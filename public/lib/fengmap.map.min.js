// /**Released Version v3.1.10,BUILD 257,Time 1751616295669. Fengmap Javascript SDK  es6, see: https://www.fengmap.com for details**/
!function(t){var a={VERSION:"v3.1.10",BUILD:257};let jt="169",at={LEFT:0,MIDDLE:1,RIGHT:2,ROTATE:0,DOLLY:1,PAN:2},ht={ROTATE:0,PAN:1,DOLLY_PAN:2,DOLLY_ROTATE:3},X=0,Y=1,Z=2,i=1,h=2,D=3,Xt=0,Yt=1,Zt=2,q=0,vt=1,K=2,J=3,$=4,Q=5,tt=100,et=101,it=102,st=103,rt=104,ot=200,lt=201,ut=202,ft=203,dt=204,pt=205,mt=206,gt=207,_t=208,wt=209,Mt=210,yt=211,Et=212,xt=213,bt=214,St=0,At=1,Tt=2,Rt=3,Lt=4,Ct=5,Nt=6,It=7,o=0,l=1,y=2,qt=0,x=1,S=2,A=3,T=4,R=5,O=6,U=7,F="attached",e="detached",B=300,Pt=301,Dt=302,Ot=303,Ut=304,Ft=306,Bt=1e3,kt=1001,Kt=1002,Jt=1003,$t=1004,Qt=1005,V=1006,te=1007,ee=1008,ie=1008,se=1009,re=1010,ne=1011,ae=1012,he=1013,oe=1014,le=1015,ue=1016,ce=1017,fe=1018,de=1020,ve=35902,pe=1021,me=1022,ge=1023,_e=1024,we=1025,Me=1026,ye=1027,Ee=1028,xe=1029,be=1030,Se=1031,Ae=1033,Te=33776,Re=33777,Le=33778,Ce=33779,Ne=35840,Ie=35841,Pe=35842,De=35843,Oe=36196,Ue=37492,Fe=37496,Be=37808,ke=37809,Ge=37810,He=37811,Ve=37812,ze=37813,We=37814,je=37815,Xe=37816,Ye=37817,Ze=37818,qe=37819,Ke=37820,Je=37821,$e=36492,Qe=36494,ti=36495,ei=36283,ii=36284,si=36285,ri=36286,ni=2200,ai=2201,hi=2202,oi=2300,li=2301,ui=2302,ci=2400,fi=2401,di=2402,vi=2500,pi=2501,mi=0,gi=1,_i=2,wi=3200,Mi=3201,yi=0,Ei=1,xi="",bi="srgb",Si="srgb-linear",Ai="display-p3",Ti="display-p3-linear",Ri="linear",Li="srgb",Ci="rec709",Ni="p3",Ii=7680,Pi=7681,Di=516,Oi=519,Ui=512,Fi=513,Bi=514,ki=515,Gi=516,Hi=517,Vi=518,zi=519,Wi=35044,ji="300 es",Xi=2e3,Yi=2001,Zi=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"],qi=1234567,Ki=Math.PI/180,Ji=180/Math.PI;function $i(){var t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0;return(Zi[255&t]+Zi[t>>8&255]+Zi[t>>16&255]+Zi[t>>24&255]+"-"+Zi[255&e]+Zi[e>>8&255]+"-"+Zi[e>>16&15|64]+Zi[e>>24&255]+"-"+Zi[63&i|128]+Zi[i>>8&255]+"-"+Zi[i>>16&255]+Zi[i>>24&255]+Zi[255&s]+Zi[s>>8&255]+Zi[s>>16&255]+Zi[s>>24&255]).toLowerCase()}function Qi(t,e,i){return Math.max(e,Math.min(i,t))}function ts(t,e){return(t%e+e)%e}function es(t,e,i,s,r){return s+(t-e)*(r-s)/(i-e)}function is(t,e,i){return t!==e?(i-t)/(e-t):0}function ss(t,e,i){return(1-i)*t+i*e}function rs(t,e,i,s){return ss(t,e,1-Math.exp(-i*s))}function ns(t,e=1){return e-Math.abs(ts(t,2*e)-e)}function as(t,e,i){return t<=e?0:i<=t?1:(t=(t-e)/(i-e))*t*(3-2*t)}function hs(t,e,i){return t<=e?0:i<=t?1:(t=(t-e)/(i-e))*t*t*(t*(6*t-15)+10)}function os(t,e){return t+Math.floor(Math.random()*(e-t+1))}function ls(t,e){return t+Math.random()*(e-t)}function us(t){return t*(.5-Math.random())}function cs(t){void 0!==t&&(qi=t);t=qi+=1831565813,t=Math.imul(t^t>>>15,1|t);return(((t^=t+Math.imul(t^t>>>7,61|t))^t>>>14)>>>0)/4294967296}function fs(t){return t*Ki}function ds(t){return t*Ji}function vs(t){return 0==(t&t-1)&&0!==t}function ps(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}function ms(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}function gs(t,e,i,s,r){var n=Math.cos,a=Math.sin,h=n(i/2),o=a(i/2),l=n((e+s)/2),u=a((e+s)/2),c=n((e-s)/2),f=a((e-s)/2),d=n((s-e)/2),v=a((s-e)/2);switch(r){case"XYX":t.set(h*u,o*c,o*f,h*l);break;case"YZY":t.set(o*f,h*u,o*c,h*l);break;case"ZXZ":t.set(o*c,o*f,h*u,h*l);break;case"XZX":t.set(h*u,o*v,o*d,h*l);break;case"YXY":t.set(o*d,h*u,o*v,h*l);break;case"ZYZ":t.set(o*v,o*d,h*u,h*l);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+r)}}function _s(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return t/4294967295;case Uint16Array:return t/65535;case Uint8Array:return t/255;case Int32Array:return Math.max(t/2147483647,-1);case Int16Array:return Math.max(t/32767,-1);case Int8Array:return Math.max(t/127,-1);default:throw new Error("Invalid component type.")}}function n(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return Math.round(4294967295*t);case Uint16Array:return Math.round(65535*t);case Uint8Array:return Math.round(255*t);case Int32Array:return Math.round(2147483647*t);case Int16Array:return Math.round(32767*t);case Int8Array:return Math.round(127*t);default:throw new Error("Invalid component type.")}}let ws={DEG2RAD:Ki,RAD2DEG:Ji,generateUUID:$i,clamp:Qi,euclideanModulo:ts,mapLinear:es,inverseLerp:is,lerp:ss,damp:rs,pingpong:ns,smoothstep:as,smootherstep:hs,randInt:os,randFloat:ls,randFloatSpread:us,seededRandom:cs,degToRad:fs,radToDeg:ds,isPowerOfTwo:vs,ceilPowerOfTwo:ps,floorPowerOfTwo:ms,setQuaternionFromProperEuler:gs,normalize:n,denormalize:_s};class Ms{constructor(t=0,e=0,i=0,s=1){this.isQuaternion=!0,this.t=t,this.o=e,this.p=i,this._=s}static slerpFlat(t,e,i,s,r,n,a){let h=i[s+0],o=i[s+1],l=i[s+2],u=i[s+3];var i=r[n+0],s=r[n+1],c=r[n+2],r=r[n+3];if(0===a)t[e+0]=h,t[e+1]=o,t[e+2]=l,t[e+3]=u;else if(1===a)t[e+0]=i,t[e+1]=s,t[e+2]=c,t[e+3]=r;else{if(u!==r||h!==i||o!==s||l!==c){let t=1-a;var n=h*i+o*s+l*c+u*r,f=0<=n?1:-1,d=1-n*n,n=(d>Number.EPSILON&&(d=Math.sqrt(d),n=Math.atan2(d,n*f),t=Math.sin(t*n)/d,a=Math.sin(a*n)/d),a*f);h=h*t+i*n,o=o*t+s*n,l=l*t+c*n,u=u*t+r*n,t===1-a&&(d=1/Math.sqrt(h*h+o*o+l*l+u*u),h*=d,o*=d,l*=d,u*=d)}t[e]=h,t[e+1]=o,t[e+2]=l,t[e+3]=u}}static multiplyQuaternionsFlat(t,e,i,s,r,n){var a=i[s],h=i[s+1],o=i[s+2],i=i[s+3],s=r[n],l=r[n+1],u=r[n+2],r=r[n+3];return t[e]=a*r+i*s+h*u-o*l,t[e+1]=h*r+i*l+o*s-a*u,t[e+2]=o*r+i*u+a*l-h*s,t[e+3]=i*r-a*s-h*l-o*u,t}get x(){return this.t}set x(t){this.t=t,this.M()}get y(){return this.o}set y(t){this.o=t,this.M()}get z(){return this.p}set z(t){this.p=t,this.M()}get w(){return this._}set w(t){this._=t,this.M()}set(t,e,i,s){return this.t=t,this.o=e,this.p=i,this._=s,this.M(),this}clone(){return new this.constructor(this.t,this.o,this.p,this._)}copy(t){return this.t=t.x,this.o=t.y,this.p=t.z,this._=t.w,this.M(),this}setFromEuler(t,e=!0){var i=t.t,s=t.o,r=t.p,n=t.S,t=Math.cos,a=Math.sin,h=t(i/2),o=t(s/2),l=t(r/2),u=a(i/2),c=a(s/2),f=a(r/2);switch(n){case"XYZ":this.t=u*o*l+h*c*f,this.o=h*c*l-u*o*f,this.p=h*o*f+u*c*l,this._=h*o*l-u*c*f;break;case"YXZ":this.t=u*o*l+h*c*f,this.o=h*c*l-u*o*f,this.p=h*o*f-u*c*l,this._=h*o*l+u*c*f;break;case"ZXY":this.t=u*o*l-h*c*f,this.o=h*c*l+u*o*f,this.p=h*o*f+u*c*l,this._=h*o*l-u*c*f;break;case"ZYX":this.t=u*o*l-h*c*f,this.o=h*c*l+u*o*f,this.p=h*o*f-u*c*l,this._=h*o*l+u*c*f;break;case"YZX":this.t=u*o*l+h*c*f,this.o=h*c*l+u*o*f,this.p=h*o*f-u*c*l,this._=h*o*l-u*c*f;break;case"XZY":this.t=u*o*l-h*c*f,this.o=h*c*l-u*o*f,this.p=h*o*f+u*c*l,this._=h*o*l+u*c*f;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+n)}return!0===e&&this.M(),this}setFromAxisAngle(t,e){var e=e/2,i=Math.sin(e);return this.t=t.x*i,this.o=t.y*i,this.p=t.z*i,this._=Math.cos(e),this.M(),this}setFromRotationMatrix(t){var t=t.elements,e=t[0],i=t[4],s=t[8],r=t[1],n=t[5],a=t[9],h=t[2],o=t[6],t=t[10],l=e+n+t;return 0<l?(l=.5/Math.sqrt(l+1),this._=.25/l,this.t=(o-a)*l,this.o=(s-h)*l,this.p=(r-i)*l):n<e&&t<e?(l=2*Math.sqrt(1+e-n-t),this._=(o-a)/l,this.t=.25*l,this.o=(i+r)/l,this.p=(s+h)/l):t<n?(l=2*Math.sqrt(1+n-e-t),this._=(s-h)/l,this.t=(i+r)/l,this.o=.25*l,this.p=(a+o)/l):(l=2*Math.sqrt(1+t-e-n),this._=(r-i)/l,this.t=(s+h)/l,this.o=(a+o)/l,this.p=.25*l),this.M(),this}setFromUnitVectors(t,e){let i=t.dot(e)+1;return i<Number.EPSILON?(i=0,Math.abs(t.x)>Math.abs(t.z)?(this.t=-t.y,this.o=t.x,this.p=0):(this.t=0,this.o=-t.z,this.p=t.y)):(this.t=t.y*e.z-t.z*e.y,this.o=t.z*e.x-t.x*e.z,this.p=t.x*e.y-t.y*e.x),this._=i,this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(Qi(this.dot(t),-1,1)))}rotateTowards(t,e){var i=this.angleTo(t);return 0!==i&&(e=Math.min(1,e/i),this.slerp(t,e)),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this.t*=-1,this.o*=-1,this.p*=-1,this.M(),this}dot(t){return this.t*t.t+this.o*t.o+this.p*t.p+this._*t._}lengthSq(){return this.t*this.t+this.o*this.o+this.p*this.p+this._*this._}length(){return Math.sqrt(this.t*this.t+this.o*this.o+this.p*this.p+this._*this._)}normalize(){var t=this.length();return 0===t?(this.t=0,this.o=0,this.p=0,this._=1):(this.t=this.t*(t=1/t),this.o=this.o*t,this.p=this.p*t,this._=this._*t),this.M(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){var i=t.t,s=t.o,r=t.p,t=t._,n=e.t,a=e.o,h=e.p,e=e._;return this.t=i*e+t*n+s*h-r*a,this.o=s*e+t*a+r*n-i*h,this.p=r*e+t*h+i*a-s*n,this._=t*e-i*n-s*a-r*h,this.M(),this}slerp(e,i){if(0!==i){if(1===i)return this.copy(e);var s,r,n=this.t,a=this.o,h=this.p,o=this._;let t=o*e._+n*e.t+a*e.o+h*e.p;t<0?(this._=-e._,this.t=-e.t,this.o=-e.o,this.p=-e.p,t=-t):this.copy(e),1<=t?(this._=o,this.t=n,this.o=a,this.p=h):(e=1-t*t)<=Number.EPSILON?(this._=(s=1-i)*o+i*this._,this.t=s*n+i*this.t,this.o=s*a+i*this.o,this.p=s*h+i*this.p,this.normalize()):(s=Math.sqrt(e),e=Math.atan2(s,t),r=Math.sin((1-i)*e)/s,i=Math.sin(i*e)/s,this._=o*r+this._*i,this.t=n*r+this.t*i,this.o=a*r+this.o*i,this.p=h*r+this.p*i,this.M())}return this}slerpQuaternions(t,e,i){return this.copy(t).slerp(e,i)}random(){var t=2*Math.PI*Math.random(),e=2*Math.PI*Math.random(),i=Math.random(),s=Math.sqrt(1-i),i=Math.sqrt(i);return this.set(s*Math.sin(t),s*Math.cos(t),i*Math.sin(e),i*Math.cos(e))}equals(t){return t.t===this.t&&t.o===this.o&&t.p===this.p&&t._===this._}fromArray(t,e=0){return this.t=t[e],this.o=t[e+1],this.p=t[e+2],this._=t[e+3],this.M(),this}toArray(t=[],e=0){return t[e]=this.t,t[e+1]=this.o,t[e+2]=this.p,t[e+3]=this._,t}fromBufferAttribute(t,e){return this.t=t.getX(e),this.o=t.getY(e),this.p=t.getZ(e),this._=t.getW(e),this.M(),this}toJSON(){return this.toArray()}A(t){return this.M=t,this}M(){}*[Symbol.iterator](){yield this.t,yield this.o,yield this.p,yield this._}}class Gt{constructor(t=0,e=0,i=0){Gt.prototype.isVector3=!0,this.x=t,this.y=e,this.z=i}set(t,e,i){return void 0===i&&(i=this.z),this.x=t,this.y=e,this.z=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(Es.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(Es.setFromAxisAngle(t,e))}applyMatrix3(t){var e=this.x,i=this.y,s=this.z,t=t.elements;return this.x=t[0]*e+t[3]*i+t[6]*s,this.y=t[1]*e+t[4]*i+t[7]*s,this.z=t[2]*e+t[5]*i+t[8]*s,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){var e=this.x,i=this.y,s=this.z,t=t.elements,r=1/(t[3]*e+t[7]*i+t[11]*s+t[15]);return this.x=(t[0]*e+t[4]*i+t[8]*s+t[12])*r,this.y=(t[1]*e+t[5]*i+t[9]*s+t[13])*r,this.z=(t[2]*e+t[6]*i+t[10]*s+t[14])*r,this}applyQuaternion(t){var e=this.x,i=this.y,s=this.z,r=t.x,n=t.y,a=t.z,t=t.w,h=2*(n*s-a*i),o=2*(a*e-r*s),l=2*(r*i-n*e);return this.x=e+t*h+n*l-a*o,this.y=i+t*o+a*h-r*l,this.z=s+t*l+r*o-n*h,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){var e=this.x,i=this.y,s=this.z,t=t.elements;return this.x=t[0]*e+t[4]*i+t[8]*s,this.y=t[1]*e+t[5]*i+t[9]*s,this.z=t[2]*e+t[6]*i+t[10]*s,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this}clampLength(t,e){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){var i=t.x,s=t.y,t=t.z,r=e.x,n=e.y,e=e.z;return this.x=s*e-t*n,this.y=t*r-i*e,this.z=i*n-s*r,this}projectOnVector(t){var e=t.lengthSq();return 0===e?this.set(0,0,0):(e=t.dot(this)/e,this.copy(t).multiplyScalar(e))}projectOnPlane(t){return ys.copy(this).projectOnVector(t),this.sub(ys)}reflect(t){return this.sub(ys.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){var e=Math.sqrt(this.lengthSq()*t.lengthSq());return 0===e?Math.PI/2:(t=this.dot(t)/e,Math.acos(Qi(t,-1,1)))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){var e=this.x-t.x,i=this.y-t.y,t=this.z-t.z;return e*e+i*i+t*t}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,i){var s=Math.sin(e)*t;return this.x=s*Math.sin(i),this.y=Math.cos(e)*t,this.z=s*Math.cos(i),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,i){return this.x=t*Math.sin(e),this.y=i,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){t=t.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(t){var e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length(),t=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=i,this.z=t,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}setFromEuler(t){return this.x=t.t,this.y=t.o,this.z=t.p,this}setFromColor(t){return this.x=t.r,this.y=t.g,this.z=t.b,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){var t=Math.random()*Math.PI*2,e=2*Math.random()-1,i=Math.sqrt(1-e*e);return this.x=i*Math.cos(t),this.y=e,this.z=i*Math.sin(t),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}let ys=new Gt,Es=new Ms;class Ht{constructor(t,e,i,s,r,n,a,h,o,l,u,c,f,d,v,p){Ht.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,e,i,s,r,n,a,h,o,l,u,c,f,d,v,p)}set(t,e,i,s,r,n,a,h,o,l,u,c,f,d,v,p){var m=this.elements;return m[0]=t,m[4]=e,m[8]=i,m[12]=s,m[1]=r,m[5]=n,m[9]=a,m[13]=h,m[2]=o,m[6]=l,m[10]=u,m[14]=c,m[3]=f,m[7]=d,m[11]=v,m[15]=p,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Ht).fromArray(this.elements)}copy(t){var e=this.elements,t=t.elements;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],this}copyPosition(t){var e=this.elements,t=t.elements;return e[12]=t[12],e[13]=t[13],e[14]=t[14],this}setFromMatrix3(t){t=t.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(t,e,i){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this}extractRotation(t){var e=this.elements,i=t.elements,s=1/xs.setFromMatrixColumn(t,0).length(),r=1/xs.setFromMatrixColumn(t,1).length(),t=1/xs.setFromMatrixColumn(t,2).length();return e[0]=i[0]*s,e[1]=i[1]*s,e[2]=i[2]*s,e[3]=0,e[4]=i[4]*r,e[5]=i[5]*r,e[6]=i[6]*r,e[7]=0,e[8]=i[8]*t,e[9]=i[9]*t,e[10]=i[10]*t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){var e,i,s,r,n=this.elements,a=t.x,h=t.y,o=t.z,l=Math.cos(a),a=Math.sin(a),u=Math.cos(h),h=Math.sin(h),c=Math.cos(o),o=Math.sin(o);return"XYZ"===t.order?(i=l*c,s=l*o,r=a*c,e=a*o,n[0]=u*c,n[4]=-u*o,n[8]=h,n[1]=s+r*h,n[5]=i-e*h,n[9]=-a*u,n[2]=e-i*h,n[6]=r+s*h,n[10]=l*u):"YXZ"===t.order?(e=u*o,i=h*c,n[0]=(r=u*c)+(s=h*o)*a,n[4]=i*a-e,n[8]=l*h,n[1]=l*o,n[5]=l*c,n[9]=-a,n[2]=e*a-i,n[6]=s+r*a,n[10]=l*u):"ZXY"===t.order?(e=u*o,i=h*c,n[0]=(s=u*c)-(r=h*o)*a,n[4]=-l*o,n[8]=i+e*a,n[1]=e+i*a,n[5]=l*c,n[9]=r-s*a,n[2]=-l*h,n[6]=a,n[10]=l*u):"ZYX"===t.order?(e=l*c,i=l*o,r=a*c,s=a*o,n[0]=u*c,n[4]=r*h-i,n[8]=e*h+s,n[1]=u*o,n[5]=s*h+e,n[9]=i*h-r,n[2]=-h,n[6]=a*u,n[10]=l*u):"YZX"===t.order?(s=l*u,e=l*h,i=a*u,r=a*h,n[0]=u*c,n[4]=r-s*o,n[8]=i*o+e,n[1]=o,n[5]=l*c,n[9]=-a*c,n[2]=-h*c,n[6]=e*o+i,n[10]=s-r*o):"XZY"===t.order&&(e=l*u,i=l*h,s=a*u,r=a*h,n[0]=u*c,n[4]=-o,n[8]=h*c,n[1]=e*o+r,n[5]=l*c,n[9]=i*o-s,n[2]=s*o-i,n[6]=a*c,n[10]=r*o+e),n[3]=0,n[7]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,this}makeRotationFromQuaternion(t){return this.compose(Ss,t,As)}lookAt(t,e,i){var s=this.elements;return Ls.subVectors(t,e),0===Ls.lengthSq()&&(Ls.z=1),Ls.normalize(),Ts.crossVectors(i,Ls),0===Ts.lengthSq()&&(1===Math.abs(i.z)?Ls.x+=1e-4:Ls.z+=1e-4,Ls.normalize(),Ts.crossVectors(i,Ls)),Ts.normalize(),Rs.crossVectors(Ls,Ts),s[0]=Ts.x,s[4]=Rs.x,s[8]=Ls.x,s[1]=Ts.y,s[5]=Rs.y,s[9]=Ls.y,s[2]=Ts.z,s[6]=Rs.z,s[10]=Ls.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){var t=t.elements,e=e.elements,i=this.elements,s=t[0],r=t[4],n=t[8],a=t[12],h=t[1],o=t[5],l=t[9],u=t[13],c=t[2],f=t[6],d=t[10],v=t[14],p=t[3],m=t[7],g=t[11],t=t[15],_=e[0],w=e[4],M=e[8],y=e[12],E=e[1],x=e[5],b=e[9],S=e[13],A=e[2],T=e[6],R=e[10],L=e[14],C=e[3],N=e[7],I=e[11],e=e[15];return i[0]=s*_+r*E+n*A+a*C,i[4]=s*w+r*x+n*T+a*N,i[8]=s*M+r*b+n*R+a*I,i[12]=s*y+r*S+n*L+a*e,i[1]=h*_+o*E+l*A+u*C,i[5]=h*w+o*x+l*T+u*N,i[9]=h*M+o*b+l*R+u*I,i[13]=h*y+o*S+l*L+u*e,i[2]=c*_+f*E+d*A+v*C,i[6]=c*w+f*x+d*T+v*N,i[10]=c*M+f*b+d*R+v*I,i[14]=c*y+f*S+d*L+v*e,i[3]=p*_+m*E+g*A+t*C,i[7]=p*w+m*x+g*T+t*N,i[11]=p*M+m*b+g*R+t*I,i[15]=p*y+m*S+g*L+t*e,this}multiplyScalar(t){var e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){var t=this.elements,e=t[0],i=t[4],s=t[8],r=t[12],n=t[1],a=t[5],h=t[9],o=t[13],l=t[2],u=t[6],c=t[10],f=t[14];return t[3]*(+r*h*u-s*o*u-r*a*c+i*o*c+s*a*f-i*h*f)+t[7]*(+e*h*f-e*o*c+r*n*c-s*n*f+s*o*l-r*h*l)+t[11]*(+e*o*u-e*a*f-r*n*u+i*n*f+r*a*l-i*o*l)+t[15]*(-s*a*l-e*h*u+e*a*c+s*n*u-i*n*c+i*h*l)}transpose(){var t=this.elements,e=t[1];return t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,i){var s=this.elements;return t.isVector3?(s[12]=t.x,s[13]=t.y,s[14]=t.z):(s[12]=t,s[13]=e,s[14]=i),this}invert(){var t=this.elements,e=t[0],i=t[1],s=t[2],r=t[3],n=t[4],a=t[5],h=t[6],o=t[7],l=t[8],u=t[9],c=t[10],f=t[11],d=t[12],v=t[13],p=t[14],m=t[15],g=u*p*o-v*c*o+v*h*f-a*p*f-u*h*m+a*c*m,_=d*c*o-l*p*o-d*h*f+n*p*f+l*h*m-n*c*m,w=l*v*o-d*u*o+d*a*f-n*v*f-l*a*m+n*u*m,M=d*u*h-l*v*h-d*a*c+n*v*c+l*a*p-n*u*p,y=e*g+i*_+s*w+r*M;return 0==y?this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0):(t[0]=g*(g=1/y),t[1]=(v*c*r-u*p*r-v*s*f+i*p*f+u*s*m-i*c*m)*g,t[2]=(a*p*r-v*h*r+v*s*o-i*p*o-a*s*m+i*h*m)*g,t[3]=(u*h*r-a*c*r-u*s*o+i*c*o+a*s*f-i*h*f)*g,t[4]=_*g,t[5]=(l*p*r-d*c*r+d*s*f-e*p*f-l*s*m+e*c*m)*g,t[6]=(d*h*r-n*p*r-d*s*o+e*p*o+n*s*m-e*h*m)*g,t[7]=(n*c*r-l*h*r+l*s*o-e*c*o-n*s*f+e*h*f)*g,t[8]=w*g,t[9]=(d*u*r-l*v*r-d*i*f+e*v*f+l*i*m-e*u*m)*g,t[10]=(n*v*r-d*a*r+d*i*o-e*v*o-n*i*m+e*a*m)*g,t[11]=(l*a*r-n*u*r-l*i*o+e*u*o+n*i*f-e*a*f)*g,t[12]=M*g,t[13]=(l*v*s-d*u*s+d*i*c-e*v*c-l*i*p+e*u*p)*g,t[14]=(d*a*s-n*v*s-d*i*h+e*v*h+n*i*p-e*a*p)*g,t[15]=(n*u*s-l*a*s+l*i*h-e*u*h-n*i*c+e*a*c)*g,this)}scale(t){var e=this.elements,i=t.x,s=t.y,t=t.z;return e[0]*=i,e[4]*=s,e[8]*=t,e[1]*=i,e[5]*=s,e[9]*=t,e[2]*=i,e[6]*=s,e[10]*=t,e[3]*=i,e[7]*=s,e[11]*=t,this}getMaxScaleOnAxis(){var t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];return Math.sqrt(Math.max(e,t[4]*t[4]+t[5]*t[5]+t[6]*t[6],t[8]*t[8]+t[9]*t[9]+t[10]*t[10]))}makeTranslation(t,e,i){return t.isVector3?this.set(1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1):this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this}makeRotationX(t){var e=Math.cos(t),t=Math.sin(t);return this.set(1,0,0,0,0,e,-t,0,0,t,e,0,0,0,0,1),this}makeRotationY(t){var e=Math.cos(t),t=Math.sin(t);return this.set(e,0,t,0,0,1,0,0,-t,0,e,0,0,0,0,1),this}makeRotationZ(t){var e=Math.cos(t),t=Math.sin(t);return this.set(e,-t,0,0,t,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){var i=Math.cos(e),e=Math.sin(e),s=1-i,r=t.x,n=t.y,t=t.z,a=s*r,h=s*n;return this.set(a*r+i,a*n-e*t,a*t+e*n,0,a*n+e*t,h*n+i,h*t-e*r,0,a*t-e*n,h*t+e*r,s*t*t+i,0,0,0,0,1),this}makeScale(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this}makeShear(t,e,i,s,r,n){return this.set(1,i,r,0,t,1,n,0,e,s,1,0,0,0,0,1),this}compose(t,e,i){var s=this.elements,r=e.t,n=e.o,a=e.p,e=e._,h=r+r,o=n+n,l=a+a,u=r*h,c=r*o,r=r*l,f=n*o,n=n*l,a=a*l,h=e*h,o=e*o,e=e*l,l=i.x,d=i.y,i=i.z;return s[0]=(1-(f+a))*l,s[1]=(c+e)*l,s[2]=(r-o)*l,s[3]=0,s[4]=(c-e)*d,s[5]=(1-(u+a))*d,s[6]=(n+h)*d,s[7]=0,s[8]=(r+o)*i,s[9]=(n-h)*i,s[10]=(1-(u+f))*i,s[11]=0,s[12]=t.x,s[13]=t.y,s[14]=t.z,s[15]=1,this}decompose(t,e,i){var s=this.elements;let r=xs.set(s[0],s[1],s[2]).length();var n=xs.set(s[4],s[5],s[6]).length(),a=xs.set(s[8],s[9],s[10]).length(),t=(this.determinant()<0&&(r=-r),t.x=s[12],t.y=s[13],t.z=s[14],bs.copy(this),1/r),s=1/n,h=1/a;return bs.elements[0]*=t,bs.elements[1]*=t,bs.elements[2]*=t,bs.elements[4]*=s,bs.elements[5]*=s,bs.elements[6]*=s,bs.elements[8]*=h,bs.elements[9]*=h,bs.elements[10]*=h,e.setFromRotationMatrix(bs),i.x=r,i.y=n,i.z=a,this}makePerspective(t,e,i,s,r,n,a=Xi){var h=this.elements,o=2*r/(e-t),l=2*r/(i-s),e=(e+t)/(e-t),t=(i+s)/(i-s);let u,c;if(a===Xi)u=-(n+r)/(n-r),c=-2*n*r/(n-r);else{if(a!==Yi)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+a);u=-n/(n-r),c=-n*r/(n-r)}return h[0]=o,h[4]=0,h[8]=e,h[12]=0,h[1]=0,h[5]=l,h[9]=t,h[13]=0,h[2]=0,h[6]=0,h[10]=u,h[14]=c,h[3]=0,h[7]=0,h[11]=-1,h[15]=0,this}makeOrthographic(t,e,i,s,r,n,a=Xi){var h=this.elements,o=1/(e-t),l=1/(i-s),u=1/(n-r),e=(e+t)*o,t=(i+s)*l;let c,f;if(a===Xi)c=(n+r)*u,f=-2*u;else{if(a!==Yi)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+a);c=r*u,f=-1*u}return h[0]=2*o,h[4]=0,h[8]=0,h[12]=-e,h[1]=0,h[5]=2*l,h[9]=0,h[13]=-t,h[2]=0,h[6]=0,h[10]=f,h[14]=-c,h[3]=0,h[7]=0,h[11]=0,h[15]=1,this}equals(t){var e=this.elements,i=t.elements;for(let t=0;t<16;t++)if(e[t]!==i[t])return!1;return!0}fromArray(e,i=0){for(let t=0;t<16;t++)this.elements[t]=e[t+i];return this}toArray(t=[],e=0){var i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t}}let xs=new Gt,bs=new Ht,Ss=new Gt(0,0,0),As=new Gt(1,1,1),Ts=new Gt,Rs=new Gt,Ls=new Gt;class Cs{addEventListener(t,e){void 0===this.T&&(this.T={});var i=this.T;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)}hasEventListener(t,e){var i;return void 0!==this.T&&void 0!==(i=this.T)[t]&&-1!==i[t].indexOf(e)}removeEventListener(t,e){var i;void 0!==this.T&&void 0!==(t=this.T[t])&&-1!==(i=t.indexOf(e))&&t.splice(i,1)}dispatchEvent(i){if(void 0!==this.T){var t=this.T[i.type];if(void 0!==t){i.target=this;var s=t.slice(0);for(let t=0,e=s.length;t<e;t++)s[t].call(this,i);i.target=null}}}}let Ns=new Ht,Is=new Ms;class Ps{constructor(t=0,e=0,i=0,s=Ps.DEFAULT_ORDER){this.isEuler=!0,this.t=t,this.o=e,this.p=i,this.S=s}get x(){return this.t}set x(t){this.t=t,this.M()}get y(){return this.o}set y(t){this.o=t,this.M()}get z(){return this.p}set z(t){this.p=t,this.M()}get order(){return this.S}set order(t){this.S=t,this.M()}set(t,e,i,s=this.S){return this.t=t,this.o=e,this.p=i,this.S=s,this.M(),this}clone(){return new this.constructor(this.t,this.o,this.p,this.S)}copy(t){return this.t=t.t,this.o=t.o,this.p=t.p,this.S=t.S,this.M(),this}setFromRotationMatrix(t,e=this.S,i=!0){var t=t.elements,s=t[0],r=t[4],n=t[8],a=t[1],h=t[5],o=t[9],l=t[2],u=t[6],c=t[10];switch(e){case"XYZ":this.o=Math.asin(Qi(n,-1,1)),Math.abs(n)<.9999999?(this.t=Math.atan2(-o,c),this.p=Math.atan2(-r,s)):(this.t=Math.atan2(u,h),this.p=0);break;case"YXZ":this.t=Math.asin(-Qi(o,-1,1)),Math.abs(o)<.9999999?(this.o=Math.atan2(n,c),this.p=Math.atan2(a,h)):(this.o=Math.atan2(-l,s),this.p=0);break;case"ZXY":this.t=Math.asin(Qi(u,-1,1)),Math.abs(u)<.9999999?(this.o=Math.atan2(-l,c),this.p=Math.atan2(-r,h)):(this.o=0,this.p=Math.atan2(a,s));break;case"ZYX":this.o=Math.asin(-Qi(l,-1,1)),Math.abs(l)<.9999999?(this.t=Math.atan2(u,c),this.p=Math.atan2(a,s)):(this.t=0,this.p=Math.atan2(-r,h));break;case"YZX":this.p=Math.asin(Qi(a,-1,1)),Math.abs(a)<.9999999?(this.t=Math.atan2(-o,h),this.o=Math.atan2(-l,s)):(this.t=0,this.o=Math.atan2(n,c));break;case"XZY":this.p=Math.asin(-Qi(r,-1,1)),Math.abs(r)<.9999999?(this.t=Math.atan2(u,h),this.o=Math.atan2(n,s)):(this.t=Math.atan2(-o,c),this.o=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this.S=e,!0===i&&this.M(),this}setFromQuaternion(t,e,i){return Ns.makeRotationFromQuaternion(t),this.setFromRotationMatrix(Ns,e,i)}setFromVector3(t,e=this.S){return this.set(t.x,t.y,t.z,e)}reorder(t){return Is.setFromEuler(this),this.setFromQuaternion(Is,t)}equals(t){return t.t===this.t&&t.o===this.o&&t.p===this.p&&t.S===this.S}fromArray(t){return this.t=t[0],this.o=t[1],this.p=t[2],void 0!==t[3]&&(this.S=t[3]),this.M(),this}toArray(t=[],e=0){return t[e]=this.t,t[e+1]=this.o,t[e+2]=this.p,t[e+3]=this.S,t}A(t){return this.M=t,this}M(){}*[Symbol.iterator](){yield this.t,yield this.o,yield this.p,yield this.S}}Ps.DEFAULT_ORDER="XYZ";class Ds{constructor(){this.mask=1}set(t){this.mask=(1<<t|0)>>>0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return 0!=(this.mask&t.mask)}isEnabled(t){return 0!=(this.mask&(1<<t|0))}}class _{constructor(t,e,i,s,r,n,a,h,o){_.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==t&&this.set(t,e,i,s,r,n,a,h,o)}set(t,e,i,s,r,n,a,h,o){var l=this.elements;return l[0]=t,l[1]=s,l[2]=a,l[3]=e,l[4]=r,l[5]=h,l[6]=i,l[7]=n,l[8]=o,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){var e=this.elements,t=t.elements;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this}extractBasis(t,e,i){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(t){t=t.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){var t=t.elements,e=e.elements,i=this.elements,s=t[0],r=t[3],n=t[6],a=t[1],h=t[4],o=t[7],l=t[2],u=t[5],t=t[8],c=e[0],f=e[3],d=e[6],v=e[1],p=e[4],m=e[7],g=e[2],_=e[5],e=e[8];return i[0]=s*c+r*v+n*g,i[3]=s*f+r*p+n*_,i[6]=s*d+r*m+n*e,i[1]=a*c+h*v+o*g,i[4]=a*f+h*p+o*_,i[7]=a*d+h*m+o*e,i[2]=l*c+u*v+t*g,i[5]=l*f+u*p+t*_,i[8]=l*d+u*m+t*e,this}multiplyScalar(t){var e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){var t=this.elements,e=t[0],i=t[1],s=t[2],r=t[3],n=t[4],a=t[5],h=t[6],o=t[7],t=t[8];return e*n*t-e*a*o-i*r*t+i*a*h+s*r*o-s*n*h}invert(){var t=this.elements,e=t[0],i=t[1],s=t[2],r=t[3],n=t[4],a=t[5],h=t[6],o=t[7],l=t[8],u=l*n-a*o,c=a*h-l*r,f=o*r-n*h,d=e*u+i*c+s*f;return 0==d?this.set(0,0,0,0,0,0,0,0,0):(t[0]=u*(u=1/d),t[1]=(s*o-l*i)*u,t[2]=(a*i-s*n)*u,t[3]=c*u,t[4]=(l*e-s*h)*u,t[5]=(s*r-a*e)*u,t[6]=f*u,t[7]=(i*h-o*e)*u,t[8]=(n*e-i*r)*u,this)}transpose(){var t=this.elements,e=t[1];return t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){var e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,i,s,r,n,a){var h=Math.cos(r),r=Math.sin(r);return this.set(i*h,i*r,-i*(h*n+r*a)+n+t,-s*r,s*h,-s*(-r*n+h*a)+a+e,0,0,1),this}scale(t,e){return this.premultiply(Os.makeScale(t,e)),this}rotate(t){return this.premultiply(Os.makeRotation(-t)),this}translate(t,e){return this.premultiply(Os.makeTranslation(t,e)),this}makeTranslation(t,e){return t.isVector2?this.set(1,0,t.x,0,1,t.y,0,0,1):this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){var e=Math.cos(t),t=Math.sin(t);return this.set(e,-t,0,t,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){var e=this.elements,i=t.elements;for(let t=0;t<9;t++)if(e[t]!==i[t])return!1;return!0}fromArray(e,i=0){for(let t=0;t<9;t++)this.elements[t]=e[t+i];return this}toArray(t=[],e=0){var i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t}clone(){return(new this.constructor).fromArray(this.elements)}}let Os=new _,Us=0,Fs=new Gt,Bs=new Ms,ks=new Ht,Gs=new Gt,Hs=new Gt,Vs=new Gt,zs=new Ms,Ws=new Gt(1,0,0),js=new Gt(0,1,0),Xs=new Gt(0,0,1),Ys={type:"added"},Zs={type:"removed"},qs={type:"childadded",child:null},Ks={type:"childremoved",child:null};class Js extends Cs{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:Us++}),this.uuid=$i(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Js.DEFAULT_UP.clone();var t=new Gt;let e=new Ps,i=new Ms;var s=new Gt(1,1,1);e.A(function(){i.setFromEuler(e,!1)}),i.A(function(){e.setFromQuaternion(i,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:s},modelViewMatrix:{value:new Ht},normalMatrix:{value:new _}}),this.matrix=new Ht,this.matrixWorld=new Ht,this.matrixAutoUpdate=Js.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=Js.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new Ds,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return Bs.setFromAxisAngle(t,e),this.quaternion.multiply(Bs),this}rotateOnWorldAxis(t,e){return Bs.setFromAxisAngle(t,e),this.quaternion.premultiply(Bs),this}rotateX(t){return this.rotateOnAxis(Ws,t)}rotateY(t){return this.rotateOnAxis(js,t)}rotateZ(t){return this.rotateOnAxis(Xs,t)}translateOnAxis(t,e){return Fs.copy(t).applyQuaternion(this.quaternion),this.position.add(Fs.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(Ws,t)}translateY(t){return this.translateOnAxis(js,t)}translateZ(t){return this.translateOnAxis(Xs,t)}localToWorld(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(ks.copy(this.matrixWorld).invert())}lookAt(t,e,i){t.isVector3?Gs.copy(t):Gs.set(t,e,i);t=this.parent;this.updateWorldMatrix(!0,!1),Hs.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?ks.lookAt(Hs,Gs,this.up):ks.lookAt(Gs,Hs,this.up),this.quaternion.setFromRotationMatrix(ks),t&&(ks.extractRotation(t.matrixWorld),Bs.setFromRotationMatrix(ks),this.quaternion.premultiply(Bs.invert()))}add(t){if(1<arguments.length)for(let t=0;t<arguments.length;t++)this.add(arguments[t]);else t===this?console.error("THREE.Object3D.add: object can't be added as a child of itself.",t):t&&t.isObject3D?(t.removeFromParent(),(t.parent=this).children.push(t),t.dispatchEvent(Ys),qs.child=t,this.dispatchEvent(qs),qs.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t);return this}remove(t){if(1<arguments.length)for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);else{var e=this.children.indexOf(t);-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(Zs),Ks.child=t,this.dispatchEvent(Ks),Ks.child=null)}return this}removeFromParent(){var t=this.parent;return null!==t&&t.remove(this),this}clear(){return this.remove(...this.children)}attach(t){return this.updateWorldMatrix(!0,!1),ks.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),ks.multiply(t.parent.matrixWorld)),t.applyMatrix4(ks),t.removeFromParent(),(t.parent=this).children.push(t),t.updateWorldMatrix(!1,!0),t.dispatchEvent(Ys),qs.child=t,this.dispatchEvent(qs),qs.child=null,this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(i,s){if(this[i]===s)return this;for(let t=0,e=this.children.length;t<e;t++){var r=this.children[t].getObjectByProperty(i,s);if(void 0!==r)return r}}getObjectsByProperty(i,s,r=[]){this[i]===s&&r.push(this);var n=this.children;for(let t=0,e=n.length;t<e;t++)n[t].getObjectsByProperty(i,s,r);return r}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Hs,t,Vs),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Hs,zs,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);var e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(i){i(this);var s=this.children;for(let t=0,e=s.length;t<e;t++)s[t].traverse(i)}traverseVisible(i){if(!1!==this.visible){i(this);var s=this.children;for(let t=0,e=s.length;t<e;t++)s[t].traverseVisible(i)}}traverseAncestors(t){var e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(i){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||i)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),i=!(this.matrixWorldNeedsUpdate=!1));var s=this.children;for(let t=0,e=s.length;t<e;t++)s[t].updateMatrixWorld(i)}updateWorldMatrix(t,e){var i=this.parent;if(!0===t&&null!==i&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===e){var s=this.children;for(let t=0,e=s.length;t<e;t++)s[t].updateWorldMatrix(!1,!0)}}toJSON(i){var t,e,s,r,n,a,h=void 0===i||"string"==typeof i,o={},l=(h&&(i={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},o.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"}),{});function u(t,e){return void 0===t[e.uuid]&&(t[e.uuid]=e.toJSON(i)),e.uuid}if(l.uuid=this.uuid,l.type=this.type,""!==this.name&&(l.name=this.name),!0===this.castShadow&&(l.castShadow=!0),!0===this.receiveShadow&&(l.receiveShadow=!0),!1===this.visible&&(l.visible=!1),!1===this.frustumCulled&&(l.frustumCulled=!1),0!==this.renderOrder&&(l.renderOrder=this.renderOrder),0<Object.keys(this.userData).length&&(l.userData=this.userData),l.layers=this.layers.mask,l.matrix=this.matrix.toArray(),l.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(l.matrixAutoUpdate=!1),this.isInstancedMesh&&(l.type="InstancedMesh",l.count=this.count,l.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor)&&(l.instanceColor=this.instanceColor.toJSON()),this.isBatchedMesh&&(l.type="BatchedMesh",l.perObjectFrustumCulled=this.perObjectFrustumCulled,l.sortObjects=this.sortObjects,l.drawRanges=this._drawRanges,l.reservedRanges=this._reservedRanges,l.visibility=this._visibility,l.active=this._active,l.bounds=this.R.map(t=>({boxInitialized:t.boxInitialized,boxMin:t.box.min.toArray(),boxMax:t.box.max.toArray(),sphereInitialized:t.sphereInitialized,sphereRadius:t.sphere.radius,sphereCenter:t.sphere.center.toArray()})),l.maxInstanceCount=this.L,l.maxVertexCount=this._maxVertexCount,l.maxIndexCount=this._maxIndexCount,l.geometryInitialized=this._geometryInitialized,l.geometryCount=this._geometryCount,l.matricesTexture=this._matricesTexture.toJSON(i),null!==this._colorsTexture&&(l.colorsTexture=this._colorsTexture.toJSON(i)),null!==this.boundingSphere&&(l.boundingSphere={center:l.boundingSphere.center.toArray(),radius:l.boundingSphere.radius}),null!==this.boundingBox)&&(l.boundingBox={min:l.boundingBox.min.toArray(),max:l.boundingBox.max.toArray()}),this.isScene)this.background&&(this.background.isColor?l.background=this.background.toJSON():this.background.isTexture&&(l.background=this.background.toJSON(i).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(l.environment=this.environment.toJSON(i).uuid);else if(this.isMesh||this.isLine||this.isPoints){l.geometry=u(i.geometries,this.geometry);var c=this.geometry.parameters;if(void 0!==c&&void 0!==c.shapes){var f=c.shapes;if(Array.isArray(f))for(let t=0,e=f.length;t<e;t++){var d=f[t];u(i.shapes,d)}else u(i.shapes,f)}}if(this.isSkinnedMesh&&(l.bindMode=this.bindMode,l.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton)&&(u(i.skeletons,this.skeleton),l.skeleton=this.skeleton.uuid),void 0!==this.material)if(Array.isArray(this.material)){var v=[];for(let t=0,e=this.material.length;t<e;t++)v.push(u(i.materials,this.material[t]));l.material=v}else l.material=u(i.materials,this.material);if(0<this.children.length){l.children=[];for(let t=0;t<this.children.length;t++)l.children.push(this.children[t].toJSON(i).object)}if(0<this.animations.length){l.animations=[];for(let t=0;t<this.animations.length;t++){var p=this.animations[t];l.animations.push(u(i.animations,p))}}return h&&(c=m(i.geometries),h=m(i.materials),t=m(i.textures),e=m(i.images),s=m(i.shapes),r=m(i.skeletons),n=m(i.animations),a=m(i.nodes),0<c.length&&(o.geometries=c),0<h.length&&(o.materials=h),0<t.length&&(o.textures=t),0<e.length&&(o.images=e),0<s.length&&(o.shapes=s),0<r.length&&(o.skeletons=r),0<n.length&&(o.animations=n),0<a.length)&&(o.nodes=a),o.object=l,o;function m(t){var e,i=[];for(e in t){var s=t[e];delete s.metadata,i.push(s)}return i}}clone(t){return(new this.constructor).copy(this,t)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let t=0;t<e.children.length;t++){var i=e.children[t];this.add(i.clone())}return this}}Js.DEFAULT_UP=new Gt(0,1,0),Js.DEFAULT_MATRIX_AUTO_UPDATE=!0,Js.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;class $s extends Js{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new Ht,this.projectionMatrix=new Ht,this.projectionMatrixInverse=new Ht,this.coordinateSystem=Xi}copy(t,e){return super.copy(t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this.coordinateSystem=t.coordinateSystem,this}getWorldDirection(t){return super.getWorldDirection(t).negate()}updateMatrixWorld(t){super.updateMatrixWorld(t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(t,e){super.updateWorldMatrix(t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}class ct{constructor(t=0,e=0){ct.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){var e=this.x,i=this.y,t=t.elements;return this.x=t[0]*e+t[3]*i+t[6],this.y=t[1]*e+t[4]*i+t[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this}clampLength(t,e){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){var e=Math.sqrt(this.lengthSq()*t.lengthSq());return 0===e?Math.PI/2:(t=this.dot(t)/e,Math.acos(Qi(t,-1,1)))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){var e=this.x-t.x,t=this.y-t.y;return e*e+t*t}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){var i=Math.cos(e),e=Math.sin(e),s=this.x-t.x,r=this.y-t.y;return this.x=s*i-r*e+t.x,this.y=s*e+r*i+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}let Qs=new Gt,tr=new ct,er=new ct;class ir extends $s{constructor(t=50,e=1,i=.1,s=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=t,this.zoom=1,this.near=i,this.far=s,this.focus=10,this.aspect=e,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=null===t.view?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this}setFocalLength(t){t=.5*this.getFilmHeight()/t;this.fov=2*Ji*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){var t=Math.tan(.5*Ki*this.fov);return.5*this.getFilmHeight()/t}getEffectiveFOV(){return 2*Ji*Math.atan(Math.tan(.5*Ki*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(t,e,i){Qs.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),e.set(Qs.x,Qs.y).multiplyScalar(-t/Qs.z),Qs.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),i.set(Qs.x,Qs.y).multiplyScalar(-t/Qs.z)}getViewSize(t,e){return this.getViewBounds(t,tr,er),e.subVectors(er,tr)}setViewOffset(t,e,i,s,r,n){this.aspect=t/e,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=s,this.view.width=r,this.view.height=n,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){var t=this.near;let e=t*Math.tan(.5*Ki*this.fov)/this.zoom,i=2*e,s=this.aspect*i,r=-.5*s;var n,a=this.view,h=(null!==this.view&&this.view.enabled&&(h=a.fullWidth,n=a.fullHeight,r+=a.offsetX*s/h,e-=a.offsetY*i/n,s*=a.width/h,i*=a.height/n),this.filmOffset);0!==h&&(r+=t*h/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+s,e,e-i,t,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){t=super.toJSON(t);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}class sr extends $s{constructor(t=-1,e=1,i=1,s=-1,r=.1,n=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t,this.right=e,this.top=i,this.bottom=s,this.near=r,this.far=n,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=null===t.view?null:Object.assign({},t.view),this}setViewOffset(t,e,i,s,r,n){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=s,this.view.width=r,this.view.height=n,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){var t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,s=(this.top+this.bottom)/2;let r=i-t,n=i+t,a=s+e,h=s-e;null!==this.view&&this.view.enabled&&(i=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom,r+=i*this.view.offsetX,n=r+i*this.view.width,a-=t*this.view.offsetY,h=a-t*this.view.height),this.projectionMatrix.makeOrthographic(r,n,a,h,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){t=super.toJSON(t);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}class rr{constructor(t=new Gt(1/0,1/0,1/0),e=new Gt(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(i){this.makeEmpty();for(let t=0,e=i.length;t<e;t+=3)this.expandByPoint(ar.fromArray(i,t));return this}setFromBufferAttribute(i){this.makeEmpty();for(let t=0,e=i.count;t<e;t++)this.expandByPoint(ar.fromBufferAttribute(i,t));return this}setFromPoints(i){this.makeEmpty();for(let t=0,e=i.length;t<e;t++)this.expandByPoint(i[t]);return this}setFromCenterAndSize(t,e){e=ar.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(e),this.max.copy(t).add(e),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(i,s=!1){i.updateWorldMatrix(!1,!1);var t=i.geometry;if(void 0!==t){var r=t.getAttribute("position");if(!0===s&&void 0!==r&&!0!==i.isInstancedMesh)for(let t=0,e=r.count;t<e;t++)!0===i.isMesh?i.getVertexPosition(t,ar):ar.fromBufferAttribute(r,t),ar.applyMatrix4(i.matrixWorld),this.expandByPoint(ar);else void 0!==i.boundingBox?(null===i.boundingBox&&i.computeBoundingBox(),hr.copy(i.boundingBox)):(null===t.boundingBox&&t.computeBoundingBox(),hr.copy(t.boundingBox)),hr.applyMatrix4(i.matrixWorld),this.union(hr)}var n=i.children;for(let t=0,e=n.length;t<e;t++)this.expandByObject(n[t],s);return this}containsPoint(t){return t.x>=this.min.x&&t.x<=this.max.x&&t.y>=this.min.y&&t.y<=this.max.y&&t.z>=this.min.z&&t.z<=this.max.z}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return t.max.x>=this.min.x&&t.min.x<=this.max.x&&t.max.y>=this.min.y&&t.min.y<=this.max.y&&t.max.z>=this.min.z&&t.min.z<=this.max.z}intersectsSphere(t){return this.clampPoint(t.center,ar),ar.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,i;return i=0<t.normal.x?(e=t.normal.x*this.min.x,t.normal.x*this.max.x):(e=t.normal.x*this.max.x,t.normal.x*this.min.x),0<t.normal.y?(e+=t.normal.y*this.min.y,i+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,i+=t.normal.y*this.min.y),0<t.normal.z?(e+=t.normal.z*this.min.z,i+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,i+=t.normal.z*this.min.z),e<=-t.constant&&i>=-t.constant}intersectsTriangle(t){return!this.isEmpty()&&(this.getCenter(vr),pr.subVectors(this.max,vr),or.subVectors(t.a,vr),lr.subVectors(t.b,vr),ur.subVectors(t.c,vr),cr.subVectors(lr,or),fr.subVectors(ur,lr),dr.subVectors(or,ur),!!_r([0,-cr.z,cr.y,0,-fr.z,fr.y,0,-dr.z,dr.y,cr.z,0,-cr.x,fr.z,0,-fr.x,dr.z,0,-dr.x,-cr.y,cr.x,0,-fr.y,fr.x,0,-dr.y,dr.x,0],or,lr,ur,pr))&&!!_r([1,0,0,0,1,0,0,0,1],or,lr,ur,pr)&&(mr.crossVectors(cr,fr),_r([mr.x,mr.y,mr.z],or,lr,ur,pr))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,ar).distanceTo(t)}getBoundingSphere(t){return this.isEmpty()?t.makeEmpty():(this.getCenter(t.center),t.radius=.5*this.getSize(ar).length()),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()||(nr[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),nr[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),nr[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),nr[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),nr[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),nr[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),nr[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),nr[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(nr)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}let nr=[new Gt,new Gt,new Gt,new Gt,new Gt,new Gt,new Gt,new Gt],ar=new Gt,hr=new rr,or=new Gt,lr=new Gt,ur=new Gt,cr=new Gt,fr=new Gt,dr=new Gt,vr=new Gt,pr=new Gt,mr=new Gt,gr=new Gt;function _r(i,s,r,n,a){for(let t=0,e=i.length-3;t<=e;t+=3){gr.fromArray(i,t);var h=a.x*Math.abs(gr.x)+a.y*Math.abs(gr.y)+a.z*Math.abs(gr.z),o=s.dot(gr),l=r.dot(gr),u=n.dot(gr);if(Math.max(-Math.max(o,l,u),Math.min(o,l,u))>h)return!1}return!0}let wr=new rr,Mr=new Gt,yr=new Gt;class Er{constructor(t=new Gt,e=-1){this.isSphere=!0,this.center=t,this.radius=e}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(i,t){var s=this.center;void 0!==t?s.copy(t):wr.setFromPoints(i).getCenter(s);let r=0;for(let t=0,e=i.length;t<e;t++)r=Math.max(r,s.distanceToSquared(i[t]));return this.radius=Math.sqrt(r),this}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){var e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){var i=this.center.distanceToSquared(t);return e.copy(t),i>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return this.isEmpty()?t.makeEmpty():(t.set(this.center,this.center),t.expandByScalar(this.radius)),t}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}expandByPoint(t){var e;return this.isEmpty()?(this.center.copy(t),this.radius=0):(Mr.subVectors(t,this.center),(t=Mr.lengthSq())>this.radius*this.radius&&(e=.5*((t=Math.sqrt(t))-this.radius),this.center.addScaledVector(Mr,e/t),this.radius+=e)),this}union(t){return t.isEmpty()||(this.isEmpty()?this.copy(t):!0===this.center.equals(t.center)?this.radius=Math.max(this.radius,t.radius):(yr.subVectors(t.center,this.center).setLength(t.radius),this.expandByPoint(Mr.copy(t.center).add(yr)),this.expandByPoint(Mr.copy(t.center).sub(yr)))),this}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}clone(){return(new this.constructor).copy(this)}}let xr=new Gt,br=new Gt,Sr=new _;class Ar{constructor(t=new Gt(1,0,0),e=0){this.isPlane=!0,this.normal=t,this.constant=e}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,i,s){return this.normal.set(t,e,i),this.constant=s,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,i){i=xr.subVectors(i,e).cross(br.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(i,t),this}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){var t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return e.copy(t).addScaledVector(this.normal,-this.distanceToPoint(t))}intersectLine(t,e){var i=t.delta(xr),s=this.normal.dot(i);return 0===s?0===this.distanceToPoint(t.start)?e.copy(t.start):null:(s=-(t.start.dot(this.normal)+this.constant)/s)<0||1<s?null:e.copy(t.start).addScaledVector(i,s)}intersectsLine(t){var e=this.distanceToPoint(t.start),t=this.distanceToPoint(t.end);return e<0&&0<t||t<0&&0<e}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){e=e||Sr.getNormalMatrix(t),t=this.coplanarPoint(xr).applyMatrix4(t),e=this.normal.applyMatrix3(e).normalize();return this.constant=-t.dot(e),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}clone(){return(new this.constructor).copy(this)}}let Tr=new Er,Rr=new Gt;class Lr{constructor(t=new Ar,e=new Ar,i=new Ar,s=new Ar,r=new Ar,n=new Ar){this.planes=[t,e,i,s,r,n]}set(t,e,i,s,r,n){var a=this.planes;return a[0].copy(t),a[1].copy(e),a[2].copy(i),a[3].copy(s),a[4].copy(r),a[5].copy(n),this}copy(e){var i=this.planes;for(let t=0;t<6;t++)i[t].copy(e.planes[t]);return this}setFromProjectionMatrix(t,e=Xi){var i=this.planes,t=t.elements,s=t[0],r=t[1],n=t[2],a=t[3],h=t[4],o=t[5],l=t[6],u=t[7],c=t[8],f=t[9],d=t[10],v=t[11],p=t[12],m=t[13],g=t[14],t=t[15];if(i[0].setComponents(a-s,u-h,v-c,t-p).normalize(),i[1].setComponents(a+s,u+h,v+c,t+p).normalize(),i[2].setComponents(a+r,u+o,v+f,t+m).normalize(),i[3].setComponents(a-r,u-o,v-f,t-m).normalize(),i[4].setComponents(a-n,u-l,v-d,t-g).normalize(),e===Xi)i[5].setComponents(a+n,u+l,v+d,t+g).normalize();else{if(e!==Yi)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+e);i[5].setComponents(n,l,d,g).normalize()}return this}intersectsObject(t){var e;return(void 0!==t.boundingSphere?(null===t.boundingSphere&&t.computeBoundingSphere(),Tr.copy(t.boundingSphere)):(null===(e=t.geometry).boundingSphere&&e.computeBoundingSphere(),Tr.copy(e.boundingSphere))).applyMatrix4(t.matrixWorld),this.intersectsSphere(Tr)}intersectsSprite(t){return Tr.center.set(0,0,0),Tr.radius=.7071067811865476,Tr.applyMatrix4(t.matrixWorld),this.intersectsSphere(Tr)}intersectsSphere(t){var e=this.planes,i=t.center,s=-t.radius;for(let t=0;t<6;t++)if(e[t].distanceToPoint(i)<s)return!1;return!0}intersectsBox(e){var i=this.planes;for(let t=0;t<6;t++){var s=i[t];if(Rr.x=(0<s.normal.x?e.max:e.min).x,Rr.y=(0<s.normal.y?e.max:e.min).y,Rr.z=(0<s.normal.z?e.max:e.min).z,s.distanceToPoint(Rr)<0)return!1}return!0}containsPoint(e){var i=this.planes;for(let t=0;t<6;t++)if(i[t].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}let u={FOV:35,CAMERA_NEAR:1,CAMERA_FAR:1e5,ZOOM_UPPER_BOUND:30,TILT_UPPER_BOUND:90,THOUSAND:1e3,DEG2RAD:.0174532,RAD2DEG:57.2957795,DRAW_TIME:500,EPS:.001},Cr=(Object.freeze(u),{MODE_3D:2,MODE_2D:4}),p=(Object.freeze(Cr),{NONE:0,EXTRUDE_MARKER:2,FM3DTILE_LAYER:4,IMAGE_MARKER:8,LOCATION_MARKER:16,POLYGON_MARKER:32,TEXT_MARKER:64,LINE_MARKER:128,LINE3D_MARKER:256,HEAT_MAP_MARKER:512,EXTENT:1024,EXTERNAL_MODEL:2048,MODEL:4096,FACILITY:8192,LABEL:16384,DYNAMIC_MODEL_MARKER:32768,DOM_MARKER:65536,SPHERE_MARKER:1<<17,CAD_LAYER:1<<18,EXTENT_LAYER:1<<20,EXTERNAL_MODEL_LAYER:1<<21,MODEL_LAYER:1<<22,FACILITY_LAYER:1<<23,LABEL_LAYER:1<<24,MARKER_GROUP:1<<25,FLOW_LINE_LAYER:1<<27,FLOW_LINE_MARKER:1<<27,FIRE_MARKER:1<<28,WALL_MARKER:1<<29,TUBE_MARKER:1<<30}),Nr=(p.LAYER_NODE_TYPE=new Map,p.LAYER_NODE_TYPE.set(p.EXTENT_LAYER,p.EXTENT),p.LAYER_NODE_TYPE.set(p.EXTERNAL_MODEL_LAYER,p.EXTERNAL_MODEL),p.LAYER_NODE_TYPE.set(p.MODEL_LAYER,p.MODEL),p.LAYER_NODE_TYPE.set(p.FACILITY_LAYER,p.FACILITY),p.LAYER_NODE_TYPE.set(p.LABEL_LAYER,p.LABEL),p.LAYER_NODE_TYPE.set(p.DOM_MARKER,p.DOM_MARKER),p.LAYER_NODE_TYPE.set(p.DYNAMIC_MODEL_MARKER,p.DYNAMIC_MODEL_MARKER),p.LAYER_NODE_TYPE.set(p.EXTRUDE_MARKER,p.EXTRUDE_MARKER),p.LAYER_NODE_TYPE.set(p.HEAT_MAP_MARKER,p.HEAT_MAP_MARKER),p.LAYER_NODE_TYPE.set(p.LINE_MARKER,p.LINE_MARKER),p.LAYER_NODE_TYPE.set(p.LOCATION_MARKER,p.LOCATION_MARKER),p.LAYER_NODE_TYPE.set(p.POLYGON_MARKER,p.POLYGON_MARKER),p.LAYER_NODE_TYPE.set(p.TEXT_MARKER,p.TEXT_MARKER),p.LAYER_NODE_TYPE.set(p.IMAGE_MARKER,p.IMAGE_MARKER),p.LAYER_NODE_TYPE.set(p.FLOW_LINE_LAYER,p.FLOW_LINE_MARKER),p.LAYER_NODE_TYPE.set(p.FIRE_MARKER,p.FIRE_MARKER),p.LAYER_NODE_TYPE.set(p.WALL_MARKER,p.WALL_MARKER),p.LAYER_NODE_TYPE.set(p.TUBE_MARKER,p.TUBE_MARKER),p.LAYER_NODE_TYPE.set(p.LINE3D_MARKER,p.LINE3D_MARKER),p.LAYER_NODE_TYPE.set(p.SPHERE_MARKER,p.SPHERE_MARKER),p.LAYER_NODE_TYPE.set(p.CAD_LAYER,p.CAD_LAYER),{NAME_KEY_ERROR:0,MAP_ID_URL_ERROR:2,THEME_ID_URL_ERROR:4,LICENSE_ERROR:8,PATH_ERROR:404,INFO:32,DEFAULT_LEVEL_ERROR:64}),Ir={RIGHT:2,LEFT:4,BOTTOM:8,TOP:16,RIGHT_BOTTOM:32,LEFT_BOTTOM:64,RIGHT_TOP:128,LEFT_TOP:256,CENTER:512};Object.freeze(Ir);class Vt{constructor(t=0,e=0,i=0,s=1){Vt.prototype.isVector4=!0,this.x=t,this.y=e,this.z=i,this.w=s}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){var e=this.x,i=this.y,s=this.z,r=this.w,t=t.elements;return this.x=t[0]*e+t[4]*i+t[8]*s+t[12]*r,this.y=t[1]*e+t[5]*i+t[9]*s+t[13]*r,this.z=t[2]*e+t[6]*i+t[10]*s+t[14]*r,this.w=t[3]*e+t[7]*i+t[11]*s+t[15]*r,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);var e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(e){let t,i,s,r;var n,a,h,o,l,u,e=e.elements,c=e[0],f=e[4],d=e[8],v=e[1],p=e[5],m=e[9],g=e[2],_=e[6],e=e[10];if(Math.abs(f-v)<.01&&Math.abs(d-g)<.01&&Math.abs(m-_)<.01)Math.abs(f+v)<.1&&Math.abs(d+g)<.1&&Math.abs(m+_)<.1&&Math.abs(c+p+e-3)<.1?this.set(1,0,0,0):(t=Math.PI,h=(e+1)/2,o=(f+v)/4,l=(d+g)/4,u=(m+_)/4,(a=(p+1)/2)<(n=(c+1)/2)&&h<n?r=n<.01?(i=0,s=.707106781):(i=Math.sqrt(n),s=o/i,l/i):h<a?r=a<.01?(i=.707106781,s=0,.707106781):(s=Math.sqrt(a),i=o/s,u/s):h<.01?(i=.707106781,s=.707106781,r=0):(r=Math.sqrt(h),i=l/r,s=u/r),this.set(i,s,r,t));else{let t=Math.sqrt((_-m)*(_-m)+(d-g)*(d-g)+(v-f)*(v-f));Math.abs(t)<.001&&(t=1),this.x=(_-m)/t,this.y=(d-g)/t,this.z=(v-f)/t,this.w=Math.acos((c+p+e-1)/2)}return this}setFromMatrixPosition(t){t=t.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this.w=t[15],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this.w=Math.max(t,Math.min(e,this.w)),this}clampLength(t,e){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this.w=t.w+(e.w-t.w)*i,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}let I={BROWSER:0,WX:1},nt=(Object.freeze(I),{document:"undefined"!=typeof document?document:{},window:"undefined"!=typeof window?window:{},environment:I.BROWSER,XMLHttpRequest:"undefined"!=typeof XMLHttpRequest?XMLHttpRequest:{}});class Pr{constructor(){}static convertPointCoordsByCenter(t,e){return t.x=t.x-e.x,t.y=t.y-e.y,void 0!==t.z&&void 0!==e.z&&(t.z=t.z-e.z),t}static convertPointsCoordsByCenter(e,i){for(let t=0;t<e.length;t++)this.convertPointCoordsByCenter(e[t],i);return e}static getMapScaleInfo(){if(!Pr.scaleInfo){let t;if(nt.environment===I.WX)return 96/2.54;var e;window.screen.deviceXDPI?t=window.screen.deviceXDPI:((e=document.createElement("DIV")).style.cssText="width:1in;height:1in;position:absolute;left:0px;top:0px;z-index:99;visibility:hidden",document.body.appendChild(e),t=parseInt(e.offsetWidth),e.parentNode.removeChild(e)),Pr.scaleInfo=t/2.54}return Pr.scaleInfo}static getCenterByAnchor(t){var e=new ct(.5,.5);switch(t){case Ir.LEFT:e.setX(0);break;case Ir.RIGHT:e.setX(1);break;case Ir.TOP:e.setY(1);break;case Ir.BOTTOM:e.setY(0);break;case Ir.LEFT_TOP:e.set(0,1);break;case Ir.RIGHT_TOP:e.set(1,1);break;case Ir.LEFT_BOTTOM:e.set(0,0);break;case Ir.RIGHT_BOTTOM:e.set(1,0)}return e}static uniqWithArrayOne(t){let e=[];return t.forEach(t=>{e.includes(t)||e.push(t)}),e}static uniqWithArrayTwo(i){if(i.length<1)return[];i=JSON.parse(JSON.stringify(i));let s=[];for(let e=0;e<i.length;e++){let t=this.uniqWithArrayOne(i[e]);t=t.filter(t=>!s.includes(t)),i[e]=t,s=s.concat(t)}return i.filter(t=>0<t.length)}static compareArrays(e,i){if(e.length!==i.length)return!1;for(let t=0;t<e.length;t++){var s,r=e[t],n=i[t];if(Object.keys(r).length!==Object.keys(n).length)return!1;for(s in r)if(r[s]&&n[s]&&r[s]!==n[s])return!1}return!0}}let Dr=(new _).set(.8224621,.177538,0,.0331941,.9668058,0,.0170827,.0723974,.9105199),Or=(new _).set(1.2249401,-.2249404,0,-.0420569,1.0420571,0,-.0196376,-.0786361,1.0982735),Ur={[Si]:{transfer:Ri,primaries:Ci,luminanceCoefficients:[.2126,.7152,.0722],toReference:t=>t,fromReference:t=>t},[bi]:{transfer:Li,primaries:Ci,luminanceCoefficients:[.2126,.7152,.0722],toReference:t=>t.convertSRGBToLinear(),fromReference:t=>t.convertLinearToSRGB()},[Ti]:{transfer:Ri,primaries:Ni,luminanceCoefficients:[.2289,.6917,.0793],toReference:t=>t.applyMatrix3(Or),fromReference:t=>t.applyMatrix3(Dr)},[Ai]:{transfer:Li,primaries:Ni,luminanceCoefficients:[.2289,.6917,.0793],toReference:t=>t.convertSRGBToLinear().applyMatrix3(Or),fromReference:t=>t.applyMatrix3(Dr).convertLinearToSRGB()}},Fr=new Set([Si,Ti]),zt={enabled:!0,C:Si,get workingColorSpace(){return this.C},set workingColorSpace(t){if(!Fr.has(t))throw new Error(`Unsupported working color space, "${t}".`);this.C=t},convert:function(t,e,i){return!1!==this.enabled&&e!==i&&e&&i?(e=Ur[e].toReference,(0,Ur[i].fromReference)(e(t))):t},fromWorkingColorSpace:function(t,e){return this.convert(t,this.C,e)},toWorkingColorSpace:function(t,e){return this.convert(t,e,this.C)},getPrimaries:function(t){return Ur[t].primaries},getTransfer:function(t){return t===xi?Ri:Ur[t].transfer},getLuminanceCoefficients:function(t,e=this.C){return t.fromArray(Ur[e].luminanceCoefficients)}};function Br(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function kr(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}let Gr=.001,Hr=Si,Vr=Si,zr=!1,Wr=!1;function jr(){return zr}function Xr(t){zr=t}function Yr(){return Vr}function Zr(t){Vr=t}function qr(){return Gr}function Kr(t){Gr=t}function Jr(){return Wr}function $r(t){Wr=t}let Qr={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},tn={h:0,s:0,l:0},en={h:0,s:0,l:0};function sn(t,e,i){return i<0&&(i+=1),1<i&&--i,i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+6*(e-t)*(2/3-i):t}class Wt{constructor(t,e,i){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(t,e,i)}set(t,e,i){var s;return void 0===e&&void 0===i?(s=t)&&s.isColor?this.copy(s):"number"==typeof s?this.setHex(s):"string"==typeof s&&this.setStyle(s):this.setRGB(t,e,i),this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t,e=Hr){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,zt.toWorkingColorSpace(this,e),this}setRGB(t,e,i,s=zt.workingColorSpace){return this.r=t,this.g=e,this.b=i,zt.toWorkingColorSpace(this,s),this}setHSL(t,e,i,s=zt.workingColorSpace){return t=ts(t,1),e=Qi(e,0,1),i=Qi(i,0,1),0===e?this.r=this.g=this.b=i:(this.r=sn(e=2*i-(i=i<=.5?i*(1+e):i+e-i*e),i,t+1/3),this.g=sn(e,i,t),this.b=sn(e,i,t-1/3)),zt.toWorkingColorSpace(this,s),this}setStyle(e,i=Hr){function s(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}if(a=/^(\w+)\(([^\)]*)\)/.exec(e)){let t;var r=a[1],n=a[2];switch(r){case"rgb":case"rgba":if(t=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return s(t[4]),this.setRGB(Math.min(255,parseInt(t[1],10))/255,Math.min(255,parseInt(t[2],10))/255,Math.min(255,parseInt(t[3],10))/255,i);if(t=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return s(t[4]),this.setRGB(Math.min(100,parseInt(t[1],10))/100,Math.min(100,parseInt(t[2],10))/100,Math.min(100,parseInt(t[3],10))/100,i);break;case"hsl":case"hsla":if(t=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return s(t[4]),this.setHSL(parseFloat(t[1])/360,parseFloat(t[2])/100,parseFloat(t[3])/100,i);break;default:console.warn("THREE.Color: Unknown color model "+e)}}else if(a=/^\#([A-Fa-f\d]+)$/.exec(e)){var r=a[1],a=r.length;if(3===a)return this.setRGB(parseInt(r.charAt(0),16)/15,parseInt(r.charAt(1),16)/15,parseInt(r.charAt(2),16)/15,i);if(6===a)return this.setHex(parseInt(r,16),i);console.warn("THREE.Color: Invalid hex color "+e)}else if(e&&0<e.length)return this.setColorName(e,i);return this}setColorName(t,e=Hr){var i=Qr[t.toLowerCase()];return void 0!==i?this.setHex(i,e):console.warn("THREE.Color: Unknown color "+t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copySRGBToLinear(t){return this.r=Br(t.r),this.g=Br(t.g),this.b=Br(t.b),this}copyLinearToSRGB(t){return this.r=kr(t.r),this.g=kr(t.g),this.b=kr(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(t=Hr){return zt.fromWorkingColorSpace(rn.copy(this),t),65536*Math.round(Qi(255*rn.r,0,255))+256*Math.round(Qi(255*rn.g,0,255))+Math.round(Qi(255*rn.b,0,255))}getHexString(t=Hr){return("000000"+this.getHex(t).toString(16)).slice(-6)}getHSL(t,e=zt.workingColorSpace){zt.fromWorkingColorSpace(rn.copy(this),e);var i=rn.r,s=rn.g,r=rn.b,e=Math.max(i,s,r),n=Math.min(i,s,r);let a,h;var o=(n+e)/2;if(n===e)a=0,h=0;else{var l=e-n;switch(h=o<=.5?l/(e+n):l/(2-e-n),e){case i:a=(s-r)/l+(s<r?6:0);break;case s:a=(r-i)/l+2;break;case r:a=(i-s)/l+4}a/=6}return t.h=a,t.s=h,t.l=o,t}getRGB(t,e=zt.workingColorSpace){return zt.fromWorkingColorSpace(rn.copy(this),e),t.r=rn.r,t.g=rn.g,t.b=rn.b,t}getStyle(t=Hr){zt.fromWorkingColorSpace(rn.copy(this),t);var e=rn.r,i=rn.g,s=rn.b;return t!==Hr?`color(${t} ${e.toFixed(3)} ${i.toFixed(3)} ${s.toFixed(3)})`:`rgb(${Math.round(255*e)},${Math.round(255*i)},${Math.round(255*s)})`}offsetHSL(t,e,i){return this.getHSL(tn),this.setHSL(tn.h+t,tn.s+e,tn.l+i)}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,i){return this.r=t.r+(e.r-t.r)*i,this.g=t.g+(e.g-t.g)*i,this.b=t.b+(e.b-t.b)*i,this}lerpHSL(t,e){this.getHSL(tn),t.getHSL(en);var t=ss(tn.h,en.h,e),i=ss(tn.s,en.s,e),e=ss(tn.l,en.l,e);return this.setHSL(t,i,e),this}setFromVector3(t){return this.r=t.x,this.g=t.y,this.b=t.z,this}applyMatrix3(t){var e=this.r,i=this.g,s=this.b,t=t.elements;return this.r=t[0]*e+t[3]*i+t[6]*s,this.g=t[1]*e+t[4]*i+t[7]*s,this.b=t[2]*e+t[5]*i+t[8]*s,this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}let rn=new Wt;Wt.NAMES=Qr;class nn{constructor(){}static round(t){return 0<t.toFixed(2)?Math.ceil(t.toFixed(2)):Math.floor(t.toFixed(2))}static generateUUID(){var e=[];for(let t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);var t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,r=4294967295*Math.random()|0,t=e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]+"-"+e[255&i]+e[i>>8&255]+"-"+e[i>>16&15|64]+e[i>>24&255]+"-"+e[63&s|128]+e[s>>8&255]+"-"+e[s>>16&255]+e[s>>24&255]+e[255&r]+e[r>>8&255]+e[r>>16&255]+e[r>>24&255];return e.length=0,t.toUpperCase()}static findNearNthPowerOfTwo(t){t-=1;return(t=(t=(t=(t=(t|=t>>1)|t>>2)|t>>4)|t>>8)|t>>16)<0?1:1+t}static rgbToArray(t){var e=new Wt;return e.setStyle(t),[e.r,e.g,e.b]}static toRgba(t){var e;return void 0===t?t:"number"!=typeof t?3<=(e=t.split(",")).length?"rgba("+parseInt(e[0])+","+parseInt(e[1])+","+parseInt(e[2])+",1)":t:"rgba("+parseInt(255*new Wt(t).r)+","+parseInt(255*new Wt(t).g)+","+parseInt(255*new Wt(t).b)+",1)"}static toColor(t){var e;return"number"==typeof t?t:3<=(e=t.split(",")).length?parseInt(e[0])<<16|parseInt(e[1])<<8|parseInt(e[2]):(console.error("color format error",t),0)}static cov(r){var t=[],e=[0,0],n=[];for(let t=0;t<r.length;t++)e[0]+=r[t].x,e[1]+=r[t].y;e[0]=e[0]/r.length,e[1]=e[1]/r.length;for(let t=0;t<r.length;t++)n.push([r[t].x-e[0],r[t].y-e[1]]);var a=[];for(let e=0;e<n[0].length;e++){var i=[];for(let t=0;t<n.length;t++)i.push(n[t][e]);a.push(i)}for(let s=0;s<a.length;s++){var h=[];for(let i=0;i<n[0].length;i++){let e=0;for(let t=0;t<a[s].length;t++)e+=a[s][t]*n[t][i];e/=r.length-1,h.push(e)}t.push(h)}return t}static eig(t){var e=(t[0][0]+t[1][1])/2,i=t[0][0]*t[1][1]-t[1][0]*t[0][1],s=e+Math.sqrt(e*e-i),e=e-Math.sqrt(e*e-i);return 0==t[0][1]&&0==t[1][0]?{eigValue:[s,e],eigVect:[[1,0],[0,1]]}:(i=(s-t[0][0])/t[0][1],t=(e-t[0][0])/t[0][1],{eigValue:[s,e],eigVect:[[1/Math.sqrt(1+i*i),i/Math.sqrt(1+i*i)],[1/Math.sqrt(1+t*t),t/Math.sqrt(1+t*t)]]})}}class an{constructor(t){this.N=(t=t||{}).src,this.I=t.dest,this.P=null,this.D=[],this.O=0,this.U=0,this.F=0,this.B=u.THOUSAND,this.k=!1,this.G=!1,this.H=!0,this.V=null,this.W=null,this.j=nn.generateUUID()}play(){return this.X()}pause(){return this.G=!0,this}resume(){return this.G=!1,this.O+=this.F,this.F=0,this}stop(){return this.H=!0,this}finish(){return this.H=!0,this.W&&this.W(),this.D=[],this}setSrc(t){return this.Y(t)}setDest(t){return this.Z(t)}setDuration(t){return this.K(t)}setUpdate(t){return this.J(t)}setCallback(t){return this.$(t)}inverse(){return this.tt()}setDelay(t){return this.et(t)}}function hn(t){Object.assign(t.prototype,{it(t){let e=this.st.getZoom()*t,i=new an({src:[this.st.getZoom()],dest:[e]});e>this.nt.rt[1]||e<this.nt.rt[0]||(i.K(.5).J(t=>this.st.setZoom({animate:!1,zoom:t.destination[0]})).$(()=>this.st.ot.ht(i)),this.st.ot.lt(i.X()))},ut(){var t=this.st.ct.isPerspectiveCamera?this.ft():this.dt();return this.vt(t)},gt(t,e){this.st.ot.ht(e),this._t({zoom:t.zoom,animate:!1,finish:t.finish})},_t(i){this.nt.zoom=i.zoom;var t=Number.isFinite(i.duration)?i.duration:.5,s=this.wt(this.nt.zoom);let r=this.Mt(s),n=this.yt.object.position.distanceTo(this.yt.target),e=(new Gt).copy(this.yt.object.position).sub(this.yt.target).normalize(),a=(new Gt).copy(e).multiplyScalar(r-n);if(this.st.ct.isPerspectiveCamera)if("animate"in i&&!i.animate)this.yt.update({offset:a,dirction:r-n}),i.finish&&i.finish();else{let e=new an({src:[0,0,0],dest:[a.x,a.y,a.z]});e.K(t).J(t=>{"PerspectiveCamera"===this.st.ct.type?this.yt.update({offset:new Gt(t.delta[0],t.delta[1],t.delta[2]),dirction:r-n}):this.gt(i,e)}).$(()=>{this.st.ot.ht(e),i.finish&&i.finish()}),this.st.ot.lt(e.X())}else if("animate"in i&&!i.animate){var h=this.Et(s);this.st.ct.zoom=1/h,this.st.ct.updateProjectionMatrix(),this.st.bt.xt(),this.yt.update({offset:a}),i.finish&&i.finish()}else{let e=new an({src:[this.dt()],dest:[s]});e.K(t).J(t=>{"OrthographicCamera"===this.st.ct.type?(t=this.Et(t.destination[0]),this.st.ct.zoom=1/t,this.st.ct.updateProjectionMatrix(),this.st.bt.xt(),this.st.enableUpdateRender(),this.st.St()):this.gt(i,e)}).$(()=>{this.yt.update({offset:a,dirction:r-n}),this.st.ot.ht(e),i.finish&&i.finish()}),this.st.ot.lt(e.X())}},At(t){this.nt.rt=t,this.Tt(),this.yt.update()},Tt(){var t=this.wt(this.nt.rt[0]),e=this.wt(this.nt.rt[1]);this.yt.maxDistance=this.Mt(t),this.yt.minDistance=this.Mt(e),this.yt.minZoom=1/this.Et(t),this.yt.maxZoom=1/this.Et(e)},wt(t){var e=this.Rt.length-1,i=(--t,t=Math.max(0,Math.min(t,e)),Math.floor(t)),t=t-i,s=Math.max(0,Math.min(i,e)),e=Math.max(0,Math.min(i+1,e)),s=this.Rt[s]-this.Rt[e];return this.Rt[i]-s*t},vt(e){let i=0,s=.1,r=!1;for(let t=0;t<this.Rt.length-1;t++)if(e<=this.Rt[t]&&e>this.Rt[t+1]){i=t,s=(this.Rt[t]-e)/(this.Rt[t]-this.Rt[t+1]),r=!0;break}let t=null;var n;return t=r?parseFloat((i+1+s).toFixed(2)):(n=this.Rt.length-1,e<=this.Rt[n]?1+n:1)},Mt(t){return t/100*(this.st.bt.renderer.domElement.clientHeight/Pr.getMapScaleInfo())/2/Math.tan(u.FOV/2*u.DEG2RAD)},ft(){return(new Gt).copy(this.yt.object.position).sub(this.yt.target).length()*(100*Math.tan(u.FOV/2*u.DEG2RAD)*2/(this.st.bt.renderer.domElement.clientHeight/Pr.getMapScaleInfo()))},dt(){var t=this.st.ct.top,e=this.st.ct.bottom;return Math.abs(t-e)*Pr.getMapScaleInfo()*100/this.st.bt.renderer.domElement.clientHeight/this.st.ct.zoom},Et(t){var e=this.st.Lt.top,i=this.st.Lt.bottom;return t/(Math.abs(e-i)*Pr.getMapScaleInfo()*100/this.st.bt.renderer.domElement.clientHeight)}})}function on(t){Object.assign(t.prototype,{Ct(t){let e=this.yt,i=t.finish;var s;"animate"in t&&!t.animate?(e.update({phi:(u.TILT_UPPER_BOUND-t.tilt)*u.DEG2RAD}),e.update(),i&&i()):(null===this.Nt&&(this.Nt=new an),s=Number.isFinite(t.duration)?t.duration:.5,this.Nt.Y([this.st.getTilt()]).Z([t.tilt]).K(s).J(t=>{e.update({phi:(u.TILT_UPPER_BOUND-t.destination[0])*u.DEG2RAD})}).$(()=>{e.update({phi:(u.TILT_UPPER_BOUND-t.tilt)*u.DEG2RAD}),e.update(),this.st.ot.ht(this.Nt),i&&i()}),this.st.ot.lt(this.Nt.X()))},It(){let t=nn.round(-this.yt.getAzimuthalAngle()*u.RAD2DEG);return 360<(t=t<0?360+t:t)&&(t%=360),t},Pt(t,e){let i=-t%360*u.DEG2RAD,s=(i=!1===e?-t*u.DEG2RAD:i)-this.yt.getAzimuthalAngle();return s=0!==s&&e?Math.sin(s)/Math.abs(Math.sin(s))*Math.acos(Math.cos(s)):s},Dt(i){let s=void 0!==i.loop&&i.loop;var t=void 0!==i.direction?i.direction:0,e=void 0===i.minimumAngleTransformation||i.minimumAngleTransformation,r=this.yt.getAzimuthalAngle();let n;if(n=s?0===t?r-2*Math.PI:2*Math.PI+r:r+this.Pt(i.rotation,e),!("animate"in i)||i.animate){let t=i&&i.duration&&Number.isFinite(i.duration)?i.duration:.5,e=new an({src:[r],dest:[n]});return e.K(t).Ot(s).J(t=>{this.yt.update({theta:t.destination[0]})}).$(()=>{s||this.st.ot.ht(e),i.finish&&i.finish()}),this.st.ot.lt(e.X()),e}this.yt.update({theta:n}),i.finish&&i.finish()}})}function ln(t){Object.assign(t.prototype,{Ut(){var t=this.yt.target,e=this.st.Ft[0];return{x:parseFloat((e.x+t.x).toFixed(4)),y:parseFloat((e.y-t.z).toFixed(4))}},Bt(i){let s=this.yt,t=this.st.Ft[0],r=i.x-t.x,n=-i.y+t.y,a=s.target.x,h=s.target.z,e=i.height,o=!!e&&Number.isFinite(e),l,u;if(o?(u=s.target.y,l=e):u=l=0,"animate"in i&&i.animate){let t=Number.isFinite(i.duration)?i.duration:.5,e=new an({src:[a,u,h],dest:[r,l,n]});e.K(t).J(t=>{s.panAdd({x:t.delta[0],y:t.delta[1],z:t.delta[2]}),s.update(),this.st.bt.xt()}).$(()=>{this.st.ot.ht(e),this.st.bt.xt(),i.finish&&i.finish()}),this.st.ot.lt(e.X())}else s.panAdd({x:r-a,y:l-u,z:n-h}),s.update(),i.finish&&i.finish(),this.st.bt.xt()},kt(e,i){let s=this.yt,t=()=>{this.nt.Gt(e.Ht).level=i.level,this.st.bt.Vt(),this.st.Wt.zt();var t={type:"levelChanged",level:i.level};e!==this.st.jt&&(t.buildingID=e.Ht),this.st.Yt.Xt(t),this.enableDragRange&&s.saveState(),this.st.bt.xt(),this.st.Zt(),i.finish&&i.finish(i.level)};e===this.st.jt||this.st.qt?this.Kt(e,{level:i.level,animate:i.animate,duration:i.duration,callback:i.callback,finish:()=>{t()}}):t()},Kt(t,e){var i=void 0!==e.duration?e.duration:.5,s=void 0===e.animate||e.animate;let r=this.yt;var n=r.target.y;let a=t.getFloor(e.level).Jt,h={type:"updateCameraHeight"};s?(null===this.$t&&(this.$t=new an),this.$t.Y([n]).Z([a]).K(i).J(t=>{this.st.Yt.Xt(h),r.panUp(t.delta[0]),r.update()}).$(()=>{r.panUp(a-r.target.y),r.update(),e.finish&&e.finish()}),this.st.ot.lt(this.$t.X()),e.callback&&e.callback(this.$t)):(r.panUp(a-n),r.update(),e.callback&&e.callback(null),e.finish&&e.finish())}})}Object.assign(an.prototype,{Qt(){for(var t in this)this[""+t]=null,delete this[""+t]},Y(t){return this.N=t,this},Z(t){return this.I=t,this},K(t){return this.B=t*u.THOUSAND,this},et(t){return this.U=t*u.THOUSAND,this},J(t){return this.V=t,this},$(t){return this.W=t,this},Ot(t){return this.k=t,this},X(){return this.H=!1,this.P&&(this.O=this.P.te),this},ee(){var t=new this.constructor({src:this.N,dest:this.I});return t.O=this.O,t.U=this.U,t.B=this.B,t.k=this.k,t.V=this.V,t.W=this.W,t},tt(){var t=this.I.concat(),e=this.N.concat();return this.N=t,this.I=e,this}});class un{constructor(t,e){this.start=t??0,this.stop=e??0}}function C(t){return null!=t}class cn{constructor(t=null,e=null){this.center=t?.clone(),this.radius=e}get valid(){return null!==this.center&&null!==this.radius}reset(){this.center=null,this.radius=null}static computePlaneDistances(t,e,i,s){C(s)||(s=new un);var r=new Gt,e=(r.subVectors(t.center,e),i.dot(r));return s.start=e-t.radius,s.stop=e+t.radius,s}static clone(t,e){if(C(t))return C(e)?(e.center=t.center.clone(),e.radius=t.radius,e):new cn(t.center,t.radius)}static expand(t,e,i){i=cn.clone(t,i);t=e.distance(i.center);return t>i.radius&&(i.radius=t),i}static union(t,e,i){C(i)||(i=new cn);var s=t.center,r=t.radius,n=e.center,a=e.radius,h=new Gt,n=(h.subVectors(n,s),h.length());return n+a<=r?cn.clone(t,i):n+r<=a?cn.clone(e,i):(t=.5*(r+n+a),(e=h.clone()).multiplyScalar((t-r)/n),e.add(s),i.center=e.clone(),i.radius=t),i}static equals(t,e){return t===e||C(t)&&C(e)&&t.equals(e.center)&&t.radius===e.radius}}class fn{constructor(t){this.yt=t,this.ie=new un,this.se=new cn}static getMeshBoudinggSphere(t){var t=(new rr).setFromObject(t),e=new Gt,i=(t.getCenter(e),new Gt),t=(t.getSize(i),.5*i.length());return new cn(e,t)}static getSceneBoudingSphere(t,i){t.traverse(t=>{let e;"Mesh"===t.type||"SkinnedMesh"===t.type?e=fn.getMeshBoudinggSphere(t):"Scene"!==t.type&&"Group"!==t.type&&"DirectionalLight"!==t.type&&"AmbientLight"!==t.type&&(e=new cn(t.position,0)),!e||isNaN(e.radius)||isNaN(e.center.x)||isNaN(e.center.y)||isNaN(e.center.z)||(i.valid||cn.clone(e,i),cn.union(e,i,i))})}reset(){this.re()}update(t){this.ne(t)}}Object.assign(fn.prototype,{ae(){var t,e,i;!this.se.valid||this.se.radius<=0||({target:i,object:t}=this.yt,(t.far>u.CAMERA_FAR||void 0===t.userData.far)&&(t.userData.far=Math.max(t.far,t.userData.far??0)),void 0===t.userData.near&&(t.userData.near=t.near),e=t.position,i=i.clone().sub(e).normalize(),cn.computePlaneDistances(this.se,e,i,this.ie),this.ie.start>=this.ie.stop)||(t.near=Math.max(this.ie.start,t.userData.near),t.far=this.ie.stop,t.updateProjectionMatrix())},re(){this.se.reset()},ne(t){t.forEach(t=>{t&&fn.getSceneBoudingSphere(t,this.se)}),this.ae()}});class dn{constructor(t,e){this.he=t,this.oe=e}}Object.assign(dn.prototype,{le(t){return!1},ue(t,e){}});let vn={NONE:0,POINT:1,LINE:2,POLYGON:4,MULTIPOINT:8,MULTILINE:16,MULTIPOLYGON:32,GROUP:64,EXTENT:1024,EXTERNALMODEL:2048,MODEL:4096,FACILITY:8192,LABEL:16384,EXTENTGROUP:1<<20,EXTERNALMODELGROUP:1<<21,MODELGROUP:1<<22,FACILITYGROUP:1<<23,LABELGROUP:1<<24},pn=(Object.freeze(vn),{triangulate:function(h,o,l){l=l||2;var u=o&&o.length,c=u?o[0]*l:h.length;let f=mn(h,0,c,l,!0);var d=[];if(f&&f.next!==f.prev){let e,i,s,r,n,a,t;if(u&&(f=xn(h,o,f,l)),h.length>80*l){e=s=h[0],i=r=h[1];for(let t=l;t<c;t+=l)n=h[t],a=h[t+1],n<e&&(e=n),a<i&&(i=a),n>s&&(s=n),a>r&&(r=a);t=0!==(t=Math.max(s-e,r-i))?1/t:0}_n(f,d,l,e,i,t)}return d}});function mn(t,e,i,s,r){let n,a;if(r===0<Xn(t,e,i,s))for(n=e;n<i;n+=s)a=zn(n,t[n],t[n+1],a);else for(n=i-s;n>=e;n-=s)a=zn(n,t[n],t[n+1],a);return a&&On(a,a.next)&&(Wn(a),a=a.next),a}function gn(t,e){if(!t)return t;e=e||t;let i=t,s;do{if(s=!1,i.steiner||!On(i,i.next)&&0!==Dn(i.prev,i,i.next))i=i.next;else{if(Wn(i),(i=e=i.prev)===i.next)break;s=!0}}while(s||i!==e);return e}function _n(s,r,n,a,h,o,l){if(s){!l&&o&&Rn(s,a,h,o);let t=s,e,i;for(;s.prev!==s.next;)if(e=s.prev,i=s.next,o?Mn(s,a,h,o):wn(s))r.push(e.i/n),r.push(s.i/n),r.push(i.i/n),Wn(s),s=i.next,t=i.next;else if((s=i)===t){l?1===l?_n(s=yn(gn(s),r,n),r,n,a,h,o,2):2===l&&En(s,r,n,a,h,o):_n(gn(s),r,n,a,h,o,1);break}}}function wn(e){var i=e.prev,s=e,r=e.next;if(!(0<=Dn(i,s,r))){let t=e.next.next;for(;t!==e.prev;){if(In(i.x,i.y,s.x,s.y,r.x,r.y,t.x,t.y)&&0<=Dn(t.prev,t,t.next))return;t=t.next}return 1}}function Mn(i,s,r,n){var a=i.prev,h=i,o=i.next;if(!(0<=Dn(a,h,o))){var l=(a.x<h.x?a.x<o.x?a:o:h.x<o.x?h:o).x,u=(a.y<h.y?a.y<o.y?a:o:h.y<o.y?h:o).y,c=(a.x>h.x?a.x>o.x?a:o:h.x>o.x?h:o).x,f=(a.y>h.y?a.y>o.y?a:o:h.y>o.y?h:o).y,d=Cn(l,u,s,r,n),v=Cn(c,f,s,r,n);let t=i.prevZ,e=i.nextZ;for(;t&&t.z>=d&&e&&e.z<=v;){if(t!==i.prev&&t!==i.next&&In(a.x,a.y,h.x,h.y,o.x,o.y,t.x,t.y)&&0<=Dn(t.prev,t,t.next))return;if(t=t.prevZ,e!==i.prev&&e!==i.next&&In(a.x,a.y,h.x,h.y,o.x,o.y,e.x,e.y)&&0<=Dn(e.prev,e,e.next))return;e=e.nextZ}for(;t&&t.z>=d;){if(t!==i.prev&&t!==i.next&&In(a.x,a.y,h.x,h.y,o.x,o.y,t.x,t.y)&&0<=Dn(t.prev,t,t.next))return;t=t.prevZ}for(;e&&e.z<=v;){if(e!==i.prev&&e!==i.next&&In(a.x,a.y,h.x,h.y,o.x,o.y,e.x,e.y)&&0<=Dn(e.prev,e,e.next))return;e=e.nextZ}return 1}}function yn(t,e,i){let s=t;do{var r=s.prev,n=s.next.next;!On(r,n)&&Un(r,s,s.next,n)&&Gn(r,n)&&Gn(n,r)&&(e.push(r.i/i),e.push(s.i/i),e.push(n.i/i),Wn(s),Wn(s.next),s=t=n),s=s.next}while(s!==t);return gn(s)}function En(t,e,i,s,r,n){let a=t;do{let t=a.next.next;for(;t!==a.prev;){var h;if(a.i!==t.i&&Pn(a,t))return h=Vn(a,t),a=gn(a,a.next),h=gn(h,h.next),_n(a,e,i,s,r,n),void _n(h,e,i,s,r,n);t=t.next}}while((a=a.next)!==t)}function xn(t,e,i,s){var r=[];let n,a,h,o,l;for(n=0,a=e.length;n<a;n++)h=e[n]*s,o=n<a-1?e[n+1]*s:t.length,(l=mn(t,h,o,s,!1))===l.next&&(l.steiner=!0),r.push(Nn(l));for(r.sort(bn),n=0;n<r.length;n++)Sn(r[n],i),i=gn(i,i.next);return i}function bn(t,e){return t.x-e.x}function Sn(t,e){(e=An(t,e))&&(t=Vn(e,t),gn(e,e.next),gn(t,t.next))}function An(i,t){let s=t;var r=i.x,n=i.y;let a=-1/0,h;do{if(n<=s.y&&n>=s.next.y&&s.next.y!==s.y){var e=s.x+(n-s.y)*(s.next.x-s.x)/(s.next.y-s.y);if(e<=r&&e>a){if((a=e)===r){if(n===s.y)return s;if(n===s.next.y)return s.next}h=s.x<s.next.x?s:s.next}}}while((s=s.next)!==t);if(!h)return null;if(r!==a){var o=h,l=h.x,u=h.y;let t=1/0,e;for(s=h;r>=s.x&&s.x>=l&&r!==s.x&&In(n<u?r:a,n,l,u,n<u?a:r,n,s.x,s.y)&&(e=Math.abs(n-s.y)/(r-s.x),Gn(s,i))&&(e<t||e===t&&(s.x>h.x||s.x===h.x&&Tn(h,s)))&&(h=s,t=e),(s=s.next)!==o;);}return h}function Tn(t,e){return Dn(t.prev,t,e.prev)<0&&Dn(e.next,t,t.next)<0}function Rn(t,e,i,s){let r=t;for(;null===r.z&&(r.z=Cn(r.x,r.y,e,i,s)),r.prevZ=r.prev,r.nextZ=r.next,(r=r.next)!==t;);r.prevZ.nextZ=null,r.prevZ=null,Ln(r)}function Ln(t){let e,i,s,r,n,a,h,o,l=1;do{for(i=t,t=null,n=null,a=0;i;){for(a++,s=i,h=0,e=0;e<l&&(h++,s=s.nextZ);e++);for(o=l;0<h||0<o&&s;)0!==h&&(0===o||!s||i.z<=s.z)?(i=(r=i).nextZ,h--):(s=(r=s).nextZ,o--),n?n.nextZ=r:t=r,r.prevZ=n,n=r;i=s}}while(n.nextZ=null,l*=2,1<a)}function Cn(t,e,i,s,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-s)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Nn(t){let e=t,i=t;for(;(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),(e=e.next)!==t;);return i}function In(t,e,i,s,r,n,a,h){return 0<=(r-a)*(e-h)-(t-a)*(n-h)&&0<=(t-a)*(s-h)-(i-a)*(e-h)&&0<=(i-a)*(n-h)-(r-a)*(s-h)}function Pn(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!kn(t,e)&&(Gn(t,e)&&Gn(e,t)&&Hn(t,e)&&(Dn(t.prev,t,e.prev)||Dn(t,e.prev,e))||On(t,e)&&0<Dn(t.prev,t,t.next)&&0<Dn(e.prev,e,e.next))}function Dn(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function On(t,e){return t.x===e.x&&t.y===e.y}function Un(t,e,i,s){var r=Bn(Dn(t,e,i)),n=Bn(Dn(t,e,s)),a=Bn(Dn(i,s,t)),h=Bn(Dn(i,s,e));return r!==n&&a!==h||0===r&&Fn(t,i,e)||0===n&&Fn(t,s,e)||0===a&&Fn(i,t,s)||!(0!==h||!Fn(i,e,s))}function Fn(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function Bn(t){return 0<t?1:t<0?-1:0}function kn(t,e){let i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&Un(i,i.next,t,e))return 1}while((i=i.next)!==t)}function Gn(t,e){return Dn(t.prev,t,t.next)<0?0<=Dn(t,e,t.next)&&0<=Dn(t,t.prev,e):Dn(t,e,t.prev)<0||Dn(t,t.next,e)<0}function Hn(t,e){let i=t,s=!1;for(var r=(t.x+e.x)/2,n=(t.y+e.y)/2;i.y>n!=i.next.y>n&&i.next.y!==i.y&&r<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(s=!s),(i=i.next)!==t;);return s}function Vn(t,e){var i=new jn(t.i,t.x,t.y),s=new jn(e.i,e.x,e.y),r=t.next,n=e.prev;return(t.next=e).prev=t,(i.next=r).prev=i,(s.next=i).prev=s,(n.next=s).prev=n,s}function zn(t,e,i,s){t=new jn(t,e,i);return s?(t.next=s.next,(t.prev=s).next.prev=t,s.next=t):(t.prev=t).next=t,t}function Wn(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function jn(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Xn(i,s,r,n){let a=0;for(let t=s,e=r-n;t<r;t+=n)a+=(i[e]-i[t])*(i[t+1]+i[e+1]),e=t;return a}let Yn={area:function(i){var s=i.length;let r=0;for(let t=s-1,e=0;e<s;t=e++)r+=i[t].x*i[e].y-i[e].x*i[t].y;return.5*r},isClockWise:function(t){return Yn.area(t)<0},triangulateShape:function(t,e){var i=[],s=[],r=[];qn(t),Kn(i,t);let n=t.length;e.forEach(qn);for(let t=0;t<e.length;t++)s.push(n),n+=e[t].length,Kn(i,e[t]);var a=pn.triangulate(i,s);for(let t=0;t<a.length;t+=3)r.push(a.slice(t,t+3));return r},triangulate:function(e){let t=[];t.push(...e[0]);var i=[];for(let t=1;t<e.length;t++){var s=[];s.push(...e[t]),i.push(s)}if(!Yn.isClockWise(t)){t=t.reverse();for(let t=0,e=i.length;t<e;t++){var r=i[t];Yn.isClockWise(r)&&(i[t]=r.reverse())}}return Yn.triangulateShape(t,i)}};function Zn(t,e){return t.x===e.x&&t.y===e.y}function qn(t){var e=t.length;2<e&&Zn(t[e-1],t[0])&&t.pop()}function Kn(e,i){for(let t=0;t<i.length;t++)e.push(i[t].x),e.push(i[t].y)}let Jn=1e-5,$n=1e-5,Qn=.001,ta=Math.PI/180,ea=180/Math.PI;class ia{constructor(){}}Object.assign(ia.prototype,{ce(){return Jn},fe(){return ta},de(){return ea},ve(t){return t<Jn&&t>-Jn},pe(t){return t>Jn},me(t){return t<-Jn},ge(t,e,i){e=(t.x-i.x)*(e.y-i.y)-(e.x-i.x)*(t.y-i.y);return Math.abs(e)<Jn?0:e},distanceOfTwoPoints(t,e){return t&&e?Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)):Number.NaN},distance(t,e){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))},isPolygonContainPoint(s,r){let n=0;for(let i=0;i<s.length;i++){var a=s[i].x,h=s[i].y;let t=0,e=0;if(e=(i<s.length-1?(t=s[i+1].x,s[i+1]):(t=s[0].x,s[0])).y,a===r.x&&h===r.y||t===r.x&&e===r.y)return!0;if(e!==h){var o=a+(r.y-h)*(t-a)/(e-h);if(o===r.x)return!0;a!==t?o<=Math.max(a,t)&&o>=Math.min(a,t)&&o>r.x&&o!==a&&(o===t&&0<(h-r.y)*(e-r.y)?n+=2:n++):o<=Math.max(a,t)&&o>=Math.min(a,t)&&o>r.x&&(o===t&&0<(h-r.y)*(e-r.y)?n+=2:n++)}}return 0<n%2},isPolygonContainPoint2(e,i){var s=e.length;if(s<3)return!1;let r=s-1,n=!1,a=0;for(let t=0;t<s;t++){var h=e[t],o=e[r];h.y>i.y!=o.y>i.y&&i.x<(o.x-h.x)*(i.y-h.y)/(o.y-h.y)+h.x&&(n=!n,h.y>o.y?a++:a--),r=t}return 0!=a},isPolygonInPolygon(t,e){var i=Object.assign([],t),s=Object.assign([],e);i.push(i[0]),s.push(s[0]);for(let t=0;t<i.length-1;t++){var r=i[t];if(!this.isPolygonContainPoint(s,r)&&!this.isPolygonContainPoint2(s,r))return!1}for(let e=0;e<i.length-1;e++)for(let t=0;t<s.length-1;t++)if(this._e(i[e],i[e+1],s[t],s[t+1]).isintersect&&!this.we(s[t],s[t+1],i[e])&&!this.we(s[t],s[t+1],i[e+1]))return!1;return!0},Me(t,e,i,s){return!(Math.max(t.x,e.x)<Math.min(i.x,s.x)||Math.max(t.y,e.y)<Math.min(i.y,s.y)||Math.max(i.x,s.x)<Math.min(t.x,e.x)||Math.max(i.y,s.y)<Math.min(t.y,e.y))},ye(t,e,i,s){return!(Math.max(t.x,e.x)<Math.min(i.x,s.x)||Math.max(t.y,e.y)<Math.min(i.y,s.y)||Math.max(i.x,s.x)<Math.min(t.x,e.x)||Math.max(i.y,s.y)<Math.min(t.y,e.y)||0===this.ge(i,e,t)&&0===this.ge(e,s,t)||this.ge(i,e,t)*this.ge(e,s,t)<0||this.ge(t,s,i)*this.ge(s,e,i)<0)},Ee(t,e,i){return!(t.x<e.x||t.y<e.y||t.x>i.x||i.y<t.y)},xe(t,e,i){var s=Math.min(e.x,i.x),r=Math.max(e.x,i.x),n=Math.min(e.y,i.y),e=Math.max(e.y,i.y);return!(t.x<s||t.x>r||t.y<n||t.y>e)},be(t,e,i){var s=Math.min(i.x,e.x),r=Math.max(i.x,e.x),n=Math.min(i.y,e.y),i=Math.max(i.y,e.y);return!(t.x<s||t.x>r||t.y<n||t.y>i)},Se(e,i,s){let r=!1;var n,a;for(let t=0;t<s;t++)n=i[t],a=i[(t+1)%s],(n.y<e.y&&a.y>=e.y||a.y<e.y&&n.y>=e.y)&&(n.x<=e.x||a.x<=e.x)&&n.x+(e.y-n.y)/(a.y-n.y)*(a.x-n.x)<e.x&&(r=!r);return r},Ae(t,e,i){return(t.x-e.x)*(i.y-e.y)==(i.x-e.x)*(t.y-e.y)&&Math.min(e.x,i.x)<=t.x&&t.x<=Math.max(e.x,i.x)&&Math.min(e.y,i.y)<=t.y&&t.y<=Math.max(e.y,i.y)},Te(t,e){return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))},Re(t,e){return(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)},Le(t,e,i){let s;var r=e.x,e=e.y,n=i.x,i=i.y,a=t.x,t=t.y,h=n-r,o=i-e,l=h*h+o*o,u=a-r,c=t-e,f=u*u+c*c;return this.ve(l)?s=this.ve(f)?0:f:(o=(l=h/(h=Math.sqrt(l)))*u+(u=o/h)*c,s=this.pe(o)?this.me(o-h)?(c=a-(r+o*l))*c+(h=t-(e+o*u))*h:(r=a-n)*r+(l=t-i)*l:f,this.ve(s)?0:s)},Ce(t,e,i,s){let r;var n=e.x,a=e.y,h=i.x,o=i.y,l=t.x,t=t.y,u=h-n,c=o-a,f=Math.sqrt(u*u+c*c),d=l-n,v=t-a,p=Math.sqrt(d*d+v*v);return r=!this.ve(f)&&(c=(u=u/f)*d+(d=c/f)*v,this.pe(c))?this.me(c-f)?(f=l-(v=n+c*u),u=t-(n=a+c*d),a=Math.sqrt(f*f+u*u),s.x=v,s.y=n,a):(c=l-h,d=t-o,f=Math.sqrt(c*c+d*d),s.x=i.x,s.y=i.y,f):(s.x=e.x,s.y=e.y,p),this.ve(r)?0:r},Ne(e,i){let s=0,r=0,n=0;for(let t=0;t<i;t++){var a=e[t],h=e[(t+1)%i],o=(a.x*h.y-a.y*h.x)/2;s+=o,r+=o*(a.x+h.x)/3,n+=o*(a.y+h.y)/3}return r/=s,n/=s,{x:r,y:n}},Ie(e){var i=Yn.triangulate([e]);let s=0,r=0,n=0;for(let t=0;t<i.length;t++){var a=e[i[t][0]],h=e[i[t][1]],o=e[i[t][2]],l={x:h.x-a.x,y:h.y-a.y},u={x:o.x-a.x,y:o.y-a.y},u=(l.x*u.y-u.x*l.y)/2,l=(s+=u,(a.x+h.x+o.x)/3);r+=l*u,n+=(a.y+h.y+o.y)/3*u}return{x:r/s,y:n/s}},Pe(e,i){if(i<3)return 0;let s=0;for(let t=0;t<i;++t){var r=e[t],n=e[(t+1)%i];s+=r.x*n.y-r.y*n.x}return Math.abs(s/2)},De(t,e,i,s,r){var n;return this.ye(t,e,i,s)?(n=(s.x-i.x)*(t.y-e.y)-(e.x-t.x)*(i.y-s.y),r.x=((t.y-i.y)*(e.x-t.x)*(s.x-i.x)+i.x*(s.y-i.y)*(e.x-t.x)-t.x*(e.y-t.y)*(s.x-i.x))/n,r.y=(e.y*(t.x-e.x)*(s.y-i.y)+(s.x-e.x)*(s.y-i.y)*(t.y-e.y)-s.y*(i.x-s.x)*(e.y-t.y))/(n=(t.x-e.x)*(s.y-i.y)-(e.y-t.y)*(i.x-s.x)),1):0},Oe(t,e,i,s,r){var n=Math.min(i.x,s.x),a=Math.max(i.x,s.x),h=Math.min(i.y,s.y),o=Math.max(i.y,s.y),l=t.x,u=t.y,c=i.x,f=i.y,d=s.x,v=s.y;if(90==e)return!(t.x<n||t.x>a||(a-n<Qn?t.y>=f&&t.y<=v||t.y>=v&&t.y<=f?(r.x=t.x,r.y=t.y,0):f<v&&t.x<f?(r.x=c,r.y=f,0):!(v<f&&t.x<v)||(r.x=d,r.y=v,0):(r.y=p=(v-f)/(d-c)*(l-c)+f,r.x=l,p<u||!this.be(r,i,s))));if(270==e)return!(t.x<n||t.x>a||(Math.abs(a-n<Qn)?t.y>=f&&t.y<=v||t.y>=v&&t.y<=f?(r.x=t.x,r.y=t.y,0):f<v&&t.y>v?(r.x=d,r.y=v,0):!(v<f&&t.y>f)||(r.x=c,r.y=f,0):(r.y=p=(v-f)/(d-c)*(l-c)+f,r.x=l,u<p||!this.be(r,i,s))));if(270!=e&&90!=e&&Math.abs(a-n<Qn)){var t=n,p=Math.tan(e/180*Math.PI)*(t-l)+u;if(r.y=p,r.x=t,this.be(r,i,s))return a=p-u,0<(n=t-l)/Math.sqrt(n*n+a*a)*Math.cos(e/180*Math.PI)}return Math.abs(o-h<=Qn)?(p=h,t=1/Math.tan(e/180*Math.PI)*(p-u)+l,r.x=t,r.y=p,!!this.be(r,i,s)&&(n=p-u,0<(a=t-l)/Math.sqrt(a*a+n*n)*Math.cos(e/180*Math.PI))):(t=u+(o=Math.tan(e/180*Math.PI))*((p=(f-u-((h=(v-f)/(d-c))*c-o*l))/(o-h))-l),r.x=p,r.y=t,!!this.be(r,i,s)&&(a=p-l,n=t-u,Math.abs(a)<=Qn&&Math.abs(n)<=Qn||0<a/Math.sqrt(a*a+n*n)*Math.cos(e/180*Math.PI)))},Ue(t,e){return Math.abs(t.x-e.x)<Jn&&Math.abs(t.y-e.y)<Jn},Fe(t,e,i,s){var r,n,a,h,o=t.x,l=t.y,u=e.x,c=e.y,f=i.x,d=i.y;return this.Ue(t,e)||this.Ue(t,i)?(s.x=o,s.y=l,!0):(a=Math.min(e.x,i.x),h=Math.max(e.x,i.x),r=Math.min(e.y,i.y),n=Math.max(e.y,i.y),Math.abs(u-f)<$n?(s.x=u,r<=(s.y=l)&&l<=n):Math.abs(c-d)<$n?(s.x=o,s.y=c,a<=o&&o<=h):(h=l+(r=-1/((d-c)/(f-u)))*((a=(c-l-((n=(d-c)/(f-u))*u-r*o))/(r-n))-o),s.x=a,s.y=h,!!this.be(s,e,i)||!(!this.Ue(t,e)&&!this.Ue(t,i))))},Be(t,e){return{x:t.y*e.z-t.z*e.y,y:t.z*e.x-t.x*e.z,z:t.x*e.y-t.y*e.x}},ke(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},Ge(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)},He(t,e){return t.x*e.x+t.y*e.y},Ve(t,e){return t.x*e.y-t.y*e.x},ze(t){return Math.sqrt(t.x*t.x+t.y*t.y)},We(t,e){var i,s;return 0==t.x&&0==t.y||0==e.x&&0==e.y?0:(i={x:e.x,y:e.y,z:0},i=this.Be({x:t.x,y:t.y,z:0},i),s=this.He(t,e),s=Math.acos(s/(this.ze(t)*this.ze(e))),0<i.z?s/Math.PI*180:360-s/Math.PI*180)},je(e,i,s,r){for(let t=0;t<s.length;t++){var n=s[t],a=s[(t+1)%s.length];if(1==this.De(e,i,n,a,r))return!0}return!1},Xe(t,e,i,s,r){var n=Math.min(t.x,i.x,s.x),a=Math.max(t.x,i.x,s.x),h=Math.min(t.y,i.y,s.y),o=Math.max(t.y,i.y,s.y),a=Math.sqrt((a-n)*(a-n)+(o-h)*(o-h)),n=e/180*Math.PI,o=a*Math.cos(n)+t.x,h=a*Math.sin(n)+t.y;return 1==this.De(t,{x:o,y:h},i,s,r)},Ye(e){var t={x:null,y:null};let i=0,s=0,r=e.length;1<e.length&&e[0].x===e[e.length-1].x&&e[0].y===e[e.length-1].y&&r--;for(let t=0;t<r;t++)i+=e[t].x,s+=e[t].y;return t.x=i/e.length,t.y=s/e.length,t},Ze(t,e,i,s){var r=[],n=t.x-e,a=t.x+e,h=t.y-e,o=t.y+e,l=Math.min(i.x,s.x),u=Math.max(i.x,s.x),c=Math.min(i.y,s.y),f=Math.max(i.y,s.y);return u<n||a<l||f<h||o<c||(a=(t=((n=s.x-i.x)*(a=t.x-i.x)+(h=s.y-i.y)*(o=t.y-i.y))/(s=n*n+h*h))*t-(a*a+o*o-e*e)/s)<0||(o=Math.sqrt(a),s={x:i.x-n*(e=-t+o),y:i.y-h*e},n={x:i.x-n*(a=-t-o),y:i.y-h*a},e!==a&&(l<=s.x&&s.x<=u&&c<=s.y&&s.y<=f&&r.push(s),l<=n.x)&&n.x<=u&&c<=n.y&&n.y<=f&&r.push(n)),r},qe(t,e){return Math.abs(t.x-e.x)<=Jn&&Math.abs(t.y-e.y)<=Jn},Ke(t,e,i){var s,r={};if(t.x!=e.x)return s=e=(e.y-t.y)/(e.x-t.x),r.x=(+i.x- -1*s*i.y-s*(e=t.y-e*t.x))/(s*s+1),r.y=(s*s*i.y- -1*s*i.x- -1*e)/(s*s+1),r;r.x=t.x,r.y=i.y},_e(t,e,i,s){var r,n,a,h,o={point:null,isintersect:!1};return this.distanceOfTwoPoints(t,i)<.001||this.distanceOfTwoPoints(t,s)<.001?(o.isintersect=!0,o.point=t):this.distanceOfTwoPoints(e,i)<.001||this.distanceOfTwoPoints(e,s)<.001?(o.isintersect=!0,o.point=e):(r={x:e.x-t.x,y:e.y-t.y},n={x:s.x-i.x,y:s.y-i.y},s={x:s.x-t.x,y:s.y-t.y},e={x:e.x-i.x,y:e.y-i.y},a={x:-(i={x:i.x-t.x,y:i.y-t.y}).x,y:-i.y},h=this.Ve(n,r),Math.abs(h)<=1e-5||this.Ve(i,r)*this.Ve(s,r)<=-5e-4&&this.Ve(a,n)*this.Ve(e,n)<-5e-4&&(s=this.Ve(n,i)/h,o.point={x:t.x+r.x*s,y:t.y+r.y*s},o.isintersect=!0)),o},Je(t,e,i){return t.x===e.x&&(e.x=e.x+1),t.y===e.y&&(e.y=e.y+1),e.x===i.x&&(i.x=i.x+1),e.y===i.y&&(i.y=i.y+1),!(0<(e.x-t.x)*(i.y-e.y)-(e.y-t.y)*(i.x-e.x))},getAngle(t){var e=t.p1,t=t.p2,i=t.x-e.x,t=t.y-e.y,e=Math.sqrt(i*i+t*t),e=Math.asin(Math.abs(t)/e);return 0<i&&0<t?e:i<0&&0<t?Math.PI-e:i<0&&t<0?Math.PI+e:0<i&&t<0?2*Math.PI-e:0==i&&0<t?e:0==i&&t<0?3*Math.PI/2:0<i&&0==t?e:i<0&&0==t?Math.PI:null},$e(t){var e=this.distanceOfTwoPoints(t[0],t[1]),i=this.distanceOfTwoPoints(t[1],t[2]),t=this.distanceOfTwoPoints(t[0],t[2]),s=(e+i+t)/2;return Math.sqrt(s*(s-e)*(s-i)*(s-t))},Qe(t,e){var i,s,r,n,a;return this.Ce(t,e[0],e[1],{})<1e-4||this.Ce(t,e[0],e[2],{})<1e-4||this.Ce(t,e[1],e[2],{})<1e-4||(n={x:e[1].x-e[0].x,y:e[1].y-e[0].y},i={x:e[0].x-e[2].x,y:e[0].y-e[2].y},s={x:e[2].x-e[1].x,y:e[2].y-e[1].y},a={x:t.x-e[0].x,y:t.y-e[0].y},r={x:t.x-e[1].x,y:t.y-e[1].y},t={x:t.x-e[2].x,y:t.y-e[2].y},e=this.Ve(n,a),n=this.Ve(s,r),a=this.Ve(i,t),e*n>Jn&&n*a>Jn)},ti(s,r,n){var a=n.length,h={isintersect:!1,start:null,end:null,type:0,outer:null},o=[];if(this.Qe(s,n)&&(h.start=s),this.Qe(r,n)&&(h.end=r),null!=h.start&&null!=h.end)h.isintersect=!0,h.type=1;else{let e=(n[1].x+n[2].x)/2,i=(n[1].y+n[2].y)/2;for(let t=1;t<a;t++){var l,u=this._e(s,r,n[t-1],n[t]);if(u.isintersect){if(null!=h.start)return h.end=u.point,h.isintersect=!0,h.outer="end",l=this.We({x:e-n[0].x,y:i-n[0].y},{x:r.x-n[0].x,y:r.y-n[0].y}),h.type=0<(l=l<180?l:l-360)?2:3,h;if(null!=h.end)return h.start=u.point,h.isintersect=!0,h.outer="start",l=this.We({x:e-n[0].x,y:i-n[0].y},{x:s.x-n[0].x,y:s.y-n[0].y}),h.type=0<(l=l<180?l:l-360)?2:3,h;o.push(u)}}var t,c=this._e(s,r,n[0],n[a-1]);if(c.isintersect){if(null!=h.start)return h.end=c.point,h.isintersect=!0,h.outer="end",t=this.We({x:e-n[0].x,y:i-n[0].y},{x:r.x-n[0].x,y:r.y-n[0].y}),h.type=0<(t=t<180?t:t-360)?2:3,h;if(null!=h.end)return h.start=c.point,h.isintersect=!0,h.outer="start",t=this.We({x:e-n[0].x,y:i-n[0].y},{x:s.x-n[0].x,y:s.y-n[0].y}),h.type=0<(t=t<180?t:t-360)?2:3,h;o.push(c)}2!=o.length||this.distanceOfTwoPoints(o[0].point,o[1].point)<.01||(this.distanceOfTwoPoints(o[0].point,s)<=this.distanceOfTwoPoints(o[0].point,r)?(h.start=o[0].point,h.end=o[1].point):(h.start=o[1].point,h.end=o[0].point),h.isintersect=!0,h.type=4)}return h},ei(e,i,s){var r=s.length,n={isintersect:!1,start:null,end:null},a=[];if(this.Qe(e,s)&&(n.start=e),this.Qe(i,s)&&(n.end=i),null!=n.start&&null!=n.end)n.isintersect=!0;else{for(let t=1;t<r;t++){var h=this._e(e,i,s[t-1],s[t]);if(h.isintersect){if(null!=n.start)return n.end=h.point,n.isintersect=!0,n;if(null!=n.end)return n.start=e,n.isintersect=!0,n;a.push(h)}}var t=this._e(e,i,s[0],s[r-1]);if(t.isintersect){if(null!=n.start)return n.end=t.point,n.isintersect=!0,n;if(null!=n.end)return n.start=e,n.isintersect=!0,n;a.push(t)}2==a.length&&(n.start=(this.distanceOfTwoPoints(a[0].point,e)<=this.distanceOfTwoPoints(a[0].point,i)?a[0]:a[1]).point,n.end=(this.distanceOfTwoPoints(a[0].point,e)>this.distanceOfTwoPoints(a[0].point,i)?a[0]:a[1]).point,n.isintersect=!0)}return n},ii(r,t){if(0==t.length)return[r];var e,i,s=this.si(t),n=[];s.sort(function(t,e){var i=(t.ri.x-r.ri.x)*(t.ri.x-r.ri.x)+(t.ri.y-r.ri.y)*(t.ri.y-r.ri.y),s=(e.ri.x-r.ri.x)*(e.ri.x-r.ri.x)+(e.ri.y-r.ri.y)*(e.ri.y-r.ri.y),t=(t.ni.x-r.ri.x)*(t.ni.x-r.ri.x)+(t.ni.y-r.ri.y)*(t.ni.y-r.ri.y),e=(e.ni.x-r.ri.x)*(e.ni.x-r.ri.x)+(e.ni.y-r.ri.y)*(e.ni.y-r.ri.y);return(i<t?i:t)<(s<e?s:e)});let a=0;for(a=0;a<s.length;a++)this.distanceOfTwoPoints(s[a].ri,s[a].ni)<.01||(e=this.distanceOfTwoPoints(s[a].ri,r.ri),i=this.distanceOfTwoPoints(s[a].ni,r.ri),e<.01?r.ri=s[a].ni:i<.01?r.ri=s[a].ri:e<i?.1<this.distanceOfTwoPoints(r.ri,s[a].ri)&&(n.push({ai:r.ai,ri:r.ri,ni:s[a].ri,Te:r.Te,oi:r.oi}),r.ri=s[a].ni):.1<this.distanceOfTwoPoints(r.ri,s[a].ni)&&(n.push({ai:r.ai,ri:r.ri,ni:s[a].ni,Te:r.Te,oi:r.oi}),r.ri=s[a].ri),s.splice(a,1));return.1<this.distanceOfTwoPoints(r.ri,r.ni)&&n.push(r),n},si(t){var e=[];if(1==t.length)return t;let i=t[0],s=1;for(;0<t.length;){if(s>=t.length){if(e.push(i),t.splice(0,1),t.length<1)break;i=t[0],s=1}if(1===t.length){e.push(i);break}this.we(i.ri,i.ni,t[s].ri)?(this.we(i.ri,i.ni,t[s].ni)||(i.ni=t[s].ni),t.splice(s,1)):this.we(i.ri,i.ni,t[s].ni)?(i.ri=t[s].ri,t.splice(s,1)):this.we(t[s].ri,t[s].ni,i.ri)?(i=(this.we(t[s].ri,t[s].ni,i.ni)||(t[s].ni=i.ni),t[s]),t.splice(s,1)):this.we(t[s].ri,t[s].ni,i.ni)?(t[s].ri=i.ri,i=t[s],t.splice(s,1)):s++}return e},we(t,e,i){let s=t.x-i.x,r=t.y-i.y,n=e.x-i.x,a=e.y-i.y;var h=this.distanceOfTwoPoints(t,i),i=this.distanceOfTwoPoints(e,i),t=this.distanceOfTwoPoints(t,e);return s*a-r*n<1e-5&&h+i-t<.001},li(t,e,i){let s=e.x-t.x,r=e.y-t.y;t=Math.sqrt(s*s+r*r);return{x:e.x+s/t*i,y:e.y+r/t*i}},ui(e){let i=null,s=0,t=0,r=0;for(let t=0;t<e.length;t++)(null===i||e[t].x>i)&&(i=e[t].x,s=t);var n=new Gt(e[s].x,e[s].y,0),a=(t=0===s?e.length-1:s-1,r=s===e.length-1?0:s+1,new Gt(e[t].x,e[t].y,0)),h=new Gt(e[r].x,e[r].y,0),a=(new Gt).copy(n).sub(a),h=(new Gt).copy(h).sub(n);return 0<a.cross(h).z}});let G=new ia;class sa{constructor(){this.ci={x:Number.MAX_VALUE,y:Number.MAX_VALUE},this.fi={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE}}get min(){return this.ci}get max(){return this.fi}get center(){var t={x:Number.NaN,y:Number.NaN};return this.valid()&&(t.x=(this.min.x+this.max.x)/2,t.y=(this.min.y+this.max.y)/2),t}get size(){var t={x:Number.NaN,y:Number.NaN};return this.valid()&&(t.x=this.max.x-this.min.x,t.y=this.max.y-this.min.y),t}copy(t){return this.fi.x=t.max.x,this.fi.y=t.max.y,this.ci.x=t.min.x,this.ci.y=t.min.y,this}clone(){return(new sa).copy(this)}reset(){this.ci={x:Number.MAX_VALUE,y:Number.MAX_VALUE},this.fi={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE}}toObject(){return{min:this.min,max:this.max,center:this.center,size:this.size}}expand(t){this.di(t)}expandByCoords(t){this.vi(t)}valid(){return this.pi()}isCross(t){let e=!0;return t.max.x<this.min.x&&(e=!1),t.min.x>this.max.x&&(e=!1),t.max.y<this.min.y&&(e=!1),e=t.min.y>this.max.y?!1:e}}Object.assign(sa.prototype,{pi(){return!(this.min.x>this.max.x||this.min.y>this.max.y)},di(t){t&&t.valid()&&(t.min.x<this.min.x&&(this.min.x=t.min.x),t.min.y<this.min.y&&(this.min.y=t.min.y),t.max.x>this.max.x&&(this.max.x=t.max.x),t.max.y>this.max.y)&&(this.max.y=t.max.y)},vi(t){t&&0!=t.length&&t.forEach(t=>{t.x<this.min.x&&(this.min.x=t.x),t.y<this.min.y&&(this.min.y=t.y),t.x>this.max.x&&(this.max.x=t.x),t.y>this.max.y&&(this.max.y=t.y)})}});class ra extends dn{constructor(t,e){super(t,e),this.mi=new sa,this.gi=null}}Object.assign(ra.prototype,{le(t){return t.getType()!=vn.MODEL?this._i(t):this.wi(t)},wi(t){return!0},Mi(t){t=t.getBound();return!!G.Me(this.mi.ci,this.mi.fi,t.min,t.max)},ue(t,e){var r=t.getCoordinates();if(t.getType()!==vn.MODEL)e.Te=Math.sqrt(G.Re(r[0],this.yi));else{let s=Number.MAX_VALUE;for(let i=0,t=r.length;i<t;i++)for(let t=1,e=r[i].length;t<e;t++){var n=r[i][t-1],a=r[i][t],n=G.Le(this.yi,n,a);s>n&&(s=n)}e.Te=Math.sqrt(s)}},_i(t){t=t.getCoordinates()[0];return!!G.Ee(t,this.mi.ci,this.mi.fi)&&("circle"===this.gi?G.Re(t,this.yi)<this._radiusSquare:G.Se(t,this.Ei,this.Ei.length-1))}});class na extends ra{constructor(t,e){super(t,e),this.gi="polygon",this.Ei=this.oe,this.xi=this.Ei.length-1,this.yi=G.Ie(this.Ei),this.mi.vi(this.Ei)}}Object.assign(na.prototype,{wi(t){if(this.Mi(t)){var n=t.getCoordinates();for(let i=0,t=n.length;i<t;i++)for(let t=0,e=n[i].length-1;t<e;t++)if(G.Se(n[i][t],this.Ei,this.Ei.length))return!0;for(let s=0;s<this.xi;s++){let i=!1;for(let t=0,e=n.length;t<e;t++)G.Se(this.Ei[s],n[t],n[t].length-1)&&(i=0==t);if(i)return!0}for(let t=0;t<=this.xi;t++){let s=null,r=null;r=t===this.xi?(s=this.Ei[0],this.Ei[t]):(s=this.Ei[t],this.Ei[t+1]);for(let i=0,t=n.length;i<t;i++)for(let t=0,e=n[i].length-1;t<e;t++){var a=n[i][t],h=n[i][t+1];if(G.ye(s,r,a,h))return!0}}}return!1}});class aa{constructor(){}static coordsMapToScreen(t,e){var i=void 0!==e.height?e.height:0;let s=t.getMapOptions().buildingID;e.buildingID&&(s=e.buildingID);var r=t.getBuilding(s),n=(void 0!==e.level?e:r).level,r=void 0!==e.z?e.z:r.getFloor(n).Jt;return this.coordsMapToScreen_(t,{x:e.x,y:e.y,z:r+i})}static coordsScreenToMap(a,h,o){var l=(void 0!==h.buildingID?h:a.getMapOptions()).buildingID,l=a.getBuilding(l);if(l){var u=a.jt,c=(void 0!==h.level?h:l).level,l=void 0!==h.z?h.z:l.getFloor(c).Jt;let t=null,e=a.bt.renderer.domElement.clientWidth,i=a.bt.renderer.domElement.clientHeight,s=new Gt,r=new Gt;c=((t=o||a.bi.yt.object).userData?.near?t.userData:t).near,o=(t.userData?.far?t.userData:t).far;t.isPerspectiveCamera?(t.updateMatrixWorld(),s.setFromMatrixPosition(t.matrixWorld),a=h.x/e*2-1,r.set(a,-h.y/i*2+1,c).unproject(t).sub(s).normalize()):(a=h.x/e*2-1,s.set(a,-h.y/i*2+1,(c+o)/(c-o)).unproject(t),r.set(0,0,-1).transformDirection(t.matrixWorld));let n=(-s.y+l)/r.y;n<0&&(n=o);a=(new Gt).copy(s).add((new Gt).copy(r).multiplyScalar(n));return{x:a.x+u.x,y:u.y-a.z,z:l}}}static coordsMapToScreen_(t,e){var i=t.bi.yt.object,s=(i.userData?.near?i.userData:i).near,r=(i.userData?.far?i.userData:i).far,n=i.near,a=i.far,s=(i.near=s,i.far=r,i.updateProjectionMatrix(),t.jt),r=new Gt(e.x-s.x,e.z,-e.y+s.y).project(i),e=t.bt.renderer.domElement.clientWidth,s=t.bt.renderer.domElement.clientHeight;return i.near=n,i.far=a,i.updateProjectionMatrix(),r.z<-1||1<r.z?null:{x:Math.round(e/2*r.x+e/2),y:Math.round(-s/2*r.y+s/2)}}static exportToImage(t,e,i,s,r){}static screenshot(t,e,i,s,r,n,a,h){}}var ha="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function oa(t){return t&&t.Si&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var la={exports:{}},ua=(la.exports,(()=>{function e(t){return 180*t/Math.PI}function c(t){return e(Math.atan2(t[1][1]-t[0][1],t[1][0]-t[0][0]))}function f(t,e){return(t=>{if(Array.isArray(t))return t})(t)||((t,e)=>{var i=[],s=!0,r=!1,n=void 0;try{for(var a,h=t[Symbol.iterator]();!(s=(a=h.next()).done)&&(i.push(a.value),!e||i.length!==e);s=!0);}catch(t){r=!0,n=t}finally{try{s||null==h.return||h.return()}finally{if(r)throw n}}return i})(t,e)||(()=>{throw new TypeError("Invalid attempt to destructure non-iterable instance")})()}function s(t){return(t=>{if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}})(t)||(t=>{if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)})(t)||(()=>{throw new TypeError("Invalid attempt to spread non-iterable instance")})()}function d(t){var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1],t=f(t,2),i=f(t[0],2),s=i[0],r=i[1],i=f(t[1],2),n=i[0],a=i[1];return function(t){t=e?t<0?0:1<t?1:t:t;return[(n-s)*t+s,(a-r)*t+r]}}function v(t){return Math.sqrt(Math.pow(t[1][0]-t[0][0],2)+Math.pow(t[1][1]-t[0][1],2))}function r(t){return[(t[0][0]+t[1][0])/2,(t[0][1]+t[1][1])/2]}function n(t){return t/180*Math.PI}function a(t,e,i){e=n(e||0);return!i||0===i[0]&&0===i[1]?h(t,e):h(t.map(function(t,e){return t-i[e]}),e).map(function(t,e){return t+i[e]})}function h(t,e){return[t[0]*Math.cos(e)-t[1]*Math.sin(e),t[0]*Math.sin(e)+t[1]*Math.cos(e)]}function p(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,e=n(e);return[t[0]+i*Math.cos(e),t[1]+i*Math.sin(e)]}function l(t){for(var e=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=0,s=0,r=t.length;s<r;s++)var n=t[s],a=t[s===r-1?0:s+1],i=(i+=n[0]*a[1])-a[0]*n[1];return e?i/2:Math.abs(i/2)}function m(t){if(t.length<3)return null;for(var e=1/0,i=-1/0,s=1/0,r=-1/0,n=!1,a=0,h=t.length;a<h;a++){var o=t[a],l=o[0],o=o[1];null!=l&&isFinite(l)&&null!=o&&isFinite(o)&&(n=!0,l<e&&(e=l),i<l&&(i=l),o<s&&(s=o),r<o)&&(r=o)}return n?[[e,s],[i,r]]:null}function u(t){for(var e=0,i=0,s=0,r=t.length,n=0;n<r;n++){var a=t[n],h=t[n===r-1?0:n+1],o=a[0]*h[1]-h[0]*a[1];e+=o,i+=(a[0]+h[0])*o,s+=(a[1]+h[1])*o}var l=3*e;return[i/l,s/l]}function o(t,e,i){return(t[0]-i[0])*(e[1]-i[1])-(t[1]-i[1])*(e[0]-i[0])}function g(t){return i=(e=t)[0],e=e[e.length-1],i[0]===e[0]&&i[1]===e[1]?t:[].concat(s(t),[t[0]]);var e,i}function _(t){if(0===t.length)return 0;for(var e,i,s=-1,r=t.length,n=t[r-1],a=n[0],h=n[1],o=0;++s<r;)e=a,i=h,e-=a=(n=t[s])[0],i-=h=n[1],o+=Math.sqrt(e*e+i*i);return o}function w(t,e,i){i=i||u(t);for(var s=[],r=0,n=t.length;r<n;r++){var a=t[r],h=v([i,a]),a=c([i,a]);s[r]=p(i,a,h*Math.sqrt(e))}return s}function M(t,e,i){for(var s=[],r=0,n=t.length;r<n;r++)s[r]=p(t[r],e,i);return s}function y(t,e,i){for(var s=e,r=e,n=[],a=1;a<t.length-1;a++){var h=t[a];.5<Math.random()?(n.push(h-s),s=h):(n.push(r-h),r=h)}return n.push(i-s),n.push(r-i),n}function i(t){return t[1][1]>t[0][1]?t:[t[1],t[0]]}function E(t,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,s=v(e);return x(t,e,i)&&v([e[0],t])<=s&&v([e[1],t])<=s}function x(t,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;return Math.abs(o(t,e[0],e[1]))<=i}function b(t,e){var i=f(t,2),s=f(i[0],2),r=s[0],s=s[1],i=f(i[1],2),n=i[0],i=i[1],a=f(e,2),h=f(a[0],2),o=h[0],h=h[1],a=f(a[1],2),l=a[0],a=a[1];return r===o&&s===h||n===l&&i===a||!!(E(t[0],e)||E(t[1],e)||E(e[0],t)||E(e[1],t))||0!=(e=(a-h)*(n-r)-(l-o)*(i-s))&&(i=((n-r)*(t=s-h)-(i-s)*(n=r-o))/e,0<(s=((l-o)*t-(a-h)*n)/e))&&s<1&&0<i&&i<1}function S(t,e){for(var i=!1,s=g(e),r=0,n=s.length-1;r<n;r++){var a=s[r],h=s[r+1];if(b(t,[a,h])||E(a,t)&&E(h,t)){i=!0;break}}return i}function A(t,e){for(var i=t[0],s=t[1],r=!1,n=0,a=e.length-1;n<e.length;a=n++){var h=e[n][0],o=e[n][1],l=e[a][0],u=e[a][1];s<o!=s<u&&i<(l-h)*(s-o)/(u-o)+h&&(r=!r)}return r}function T(t,e){for(var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,s=!1,r=g(e),n=0,a=r.length-1;n<a;n++)if(E(t,[r[n],r[n+1]],i)){s=!0;break}return s}var t;(t=la.exports).lineAngle=c,t.lineInterpolate=d,t.lineLength=v,t.lineMidpoint=r,t.lineRotate=function(e,i,s){return e.map(function(t){return a(t,i,s||r(e))})},t.lineTranslate=function(t,e,i){return t.map(function(t){return p(t,e,i)})},t.pointRotate=a,t.pointTranslate=p,t.polygonArea=l,t.polygonBounds=m,t.polygonCentroid=u,t.polygonHull=function(t){if(t.length<3)return null;for(var e=t.slice().sort(function(t,e){return t[0]===e[0]?t[1]-e[1]:t[0]-e[0]}),i=[],s=0;s<e.length;s++){for(;2<=i.length&&o(i[i.length-2],i[i.length-1],e[s])<=0;)i.pop();i.push(e[s])}for(var r=[],n=e.length-1;0<=n;n--){for(;2<=r.length&&o(r[r.length-2],r[r.length-1],e[n])<=0;)r.pop();r.push(e[n])}return r.pop(),i.pop(),i.concat(r)},t.polygonInterpolate=function(u){return function(t){if(t<=0)return u[0];var e=g(u);if(1<=t)return e[e.length-1];for(var i=_(e)*t,s=[],r=0,n=0;n<e.length-1;n++){var a=[e[n],e[n+1]],h=v(a),o=c(a),l=i-(r+=h);if(l<0){s=p(a[0],o,h+l);break}n===u.length-2&&(s=p(a[0],o,l))}return s}},t.polygonLength=_,t.polygonMean=function(t){for(var e=0,i=0,s=t.length,r=0;r<s;r++){var n=t[r];e+=n[0],i+=n[1]}return[e/s,i/s]},t.polygonRandom=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:3,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:100,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[0,0],s=Math.sqrt(e/Math.PI),r=Array.from({length:t},function(){return 2*s*Math.random()}),t=Array.from({length:t},function(){return 2*s*Math.random()}),r=(r.sort(function(t,e){return t-e}),t.sort(function(t,e){return t-e}),y(r,r[0],r[r.length-1])),n=y(t,t[0],t[t.length-1]),a=((t=>{for(var e=t.length-1;0<e;e--){var i=Math.floor(Math.random()*(e+1)),s=[t[i],t[e]];t[e]=s[0],t[i]=s[1]}})(n),[]),h=0,o=0,t=(r.map(function(t,e){return[t,n[e]]}).sort(function(t,e){return Math.atan2(e[1],e[0])-Math.atan2(t[1],t[0])}).forEach(function(t){h+=+t[0],o+=+t[1],a.push([h,o])}),u(a));return M(w(a,e/l(a)),c([t,i]),v([t,i]))},t.polygonReflectX=function(t){for(var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,i=f(m(t),2),s=f(i[0],2),r=s[0],s=f(i[1],2),n=s[0],a=[],h=0,o=t.length;h<o;h++){var l=f(t[h],2),u=l[0],l=l[1],c=[r+n-u,l];0===e?a[h]=[u,l]:1===e?a[h]=c:(u=d([[u,l],c]),a[h]=u(Math.max(Math.min(e,1),0)))}return a},t.polygonReflectY=function(t){for(var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,i=f(m(t),2),s=f(i[0],2),r=(s[0],s[1]),s=f(i[1],2),n=(s[0],s[1]),a=[],h=0,o=t.length;h<o;h++){var l=f(t[h],2),u=l[0],l=l[1],c=[u,r+n-l];0===e?a[h]=[u,l]:1===e?a[h]=c:(u=d([[u,l],c]),a[h]=u(Math.max(Math.min(e,1),0)))}return a},t.polygonRegular=function(){for(var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:3,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:100,i=2<arguments.length?arguments[2]:void 0,s=[],r=[0,0],n=[0,0],a=0,h=0;h<t;h++)s[h]=r,n[0]+=r[0],n[1]+=r[1],r=p(r,a,Math.sqrt(4*e*Math.tan(Math.PI/t)/t)),a-=360/t;i&&(s=M(s,c(i=[[n[0]/t,n[1]/t],i]),v(i)));return s},t.polygonRotate=function(t,e,i){for(var s=[],r=0,n=t.length;r<n;r++)s[r]=a(t[r],e,i);return s},t.polygonScale=function(t,e,i){i=i||u(t);for(var s=[],r=0,n=t.length;r<n;r++){var a=t[r],h=v([i,a]),a=c([i,a]);s[r]=p(i,a,h*e)}return s},t.polygonScaleArea=w,t.polygonScaleX=function(t,e,i){i=i||u(t);for(var s=[],r=0,n=t.length;r<n;r++){var a=t[r],h=v([i,a]),o=c([i,a]),o=p(i,o,h*e);s[r]=[o[0],a[1]]}return s},t.polygonScaleY=function(t,e,i){i=i||u(t);for(var s=[],r=0,n=t.length;r<n;r++){var a=t[r],h=v([i,a]),o=c([i,a]),o=p(i,o,h*e);s[r]=[a[0],o[1]]}return s},t.polygonTranslate=M,t.polygonWind=function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"ccw";if(t.length<3)return null;var i=t.slice().reverse(),s=0<l(t,!0);return"cw"===e||"clockwise"===e?s?t:i:s?i:t},t.lineIntersectsLine=b,t.lineIntersectsPolygon=S,t.pointInPolygon=A,t.pointOnPolygon=T,t.pointLeftofLine=function(t,e){e=i(e);return o(t,e[1],e[0])<0},t.pointRightofLine=function(t,e){e=i(e);return 0<o(t,e[1],e[0])},t.pointOnLine=E,t.pointWithLine=x,t.polygonInPolygon=function(t,e){for(var i=!0,s=g(t),r=0,n=s.length-1;r<n;r++){var a=s[r];if(!A(a,e)){i=!1;break}if(S([a,s[r+1]],e)){i=!1;break}}return i},t.polygonIntersectsPolygon=function(t,e){for(var i=!1,s=0,r=g(t),n=0,a=r.length-1;n<a;n++){var h=r[n],o=r[n+1];if(S([h,o],e)){i=!0;break}if(T(h,e)&&++s,2===s){i=!0;break}}return i},t.angleReflect=function(t,e){e=2*e-t;return 360<=e?e-360:e<0?360+e:e},t.angleToDegrees=e,t.angleToRadians=n,Object.defineProperty(t,"Si",{value:!0})})(),la.exports),ca;let fa={STOP:0,PASS:1,PUSH:2};Object.freeze(fa);class da{constructor(){this.Ht=-1,this.Ai=vn.NONE,this.Ti=null,this.mi=null}getType(){return this.Ai}getCoordinates(){return this.Ti}getBound(){return this.mi||this.Ri(),this.mi}}Object.assign(da.prototype,{Qt(){},Li(t){t._support(this)==fa.PUSH&&t._result.push(this)}});class va extends da{constructor(t){super(),this.Ht=t.eid,this.Ai=vn.POLYGON,Object.assign(this,t)}getCenter(){return this.yi}}Object.assign(va.prototype,{Ri(){this.mi=new sa,this.Ti&&this.Ti.forEach(t=>{this.mi.vi(t)})},Li(t){t._support(this)==fa.PUSH&&t._result.push(this)}});let pa={NO_RIGHT_CLICK:2,NORMAL:4};Object.freeze(pa);class ma{constructor(t=1,e=0,i=0){return this.radius=t,this.phi=e,this.theta=i,this}set(t,e,i){return this.radius=t,this.phi=e,this.theta=i,this}copy(t){return this.radius=t.radius,this.phi=t.phi,this.theta=t.theta,this}makeSafe(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this}setFromVector3(t){return this.setFromCartesianCoords(t.x,t.y,t.z)}setFromCartesianCoords(t,e,i){return this.radius=Math.sqrt(t*t+e*e+i*i),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(t,i),this.phi=Math.acos(Qi(e/this.radius,-1,1))),this}clone(){return(new this.constructor).copy(this)}}function ga(t,e){e=aa.coordsScreenToMap(t.st,{x:e.x,y:e.y});return{x:e.x-t.st.x,y:e.z,z:t.st.y-e.y}}let _a=1e-5,wa=Math.PI/180;function Ma(t,e,i){return Math.max(e,Math.min(i,t))}function ya(t,e=_a){return Math.abs(t)<e}function Ea(t,e,i=_a){return ya(t-e,i)}function xa(t,e,i,s,r=1/0,n){var a=2/(s=Math.max(1e-4,s)),h=a*n,h=1/(1+h+.48*h*h+.235*h*h*h),o=e,r=r*s,r=(e=t-(s=Ma(t-e,-r,r)),(i.value+a*s)*n);i.value=(i.value-a*r)*h;let l=e+(s+r)*h;return 0<o-t==l>o&&(l=o,i.value=(l-o)/n),l}function ba(t,e,i,s,r=1/0,n,a){var h=2/(s=Math.max(1e-4,s)),o=h*n,o=1/(1+o+.48*o*o+.235*o*o*o),l=e.x,u=e.y,e=e.z;let c=t.x-l,f=t.y-u,d=t.z-e;var v=l,p=u,m=e,r=r*s,s=c*c+f*f+d*d,s=(r*r<s&&(s=Math.sqrt(s),c=c/s*r,f=f/s*r,d=d/s*r),l=t.x-c,u=t.y-f,e=t.z-d,(i.x+h*c)*n),r=(i.y+h*f)*n,g=(i.z+h*d)*n,h=(i.x=(i.x-h*s)*o,i.y=(i.y-h*r)*o,i.z=(i.z-h*g)*o,a.x=l+(c+s)*o,a.y=u+(f+r)*o,a.z=e+(d+g)*o,v-t.x);0<h*(a.x-v)+(p-t.y)*(a.y-p)+(m-t.z)*(a.z-m)&&(a.x=v,a.y=p,a.z=m,i.x=(a.x-v)/n,i.y=(a.y-p)/n,i.z=(a.z-m)/n)}function Sa(t){return t.isPerspectiveCamera}function Aa(t){return t.isOrthographicCamera}function Ta(t,e){t=aa.coordsScreenToMap(e.st,{x:t.clientX-e.Ci.x,y:t.clientY-e.Ci.y});return{x:t.x-e.st.x,y:t.z,z:e.st.y-t.y}}function Ra(t){const e=t.touches[0].pageX,i=t.touches[0].pageY,s=t.touches[1].pageX,r=t.touches[1].pageY;return{x:(e+s)/2,y:(i+r)/2}}function La(){let e=!0;if(navigator){var i=navigator.userAgent,s=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"];for(let t=0;t<s.length;t++)if(0<i.indexOf(s[t])){e=!1;break}}return e}let Ca={CENTER:2,MOUSE:4},Na=(Object.freeze(Ca),/Mac/.test(null==(ca=null==globalThis?void 0:globalThis.navigator)?void 0:ca.platform)),Ia=Object.freeze(new Gt(0,1,0)),Pa=new Gt,Da=new Gt,Oa=new Gt,Ua=new Gt,Fa=new Gt,Ba=new Gt,ka=new Gt,Ga=new Gt;var Ha=function(U,t,F){void 0===t&&console.warn('THREE.OrbitControls: The second parameter "domElement" is now mandatory.'),t===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.object=U,this.isScreenLock=!1,this.domElement=t,this.st=F,this.enabled=!0,this.useRange=!1,this.target=new Gt,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.isDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.zoomSpeedParam=1,this.enableRotate=!0,this.enableRotateLeft=!0,this.enableRotateUp=!0,this.rotateSpeed=2,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={LEFT:at.ROTATE,MIDDLE:at.DOLLY,RIGHT:at.PAN},this.touches={ONE:ht.ROTATE,TWO:ht.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.rotateLeftStart=new ct,this.rotateLeftEnd=new ct,this.mapStateArray=[],this.timelone=null,this.zoomCenterType=F.getMapOptions().interaction.zoomCenterType,this.dollyToCursor=!0,this.isMoble=!La(),this.Ni=()=>{this.zoomCenterCusorReady=!0,this.zoomCenterType==Ca.MOUSE&&(this.Ii=0,this.smoothTime=.25,this.draggingSmoothTime=.125,this.dollySpeed=1,this.Pi={value:0},this.Di=new Gt,this.Oi=new Gt,this.Ui={value:0},this.Ci=new DOMRect,this.Fi=new ct,this.Bi=(new Ms).setFromUnitVectors(this.object.up,Ia),this.ki=this.Bi.clone().invert(),this.Gi=new rr(new Gt(-1/0,-1/0,-1/0),new Gt(1/0,1/0,1/0)),this.Hi(!1))},this.Vi=()=>{var t;this.zoomCenterType==Ca.MOUSE&&(t=ga(this,{x:this.domElement.clientWidth/2,y:this.domElement.clientHeight/2}),this.Oi.set(t.x,t.y,t.z),this.setOrbitPoint(t.x,t.y,t.z))},this.zi=t=>{Sa(o.object)&&(o.timer&&clearTimeout(o.timer),o.timer=setTimeout(()=>{o.dollyPoint=Ta(t,o),o.setOrbitPoint(o.dollyPoint.x,o.dollyPoint.y,o.dollyPoint.z,!0),o.dollyPoint=null,o.update()},500),o.dollyPoint||(o.dollyPoint=Ta(t,o),o.setOrbitPoint(o.dollyPoint.x,o.dollyPoint.y,o.dollyPoint.z,!0),o.update())),o.Wi(o.Ci);var e=Na?-1:-3,e=1===t.deltaMode||t.ctrlKey?t.deltaY/e:t.deltaY/(10*e),i=(t.clientX-o.Ci.x)/o.Ci.width*2-1,s=(t.clientY-o.Ci.y)/o.Ci.height*-2+1;o.object.isOrthographicCamera?(o.ji(-e,i,s),o.Xi=!0):(o.Yi(-e,i,s),o.Zi=!0),o.update()},this.Hi=()=>{this.zoomCenterType==Ca.MOUSE&&(this.qi=!0,this.Ki=this.target,this.Ji=this.target,this.$i=(new ma).setFromVector3(Pa.copy(this.object.position).sub(this.Ki).applyQuaternion(this.Bi)),this.Qi=this.$i.clone(),this.ts=this.$i.radius,this.es=new Gt,this.ss=this.es.clone(),this.rs=0,this.ns=this.object.zoom,this.hs=this.ns,this.ls=this.ns)},this.us=(t,e,i)=>{var s,r,n=e.lengthSq();return 0===n?t:(s=Da.copy(e).add(t),0===(r=(s=this.Gi.clampPoint(s,Oa).sub(s)).lengthSq())?t.add(e):r===n?t:0===i?t.add(e).add(s):(n=1+i*r/e.dot(s),t.add(Da.copy(e).multiplyScalar(n)).add(s.multiplyScalar(1-i))))},this.Wi=t=>{var e=this.domElement.getBoundingClientRect();return t.x=e.left,t.y=e.top,t.width=e.width,t.height=e.height,t},this.moveTo=(t,e,i,s=!1)=>{this.cs=!1;t=Pa.set(t,e,i).sub(this.Ji),this.us(this.Ji,t,this.boundaryFriction),this.qi=!0,s||this.Ki.copy(this.Ji),e=!s||Ea(this.Ki.x,this.Ji.x,this.restThreshold)&&Ea(this.Ki.y,this.Ji.y,this.restThreshold)&&Ea(this.Ki.z,this.Ji.z,this.restThreshold);return this.ds(e)},this.setFocalOffset=(t,e,i,s=!1)=>{this.vs=!1,this.ss.set(t,e,i),this.qi=!0,s||this.es.copy(this.ss);t=!s||Ea(this.es.x,this.ss.x,this.restThreshold)&&Ea(this.es.y,this.ss.y,this.restThreshold)&&Ea(this.es.z,this.ss.z,this.restThreshold);return this.ds(t)},this.ds=t=>t?Promise.resolve():(this.ps=!1,this.dispatchEvent({type:"transitionstart"}),new Promise(t=>{let e=()=>{this.removeEventListener("rest",e),t()};this.addEventListener("rest",e)})),this.gs=t=>t.setFromSpherical(this.$i).divideScalar(this.$i.radius).applyQuaternion(this.ki),this._s=t=>this.gs(t).negate(),this.ws=(t,e=!1)=>{this.Qi.radius=t,this.qi=!0,e||(this.$i.radius=this.Qi.radius);t=!e||Ea(this.$i.radius,this.Qi.radius,this.restThreshold);return this.ds(t)},this.dollyTo=(t,e=!1)=>(this.Zi=!1,this.Ms=0,this.Ii=0,this.ws(Ma(t,this.minDistance,this.maxDistance),e)),this.setOrbitPoint=(t,e,i)=>{var s,r=Pa.set(t,e,i);r.length()>=this.maxDistance||(this.object.updateMatrixWorld(),Fa.setFromMatrixColumn(this.object.matrixWorldInverse,0),Ba.setFromMatrixColumn(this.object.matrixWorldInverse,1),ka.setFromMatrixColumn(this.object.matrixWorldInverse,2),s=r.distanceTo(this.object.position),r=r.sub(this.object.position),Fa.multiplyScalar(r.x),Ba.multiplyScalar(r.y),ka.multiplyScalar(r.z),Pa.copy(Fa).add(Ba).add(ka),Pa.z=Pa.z+s,this.dollyTo(s,!1),this.setFocalOffset(-Pa.x,Pa.y,-Pa.z,!1),this.moveTo(t,e,i,!1))},this.Yi=(t,e,i)=>{var s=Math.pow(.95,-t*this.dollySpeed),r=this.Qi.radius,s=Ma(this.Qi.radius*s,this.minDistance,this.maxDistance);this.ws(s,!0),this.dollyToCursor&&(this.Ii+=s-r,this.Fi.set(e,i)),this.Ms=Math.sign(-t)},this.zoomTo=(t,e=!1)=>{this.Xi=!1,this.hs=Ma(t,this.minZoom,this.maxZoom),this.qi=!0,e||(this.ns=this.hs);t=!e||Ea(this.ns,this.hs,this.restThreshold);return this.rs=0,this.ds(t)},this.ji=(t,e,i)=>{var t=Math.pow(.95,t*this.dollySpeed),s=this.ns,t=this.ns*t;this.zoomTo(t,!0),this.dollyToCursor&&(this.rs+=t-s,this.Fi.set(e,i))},this.dolly=(t,e)=>this.dollyTo(this.Qi.radius-t,e),this.ys=(t,e)=>{var i,s,r,n,a,h;this.zoomCenterType==Ca.MOUSE&&this.zoomCenterCusorReady&&(a=this.Qi.radius-this.$i.radius,h=this.hs-this.ns,ya((n=Ga.subVectors(this.ss,this.es)).x)&&ya(n.y)&&ya(n.z)?(this.Di.set(0,0,0),this.es.copy(this.ss)):(n=this.vs?this.draggingSmoothTime:this.smoothTime,ba(this.es,this.ss,this.Di,n,this.maxSpeed,.01,this.es),this.qi=!0),ya(a)?(this.Pi.value=0,this.$i.radius=this.Qi.radius):(n=this.Zi?this.draggingSmoothTime:this.smoothTime,this.$i.radius=xa(this.$i.radius,this.Qi.radius,this.Pi,n,this.maxSpeed,.01),this.qi=!0),ya(h)?(this.Ui.value=0,this.ns=this.hs):(a=this.Xi?this.draggingSmoothTime:this.smoothTime,this.ns=xa(this.ns,this.hs,this.Ui,a,1/0,.01)),Sa(n=this.object)&&0!==this.Ii?(h=this.$i.radius-this.ts,a=this._s(Ua),0===(r=Pa.copy(a).cross(n.up).normalize()).lengthSq()&&(r.x=1),a=Da.crossVectors(r,a),i=this.Qi.radius*Math.tan(n.getEffectiveFOV()*wa*.5),s=(this.Qi.radius-h-this.Qi.radius)/this.Qi.radius,r=Oa.copy(this.Ji).add(r.multiplyScalar(this.Fi.x*i*n.aspect)).add(a.multiplyScalar(this.Fi.y*i)),a=Pa.copy(this.Ji).lerp(r,s),this.Gi.clampPoint(a,a),this.Ji.copy(a),this.Ii-=h,ya(this.Ii)&&(this.Ii=0)):Aa(n)&&0!==this.rs&&(i=this.ns-this.ls,r=Pa.set(this.Fi.x,this.Fi.y,(n.near+n.far)/(n.near-n.far)).unproject(n),s=Da.set(0,0,-1).applyQuaternion(n.quaternion),a=Oa.copy(r).add(s.multiplyScalar(-r.dot(n.up))),h=-(this.ns-i-this.ns)/this.ns,s=this._s(Ua),r=this.Ji.dot(s),a=(n=Pa.copy(this.Ji).lerp(a,h)).dot(s),h=s.multiplyScalar(a-r),n.sub(h),this.Gi.clampPoint(n,n),this.Ji.copy(n),this.Ki.copy(this.Ji),this.rs-=i,ya(this.rs))&&(this.rs=0),Sa(this.object)||this.object.zoom!==this.ns&&(this.object.zoom=this.ns,this.object.updateProjectionMatrix(),this.qi=!0),this.$i.theta+=t.theta,this.$i.phi+=t.phi,this.$i.theta=Math.max(o.minAzimuthAngle,Math.min(o.maxAzimuthAngle,this.$i.theta)),e&&void 0!==e.theta&&(this.$i.theta=Math.max(o.minAzimuthAngle,Math.min(o.maxAzimuthAngle,e.theta))),this.$i.phi=Math.max(o.minPolarAngle,Math.min(o.maxPolarAngle,this.$i.phi)),e&&void 0!==e.phi&&(this.$i.phi=Math.max(o.minPolarAngle,Math.min(o.maxPolarAngle,e.phi))),e&&(this.qi=!0),this.$i.makeSafe(),this.object.position.setFromSpherical(this.$i).add(this.Ki),o.object.lookAt(this.Ki),ya(this.es.x)&&ya(this.es.y)&&ya(this.es.z)||(Fa.setFromMatrixColumn(this.object.matrix,0),Ba.setFromMatrixColumn(this.object.matrix,1),ka.setFromMatrixColumn(this.object.matrix,2),Fa.multiplyScalar(this.es.x),Ba.multiplyScalar(-this.es.y),ka.multiplyScalar(this.es.z),Pa.copy(Fa).add(Ba).add(ka),this.object.position.add(Pa),this.object.updateMatrixWorld()),this.qi,this.ts=this.$i.radius,this.ls=this.ns,this.qi=!1)},this.Es=()=>{this.isDamping&&(v.theta>f||v.phi>f||m.length()>f?(this.update(),this.st.enableUpdateRender()):(this.isDamping=!1,this.update()))},this.Es=this.Es.bind(this),this.st.on("beforeRender",this.Es),this.getPolarAngle=function(){return(this.zoomCenterType==Ca.MOUSE?this.$i:d).phi},this.getAzimuthalAngle=function(){return(this.zoomCenterType==Ca.MOUSE?this.$i:d).theta},this.panAdd=function(t){m.add(t)},this.saveState=function(){o.target0.copy(o.target),o.position0.copy(o.object.position),o.zoom0=o.object.zoom},this.resetState=function(){c=u.NONE},this.reset=function(){o.target.copy(o.target0),o.object.position.copy(o.position0),o.object.zoom=o.zoom0,o.object.updateProjectionMatrix(),o.dispatchEvent(k),o.update(),c=u.NONE},this.updateCheck=function(){if(this.st.bi&&this.st.bi.enableDragRange)if(this.st.bi.xs())this.saveMapState();else{let t=this.mapStateArray.length-1;for(;0<=t;){var e=this.mapStateArray[t];if(e.viewMode=this.st.getViewMode(),this.updateState(e),this.st.bi.xs())break;t--}var i,s;t<0&&(s=(i=this.st.getBuilding(this.st.bi.nt.bs)).getFloor(i.level).bound.center,this.st.setCenter({x:s.x,y:s.y}),this.st.getMapOptions().followFocus||this.st.bi.nt.bs===this.st.getMapOptions().mapID||this.st.bi.Kt(i,{level:i.level,animate:!1}))}},this.updateState=function(t){this.st.bi.pauseDamping(),this.st.setCenter({animate:!1,x:t.center.x,y:t.center.y,finish:()=>{this.st.setRotation({animate:!1,rotation:t.rotation,finish:()=>{this.st.setTilt({animate:!1,tilt:t.tiltAngle,finish:()=>{this.st.setZoom({animate:!1,zoom:t.zoom})}})}})}})},this.saveMapState=function(){var t=this.st.getState();(t=>{let e=!0;for(var i in t)if(""+i=="center"){var s=t[i];if(isNaN(parseFloat(""+s.x))||isNaN(parseFloat(""+s.y))){e=!1;break}}else if(("rotation"===i||"tiltAngle"===i)&&isNaN(parseFloat(""+t[i]))){e=!1;break}return e})(t)&&(200<=this.mapStateArray.length&&this.mapStateArray.splice(0,1),this.mapStateArray.push(t))},this.getTarget=function(t,e){var i,s;return 0===this.st.Ft.length?t:(i=this.st.getMapOptions().screenLockCoords,s={x:this.st.getContainer().clientWidth/2,y:this.st.getContainer().clientHeight/2},i={x:this.st.getContainer().clientWidth*i.x,y:this.st.getContainer().clientHeight*i.y},(s=aa.coordsScreenToMap(this.st,s,e)).x=s.x-this.st.x,s.y=-s.y+this.st.y,(i=aa.coordsScreenToMap(this.st,i,e)).x=i.x-this.st.x,i.y=-i.y+this.st.y,e=i.x-s.x,i=i.y-s.y,s=t.clone(),isNaN(e)||isNaN(i)||1e3<Math.abs(i)||1e3<Math.abs(e)||(s.x=s.x-e,s.z=s.z-i),s)},this.update=(s=new Gt,r=(new Ms).setFromUnitVectors(U.up,new Gt(0,1,0)),B=r.clone().invert(),n=new Gt,a=new Ms,h=0,function(t){t=t||{};var e,i=o.object.position;if(s.copy(i).sub(o.target),s.applyQuaternion(r),d.setFromVector3(s),o.autoRotate&&c===u.NONE&&T(2*Math.PI/60/60*o.autoRotateSpeed),o.enableDamping&&o.isDamping?(d.theta+=v.theta*o.dampingFactor,d.phi+=v.phi*o.dampingFactor):(d.theta+=v.theta,d.phi+=v.phi),d.theta=Math.max(o.minAzimuthAngle,Math.min(o.maxAzimuthAngle,d.theta)),t&&void 0!==t.theta&&(d.theta=Math.max(o.minAzimuthAngle,Math.min(o.maxAzimuthAngle,t.theta))),d.phi=Math.max(o.minPolarAngle,Math.min(o.maxPolarAngle,d.phi)),t&&void 0!==t.phi&&(d.phi=Math.max(o.minPolarAngle,Math.min(o.maxPolarAngle,t.phi))),d.makeSafe(),o.zoomCenterType==Ca.CENTER&&(d.radius*=p,d.radius=Math.max(o.minDistance,Math.min(o.maxDistance,d.radius))),this.useRange?((e=(new Gt).setFromMatrixPosition(o.object.matrixWorld)).add(m),e=(new Ht).copy(o.object.matrixWorld).setPosition(e),e=(new Ht).getInverse(e),(new Lr).setFromProjectionMatrix((new Ht).multiplyMatrices(o.object.projectionMatrix,e)).intersectsSphere(o.viewSphere)&&o.target.add(m)):o.enableDamping&&o.isDamping?o.target.addScaledVector(m,o.dampingFactor):o.target.add(m),s.setFromSpherical(d),s.applyQuaternion(B),t&&t.offset&&s.add(t.offset),this.useRange?((e=(new Gt).setFromMatrixPosition(o.object.matrixWorld)).add(s),e=(new Ht).copy(o.object.matrixWorld).setPosition(e),e=(new Ht).getInverse(e),(new Lr).setFromProjectionMatrix((new Ht).multiplyMatrices(o.object.projectionMatrix,e)).intersectsSphere(o.viewSphere)&&i.copy(o.target).add(s)):this.zoomCenterType==Ca.CENTER&&i.copy(o.target).add(s),this.zoomCenterType==Ca.MOUSE){if(t.offset)return this.dolly(t.offset.length()*(0<t.dirction?-1:1),!1),void this.update();o.ys(v,t)}else o.isScreenLock&&void 0!==this.st.getMapOptions().screenLockCoords?((e=o.object.clone()).lookAt(o.target),o.object.lookAt(this.getTarget(o.target,e)),o.object.rotation.z=e.rotation.z):o.object.lookAt(o.target);return o.enableDamping&&o.isDamping?(v.theta*=1-o.dampingFactor,v.phi*=1-o.dampingFactor,m.multiplyScalar(1-o.dampingFactor)):(v.set(0,0,0),m.set(0,0,0)),p=1,!(!(g||n.distanceToSquared(o.object.position)>f||8*(1-a.dot(o.object.quaternion))>f||h!==o.object.zoom)||(o.dispatchEvent(k),n.copy(o.object.position),a.copy(o.object.quaternion),h=o.object.zoom,g=!1))}),this.dispose=function(){o.domElement.removeEventListener("contextmenu",rt,!1),o.domElement.removeEventListener("mousedown",$,!1),o.domElement.removeEventListener("wheel",Q,!1),o.domElement.removeEventListener("touchstart",et,!1),o.domElement.removeEventListener("touchend",st,!1),o.domElement.removeEventListener("touchmove",it,!1),nt.document.removeEventListener("mousemove",D,!1),nt.document.removeEventListener("mouseup",O,!1),o.domElement.removeEventListener("keydown",tt,!1)};var s,r,B,n,a,h,o=this,k={type:"change"},l={type:"start"},i={type:"end"},u={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},c=u.NONE,f=1e-6,d=new ma,v=new ma,p=1,m=new Gt,g=!1,_=new ct,w=new ct,M=new ct,y=new ct,E=new ct,x=new ct,b=new ct,S=new ct,A=new ct,G=null;function H(){return Math.pow(.95,o.zoomSpeed)}function T(t){o.enableRotateLeft&&(v.theta-=t)}function V(t){o.enableRotateUp&&(v.phi-=t)}R=new Gt;var R,L,C,z=function(t,e){R.setFromMatrixColumn(e,0),R.multiplyScalar(-t),m.add(R)},W=(L=new Gt,function(t,e){!0===o.screenSpacePanning?L.setFromMatrixColumn(e,1):(L.setFromMatrixColumn(e,0),L.crossVectors(o.object.up,L)),L.multiplyScalar(t),m.add(L)}),N=(this.panUp=t=>{var e=new Gt(0,1,0);e.multiplyScalar(t),m.add(e)},C=new Gt,function(t,e){var i,s=o.domElement;o.object.isPerspectiveCamera?(i=o.object.position,C.copy(i).sub(o.target),i=C.length(),i*=Math.tan(o.object.fov/2*Math.PI/180),z(2*t*i/s.clientHeight,o.object.matrix),W(2*e*i/s.clientHeight,o.object.matrix)):o.object.isOrthographicCamera?(z(t*(o.object.right-o.object.left)/o.object.zoom/s.clientWidth,o.object.matrix),W(e*(o.object.top-o.object.bottom)/o.object.zoom/s.clientHeight,o.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),o.enablePan=!1)});function I(t){o.object.isPerspectiveCamera?p/=t:o.object.isOrthographicCamera?(o.object.zoom=Math.max(o.minZoom,Math.min(o.maxZoom,o.object.zoom*t)),o.object.updateProjectionMatrix(),p/=t,g=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),o.enableZoom=!1)}function P(t){o.object.isPerspectiveCamera?p*=t:o.object.isOrthographicCamera?(o.object.zoom=Math.max(o.minZoom,Math.min(o.maxZoom,o.object.zoom/t)),o.object.updateProjectionMatrix(),p*=t,g=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),o.enableZoom=!1)}function e(t){_.set(t.clientX,t.clientY)}function j(t){y.set(t.clientX,t.clientY)}function X(t){var e,i;1==t.touches.length?_.set(t.touches[0].pageX,t.touches[0].pageY):(e=.5*(t.touches[0].pageX+t.touches[1].pageX),i=.5*(t.touches[0].pageY+t.touches[1].pageY),_.set(e,i),e=t.touches[0].pageX-t.touches[1].pageX,i=t.touches[0].pageY-t.touches[1].pageY,o.rotateLeftStart.set(e,i))}function Y(t){var e;1==t.touches.length?y.set(t.touches[0].pageX,t.touches[0].pageY):(e=.5*(t.touches[0].pageX+t.touches[1].pageX),t=.5*(t.touches[0].pageY+t.touches[1].pageY),y.set(e,t))}function Z(t){var e=t.touches[0].pageX-t.touches[1].pageX,t=t.touches[0].pageY-t.touches[1].pageY,e=Math.sqrt(e*e+t*t);b.set(0,e)}function q(t){1==t.touches.length?w.set(t.touches[0].pageX,t.touches[0].pageY):(i=.5*(t.touches[0].pageX+t.touches[1].pageX),e=.5*(t.touches[0].pageY+t.touches[1].pageY),w.set(i,e),i=t.touches[0].pageX-t.touches[1].pageX,e=t.touches[0].pageY-t.touches[1].pageY,o.rotateLeftEnd.set(i,e),t=o.rotateLeftStart.angle(),T((-o.rotateLeftEnd.angle()+t)*o.rotateSpeed),o.rotateLeftStart.copy(o.rotateLeftEnd)),M.subVectors(w,_).multiplyScalar(o.rotateSpeed);var e,i=o.domElement;V(2*Math.PI*M.y/i.clientHeight),_.copy(w)}function K(t){var e;1==t.touches.length?(E.set(t.touches[0].pageX,t.touches[0].pageY),E.x<0&&E.copy(y)):(e=.5*(t.touches[0].pageX+t.touches[1].pageX),t=.5*(t.touches[0].pageY+t.touches[1].pageY),E.set(e,t)),x.subVectors(E,y).multiplyScalar(o.panSpeed),N(x.x,x.y),y.copy(E)}function J(t){var e,i;t.touches[0]&&t.touches[1]&&(i=t.touches[0].pageX-t.touches[1].pageX,e=t.touches[0].pageY-t.touches[1].pageY,i=Math.sqrt(i*i+e*e),S.set(0,i),A.set(0,Math.pow(S.y/b.y,o.zoomSpeed)),o.zoomCenterType==Ca.MOUSE&&o.zoomCenterCusorReady?(o.lastScreenPoint||(o.lastScreenPoint=Ra(t)),e=o.lastScreenPoint,i=A.y*Sa(o.object)?35:50,o.zi({clientX:e.x,clientY:e.y,deltaMode:0,deltaY:1<A.y?-i:i})):I(A.y),b.copy(S))}function $(t){if(!1!==o.enabled){switch(o.activeing=!0,t.preventDefault(),(o.domElement.focus?o.domElement:window).focus(),t.button){case 0:switch(o.mouseButtons.LEFT){case at.ROTATE:if(t.ctrlKey||t.metaKey||t.shiftKey){if(!1===o.enablePan)return;j(t),c=u.PAN}else{if(!1===o.enableRotate)return;e(t),c=u.ROTATE}break;case at.PAN:if(t.ctrlKey||t.metaKey||t.shiftKey){if(!1===o.enableRotate)return;e(t),c=u.ROTATE}else{if(!1===o.enablePan)return;j(t),c=u.PAN}break;default:c=u.NONE}break;case 1:switch(o.mouseButtons.MIDDLE){case at.DOLLY:if(!1===o.enableZoom)return;b.set(t.clientX,t.clientY),c=u.DOLLY;break;case at.ROTATE:if(!1===o.enableRotate)return;e(t),c=u.ROTATE;break;default:c=u.NONE}break;case 2:switch(o.mouseButtons.RIGHT){case at.ROTATE:if(!1===o.enableRotate)return;e(t),c=u.ROTATE;break;case at.PAN:if(!1===o.enablePan)return;j(t),c=u.PAN;break;default:c=u.NONE}}c!==u.NONE&&(nt.document.addEventListener("mousemove",D,!1),nt.document.addEventListener("mouseup",O,!1),o.dispatchEvent(l))}}function D(t){var e;if(!1!==o.enabled)switch(t.preventDefault(),c){case u.ROTATE:!1!==o.enableRotate&&(e=t,o.zoomCenterType!=Ca.MOUSE||o.isMoble||o.Vi(),w.set(e.clientX,e.clientY),M.subVectors(w,_).multiplyScalar(o.rotateSpeed),e=o.domElement,T(2*Math.PI*M.x/e.clientHeight),V(2*Math.PI*M.y/e.clientHeight),_.copy(w),o.isDamping=!0,o.update(),o.updateCheck());break;case u.DOLLY:!1!==o.enableZoom&&(S.set(t.clientX,t.clientY),A.subVectors(S,b),0<A.y?I(H()):A.y<0&&P(H()),b.copy(S),o.isDamping=!0,o.update(),o.updateCheck());break;case u.PAN:!1!==o.enablePan&&(E.set(t.clientX,t.clientY),x.subVectors(E,y).multiplyScalar(o.panSpeed),N(x.x,x.y),y.copy(E),o.isDamping=!0,o.update(),o.updateCheck())}}function O(t){!1!==o.enabled&&(o.activeing=!1,nt.document.removeEventListener("mousemove",D,!1),nt.document.removeEventListener("mouseup",O,!1),o.dispatchEvent(i),c=u.NONE)}function Q(t){var e;!1===o.enabled||!1===o.enableZoom||c!==u.NONE&&c!==u.ROTATE||(o.activeing=!0,void 0!==o.wheelTimer&&clearTimeout(o.wheelTimer),o.wheelTimer=setTimeout(()=>{o.activeing=!1},100),t.preventDefault(),t.stopPropagation(),o.dispatchEvent(l),t=t,e=Math.pow(.95,o.zoomSpeed*o.zoomSpeedParam),o.zoomCenterType==Ca.MOUSE&&o.zoomCenterCusorReady?o.zi(t):(t.deltaY<0?P(e):0<t.deltaY&&I(e),o.isDamping=!0,o.update(),o.updateCheck()),o.dispatchEvent(i))}function tt(t){if(!1!==o.enabled&&!1!==o.enableKeys&&!1!==o.enablePan){var e=!1;switch(t.keyCode){case o.keys.UP:N(0,o.keyPanSpeed),e=!0;break;case o.keys.BOTTOM:N(0,-o.keyPanSpeed),e=!0;break;case o.keys.LEFT:N(o.keyPanSpeed,0),e=!0;break;case o.keys.RIGHT:N(-o.keyPanSpeed,0),e=!0}e&&(t.preventDefault(),o.isDamping=!0,o.update(),o.updateCheck())}}function et(t){if(!1!==o.enabled){switch(o.activeing=!0,t.preventDefault(),t.touches.length){case 1:switch(o.touches.ONE){case ht.ROTATE:if(!1===o.enableRotate)return;X(t),c=u.TOUCH_ROTATE;break;case ht.PAN:if(!1===o.enablePan)return;Y(t),c=u.TOUCH_PAN;break;default:c=u.NONE}break;case 2:switch(G=t.touches[0].identifier,o.touches.TWO){case ht.DOLLY_PAN:if(!1===o.enableZoom&&!1===o.enablePan)return;o.zoomCenterType==Ca.MOUSE&&(i=Ta({clientX:(i=Ra(t)).x,clientY:i.y},o),o.setOrbitPoint(i.x,i.y,i.z,!0),o.update()),i=t,o.enableZoom&&Z(i),o.enablePan&&Y(i),c=u.TOUCH_DOLLY_PAN;break;case ht.DOLLY_ROTATE:if(!1===o.enableZoom&&!1===o.enableRotate)return;e=t,o.enableZoom&&Z(e),o.enableRotate&&X(e),c=u.TOUCH_DOLLY_ROTATE;break;default:c=u.NONE}break;default:c=u.NONE}var e,i;c!==u.NONE&&o.dispatchEvent(l)}}function it(t){var e,i;if(!1!==o.enabled)switch(o.activeing=!0,2===t.touches.length&&t.touches[1].identifier===G&&(e=t.touches[0],t.touches[0]=t.touches[1],t.touches[1]=e),t.preventDefault(),t.stopPropagation(),c){case u.TOUCH_ROTATE:!1!==o.enableRotate&&(q(t),o.isDamping=!0,o.update(),o.updateCheck());break;case u.TOUCH_PAN:!1!==o.enablePan&&(K(t),o.isDamping=!0,o.update(),o.updateCheck());break;case u.TOUCH_DOLLY_PAN:!1===o.enableZoom&&!1===o.enablePan||(i=t,o.enableZoom&&J(i),o.enablePan&&K(i),o.isDamping=!0,o.update(),o.updateCheck());break;case u.TOUCH_DOLLY_ROTATE:!1===o.enableZoom&&!1===o.enableRotate||(i=t,o.enableZoom&&J(i),o.enableRotate&&q(i),o.isDamping=!0,o.update(),o.updateCheck());break;default:c=u.NONE}}function st(t){!1!==o.enabled&&(o.activeing=!1,o.lastScreenPoint=null,o.dispatchEvent(i),c=u.NONE)}function rt(t){!1!==o.enabled&&t.preventDefault()}this.dollyIn=t=>I(t),this.dollyOut=t=>P(t),o.domElement.addEventListener("contextmenu",rt,!1),o.domElement.addEventListener("mousedown",$,!1),o.domElement.addEventListener("wheel",Q,!1),o.domElement.addEventListener("touchstart",et,!1),o.domElement.addEventListener("touchend",st,!1),o.domElement.addEventListener("touchmove",it,!1),o.domElement.addEventListener("keydown",tt,!1),-1===o.domElement.tabIndex&&(o.domElement.tabIndex=0),o.isDamping=!0,this.update(),this.updateCheck(),this.removeEvent=function(){o.domElement.removeEventListener("contextmenu",rt,!1),o.domElement.removeEventListener("mousedown",$,!1),o.domElement.removeEventListener("wheel",Q,!1),o.domElement.removeEventListener("touchstart",et,!1),o.domElement.removeEventListener("touchend",st,!1),o.domElement.removeEventListener("touchmove",it,!1),o.domElement.removeEventListener("keydown",tt,!1),nt.document.removeEventListener("mousemove",D,!1),nt.document.removeEventListener("mouseup",O,!1)}},Va=(Ha.prototype=Object.create(Cs.prototype),Ha.prototype.constructor=Ha,function(t,e,i){Ha.call(this,t,e,i),this.mouseButtons.LEFT=at.PAN,this.mouseButtons.RIGHT=at.ROTATE,this.touches.ONE=ht.PAN,this.touches.TWO=ht.DOLLY_ROTATE,this.Ss=null});Va.prototype=Object.create(Cs.prototype),Va.prototype.constructor=Va,Object.assign(Va.prototype,{setMouseMiddleButtonRotation(){this.mouseButtons.RIGHT=at.NONE,this.mouseButtons.MIDDLE=at.ROTATE},dispose(){this.removeEvent(),this.object=null,this.domElement=null,this.st.off("beforeRender",this.st.Es),this.st=null},pauseDamping(){this.Ss={dampingFactor:this.dampingFactor,enableDamping:this.enableDamping},this.enableDamping=!1,this.dampingFactor=1},resumeDamping(){this.Ss&&(this.enableDamping=this.Ss.enableDamping,this.dampingFactor=this.Ss.dampingFactor)}});class za{constructor(t,e,i){this.st=t,this.nt=i,this.Rt=[295829355.45,147914677.73,73957338.86,36978669.43,18489334.72,9244667.36,4622333.68,2311166.84,1155583.42,577791.71,288895.85,144447.93,72223.96,36111.98,18056,9028,4514,2257,1128,564,282,141,70,35,17,8,4,2,1],this.Ft=[],this.As=new Map,this.$t=null,this.Ts=this.nt.Rs,this.Nt=null,this.yt=new Va(this.st.ct,e,this.st),this.yt.enableDamping=this.st.Ls.enableDamping,this.yt.dampingFactor=.08,this.st.Ls.interaction.mouseMode===pa.NO_RIGHT_CLICK&&this.yt.setMouseMiddleButtonRotation(),this.Cs=null,this.yt.addEventListener("change",()=>{this.W(),this.st.Yt.Xt({type:"viewChanged"}),this.st.bt.Ns=1,null!==this.Cs&&clearTimeout(this.Cs),this.Cs=setTimeout(()=>{this.st.bt.Ns=0,this.st.enableUpdateRender()},10)}),this.st.Ls.interaction.zoomCenterType==Ca.CENTER?this.Is=new fn(this.yt,this.st.Ps,this.st.Lt):(this.st.Ps.far=1e8,this.st.Lt.far=1e8,this.st.Ps.updateProjectionMatrix(),this.st.Lt.updateProjectionMatrix());t=!this.st.Ls.interaction.lock;this.yt.enableZoom=t,this.yt.enablePan=t,this.yt.enableRotate=t,this.yt.enableRotateLeft=t,this.yt.enableRotateUp=t,this.Ds=t,this.Os=t,this.Us=t,this.Fs=t,this.Bs=this.yt.useRange,this.ks={},this.Gs=this.Gs.bind(this)}get enableZoom(){return this.Ds}set enableZoom(t){this.Ds=t,this.yt.enableZoom=t}get enableDragRange(){return this.Bs}set enableDragRange(t){this.Bs=t}get enableDrag(){return this.Os}set enableDrag(t){this.Os=t,this.yt.enablePan=t}get enableRotate(){return this.Us}set enableRotate(t){this.Us=t,this.yt.enableRotateLeft=t}get enableTilt(){return this.Fs}set enableTilt(t){this.Fs=t,this.yt.enableRotateUp=t}get enableDamping(){return this.yt.enableDamping}set enableDamping(t){this.yt.enableDamping=t}get controls(){return this.yt}set controls(t){this.yt=t}get autoCameraNearFar(){return this.Is}get mouseMode(){return this.st.Ls.mouseMode}set zoomSpeed(t){this.yt.zoomSpeedParam=t}get zoomSpeed(){return this.yt.zoomSpeedParam}copyControls(t){t=new Va(t,this.yt.domElement,this.st);return t.target=(new Gt).copy(this.yt.target),t.maxDistance=this.yt.maxDistance,t.minDistance=this.yt.minDistance,t.minZoom=this.yt.minZoom,t.maxZoom=this.yt.maxZoom,t.minPolarAngle=this.yt.minPolarAngle,t.maxPolarAngle=this.yt.maxPolarAngle,t.update({theta:this.yt.getAzimuthalAngle()}),t}pauseDamping(){this.yt&&this.yt.pauseDamping()}resumeDamping(){this.yt&&this.yt.pauseDamping()}}Object.assign(za.prototype,{Qt(){for(var t in clearTimeout(this.Cs),this.yt.dispose(),this)this[""+t]=null,delete this[""+t]},Hs(){var t,e=this.wt(this.nt.zoom),i=this.Mt(e),s=this.nt.yi,r=this.st.Wt.Vs(this.st.jt.Ht,this.st.jt.level);r?(s.y=r.Jt,this.yt.target=(new Gt).copy(s),this.yt.object.lookAt(s),this.Tt(),this.nt.Rs===Cr.MODE_3D?(r=(u.TILT_UPPER_BOUND-this.nt.zs)*u.DEG2RAD,t=i*Math.cos(r),r=i*Math.sin(r),this.yt.object.position.set(s.x,s.y+t,s.z+r),this.yt.minPolarAngle=(u.TILT_UPPER_BOUND-this.st.Ls.maxTiltAngle)*u.DEG2RAD,this.yt.maxPolarAngle=(u.TILT_UPPER_BOUND-this.st.Ls.minTiltAngle)*u.DEG2RAD):(t=this.Et(e),this.yt.minPolarAngle=0,this.yt.maxPolarAngle=0,this.yt.object.position.set(s.x,s.y+i,s.z),this.yt.object.zoom=1/t,this.yt.object.updateProjectionMatrix()),this.yt.Ni(),r=this.Pt(this.nt.Ws),this.yt.update({theta:this.yt.getAzimuthalAngle()+r})):(e={type:"info",InfoMode:Nr.DEFAULT_LEVEL_ERROR},this.st.js.error.push(e),this.st.Yt.Xt(e))},Xs(t){this.yt.target=t,this.yt.update()},Ys(s){if(this.Ts===s.mode)s.mode===this.st.getViewMode()&&s.finish&&s.finish();else{this.Ts=s.mode;let i=this.yt,t=(i.Vi(),s.duration);var e,r;void 0===t&&(t=1),this.Nt&&!1===this.Nt.H&&this.Nt.finish(),s.mode===Cr.MODE_2D?(i.minPolarAngle=-90*u.DEG2RAD,this.nt.zs=this.st.getTilt(),this.Ct({animate:void 0===s.animate||s.animate,duration:t,tilt:90,finish:()=>{i.maxPolarAngle=0;var t=this.st.Lt,e=this.ft(),e=this.Et(e);t.quaternion.copy(i.object.quaternion),t.position.copy(i.object.position),t.zoom=1/e,t.updateProjectionMatrix(),i.object=t,this.yt.Hi(),i.update(),this.st.ct=t,this.st.bt.xt(),this.st.Yt.Xt({type:"viewModeChanged"}),s.finish&&s.finish()}})):s.mode===Cr.MODE_3D&&(i.maxPolarAngle=(u.TILT_UPPER_BOUND-this.st.Ls.minTiltAngle)*u.DEG2RAD,e=this.st.Ps,r=this.dt(),r=this.Mt(r),e.quaternion.copy(i.object.quaternion),e.position.copy(i.object.position),e.position.setY(i.target.y+r),e.updateMatrix(),i.object=e,this.yt.Hi(),i.update(),this.st.ct=e,this.st.bt.xt(),this.Ct({animate:void 0===s.animate||s.animate,duration:t,tilt:this.nt.zs,finish:s.finish}),this.st.Yt.Xt({type:"viewModeChanged"}))}},lt(t){this.Ft.push(...t)},W(){for(let t=0;t<this.Ft.length;t++)this.Ft[t].call(this.st.bt)},xs(n){try{let e=!1;var a=this.st.camera;let t=null,i=null,s=null,r=void 0;if(n?(t=this.st.getBuilding(n.buildingID),i=t.getFloor(n.level),s=i.getLayers(p.EXTENT_LAYER)[0]):(t=this.st.getBuilding(this.nt.bs),i=t.getFloor(t.level),s=i.getLayers(p.EXTENT_LAYER)[0],r=this.st.Ls.panRangeValue),r){var h,o,l=new Lr;l.setFromProjectionMatrix((new Ht).multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse));let e=null;for(let t=0;t<s.Ft.length;t++)s.Ft[t].Zs&&(e=s.Ft[t].Zs);return null===e?!1:(h=e.geometry.boundingSphere,(new Er).copy(h).applyMatrix4(e.matrixWorld),o=new Er(new Gt(r.center.x-this.st.x,i.height,this.st.y-r.center.y),r.radius),l.intersectsSphere(o))}var u=[],c=this.st.Ls.container.clientWidth,f=this.st.Ls.container.clientHeight,d=(u.push(aa.coordsScreenToMap(this.st,{x:0,y:0,level:i.level,buildingID:t.Ht})),u.push(aa.coordsScreenToMap(this.st,{x:c,y:0,level:i.level,buildingID:t.Ht})),u.push(aa.coordsScreenToMap(this.st,{x:c,y:f,level:i.level,buildingID:t.Ht})),u.push(aa.coordsScreenToMap(this.st,{x:0,y:f,level:i.level,buildingID:t.Ht})),new na("polygon",u));for(let t=0;t<s.Ft.length;t++){var v=((e,t)=>{var i=[];for(let t=0;t<e.length;t++)i.push([e[t].x,e[t].y]);var s=ua.polygonScale(i,.9,[t.center.x,t.center.y]),r=[];for(let t=0;t<s.length;t++)r.push({x:s[t][0],y:s[t][1]});return t=new va({eid:"1",Ti:[r]})})(s.Ft[t].qs.Ti[0],s.Ft[t].bound);if(d.wi(v)){e=!0;break}}return e}catch(t){return!0}},Gs(){if(this.ks.counter<this.ks.num){var e=(new Date).getTime();let t=e-this.ks.frameTime;this.ks.counter+t>this.ks.num&&(t=this.ks.num-this.ks.counter);var i,s=this.ks.num-this.ks.counter,r=(this.ks.targetX-this.yt.target.x)/s,n=(this.ks.targetZ-this.yt.target.z)/s,a=this.wt(this.ks.state.zoom),h=this.Mt(a),o=this.yt.object.position.distanceTo(this.yt.target),l=(new Gt).copy(this.yt.object.position).sub(this.yt.target).normalize(),l=(new Gt).copy(l).multiplyScalar(h-o),r=(this.yt.panAdd({x:r*t,y:0,z:n*t}),this.yt.getAzimuthalAngle()),n=(u.TILT_UPPER_BOUND-(this.ks.tilt+t*this.ks.perTilt))*u.DEG2RAD;this.ks.tilt=this.ks.tilt+t*this.ks.perTilt,"OrthographicCamera"===this.st.ct.type&&(a=(i=this.dt())+(a-i)/s*t,i=this.Et(a),this.st.ct.zoom=1/i,this.st.ct.updateProjectionMatrix(),this.st.St()),this.yt.update({dirction:h-o,offset:new Gt(l.x/s*t,l.y/s*t,l.z/s*t)}),this.yt.update({theta:r+this.ks.disRotation*t}),this.yt.update({phi:n}),this.st.bt.xt(),this.ks.counter=this.ks.counter+t,this.ks.frameTime=e}else this.st.ot.Ks(this.Gs),"2d"===this.ks.modeUpdateType&&this.st.setViewMode({mode:this.ks.state.viewMode,animate:!1}),this.st.setVisibleLevels(this.ks.state.visibleLevels,()=>{let e=this.ks.state.focusBuildingState;if(null===e&&this.st.setLevel({level:this.ks.state.level,animate:!0,finish:()=>{this.ks.options.finish&&this.ks.options.finish()}}),this.st.qt=this.st.getMapOptions().followFocus,null!==e){let t=this.st.getBuilding(e.buildingID);e.buildingID===this.ks.state.viewBuildingID&&this.ks.state.viewBuildingID!==this.st.nt.bs?t.setVisibleLevels(e.visibleLevels,()=>{t.setLevel({level:e.level,animate:!1,finish:()=>{this.st.enterBuilding({buildingID:this.ks.state.viewBuildingID,noCenter:!0,finish:()=>{this.ks.options.finish&&this.ks.options.finish()}})}})}):t.setVisibleLevels(e.visibleLevels,()=>{t.setLevel({level:e.level,animate:!0,finish:()=>{this.ks.options.finish&&this.ks.options.finish()}})})}}),this.resumeDamping()},Js(t,e,i){this.st.ot.Ks(this.Gs),this.pauseDamping(),null!==t.focusBuildingState?this.st.nt.bs!==this.st.getMapOptions().mapID&&this.st.exitBuilding({buildingID:this.st.nt.bs,noCenter:!0,finish:()=>{this.st.setLevel({level:t.level,animate:!1})}}):this.st.nt.bs!==this.st.getMapOptions().mapID?this.st.exitBuilding({buildingID:this.st.nt.bs,noCenter:!0,finish:()=>{this.st.setLevel({level:t.level,animate:!1})}}):null!==i.focusBuildingState&&this.st.exitBuilding({buildingID:i.focusBuildingState.buildingID,noCenter:!0,finish:()=>{this.st.setLevel({level:t.level,animate:!1})}}),this.st.qt=!1,this.ks={},this.ks.options=e,this.ks.targetX=t.center.x-this.st.x,this.ks.targetZ=-t.center.y+this.st.y,this.ks.num=1e3*e.duration,this.ks.counter=0;var s,i=this.Pt(t.rotation,!0),e=(this.ks.disRotation=i/this.ks.num,t.tiltAngle=ws.clamp(t.tiltAngle,this.st.Ls.minTiltAngle,this.st.Ls.maxTiltAngle),this.ks.state=t,this.st.getTilt()),i=(t.tiltAngle-e)/this.ks.num;this.ks.tilt=e,this.ks.perTilt=i;let r="no";this.st.getViewMode()!==t.viewMode&&(t.viewMode===Cr.MODE_3D?(r="3d",this.yt.maxPolarAngle=(u.TILT_UPPER_BOUND-this.st.Ls.minTiltAngle)*u.DEG2RAD,i=this.st.Ps,s=this.dt(),s=this.Mt(s),i.quaternion.copy(this.yt.object.quaternion),i.position.copy(this.yt.object.position),i.position.setY(this.yt.target.y+s),i.updateMatrix(),this.yt.object=i,this.yt.update(),this.st.ct=i,this.Ts=Cr.MODE_3D):(r="2d",this.ks.perTilt=(90-e)/this.ks.num)),this.ks.frameTime=(new Date).getTime(),this.ks.modeUpdateType=r,this.st.getFloorSpace()!==t.floorSpace&&this.st.setFloorSpace(t.floorSpace),this.st.ot.$s(this.Gs)}}),hn(za),on(za),ln(za);let Wa=new Gt,ja=new Gt,Xa=new Gt,Ya=new Gt,Za=new Gt,qa=new Gt,Ka=new Gt;class Ja{constructor(t=new Gt,e=new Gt(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}at(t,e){return e.copy(this.origin).addScaledVector(this.direction,t)}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}recast(t){return this.origin.copy(this.at(t,Wa)),this}closestPointToPoint(t,e){e.subVectors(t,this.origin);t=e.dot(this.direction);return t<0?e.copy(this.origin):e.copy(this.origin).addScaledVector(this.direction,t)}distanceToPoint(t){return Math.sqrt(this.distanceSqToPoint(t))}distanceSqToPoint(t){var e=Wa.subVectors(t,this.origin).dot(this.direction);return(e<0?this.origin:(Wa.copy(this.origin).addScaledVector(this.direction,e),Wa)).distanceToSquared(t)}distanceSqToSegment(t,e,i,s){ja.copy(t).add(e).multiplyScalar(.5),Xa.copy(e).sub(t).normalize(),Ya.copy(this.origin).sub(ja);var t=.5*t.distanceTo(e),e=-this.direction.dot(Xa),r=Ya.dot(this.direction),n=-Ya.dot(Xa),a=Ya.lengthSq(),h=Math.abs(1-e*e);let o,l,u,c;return u=0<h?(o=e*n-r,l=e*r-n,c=t*h,0<=o?l>=-c?l<=c?(h=1/h,o*=h,l*=h,o*(o+e*l+2*r)+l*(e*o+l+2*n)+a):(l=t,-(o=Math.max(0,-(e*l+r)))*o+l*(l+2*n)+a):(l=-t,-(o=Math.max(0,-(e*l+r)))*o+l*(l+2*n)+a):l<=-c?(o=Math.max(0,-(-e*t+r)),l=0<o?-t:Math.min(Math.max(-t,-n),t),-o*o+l*(l+2*n)+a):l<=c?(o=0,(l=Math.min(Math.max(-t,-n),t))*(l+2*n)+a):(o=Math.max(0,-(e*t+r)),l=0<o?t:Math.min(Math.max(-t,-n),t),-o*o+l*(l+2*n)+a)):(l=0<e?-t:t,-(o=Math.max(0,-(e*l+r)))*o+l*(l+2*n)+a),i&&i.copy(this.origin).addScaledVector(this.direction,o),s&&s.copy(ja).addScaledVector(Xa,l),u}intersectSphere(t,e){Wa.subVectors(t.center,this.origin);var i=Wa.dot(this.direction),s=Wa.dot(Wa)-i*i,t=t.radius*t.radius;return t<s||(s=i-(t=Math.sqrt(t-s)),(i=i+t)<0)?null:s<0?this.at(i,e):this.at(s,e)}intersectsSphere(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius}distanceToPlane(t){var e=t.normal.dot(this.direction);return 0===e?0===t.distanceToPoint(this.origin)?0:null:0<=(t=-(this.origin.dot(t.normal)+t.constant)/e)?t:null}intersectPlane(t,e){t=this.distanceToPlane(t);return null===t?null:this.at(t,e)}intersectsPlane(t){var e=t.distanceToPoint(this.origin);return 0===e||t.normal.dot(this.direction)*e<0}intersectBox(t,e){let i,s,r,n,a,h;var o=1/this.direction.x,l=1/this.direction.y,u=1/this.direction.z,c=this.origin;return s=0<=o?(i=(t.min.x-c.x)*o,(t.max.x-c.x)*o):(i=(t.max.x-c.x)*o,(t.min.x-c.x)*o),n=0<=l?(r=(t.min.y-c.y)*l,(t.max.y-c.y)*l):(r=(t.max.y-c.y)*l,(t.min.y-c.y)*l),i>n||r>s||((r>i||isNaN(i))&&(i=r),(n<s||isNaN(s))&&(s=n),h=0<=u?(a=(t.min.z-c.z)*u,(t.max.z-c.z)*u):(a=(t.max.z-c.z)*u,(t.min.z-c.z)*u),i>h)||a>s||((a>i||i!=i)&&(i=a),(s=h<s||s!=s?h:s)<0)?null:this.at(0<=i?i:s,e)}intersectsBox(t){return null!==this.intersectBox(t,Wa)}intersectTriangle(t,e,i,s,r){Za.subVectors(e,t),qa.subVectors(i,t),Ka.crossVectors(Za,qa);let n=this.direction.dot(Ka),a;if(0<n){if(s)return null;a=1}else{if(!(n<0))return null;a=-1,n=-n}Ya.subVectors(this.origin,t);e=a*this.direction.dot(qa.crossVectors(Ya,qa));return e<0||(i=a*this.direction.dot(Za.cross(Ya)))<0||e+i>n||(s=-a*Ya.dot(Ka))<0?null:this.at(s/n,r)}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}let $a=new Ht;class Qa{constructor(t,e,i=0,s=1/0){this.ray=new Ja(t,e),this.near=i,this.far=s,this.camera=null,this.layers=new Ds,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(t,e){this.ray.set(t,e)}setFromCamera(t,e){e.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(t.x,t.y,.5).unproject(e).sub(this.ray.origin).normalize(),this.camera=e):e.isOrthographicCamera?(this.ray.origin.set(t.x,t.y,(e.near+e.far)/(e.near-e.far)).unproject(e),this.ray.direction.set(0,0,-1).transformDirection(e.matrixWorld),this.camera=e):console.error("THREE.Raycaster: Unsupported camera type: "+e.type)}setFromXRController(t){return $a.identity().extractRotation(t.matrixWorld),this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(0,0,-1).applyMatrix4($a),this}intersectObject(t,e=!0,i=[]){return eh(t,this,i,e),i.sort(th),i}intersectObjects(i,s=!0,r=[]){for(let t=0,e=i.length;t<e;t++)eh(i[t],this,r,s);return r.sort(th),r}}function th(t,e){return t.distance-e.distance}function eh(t,i,s,e){let r=!0;if(!0===(r=t.layers.test(i.layers)&&!1===t.raycast(i,s)?!1:r)&&!0===e){var n=t.children;for(let t=0,e=n.length;t<e;t++)eh(n[t],i,s,!0)}}let ih={CLASSIC:2,REAL:4};Object.freeze(ih);class sh{constructor(){this.Ht=-1,this.Ai=p.NONE,this.Qs=!0,this.P=null,this.Ft=[],this.mi=new sa,this.tr=!0,this.er=$i(),this.ir=void 0}get type(){return this.Ai}get visible(){return this.Qs}get children(){return this.Ft}set visible(t){this.Qs=t}get parent(){return this.P}set parent(t){this.P=t}get needUpdateBound(){return this.tr}set needUpdateBound(t){!0===(this.tr=t)&&null!==this.parent&&(this.parent.needUpdateBound=t)}get isLayer(){return!1}setType(t){this.Ai=t}traverse(e){if(this.Ft)for(let t=this.Ft.length-1;0<=t;t--)e(this.Ft[t])}remove(t){var e=this.Ft.indexOf(t);-1<e&&this.Ft.splice(e,1),t.parent=null,this.needUpdateBound=!0}dispose(){for(var t in this.traverse(t=>{this.remove(t),t.dispose()}),this.parent&&this.parent.remove(this),this)this[""+t]&&this[""+t].Qt&&this[""+t].Qt(),this[""+t]&&this[""+t].dispose&&this[""+t].dispose(),this[""+t]=null,delete this[""+t]}getBelongedBuildingID(){let e=null;if(this.sr)e=this;else if(this.rr)e=this.parent;else if(this.nr){var t=this.parent;e=t.parent}else if(this.ar){let t=null;t=this.type==p.DOM_MARKER?this.hr:this.parent.parent,e=t.parent}if(e)return(t=e).lr?null:t.buildingID}}Object.assign(sh.prototype,{ur(t){let e=this;for(;e;){if(e instanceof t)return e;e=e.P}return null}});class rh extends sh{constructor(t){super(),this.Ht=t.bid,this.cr=t.bcode,this.dr=t.mid,this.vr=t.name,this.pr=t.ename,this.mr=t.alias,this.t=t.x,this.o=t.y,this.gr=t.levels,this._r=[],this.wr=!0,this.ir=void 0,this.Mr=void 0,this.lr=!1,this.sr=!0,this.yr=t.groundLevel,this.Er=null}getBelongedBuildingID(){}get type(){return this.Ai}get x(){return this.t}get y(){return this.o}get bound(){return!0===this.needUpdateBound&&(this.mi.reset(),void 0!==this.R&&this.mi.copy(this.R),this.Ft.forEach(t=>{this.mi.expand(t.bound)}),this.needUpdateBound=!1),this.mi.clone()}get buildingID(){return this.Ht}get bcode(){return this.cr}get name(){return this.vr}get eName(){return this.pr}get alias(){return this.mr}get floorSpace(){return this.P.nt.Gt(this.Ht).floorSpace}set floorSpace(t){this.P.nt.Gt(this.Ht).floorSpace=t,this.traverse(t=>{t.br({animate:!1}),null===this.Er&&null!==t.Sr&&t.Sr.Ar()}),this.P.bi.Kt(this,{level:this.level,animate:!1,finish:()=>{this.wr&&(this.parent.bt.xt(),this.parent.bt.Vt(),this.parent.bt.render())}})}get level(){return this.P.nt.Gt(this.Ht).level}get visibleLevels(){return this.P.nt.Gt(this.Ht).visibleLevels}get isGroundLevel(){var t=this.P.nt.Gt(this.Ht);return t.visibleLevelsBak.length!==t.visibleLevels.length}getFloor(e){let i=null;return this.traverse(t=>{t.Tr===e&&(i=t)}),i}getFloorInfos(){return this.Rr()}setLevel(t){this.P.Wt.Lr(this,t)}setVisibleLevels(t,e,i){var s=[...t];i||(this.P.nt.Gt(this.Ht).visibleLevelsBak=[...t],null!==this.Er&&(this.floorSpace=this.Er,this.Er=null)),void 0!==this.yr&&this.P.nt.bs!==this.Ht&&2===s.length&&0<=s.indexOf(this.yr)?s.splice(s.indexOf(this.yr),1):void 0!==this.yr&&this.P.nt.bs===this.Ht&&1===s.length&&s.indexOf(this.yr)<0&&s.push(this.yr),this.P.Wt.Cr({levels:s,building:this},e)}getVisibleLevels(){return this.visibleLevels}setFloorSpace(e){if(!("animate"in e)||e.animate){this.Nr||(this.Nr=new an);var i=Number.isFinite(e.duration)?e.duration:.5;let t=e.finish;return this.wr=!1,this.Nr.Y([this.floorSpace]).Z([e.floorSpace]).K(i).J(t=>{this.floorSpace=t.destination[0]}).$(()=>{this.wr=!0,this.P.ot.ht(this.Nr),t&&t()}),this.P.ot.lt(this.Nr.X()),this.Nr}this.floorSpace=e.floorSpace}getFloorSpace(){return this.floorSpace}}function nh(e,i){if(e.userData.sourceMaterial||(e.userData.sourceMaterial=e.material),Array.isArray(e.material))for(let t=0;t<e.material.length;t++)e.material[t]=e.material[t].clone(),e.material[t].color=new Wt(i);else e.material=e.material.clone(),e.material.color=new Wt(i)}function ah(e){if(Array.isArray(e.material))for(let t=0;t<e.material.length;t++)e.material[t].dispose();else e.material.dispose();e.userData.sourceMaterial&&(e.material=e.userData.sourceMaterial,delete e.userData.sourceMaterial)}function hh(t){var e,i;t&&(t.Ir=null,e=t.Zs)&&(t.Ai===p.MODEL?e.userData.sourceMaterial&&!1!==e.userData.sourceMaterial.canDispose&&(i=e.material,e.material=e.userData.sourceMaterial,i.dispose(),delete e.userData.sourceMaterial):t.Ai===p.EXTERNAL_MODEL&&("Mesh"===e.type?ah(e):"Scene"!==e.type&&"Group"!=e.type||!e.parent||e.traverse(t=>{"Mesh"===t.type&&ah(t)}),t.Pr()))}Object.assign(rh.prototype,{Rr(){0===this._r.length&&(t=this.P.Or.Dr.get(this.dr))&&(this._r=[],t.Ft.forEach(t=>{this._r.push(t)}));var t,i={alias:"alias",floorId:"floorID",gid:"level",gname:"name"},s=Object.keys(i),r=[];for(let e=0;e<this._r.length;e++){var n=this._r[e];r[e]={};for(let t=0;t<s.length;t++){var a=s[t],h=i[a];n[a]?r[e][h]=n[a]:r[e][h]=null}}return r},Ur(){var e=this.Ft;for(let t=0;t<e.length;t++)this.Fr(e[t])},Fr(t){var e=t.getLayers();for(let t=0;t<e.length;t++){var i=e[t].children;for(let t=0;t<i.length;t++)i[t].ir=void 0,(!this.Mr||this.Mr.indexOf(i[t].er)<0)&&(i[t].ir=this.ir),(t=>t!==p.EXTENT&&t!==p.EXTERNAL_MODEL&&t!==p.MODEL&&t!==p.LABEL&&t!==p.FACILITY)(i[t].type)?(void 0!==i[t].ir?(void 0===i[t].oldOpacity&&(i[t].oldOpacity=i[t].opacity),i[t].opacity=i[t].ir):void 0!==i[t].oldOpacity&&(i[t].opacity=i[t].oldOpacity),void 0!==i[t].renderType&&i[t].update()):i[t].Pr()}},Br(t){if(null===this._focusOptions)return this._focusOpacity;let e=null;return e=null!==(e=this._focusOptions.levels&&!i(this._focusOptions.levels,t.parent.level)?this._focusOptions.opacity:e)||void 0===this._focusOptions.typeID||i(this._focusOptions.typeID,t.typeID)?e:this._focusOptions.opacity;function i(e,i){let s=!1;for(let t=0;t<e.length;t++)if(""+e[t]==""+i){s=!0;break}return s}}});class oh{constructor(t,e,i){this.st=t,this.nt=i,this.Ls=e,this.kr=[],this.Gr=null,this.Hr=nn.generateUUID(),this.Vr=new Qa,this.zr=new Gt,this.Wr=0,this.jr=0,this.W=this.W.bind(this),this.O=0,this.st.bt.renderer.domElement.addEventListener("mousedown",this.W,!1),this.st.bt.renderer.domElement.addEventListener("mouseup",this.W,!1),this.st.bt.renderer.domElement.addEventListener("mousemove",this.W,!1),this.st.bt.renderer.domElement.addEventListener("touchstart",this.W,!1),this.st.bt.renderer.domElement.addEventListener("touchend",this.W,!1),this.st.bt.renderer.domElement.addEventListener("touchmove",this.W,!1)}}function lh(){let i=null,t=!1,s=null,r=null;function n(t,e){s(t,e),r=i.requestAnimationFrame(n)}return{start:function(){!0!==t&&null!==s&&(r=i.requestAnimationFrame(n),t=!0)},stop:function(){i.cancelAnimationFrame(r),t=!1},setAnimationLoop:function(t){s=t},setContext:function(t){i=t}}}function uh(c){let f=new WeakMap;return{get:function(t){return t.isInterleavedBufferAttribute&&(t=t.data),f.get(t)},remove:function(t){t.isInterleavedBufferAttribute&&(t=t.data);var e=f.get(t);e&&(c.deleteBuffer(e.buffer),f.delete(t))},update:function(t,e){if((t=t.isInterleavedBufferAttribute?t.data:t).isGLBufferAttribute)(!(i=f.get(t))||i.version<t.version)&&f.set(t,{buffer:t.buffer,type:t.type,bytesPerElement:t.elementSize,version:t.version});else{var i=f.get(t);if(void 0===i)f.set(t,((t,e)=>{var i=t.array,s=t.usage,r=i.byteLength,n=c.createBuffer();c.bindBuffer(e,n),c.bufferData(e,i,s),t.onUploadCallback();let a;if(i instanceof Float32Array)a=c.FLOAT;else if(i instanceof Uint16Array)a=t.isFloat16BufferAttribute?c.HALF_FLOAT:c.UNSIGNED_SHORT;else if(i instanceof Int16Array)a=c.SHORT;else if(i instanceof Uint32Array)a=c.UNSIGNED_INT;else if(i instanceof Int32Array)a=c.INT;else if(i instanceof Int8Array)a=c.BYTE;else{if(!(i instanceof Uint8Array||i instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+i);a=c.UNSIGNED_BYTE}return{buffer:n,type:a,bytesPerElement:i.BYTES_PER_ELEMENT,version:t.version,size:r}})(t,e));else if(i.version<t.version){if(i.size!==t.array.byteLength)throw new Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");var s=i.buffer,r=t,n=e,a=r.array,h=r.updateRanges;if(c.bindBuffer(n,s),0===h.length)c.bufferSubData(n,0,a);else{h.sort((t,e)=>t.start-e.start);let e=0;for(let t=1;t<h.length;t++){var o=h[e],l=h[t];l.start<=o.start+o.count+1?o.count=Math.max(o.count,l.start+l.count-o.start):h[++e]=l}h.length=e+1;for(let t=0,e=h.length;t<e;t++){var u=h[t];c.bufferSubData(n,u.start*a.BYTES_PER_ELEMENT,a,u.start,u.count)}r.clearUpdateRanges()}r.onUploadCallback(),i.version=t.version}}}}}Object.assign(oh.prototype,{Qt(){for(var t in this.st.bt.renderer.domElement.removeEventListener("mousedown",this.W,!1),this.st.bt.renderer.domElement.removeEventListener("mouseup",this.W,!1),this.st.bt.renderer.domElement.removeEventListener("touchstart",this.W,!1),this.st.bt.renderer.domElement.removeEventListener("mousemove",this.W,!1),this.st.bt.renderer.domElement.removeEventListener("touchmove",this.W,!1),this.st.bt.renderer.domElement.removeEventListener("touchend",this.W,!1),delete this.st,delete this.nt,delete this.Ls,this)this[""+t]&&this[""+t].Qt&&this[""+t].Qt(),this[""+t]=null,delete this[""+t]},lt(t){this.kr.push(...t)},W(s){if((nt.environment!==I.WX||"touchmove"!==s.type)&&(!this.nt||"mousemove"!==s.type||this.nt.Xr))if("mousedown"===s.type||"touchstart"===s.type)this.O=(new Date).getTime(),"touchstart"===s.type&&(this.Wr=s.changedTouches[0].clientX,this.jr=s.changedTouches[0].clientY);else{if("mouseup"===s.type||"touchend"===s.type){if(200<(new Date).getTime()-this.O)return;if("touchend"===s.type&&Math.pow(s.changedTouches[0].clientX-this.Wr,2)+Math.pow(s.changedTouches[0].clientY-this.jr,2)>Math.pow(s.changedTouches[0].radiusX,2))return;this.O=(new Date).getTime()}var r=this.Yr(s);for(let t=0;t<this.kr.length;t++)this.kr[t](r);let t=this.Zr(r),e=null,i=null;var n=this.qr(r);if(null!==e)null!==i?n.height=n.height-this.st.getBuilding(i).getFloor(e).height:n.height=n.height-this.st.getFloor(e).height;else{var a=this.st.getLevel();if(void 0===a)return;n.height=n.height-this.st.getFloor(a).height}var a="mousemove"===s.type||"touchmove"===s.type?"hover":"click",h=(0<t.length&&(t=((e,i)=>{var s,r,n=[];for(let t=0;t<e.length;t++)e[t].type===p.LINE_MARKER?n.push(e[t]):e[t].ur?(r=e[t].ur(rh))&&(s=e[t].level,!(r=r.getFloor(s))||r.Sr&&0===r.Sr.Kr&&r.Sr.Jr(e[t].parent.type)&&!r.Sr.$r(i)||n.push(e[t])):n.push(e[t]);return n})(t,n))[0]&&t[0].type!==p.FM3DTILE_LAYER&&(h=t[0].ur(rh))&&(e=t[0].level,h!==this.st.jt)&&(i=h.Ht),{type:a,targets:t,coords:n,mouseEvent:s,level:e,buildingID:i});-1<this.Ls.Qr.indexOf(a)&&this.tn(t),this.st.Yt.Xt(h)}},tn(i){var e=[p.MODEL,p.EXTERNAL_MODEL];for(let t=0;t<i.length;t++)if(-1<e.indexOf(i[t].Ai)){if(i[t]===this.Gr)return;if(i[t].Zs){this.As&&(this.As.stop(),this.st.ot.ht(this.As)),hh(this.Gr),this.Gr=i[t],this.Gr.Ir=this.nt.highlightColor;let e=i[t].Zs;if(i[t].Ai===p.MODEL){e.userData.sourceMaterial=e.material,e.material=e.material.clone();var s=e.material.color;let t=new Wt(this.nt.highlightColor);this.As?(this.As.Y([s.r,s.g,s.b]),this.As.Z([t.r,t.g,t.b])):this.As=new an({src:[s.r,s.g,s.b],dest:[t.r,t.g,t.b]}),this.As.K(.5).J(t=>{t=new Wt(t.destination[0],t.destination[1],t.destination[2]);e&&e.material&&(e.material.color=t),this.st.enableUpdateRender()}).$(()=>{this.As.stop(),this.st.ot.ht(this.As),e&&e.material&&(e.material.color=t),this.st.enableUpdateRender()}),this.st.ot.lt(this.As.X())}else i[t].Ai===p.EXTERNAL_MODEL&&("Mesh"===e.type?nh(e,this.nt.highlightColor):"Scene"!==e.type&&"Group"!=e.type||e.traverse(t=>{"Mesh"===t.type&&nh(t,this.nt.highlightColor)}));return void this.st.enableUpdateRender()}break}this.As&&(this.As.stop(),this.st.ot.ht(this.As)),hh(this.Gr),this.Gr=null,this.st.enableUpdateRender()},Zr(e){var s=[];for(let t=0;t<e.length;t++)if(void 0!==e[t].type&&e[t].type===p.FM3DTILE_LAYER)s.push({type:p.FM3DTILE_LAYER,object:e[t].object});else{let i=e[t].object;if("LineSegments"!==i.type&&!(i.isNoPickup||i.parent&&i.parent.mapNode&&i.parent.mapNode.en&&i===i.parent.mapNode.en.top)){for(;!i.mapNode;)i=i.parent;let e=!0;for(let t=0;t<s.length;t++)if(s[t].Zs&&s[t].Zs.uuid===i.uuid){e=!1;break}var r=this.st.pickFilterFunction({type:i.mapNode.Ai,data:i.mapNode.qs});i.mapNode.visible&&!i.mapNode.sn&&r&&e&&i.visible&&s.push(i.mapNode)}}return s},qr(e){let i=null;for(let t=0;t<e.length;t++)if("LineSegments"!==e[t].object.type){i=e[t];break}var t;return e.length<1||!i?{x:NaN,y:NaN,z:NaN,height:NaN}:(t=i.point.clone(),{x:this.st.x+t.x,y:this.st.y-t.z,z:i.point.y,height:i.point.y})},Yr(e){var i=[];if(e.touches){let t=e.touches[0];"touchend"===e.type&&(t=e.changedTouches[0]);var s=this.st.bt.renderer.domElement.getBoundingClientRect(),r=t.clientX-s.left,n=t.clientY-s.top;this.zr.x=r/s.width*2-1,this.zr.y=-n/s.height*2+1}else{r=e;this.zr.x=r.offsetX/this.st.bt.renderer.domElement.clientWidth*2-1,this.zr.y=2*-(r.offsetY/this.st.bt.renderer.domElement.clientHeight)+1}this.zr.z=.5,this.Vr.setFromCamera(this.zr,this.st.ct);let a=new Map,h=[];if(this.st.bt.rn.forEach((t,e)=>{e=e.split("%A%B%C%D")[0];let i=a.get(e);if(i||(i=[],a.set(e,i),h.unshift(e)),t.visible){var s=this.Vr.intersectObject(t,!0);for(let t=0;t<s.length;t++)s[t].object.visible&&!s[t].object.isNoPick&&i.push(s[t])}}),0<this.st.bt.nn.length){let i=a.get("other1");i||(i=[],a.set("other1",i),h.push("other1"));var t=this.st.bt.nn;for(let e=0;e<t.length;e++)if(t[e].visible){var o=this.Vr.intersectObject(t[e],!0);for(let t=0;t<o.length;t++)o[e].type=p.FM3DTILE_LAYER,i.push(o[e])}}if(this.st.bt.an){let e=a.get("other2");e||(e=[],a.set("other2",e),h.push("other2"));var l=this.Vr.intersectObject(this.st.bt.an,!0);for(let t=0;t<l.length;t++)l[t].object.visible&&(l[t].object.isNoPickup=!0,e.push(l[t]))}for(let t=0;t<h.length;t++)for(var u=a.get(h[t]),c=0;c<u.length;c++)i.push(u[c]);return i.sort(function(t,e){return t.distance-e.distance}),i}});let ch=new Gt,fh=new ct;class N{constructor(t,e,i=!1){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=i,this.usage=Wi,this.updateRanges=[],this.gpuType=le,this.version=0}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}setUsage(t){return this.usage=t,this}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}copy(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this.gpuType=t.gpuType,this}copyAt(i,s,r){i*=this.itemSize,r*=s.itemSize;for(let t=0,e=this.itemSize;t<e;t++)this.array[i+t]=s.array[r+t];return this}copyArray(t){return this.array.set(t),this}applyMatrix3(i){if(2===this.itemSize)for(let t=0,e=this.count;t<e;t++)fh.fromBufferAttribute(this,t),fh.applyMatrix3(i),this.setXY(t,fh.x,fh.y);else if(3===this.itemSize)for(let t=0,e=this.count;t<e;t++)ch.fromBufferAttribute(this,t),ch.applyMatrix3(i),this.setXYZ(t,ch.x,ch.y,ch.z);return this}applyMatrix4(i){for(let t=0,e=this.count;t<e;t++)ch.fromBufferAttribute(this,t),ch.applyMatrix4(i),this.setXYZ(t,ch.x,ch.y,ch.z);return this}applyNormalMatrix(i){for(let t=0,e=this.count;t<e;t++)ch.fromBufferAttribute(this,t),ch.applyNormalMatrix(i),this.setXYZ(t,ch.x,ch.y,ch.z);return this}transformDirection(i){for(let t=0,e=this.count;t<e;t++)ch.fromBufferAttribute(this,t),ch.transformDirection(i),this.setXYZ(t,ch.x,ch.y,ch.z);return this}set(t,e=0){return this.array.set(t,e),this}getComponent(t,e){let i=this.array[t*this.itemSize+e];return i=this.normalized?_s(i,this.array):i}setComponent(t,e,i){return this.normalized&&(i=n(i,this.array)),this.array[t*this.itemSize+e]=i,this}getX(t){let e=this.array[t*this.itemSize];return e=this.normalized?_s(e,this.array):e}setX(t,e){return this.normalized&&(e=n(e,this.array)),this.array[t*this.itemSize]=e,this}getY(t){let e=this.array[t*this.itemSize+1];return e=this.normalized?_s(e,this.array):e}setY(t,e){return this.normalized&&(e=n(e,this.array)),this.array[t*this.itemSize+1]=e,this}getZ(t){let e=this.array[t*this.itemSize+2];return e=this.normalized?_s(e,this.array):e}setZ(t,e){return this.normalized&&(e=n(e,this.array)),this.array[t*this.itemSize+2]=e,this}getW(t){let e=this.array[t*this.itemSize+3];return e=this.normalized?_s(e,this.array):e}setW(t,e){return this.normalized&&(e=n(e,this.array)),this.array[t*this.itemSize+3]=e,this}setXY(t,e,i){return t*=this.itemSize,this.normalized&&(e=n(e,this.array),i=n(i,this.array)),this.array[t+0]=e,this.array[t+1]=i,this}setXYZ(t,e,i,s){return t*=this.itemSize,this.normalized&&(e=n(e,this.array),i=n(i,this.array),s=n(s,this.array)),this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=s,this}setXYZW(t,e,i,s,r){return t*=this.itemSize,this.normalized&&(e=n(e,this.array),i=n(i,this.array),s=n(s,this.array),r=n(r,this.array)),this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=s,this.array[t+3]=r,this}onUpload(t){return this.onUploadCallback=t,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){var t={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(t.name=this.name),this.usage!==Wi&&(t.usage=this.usage),t}}class dh extends N{constructor(t,e,i){super(new Uint16Array(t),e,i)}}class vh extends N{constructor(t,e,i){super(new Uint32Array(t),e,i)}}class ph extends N{constructor(t,e,i){super(new Float32Array(t),e,i)}}function mh(e){for(let t=e.length-1;0<=t;--t)if(65535<=e[t])return 1}function gh(t){return nt.document.createElementNS("http://www.w3.org/1999/xhtml",t)}function _h(){var t=gh("canvas");return t.style.display="block",t}let wh={};function Mh(t){t in wh||(wh[t]=!0,console.warn(t))}function yh(s,r,n){return new Promise(function(e,i){setTimeout(function t(){switch(s.clientWaitSync(r,s.SYNC_FLUSH_COMMANDS_BIT,0)){case s.WAIT_FAILED:i();break;case s.TIMEOUT_EXPIRED:setTimeout(t,n);break;default:e()}},n)})}function Eh(t){t=t.elements;t[2]=.5*t[2]+.5*t[3],t[6]=.5*t[6]+.5*t[7],t[10]=.5*t[10]+.5*t[11],t[14]=.5*t[14]+.5*t[15]}function xh(t){t=t.elements;-1===t[11]?(t[10]=-t[10]-1,t[14]=-t[14]):(t[10]=-t[10],t[14]=1-t[14])}let bh=0,Sh=new Ht,Ah=new Js,Th=new Gt,Rh=new rr,Lh=new rr,Ch=new Gt;class Nh extends Cs{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:bh++}),this.uuid=$i(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(t){return Array.isArray(t)?this.index=new(mh(t)?vh:dh)(t,1):this.index=t,this}getAttribute(t){return this.attributes[t]}setAttribute(t,e){return this.attributes[t]=e,this}deleteAttribute(t){return delete this.attributes[t],this}hasAttribute(t){return void 0!==this.attributes[t]}addGroup(t,e,i=0){this.groups.push({start:t,count:e,materialIndex:i})}clearGroups(){this.groups=[]}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}applyMatrix4(t){var e=this.attributes.position,e=(void 0!==e&&(e.applyMatrix4(t),e.needsUpdate=!0),this.attributes.normal),i=(void 0!==e&&(i=(new _).getNormalMatrix(t),e.applyNormalMatrix(i),e.needsUpdate=!0),this.attributes.tangent);return void 0!==i&&(i.transformDirection(t),i.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(t){return Sh.makeRotationFromQuaternion(t),this.applyMatrix4(Sh),this}rotateX(t){return Sh.makeRotationX(t),this.applyMatrix4(Sh),this}rotateY(t){return Sh.makeRotationY(t),this.applyMatrix4(Sh),this}rotateZ(t){return Sh.makeRotationZ(t),this.applyMatrix4(Sh),this}translate(t,e,i){return Sh.makeTranslation(t,e,i),this.applyMatrix4(Sh),this}scale(t,e,i){return Sh.makeScale(t,e,i),this.applyMatrix4(Sh),this}lookAt(t){return Ah.lookAt(t),Ah.updateMatrix(),this.applyMatrix4(Ah.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(Th).negate(),this.translate(Th.x,Th.y,Th.z),this}setFromPoints(i){var s=[];for(let t=0,e=i.length;t<e;t++){var r=i[t];s.push(r.x,r.y,r.z||0)}return this.setAttribute("position",new ph(s,3)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new rr);var t=this.attributes.position,i=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)console.error("THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),this.boundingBox.set(new Gt(-1/0,-1/0,-1/0),new Gt(1/0,1/0,1/0));else{if(void 0!==t){if(this.boundingBox.setFromBufferAttribute(t),i)for(let t=0,e=i.length;t<e;t++){var s=i[t];Rh.setFromBufferAttribute(s),this.morphTargetsRelative?(Ch.addVectors(this.boundingBox.min,Rh.min),this.boundingBox.expandByPoint(Ch),Ch.addVectors(this.boundingBox.max,Rh.max),this.boundingBox.expandByPoint(Ch)):(this.boundingBox.expandByPoint(Rh.min),this.boundingBox.expandByPoint(Rh.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Er);var s=this.attributes.position,r=this.morphAttributes.position;if(s&&s.isGLBufferAttribute)console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),this.boundingSphere.set(new Gt,1/0);else if(s){var n=this.boundingSphere.center;if(Rh.setFromBufferAttribute(s),r)for(let t=0,e=r.length;t<e;t++){var a=r[t];Lh.setFromBufferAttribute(a),this.morphTargetsRelative?(Ch.addVectors(Rh.min,Lh.min),Rh.expandByPoint(Ch),Ch.addVectors(Rh.max,Lh.max),Rh.expandByPoint(Ch)):(Rh.expandByPoint(Lh.min),Rh.expandByPoint(Lh.max))}Rh.getCenter(n);let i=0;for(let t=0,e=s.count;t<e;t++)Ch.fromBufferAttribute(s,t),i=Math.max(i,n.distanceToSquared(Ch));if(r)for(let t=0,e=r.length;t<e;t++){var h=r[t],o=this.morphTargetsRelative;for(let t=0,e=h.count;t<e;t++)Ch.fromBufferAttribute(h,t),o&&(Th.fromBufferAttribute(s,t),Ch.add(Th)),i=Math.max(i,n.distanceToSquared(Ch))}this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){var y,E,x,b,S=this.index,t=this.attributes;if(null===S||void 0===t.position||void 0===t.normal||void 0===t.uv)console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");else{let i=t.position,s=t.normal,r=t.uv,n=(!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new N(new Float32Array(4*i.count),4)),this.getAttribute("tangent")),a=[],h=[];for(let t=0;t<i.count;t++)a[t]=new Gt,h[t]=new Gt;let o=new Gt,l=new Gt,u=new Gt,c=new ct,f=new ct,d=new ct,v=new Gt,p=new Gt,m=this.groups;for(let t=0,e=(m=0===m.length?[{start:0,count:S.count}]:m).length;t<e;++t){var A=m[t],T=A.start;for(let t=T,e=T+A.count;t<e;t+=3)y=S.getX(t+0),E=S.getX(t+1),x=S.getX(t+2),b=void 0,o.fromBufferAttribute(i,y),l.fromBufferAttribute(i,E),u.fromBufferAttribute(i,x),c.fromBufferAttribute(r,y),f.fromBufferAttribute(r,E),d.fromBufferAttribute(r,x),l.sub(o),u.sub(o),f.sub(c),d.sub(c),b=1/(f.x*d.y-d.x*f.y),isFinite(b)&&(v.copy(l).multiplyScalar(d.y).addScaledVector(u,-f.y).multiplyScalar(b),p.copy(u).multiplyScalar(f.x).addScaledVector(l,-d.x).multiplyScalar(b),a[y].add(v),a[E].add(v),a[x].add(v),h[y].add(p),h[E].add(p),h[x].add(p))}let g=new Gt,_=new Gt,w=new Gt,M=new Gt;for(let t=0,e=m.length;t<e;++t){var R=m[t],L=R.start;for(let t=L,e=L+R.count;t<e;t+=3)C(S.getX(t+0)),C(S.getX(t+1)),C(S.getX(t+2))}function C(t){w.fromBufferAttribute(s,t),M.copy(w);var e=a[t],e=(g.copy(e),g.sub(w.multiplyScalar(w.dot(e))).normalize(),_.crossVectors(M,e),_.dot(h[t])),e=e<0?-1:1;n.setXYZW(t,g.x,g.y,g.z,e)}}}computeVertexNormals(){var s=this.index,r=this.getAttribute("position");if(void 0!==r){let i=this.getAttribute("normal");if(void 0===i)i=new N(new Float32Array(3*r.count),3),this.setAttribute("normal",i);else for(let t=0,e=i.count;t<e;t++)i.setXYZ(t,0,0,0);var n=new Gt,a=new Gt,h=new Gt,o=new Gt,l=new Gt,u=new Gt,c=new Gt,f=new Gt;if(s)for(let t=0,e=s.count;t<e;t+=3){var d=s.getX(t+0),v=s.getX(t+1),p=s.getX(t+2);n.fromBufferAttribute(r,d),a.fromBufferAttribute(r,v),h.fromBufferAttribute(r,p),c.subVectors(h,a),f.subVectors(n,a),c.cross(f),o.fromBufferAttribute(i,d),l.fromBufferAttribute(i,v),u.fromBufferAttribute(i,p),o.add(c),l.add(c),u.add(c),i.setXYZ(d,o.x,o.y,o.z),i.setXYZ(v,l.x,l.y,l.z),i.setXYZ(p,u.x,u.y,u.z)}else for(let t=0,e=r.count;t<e;t+=3)n.fromBufferAttribute(r,t+0),a.fromBufferAttribute(r,t+1),h.fromBufferAttribute(r,t+2),c.subVectors(h,a),f.subVectors(n,a),c.cross(f),i.setXYZ(t+0,c.x,c.y,c.z),i.setXYZ(t+1,c.x,c.y,c.z),i.setXYZ(t+2,c.x,c.y,c.z);this.normalizeNormals(),i.needsUpdate=!0}}normalizeNormals(){var i=this.attributes.normal;for(let t=0,e=i.count;t<e;t++)Ch.fromBufferAttribute(i,t),Ch.normalize(),i.setXYZ(t,Ch.x,Ch.y,Ch.z)}toNonIndexed(){function i(i,s){var r=i.array,n=i.itemSize,t=i.normalized,a=new r.constructor(s.length*n);let h=0,o=0;for(let t=0,e=s.length;t<e;t++){h=i.isInterleavedBufferAttribute?s[t]*i.data.stride+i.offset:s[t]*n;for(let t=0;t<n;t++)a[o++]=r[h++]}return new N(a,n,t)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;var t,s=new Nh,r=this.index.array,e=this.attributes;for(t in e){var n=i(e[t],r);s.setAttribute(t,n)}var a,h=this.morphAttributes;for(a in h){var o=[],l=h[a];for(let t=0,e=l.length;t<e;t++){var u=i(l[t],r);o.push(u)}s.morphAttributes[a]=o}s.morphTargetsRelative=this.morphTargetsRelative;var c=this.groups;for(let t=0,e=c.length;t<e;t++){var f=c[t];s.addGroup(f.start,f.count,f.materialIndex)}return s}toJSON(){var i={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),0<Object.keys(this.userData).length&&(i.userData=this.userData),void 0!==this.parameters){var t,e=this.parameters;for(t in e)void 0!==e[t]&&(i[t]=e[t])}else{i.data={attributes:{}};var s,r=this.index,n=(null!==r&&(i.data.index={type:r.array.constructor.name,array:Array.prototype.slice.call(r.array)}),this.attributes);for(s in n){var a=n[s];i.data.attributes[s]=a.toJSON(i.data)}var h,o={};let t=!1;for(h in this.morphAttributes){var l=this.morphAttributes[h],u=[];for(let t=0,e=l.length;t<e;t++){var c=l[t];u.push(c.toJSON(i.data))}0<u.length&&(o[h]=u,t=!0)}t&&(i.data.morphAttributes=o,i.data.morphTargetsRelative=this.morphTargetsRelative);r=this.groups,r=(0<r.length&&(i.data.groups=JSON.parse(JSON.stringify(r))),this.boundingSphere);null!==r&&(i.data.boundingSphere={center:r.center.toArray(),radius:r.radius})}return i}clone(){return(new this.constructor).copy(this)}copy(t){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;var e,i={},s=(this.name=t.name,t.index),r=(null!==s&&this.setIndex(s.clone(i)),t.attributes);for(e in r){var n=r[e];this.setAttribute(e,n.clone(i))}var a,h=t.morphAttributes;for(a in h){var o=[],l=h[a];for(let t=0,e=l.length;t<e;t++)o.push(l[t].clone(i));this.morphAttributes[a]=o}this.morphTargetsRelative=t.morphTargetsRelative;var u=t.groups;for(let t=0,e=u.length;t<e;t++){var c=u[t];this.addGroup(c.start,c.count,c.materialIndex)}s=t.boundingBox,null!==s&&(this.boundingBox=s.clone()),s=t.boundingSphere;return null!==s&&(this.boundingSphere=s.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}class Ih extends Nh{constructor(t=1,e=1,i=1,s=1,r=1,n=1){super(),this.type="BoxGeometry",this.parameters={width:t,height:e,depth:i,widthSegments:s,heightSegments:r,depthSegments:n};let T=this,R=(s=Math.floor(s),r=Math.floor(r),n=Math.floor(n),[]),L=[],C=[],N=[],I=0,P=0;function a(i,s,r,n,a,t,e,h,o,l,u){var c=t/o,f=e/l,d=t/2,v=e/2,p=h/2,m=o+1,g=l+1;let _=0,w=0;var M=new Gt;for(let e=0;e<g;e++){var y=e*f-v;for(let t=0;t<m;t++){var E=t*c-d;M[i]=E*n,M[s]=y*a,M[r]=p,L.push(M.x,M.y,M.z),M[i]=0,M[s]=0,M[r]=0<h?1:-1,C.push(M.x,M.y,M.z),N.push(t/o),N.push(1-e/l),_+=1}}for(let e=0;e<l;e++)for(let t=0;t<o;t++){var x=I+t+m*e,b=I+t+m*(e+1),S=I+(t+1)+m*(e+1),A=I+(t+1)+m*e;R.push(x,b,A),R.push(b,S,A),w+=6}T.addGroup(P,w,u),P+=w,I+=_}a("z","y","x",-1,-1,i,e,t,n,r,0),a("z","y","x",1,-1,i,e,-t,n,r,1),a("x","z","y",1,1,t,i,e,s,n,2),a("x","z","y",1,-1,t,i,-e,s,n,3),a("x","y","z",1,-1,t,e,i,s,r,4),a("x","y","z",-1,-1,t,e,-i,s,r,5),this.setIndex(R),this.setAttribute("position",new ph(L,3)),this.setAttribute("normal",new ph(C,3)),this.setAttribute("uv",new ph(N,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new Ih(t.width,t.height,t.depth,t.widthSegments,t.heightSegments,t.depthSegments)}}class Ph extends Nh{constructor(t=1,e=1,i=1,s=1){super(),this.type="PlaneGeometry",this.parameters={width:t,height:e,widthSegments:i,heightSegments:s};var r=t/2,n=e/2,a=Math.floor(i),h=Math.floor(s),o=a+1,l=h+1,u=t/a,c=e/h,f=[],d=[],v=[],p=[];for(let e=0;e<l;e++){var m=e*c-n;for(let t=0;t<o;t++){var g=t*u-r;d.push(g,-m,0),v.push(0,0,1),p.push(t/a),p.push(1-e/h)}}for(let e=0;e<h;e++)for(let t=0;t<a;t++){var _=t+o*e,w=t+o*(e+1),M=t+1+o*(e+1),y=t+1+o*e;f.push(_,w,y),f.push(w,M,y)}this.setIndex(f),this.setAttribute("position",new ph(d,3)),this.setAttribute("normal",new ph(v,3)),this.setAttribute("uv",new ph(p,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new Ph(t.width,t.height,t.widthSegments,t.heightSegments)}}let Dh=0;class Oh extends Cs{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:Dh++}),this.uuid=$i(),this.name="",this.type="Material",this.blending=vt,this.side=Xt,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=dt,this.blendDst=pt,this.blendEquation=tt,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new Wt(0,0,0),this.blendAlpha=0,this.depthFunc=Rt,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=Oi,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=Ii,this.stencilZFail=Ii,this.stencilZPass=Ii,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this.hn=qr()}get alphaTest(){return this.hn}set alphaTest(t){0<this.hn!=0<t&&this.version++,this.hn=t}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(t){if(void 0!==t)for(var e in t){var i,s=t[e];void 0===s?console.warn(`THREE.Material: parameter '${e}' has value of undefined.`):void 0===(i=this[e])?console.warn(`THREE.Material: '${e}' is not a property of THREE.${this.type}.`):i&&i.isColor?i.set(s):i&&i.isVector3&&s&&s.isVector3?i.copy(s):this[e]=s}}toJSON(t){var e=void 0===t||"string"==typeof t,i=(e&&(t={textures:{},images:{}}),{metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}});function s(t){var e,i=[];for(e in t){var s=t[e];delete s.metadata,i.push(s)}return i}return i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),void 0!==this.sheen&&(i.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(i.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(i.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(i.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(i.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(t).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(t).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(t).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.dispersion&&(i.dispersion=this.dispersion),void 0!==this.iridescence&&(i.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(i.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(i.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(i.iridescenceMap=this.iridescenceMap.toJSON(t).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(i.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(t).uuid),void 0!==this.anisotropy&&(i.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(i.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(i.anisotropyMap=this.anisotropyMap.toJSON(t).uuid),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(t).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(t).uuid,i.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(t).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(t).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(t).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(t).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(t).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(i.specularIntensityMap=this.specularIntensityMap.toJSON(t).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(i.specularColorMap=this.specularColorMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(t).uuid,void 0!==this.combine)&&(i.combine=this.combine),void 0!==this.envMapRotation&&(i.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(i.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(i.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(t).uuid),void 0!==this.transmission&&(i.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(i.transmissionMap=this.transmissionMap.toJSON(t).uuid),void 0!==this.thickness&&(i.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(i.thicknessMap=this.thicknessMap.toJSON(t).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(i.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(i.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(i.size=this.size),null!==this.shadowSide&&(i.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),this.blending!==vt&&(i.blending=this.blending),this.side!==Xt&&(i.side=this.side),!0===this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=!0),this.blendSrc!==dt&&(i.blendSrc=this.blendSrc),this.blendDst!==pt&&(i.blendDst=this.blendDst),this.blendEquation!==tt&&(i.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(i.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(i.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(i.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(i.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(i.blendAlpha=this.blendAlpha),this.depthFunc!==Rt&&(i.depthFunc=this.depthFunc),!1===this.depthTest&&(i.depthTest=this.depthTest),!1===this.depthWrite&&(i.depthWrite=this.depthWrite),!1===this.colorWrite&&(i.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(i.stencilWriteMask=this.stencilWriteMask),this.stencilFunc!==Oi&&(i.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(i.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(i.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==Ii&&(i.stencilFail=this.stencilFail),this.stencilZFail!==Ii&&(i.stencilZFail=this.stencilZFail),this.stencilZPass!==Ii&&(i.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(i.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),0<this.alphaTest&&(i.alphaTest=this.alphaTest),!0===this.alphaHash&&(i.alphaHash=!0),!0===this.alphaToCoverage&&(i.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=!0),!0===this.forceSinglePass&&(i.forceSinglePass=!0),!0===this.wireframe&&(i.wireframe=!0),1<this.wireframeLinewidth&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(i.flatShading=!0),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),!1===this.fog&&(i.fog=!1),0<Object.keys(this.userData).length&&(i.userData=this.userData),e&&(e=s(t.textures),t=s(t.images),0<e.length&&(i.textures=e),0<t.length)&&(i.images=t),i}clone(){return(new this.constructor).copy(this)}copy(t){this.name=t.name,this.blending=t.blending,this.side=t.side,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.blendColor.copy(t.blendColor),this.blendAlpha=t.blendAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilWrite=t.stencilWrite;var e=t.clippingPlanes;let i=null;if(null!==e){var s=e.length;i=new Array(s);for(let t=0;t!==s;++t)i[t]=e[t].clone()}return this.clippingPlanes=i,this.clipIntersection=t.clipIntersection,this.clipShadows=t.clipShadows,this.shadowSide=t.shadowSide,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.alphaHash=t.alphaHash,this.alphaToCoverage=t.alphaToCoverage,this.premultipliedAlpha=t.premultipliedAlpha,this.forceSinglePass=t.forceSinglePass,this.visible=t.visible,this.toneMapped=t.toneMapped,this.userData=JSON.parse(JSON.stringify(t.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(t){!0===t&&this.version++}onBuild(){console.warn("Material: onBuild() has been removed.")}}function Uh(t){var e,i={};for(e in t)for(var s in i[e]={},t[e]){var r=t[e][s];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture||r.isQuaternion)?r.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),i[e][s]=null):i[e][s]=r.clone():Array.isArray(r)?i[e][s]=r.slice():i[e][s]=r}return i}function Fh(e){var i={};for(let t=0;t<e.length;t++){var s,r=Uh(e[t]);for(s in r)i[s]=r[s]}return i}function Bh(e){var i=[];for(let t=0;t<e.length;t++)i.push(e[t].clone());return i}function kh(t){var e=t.getRenderTarget();return null===e?t.outputColorSpace:!0===e.isXRRenderTarget?e.texture.colorSpace:zt.workingColorSpace}let Gh={clone:Uh,merge:Fh};var Hh=`
void main() {
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}
`,Vh=`
void main() {
	gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
}
`;class zh extends Oh{constructor(t){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader=Hh,this.fragmentShader=Vh,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==t&&this.setValues(t)}copy(t){return super.copy(t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=Uh(t.uniforms),this.uniformsGroups=Bh(t.uniformsGroups),this.defines=Object.assign({},t.defines),this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.fog=t.fog,this.lights=t.lights,this.clipping=t.clipping,this.extensions=Object.assign({},t.extensions),this.glslVersion=t.glslVersion,this}toJSON(t){var e,i=super.toJSON(t);for(e in i.glslVersion=this.glslVersion,i.uniforms={},this.uniforms){var s=this.uniforms[e].value;s&&s.isTexture?i.uniforms[e]={type:"t",value:s.toJSON(t).uuid}:s&&s.isColor?i.uniforms[e]={type:"c",value:s.getHex()}:s&&s.isVector2?i.uniforms[e]={type:"v2",value:s.toArray()}:s&&s.isVector3?i.uniforms[e]={type:"v3",value:s.toArray()}:s&&s.isVector4?i.uniforms[e]={type:"v4",value:s.toArray()}:s&&s.isMatrix3?i.uniforms[e]={type:"m3",value:s.toArray()}:s&&s.isMatrix4?i.uniforms[e]={type:"m4",value:s.toArray()}:i.uniforms[e]={value:s}}0<Object.keys(this.defines).length&&(i.defines=this.defines),i.vertexShader=this.vertexShader,i.fragmentShader=this.fragmentShader,i.lights=this.lights,i.clipping=this.clipping;var r,n={};for(r in this.extensions)!0===this.extensions[r]&&(n[r]=!0);return 0<Object.keys(n).length&&(i.extensions=n),i}}let Wh=new Gt,jh=new Gt,Xh=new Gt,Yh=new Gt,Zh=new Gt,qh=new Gt,Kh=new Gt,Jh=new Gt,$h=new Gt,Qh=new Gt,to=new Vt,eo=new Vt,io=new Vt;class so{constructor(t=new Gt,e=new Gt,i=new Gt){this.a=t,this.b=e,this.c=i}static getNormal(t,e,i,s){s.subVectors(i,e),Wh.subVectors(t,e),s.cross(Wh);i=s.lengthSq();return 0<i?s.multiplyScalar(1/Math.sqrt(i)):s.set(0,0,0)}static getBarycoord(t,e,i,s,r){Wh.subVectors(s,e),jh.subVectors(i,e),Xh.subVectors(t,e);var s=Wh.dot(Wh),i=Wh.dot(jh),t=Wh.dot(Xh),e=jh.dot(jh),n=jh.dot(Xh),a=s*e-i*i;return 0==a?(r.set(0,0,0),null):r.set(1-(e=(e*t-i*n)*(r=1/a))-(a=(s*n-i*t)*r),a,e)}static containsPoint(t,e,i,s){return null!==this.getBarycoord(t,e,i,s,Yh)&&0<=Yh.x&&0<=Yh.y&&Yh.x+Yh.y<=1}static getInterpolation(t,e,i,s,r,n,a,h){return null===this.getBarycoord(t,e,i,s,Yh)?(h.x=0,h.y=0,"z"in h&&(h.z=0),"w"in h&&(h.w=0),null):(h.setScalar(0),h.addScaledVector(r,Yh.x),h.addScaledVector(n,Yh.y),h.addScaledVector(a,Yh.z),h)}static getInterpolatedAttribute(t,e,i,s,r,n){return to.setScalar(0),eo.setScalar(0),io.setScalar(0),to.fromBufferAttribute(t,e),eo.fromBufferAttribute(t,i),io.fromBufferAttribute(t,s),n.setScalar(0),n.addScaledVector(to,r.x),n.addScaledVector(eo,r.y),n.addScaledVector(io,r.z),n}static isFrontFacing(t,e,i,s){return Wh.subVectors(i,e),jh.subVectors(t,e),Wh.cross(jh).dot(s)<0}set(t,e,i){return this.a.copy(t),this.b.copy(e),this.c.copy(i),this}setFromPointsAndIndices(t,e,i,s){return this.a.copy(t[e]),this.b.copy(t[i]),this.c.copy(t[s]),this}setFromAttributeAndIndices(t,e,i,s){return this.a.fromBufferAttribute(t,e),this.b.fromBufferAttribute(t,i),this.c.fromBufferAttribute(t,s),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getArea(){return Wh.subVectors(this.c,this.b),jh.subVectors(this.a,this.b),.5*Wh.cross(jh).length()}getMidpoint(t){return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return so.getNormal(this.a,this.b,this.c,t)}getPlane(t){return t.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,e){return so.getBarycoord(t,this.a,this.b,this.c,e)}getInterpolation(t,e,i,s,r){return so.getInterpolation(t,this.a,this.b,this.c,e,i,s,r)}containsPoint(t){return so.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return so.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(t){return t.intersectsTriangle(this)}closestPointToPoint(t,e){var i=this.a,s=this.b,r=this.c;let n,a;Zh.subVectors(s,i),qh.subVectors(r,i),Jh.subVectors(t,i);var h=Zh.dot(Jh),o=qh.dot(Jh);if(h<=0&&o<=0)return e.copy(i);$h.subVectors(t,s);var l=Zh.dot($h),u=qh.dot($h);if(0<=l&&u<=l)return e.copy(s);var c=h*u-l*o;if(c<=0&&0<=h&&l<=0)return n=h/(h-l),e.copy(i).addScaledVector(Zh,n);Qh.subVectors(t,r);var t=Zh.dot(Qh),f=qh.dot(Qh);return 0<=f&&t<=f?e.copy(r):(h=t*o-h*f)<=0&&0<=o&&f<=0?(a=o/(o-f),e.copy(i).addScaledVector(qh,a)):(o=l*f-t*u)<=0&&0<=u-l&&0<=t-f?(Kh.subVectors(r,s),a=(u-l)/(u-l+(t-f)),e.copy(s).addScaledVector(Kh,a)):(r=1/(o+h+c),n=h*r,a=c*r,e.copy(i).addScaledVector(Zh,n).addScaledVector(qh,a))}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}class ro extends Oh{constructor(t){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new Wt(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Ps,this.combine=o,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapRotation.copy(t.envMapRotation),this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.fog=t.fog,this}}let no=new Ht,ao=new Ja,ho=new Er,oo=new Gt,lo=new Gt,uo=new Gt,co=new Gt,fo=new Gt,vo=new Gt,po=new Gt,mo=new Gt;class L extends Js{constructor(t=new Nh,e=new ro){super(),this.isMesh=!0,this.type="Mesh",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),void 0!==t.morphTargetInfluences&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),void 0!==t.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}updateMorphTargets(){var t=this.geometry.morphAttributes,e=Object.keys(t);if(0<e.length){var i=t[e[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=i.length;t<e;t++){var s=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[s]=t}}}}getVertexPosition(i,s){var t=this.geometry,e=t.attributes.position,r=t.morphAttributes.position,n=t.morphTargetsRelative,a=(s.fromBufferAttribute(e,i),this.morphTargetInfluences);if(r&&a){vo.set(0,0,0);for(let t=0,e=r.length;t<e;t++){var h=a[t],o=r[t];0!==h&&(fo.fromBufferAttribute(o,i),n?vo.addScaledVector(fo,h):vo.addScaledVector(fo.sub(s),h))}s.add(vo)}return s}raycast(t,e){var i=this.geometry,s=this.material,r=this.matrixWorld;if(void 0!==s){if(null===i.boundingSphere&&i.computeBoundingSphere(),ho.copy(i.boundingSphere),ho.applyMatrix4(r),ao.copy(t.ray).recast(t.near),!1===ho.containsPoint(ao.origin)){if(null===ao.intersectSphere(ho,oo))return;if(ao.origin.distanceToSquared(oo)>(t.far-t.near)**2)return}no.copy(r).invert(),ao.copy(t.ray).applyMatrix4(no),null!==i.boundingBox&&!1===ao.intersectsBox(i.boundingBox)||this.ln(t,e,ao)}}ln(i,s,r){let n;var t=this.geometry,a=this.material,h=t.index,o=t.attributes.position,l=t.attributes.uv,u=t.attributes.uv1,c=t.attributes.normal,f=t.groups,d=t.drawRange;if(null!==h)if(Array.isArray(a))for(let t=0,e=f.length;t<e;t++){var v=f[t],p=a[v.materialIndex];for(let t=Math.max(v.start,d.start),e=Math.min(h.count,Math.min(v.start+v.count,d.start+d.count));t<e;t+=3){var m=h.getX(t),g=h.getX(t+1),_=h.getX(t+2);(n=_o(this,p,i,r,l,u,c,m,g,_))&&(n.faceIndex=Math.floor(t/3),n.face.materialIndex=v.materialIndex,s.push(n))}}else for(let t=Math.max(0,d.start),e=Math.min(h.count,d.start+d.count);t<e;t+=3){var w=h.getX(t),M=h.getX(t+1),y=h.getX(t+2);(n=_o(this,a,i,r,l,u,c,w,M,y))&&(n.faceIndex=Math.floor(t/3),s.push(n))}else if(void 0!==o)if(Array.isArray(a))for(let t=0,e=f.length;t<e;t++){var E=f[t],x=a[E.materialIndex];for(let t=Math.max(E.start,d.start),e=Math.min(o.count,Math.min(E.start+E.count,d.start+d.count));t<e;t+=3){var b=t,S=t+1,A=t+2;(n=_o(this,x,i,r,l,u,c,b,S,A))&&(n.faceIndex=Math.floor(t/3),n.face.materialIndex=E.materialIndex,s.push(n))}}else for(let t=Math.max(0,d.start),e=Math.min(o.count,d.start+d.count);t<e;t+=3){var T=t,R=t+1,L=t+2;(n=_o(this,a,i,r,l,u,c,T,R,L))&&(n.faceIndex=Math.floor(t/3),s.push(n))}}}function go(t,e,i,s,r,n,a,h){let o;if(null===(o=e.side===Yt?s.intersectTriangle(a,n,r,!0,h):s.intersectTriangle(r,n,a,e.side===Xt,h)))return null;mo.copy(h),mo.applyMatrix4(t.matrixWorld);s=i.ray.origin.distanceTo(mo);return s<i.near||s>i.far?null:{distance:s,point:mo.clone(),object:t}}function _o(t,e,i,s,r,n,a,h,o,l){t.getVertexPosition(h,lo),t.getVertexPosition(o,uo),t.getVertexPosition(l,co);t=go(t,e,i,s,lo,uo,co,po);return t&&(e=new Gt,so.getBarycoord(po,lo,uo,co,e),r&&(t.uv=so.getInterpolatedAttribute(r,h,o,l,e,new ct)),n&&(t.uv1=so.getInterpolatedAttribute(n,h,o,l,e,new ct)),a&&(t.normal=so.getInterpolatedAttribute(a,h,o,l,e,new Gt),0<t.normal.dot(s.direction))&&t.normal.multiplyScalar(-1),i={a:h,b:o,c:l,normal:new Gt,materialIndex:0},so.getNormal(lo,uo,co,i.normal),t.face=i,t.barycoord=e),t}var wo=`
#ifdef USE_ALPHAHASH

	if ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;

#endif
`,Mo=`
#ifdef USE_ALPHAHASH

	/**
	 * See: https://casual-effects.com/research/Wyman2017Hashed/index.html
	 */

	const float ALPHA_HASH_SCALE = 0.05; // Derived from trials only, and may be changed.

	float hash2D( vec2 value ) {

		return fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );

	}

	float hash3D( vec3 value ) {

		return hash2D( vec2( hash2D( value.xy ), value.z ) );

	}

	float getAlphaHashThreshold( vec3 position ) {

		// Find the discretized derivatives of our coordinates
		float maxDeriv = max(
			length( dFdx( position.xyz ) ),
			length( dFdy( position.xyz ) )
		);
		float pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );

		// Find two nearest log-discretized noise scales
		vec2 pixScales = vec2(
			exp2( floor( log2( pixScale ) ) ),
			exp2( ceil( log2( pixScale ) ) )
		);

		// Compute alpha thresholds at our two noise scales
		vec2 alpha = vec2(
			hash3D( floor( pixScales.x * position.xyz ) ),
			hash3D( floor( pixScales.y * position.xyz ) )
		);

		// Factor to interpolate lerp with
		float lerpFactor = fract( log2( pixScale ) );

		// Interpolate alpha threshold from noise at two scales
		float x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;

		// Pass into CDF to compute uniformly distrib threshold
		float a = min( lerpFactor, 1.0 - lerpFactor );
		vec3 cases = vec3(
			x * x / ( 2.0 * a * ( 1.0 - a ) ),
			( x - 0.5 * a ) / ( 1.0 - a ),
			1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )
		);

		// Find our final, uniformly distributed alpha threshold ()
		float threshold = ( x < ( 1.0 - a ) )
			? ( ( x < a ) ? cases.x : cases.y )
			: cases.z;

		// Avoids  == 0. Could also do  =1-
		return clamp( threshold , 1.0e-6, 1.0 );

	}

#endif
`,yo=`
#ifdef USE_ALPHAMAP

	diffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;

#endif
`,Eo=`
#ifdef USE_ALPHAMAP

	uniform sampler2D alphaMap;

#endif
`,xo=`
#ifdef USE_ALPHATEST

	#ifdef ALPHA_TO_COVERAGE

	diffuseColor.a = smoothstep( alphaTest, alphaTest + fwidth( diffuseColor.a ), diffuseColor.a );
	if ( diffuseColor.a == 0.0 ) discard;

	#else

	if ( diffuseColor.a < alphaTest ) discard;

	#endif

#endif
`,bo=`
#ifdef USE_ALPHATEST
	uniform float alphaTest;
#endif
`,So=`
#ifdef USE_AOMAP

	// reads channel R, compatible with a combined OcclusionRoughnessMetallic (RGB) texture
	float ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;

	reflectedLight.indirectDiffuse *= ambientOcclusion;

	#if defined( USE_CLEARCOAT ) 
		clearcoatSpecularIndirect *= ambientOcclusion;
	#endif

	#if defined( USE_SHEEN ) 
		sheenSpecularIndirect *= ambientOcclusion;
	#endif

	#if defined( USE_ENVMAP ) && defined( STANDARD )

		float dotNV = saturate( dot( geometryNormal, geometryViewDir ) );

		reflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );

	#endif

#endif
`,Ao=`
#ifdef USE_AOMAP

	uniform sampler2D aoMap;
	uniform float aoMapIntensity;

#endif
`,To=`
#ifdef USE_BATCHING
	#if ! defined( GL_ANGLE_multi_draw )
	#define gl_DrawID _gl_DrawID
	uniform int _gl_DrawID;
	#endif

	uniform highp sampler2D batchingTexture;
	uniform highp usampler2D batchingIdTexture;
	mat4 getBatchingMatrix( const in float i ) {

		int size = textureSize( batchingTexture, 0 ).x;
		int j = int( i ) * 4;
		int x = j % size;
		int y = j / size;
		vec4 v1 = texelFetch( batchingTexture, ivec2( x, y ), 0 );
		vec4 v2 = texelFetch( batchingTexture, ivec2( x + 1, y ), 0 );
		vec4 v3 = texelFetch( batchingTexture, ivec2( x + 2, y ), 0 );
		vec4 v4 = texelFetch( batchingTexture, ivec2( x + 3, y ), 0 );
		return mat4( v1, v2, v3, v4 );

	}

	float getIndirectIndex( const in int i ) {

		int size = textureSize( batchingIdTexture, 0 ).x;
		int x = i % size;
		int y = i / size;
		return float( texelFetch( batchingIdTexture, ivec2( x, y ), 0 ).r );

	}

#endif

#ifdef USE_BATCHING_COLOR

	uniform sampler2D batchingColorTexture;
	vec3 getBatchingColor( const in float i ) {

		int size = textureSize( batchingColorTexture, 0 ).x;
		int j = int( i );
		int x = j % size;
		int y = j / size;
		return texelFetch( batchingColorTexture, ivec2( x, y ), 0 ).rgb;

	}

#endif
`,Ro=`
#ifdef USE_BATCHING
	mat4 batchingMatrix = getBatchingMatrix( getIndirectIndex( gl_DrawID ) );
#endif
`,Lo=`
vec3 transformed = vec3( position );

#ifdef USE_ALPHAHASH

	vPosition = vec3( position );

#endif
`,Co=`
vec3 objectNormal = vec3( normal );

#ifdef USE_TANGENT

	vec3 objectTangent = vec3( tangent.xyz );

#endif
`,No=`

float G_BlinnPhong_Implicit( /* const in float dotNL, const in float dotNV */ ) {

	// geometry term is (n dot l)(n dot v) / 4(n dot l)(n dot v)
	return 0.25;

}

float D_BlinnPhong( const in float shininess, const in float dotNH ) {

	return RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );

}

vec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {

	vec3 halfDir = normalize( lightDir + viewDir );

	float dotNH = saturate( dot( normal, halfDir ) );
	float dotVH = saturate( dot( viewDir, halfDir ) );

	vec3 F = F_Schlick( specularColor, 1.0, dotVH );

	float G = G_BlinnPhong_Implicit( /* dotNL, dotNV */ );

	float D = D_BlinnPhong( shininess, dotNH );

	return F * ( G * D );

} // validated

`,Io=`

#ifdef USE_IRIDESCENCE

	// XYZ to linear-sRGB color space
	const mat3 XYZ_TO_REC709 = mat3(
		 3.2404542, -0.9692660,  0.0556434,
		-1.5371385,  1.8760108, -0.2040259,
		-0.4985314,  0.0415560,  1.0572252
	);

	// Assume air interface for top
	// Note: We don't handle the case fresnel0 == 1
	vec3 Fresnel0ToIor( vec3 fresnel0 ) {

		vec3 sqrtF0 = sqrt( fresnel0 );
		return ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );

	}

	// Conversion FO/IOR
	vec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {

		return pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );

	}

	// ior is a value between 1.0 and 3.0. 1.0 is air interface
	float IorToFresnel0( float transmittedIor, float incidentIor ) {

		return pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));

	}

	// Fresnel equations for dielectric/dielectric interfaces.
	// Ref: https://belcour.github.io/blog/research/2017/05/01/brdf-thin-film.html
	// Evaluation XYZ sensitivity curves in Fourier space
	vec3 evalSensitivity( float OPD, vec3 shift ) {

		float phase = 2.0 * PI * OPD * 1.0e-9;
		vec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );
		vec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );
		vec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );

		vec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );
		xyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );
		xyz /= 1.0685e-7;

		vec3 rgb = XYZ_TO_REC709 * xyz;
		return rgb;

	}

	vec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {

		vec3 I;

		// Force iridescenceIOR -> outsideIOR when thinFilmThickness -> 0.0
		float iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );
		// Evaluate the cosTheta on the base layer (Snell law)
		float sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );

		// Handle TIR:
		float cosTheta2Sq = 1.0 - sinTheta2Sq;
		if ( cosTheta2Sq < 0.0 ) {

			return vec3( 1.0 );

		}

		float cosTheta2 = sqrt( cosTheta2Sq );

		// First interface
		float R0 = IorToFresnel0( iridescenceIOR, outsideIOR );
		float R12 = F_Schlick( R0, 1.0, cosTheta1 );
		float T121 = 1.0 - R12;
		float phi12 = 0.0;
		if ( iridescenceIOR < outsideIOR ) phi12 = PI;
		float phi21 = PI - phi12;

		// Second interface
		vec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) ); // guard against 1.0
		vec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );
		vec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );
		vec3 phi23 = vec3( 0.0 );
		if ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;
		if ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;
		if ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;

		// Phase shift
		float OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;
		vec3 phi = vec3( phi21 ) + phi23;

		// Compound terms
		vec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );
		vec3 r123 = sqrt( R123 );
		vec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );

		// Reflectance term for m = 0 (DC term amplitude)
		vec3 C0 = R12 + Rs;
		I = C0;

		// Reflectance term for m > 0 (pairs of diracs)
		vec3 Cm = Rs - T121;
		for ( int m = 1; m <= 2; ++ m ) {

			Cm *= r123;
			vec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );
			I += Cm * Sm;

		}

		// Since out of gamut colors might be produced, negative color values are clamped to 0.
		return max( I, vec3( 0.0 ) );

	}

#endif

`,Po=`
#ifdef USE_BUMPMAP

	uniform sampler2D bumpMap;
	uniform float bumpScale;

	// Bump Mapping Unparametrized Surfaces on the GPU by Morten S. Mikkelsen
	// https://mmikk.github.io/papers3d/mm_sfgrad_bump.pdf

	// Evaluate the derivative of the height w.r.t. screen-space using forward differencing (listing 2)

	vec2 dHdxy_fwd() {

		vec2 dSTdx = dFdx( vBumpMapUv );
		vec2 dSTdy = dFdy( vBumpMapUv );

		float Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;
		float dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;
		float dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;

		return vec2( dBx, dBy );

	}

	vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {

		// normalize is done to ensure that the bump map looks the same regardless of the texture's scale
		vec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );
		vec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );
		vec3 vN = surf_norm; // normalized

		vec3 R1 = cross( vSigmaY, vN );
		vec3 R2 = cross( vN, vSigmaX );

		float fDet = dot( vSigmaX, R1 ) * faceDirection;

		vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );
		return normalize( abs( fDet ) * surf_norm - vGrad );

	}

#endif
`,Do=`
#if NUM_CLIPPING_PLANES > 0

	vec4 plane;

	#ifdef ALPHA_TO_COVERAGE

		float distanceToPlane, distanceGradient;
		float clipOpacity = 1.0;

		#pragma unroll_loop_start
		for ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {

			plane = clippingPlanes[ i ];
			distanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;
			distanceGradient = fwidth( distanceToPlane ) / 2.0;
			clipOpacity *= smoothstep( - distanceGradient, distanceGradient, distanceToPlane );

			if ( clipOpacity == 0.0 ) discard;

		}
		#pragma unroll_loop_end

		#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES

			float unionClipOpacity = 1.0;

			#pragma unroll_loop_start
			for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {

				plane = clippingPlanes[ i ];
				distanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;
				distanceGradient = fwidth( distanceToPlane ) / 2.0;
				unionClipOpacity *= 1.0 - smoothstep( - distanceGradient, distanceGradient, distanceToPlane );

			}
			#pragma unroll_loop_end

			clipOpacity *= 1.0 - unionClipOpacity;

		#endif

		diffuseColor.a *= clipOpacity;

		if ( diffuseColor.a == 0.0 ) discard;

	#else

		#pragma unroll_loop_start
		for ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {

			plane = clippingPlanes[ i ];
			if ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;

		}
		#pragma unroll_loop_end

		#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES

			bool clipped = true;

			#pragma unroll_loop_start
			for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {

				plane = clippingPlanes[ i ];
				clipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;

			}
			#pragma unroll_loop_end

			if ( clipped ) discard;

		#endif

	#endif

#endif
`,Oo=`
#if NUM_CLIPPING_PLANES > 0

	varying vec3 vClipPosition;

	uniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];

#endif
`,Uo=`
#if NUM_CLIPPING_PLANES > 0

	varying vec3 vClipPosition;

#endif
`,Fo=`
#if NUM_CLIPPING_PLANES > 0

	vClipPosition = - mvPosition.xyz;

#endif
`,Bo=`
#if defined( USE_COLOR_ALPHA )

	diffuseColor *= vColor;

#elif defined( USE_COLOR )

	diffuseColor.rgb *= vColor;

#endif
`,ko=`
#if defined( USE_COLOR_ALPHA )

	varying vec4 vColor;

#elif defined( USE_COLOR )

	varying vec3 vColor;

#endif
`,Go=`
#if defined( USE_COLOR_ALPHA )

	varying vec4 vColor;

#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )

	varying vec3 vColor;

#endif
`,Ho=`
#if defined( USE_COLOR_ALPHA )

	vColor = vec4( 1.0 );

#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )

	vColor = vec3( 1.0 );

#endif

#ifdef USE_COLOR

	vColor *= color;

#endif

#ifdef USE_INSTANCING_COLOR

	vColor.xyz *= instanceColor.xyz;

#endif

#ifdef USE_BATCHING_COLOR

	vec3 batchingColor = getBatchingColor( getIndirectIndex( gl_DrawID ) );

	vColor.xyz *= batchingColor.xyz;

#endif
`,Vo=`
#define PI 3.141592653589793
#define PI2 6.283185307179586
#define PI_HALF 1.5707963267948966
#define RECIPROCAL_PI 0.3183098861837907
#define RECIPROCAL_PI2 0.15915494309189535
#define EPSILON 1e-6

#ifndef saturate
// <tonemapping_pars_fragment> may have defined saturate() already
#define saturate( a ) clamp( a, 0.0, 1.0 )
#endif
#define whiteComplement( a ) ( 1.0 - saturate( a ) )

float pow2( const in float x ) { return x*x; }
vec3 pow2( const in vec3 x ) { return x*x; }
float pow3( const in float x ) { return x*x*x; }
float pow4( const in float x ) { float x2 = x*x; return x2*x2; }
float max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }
float average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }

// expects values in the range of [0,1]x[0,1], returns values in the [0,1] range.
// do not collapse into a single function per: http://byteblacksmith.com/improvements-to-the-canonical-one-liner-glsl-rand-for-opengl-es-2-0/
highp float rand( const in vec2 uv ) {

	const highp float a = 12.9898, b = 78.233, c = 43758.5453;
	highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );

	return fract( sin( sn ) * c );

}

#ifdef HIGH_PRECISION
	float precisionSafeLength( vec3 v ) { return length( v ); }
#else
	float precisionSafeLength( vec3 v ) {
		float maxComponent = max3( abs( v ) );
		return length( v / maxComponent ) * maxComponent;
	}
#endif

struct IncidentLight {
	vec3 color;
	vec3 direction;
	bool visible;
};

struct ReflectedLight {
	vec3 directDiffuse;
	vec3 directSpecular;
	vec3 indirectDiffuse;
	vec3 indirectSpecular;
};

#ifdef USE_ALPHAHASH

	varying vec3 vPosition;

#endif

vec3 transformDirection( in vec3 dir, in mat4 matrix ) {

	return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );

}

vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {

	// dir can be either a direction vector or a normal vector
	// upper-left 3x3 of matrix is assumed to be orthogonal

	return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );

}

mat3 transposeMat3( const in mat3 m ) {

	mat3 tmp;

	tmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );
	tmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );
	tmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );

	return tmp;

}

bool isPerspectiveMatrix( mat4 m ) {

	return m[ 2 ][ 3 ] == - 1.0;

}

vec2 equirectUv( in vec3 dir ) {

	// dir is assumed to be unit length

	float u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;

	float v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;

	return vec2( u, v );

}

vec3 BRDF_Lambert( const in vec3 diffuseColor ) {

	return RECIPROCAL_PI * diffuseColor;

} // validated

vec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {

	// Original approximation by Christophe Schlick '94
	// float fresnel = pow( 1.0 - dotVH, 5.0 );

	// Optimized variant (presented by Epic at SIGGRAPH '13)
	// https://cdn2.unrealengine.com/Resources/files/2013SiggraphPresentationsNotes-26915738.pdf
	float fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );

	return f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );

} // validated

float F_Schlick( const in float f0, const in float f90, const in float dotVH ) {

	// Original approximation by Christophe Schlick '94
	// float fresnel = pow( 1.0 - dotVH, 5.0 );

	// Optimized variant (presented by Epic at SIGGRAPH '13)
	// https://cdn2.unrealengine.com/Resources/files/2013SiggraphPresentationsNotes-26915738.pdf
	float fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );

	return f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );

} // validated
`,zo=`
#ifdef ENVMAP_TYPE_CUBE_UV

	#define cubeUV_minMipLevel 4.0
	#define cubeUV_minTileSize 16.0

	// These shader functions convert between the UV coordinates of a single face of
	// a cubemap, the 0-5 integer index of a cube face, and the direction vector for
	// sampling a textureCube (not generally normalized ).

	float getFace( vec3 direction ) {

		vec3 absDirection = abs( direction );

		float face = - 1.0;

		if ( absDirection.x > absDirection.z ) {

			if ( absDirection.x > absDirection.y )

				face = direction.x > 0.0 ? 0.0 : 3.0;

			else

				face = direction.y > 0.0 ? 1.0 : 4.0;

		} else {

			if ( absDirection.z > absDirection.y )

				face = direction.z > 0.0 ? 2.0 : 5.0;

			else

				face = direction.y > 0.0 ? 1.0 : 4.0;

		}

		return face;

	}

	// RH coordinate system; PMREM face-indexing convention
	vec2 getUV( vec3 direction, float face ) {

		vec2 uv;

		if ( face == 0.0 ) {

			uv = vec2( direction.z, direction.y ) / abs( direction.x ); // pos x

		} else if ( face == 1.0 ) {

			uv = vec2( - direction.x, - direction.z ) / abs( direction.y ); // pos y

		} else if ( face == 2.0 ) {

			uv = vec2( - direction.x, direction.y ) / abs( direction.z ); // pos z

		} else if ( face == 3.0 ) {

			uv = vec2( - direction.z, direction.y ) / abs( direction.x ); // neg x

		} else if ( face == 4.0 ) {

			uv = vec2( - direction.x, direction.z ) / abs( direction.y ); // neg y

		} else {

			uv = vec2( direction.x, direction.y ) / abs( direction.z ); // neg z

		}

		return 0.5 * ( uv + 1.0 );

	}

	vec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {

		float face = getFace( direction );

		float filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );

		mipInt = max( mipInt, cubeUV_minMipLevel );

		float faceSize = exp2( mipInt );

		highp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0; // #25071

		if ( face > 2.0 ) {

			uv.y += faceSize;

			face -= 3.0;

		}

		uv.x += face * faceSize;

		uv.x += filterInt * 3.0 * cubeUV_minTileSize;

		uv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );

		uv.x *= CUBEUV_TEXEL_WIDTH;
		uv.y *= CUBEUV_TEXEL_HEIGHT;

		#ifdef texture2DGradEXT

			return texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb; // disable anisotropic filtering

		#else

			return texture2D( envMap, uv ).rgb;

		#endif

	}

	// These defines must match with PMREMGenerator

	#define cubeUV_r0 1.0
	#define cubeUV_m0 - 2.0
	#define cubeUV_r1 0.8
	#define cubeUV_m1 - 1.0
	#define cubeUV_r4 0.4
	#define cubeUV_m4 2.0
	#define cubeUV_r5 0.305
	#define cubeUV_m5 3.0
	#define cubeUV_r6 0.21
	#define cubeUV_m6 4.0

	float roughnessToMip( float roughness ) {

		float mip = 0.0;

		if ( roughness >= cubeUV_r1 ) {

			mip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;

		} else if ( roughness >= cubeUV_r4 ) {

			mip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;

		} else if ( roughness >= cubeUV_r5 ) {

			mip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;

		} else if ( roughness >= cubeUV_r6 ) {

			mip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;

		} else {

			mip = - 2.0 * log2( 1.16 * roughness ); // 1.16 = 1.79^0.25
		}

		return mip;

	}

	vec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {

		float mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );

		float mipF = fract( mip );

		float mipInt = floor( mip );

		vec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );

		if ( mipF == 0.0 ) {

			return vec4( color0, 1.0 );

		} else {

			vec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );

			return vec4( mix( color0, color1, mipF ), 1.0 );

		}

	}

#endif
`,Wo=`

vec3 transformedNormal = objectNormal;
#ifdef USE_TANGENT

	vec3 transformedTangent = objectTangent;

#endif

#ifdef USE_BATCHING

	// this is in lieu of a per-instance normal-matrix
	// shear transforms in the instance matrix are not supported

	mat3 bm = mat3( batchingMatrix );
	transformedNormal /= vec3( dot( bm[ 0 ], bm[ 0 ] ), dot( bm[ 1 ], bm[ 1 ] ), dot( bm[ 2 ], bm[ 2 ] ) );
	transformedNormal = bm * transformedNormal;

	#ifdef USE_TANGENT

		transformedTangent = bm * transformedTangent;

	#endif

#endif

#ifdef USE_INSTANCING

	// this is in lieu of a per-instance normal-matrix
	// shear transforms in the instance matrix are not supported

	mat3 im = mat3( instanceMatrix );
	transformedNormal /= vec3( dot( im[ 0 ], im[ 0 ] ), dot( im[ 1 ], im[ 1 ] ), dot( im[ 2 ], im[ 2 ] ) );
	transformedNormal = im * transformedNormal;

	#ifdef USE_TANGENT

		transformedTangent = im * transformedTangent;

	#endif

#endif

transformedNormal = normalMatrix * transformedNormal;

#ifdef FLIP_SIDED

	transformedNormal = - transformedNormal;

#endif

#ifdef USE_TANGENT

	transformedTangent = ( modelViewMatrix * vec4( transformedTangent, 0.0 ) ).xyz;

	#ifdef FLIP_SIDED

		transformedTangent = - transformedTangent;

	#endif

#endif
`,jo=`
#ifdef USE_DISPLACEMENTMAP

	uniform sampler2D displacementMap;
	uniform float displacementScale;
	uniform float displacementBias;

#endif
`,Xo=`
#ifdef USE_DISPLACEMENTMAP

	transformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );

#endif
`,Yo=`
#ifdef USE_EMISSIVEMAP

	vec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );

	totalEmissiveRadiance *= emissiveColor.rgb;

#endif
`,Zo=`
#ifdef USE_EMISSIVEMAP

	uniform sampler2D emissiveMap;

#endif
`,qo=`
gl_FragColor = linearToOutputTexel( gl_FragColor );
`,Ko=`

// http://www.russellcottrell.com/photo/matrixCalculator.htm

// Linear sRGB => XYZ => Linear Display P3
const mat3 LINEAR_SRGB_TO_LINEAR_DISPLAY_P3 = mat3(
	vec3( 0.8224621, 0.177538, 0.0 ),
	vec3( 0.0331941, 0.9668058, 0.0 ),
	vec3( 0.0170827, 0.0723974, 0.9105199 )
);

// Linear Display P3 => XYZ => Linear sRGB
const mat3 LINEAR_DISPLAY_P3_TO_LINEAR_SRGB = mat3(
	vec3( 1.2249401, - 0.2249404, 0.0 ),
	vec3( - 0.0420569, 1.0420571, 0.0 ),
	vec3( - 0.0196376, - 0.0786361, 1.0982735 )
);

vec4 LinearSRGBToLinearDisplayP3( in vec4 value ) {
	return vec4( value.rgb * LINEAR_SRGB_TO_LINEAR_DISPLAY_P3, value.a );
}

vec4 LinearDisplayP3ToLinearSRGB( in vec4 value ) {
	return vec4( value.rgb * LINEAR_DISPLAY_P3_TO_LINEAR_SRGB, value.a );
}

vec4 LinearTransferOETF( in vec4 value ) {
	return value;
}

vec4 sRGBTransferOETF( in vec4 value ) {
	return vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );
}

`,Jo=`
#ifdef USE_ENVMAP

	#ifdef ENV_WORLDPOS

		vec3 cameraToFrag;

		if ( isOrthographic ) {

			cameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );

		} else {

			cameraToFrag = normalize( vWorldPosition - cameraPosition );

		}

		// Transforming Normal Vectors with the Inverse Transformation
		vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );

		#ifdef ENVMAP_MODE_REFLECTION

			vec3 reflectVec = reflect( cameraToFrag, worldNormal );

		#else

			vec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );

		#endif

	#else

		vec3 reflectVec = vReflect;

	#endif

	#ifdef ENVMAP_TYPE_CUBE

		vec4 envColor = textureCube( envMap, envMapRotation * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );

	#else

		vec4 envColor = vec4( 0.0 );

	#endif

	#ifdef ENVMAP_BLENDING_MULTIPLY

		outgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );

	#elif defined( ENVMAP_BLENDING_MIX )

		outgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );

	#elif defined( ENVMAP_BLENDING_ADD )

		outgoingLight += envColor.xyz * specularStrength * reflectivity;

	#endif

#endif
`,$o=`
#ifdef USE_ENVMAP

	uniform float envMapIntensity;
	uniform float flipEnvMap;
	uniform mat3 envMapRotation;

	#ifdef ENVMAP_TYPE_CUBE
		uniform samplerCube envMap;
	#else
		uniform sampler2D envMap;
	#endif
	
#endif
`,Qo=`
#ifdef USE_ENVMAP

	uniform float reflectivity;

	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )

		#define ENV_WORLDPOS

	#endif

	#ifdef ENV_WORLDPOS

		varying vec3 vWorldPosition;
		uniform float refractionRatio;
	#else
		varying vec3 vReflect;
	#endif

#endif
`,tl=`
#ifdef USE_ENVMAP

	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )

		#define ENV_WORLDPOS

	#endif

	#ifdef ENV_WORLDPOS
		
		varying vec3 vWorldPosition;

	#else

		varying vec3 vReflect;
		uniform float refractionRatio;

	#endif

#endif
`,el=`
#ifdef USE_ENVMAP

	#ifdef ENV_WORLDPOS

		vWorldPosition = worldPosition.xyz;

	#else

		vec3 cameraToVertex;

		if ( isOrthographic ) {

			cameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );

		} else {

			cameraToVertex = normalize( worldPosition.xyz - cameraPosition );

		}

		vec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );

		#ifdef ENVMAP_MODE_REFLECTION

			vReflect = reflect( cameraToVertex, worldNormal );

		#else

			vReflect = refract( cameraToVertex, worldNormal, refractionRatio );

		#endif

	#endif

#endif
`,il=`
#ifdef USE_FOG

	vFogDepth = - mvPosition.z;

#endif
`,sl=`
#ifdef USE_FOG

	varying float vFogDepth;

#endif
`,rl=`
#ifdef USE_FOG

	#ifdef FOG_EXP2

		float fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );

	#else

		float fogFactor = smoothstep( fogNear, fogFar, vFogDepth );

	#endif

	gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );

#endif
`,nl=`
#ifdef USE_FOG

	uniform vec3 fogColor;
	varying float vFogDepth;

	#ifdef FOG_EXP2

		uniform float fogDensity;

	#else

		uniform float fogNear;
		uniform float fogFar;

	#endif

#endif
`,al=`

#ifdef USE_GRADIENTMAP

	uniform sampler2D gradientMap;

#endif

vec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {

	// dotNL will be from -1.0 to 1.0
	float dotNL = dot( normal, lightDirection );
	vec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );

	#ifdef USE_GRADIENTMAP

		return vec3( texture2D( gradientMap, coord ).r );

	#else

		vec2 fw = fwidth( coord ) * 0.5;
		return mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );

	#endif

}
`,hl=`
#ifdef USE_LIGHTMAP

	uniform sampler2D lightMap;
	uniform float lightMapIntensity;

#endif
`,ol=`
LambertMaterial material;
material.diffuseColor = diffuseColor.rgb;
material.specularStrength = specularStrength;
`,ll=`
varying vec3 vViewPosition;

struct LambertMaterial {

	vec3 diffuseColor;
	float specularStrength;

};

void RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {

	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );
	vec3 irradiance = vec3(dotNL) * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );

}

void RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {

	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );

}

#define RE_Direct				RE_Direct_Lambert
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Lambert
`,ul=`
uniform bool receiveShadow;
uniform vec3 ambientLightColor;

#if defined( USE_LIGHT_PROBES )

	uniform vec3 lightProbe[ 9 ];

#endif

// get the irradiance (radiance convolved with cosine lobe) at the point 'normal' on the unit sphere
// source: https://graphics.stanford.edu/papers/envmap/envmap.pdf
vec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {

	// normal is assumed to have unit length

	float x = normal.x, y = normal.y, z = normal.z;

	// band 0
	vec3 result = shCoefficients[ 0 ] * 0.886227;

	// band 1
	result += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;
	result += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;
	result += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;

	// band 2
	result += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;
	result += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;
	result += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );
	result += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;
	result += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );

	return result;

}

vec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {

	vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );

	vec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );

	return irradiance;

}

vec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {

	vec3 irradiance = ambientLightColor;

	return irradiance;

}

float getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {

	// based upon Frostbite 3 Moving to Physically-based Rendering
	// page 32, equation 26: E[window1]
	// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf
	float distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );

	if ( cutoffDistance > 0.0 ) {

		distanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );

	}

	return distanceFalloff;

}

float getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {

	return smoothstep( coneCosine, penumbraCosine, angleCosine );

}

#if NUM_DIR_LIGHTS > 0

	struct DirectionalLight {
		vec3 direction;
		vec3 color;
	};

	uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];

	void getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {

		light.color = directionalLight.color;
		light.direction = directionalLight.direction;
		light.visible = true;

	}

#endif


#if NUM_POINT_LIGHTS > 0

	struct PointLight {
		vec3 position;
		vec3 color;
		float distance;
		float decay;
	};

	uniform PointLight pointLights[ NUM_POINT_LIGHTS ];

	// light is an out parameter as having it as a return value caused compiler errors on some devices
	void getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {

		vec3 lVector = pointLight.position - geometryPosition;

		light.direction = normalize( lVector );

		float lightDistance = length( lVector );

		light.color = pointLight.color;
		light.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );
		light.visible = ( light.color != vec3( 0.0 ) );

	}

#endif


#if NUM_SPOT_LIGHTS > 0

	struct SpotLight {
		vec3 position;
		vec3 direction;
		vec3 color;
		float distance;
		float decay;
		float coneCos;
		float penumbraCos;
	};

	uniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];

	// light is an out parameter as having it as a return value caused compiler errors on some devices
	void getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {

		vec3 lVector = spotLight.position - geometryPosition;

		light.direction = normalize( lVector );

		float angleCos = dot( light.direction, spotLight.direction );

		float spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );

		if ( spotAttenuation > 0.0 ) {

			float lightDistance = length( lVector );

			light.color = spotLight.color * spotAttenuation;
			light.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );
			light.visible = ( light.color != vec3( 0.0 ) );

		} else {

			light.color = vec3( 0.0 );
			light.visible = false;

		}

	}

#endif


#if NUM_RECT_AREA_LIGHTS > 0

	struct RectAreaLight {
		vec3 color;
		vec3 position;
		vec3 halfWidth;
		vec3 halfHeight;
	};

	// Pre-computed values of LinearTransformedCosine approximation of BRDF
	// BRDF approximation Texture is 64x64
	uniform sampler2D ltc_1; // RGBA Float
	uniform sampler2D ltc_2; // RGBA Float

	uniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];

#endif


#if NUM_HEMI_LIGHTS > 0

	struct HemisphereLight {
		vec3 direction;
		vec3 skyColor;
		vec3 groundColor;
	};

	uniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];

	vec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {

		float dotNL = dot( normal, hemiLight.direction );
		float hemiDiffuseWeight = 0.5 * dotNL + 0.5;

		vec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );

		return irradiance;

	}

#endif
`,cl=`
#ifdef USE_ENVMAP

	vec3 getIBLIrradiance( const in vec3 normal ) {

		#ifdef ENVMAP_TYPE_CUBE_UV

			vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );

			vec4 envMapColor = textureCubeUV( envMap, envMapRotation * worldNormal, 1.0 );

			return PI * envMapColor.rgb * envMapIntensity;

		#else

			return vec3( 0.0 );

		#endif

	}

	vec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {

		#ifdef ENVMAP_TYPE_CUBE_UV

			vec3 reflectVec = reflect( - viewDir, normal );

			// Mixing the reflection with the normal is more accurate and keeps rough objects from gathering light from behind their tangent plane.
			reflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );

			reflectVec = inverseTransformDirection( reflectVec, viewMatrix );

			vec4 envMapColor = textureCubeUV( envMap, envMapRotation * reflectVec, roughness );

			return envMapColor.rgb * envMapIntensity;

		#else

			return vec3( 0.0 );

		#endif

	}

	#ifdef USE_ANISOTROPY

		vec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {

			#ifdef ENVMAP_TYPE_CUBE_UV

			  // https://google.github.io/filament/Filament.md.html#lighting/imagebasedlights/anisotropy
				vec3 bentNormal = cross( bitangent, viewDir );
				bentNormal = normalize( cross( bentNormal, bitangent ) );
				bentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );

				return getIBLRadiance( viewDir, bentNormal, roughness );

			#else

				return vec3( 0.0 );

			#endif

		}

	#endif

#endif
`,fl=`
ToonMaterial material;
material.diffuseColor = diffuseColor.rgb;
`,dl=`
varying vec3 vViewPosition;

struct ToonMaterial {

	vec3 diffuseColor;

};

void RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {

	vec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;

	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );

}

void RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {

	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );

}

#define RE_Direct				RE_Direct_Toon
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Toon
`,vl=`
BlinnPhongMaterial material;
material.diffuseColor = diffuseColor.rgb;
material.specularColor = specular;
material.specularShininess = shininess;
material.specularStrength = specularStrength;
`,pl=`
varying vec3 vViewPosition;

struct BlinnPhongMaterial {

	vec3 diffuseColor;
	vec3 specularColor;
	float specularShininess;
	float specularStrength;

};

void RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {

	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;

	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );

	reflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;

}

void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {

	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );

}

#define RE_Direct				RE_Direct_BlinnPhong
#define RE_IndirectDiffuse		RE_IndirectDiffuse_BlinnPhong
`,ml=`
PhysicalMaterial material;
material.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );

vec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );
float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );

material.roughness = max( roughnessFactor, 0.0525 );// 0.0525 corresponds to the base mip of a 256 cubemap.
material.roughness += geometryRoughness;
material.roughness = min( material.roughness, 1.0 );

#ifdef IOR

	material.ior = ior;

	#ifdef USE_SPECULAR

		float specularIntensityFactor = specularIntensity;
		vec3 specularColorFactor = specularColor;

		#ifdef USE_SPECULAR_COLORMAP

			specularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;

		#endif

		#ifdef USE_SPECULAR_INTENSITYMAP

			specularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;

		#endif

		material.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );

	#else

		float specularIntensityFactor = 1.0;
		vec3 specularColorFactor = vec3( 1.0 );
		material.specularF90 = 1.0;

	#endif

	material.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );

#else

	material.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );
	material.specularF90 = 1.0;

#endif

#ifdef USE_CLEARCOAT

	material.clearcoat = clearcoat;
	material.clearcoatRoughness = clearcoatRoughness;
	material.clearcoatF0 = vec3( 0.04 );
	material.clearcoatF90 = 1.0;

	#ifdef USE_CLEARCOATMAP

		material.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;

	#endif

	#ifdef USE_CLEARCOAT_ROUGHNESSMAP

		material.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;

	#endif

	material.clearcoat = saturate( material.clearcoat ); // Burley clearcoat model
	material.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );
	material.clearcoatRoughness += geometryRoughness;
	material.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );

#endif

#ifdef USE_DISPERSION

	material.dispersion = dispersion;

#endif

#ifdef USE_IRIDESCENCE

	material.iridescence = iridescence;
	material.iridescenceIOR = iridescenceIOR;

	#ifdef USE_IRIDESCENCEMAP

		material.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;

	#endif

	#ifdef USE_IRIDESCENCE_THICKNESSMAP

		material.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;

	#else

		material.iridescenceThickness = iridescenceThicknessMaximum;

	#endif

#endif

#ifdef USE_SHEEN

	material.sheenColor = sheenColor;

	#ifdef USE_SHEEN_COLORMAP

		material.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;

	#endif

	material.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );

	#ifdef USE_SHEEN_ROUGHNESSMAP

		material.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;

	#endif

#endif

#ifdef USE_ANISOTROPY

	#ifdef USE_ANISOTROPYMAP

		mat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );
		vec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;
		vec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;

	#else

		vec2 anisotropyV = anisotropyVector;

	#endif

	material.anisotropy = length( anisotropyV );

	if( material.anisotropy == 0.0 ) {
		anisotropyV = vec2( 1.0, 0.0 );
	} else {
		anisotropyV /= material.anisotropy;
		material.anisotropy = saturate( material.anisotropy );
	}

	// Roughness along the anisotropy bitangent is the material roughness, while the tangent roughness increases with anisotropy.
	material.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );

	material.anisotropyT = tbn[ 0 ] * anisotropyV.x + tbn[ 1 ] * anisotropyV.y;
	material.anisotropyB = tbn[ 1 ] * anisotropyV.x - tbn[ 0 ] * anisotropyV.y;

#endif
`,gl=`

struct PhysicalMaterial {

	vec3 diffuseColor;
	float roughness;
	vec3 specularColor;
	float specularF90;
	float dispersion;

	#ifdef USE_CLEARCOAT
		float clearcoat;
		float clearcoatRoughness;
		vec3 clearcoatF0;
		float clearcoatF90;
	#endif

	#ifdef USE_IRIDESCENCE
		float iridescence;
		float iridescenceIOR;
		float iridescenceThickness;
		vec3 iridescenceFresnel;
		vec3 iridescenceF0;
	#endif

	#ifdef USE_SHEEN
		vec3 sheenColor;
		float sheenRoughness;
	#endif

	#ifdef IOR
		float ior;
	#endif

	#ifdef USE_TRANSMISSION
		float transmission;
		float transmissionAlpha;
		float thickness;
		float attenuationDistance;
		vec3 attenuationColor;
	#endif

	#ifdef USE_ANISOTROPY
		float anisotropy;
		float alphaT;
		vec3 anisotropyT;
		vec3 anisotropyB;
	#endif

};

// temporary
vec3 clearcoatSpecularDirect = vec3( 0.0 );
vec3 clearcoatSpecularIndirect = vec3( 0.0 );
vec3 sheenSpecularDirect = vec3( 0.0 );
vec3 sheenSpecularIndirect = vec3(0.0 );

vec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {
    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );
    float x2 = x * x;
    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );

    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );
}

// Moving Frostbite to Physically Based Rendering 3.0 - page 12, listing 2
// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf
float V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {

	float a2 = pow2( alpha );

	float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );
	float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );

	return 0.5 / max( gv + gl, EPSILON );

}

// Microfacet Models for Refraction through Rough Surfaces - equation (33)
// http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html
// alpha is "roughness squared" in Disneys reparameterization
float D_GGX( const in float alpha, const in float dotNH ) {

	float a2 = pow2( alpha );

	float denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0; // avoid alpha = 0 with dotNH = 1

	return RECIPROCAL_PI * a2 / pow2( denom );

}

// https://google.github.io/filament/Filament.md.html#materialsystem/anisotropicmodel/anisotropicspecularbrdf
#ifdef USE_ANISOTROPY

	float V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {

		float gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );
		float gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );
		float v = 0.5 / ( gv + gl );

		return saturate(v);

	}

	float D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {

		float a2 = alphaT * alphaB;
		highp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );
		highp float v2 = dot( v, v );
		float w2 = a2 / v2;

		return RECIPROCAL_PI * a2 * pow2 ( w2 );

	}

#endif

#ifdef USE_CLEARCOAT

	// GGX Distribution, Schlick Fresnel, GGX_SmithCorrelated Visibility
	vec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {

		vec3 f0 = material.clearcoatF0;
		float f90 = material.clearcoatF90;
		float roughness = material.clearcoatRoughness;

		float alpha = pow2( roughness ); // UE4's roughness

		vec3 halfDir = normalize( lightDir + viewDir );

		float dotNL = saturate( dot( normal, lightDir ) );
		float dotNV = saturate( dot( normal, viewDir ) );
		float dotNH = saturate( dot( normal, halfDir ) );
		float dotVH = saturate( dot( viewDir, halfDir ) );

		vec3 F = F_Schlick( f0, f90, dotVH );

		float V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );

		float D = D_GGX( alpha, dotNH );

		return F * ( V * D );

	}

#endif

vec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {

	vec3 f0 = material.specularColor;
	float f90 = material.specularF90;
	float roughness = material.roughness;

	float alpha = pow2( roughness ); // UE4's roughness

	vec3 halfDir = normalize( lightDir + viewDir );

	float dotNL = saturate( dot( normal, lightDir ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );
	float dotVH = saturate( dot( viewDir, halfDir ) );

	vec3 F = F_Schlick( f0, f90, dotVH );

	#ifdef USE_IRIDESCENCE

		F = mix( F, material.iridescenceFresnel, material.iridescence );

	#endif

	#ifdef USE_ANISOTROPY

		float dotTL = dot( material.anisotropyT, lightDir );
		float dotTV = dot( material.anisotropyT, viewDir );
		float dotTH = dot( material.anisotropyT, halfDir );
		float dotBL = dot( material.anisotropyB, lightDir );
		float dotBV = dot( material.anisotropyB, viewDir );
		float dotBH = dot( material.anisotropyB, halfDir );

		float V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );

		float D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );

	#else

		float V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );

		float D = D_GGX( alpha, dotNH );

	#endif

	return F * ( V * D );

}

// Rect Area Light

// Real-Time Polygonal-Light Shading with Linearly Transformed Cosines
// by Eric Heitz, Jonathan Dupuy, Stephen Hill and David Neubelt
// code: https://github.com/selfshadow/ltc_code/

vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {

	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;

	float dotNV = saturate( dot( N, V ) );

	// texture parameterized by sqrt( GGX alpha ) and sqrt( 1 - cos( theta ) )
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );

	uv = uv * LUT_SCALE + LUT_BIAS;

	return uv;

}

float LTC_ClippedSphereFormFactor( const in vec3 f ) {

	// Real-Time Area Lighting: a Journey from Research to Production (p.102)
	// An approximation of the form factor of a horizon-clipped rectangle.

	float l = length( f );

	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );

}

vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {

	float x = dot( v1, v2 );

	float y = abs( x );

	// rational polynomial approximation to theta / sin( theta ) / 2PI
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;

	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;

	return cross( v1, v2 ) * theta_sintheta;

}

vec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {

	// bail if point is on back side of plane of light
	// assumes ccw winding order of light vertices
	vec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];
	vec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];
	vec3 lightNormal = cross( v1, v2 );

	if( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );

	// construct orthonormal basis around N
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 = - cross( N, T1 ); // negated from paper; possibly due to a different handedness of world coordinate system

	// compute transform
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );

	// transform rect
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords[ 0 ] - P );
	coords[ 1 ] = mat * ( rectCoords[ 1 ] - P );
	coords[ 2 ] = mat * ( rectCoords[ 2 ] - P );
	coords[ 3 ] = mat * ( rectCoords[ 3 ] - P );

	// project rect onto sphere
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );

	// calculate vector form factor
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );

	// adjust for horizon clipping
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );

/*
	// alternate method of adjusting for horizon clipping (see referece)
	// refactoring required
	float len = length( vectorFormFactor );
	float z = vectorFormFactor.z / len;

	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;

	// tabulated horizon-clipped sphere, apparently...
	vec2 uv = vec2( z * 0.5 + 0.5, len );
	uv = uv * LUT_SCALE + LUT_BIAS;

	float scale = texture2D( ltc_2, uv ).w;

	float result = len * scale;
*/

	return vec3( result );

}

// End Rect Area Light

#if defined( USE_SHEEN )

// https://github.com/google/filament/blob/master/shaders/src/brdf.fs
float D_Charlie( float roughness, float dotNH ) {

	float alpha = pow2( roughness );

	// Estevez and Kulla 2017, "Production Friendly Microfacet Sheen BRDF"
	float invAlpha = 1.0 / alpha;
	float cos2h = dotNH * dotNH;
	float sin2h = max( 1.0 - cos2h, 0.0078125 ); // 2^(-14/2), so sin2h^2 > 0 in fp16

	return ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );

}

// https://github.com/google/filament/blob/master/shaders/src/brdf.fs
float V_Neubelt( float dotNV, float dotNL ) {

	// Neubelt and Pettineo 2013, "Crafting a Next-gen Material Pipeline for The Order: 1886"
	return saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );

}

vec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {

	vec3 halfDir = normalize( lightDir + viewDir );

	float dotNL = saturate( dot( normal, lightDir ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );

	float D = D_Charlie( sheenRoughness, dotNH );
	float V = V_Neubelt( dotNV, dotNL );

	return sheenColor * ( D * V );

}

#endif

// This is a curve-fit approxmation to the "Charlie sheen" BRDF integrated over the hemisphere from 
// Estevez and Kulla 2017, "Production Friendly Microfacet Sheen BRDF". The analysis can be found
// in the Sheen section of https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing
float IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {

	float dotNV = saturate( dot( normal, viewDir ) );

	float r2 = roughness * roughness;

	float a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;

	float b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;

	float DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );

	return saturate( DG * RECIPROCAL_PI );

}

// Analytical approximation of the DFG LUT, one half of the
// split-sum approximation used in indirect specular lighting.
// via 'environmentBRDF' from "Physically Based Shading on Mobile"
// https://www.unrealengine.com/blog/physically-based-shading-on-mobile
vec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {

	float dotNV = saturate( dot( normal, viewDir ) );

	const vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );

	const vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );

	vec4 r = roughness * c0 + c1;

	float a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;

	vec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;

	return fab;

}

vec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {

	vec2 fab = DFGApprox( normal, viewDir, roughness );

	return specularColor * fab.x + specularF90 * fab.y;

}

// Fdez-Agera's "Multiple-Scattering Microfacet Model for Real-Time Image Based Lighting"
// Approximates multiscattering in order to preserve energy.
// http://www.jcgt.org/published/0008/01/03/
#ifdef USE_IRIDESCENCE
void computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
#else
void computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
#endif

	vec2 fab = DFGApprox( normal, viewDir, roughness );

	#ifdef USE_IRIDESCENCE

		vec3 Fr = mix( specularColor, iridescenceF0, iridescence );

	#else

		vec3 Fr = specularColor;

	#endif

	vec3 FssEss = Fr * fab.x + specularF90 * fab.y;

	float Ess = fab.x + fab.y;
	float Ems = 1.0 - Ess;

	vec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619; // 1/21
	vec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );

	singleScatter += FssEss;
	multiScatter += Fms * Ems;

}

#if NUM_RECT_AREA_LIGHTS > 0

	void RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {

		vec3 normal = geometryNormal;
		vec3 viewDir = geometryViewDir;
		vec3 position = geometryPosition;
		vec3 lightPos = rectAreaLight.position;
		vec3 halfWidth = rectAreaLight.halfWidth;
		vec3 halfHeight = rectAreaLight.halfHeight;
		vec3 lightColor = rectAreaLight.color;
		float roughness = material.roughness;

		vec3 rectCoords[ 4 ];
		rectCoords[ 0 ] = lightPos + halfWidth - halfHeight; // counterclockwise; light shines in local neg z direction
		rectCoords[ 1 ] = lightPos - halfWidth - halfHeight;
		rectCoords[ 2 ] = lightPos - halfWidth + halfHeight;
		rectCoords[ 3 ] = lightPos + halfWidth + halfHeight;

		vec2 uv = LTC_Uv( normal, viewDir, roughness );

		vec4 t1 = texture2D( ltc_1, uv );
		vec4 t2 = texture2D( ltc_2, uv );

		mat3 mInv = mat3(
			vec3( t1.x, 0, t1.y ),
			vec3(    0, 1,    0 ),
			vec3( t1.z, 0, t1.w )
		);

		// LTC Fresnel Approximation by Stephen Hill
		// http://blog.selfshadow.com/publications/s2016-advances/s2016_ltc_fresnel.pdf
		vec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );

		reflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );

		reflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );

	}

#endif

void RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {

	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );

	vec3 irradiance = dotNL * directLight.color;

	#ifdef USE_CLEARCOAT

		float dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );

		vec3 ccIrradiance = dotNLcc * directLight.color;

		clearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );

	#endif

	#ifdef USE_SHEEN

		sheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );

	#endif

	reflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );

	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}

void RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {

	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );

}

void RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {

	#ifdef USE_CLEARCOAT

		clearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );

	#endif

	#ifdef USE_SHEEN

		sheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );

	#endif

	// Both indirect specular and indirect diffuse light accumulate here

	vec3 singleScattering = vec3( 0.0 );
	vec3 multiScattering = vec3( 0.0 );
	vec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;

	#ifdef USE_IRIDESCENCE

		computeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );

	#else

		computeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );

	#endif

	vec3 totalScattering = singleScattering + multiScattering;
	vec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );

	reflectedLight.indirectSpecular += radiance * singleScattering;
	reflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;

	reflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;

}

#define RE_Direct				RE_Direct_Physical
#define RE_Direct_RectArea		RE_Direct_RectArea_Physical
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Physical
#define RE_IndirectSpecular		RE_IndirectSpecular_Physical

// ref: https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf
float computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {

	return saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );

}
`,_l=`
/**
 * This is a template that can be used to light a material, it uses pluggable
 * RenderEquations (RE)for specific lighting scenarios.
 *
 * Instructions for use:
 * - Ensure that both RE_Direct, RE_IndirectDiffuse and RE_IndirectSpecular are defined
 * - Create a material parameter that is to be passed as the third parameter to your lighting functions.
 *
 * TODO:
 * - Add area light support.
 * - Add sphere light support.
 * - Add diffuse light probe (irradiance cubemap) support.
 */

vec3 geometryPosition = - vViewPosition;
vec3 geometryNormal = normal;
vec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );

vec3 geometryClearcoatNormal = vec3( 0.0 );

#ifdef USE_CLEARCOAT

	geometryClearcoatNormal = clearcoatNormal;

#endif

#ifdef USE_IRIDESCENCE

	float dotNVi = saturate( dot( normal, geometryViewDir ) );

	if ( material.iridescenceThickness == 0.0 ) {

		material.iridescence = 0.0;

	} else {

		material.iridescence = saturate( material.iridescence );

	}

	if ( material.iridescence > 0.0 ) {

		material.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );

		// Iridescence F0 approximation
		material.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );

	}

#endif

IncidentLight directLight;

#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )

	PointLight pointLight;
	#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLightShadow;
	#endif

	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {

		pointLight = pointLights[ i ];

		getPointLightInfo( pointLight, geometryPosition, directLight );

		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )
		pointLightShadow = pointLightShadows[ i ];
		directLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowIntensity, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;
		#endif

		RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );

	}
	#pragma unroll_loop_end

#endif

#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )

	SpotLight spotLight;
	vec4 spotColor;
	vec3 spotLightCoord;
	bool inSpotLightMap;

	#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLightShadow;
	#endif

	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {

		spotLight = spotLights[ i ];

		getSpotLightInfo( spotLight, geometryPosition, directLight );

		// spot lights are ordered [shadows with maps, shadows without maps, maps without shadows, none]
		#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )
		#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX
		#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
		#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS
		#else
		#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )
		#endif

		#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )
			spotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;
			inSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );
			spotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );
			directLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;
		#endif

		#undef SPOT_LIGHT_MAP_INDEX

		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
		spotLightShadow = spotLightShadows[ i ];
		directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowIntensity, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;
		#endif

		RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );

	}
	#pragma unroll_loop_end

#endif

#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )

	DirectionalLight directionalLight;
	#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLightShadow;
	#endif

	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {

		directionalLight = directionalLights[ i ];

		getDirectionalLightInfo( directionalLight, directLight );

		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )
		directionalLightShadow = directionalLightShadows[ i ];
		directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowIntensity, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
		#endif

		RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );

	}
	#pragma unroll_loop_end

#endif

#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )

	RectAreaLight rectAreaLight;

	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {

		rectAreaLight = rectAreaLights[ i ];
		RE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );

	}
	#pragma unroll_loop_end

#endif

#if defined( RE_IndirectDiffuse )

	vec3 iblIrradiance = vec3( 0.0 );

	vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );

	#if defined( USE_LIGHT_PROBES )

		irradiance += getLightProbeIrradiance( lightProbe, geometryNormal );

	#endif

	#if ( NUM_HEMI_LIGHTS > 0 )

		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {

			irradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );

		}
		#pragma unroll_loop_end

	#endif

#endif

#if defined( RE_IndirectSpecular )

	vec3 radiance = vec3( 0.0 );
	vec3 clearcoatRadiance = vec3( 0.0 );

#endif
`,wl=`
#if defined( RE_IndirectDiffuse )

	#ifdef USE_LIGHTMAP

		vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );
		vec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;

		irradiance += lightMapIrradiance;

	#endif

	#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )

		iblIrradiance += getIBLIrradiance( geometryNormal );

	#endif

#endif

#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )

	#ifdef USE_ANISOTROPY

		radiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );

	#else

		radiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );

	#endif

	#ifdef USE_CLEARCOAT

		clearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );

	#endif

#endif
`,Ml=`
#if defined( RE_IndirectDiffuse )

	RE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );

#endif

#if defined( RE_IndirectSpecular )

	RE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );

#endif
`,yl=`
#if defined( USE_LOGDEPTHBUF )

	// Doing a strict comparison with == 1.0 can cause noise artifacts
	// on some platforms. See issue #17623.
	gl_FragDepth = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;

#endif
`,El=`
#if defined( USE_LOGDEPTHBUF )

	uniform float logDepthBufFC;
	varying float vFragDepth;
	varying float vIsPerspective;

#endif
`,xl=`
#ifdef USE_LOGDEPTHBUF

	varying float vFragDepth;
	varying float vIsPerspective;

#endif
`,bl=`
#ifdef USE_LOGDEPTHBUF

	vFragDepth = 1.0 + gl_Position.w;
	vIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );

#endif
`,Sl=`
#ifdef USE_MAP

	vec4 sampledDiffuseColor = texture2D( map, vMapUv );

	#ifdef DECODE_VIDEO_TEXTURE

		// use inline sRGB decode until browsers properly support SRGB8_ALPHA8 with video textures (#26516)

		sampledDiffuseColor = vec4( mix( pow( sampledDiffuseColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), sampledDiffuseColor.rgb * 0.0773993808, vec3( lessThanEqual( sampledDiffuseColor.rgb, vec3( 0.04045 ) ) ) ), sampledDiffuseColor.w );

	#endif

	diffuseColor *= sampledDiffuseColor;

#endif
`,Al=`
#ifdef USE_MAP

	uniform sampler2D map;

#endif
`,Tl=`
#if defined( USE_MAP ) || defined( USE_ALPHAMAP )

	#if defined( USE_POINTS_UV )

		vec2 uv = vUv;

	#else

		vec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;

	#endif

#endif

#ifdef USE_MAP

	diffuseColor *= texture2D( map, uv );

#endif

#ifdef USE_ALPHAMAP

	diffuseColor.a *= texture2D( alphaMap, uv ).g;

#endif
`,Rl=`
#if defined( USE_POINTS_UV )

	varying vec2 vUv;

#else

	#if defined( USE_MAP ) || defined( USE_ALPHAMAP )

		uniform mat3 uvTransform;

	#endif

#endif

#ifdef USE_MAP

	uniform sampler2D map;

#endif

#ifdef USE_ALPHAMAP

	uniform sampler2D alphaMap;

#endif
`,Ll=`
float metalnessFactor = metalness;

#ifdef USE_METALNESSMAP

	vec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );

	// reads channel B, compatible with a combined OcclusionRoughnessMetallic (RGB) texture
	metalnessFactor *= texelMetalness.b;

#endif
`,Cl=`
#ifdef USE_METALNESSMAP

	uniform sampler2D metalnessMap;

#endif
`,Nl=`
#ifdef USE_INSTANCING_MORPH

	float morphTargetInfluences[ MORPHTARGETS_COUNT ];

	float morphTargetBaseInfluence = texelFetch( morphTexture, ivec2( 0, gl_InstanceID ), 0 ).r;

	for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {

		morphTargetInfluences[i] =  texelFetch( morphTexture, ivec2( i + 1, gl_InstanceID ), 0 ).r;

	}
#endif
`,Il=`
#if defined( USE_MORPHCOLORS )

	// morphTargetBaseInfluence is set based on BufferGeometry.morphTargetsRelative value:
	// When morphTargetsRelative is false, this is set to 1 - sum(influences); this results in normal = sum((target - base) * influence)
	// When morphTargetsRelative is true, this is set to 1; as a result, all morph targets are simply added to the base after weighting
	vColor *= morphTargetBaseInfluence;

	for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {

		#if defined( USE_COLOR_ALPHA )

			if ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];

		#elif defined( USE_COLOR )

			if ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];

		#endif

	}

#endif
`,Pl=`
#ifdef USE_MORPHNORMALS

	// morphTargetBaseInfluence is set based on BufferGeometry.morphTargetsRelative value:
	// When morphTargetsRelative is false, this is set to 1 - sum(influences); this results in normal = sum((target - base) * influence)
	// When morphTargetsRelative is true, this is set to 1; as a result, all morph targets are simply added to the base after weighting
	objectNormal *= morphTargetBaseInfluence;

	for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {

		if ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];

	}

#endif
`,Dl=`
#ifdef USE_MORPHTARGETS

	#ifndef USE_INSTANCING_MORPH

		uniform float morphTargetBaseInfluence;
		uniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];

	#endif

	uniform sampler2DArray morphTargetsTexture;
	uniform ivec2 morphTargetsTextureSize;

	vec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {

		int texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;
		int y = texelIndex / morphTargetsTextureSize.x;
		int x = texelIndex - y * morphTargetsTextureSize.x;

		ivec3 morphUV = ivec3( x, y, morphTargetIndex );
		return texelFetch( morphTargetsTexture, morphUV, 0 );

	}

#endif
`,Ol=`
#ifdef USE_MORPHTARGETS

	// morphTargetBaseInfluence is set based on BufferGeometry.morphTargetsRelative value:
	// When morphTargetsRelative is false, this is set to 1 - sum(influences); this results in position = sum((target - base) * influence)
	// When morphTargetsRelative is true, this is set to 1; as a result, all morph targets are simply added to the base after weighting
	transformed *= morphTargetBaseInfluence;

	for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {

		if ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];

	}

#endif
`,Ul=`
float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;

#ifdef FLAT_SHADED

	vec3 fdx = dFdx( vViewPosition );
	vec3 fdy = dFdy( vViewPosition );
	vec3 normal = normalize( cross( fdx, fdy ) );

#else

	vec3 normal = normalize( vNormal );

	#ifdef DOUBLE_SIDED

		normal *= faceDirection;

	#endif

#endif

#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )

	#ifdef USE_TANGENT

		mat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );

	#else

		mat3 tbn = getTangentFrame( - vViewPosition, normal,
		#if defined( USE_NORMALMAP )
			vNormalMapUv
		#elif defined( USE_CLEARCOAT_NORMALMAP )
			vClearcoatNormalMapUv
		#else
			vUv
		#endif
		);

	#endif

	#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )

		tbn[0] *= faceDirection;
		tbn[1] *= faceDirection;

	#endif

#endif

#ifdef USE_CLEARCOAT_NORMALMAP

	#ifdef USE_TANGENT

		mat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );

	#else

		mat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );

	#endif

	#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )

		tbn2[0] *= faceDirection;
		tbn2[1] *= faceDirection;

	#endif

#endif

// non perturbed normal for clearcoat among others

vec3 nonPerturbedNormal = normal;

`,Fl=`

#ifdef USE_NORMALMAP_OBJECTSPACE

	normal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0; // overrides both flatShading and attribute normals

	#ifdef FLIP_SIDED

		normal = - normal;

	#endif

	#ifdef DOUBLE_SIDED

		normal = normal * faceDirection;

	#endif

	normal = normalize( normalMatrix * normal );

#elif defined( USE_NORMALMAP_TANGENTSPACE )

	vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;
	mapN.xy *= normalScale;

	normal = normalize( tbn * mapN );

#elif defined( USE_BUMPMAP )

	normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );

#endif
`,Bl=`
#ifndef FLAT_SHADED

	varying vec3 vNormal;

	#ifdef USE_TANGENT

		varying vec3 vTangent;
		varying vec3 vBitangent;

	#endif

#endif
`,kl=`
#ifndef FLAT_SHADED

	varying vec3 vNormal;

	#ifdef USE_TANGENT

		varying vec3 vTangent;
		varying vec3 vBitangent;

	#endif

#endif
`,Gl=`
#ifndef FLAT_SHADED // normal is computed with derivatives when FLAT_SHADED

	vNormal = normalize( transformedNormal );

	#ifdef USE_TANGENT

		vTangent = normalize( transformedTangent );
		vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );

	#endif

#endif
`,Hl=`
#ifdef USE_NORMALMAP

	uniform sampler2D normalMap;
	uniform vec2 normalScale;

#endif

#ifdef USE_NORMALMAP_OBJECTSPACE

	uniform mat3 normalMatrix;

#endif

#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )

	// Normal Mapping Without Precomputed Tangents
	// http://www.thetenthplanet.de/archives/1180

	mat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {

		vec3 q0 = dFdx( eye_pos.xyz );
		vec3 q1 = dFdy( eye_pos.xyz );
		vec2 st0 = dFdx( uv.st );
		vec2 st1 = dFdy( uv.st );

		vec3 N = surf_norm; // normalized

		vec3 q1perp = cross( q1, N );
		vec3 q0perp = cross( N, q0 );

		vec3 T = q1perp * st0.x + q0perp * st1.x;
		vec3 B = q1perp * st0.y + q0perp * st1.y;

		float det = max( dot( T, T ), dot( B, B ) );
		float scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );

		return mat3( T * scale, B * scale, N );

	}

#endif
`,Vl=`
#ifdef USE_CLEARCOAT

	vec3 clearcoatNormal = nonPerturbedNormal;

#endif
`,zl=`
#ifdef USE_CLEARCOAT_NORMALMAP

	vec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;
	clearcoatMapN.xy *= clearcoatNormalScale;

	clearcoatNormal = normalize( tbn2 * clearcoatMapN );

#endif
`,Wl=`

#ifdef USE_CLEARCOATMAP

	uniform sampler2D clearcoatMap;

#endif

#ifdef USE_CLEARCOAT_NORMALMAP

	uniform sampler2D clearcoatNormalMap;
	uniform vec2 clearcoatNormalScale;

#endif

#ifdef USE_CLEARCOAT_ROUGHNESSMAP

	uniform sampler2D clearcoatRoughnessMap;

#endif
`,jl=`

#ifdef USE_IRIDESCENCEMAP

	uniform sampler2D iridescenceMap;

#endif

#ifdef USE_IRIDESCENCE_THICKNESSMAP

	uniform sampler2D iridescenceThicknessMap;

#endif
`,Xl=`
#ifdef OPAQUE
diffuseColor.a = 1.0;
#endif

#ifdef USE_TRANSMISSION
diffuseColor.a *= material.transmissionAlpha;
#endif

gl_FragColor = vec4( outgoingLight, diffuseColor.a );
`,Yl=`
vec3 packNormalToRGB( const in vec3 normal ) {
	return normalize( normal ) * 0.5 + 0.5;
}

vec3 unpackRGBToNormal( const in vec3 rgb ) {
	return 2.0 * rgb.xyz - 1.0;
}

const float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)
const float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)
const float ShiftRight8 = 1. / 256.;
const float Inv255 = 1. / 255.;

const vec4 PackFactors = vec4( 1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0 );

const vec2 UnpackFactors2 = vec2( UnpackDownscale, 1.0 / PackFactors.g );
const vec3 UnpackFactors3 = vec3( UnpackDownscale / PackFactors.rg, 1.0 / PackFactors.b );
const vec4 UnpackFactors4 = vec4( UnpackDownscale / PackFactors.rgb, 1.0 / PackFactors.a );

vec4 packDepthToRGBA( const in float v ) {
	if( v <= 0.0 )
		return vec4( 0., 0., 0., 0. );
	if( v >= 1.0 )
		return vec4( 1., 1., 1., 1. );
	float vuf;
	float af = modf( v * PackFactors.a, vuf );
	float bf = modf( vuf * ShiftRight8, vuf );
	float gf = modf( vuf * ShiftRight8, vuf );
	return vec4( vuf * Inv255, gf * PackUpscale, bf * PackUpscale, af );
}

vec3 packDepthToRGB( const in float v ) {
	if( v <= 0.0 )
		return vec3( 0., 0., 0. );
	if( v >= 1.0 )
		return vec3( 1., 1., 1. );
	float vuf;
	float bf = modf( v * PackFactors.b, vuf );
	float gf = modf( vuf * ShiftRight8, vuf );
	// the 0.9999 tweak is unimportant, very tiny empirical improvement
	// return vec3( vuf * Inv255, gf * PackUpscale, bf * 0.9999 );
	return vec3( vuf * Inv255, gf * PackUpscale, bf );
}

vec2 packDepthToRG( const in float v ) {
	if( v <= 0.0 )
		return vec2( 0., 0. );
	if( v >= 1.0 )
		return vec2( 1., 1. );
	float vuf;
	float gf = modf( v * 256., vuf );
	return vec2( vuf * Inv255, gf );
}

float unpackRGBAToDepth( const in vec4 v ) {
	return dot( v, UnpackFactors4 );
}

float unpackRGBToDepth( const in vec3 v ) {
	return dot( v, UnpackFactors3 );
}

float unpackRGToDepth( const in vec2 v ) {
	return v.r * UnpackFactors2.r + v.g * UnpackFactors2.g;
}

vec4 pack2HalfToRGBA( const in vec2 v ) {
	vec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );
	return vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );
}

vec2 unpackRGBATo2Half( const in vec4 v ) {
	return vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );
}

// NOTE: viewZ, the z-coordinate in camera space, is negative for points in front of the camera

float viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {
	// -near maps to 0; -far maps to 1
	return ( viewZ + near ) / ( near - far );
}

float orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {
	// maps orthographic depth in [ 0, 1 ] to viewZ
	return depth * ( near - far ) - near;
}

// NOTE: https://twitter.com/gonnavis/status/1377183786949959682

float viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {
	// -near maps to 0; -far maps to 1
	return ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );
}

float perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {
	// maps perspective depth in [ 0, 1 ] to viewZ
	return ( near * far ) / ( ( far - near ) * depth - far );
}
`,Zl=`
#ifdef PREMULTIPLIED_ALPHA

	// Get get normal blending with premultipled, use with CustomBlending, OneFactor, OneMinusSrcAlphaFactor, AddEquation.
	gl_FragColor.rgb *= gl_FragColor.a;

#endif
`,ql=`
vec4 mvPosition = vec4( transformed, 1.0 );

#ifdef USE_BATCHING

	mvPosition = batchingMatrix * mvPosition;

#endif

#ifdef USE_INSTANCING

	mvPosition = instanceMatrix * mvPosition;

#endif

mvPosition = modelViewMatrix * mvPosition;

gl_Position = projectionMatrix * mvPosition;
`,Kl=`
#ifdef DITHERING

	gl_FragColor.rgb = dithering( gl_FragColor.rgb );

#endif
`,Jl=`
#ifdef DITHERING

	// based on https://www.shadertoy.com/view/MslGR8
	vec3 dithering( vec3 color ) {
		//Calculate grid position
		float grid_position = rand( gl_FragCoord.xy );

		//Shift the individual colors differently, thus making it even harder to see the dithering pattern
		vec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );

		//modify shift according to grid position.
		dither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );

		//shift the color by dither_shift
		return color + dither_shift_RGB;
	}

#endif
`,$l=`
float roughnessFactor = roughness;

#ifdef USE_ROUGHNESSMAP

	vec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );

	// reads channel G, compatible with a combined OcclusionRoughnessMetallic (RGB) texture
	roughnessFactor *= texelRoughness.g;

#endif
`,Ql=`
#ifdef USE_ROUGHNESSMAP

	uniform sampler2D roughnessMap;

#endif
`,tu=`
#if NUM_SPOT_LIGHT_COORDS > 0

	varying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];

#endif

#if NUM_SPOT_LIGHT_MAPS > 0

	uniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];

#endif

#ifdef USE_SHADOWMAP

	#if NUM_DIR_LIGHT_SHADOWS > 0

		uniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];

		struct DirectionalLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};

		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];

	#endif

	#if NUM_SPOT_LIGHT_SHADOWS > 0

		uniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];

		struct SpotLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};

		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];

	#endif

	#if NUM_POINT_LIGHT_SHADOWS > 0

		uniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];

		struct PointLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};

		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];

	#endif

	/*
	#if NUM_RECT_AREA_LIGHTS > 0

		// TODO (abelnation): create uniforms for area light shadows

	#endif
	*/

	float texture2DCompare( sampler2D depths, vec2 uv, float compare ) {

		return step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );

	}

	vec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {

		return unpackRGBATo2Half( texture2D( shadow, uv ) );

	}

	float VSMShadow (sampler2D shadow, vec2 uv, float compare ){

		float occlusion = 1.0;

		vec2 distribution = texture2DDistribution( shadow, uv );

		float hard_shadow = step( compare , distribution.x ); // Hard Shadow

		if (hard_shadow != 1.0 ) {

			float distance = compare - distribution.x ;
			float variance = max( 0.00000, distribution.y * distribution.y );
			float softness_probability = variance / (variance + distance * distance ); // Chebeyshevs inequality
			softness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 ); // 0.3 reduces light bleed
			occlusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );

		}
		return occlusion;

	}

	float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord ) {

		float shadow = 1.0;

		shadowCoord.xyz /= shadowCoord.w;
		shadowCoord.z += shadowBias;

		bool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;
		bool frustumTest = inFrustum && shadowCoord.z <= 1.0;

		if ( frustumTest ) {

		#if defined( SHADOWMAP_TYPE_PCF )

			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;

			float dx0 = - texelSize.x * shadowRadius;
			float dy0 = - texelSize.y * shadowRadius;
			float dx1 = + texelSize.x * shadowRadius;
			float dy1 = + texelSize.y * shadowRadius;
			float dx2 = dx0 / 2.0;
			float dy2 = dy0 / 2.0;
			float dx3 = dx1 / 2.0;
			float dy3 = dy1 / 2.0;

			shadow = (
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )
			) * ( 1.0 / 17.0 );

		#elif defined( SHADOWMAP_TYPE_PCF_SOFT )

			vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
			float dx = texelSize.x;
			float dy = texelSize.y;

			vec2 uv = shadowCoord.xy;
			vec2 f = fract( uv * shadowMapSize + 0.5 );
			uv -= f * texelSize;

			shadow = (
				texture2DCompare( shadowMap, uv, shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +
				texture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),
					 f.x ) +
				mix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),
					 texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),
					 f.y ) +
				mix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),
						  f.x ),
					 mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),
						  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),
						  f.x ),
					 f.y )
			) * ( 1.0 / 9.0 );

		#elif defined( SHADOWMAP_TYPE_VSM )

			shadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );

		#else // no percentage-closer filtering:

			shadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );

		#endif

		}

		return mix( 1.0, shadow, shadowIntensity );

	}

	// cubeToUV() maps a 3D direction vector suitable for cube texture mapping to a 2D
	// vector suitable for 2D texture mapping. This code uses the following layout for the
	// 2D texture:
	//
	// xzXZ
	//  y Y
	//
	// Y - Positive y direction
	// y - Negative y direction
	// X - Positive x direction
	// x - Negative x direction
	// Z - Positive z direction
	// z - Negative z direction
	//
	// Source and test bed:
	// https://gist.github.com/tschw/da10c43c467ce8afd0c4

	vec2 cubeToUV( vec3 v, float texelSizeY ) {

		// Number of texels to avoid at the edge of each square

		vec3 absV = abs( v );

		// Intersect unit cube

		float scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );
		absV *= scaleToCube;

		// Apply scale to avoid seams

		// two texels less per square (one texel will do for NEAREST)
		v *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );

		// Unwrap

		// space: -1 ... 1 range for each square
		//
		// #X##		dim    := ( 4 , 2 )
		//  # #		center := ( 1 , 1 )

		vec2 planar = v.xy;

		float almostATexel = 1.5 * texelSizeY;
		float almostOne = 1.0 - almostATexel;

		if ( absV.z >= almostOne ) {

			if ( v.z > 0.0 )
				planar.x = 4.0 - v.x;

		} else if ( absV.x >= almostOne ) {

			float signX = sign( v.x );
			planar.x = v.z * signX + 2.0 * signX;

		} else if ( absV.y >= almostOne ) {

			float signY = sign( v.y );
			planar.x = v.x + 2.0 * signY + 2.0;
			planar.y = v.z * signY - 2.0;

		}

		// Transform to UV space

		// scale := 0.5 / dim
		// translate := ( center + 0.5 ) / dim
		return vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );

	}

	float getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {

		float shadow = 1.0;

		// for point lights, the uniform @vShadowCoord is re-purposed to hold
		// the vector from the light to the world-space position of the fragment.
		vec3 lightToPosition = shadowCoord.xyz;
		
		float lightToPositionLength = length( lightToPosition );

		if ( lightToPositionLength - shadowCameraFar <= 0.0 && lightToPositionLength - shadowCameraNear >= 0.0 ) {

			// dp = normalized distance from light to fragment position
			float dp = ( lightToPositionLength - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear ); // need to clamp?
			dp += shadowBias;

			// bd3D = base direction 3D
			vec3 bd3D = normalize( lightToPosition );

			vec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );

			#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )

				vec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;

				shadow = (
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +
					texture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )
				) * ( 1.0 / 9.0 );

			#else // no percentage-closer filtering

				shadow = texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );

			#endif

		}

		return mix( 1.0, shadow, shadowIntensity );

	}

#endif
`,eu=`

#if NUM_SPOT_LIGHT_COORDS > 0

	uniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];
	varying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];

#endif

#ifdef USE_SHADOWMAP

	#if NUM_DIR_LIGHT_SHADOWS > 0

		uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];

		struct DirectionalLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};

		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];

	#endif

	#if NUM_SPOT_LIGHT_SHADOWS > 0

		struct SpotLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};

		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];

	#endif

	#if NUM_POINT_LIGHT_SHADOWS > 0

		uniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];

		struct PointLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};

		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];

	#endif

	/*
	#if NUM_RECT_AREA_LIGHTS > 0

		// TODO (abelnation): uniforms for area light shadows

	#endif
	*/

#endif
`,iu=`

#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )

	// Offsetting the position used for querying occlusion along the world normal can be used to reduce shadow acne.
	vec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
	vec4 shadowWorldPosition;

#endif

#if defined( USE_SHADOWMAP )

	#if NUM_DIR_LIGHT_SHADOWS > 0

		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {

			shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );
			vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;

		}
		#pragma unroll_loop_end

	#endif

	#if NUM_POINT_LIGHT_SHADOWS > 0

		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {

			shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );
			vPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;

		}
		#pragma unroll_loop_end

	#endif

	/*
	#if NUM_RECT_AREA_LIGHTS > 0

		// TODO (abelnation): update vAreaShadowCoord with area light info

	#endif
	*/

#endif

// spot lights can be evaluated without active shadow mapping (when SpotLight.map is used)

#if NUM_SPOT_LIGHT_COORDS > 0

	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {

		shadowWorldPosition = worldPosition;
		#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
			shadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;
		#endif
		vSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;

	}
	#pragma unroll_loop_end

#endif


`,su=`
float getShadowMask() {

	float shadow = 1.0;

	#ifdef USE_SHADOWMAP

	#if NUM_DIR_LIGHT_SHADOWS > 0

	DirectionalLightShadow directionalLight;

	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {

		directionalLight = directionalLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowIntensity, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;

	}
	#pragma unroll_loop_end

	#endif

	#if NUM_SPOT_LIGHT_SHADOWS > 0

	SpotLightShadow spotLight;

	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {

		spotLight = spotLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowIntensity, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;

	}
	#pragma unroll_loop_end

	#endif

	#if NUM_POINT_LIGHT_SHADOWS > 0

	PointLightShadow pointLight;

	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {

		pointLight = pointLightShadows[ i ];
		shadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowIntensity, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;

	}
	#pragma unroll_loop_end

	#endif

	/*
	#if NUM_RECT_AREA_LIGHTS > 0

		// TODO (abelnation): update shadow for Area light

	#endif
	*/

	#endif

	return shadow;

}
`,ru=`
#ifdef USE_SKINNING

	mat4 boneMatX = getBoneMatrix( skinIndex.x );
	mat4 boneMatY = getBoneMatrix( skinIndex.y );
	mat4 boneMatZ = getBoneMatrix( skinIndex.z );
	mat4 boneMatW = getBoneMatrix( skinIndex.w );

#endif
`,nu=`
#ifdef USE_SKINNING

	uniform mat4 bindMatrix;
	uniform mat4 bindMatrixInverse;

	uniform highp sampler2D boneTexture;

	mat4 getBoneMatrix( const in float i ) {

		int size = textureSize( boneTexture, 0 ).x;
		int j = int( i ) * 4;
		int x = j % size;
		int y = j / size;
		vec4 v1 = texelFetch( boneTexture, ivec2( x, y ), 0 );
		vec4 v2 = texelFetch( boneTexture, ivec2( x + 1, y ), 0 );
		vec4 v3 = texelFetch( boneTexture, ivec2( x + 2, y ), 0 );
		vec4 v4 = texelFetch( boneTexture, ivec2( x + 3, y ), 0 );

		return mat4( v1, v2, v3, v4 );

	}

#endif
`,au=`
#ifdef USE_SKINNING

	vec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );

	vec4 skinned = vec4( 0.0 );
	skinned += boneMatX * skinVertex * skinWeight.x;
	skinned += boneMatY * skinVertex * skinWeight.y;
	skinned += boneMatZ * skinVertex * skinWeight.z;
	skinned += boneMatW * skinVertex * skinWeight.w;

	transformed = ( bindMatrixInverse * skinned ).xyz;

#endif
`,hu=`
#ifdef USE_SKINNING

	mat4 skinMatrix = mat4( 0.0 );
	skinMatrix += skinWeight.x * boneMatX;
	skinMatrix += skinWeight.y * boneMatY;
	skinMatrix += skinWeight.z * boneMatZ;
	skinMatrix += skinWeight.w * boneMatW;
	skinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;

	objectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;

	#ifdef USE_TANGENT

		objectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;

	#endif

#endif
`,ou=`
float specularStrength;

#ifdef USE_SPECULARMAP

	vec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );
	specularStrength = texelSpecular.r;

#else

	specularStrength = 1.0;

#endif
`,lu=`
#ifdef USE_SPECULARMAP

	uniform sampler2D specularMap;

#endif
`,uu=`
#if defined( TONE_MAPPING )

	gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );

#endif
`,cu=`
#ifndef saturate
// <common> may have defined saturate() already
#define saturate( a ) clamp( a, 0.0, 1.0 )
#endif

uniform float toneMappingExposure;

// exposure only
vec3 LinearToneMapping( vec3 color ) {

	return saturate( toneMappingExposure * color );

}

// source: https://www.cs.utah.edu/docs/techreports/2002/pdf/UUCS-02-001.pdf
vec3 ReinhardToneMapping( vec3 color ) {

	color *= toneMappingExposure;
	return saturate( color / ( vec3( 1.0 ) + color ) );

}

// source: http://filmicworlds.com/blog/filmic-tonemapping-operators/
vec3 CineonToneMapping( vec3 color ) {

	// filmic operator by Jim Hejl and Richard Burgess-Dawson
	color *= toneMappingExposure;
	color = max( vec3( 0.0 ), color - 0.004 );
	return pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );

}

// source: https://github.com/selfshadow/ltc_code/blob/master/webgl/shaders/ltc/ltc_blit.fs
vec3 RRTAndODTFit( vec3 v ) {

	vec3 a = v * ( v + 0.0245786 ) - 0.000090537;
	vec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;
	return a / b;

}

// this implementation of ACES is modified to accommodate a brighter viewing environment.
// the scale factor of 1/0.6 is subjective. see discussion in #19621.

vec3 ACESFilmicToneMapping( vec3 color ) {

	// sRGB => XYZ => D65_2_D60 => AP1 => RRT_SAT
	const mat3 ACESInputMat = mat3(
		vec3( 0.59719, 0.07600, 0.02840 ), // transposed from source
		vec3( 0.35458, 0.90834, 0.13383 ),
		vec3( 0.04823, 0.01566, 0.83777 )
	);

	// ODT_SAT => XYZ => D60_2_D65 => sRGB
	const mat3 ACESOutputMat = mat3(
		vec3(  1.60475, -0.10208, -0.00327 ), // transposed from source
		vec3( -0.53108,  1.10813, -0.07276 ),
		vec3( -0.07367, -0.00605,  1.07602 )
	);

	color *= toneMappingExposure / 0.6;

	color = ACESInputMat * color;

	// Apply RRT and ODT
	color = RRTAndODTFit( color );

	color = ACESOutputMat * color;

	// Clamp to [0, 1]
	return saturate( color );

}

// Matrices for rec 2020 <> rec 709 color space conversion
// matrix provided in row-major order so it has been transposed
// https://www.itu.int/pub/R-REP-BT.2407-2017
const mat3 LINEAR_REC2020_TO_LINEAR_SRGB = mat3(
	vec3( 1.6605, - 0.1246, - 0.0182 ),
	vec3( - 0.5876, 1.1329, - 0.1006 ),
	vec3( - 0.0728, - 0.0083, 1.1187 )
);

const mat3 LINEAR_SRGB_TO_LINEAR_REC2020 = mat3(
	vec3( 0.6274, 0.0691, 0.0164 ),
	vec3( 0.3293, 0.9195, 0.0880 ),
	vec3( 0.0433, 0.0113, 0.8956 )
);

// https://iolite-engine.com/blog_posts/minimal_agx_implementation
// Mean error^2: 3.6705141e-06
vec3 agxDefaultContrastApprox( vec3 x ) {

	vec3 x2 = x * x;
	vec3 x4 = x2 * x2;

	return + 15.5 * x4 * x2
		- 40.14 * x4 * x
		+ 31.96 * x4
		- 6.868 * x2 * x
		+ 0.4298 * x2
		+ 0.1191 * x
		- 0.00232;

}

// AgX Tone Mapping implementation based on Filament, which in turn is based
// on Blender's implementation using rec 2020 primaries
// https://github.com/google/filament/pull/7236
// Inputs and outputs are encoded as Linear-sRGB.

vec3 AgXToneMapping( vec3 color ) {

	// AgX constants
	const mat3 AgXInsetMatrix = mat3(
		vec3( 0.856627153315983, 0.137318972929847, 0.11189821299995 ),
		vec3( 0.0951212405381588, 0.761241990602591, 0.0767994186031903 ),
		vec3( 0.0482516061458583, 0.101439036467562, 0.811302368396859 )
	);

	// explicit AgXOutsetMatrix generated from Filaments AgXOutsetMatrixInv
	const mat3 AgXOutsetMatrix = mat3(
		vec3( 1.1271005818144368, - 0.1413297634984383, - 0.14132976349843826 ),
		vec3( - 0.11060664309660323, 1.157823702216272, - 0.11060664309660294 ),
		vec3( - 0.016493938717834573, - 0.016493938717834257, 1.2519364065950405 )
	);

	// LOG2_MIN      = -10.0
	// LOG2_MAX      =  +6.5
	// MIDDLE_GRAY   =  0.18
	const float AgxMinEv = - 12.47393;  // log2( pow( 2, LOG2_MIN ) * MIDDLE_GRAY )
	const float AgxMaxEv = 4.026069;    // log2( pow( 2, LOG2_MAX ) * MIDDLE_GRAY )

	color *= toneMappingExposure;

	color = LINEAR_SRGB_TO_LINEAR_REC2020 * color;

	color = AgXInsetMatrix * color;

	// Log2 encoding
	color = max( color, 1e-10 ); // avoid 0 or negative numbers for log2
	color = log2( color );
	color = ( color - AgxMinEv ) / ( AgxMaxEv - AgxMinEv );

	color = clamp( color, 0.0, 1.0 );

	// Apply sigmoid
	color = agxDefaultContrastApprox( color );

	// Apply AgX look
	// v = agxLook(v, look);

	color = AgXOutsetMatrix * color;

	// Linearize
	color = pow( max( vec3( 0.0 ), color ), vec3( 2.2 ) );

	color = LINEAR_REC2020_TO_LINEAR_SRGB * color;

	// Gamut mapping. Simple clamp for now.
	color = clamp( color, 0.0, 1.0 );

	return color;

}

// https://modelviewer.dev/examples/tone-mapping

vec3 NeutralToneMapping( vec3 color ) {

	const float StartCompression = 0.8 - 0.04;
	const float Desaturation = 0.15;

	color *= toneMappingExposure;

	float x = min( color.r, min( color.g, color.b ) );

	float offset = x < 0.08 ? x - 6.25 * x * x : 0.04;

	color -= offset;

	float peak = max( color.r, max( color.g, color.b ) );

	if ( peak < StartCompression ) return color;

	float d = 1. - StartCompression;

	float newPeak = 1. - d * d / ( peak + d - StartCompression );

	color *= newPeak / peak;

	float g = 1. - 1. / ( Desaturation * ( peak - newPeak ) + 1. );

	return mix( color, vec3( newPeak ), g );

}

vec3 CustomToneMapping( vec3 color ) { return color; }
`,fu=`
#ifdef USE_TRANSMISSION

	material.transmission = transmission;
	material.transmissionAlpha = 1.0;
	material.thickness = thickness;
	material.attenuationDistance = attenuationDistance;
	material.attenuationColor = attenuationColor;

	#ifdef USE_TRANSMISSIONMAP

		material.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;

	#endif

	#ifdef USE_THICKNESSMAP

		material.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;

	#endif

	vec3 pos = vWorldPosition;
	vec3 v = normalize( cameraPosition - pos );
	vec3 n = inverseTransformDirection( normal, viewMatrix );

	vec4 transmitted = getIBLVolumeRefraction(
		n, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,
		pos, modelMatrix, viewMatrix, projectionMatrix, material.dispersion, material.ior, material.thickness,
		material.attenuationColor, material.attenuationDistance );

	material.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );

	totalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );

#endif
`,du=`
#ifdef USE_TRANSMISSION

	// Transmission code is based on glTF-Sampler-Viewer
	// https://github.com/KhronosGroup/glTF-Sample-Viewer

	uniform float transmission;
	uniform float thickness;
	uniform float attenuationDistance;
	uniform vec3 attenuationColor;

	#ifdef USE_TRANSMISSIONMAP

		uniform sampler2D transmissionMap;

	#endif

	#ifdef USE_THICKNESSMAP

		uniform sampler2D thicknessMap;

	#endif

	uniform vec2 transmissionSamplerSize;
	uniform sampler2D transmissionSamplerMap;

	uniform mat4 modelMatrix;
	uniform mat4 projectionMatrix;

	varying vec3 vWorldPosition;

	// Mipped Bicubic Texture Filtering by N8
	// https://www.shadertoy.com/view/Dl2SDW

	float w0( float a ) {

		return ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );

	}

	float w1( float a ) {

		return ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );

	}

	float w2( float a ){

		return ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );

	}

	float w3( float a ) {

		return ( 1.0 / 6.0 ) * ( a * a * a );

	}

	// g0 and g1 are the two amplitude functions
	float g0( float a ) {

		return w0( a ) + w1( a );

	}

	float g1( float a ) {

		return w2( a ) + w3( a );

	}

	// h0 and h1 are the two offset functions
	float h0( float a ) {

		return - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );

	}

	float h1( float a ) {

		return 1.0 + w3( a ) / ( w2( a ) + w3( a ) );

	}

	vec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {

		uv = uv * texelSize.zw + 0.5;

		vec2 iuv = floor( uv );
		vec2 fuv = fract( uv );

		float g0x = g0( fuv.x );
		float g1x = g1( fuv.x );
		float h0x = h0( fuv.x );
		float h1x = h1( fuv.x );
		float h0y = h0( fuv.y );
		float h1y = h1( fuv.y );

		vec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;
		vec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;
		vec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;
		vec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;

		return g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +
			g1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );

	}

	vec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {

		vec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );
		vec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );
		vec2 fLodSizeInv = 1.0 / fLodSize;
		vec2 cLodSizeInv = 1.0 / cLodSize;
		vec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );
		vec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );
		return mix( fSample, cSample, fract( lod ) );

	}

	vec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {

		// Direction of refracted light.
		vec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );

		// Compute rotation-independant scaling of the model matrix.
		vec3 modelScale;
		modelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );
		modelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );
		modelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );

		// The thickness is specified in local space.
		return normalize( refractionVector ) * thickness * modelScale;

	}

	float applyIorToRoughness( const in float roughness, const in float ior ) {

		// Scale roughness with IOR so that an IOR of 1.0 results in no microfacet refraction and
		// an IOR of 1.5 results in the default amount of microfacet refraction.
		return roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );

	}

	vec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {

		float lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );
		return textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );

	}

	vec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {

		if ( isinf( attenuationDistance ) ) {

			// Attenuation distance is +, i.e. the transmitted color is not attenuated at all.
			return vec3( 1.0 );

		} else {

			// Compute light attenuation using Beer's law.
			vec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;
			vec3 transmittance = exp( - attenuationCoefficient * transmissionDistance ); // Beer's law
			return transmittance;

		}

	}

	vec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,
		const in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,
		const in mat4 viewMatrix, const in mat4 projMatrix, const in float dispersion, const in float ior, const in float thickness,
		const in vec3 attenuationColor, const in float attenuationDistance ) {

		vec4 transmittedLight;
		vec3 transmittance;

		#ifdef USE_DISPERSION

			float halfSpread = ( ior - 1.0 ) * 0.025 * dispersion;
			vec3 iors = vec3( ior - halfSpread, ior, ior + halfSpread );

			for ( int i = 0; i < 3; i ++ ) {

				vec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, iors[ i ], modelMatrix );
				vec3 refractedRayExit = position + transmissionRay;
		
				// Project refracted vector on the framebuffer, while mapping to normalized device coordinates.
				vec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );
				vec2 refractionCoords = ndcPos.xy / ndcPos.w;
				refractionCoords += 1.0;
				refractionCoords /= 2.0;
		
				// Sample framebuffer to get pixel the refracted ray hits.
				vec4 transmissionSample = getTransmissionSample( refractionCoords, roughness, iors[ i ] );
				transmittedLight[ i ] = transmissionSample[ i ];
				transmittedLight.a += transmissionSample.a;

				transmittance[ i ] = diffuseColor[ i ] * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance )[ i ];

			}

			transmittedLight.a /= 3.0;
		
		#else
		
			vec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );
			vec3 refractedRayExit = position + transmissionRay;

			// Project refracted vector on the framebuffer, while mapping to normalized device coordinates.
			vec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );
			vec2 refractionCoords = ndcPos.xy / ndcPos.w;
			refractionCoords += 1.0;
			refractionCoords /= 2.0;

			// Sample framebuffer to get pixel the refracted ray hits.
			transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );
			transmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );
		
		#endif

		vec3 attenuatedColor = transmittance * transmittedLight.rgb;

		// Get the specular component.
		vec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );

		// As less light is transmitted, the opacity should be increased. This simple approximation does a decent job 
		// of modulating a CSS background, and has no effect when the buffer is opaque, due to a solid object or clear color.
		float transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;

		return vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );

	}
#endif
`,vu=`
#if defined( USE_UV ) || defined( USE_ANISOTROPY )

	varying vec2 vUv;

#endif
#ifdef USE_MAP

	varying vec2 vMapUv;

#endif
#ifdef USE_ALPHAMAP

	varying vec2 vAlphaMapUv;

#endif
#ifdef USE_LIGHTMAP

	varying vec2 vLightMapUv;

#endif
#ifdef USE_AOMAP

	varying vec2 vAoMapUv;

#endif
#ifdef USE_BUMPMAP

	varying vec2 vBumpMapUv;

#endif
#ifdef USE_NORMALMAP

	varying vec2 vNormalMapUv;

#endif
#ifdef USE_EMISSIVEMAP

	varying vec2 vEmissiveMapUv;

#endif
#ifdef USE_METALNESSMAP

	varying vec2 vMetalnessMapUv;

#endif
#ifdef USE_ROUGHNESSMAP

	varying vec2 vRoughnessMapUv;

#endif
#ifdef USE_ANISOTROPYMAP

	varying vec2 vAnisotropyMapUv;

#endif
#ifdef USE_CLEARCOATMAP

	varying vec2 vClearcoatMapUv;

#endif
#ifdef USE_CLEARCOAT_NORMALMAP

	varying vec2 vClearcoatNormalMapUv;

#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP

	varying vec2 vClearcoatRoughnessMapUv;

#endif
#ifdef USE_IRIDESCENCEMAP

	varying vec2 vIridescenceMapUv;

#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP

	varying vec2 vIridescenceThicknessMapUv;

#endif
#ifdef USE_SHEEN_COLORMAP

	varying vec2 vSheenColorMapUv;

#endif
#ifdef USE_SHEEN_ROUGHNESSMAP

	varying vec2 vSheenRoughnessMapUv;

#endif
#ifdef USE_SPECULARMAP

	varying vec2 vSpecularMapUv;

#endif
#ifdef USE_SPECULAR_COLORMAP

	varying vec2 vSpecularColorMapUv;

#endif
#ifdef USE_SPECULAR_INTENSITYMAP

	varying vec2 vSpecularIntensityMapUv;

#endif
#ifdef USE_TRANSMISSIONMAP

	uniform mat3 transmissionMapTransform;
	varying vec2 vTransmissionMapUv;

#endif
#ifdef USE_THICKNESSMAP

	uniform mat3 thicknessMapTransform;
	varying vec2 vThicknessMapUv;

#endif
`,pu=`
#if defined( USE_UV ) || defined( USE_ANISOTROPY )

	varying vec2 vUv;

#endif
#ifdef USE_MAP

	uniform mat3 mapTransform;
	varying vec2 vMapUv;

#endif
#ifdef USE_ALPHAMAP

	uniform mat3 alphaMapTransform;
	varying vec2 vAlphaMapUv;

#endif
#ifdef USE_LIGHTMAP

	uniform mat3 lightMapTransform;
	varying vec2 vLightMapUv;

#endif
#ifdef USE_AOMAP

	uniform mat3 aoMapTransform;
	varying vec2 vAoMapUv;

#endif
#ifdef USE_BUMPMAP

	uniform mat3 bumpMapTransform;
	varying vec2 vBumpMapUv;

#endif
#ifdef USE_NORMALMAP

	uniform mat3 normalMapTransform;
	varying vec2 vNormalMapUv;

#endif
#ifdef USE_DISPLACEMENTMAP

	uniform mat3 displacementMapTransform;
	varying vec2 vDisplacementMapUv;

#endif
#ifdef USE_EMISSIVEMAP

	uniform mat3 emissiveMapTransform;
	varying vec2 vEmissiveMapUv;

#endif
#ifdef USE_METALNESSMAP

	uniform mat3 metalnessMapTransform;
	varying vec2 vMetalnessMapUv;

#endif
#ifdef USE_ROUGHNESSMAP

	uniform mat3 roughnessMapTransform;
	varying vec2 vRoughnessMapUv;

#endif
#ifdef USE_ANISOTROPYMAP

	uniform mat3 anisotropyMapTransform;
	varying vec2 vAnisotropyMapUv;

#endif
#ifdef USE_CLEARCOATMAP

	uniform mat3 clearcoatMapTransform;
	varying vec2 vClearcoatMapUv;

#endif
#ifdef USE_CLEARCOAT_NORMALMAP

	uniform mat3 clearcoatNormalMapTransform;
	varying vec2 vClearcoatNormalMapUv;

#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP

	uniform mat3 clearcoatRoughnessMapTransform;
	varying vec2 vClearcoatRoughnessMapUv;

#endif
#ifdef USE_SHEEN_COLORMAP

	uniform mat3 sheenColorMapTransform;
	varying vec2 vSheenColorMapUv;

#endif
#ifdef USE_SHEEN_ROUGHNESSMAP

	uniform mat3 sheenRoughnessMapTransform;
	varying vec2 vSheenRoughnessMapUv;

#endif
#ifdef USE_IRIDESCENCEMAP

	uniform mat3 iridescenceMapTransform;
	varying vec2 vIridescenceMapUv;

#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP

	uniform mat3 iridescenceThicknessMapTransform;
	varying vec2 vIridescenceThicknessMapUv;

#endif
#ifdef USE_SPECULARMAP

	uniform mat3 specularMapTransform;
	varying vec2 vSpecularMapUv;

#endif
#ifdef USE_SPECULAR_COLORMAP

	uniform mat3 specularColorMapTransform;
	varying vec2 vSpecularColorMapUv;

#endif
#ifdef USE_SPECULAR_INTENSITYMAP

	uniform mat3 specularIntensityMapTransform;
	varying vec2 vSpecularIntensityMapUv;

#endif
#ifdef USE_TRANSMISSIONMAP

	uniform mat3 transmissionMapTransform;
	varying vec2 vTransmissionMapUv;

#endif
#ifdef USE_THICKNESSMAP

	uniform mat3 thicknessMapTransform;
	varying vec2 vThicknessMapUv;

#endif
`,mu=`
#if defined( USE_UV ) || defined( USE_ANISOTROPY )

	vUv = vec3( uv, 1 ).xy;

#endif
#ifdef USE_MAP

	vMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;

#endif
#ifdef USE_ALPHAMAP

	vAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_LIGHTMAP

	vLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_AOMAP

	vAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_BUMPMAP

	vBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_NORMALMAP

	vNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_DISPLACEMENTMAP

	vDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_EMISSIVEMAP

	vEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_METALNESSMAP

	vMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_ROUGHNESSMAP

	vRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_ANISOTROPYMAP

	vAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_CLEARCOATMAP

	vClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_CLEARCOAT_NORMALMAP

	vClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP

	vClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_IRIDESCENCEMAP

	vIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP

	vIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_SHEEN_COLORMAP

	vSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_SHEEN_ROUGHNESSMAP

	vSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_SPECULARMAP

	vSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_SPECULAR_COLORMAP

	vSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_SPECULAR_INTENSITYMAP

	vSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_TRANSMISSIONMAP

	vTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;

#endif
#ifdef USE_THICKNESSMAP

	vThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;

#endif
`,gu=`
#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0

	vec4 worldPosition = vec4( transformed, 1.0 );

	#ifdef USE_BATCHING

		worldPosition = batchingMatrix * worldPosition;

	#endif

	#ifdef USE_INSTANCING

		worldPosition = instanceMatrix * worldPosition;

	#endif

	worldPosition = modelMatrix * worldPosition;

#endif
`;let _u=`
varying vec2 vUv;
uniform mat3 uvTransform;

void main() {

	vUv = ( uvTransform * vec3( uv, 1 ) ).xy;

	gl_Position = vec4( position.xy, 1.0, 1.0 );

}
`,wu=`
uniform sampler2D t2D;
uniform float backgroundIntensity;

varying vec2 vUv;

void main() {

	vec4 texColor = texture2D( t2D, vUv );

	#ifdef DECODE_VIDEO_TEXTURE

		// use inline sRGB decode until browsers properly support SRGB8_APLHA8 with video textures

		texColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );

	#endif

	texColor.rgb *= backgroundIntensity;

	gl_FragColor = texColor;

	#include <tonemapping_fragment>
	#include <colorspace_fragment>

}
`,Mu=`
varying vec3 vWorldDirection;

#include <common>

void main() {

	vWorldDirection = transformDirection( position, modelMatrix );

	#include <begin_vertex>
	#include <project_vertex>

	gl_Position.z = gl_Position.w; // set z to camera.far

}
`,yu=`

#ifdef ENVMAP_TYPE_CUBE

	uniform samplerCube envMap;

#elif defined( ENVMAP_TYPE_CUBE_UV )

	uniform sampler2D envMap;

#endif

uniform float flipEnvMap;
uniform float backgroundBlurriness;
uniform float backgroundIntensity;
uniform mat3 backgroundRotation;

varying vec3 vWorldDirection;

#include <cube_uv_reflection_fragment>

void main() {

	#ifdef ENVMAP_TYPE_CUBE

		vec4 texColor = textureCube( envMap, backgroundRotation * vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );

	#elif defined( ENVMAP_TYPE_CUBE_UV )

		vec4 texColor = textureCubeUV( envMap, backgroundRotation * vWorldDirection, backgroundBlurriness );

	#else

		vec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );

	#endif

	texColor.rgb *= backgroundIntensity;

	gl_FragColor = texColor;

	#include <tonemapping_fragment>
	#include <colorspace_fragment>

}
`,Eu=`
varying vec3 vWorldDirection;

#include <common>

void main() {

	vWorldDirection = transformDirection( position, modelMatrix );

	#include <begin_vertex>
	#include <project_vertex>

	gl_Position.z = gl_Position.w; // set z to camera.far

}
`,xu=`
uniform samplerCube tCube;
uniform float tFlip;
uniform float opacity;

varying vec3 vWorldDirection;

void main() {

	vec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );

	gl_FragColor = texColor;
	gl_FragColor.a *= opacity;

	#include <tonemapping_fragment>
	#include <colorspace_fragment>

}
`,bu=`
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>

// This is used for computing an equivalent of gl_FragCoord.z that is as high precision as possible.
// Some platforms compute gl_FragCoord at a lower precision which makes the manually computed value better for
// depth-based postprocessing effects. Reproduced on iPad with A10 processor / iPadOS 13.3.1.
varying vec2 vHighPrecisionZW;

void main() {

	#include <uv_vertex>

	#include <batching_vertex>
	#include <skinbase_vertex>

	#include <morphinstance_vertex>

	#ifdef USE_DISPLACEMENTMAP

		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>

	#endif

	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>

	vHighPrecisionZW = gl_Position.zw;

}
`,Su=`
#if DEPTH_PACKING == 3200

	uniform float opacity;

#endif

#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>

varying vec2 vHighPrecisionZW;

void main() {

	vec4 diffuseColor = vec4( 1.0 );
	#include <clipping_planes_fragment>

	#if DEPTH_PACKING == 3200

		diffuseColor.a = opacity;

	#endif

	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>

	#include <logdepthbuf_fragment>

	// Higher precision equivalent of gl_FragCoord.z. This assumes depthRange has been left to its default values.
	float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;

	#if DEPTH_PACKING == 3200

		gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );

	#elif DEPTH_PACKING == 3201

		gl_FragColor = packDepthToRGBA( fragCoordZ );

	#elif DEPTH_PACKING == 3202

		gl_FragColor = vec4( packDepthToRGB( fragCoordZ ), 1.0 );

	#elif DEPTH_PACKING == 3203

		gl_FragColor = vec4( packDepthToRG( fragCoordZ ), 0.0, 1.0 );

	#endif

}
`,Au=`
#define DISTANCE

varying vec3 vWorldPosition;

#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <clipping_planes_pars_vertex>

void main() {

	#include <uv_vertex>

	#include <batching_vertex>
	#include <skinbase_vertex>

	#include <morphinstance_vertex>

	#ifdef USE_DISPLACEMENTMAP

		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>

	#endif

	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <worldpos_vertex>
	#include <clipping_planes_vertex>

	vWorldPosition = worldPosition.xyz;

}
`,Tu=`
#define DISTANCE

uniform vec3 referencePosition;
uniform float nearDistance;
uniform float farDistance;
varying vec3 vWorldPosition;

#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <clipping_planes_pars_fragment>

void main () {

	vec4 diffuseColor = vec4( 1.0 );
	#include <clipping_planes_fragment>

	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>

	float dist = length( vWorldPosition - referencePosition );
	dist = ( dist - nearDistance ) / ( farDistance - nearDistance );
	dist = saturate( dist ); // clamp to [ 0, 1 ]

	gl_FragColor = packDepthToRGBA( dist );

}
`,Ru=`
varying vec3 vWorldDirection;

#include <common>

void main() {

	vWorldDirection = transformDirection( position, modelMatrix );

	#include <begin_vertex>
	#include <project_vertex>

}
`,Lu=`
uniform sampler2D tEquirect;

varying vec3 vWorldDirection;

#include <common>

void main() {

	vec3 direction = normalize( vWorldDirection );

	vec2 sampleUV = equirectUv( direction );

	gl_FragColor = texture2D( tEquirect, sampleUV );

	#include <tonemapping_fragment>
	#include <colorspace_fragment>

}
`,Cu=`
uniform float scale;
attribute float lineDistance;

varying float vLineDistance;

#include <common>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>

void main() {

	vLineDistance = scale * lineDistance;

	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>

}
`,Nu=`
uniform vec3 diffuse;
uniform float opacity;

uniform float dashSize;
uniform float totalSize;

varying float vLineDistance;

#include <common>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>

void main() {

	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>

	if ( mod( vLineDistance, totalSize ) > dashSize ) {

		discard;

	}

	vec3 outgoingLight = vec3( 0.0 );

	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>

	outgoingLight = diffuseColor.rgb; // simple shader

	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>

}
`,Iu=`
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>

void main() {

	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>

	#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )

		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinbase_vertex>
		#include <skinnormal_vertex>
		#include <defaultnormal_vertex>

	#endif

	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>

	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <fog_vertex>

}
`,Pu=`
uniform vec3 diffuse;
uniform float opacity;

#ifndef FLAT_SHADED

	varying vec3 vNormal;

#endif

#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>

void main() {

	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>

	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>

	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );

	// accumulation (baked indirect lighting only)
	#ifdef USE_LIGHTMAP

		vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );
		reflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;

	#else

		reflectedLight.indirectDiffuse += vec3( 1.0 );

	#endif

	// modulation
	#include <aomap_fragment>

	reflectedLight.indirectDiffuse *= diffuseColor.rgb;

	vec3 outgoingLight = reflectedLight.indirectDiffuse;

	#include <envmap_fragment>

	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>

}
`,Du=`
#define LAMBERT

varying vec3 vViewPosition;

#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>

void main() {

	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>

	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>

	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>

	vViewPosition = - mvPosition.xyz;

	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>

}
`,Ou=`
#define LAMBERT

uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;

#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_lambert_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>

void main() {

	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>

	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;

	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>

	// accumulation
	#include <lights_lambert_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>

	// modulation
	#include <aomap_fragment>

	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;

	#include <envmap_fragment>
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}
`,Uu=`
#define MATCAP

varying vec3 vViewPosition;

#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <displacementmap_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>

#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>

void main() {

	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>

	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>

	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>

	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>

	vViewPosition = - mvPosition.xyz;

}
`,Fu=`
#define MATCAP

uniform vec3 diffuse;
uniform float opacity;
uniform sampler2D matcap;

varying vec3 vViewPosition;

#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <fog_pars_fragment>
#include <normal_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>

void main() {

	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>

	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>

	vec3 viewDir = normalize( vViewPosition );
	vec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );
	vec3 y = cross( viewDir, x );
	vec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5; // 0.495 to remove artifacts caused by undersized matcap disks

	#ifdef USE_MATCAP

		vec4 matcapColor = texture2D( matcap, uv );

	#else

		vec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 ); // default if matcap is missing

	#endif

	vec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;

	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>

}
`,Bu=`
#define NORMAL

#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )

	varying vec3 vViewPosition;

#endif

#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>

void main() {

	#include <uv_vertex>
	#include <batching_vertex>

	#include <beginnormal_vertex>
	#include <morphinstance_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>

	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>

#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )

	vViewPosition = - mvPosition.xyz;

#endif

}
`,ku=`
#define NORMAL

uniform float opacity;

#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )

	varying vec3 vViewPosition;

#endif

#include <packing>
#include <uv_pars_fragment>
#include <normal_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>

void main() {

	vec4 diffuseColor = vec4( 0.0, 0.0, 0.0, opacity );

	#include <clipping_planes_fragment>
	#include <logdepthbuf_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>

	gl_FragColor = vec4( packNormalToRGB( normal ), diffuseColor.a );

	#ifdef OPAQUE

		gl_FragColor.a = 1.0;

	#endif

}
`,Gu=`
#define PHONG

varying vec3 vViewPosition;

#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>

void main() {

	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>

	#include <beginnormal_vertex>
	#include <morphinstance_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>

	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>

	vViewPosition = - mvPosition.xyz;

	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>

}
`,Hu=`
#define PHONG

uniform vec3 diffuse;
uniform vec3 emissive;
uniform vec3 specular;
uniform float shininess;
uniform float opacity;

#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_phong_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>

void main() {

	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>

	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;

	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>

	// accumulation
	#include <lights_phong_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>

	// modulation
	#include <aomap_fragment>

	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;

	#include <envmap_fragment>
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>

}
`,Vu=`
#define STANDARD

varying vec3 vViewPosition;

#ifdef USE_TRANSMISSION

	varying vec3 vWorldPosition;

#endif

#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>

void main() {

	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>

	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>

	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>

	vViewPosition = - mvPosition.xyz;

	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>

#ifdef USE_TRANSMISSION

	vWorldPosition = worldPosition.xyz;

#endif
}
`,zu=`
#define STANDARD

#ifdef PHYSICAL
	#define IOR
	#define USE_SPECULAR
#endif

uniform vec3 diffuse;
uniform vec3 emissive;
uniform float roughness;
uniform float metalness;
uniform float opacity;

#ifdef IOR
	uniform float ior;
#endif

#ifdef USE_SPECULAR
	uniform float specularIntensity;
	uniform vec3 specularColor;

	#ifdef USE_SPECULAR_COLORMAP
		uniform sampler2D specularColorMap;
	#endif

	#ifdef USE_SPECULAR_INTENSITYMAP
		uniform sampler2D specularIntensityMap;
	#endif
#endif

#ifdef USE_CLEARCOAT
	uniform float clearcoat;
	uniform float clearcoatRoughness;
#endif

#ifdef USE_DISPERSION
	uniform float dispersion;
#endif

#ifdef USE_IRIDESCENCE
	uniform float iridescence;
	uniform float iridescenceIOR;
	uniform float iridescenceThicknessMinimum;
	uniform float iridescenceThicknessMaximum;
#endif

#ifdef USE_SHEEN
	uniform vec3 sheenColor;
	uniform float sheenRoughness;

	#ifdef USE_SHEEN_COLORMAP
		uniform sampler2D sheenColorMap;
	#endif

	#ifdef USE_SHEEN_ROUGHNESSMAP
		uniform sampler2D sheenRoughnessMap;
	#endif
#endif

#ifdef USE_ANISOTROPY
	uniform vec2 anisotropyVector;

	#ifdef USE_ANISOTROPYMAP
		uniform sampler2D anisotropyMap;
	#endif
#endif

varying vec3 vViewPosition;

#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <iridescence_fragment>
#include <cube_uv_reflection_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_physical_pars_fragment>
#include <fog_pars_fragment>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_physical_pars_fragment>
#include <transmission_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <clearcoat_pars_fragment>
#include <iridescence_pars_fragment>
#include <roughnessmap_pars_fragment>
#include <metalnessmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>

void main() {

	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>

	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;

	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <roughnessmap_fragment>
	#include <metalnessmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <clearcoat_normal_fragment_begin>
	#include <clearcoat_normal_fragment_maps>
	#include <emissivemap_fragment>

	// accumulation
	#include <lights_physical_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>

	// modulation
	#include <aomap_fragment>

	vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;
	vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;

	#include <transmission_fragment>

	vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;

	#ifdef USE_SHEEN

		// Sheen energy compensation approximation calculation can be found at the end of
		// https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing
		float sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );

		outgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;

	#endif

	#ifdef USE_CLEARCOAT

		float dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );

		vec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );

		outgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;

	#endif

	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>

}
`,Wu=`
#define TOON

varying vec3 vViewPosition;

#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>

void main() {

	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>

	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>

	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>

	vViewPosition = - mvPosition.xyz;

	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>

}
`,ju=`
#define TOON

uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;

#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <gradientmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_toon_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>

void main() {

	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>

	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;

	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>

	// accumulation
	#include <lights_toon_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>

	// modulation
	#include <aomap_fragment>

	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;

	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>

}
`,Xu=`
uniform float size;
uniform float scale;

#include <common>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>

#ifdef USE_POINTS_UV

	varying vec2 vUv;
	uniform mat3 uvTransform;

#endif

void main() {

	#ifdef USE_POINTS_UV

		vUv = ( uvTransform * vec3( uv, 1 ) ).xy;

	#endif

	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>

	gl_PointSize = size;

	#ifdef USE_SIZEATTENUATION

		bool isPerspective = isPerspectiveMatrix( projectionMatrix );

		if ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );

	#endif

	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <fog_vertex>

}
`,Yu=`
uniform vec3 diffuse;
uniform float opacity;

#include <common>
#include <color_pars_fragment>
#include <map_particle_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>

void main() {

	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>

	vec3 outgoingLight = vec3( 0.0 );

	#include <logdepthbuf_fragment>
	#include <map_particle_fragment>
	#include <color_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>

	outgoingLight = diffuseColor.rgb;

	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>

}
`,Zu=`
#include <common>
#include <batching_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <shadowmap_pars_vertex>

void main() {

	#include <batching_vertex>

	#include <beginnormal_vertex>
	#include <morphinstance_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>

	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>

	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>

}
`,qu=`
uniform vec3 color;
uniform float opacity;

#include <common>
#include <packing>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <logdepthbuf_pars_fragment>
#include <shadowmap_pars_fragment>
#include <shadowmask_pars_fragment>

void main() {

	#include <logdepthbuf_fragment>

	gl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );

	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>

}
`,Ku=`
uniform float rotation;
uniform vec2 center;

#include <common>
#include <uv_pars_vertex>
#include <fog_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>

void main() {

	#include <uv_vertex>

	vec4 mvPosition = modelViewMatrix[ 3 ];

	vec2 scale = vec2( length( modelMatrix[ 0 ].xyz ), length( modelMatrix[ 1 ].xyz ) );

	#ifndef USE_SIZEATTENUATION

		bool isPerspective = isPerspectiveMatrix( projectionMatrix );

		if ( isPerspective ) scale *= - mvPosition.z;

	#endif

	vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;

	vec2 rotatedPosition;
	rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
	rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;

	mvPosition.xy += rotatedPosition;

	gl_Position = projectionMatrix * mvPosition;

	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>

}
`,Ju=`
uniform vec3 diffuse;
uniform float opacity;

#include <common>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>

void main() {

	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>

	vec3 outgoingLight = vec3( 0.0 );

	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>

	outgoingLight = diffuseColor.rgb;

	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>

}
`,$u=`
#define LAMBERT

varying vec3 vViewPosition;
varying vec3 heatPosition;

// fengmap
varying float vIsPerspectiveCamera;

#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
#include <fengmap_mask_vertex1>

void main() {
	heatPosition = vec3(modelMatrix * vec4( position, 1.0 ));
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>

	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>

	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fengmap_mask_vertex2>

	vViewPosition = - mvPosition.xyz;

	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>

	// fengmap
	vIsPerspectiveCamera = isPerspectiveMatrix( projectionMatrix ) ? 1.0 : 0.0;
}
`,Qu=`
#define LAMBERT

// fengmap
varying float vIsPerspectiveCamera;

varying vec3 heatPosition;
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
uniform bool mapMixColor;
uniform vec2 heatCenter;
uniform vec2 heatSize;

uniform bool isJsonModel;


#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <fengmap_lights_pars_begin>
#include <normal_pars_fragment>
#include <fengmap_lights_lambert_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
#include <fengmap_mask_fragment1>

vec3 rgb2hsb(vec3 c) {
    float maxVal = max(c.r, max(c.g, c.b));
    float minVal = min(c.r, min(c.g, c.b));
    float delta = maxVal - minVal;

    float h = 0.0;
    if (delta > 0.0) {
        if (maxVal == c.r) {
            h = mod((c.g - c.b) / delta, 6.0);
        } else if (maxVal == c.g) {
            h = (c.b - c.r) / delta + 2.0;
        } else {
            h = (c.r - c.g) / delta + 4.0;
        }
        h /= 6.0; // Normalize to range [0,1]
    }

    float s = (maxVal == 0.0) ? 0.0 : delta / maxVal;
    float b = maxVal;

    return vec3(h, s, b);
}

vec3 hsb2rgb(vec3 c) {
    float h = c.x * 6.0;
    float s = c.y;
    float b = c.z;

    float i = floor(h);
    float f = h - i;
    float p = b * (1.0 - s);
    float q = b * (1.0 - f * s);
    float t = b * (1.0 - (1.0 - f) * s);

    if (i == 0.0) return vec3(b, t, p);
    if (i == 1.0) return vec3(q, b, p);
    if (i == 2.0) return vec3(p, b, t);
    if (i == 3.0) return vec3(p, q, b);
    if (i == 4.0) return vec3(t, p, b);
    return vec3(b, p, q);
}

void main() {

	vec4 diffuseColor = vec4( diffuse, opacity );

	#include <clipping_planes_fragment>
	#include <fengmap_mask_fragment2>

	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;

	#include <logdepthbuf_fragment>
	#include <fengmap_map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>

	// accumulation
	#include <lights_lambert_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>

	// modulation
	#include <aomap_fragment>

	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	#ifdef IGNORE_LIGHTING
	  if(vIsPerspectiveCamera == 0.0) {
			outgoingLight = diffuseColor.rgb;
		}
	#endif

	#ifdef USE_MODEL_SIDE_GRADIENT
		vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
		if (dot(vec3(0.0, 1.0, 0.0), worldNormal) < 0.8) {
			vec3 hsb = rgb2hsb(outgoingLight);
			hsb.y = clamp(hsb.y * 1.5, 0.0, 1.0);
			hsb.z = clamp(hsb.z * 0.8, 0.0, 1.0);
			outgoingLight = mix(hsb2rgb(hsb), outgoingLight, vUv.y);
		}
	#endif

	#include <envmap_fragment>
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}
`,tc=`
#define STANDARD

varying vec3 vViewPosition;

#ifdef USE_TRANSMISSION

	varying vec3 vWorldPosition;

#endif

#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
#include <fengmap_sweep_pars_common>
#include <fengmap_mask_vertex1>


void main() {

	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>

	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>

	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fengmap_mask_vertex2>

	vViewPosition = - mvPosition.xyz;

	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>

#ifdef USE_TRANSMISSION

	vWorldPosition = worldPosition.xyz;

#endif

	//fengmap
	#include <fengmap_sweep_vertex>
}
`,ec=`
#define STANDARD

#ifdef PHYSICAL
	#define IOR
	#define USE_SPECULAR
#endif

uniform vec3 diffuse;
uniform vec3 emissive;
uniform float roughness;
uniform float metalness;
uniform float opacity;

#ifdef IOR
	uniform float ior;
#endif

#ifdef USE_SPECULAR
	uniform float specularIntensity;
	uniform vec3 specularColor;

	#ifdef USE_SPECULAR_COLORMAP
		uniform sampler2D specularColorMap;
	#endif

	#ifdef USE_SPECULAR_INTENSITYMAP
		uniform sampler2D specularIntensityMap;
	#endif
#endif

#ifdef USE_CLEARCOAT
	uniform float clearcoat;
	uniform float clearcoatRoughness;
#endif

#ifdef USE_DISPERSION
	uniform float dispersion;
#endif

#ifdef USE_IRIDESCENCE
	uniform float iridescence;
	uniform float iridescenceIOR;
	uniform float iridescenceThicknessMinimum;
	uniform float iridescenceThicknessMaximum;
#endif

#ifdef USE_SHEEN
	uniform vec3 sheenColor;
	uniform float sheenRoughness;

	#ifdef USE_SHEEN_COLORMAP
		uniform sampler2D sheenColorMap;
	#endif

	#ifdef USE_SHEEN_ROUGHNESSMAP
		uniform sampler2D sheenRoughnessMap;
	#endif
#endif

#ifdef USE_ANISOTROPY
	uniform vec2 anisotropyVector;

	#ifdef USE_ANISOTROPYMAP
		uniform sampler2D anisotropyMap;
	#endif
#endif

varying vec3 vViewPosition;

#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <iridescence_fragment>
#include <cube_uv_reflection_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_physical_pars_fragment>
#include <fog_pars_fragment>
#include <fengmap_lights_pars_begin>
#include <normal_pars_fragment>
#include <fengmap_lights_physical_pars_fragment>
#include <transmission_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <clearcoat_pars_fragment>
#include <iridescence_pars_fragment>
#include <roughnessmap_pars_fragment>
#include <metalnessmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
#include <fengmap_mask_fragment1>
#include <fengmap_sweep_pars_common>
#include <fengmap_sweep_pars_fragment>

void main() {

	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	#include <fengmap_mask_fragment2>

	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;

	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <roughnessmap_fragment>
	#include <metalnessmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <clearcoat_normal_fragment_begin>
	#include <clearcoat_normal_fragment_maps>
	#include <emissivemap_fragment>

	// accumulation
	#include <lights_physical_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>

	// modulation
	#include <aomap_fragment>

	vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;
	vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;

	#include <transmission_fragment>

	vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;

	#ifdef USE_SHEEN

		// Sheen energy compensation approximation calculation can be found at the end of
		// https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing
		float sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );

		outgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;

	#endif

	#ifdef USE_CLEARCOAT

		float dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );

		vec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );

		outgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;

	#endif

	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
	#include <fengmap_sweep_fragment>
}
`,ic=`
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
#include <fengmap_mask_vertex1>

void main() {

	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>

	#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )

		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinbase_vertex>
		#include <skinnormal_vertex>
		#include <defaultnormal_vertex>

	#endif

	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fengmap_mask_vertex2>

	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <fog_vertex>

}
`,sc=`
uniform vec3 diffuse;
uniform float opacity;

#ifndef FLAT_SHADED

	varying vec3 vNormal;

#endif

#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
#include <fengmap_mask_fragment1>

void main() {

	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	#include <fengmap_mask_fragment2>

	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>

	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );

	// accumulation (baked indirect lighting only)
	#ifdef USE_LIGHTMAP

		vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );
		reflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;

	#else

		reflectedLight.indirectDiffuse += vec3( 1.0 );

	#endif

	// modulation
	#include <aomap_fragment>

	reflectedLight.indirectDiffuse *= diffuseColor.rgb;

	vec3 outgoingLight = reflectedLight.indirectDiffuse;

	#include <envmap_fragment>

	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>

}
`;var rc=`

struct PhysicalMaterial {

	vec3 diffuseColor;
	float roughness;
	vec3 specularColor;
	float specularF90;
	float dispersion;

	#ifdef USE_CLEARCOAT
		float clearcoat;
		float clearcoatRoughness;
		vec3 clearcoatF0;
		float clearcoatF90;
	#endif

	#ifdef USE_IRIDESCENCE
		float iridescence;
		float iridescenceIOR;
		float iridescenceThickness;
		vec3 iridescenceFresnel;
		vec3 iridescenceF0;
	#endif

	#ifdef USE_SHEEN
		vec3 sheenColor;
		float sheenRoughness;
	#endif

	#ifdef IOR
		float ior;
	#endif

	#ifdef USE_TRANSMISSION
		float transmission;
		float transmissionAlpha;
		float thickness;
		float attenuationDistance;
		vec3 attenuationColor;
	#endif

	#ifdef USE_ANISOTROPY
		float anisotropy;
		float alphaT;
		vec3 anisotropyT;
		vec3 anisotropyB;
	#endif

};

// temporary
vec3 clearcoatSpecularDirect = vec3( 0.0 );
vec3 clearcoatSpecularIndirect = vec3( 0.0 );
vec3 sheenSpecularDirect = vec3( 0.0 );
vec3 sheenSpecularIndirect = vec3(0.0 );

vec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {
    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );
    float x2 = x * x;
    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );

    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );
}

// Moving Frostbite to Physically Based Rendering 3.0 - page 12, listing 2
// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf
float V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {

	float a2 = pow2( alpha );

	float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );
	float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );

	return 0.5 / max( gv + gl, EPSILON );

}

// Microfacet Models for Refraction through Rough Surfaces - equation (33)
// http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html
// alpha is "roughness squared" in Disneys reparameterization
float D_GGX( const in float alpha, const in float dotNH ) {

	float a2 = pow2( alpha );

	float denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0; // avoid alpha = 0 with dotNH = 1

	return RECIPROCAL_PI * a2 / pow2( denom );

}

// https://google.github.io/filament/Filament.md.html#materialsystem/anisotropicmodel/anisotropicspecularbrdf
#ifdef USE_ANISOTROPY

	float V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {

		float gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );
		float gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );
		float v = 0.5 / ( gv + gl );

		return saturate(v);

	}

	float D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {

		float a2 = alphaT * alphaB;
		highp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );
		highp float v2 = dot( v, v );
		float w2 = a2 / v2;

		return RECIPROCAL_PI * a2 * pow2 ( w2 );

	}

#endif

#ifdef USE_CLEARCOAT

	// GGX Distribution, Schlick Fresnel, GGX_SmithCorrelated Visibility
	vec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {

		vec3 f0 = material.clearcoatF0;
		float f90 = material.clearcoatF90;
		float roughness = material.clearcoatRoughness;

		float alpha = pow2( roughness ); // UE4's roughness

		vec3 halfDir = normalize( lightDir + viewDir );

		float dotNL = saturate( dot( normal, lightDir ) );
		float dotNV = saturate( dot( normal, viewDir ) );
		float dotNH = saturate( dot( normal, halfDir ) );
		float dotVH = saturate( dot( viewDir, halfDir ) );

		vec3 F = F_Schlick( f0, f90, dotVH );

		float V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );

		float D = D_GGX( alpha, dotNH );

		return F * ( V * D );

	}

#endif

vec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {

	vec3 f0 = material.specularColor;
	float f90 = material.specularF90;
	float roughness = material.roughness;

	float alpha = pow2( roughness ); // UE4's roughness

	vec3 halfDir = normalize( lightDir + viewDir );

	float dotNL = saturate( dot( normal, lightDir ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );
	float dotVH = saturate( dot( viewDir, halfDir ) );

	vec3 F = F_Schlick( f0, f90, dotVH );

	#ifdef USE_IRIDESCENCE

		F = mix( F, material.iridescenceFresnel, material.iridescence );

	#endif

	#ifdef USE_ANISOTROPY

		float dotTL = dot( material.anisotropyT, lightDir );
		float dotTV = dot( material.anisotropyT, viewDir );
		float dotTH = dot( material.anisotropyT, halfDir );
		float dotBL = dot( material.anisotropyB, lightDir );
		float dotBV = dot( material.anisotropyB, viewDir );
		float dotBH = dot( material.anisotropyB, halfDir );

		float V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );

		float D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );

	#else

		float V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );

		float D = D_GGX( alpha, dotNH );

	#endif

	return F * ( V * D );

}

// Rect Area Light

// Real-Time Polygonal-Light Shading with Linearly Transformed Cosines
// by Eric Heitz, Jonathan Dupuy, Stephen Hill and David Neubelt
// code: https://github.com/selfshadow/ltc_code/

vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {

	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;

	float dotNV = saturate( dot( N, V ) );

	// texture parameterized by sqrt( GGX alpha ) and sqrt( 1 - cos( theta ) )
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );

	uv = uv * LUT_SCALE + LUT_BIAS;

	return uv;

}

float LTC_ClippedSphereFormFactor( const in vec3 f ) {

	// Real-Time Area Lighting: a Journey from Research to Production (p.102)
	// An approximation of the form factor of a horizon-clipped rectangle.

	float l = length( f );

	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );

}

vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {

	float x = dot( v1, v2 );

	float y = abs( x );

	// rational polynomial approximation to theta / sin( theta ) / 2PI
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;

	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;

	return cross( v1, v2 ) * theta_sintheta;

}

vec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {

	// bail if point is on back side of plane of light
	// assumes ccw winding order of light vertices
	vec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];
	vec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];
	vec3 lightNormal = cross( v1, v2 );

	if( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );

	// construct orthonormal basis around N
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 = - cross( N, T1 ); // negated from paper; possibly due to a different handedness of world coordinate system

	// compute transform
	mat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );

	// transform rect
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords[ 0 ] - P );
	coords[ 1 ] = mat * ( rectCoords[ 1 ] - P );
	coords[ 2 ] = mat * ( rectCoords[ 2 ] - P );
	coords[ 3 ] = mat * ( rectCoords[ 3 ] - P );

	// project rect onto sphere
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );

	// calculate vector form factor
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );

	// adjust for horizon clipping
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );

/*
	// alternate method of adjusting for horizon clipping (see referece)
	// refactoring required
	float len = length( vectorFormFactor );
	float z = vectorFormFactor.z / len;

	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;

	// tabulated horizon-clipped sphere, apparently...
	vec2 uv = vec2( z * 0.5 + 0.5, len );
	uv = uv * LUT_SCALE + LUT_BIAS;

	float scale = texture2D( ltc_2, uv ).w;

	float result = len * scale;
*/

	return vec3( result );

}

// End Rect Area Light

#if defined( USE_SHEEN )

// https://github.com/google/filament/blob/master/shaders/src/brdf.fs
float D_Charlie( float roughness, float dotNH ) {

	float alpha = pow2( roughness );

	// Estevez and Kulla 2017, "Production Friendly Microfacet Sheen BRDF"
	float invAlpha = 1.0 / alpha;
	float cos2h = dotNH * dotNH;
	float sin2h = max( 1.0 - cos2h, 0.0078125 ); // 2^(-14/2), so sin2h^2 > 0 in fp16

	return ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );

}

// https://github.com/google/filament/blob/master/shaders/src/brdf.fs
float V_Neubelt( float dotNV, float dotNL ) {

	// Neubelt and Pettineo 2013, "Crafting a Next-gen Material Pipeline for The Order: 1886"
	return saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );

}

vec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {

	vec3 halfDir = normalize( lightDir + viewDir );

	float dotNL = saturate( dot( normal, lightDir ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );

	float D = D_Charlie( sheenRoughness, dotNH );
	float V = V_Neubelt( dotNV, dotNL );

	return sheenColor * ( D * V );

}

#endif

// This is a curve-fit approxmation to the "Charlie sheen" BRDF integrated over the hemisphere from
// Estevez and Kulla 2017, "Production Friendly Microfacet Sheen BRDF". The analysis can be found
// in the Sheen section of https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing
float IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {

	float dotNV = saturate( dot( normal, viewDir ) );

	float r2 = roughness * roughness;

	float a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;

	float b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;

	float DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );

	return saturate( DG * RECIPROCAL_PI );

}

// Analytical approximation of the DFG LUT, one half of the
// split-sum approximation used in indirect specular lighting.
// via 'environmentBRDF' from "Physically Based Shading on Mobile"
// https://www.unrealengine.com/blog/physically-based-shading-on-mobile
vec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {

	float dotNV = saturate( dot( normal, viewDir ) );

	const vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );

	const vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );

	vec4 r = roughness * c0 + c1;

	float a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;

	vec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;

	return fab;

}

vec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {

	vec2 fab = DFGApprox( normal, viewDir, roughness );

	return specularColor * fab.x + specularF90 * fab.y;

}

// Fdez-Agera's "Multiple-Scattering Microfacet Model for Real-Time Image Based Lighting"
// Approximates multiscattering in order to preserve energy.
// http://www.jcgt.org/published/0008/01/03/
#ifdef USE_IRIDESCENCE
void computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
#else
void computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
#endif

	vec2 fab = DFGApprox( normal, viewDir, roughness );

	#ifdef USE_IRIDESCENCE

		vec3 Fr = mix( specularColor, iridescenceF0, iridescence );

	#else

		vec3 Fr = specularColor;

	#endif

	vec3 FssEss = Fr * fab.x + specularF90 * fab.y;

	float Ess = fab.x + fab.y;
	float Ems = 1.0 - Ess;

	vec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619; // 1/21
	vec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );

	singleScatter += FssEss;
	multiScatter += Fms * Ems;

}

#if NUM_RECT_AREA_LIGHTS > 0

	void RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {

		vec3 normal = geometryNormal;
		vec3 viewDir = geometryViewDir;
		vec3 position = geometryPosition;
		vec3 lightPos = rectAreaLight.position;
		vec3 halfWidth = rectAreaLight.halfWidth;
		vec3 halfHeight = rectAreaLight.halfHeight;
		vec3 lightColor = rectAreaLight.color;
		float roughness = material.roughness;

		vec3 rectCoords[ 4 ];
		rectCoords[ 0 ] = lightPos + halfWidth - halfHeight; // counterclockwise; light shines in local neg z direction
		rectCoords[ 1 ] = lightPos - halfWidth - halfHeight;
		rectCoords[ 2 ] = lightPos - halfWidth + halfHeight;
		rectCoords[ 3 ] = lightPos + halfWidth + halfHeight;

		vec2 uv = LTC_Uv( normal, viewDir, roughness );

		vec4 t1 = texture2D( ltc_1, uv );
		vec4 t2 = texture2D( ltc_2, uv );

		mat3 mInv = mat3(
			vec3( t1.x, 0, t1.y ),
			vec3(    0, 1,    0 ),
			vec3( t1.z, 0, t1.w )
		);

		// LTC Fresnel Approximation by Stephen Hill
		// http://blog.selfshadow.com/publications/s2016-advances/s2016_ltc_fresnel.pdf
		vec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );

		reflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );

		reflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );

	}

#endif

void RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {

	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );

	vec3 irradiance = dotNL * directLight.color;
	#ifndef PHYSICALLY_CORRECT_LIGHTS

			irradiance *= PI; // punctual light


	#endif
	#ifdef USE_CLEARCOAT

		float dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );

		vec3 ccIrradiance = dotNLcc * directLight.color;

		clearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );

	#endif

	#ifdef USE_SHEEN

		sheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );

	#endif

	reflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );

	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}

void RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {

	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );

}

void RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {

	#ifdef USE_CLEARCOAT

		clearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );

	#endif

	#ifdef USE_SHEEN

		sheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );

	#endif

	// Both indirect specular and indirect diffuse light accumulate here

	vec3 singleScattering = vec3( 0.0 );
	vec3 multiScattering = vec3( 0.0 );
	vec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;

	#ifdef USE_IRIDESCENCE

		computeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );

	#else

		computeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );

	#endif

	vec3 totalScattering = singleScattering + multiScattering;
	vec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );

	reflectedLight.indirectSpecular += radiance * singleScattering;
	reflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;

	reflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;

}

#define RE_Direct				RE_Direct_Physical
#define RE_Direct_RectArea		RE_Direct_RectArea_Physical
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Physical
#define RE_IndirectSpecular		RE_IndirectSpecular_Physical

// ref: https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf
float computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {

	return saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );

}
`,nc=`
uniform bool receiveShadow;
uniform vec3 ambientLightColor;

#if defined( USE_LIGHT_PROBES )

	uniform vec3 lightProbe[ 9 ];

#endif

// get the irradiance (radiance convolved with cosine lobe) at the point 'normal' on the unit sphere
// source: https://graphics.stanford.edu/papers/envmap/envmap.pdf
vec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {

	// normal is assumed to have unit length

	float x = normal.x, y = normal.y, z = normal.z;

	// band 0
	vec3 result = shCoefficients[ 0 ] * 0.886227;

	// band 1
	result += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;
	result += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;
	result += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;

	// band 2
	result += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;
	result += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;
	result += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );
	result += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;
	result += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );

	return result;

}

vec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {

	vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );

	vec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );

	return irradiance;

}

vec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {

	vec3 irradiance = ambientLightColor;
	#ifndef PHYSICALLY_CORRECT_LIGHTS
		irradiance *= PI;
	#endif
	return irradiance;

}

// fengmap r115
float punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {
    #if defined ( PHYSICALLY_CORRECT_LIGHTS )
        float distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );
        if( cutoffDistance > 0.0 ) {
            distanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );
        }
        return distanceFalloff;
    #else

        if( cutoffDistance > 0.0 && decayExponent > 0.0 ) {
            return pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );
        }
        return 1.0;
    #endif
}

float getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {

	// based upon Frostbite 3 Moving to Physically-based Rendering
	// page 32, equation 26: E[window1]
	// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf
	float distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );

	if ( cutoffDistance > 0.0 ) {

		distanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );

	}

	return distanceFalloff;

}

float getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {

	return smoothstep( coneCosine, penumbraCosine, angleCosine );

}

#if NUM_DIR_LIGHTS > 0

	struct DirectionalLight {
		vec3 direction;
		vec3 color;
	};

	uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];

	void getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {

		light.color = directionalLight.color;
		light.direction = directionalLight.direction;
		light.visible = true;

	}

#endif


#if NUM_POINT_LIGHTS > 0

	struct PointLight {
		vec3 position;
		vec3 color;
		float distance;
		float decay;
	};

	uniform PointLight pointLights[ NUM_POINT_LIGHTS ];

	// light is an out parameter as having it as a return value caused compiler errors on some devices
	void getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {

		vec3 lVector = pointLight.position - geometryPosition;

		light.direction = normalize( lVector );

		float lightDistance = length( lVector );

		light.color = pointLight.color;
		light.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );
		light.visible = ( light.color != vec3( 0.0 ) );

	}

#endif


#if NUM_SPOT_LIGHTS > 0

	struct SpotLight {
		vec3 position;
		vec3 direction;
		vec3 color;
		float distance;
		float decay;
		float coneCos;
		float penumbraCos;
	};

	uniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];

	// light is an out parameter as having it as a return value caused compiler errors on some devices
	void getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {

		vec3 lVector = spotLight.position - geometryPosition;

		light.direction = normalize( lVector );

		float angleCos = dot( light.direction, spotLight.direction );

		float spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );

		if ( spotAttenuation > 0.0 ) {

			float lightDistance = length( lVector );

			light.color = spotLight.color * spotAttenuation;
			light.color *= punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );
			light.visible = ( light.color != vec3( 0.0 ) );

		} else {

			light.color = vec3( 0.0 );
			light.visible = false;

		}

	}

#endif


#if NUM_RECT_AREA_LIGHTS > 0

	struct RectAreaLight {
		vec3 color;
		vec3 position;
		vec3 halfWidth;
		vec3 halfHeight;
	};

	// Pre-computed values of LinearTransformedCosine approximation of BRDF
	// BRDF approximation Texture is 64x64
	uniform sampler2D ltc_1; // RGBA Float
	uniform sampler2D ltc_2; // RGBA Float

	uniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];

#endif


#if NUM_HEMI_LIGHTS > 0

	struct HemisphereLight {
		vec3 direction;
		vec3 skyColor;
		vec3 groundColor;
	};

	uniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];

	vec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {

		float dotNL = dot( normal, hemiLight.direction );
		float hemiDiffuseWeight = 0.5 * dotNL + 0.5;

		vec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );

		return irradiance;

	}

#endif
`,ac=`
varying vec3 vViewPosition;

struct LambertMaterial {

	vec3 diffuseColor;
	float specularStrength;

};

void RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {

	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );
	vec3 irradiance = vec3(dotNL) * directLight.color;
	irradiance *= 3.1415926;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );

}

void RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {

	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );

}

#define RE_Direct				RE_Direct_Lambert
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Lambert
`,hc=`
#ifdef USE_MAP

vec4 sampledDiffuseColor = texture2D( map, vMapUv );
  bool needMultiply = true;
	if(!isJsonModel){
		if (vMapUv.x < 0.0 || vMapUv.x > 1.0 || vMapUv.y < 0.0 || vMapUv.y > 1.0) {
			sampledDiffuseColor = diffuseColor;
			needMultiply = false;
		}
	}
	

	#ifdef DECODE_VIDEO_TEXTURE
		// use inline sRGB decode until browsers properly support SRGB8_ALPHA8 with video textures (#26516)
		sampledDiffuseColor = vec4( mix( pow( sampledDiffuseColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), sampledDiffuseColor.rgb * 0.0773993808, vec3( lessThanEqual( sampledDiffuseColor.rgb, vec3( 0.04045 ) ) ) ), sampledDiffuseColor.w );
	#endif

	if(mapMixColor){
		vec2 uvHeat=vec2((heatPosition.x -  (heatCenter.x - heatSize.x/2.0)) / heatSize.x , (heatPosition.z - (heatCenter.y-heatSize.y/2.0)) / heatSize.y);
		vec4 heatColor=texture2D( map, uvHeat );
		diffuseColor = heatColor*heatColor.a + diffuseColor*(1.0-heatColor.a);
	} else if(needMultiply){
		diffuseColor *= sampledDiffuseColor;
	}
#endif
`,oc=`
if(isRect&&isEnable){
  vec2 v = vec2(v_position.x - moveP.x, v_position.z - moveP.y);
  if(isInRectW(v,se2N,sweepW) && isInRectH(v,se2RN,sweepH)){
    gl_FragColor = vec4(mix(gl_FragColor.rgb, sweepStrength*color_a.rgb, 0.5),gl_FragColor.a);
  }
}

if(isAnnulus&&isEnable){
  if(isMaxCircle(v_position.xyz,circleC,maxR) && isMinCircle(v_position.xyz,circleC,minR)){
    if(isSweepTexture){
      vec2 uv = vec2((v_position.x-(circleC.x-maxR))/(2.0*maxR),(v_position.z-(circleC.y-maxR))/(2.0*maxR));
      vec4 tex = texture2D( sweepTexture, uv );
      tex = mapTexelToLinear( tex );
      float d2 = pow(v_position.x-circleC.x,2.0) + pow(v_position.z-circleC.y,2.0);
      float a = smoothstep(0.0, pow(maxR,2.0), d2);
      a = 1.0 - a;
      tex.a = a;
      gl_FragColor = vec4(mix(gl_FragColor.rgb, sweepStrength*tex.rgb, 0.2),gl_FragColor.a);
    } else {
      gl_FragColor = vec4(mix(gl_FragColor.rgb, sweepStrength*color_a.rgb, 0.5),gl_FragColor.a);
    }
  }

}
`,lc=`
	uniform bool isRect;
	uniform bool isAnnulus;

	uniform float sweepW;
	uniform float sweepH;
	uniform vec2 se2N;
	uniform vec2 se2RN;
	uniform vec2 moveP;
	uniform vec3 color_r;

	uniform vec2 circleC;
	uniform float maxR;
	uniform float minR;
	uniform vec3 color_a;

	uniform bool isSweepTexture;
	uniform sampler2D sweepTexture;
	uniform float sweepStrength;

  uniform bool isEnable;

	bool isInRectW(vec2 v, vec2 a, float w){
		float a1 = abs(dot(v,a));
		return a1 < w;
	}

	bool isInRectH(vec2 v, vec2 a, float h){
		float a1 = abs(dot(v,a));
		return a1 < h;
	}

	bool isMaxCircle(vec3 a, vec2 b, float r){
		float c = pow((a.x-b.x),2.0)+pow((a.z-b.y),2.0);
		return c <= pow(r,2.0);
	}

	bool isMinCircle(vec3 a, vec2 b, float r){
		float c = pow((a.x-b.x),2.0)+pow((a.z-b.y),2.0);
		return c > pow(r,2.0);
	}

	vec4 mapTexelToLinear( vec4 value ) {
		return value;
	}
`,uc=`
 varying vec3 v_position;
`,cc=`
  v_position = vec3(modelMatrix * vec4( position, 1.0 ));
`,fc=`
    #if NUM_MASK_POLYGON > 0
        varying vec3 maskPosition;
    #endif
`,dc=`
    #if NUM_MASK_POLYGON > 0
        maskPosition = vec3(modelMatrix * vec4( position, 1.0 ));
    #endif
`,vc=`
    #if NUM_MASK_POLYGON > 0
        varying vec3 maskPosition;
        varying float v_positionHeight;
        uniform vec2 maskPolygons[ NUM_MASK_POLYGON ];
        uniform int maskType;
        uniform bool isMask;
        uniform float maskHeight;
        uniform float maskExtrudeHeight;
        uniform vec2 boundCenter;
	    uniform vec2 boundSize;
        uniform float maskOpacity;
        uniform float maskNodeHeight;
        bool isPointInsidePolygon(vec2 point,vec2 polygon2[NUM_MASK_POLYGON], int count) {
            if(count==1){
                return false;
            }
            if(count==2){
                return true;
            }
            <#ISPOINTINSIDEPOLYGON#>
        }
    #endif
     #if NUM_MASK_HOLE_POLYGON>0
        uniform vec2 maskHolePogygons[ NUM_MASK_HOLE_POLYGON ];
        bool isPointInsideHolePolygon(vec2 point,vec2 polygon2[NUM_MASK_HOLE_POLYGON], int count) {
            if(count==1){
                return false;
            }
            if(count==2){
                return true;
            }
            <#ISPOINTINSIDEHOLEPOLYGON#>
        }
     #endif
`,pc=`
    #if NUM_MASK_POLYGON > 0
    if(isMask){
            vec2 uvMesk=vec2((maskPosition.x -  (boundCenter.x - boundSize.x/2.0)) / boundSize.x , (maskPosition.z - (boundCenter.y-boundSize.y/2.0)) / boundSize.y);
            bool isDiscard=false;
    
            if(maskType==0){
                if(!isPointInsidePolygon(uvMesk,maskPolygons,NUM_MASK_POLYGON)){
                    isDiscard=true;            
                }
            } else {
                if(isPointInsidePolygon(uvMesk,maskPolygons,NUM_MASK_POLYGON)){
                    isDiscard=true;            
                }
            }
    
    #if NUM_MASK_HOLE_POLYGON > 0
        if(maskType==0){
            if(!isDiscard && isPointInsideHolePolygon(uvMesk,maskHolePogygons,NUM_MASK_HOLE_POLYGON)){
                isDiscard=true;            
            }
        } else {
            if(isDiscard && isPointInsideHolePolygon(uvMesk,maskHolePogygons,NUM_MASK_HOLE_POLYGON)){
                isDiscard=false;             
            }
        }
            
    #endif
        if(isDiscard){
            if(maskPosition.y >= maskNodeHeight + maskHeight && maskPosition.y <= maskNodeHeight + maskHeight + maskExtrudeHeight){
                if(maskOpacity == 0.0){
                    discard;
                } else {
                    diffuseColor.a = maskOpacity;
                }
            }
        }
    }
    #endif
`;let b={alphahash_fragment:wo,alphahash_pars_fragment:Mo,alphamap_fragment:yo,alphamap_pars_fragment:Eo,alphatest_fragment:xo,alphatest_pars_fragment:bo,aomap_fragment:So,aomap_pars_fragment:Ao,batching_pars_vertex:To,batching_vertex:Ro,begin_vertex:Lo,beginnormal_vertex:Co,bsdfs:No,iridescence_fragment:Io,bumpmap_pars_fragment:Po,clipping_planes_fragment:Do,clipping_planes_pars_fragment:Oo,clipping_planes_pars_vertex:Uo,clipping_planes_vertex:Fo,color_fragment:Bo,color_pars_fragment:ko,color_pars_vertex:Go,color_vertex:Ho,common:Vo,cube_uv_reflection_fragment:zo,defaultnormal_vertex:Wo,displacementmap_pars_vertex:jo,displacementmap_vertex:Xo,emissivemap_fragment:Yo,emissivemap_pars_fragment:Zo,colorspace_fragment:qo,colorspace_pars_fragment:Ko,envmap_fragment:Jo,envmap_common_pars_fragment:$o,envmap_pars_fragment:Qo,envmap_pars_vertex:tl,envmap_physical_pars_fragment:cl,envmap_vertex:el,fog_vertex:il,fog_pars_vertex:sl,fog_fragment:rl,fog_pars_fragment:nl,gradientmap_pars_fragment:al,lightmap_pars_fragment:hl,lights_lambert_fragment:ol,lights_lambert_pars_fragment:ll,lights_pars_begin:ul,lights_toon_fragment:fl,lights_toon_pars_fragment:dl,lights_phong_fragment:vl,lights_phong_pars_fragment:pl,lights_physical_fragment:ml,lights_physical_pars_fragment:gl,lights_fragment_begin:_l,lights_fragment_maps:wl,lights_fragment_end:Ml,logdepthbuf_fragment:yl,logdepthbuf_pars_fragment:El,logdepthbuf_pars_vertex:xl,logdepthbuf_vertex:bl,map_fragment:Sl,map_pars_fragment:Al,map_particle_fragment:Tl,map_particle_pars_fragment:Rl,metalnessmap_fragment:Ll,metalnessmap_pars_fragment:Cl,morphinstance_vertex:Nl,morphcolor_vertex:Il,morphnormal_vertex:Pl,morphtarget_pars_vertex:Dl,morphtarget_vertex:Ol,normal_fragment_begin:Ul,normal_fragment_maps:Fl,normal_pars_fragment:Bl,normal_pars_vertex:kl,normal_vertex:Gl,normalmap_pars_fragment:Hl,clearcoat_normal_fragment_begin:Vl,clearcoat_normal_fragment_maps:zl,clearcoat_pars_fragment:Wl,iridescence_pars_fragment:jl,opaque_fragment:Xl,packing:Yl,premultiplied_alpha_fragment:Zl,project_vertex:ql,dithering_fragment:Kl,dithering_pars_fragment:Jl,roughnessmap_fragment:$l,roughnessmap_pars_fragment:Ql,shadowmap_pars_fragment:tu,shadowmap_pars_vertex:eu,shadowmap_vertex:iu,shadowmask_pars_fragment:su,skinbase_vertex:ru,skinning_pars_vertex:nu,skinning_vertex:au,skinnormal_vertex:hu,specularmap_fragment:ou,specularmap_pars_fragment:lu,tonemapping_fragment:uu,tonemapping_pars_fragment:cu,transmission_fragment:fu,transmission_pars_fragment:du,uv_pars_fragment:vu,uv_pars_vertex:pu,uv_vertex:mu,worldpos_vertex:gu,fengmap_map_fragment:hc,fengmap_lights_pars_begin:nc,fengmap_lights_lambert_pars_fragment:ac,fengmap_lights_physical_pars_fragment:rc,fengmap_sweep_fragment:oc,fengmap_sweep_pars_fragment:lc,fengmap_sweep_pars_common:uc,fengmap_sweep_vertex:cc,fengmap_mask_vertex1:fc,fengmap_mask_vertex2:dc,fengmap_mask_fragment1:vc,fengmap_mask_fragment2:pc,background_vert:_u,background_frag:wu,backgroundCube_vert:Mu,backgroundCube_frag:yu,cube_vert:Eu,cube_frag:xu,depth_vert:bu,depth_frag:Su,distanceRGBA_vert:Au,distanceRGBA_frag:Tu,equirect_vert:Ru,equirect_frag:Lu,linedashed_vert:Cu,linedashed_frag:Nu,meshbasic_vert:Iu,meshbasic_frag:Pu,meshlambert_vert:Du,meshlambert_frag:Ou,meshmatcap_vert:Uu,meshmatcap_frag:Fu,meshnormal_vert:Bu,meshnormal_frag:ku,meshphong_vert:Gu,meshphong_frag:Hu,meshphysical_vert:Vu,meshphysical_frag:zu,meshtoon_vert:Wu,meshtoon_frag:ju,points_vert:Xu,points_frag:Yu,shadow_vert:Zu,shadow_frag:qu,sprite_vert:Ku,sprite_frag:Ju,fmMeshlambert_vert:$u,fmMeshlambert_frag:Qu,fmMeshphysical_vert:tc,fmMeshphysical_frag:ec,fmMeshBasic_vert:ic,fmMeshBasic_frag:sc},P={common:{diffuse:{value:new Wt(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new _},alphaMap:{value:null},alphaMapTransform:{value:new _},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new _}},envmap:{envMap:{value:null},envMapRotation:{value:new _},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new _}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new _}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new _},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new _},normalScale:{value:new ct(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new _},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new _}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new _}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new _}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Wt(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Wt(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new _},alphaTest:{value:0},uvTransform:{value:new _}},sprite:{diffuse:{value:new Wt(16777215)},opacity:{value:1},center:{value:new ct(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new _},alphaMap:{value:null},alphaMapTransform:{value:new _},alphaTest:{value:0}}},mc={basic:{uniforms:Fh([P.common,P.specularmap,P.envmap,P.aomap,P.lightmap,P.fog]),vertexShader:b.meshbasic_vert,fragmentShader:b.meshbasic_frag},lambert:{uniforms:Fh([P.common,P.specularmap,P.envmap,P.aomap,P.lightmap,P.emissivemap,P.bumpmap,P.normalmap,P.displacementmap,P.fog,P.lights,{emissive:{value:new Wt(0)}}]),vertexShader:b.meshlambert_vert,fragmentShader:b.meshlambert_frag},phong:{uniforms:Fh([P.common,P.specularmap,P.envmap,P.aomap,P.lightmap,P.emissivemap,P.bumpmap,P.normalmap,P.displacementmap,P.fog,P.lights,{emissive:{value:new Wt(0)},specular:{value:new Wt(1118481)},shininess:{value:30}}]),vertexShader:b.meshphong_vert,fragmentShader:b.meshphong_frag},standard:{uniforms:Fh([P.common,P.envmap,P.aomap,P.lightmap,P.emissivemap,P.bumpmap,P.normalmap,P.displacementmap,P.roughnessmap,P.metalnessmap,P.fog,P.lights,{emissive:{value:new Wt(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:b.meshphysical_vert,fragmentShader:b.meshphysical_frag},toon:{uniforms:Fh([P.common,P.aomap,P.lightmap,P.emissivemap,P.bumpmap,P.normalmap,P.displacementmap,P.gradientmap,P.fog,P.lights,{emissive:{value:new Wt(0)}}]),vertexShader:b.meshtoon_vert,fragmentShader:b.meshtoon_frag},matcap:{uniforms:Fh([P.common,P.bumpmap,P.normalmap,P.displacementmap,P.fog,{matcap:{value:null}}]),vertexShader:b.meshmatcap_vert,fragmentShader:b.meshmatcap_frag},points:{uniforms:Fh([P.points,P.fog]),vertexShader:b.points_vert,fragmentShader:b.points_frag},dashed:{uniforms:Fh([P.common,P.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:b.linedashed_vert,fragmentShader:b.linedashed_frag},depth:{uniforms:Fh([P.common,P.displacementmap]),vertexShader:b.depth_vert,fragmentShader:b.depth_frag},normal:{uniforms:Fh([P.common,P.bumpmap,P.normalmap,P.displacementmap,{opacity:{value:1}}]),vertexShader:b.meshnormal_vert,fragmentShader:b.meshnormal_frag},sprite:{uniforms:Fh([P.sprite,P.fog]),vertexShader:b.sprite_vert,fragmentShader:b.sprite_frag},background:{uniforms:{uvTransform:{value:new _},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:b.background_vert,fragmentShader:b.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1},backgroundRotation:{value:new _}},vertexShader:b.backgroundCube_vert,fragmentShader:b.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:b.cube_vert,fragmentShader:b.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:b.equirect_vert,fragmentShader:b.equirect_frag},distanceRGBA:{uniforms:Fh([P.common,P.displacementmap,{referencePosition:{value:new Gt},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:b.distanceRGBA_vert,fragmentShader:b.distanceRGBA_frag},shadow:{uniforms:Fh([P.lights,P.fog,{color:{value:new Wt(0)},opacity:{value:1}}]),vertexShader:b.shadow_vert,fragmentShader:b.shadow_frag}},gc=(mc.physical={uniforms:Fh([mc.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new _},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new _},clearcoatNormalScale:{value:new ct(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new _},dispersion:{value:0},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new _},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new _},sheen:{value:0},sheenColor:{value:new Wt(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new _},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new _},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new _},transmissionSamplerSize:{value:new ct},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new _},attenuationDistance:{value:0},attenuationColor:{value:new Wt(0)},specularColor:{value:new Wt(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new _},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new _},anisotropyVector:{value:new ct},anisotropyMap:{value:null},anisotropyMapTransform:{value:new _}}]),vertexShader:b.meshphysical_vert,fragmentShader:b.meshphysical_frag},mc.fmStandard={uniforms:Fh([mc.standard.uniforms,{sweepW:{value:0},sweepH:{value:0},se2N:{value:new ct(0,0)},se2RN:{value:new ct(0,0)},moveP:{value:new ct(0,0)},color_r:{value:new Wt(16711935)},color_a:{value:new Wt(16776960)},isRect:{value:!1},isAnnulus:{value:!1},isEnable:{value:!1},circleC:{value:new ct(0,0)},maxR:{value:0},minR:{value:0},isSweepTexture:{value:!1},sweepTexture:{value:null},sweepStrength:{value:1}},{isMask:{value:!1}},{maskType:{value:0}},{maskPolygons:{value:[]}},{maskHolePogygons:{value:[]}},{maskHeight:{value:0}},{maskExtrudeHeight:{value:0}},{boundCenter:{value:null}},{boundSize:{value:null}},{maskOpacity:{value:null}},{maskNodeHeight:{value:0}}]),vertexShader:b.fmMeshphysical_vert,fragmentShader:b.fmMeshphysical_frag},mc.fmLambert={uniforms:Fh([mc.lambert.uniforms,{mapMixColor:{value:!1}},{heatCenter:{value:new ct(0,0)}},{heatSize:{value:new ct(0,0)}},{isMask:{value:!1}},{maskType:{value:0}},{maskPolygons:{value:[]}},{maskHolePogygons:{value:[]}},{maskHeight:{value:0}},{maskExtrudeHeight:{value:0}},{boundCenter:{value:null}},{boundSize:{value:null}},{maskOpacity:{value:null}},{maskNodeHeight:{value:0}},{isJsonModel:{value:!1}}]),vertexShader:b.fmMeshlambert_vert,fragmentShader:b.fmMeshlambert_frag},mc.fmbasic={uniforms:Fh([mc.basic.uniforms,{isMask:{value:!1}},{maskType:{value:0}},{maskPolygons:{value:[]}},{maskHolePogygons:{value:[]}},{maskHeight:{value:0}},{maskExtrudeHeight:{value:0}},{boundCenter:{value:null}},{boundSize:{value:null}},{maskNodeHeight:{value:0}},{maskOpacity:{value:null}}]),vertexShader:b.fmMeshBasic_vert,fragmentShader:b.fmMeshBasic_frag},{r:0,b:0,g:0}),_c=new Ps,wc=new Ht;function Mc(s,i,r,n,a,t,h){let o=new Wt(0),l=!0===t?0:1,u,c,f=null,d=0,v=null;function p(t){let e=!0===t.isScene?t.background:null;return e&&e.isTexture&&(t=0<t.backgroundBlurriness,e=(t?r:i).get(e)),e}function m(t,e){t.getRGB(gc,kh(s)),n.buffers.color.setClear(gc.r,gc.g,gc.b,e,h)}return{getClearColor:function(){return o},setClearColor:function(t,e=1){o.set(t),l=e,m(o,l)},getClearAlpha:function(){return l},setClearAlpha:function(t){l=t,m(o,l)},render:function(t){let e=!1;null===(t=p(t))?m(o,l):t&&t.isColor&&(m(t,1),e=!0),"additive"===(t=s.xr.getEnvironmentBlendMode())?n.buffers.color.setClear(0,0,0,1,h):"alpha-blend"===t&&n.buffers.color.setClear(0,0,0,0,h),(s.autoClear||e)&&(n.buffers.depth.setTest(!0),n.buffers.depth.setMask(!0),n.buffers.color.setMask(!0),s.clear(s.autoClearColor,s.autoClearDepth,s.autoClearStencil))},addToRenderList:function(t,e){var i=p(e);i&&(i.isCubeTexture||i.mapping===Ft)?(void 0===c&&((c=new L(new Ih(1,1,1),new zh({name:"BackgroundCubeMaterial",uniforms:Uh(mc.backgroundCube.uniforms),vertexShader:mc.backgroundCube.vertexShader,fragmentShader:mc.backgroundCube.fragmentShader,side:Yt,depthTest:!1,depthWrite:!1,fog:!1}))).geometry.deleteAttribute("normal"),c.geometry.deleteAttribute("uv"),c.onBeforeRender=function(t,e,i){this.matrixWorld.copyPosition(i.matrixWorld)},Object.defineProperty(c.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),a.update(c)),_c.copy(e.backgroundRotation),_c.x*=-1,_c.y*=-1,_c.z*=-1,i.isCubeTexture&&!1===i.isRenderTargetTexture&&(_c.y*=-1,_c.z*=-1),c.material.uniforms.envMap.value=i,c.material.uniforms.flipEnvMap.value=i.isCubeTexture&&!1===i.isRenderTargetTexture?-1:1,c.material.uniforms.backgroundBlurriness.value=e.backgroundBlurriness,c.material.uniforms.backgroundIntensity.value=e.backgroundIntensity,c.material.uniforms.backgroundRotation.value.setFromMatrix4(wc.makeRotationFromEuler(_c)),c.material.toneMapped=zt.getTransfer(i.colorSpace)!==Li,f===i&&d===i.version&&v===s.toneMapping||(c.material.needsUpdate=!0,f=i,d=i.version,v=s.toneMapping),c.layers.enableAll(),t.unshift(c,c.geometry,c.material,0,0,null)):i&&i.isTexture&&(void 0===u&&((u=new L(new Ph(2,2),new zh({name:"BackgroundMaterial",uniforms:Uh(mc.background.uniforms),vertexShader:mc.background.vertexShader,fragmentShader:mc.background.fragmentShader,side:Xt,depthTest:!1,depthWrite:!1,fog:!1}))).geometry.deleteAttribute("normal"),Object.defineProperty(u.material,"map",{get:function(){return this.uniforms.t2D.value}}),a.update(u)),u.material.uniforms.t2D.value=i,u.material.uniforms.backgroundIntensity.value=e.backgroundIntensity,u.material.toneMapped=zt.getTransfer(i.colorSpace)!==Li,!0===i.matrixAutoUpdate&&i.updateMatrix(),u.material.uniforms.uvTransform.value.copy(i.matrix),f===i&&d===i.version&&v===s.toneMapping||(u.material.needsUpdate=!0,f=i,d=i.version,v=s.toneMapping),u.layers.enableAll(),t.unshift(u,u.geometry,u.material,0,0,null))}}}function yc(L,C){let r=L.getParameter(L.MAX_VERTEX_ATTRIBS),N={},t=O(null),I=t,P=!1;function D(t){L.bindVertexArray(t)}function n(t){L.deleteVertexArray(t)}function O(t){var e=[],i=[],s=[];for(let t=0;t<r;t++)e[t]=0,i[t]=0,s[t]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:e,enabledAttributes:i,attributeDivisors:s,object:t,attributes:{},index:null}}function U(){var i=I.newAttributes;for(let t=0,e=i.length;t<e;t++)i[t]=0}function F(t){B(t,0)}function B(t,e){var i=I.newAttributes,s=I.enabledAttributes,r=I.attributeDivisors;i[t]=1,0===s[t]&&(L.enableVertexAttribArray(t),s[t]=1),r[t]!==e&&(L.vertexAttribDivisor(t,e),r[t]=e)}function k(){var i=I.newAttributes,s=I.enabledAttributes;for(let t=0,e=s.length;t<e;t++)s[t]!==i[t]&&(L.disableVertexAttribArray(t),s[t]=0)}function G(t,e,i,s,r,n,a){!0===a?L.vertexAttribIPointer(t,e,i,r,n):L.vertexAttribPointer(t,e,i,s,r,n)}function a(){e(),P=!0,I!==t&&D((I=t).object)}function e(){t.geometry=null,t.program=null,t.wireframe=!1}return{setup:function(r,t,n,a,h){var e=((t,e,i)=>{let s=!0===i.wireframe,r=N[t.id],n=(void 0===r&&(r={},N[t.id]=r),r[e.id]),a=(void 0===n&&(n={},r[e.id]=n),n[s]);return void 0===a&&(a=O(L.createVertexArray()),n[s]=a),a})(a,n,t);if(I!==e&&D((I=e).object),e=((e,t,i,s)=>{let r=I.attributes,n=t.attributes,a=0,h=i.getAttributes();for(var o in h)if(0<=h[o].location){var l=r[o];let t=n[o];if(void 0===t&&("instanceMatrix"===o&&e.instanceMatrix&&(t=e.instanceMatrix),"instanceColor"===o)&&e.instanceColor&&(t=e.instanceColor),void 0===l)return!0;if(l.attribute!==t)return!0;if(t&&l.data!==t.data)return!0;a++}return I.attributesNum!==a||I.index!==s})(r,a,n,h)){var o,l=r,u=n,c=h;let e={},i=a.attributes,s=0,t=u.getAttributes();for(o in t)if(0<=t[o].location){let t=i[o];void 0===t&&("instanceMatrix"===o&&l.instanceMatrix&&(t=l.instanceMatrix),"instanceColor"===o)&&l.instanceColor&&(t=l.instanceColor);var f={};(f.attribute=t)&&t.data&&(f.data=t.data),e[o]=f,s++}I.attributes=e,I.attributesNum=s,I.index=c}if(null!==h&&C.update(h,L.ELEMENT_ARRAY_BUFFER),e||P){P=!1;var i=r,u=t,c=n,s=a;U();var d,v=s.attributes,p=c.getAttributes(),m=u.defaultAttributeValues;for(d in p){var g=p[d];if(0<=g.location){let e=v[d];if(void 0!==(e=void 0===e&&("instanceMatrix"===d&&i.instanceMatrix&&(e=i.instanceMatrix),"instanceColor"===d)&&i.instanceColor?i.instanceColor:e)){var _=e.normalized,w=e.itemSize,M=C.get(e);if(void 0!==M){var y=M.buffer,E=M.type,x=M.bytesPerElement,b=E===L.INT||E===L.UNSIGNED_INT||e.gpuType===he;if(e.isInterleavedBufferAttribute){var S=e.data,A=S.stride,T=e.offset;if(S.isInstancedInterleavedBuffer){for(let t=0;t<g.locationSize;t++)B(g.location+t,S.meshPerAttribute);!0!==i.isInstancedMesh&&void 0===s.L&&(s.L=S.meshPerAttribute*S.count)}else for(let t=0;t<g.locationSize;t++)F(g.location+t);L.bindBuffer(L.ARRAY_BUFFER,y);for(let t=0;t<g.locationSize;t++)G(g.location+t,w/g.locationSize,E,_,A*x,(T+w/g.locationSize*t)*x,b)}else{if(e.isInstancedBufferAttribute){for(let t=0;t<g.locationSize;t++)B(g.location+t,e.meshPerAttribute);!0!==i.isInstancedMesh&&void 0===s.L&&(s.L=e.meshPerAttribute*e.count)}else for(let t=0;t<g.locationSize;t++)F(g.location+t);L.bindBuffer(L.ARRAY_BUFFER,y);for(let t=0;t<g.locationSize;t++)G(g.location+t,w/g.locationSize,E,_,w*x,w/g.locationSize*t*x,b)}}}else if(void 0!==m){var R=m[d];if(void 0!==R)switch(R.length){case 2:L.vertexAttrib2fv(g.location,R);break;case 3:L.vertexAttrib3fv(g.location,R);break;case 4:L.vertexAttrib4fv(g.location,R);break;default:L.vertexAttrib1fv(g.location,R)}}}}k(),null!==h&&L.bindBuffer(L.ELEMENT_ARRAY_BUFFER,C.get(h).buffer)}},reset:a,resetDefaultState:e,dispose:function(){for(var t in a(),N){var e,i=N[t];for(e in i){var s,r=i[e];for(s in r)n(r[s].object),delete r[s];delete i[e]}delete N[t]}},releaseStatesOfGeometry:function(t){if(void 0!==N[t.id]){var e,i=N[t.id];for(e in i){var s,r=i[e];for(s in r)n(r[s].object),delete r[s];delete i[e]}delete N[t.id]}},releaseStatesOfProgram:function(t){for(var e in N){e=N[e];if(void 0!==e[t.id]){var i,s=e[t.id];for(i in s)n(s[i].object),delete s[i];delete e[t.id]}}},initAttributes:U,enableAttribute:F,disableUnusedAttributes:k}}function Ec(s,a,h){let o;function e(t,e,i){0!==i&&(s.drawArraysInstanced(o,t,e,i),h.update(e,o,i))}this.setMode=function(t){o=t},this.render=function(t,e){s.drawArrays(o,t,e),h.update(e,o,1)},this.renderInstances=e,this.renderMultiDraw=function(t,i,s){if(0!==s){a.get("WEBGL_multi_draw").multiDrawArraysWEBGL(o,t,0,i,0,s);let e=0;for(let t=0;t<s;t++)e+=i[t];h.update(e,o,1)}},this.renderMultiDrawInstances=function(i,s,r,n){if(0!==r){var t=a.get("WEBGL_multi_draw");if(null===t)for(let t=0;t<i.length;t++)e(i[t],s[t],n[t]);else{t.multiDrawArraysInstancedWEBGL(o,i,0,s,0,n,0,r);let e=0;for(let t=0;t<r;t++)e+=s[t];for(let t=0;t<n.length;t++)h.update(e,o,n[t])}}}}function xc(i,s,t,r){let e;function n(t){if("highp"===t){if(0<i.getShaderPrecisionFormat(i.VERTEX_SHADER,i.HIGH_FLOAT).precision&&0<i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.HIGH_FLOAT).precision)return"highp";t="mediump"}return"mediump"===t&&0<i.getShaderPrecisionFormat(i.VERTEX_SHADER,i.MEDIUM_FLOAT).precision&&0<i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.MEDIUM_FLOAT).precision?"mediump":"lowp"}let a=void 0!==t.precision?t.precision:"highp";var h=n(a),h=(h!==a&&(console.warn("THREE.WebGLRenderer:",a,"not supported, using",h,"instead."),a=h),!0===t.logarithmicDepthBuffer),t=!0===t.reverseDepthBuffer&&s.has("EXT_clip_control"),o=(!0===t&&(o=s.get("EXT_clip_control")).clipControlEXT(o.LOWER_LEFT_EXT,o.ZERO_TO_ONE_EXT),i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS)),l=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS),u=i.getParameter(i.MAX_TEXTURE_SIZE),c=i.getParameter(i.MAX_CUBE_MAP_TEXTURE_SIZE),f=i.getParameter(i.MAX_VERTEX_ATTRIBS),d=i.getParameter(i.MAX_VERTEX_UNIFORM_VECTORS),v=i.getParameter(i.MAX_VARYING_VECTORS),p=i.getParameter(i.MAX_FRAGMENT_UNIFORM_VECTORS),m=0<l,g=i.getParameter(i.MAX_SAMPLES);return{isWebGL2:!0,getMaxAnisotropy:function(){var t;return e=void 0===e?!0===s.has("EXT_texture_filter_anisotropic")?(t=s.get("EXT_texture_filter_anisotropic"),i.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT)):0:e},getMaxPrecision:n,textureFormatReadable:function(t){return t===ge||r.convert(t)===i.getParameter(i.IMPLEMENTATION_COLOR_READ_FORMAT)},textureTypeReadable:function(t){var e=t===ue&&(s.has("EXT_color_buffer_half_float")||s.has("EXT_color_buffer_float"));return!(t!==se&&r.convert(t)!==i.getParameter(i.IMPLEMENTATION_COLOR_READ_TYPE)&&t!==le&&!e)},precision:a,logarithmicDepthBuffer:h,reverseDepthBuffer:t,maxTextures:o,maxVertexTextures:l,maxTextureSize:u,maxCubemapSize:c,maxAttributes:f,maxVertexUniforms:d,maxVaryings:v,maxFragmentUniforms:p,vertexTextures:m,maxSamples:g}}function bc(o){let l=this,u=null,c=0,f=!1,d=!1,h=new Ar,v=new _,p={value:null,needsUpdate:!1};function m(i,t,s,e){var r=null!==i?i.length:0;let n=null;if(0!==r){if(n=p.value,!0!==e||null===n){var e=s+4*r,a=t.matrixWorldInverse;v.getNormalMatrix(a),(null===n||n.length<e)&&(n=new Float32Array(e));for(let t=0,e=s;t!==r;++t,e+=4)h.copy(i[t]).applyMatrix4(a,v),h.normal.toArray(n,e),n[e+3]=h.constant}p.value=n,p.needsUpdate=!0}return l.numPlanes=r,l.numIntersection=0,n}this.uniform=p,this.numPlanes=0,this.numIntersection=0,this.init=function(t,e){var i=0!==t.length||e||0!==c||f;return f=e,c=t.length,i},this.beginShadows=function(){d=!0,m(null)},this.endShadows=function(){d=!1},this.setGlobalState=function(t,e){u=m(t,e,0)},this.setState=function(t,e,i){var s=t.clippingPlanes,r=t.clipIntersection,n=t.clipShadows,t=o.get(t);if(!f||null===s||0===s.length||d&&!n)d?m(null):(p.value!==u&&(p.value=u,p.needsUpdate=0<c),l.numPlanes=c,l.numIntersection=0);else{var n=d?0:c,a=4*n,h=t.clippingState||null;p.value=h,h=m(s,e,a,i);for(let t=0;t!==a;++t)h[t]=u[t];t.clippingState=h,this.numIntersection=r?this.numPlanes:0,this.numPlanes+=n}}}let Sc;class Ac{static getDataURL(t){if(/^data:/i.test(t.src))return t.src;if("undefined"==typeof HTMLCanvasElement)return t.src;let e;var i;return 2048<(e=t instanceof HTMLCanvasElement?t:((Sc=void 0===Sc?gh("canvas"):Sc).width=t.width,Sc.height=t.height,i=Sc.getContext("2d"),t instanceof ImageData?i.putImageData(t,0,0):i.drawImage(t,0,0,t.width,t.height),Sc)).width||2048<e.height?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",t),e.toDataURL("image/jpeg",.6)):e.toDataURL("image/png")}static sRGBToLinear(t){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){var e=gh("canvas"),i=(e.width=t.width,e.height=t.height,e.getContext("2d")),s=(i.drawImage(t,0,0,t.width,t.height),i.getImageData(0,0,t.width,t.height)),r=s.data;for(let t=0;t<r.length;t++)r[t]=255*Br(r[t]/255);return i.putImageData(s,0,0),e}if(t.data){var n=t.data.slice(0);for(let t=0;t<n.length;t++)n instanceof Uint8Array||n instanceof Uint8ClampedArray?n[t]=Math.floor(255*Br(n[t]/255)):n[t]=Br(n[t]);return{data:n,width:t.width,height:t.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),t}}let Tc=0;class Rc{constructor(t=null){this.isSource=!0,Object.defineProperty(this,"id",{value:Tc++}),this.uuid=$i(),this.data=t,this.dataReady=!0,this.version=0}set needsUpdate(t){!0===t&&this.version++}toJSON(t){var e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.images[this.uuid])return t.images[this.uuid];var s={uuid:this.uuid,url:""},r=this.data;if(null!==r){let i;if(Array.isArray(r)){i=[];for(let t=0,e=r.length;t<e;t++)r[t].isDataTexture?i.push(Lc(r[t].image)):i.push(Lc(r[t]))}else i=Lc(r);s.url=i}return e||(t.images[this.uuid]=s),s}}function Lc(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?Ac.getDataURL(t):t.data?{data:Array.from(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let Cc=0;class c extends Cs{constructor(t=c.DEFAULT_IMAGE,e=c.DEFAULT_MAPPING,i=kt,s=kt,r=V,n=ee,a=ge,h=se,o=c.DEFAULT_ANISOTROPY,l=xi){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:Cc++}),this.uuid=$i(),this.name="",this.source=new Rc(t),this.mipmaps=[],this.mapping=e,this.channel=0,this.wrapS=i,this.wrapT=s,this.magFilter=r,this.minFilter=n,this.anisotropy=o,this.format=a,this.internalFormat=null,this.type=h,this.offset=new ct(0,0),this.repeat=new ct(1,1),this.center=new ct(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new _,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=l,this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.pmremVersion=0}get image(){return this.source.data}set image(t=null){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.channel=t.channel,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.colorSpace=t.colorSpace,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}toJSON(t){var e,i=void 0===t||"string"==typeof t;return i||void 0===t.textures[this.uuid]?(e={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment},0<Object.keys(this.userData).length&&(e.userData=this.userData),i||(t.textures[this.uuid]=e),e):t.textures[this.uuid]}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(t){if(this.mapping===B){if(t.applyMatrix3(this.matrix),t.x<0||1<t.x)switch(this.wrapS){case Bt:t.x=t.x-Math.floor(t.x);break;case kt:t.x=t.x<0?0:1;break;case Kt:1===Math.abs(Math.floor(t.x)%2)?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x)}if(t.y<0||1<t.y)switch(this.wrapT){case Bt:t.y=t.y-Math.floor(t.y);break;case kt:t.y=t.y<0?0:1;break;case Kt:1===Math.abs(Math.floor(t.y)%2)?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y)}this.flipY&&(t.y=1-t.y)}return t}set needsUpdate(t){!0===t&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(t){!0===t&&this.pmremVersion++}}c.DEFAULT_IMAGE=null,c.DEFAULT_MAPPING=B,c.DEFAULT_ANISOTROPY=1;class Nc extends Cs{constructor(t=1,e=1,i={}){super(),this.isRenderTarget=!0,this.width=t,this.height=e,this.depth=1,this.scissor=new Vt(0,0,t,e),this.scissorTest=!1,this.viewport=new Vt(0,0,t,e);var t={width:t,height:e,depth:1},s=(i=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:V,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1},i),new c(t,i.mapping,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.colorSpace)),r=(s.flipY=!1,s.generateMipmaps=i.generateMipmaps,s.internalFormat=i.internalFormat,this.textures=[],i.count);for(let t=0;t<r;t++)this.textures[t]=s.clone(),this.textures[t].isRenderTargetTexture=!0;this.depthBuffer=i.depthBuffer,this.stencilBuffer=i.stencilBuffer,this.resolveDepthBuffer=i.resolveDepthBuffer,this.resolveStencilBuffer=i.resolveStencilBuffer,this.depthTexture=i.depthTexture,this.samples=i.samples}get texture(){return this.textures[0]}set texture(t){this.textures[0]=t}setSize(i,s,r=1){if(this.width!==i||this.height!==s||this.depth!==r){this.width=i,this.height=s,this.depth=r;for(let t=0,e=this.textures.length;t<e;t++)this.textures[t].image.width=i,this.textures[t].image.height=s,this.textures[t].image.depth=r;this.dispose()}this.viewport.set(0,0,i,s),this.scissor.set(0,0,i,s)}clone(){return(new this.constructor).copy(this)}copy(i){this.width=i.width,this.height=i.height,this.depth=i.depth,this.scissor.copy(i.scissor),this.scissorTest=i.scissorTest,this.viewport.copy(i.viewport);for(let t=this.textures.length=0,e=i.textures.length;t<e;t++)this.textures[t]=i.textures[t].clone(),this.textures[t].isRenderTargetTexture=!0;var t=Object.assign({},i.texture.image);return this.texture.source=new Rc(t),this.depthBuffer=i.depthBuffer,this.stencilBuffer=i.stencilBuffer,this.resolveDepthBuffer=i.resolveDepthBuffer,this.resolveStencilBuffer=i.resolveStencilBuffer,null!==i.depthTexture&&(this.depthTexture=i.depthTexture.clone()),this.samples=i.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class Ic extends Nc{constructor(t=1,e=1,i={}){super(t,e,i),this.isWebGLRenderTarget=!0}}let Pc=-90,Dc=1;class Oc extends Js{constructor(t,e,i){super(),this.type="CubeCamera",this.renderTarget=i,this.coordinateSystem=null,this.activeMipmapLevel=0;i=new ir(Pc,Dc,t,e),i.layers=this.layers,this.add(i),i=new ir(Pc,Dc,t,e),i.layers=this.layers,this.add(i),i=new ir(Pc,Dc,t,e),i.layers=this.layers,this.add(i),i=new ir(Pc,Dc,t,e),i.layers=this.layers,this.add(i),i=new ir(Pc,Dc,t,e),i.layers=this.layers,this.add(i),i=new ir(Pc,Dc,t,e);i.layers=this.layers,this.add(i)}updateCoordinateSystem(){var t,e,i=this.coordinateSystem,s=this.children.concat(),[r,n,a,h,o,l]=s;for(t of s)this.remove(t);if(i===Xi)r.up.set(0,1,0),r.lookAt(1,0,0),n.up.set(0,1,0),n.lookAt(-1,0,0),a.up.set(0,0,-1),a.lookAt(0,1,0),h.up.set(0,0,1),h.lookAt(0,-1,0),o.up.set(0,1,0),o.lookAt(0,0,1),l.up.set(0,1,0);else{if(i!==Yi)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+i);r.up.set(0,-1,0),r.lookAt(-1,0,0),n.up.set(0,-1,0),n.lookAt(1,0,0),a.up.set(0,0,1),a.lookAt(0,1,0),h.up.set(0,0,-1),h.lookAt(0,-1,0),o.up.set(0,-1,0),o.lookAt(0,0,1),l.up.set(0,-1,0)}l.lookAt(0,0,-1);for(e of s)this.add(e),e.updateMatrixWorld()}update(t,e){null===this.parent&&this.updateMatrixWorld();var{renderTarget:i,activeMipmapLevel:s}=this,[r,n,a,h,o,l]=(this.coordinateSystem!==t.coordinateSystem&&(this.coordinateSystem=t.coordinateSystem,this.updateCoordinateSystem()),this.children),u=t.getRenderTarget(),c=t.getActiveCubeFace(),f=t.getActiveMipmapLevel(),d=t.xr.enabled,v=(t.xr.enabled=!1,i.texture.generateMipmaps);i.texture.generateMipmaps=!1,t.setRenderTarget(i,0,s),t.render(e,r),t.setRenderTarget(i,1,s),t.render(e,n),t.setRenderTarget(i,2,s),t.render(e,a),t.setRenderTarget(i,3,s),t.render(e,h),t.setRenderTarget(i,4,s),t.render(e,o),i.texture.generateMipmaps=v,t.setRenderTarget(i,5,s),t.render(e,l),t.setRenderTarget(u,c,f),t.xr.enabled=d,i.texture.needsPMREMUpdate=!0}}class Uc extends c{constructor(t,e,i,s,r,n,a,h,o,l){super(t=void 0!==t?t:[],e=void 0!==e?e:Pt,i,s,r,n,a,h,o,l),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(t){this.image=t}}class Fc extends Ic{constructor(t=1,e={}){super(t,t,e),this.isWebGLCubeRenderTarget=!0;t={width:t,height:t,depth:1},t=[t,t,t,t,t,t];this.texture=new Uc(t,e.mapping,e.wrapS,e.wrapT,e.magFilter,e.minFilter,e.format,e.type,e.anisotropy,e.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=void 0!==e.generateMipmaps&&e.generateMipmaps,this.texture.minFilter=void 0!==e.minFilter?e.minFilter:V}fromEquirectangularTexture(t,e){this.texture.type=e.type,this.texture.colorSpace=e.colorSpace,this.texture.generateMipmaps=e.generateMipmaps,this.texture.minFilter=e.minFilter,this.texture.magFilter=e.magFilter;var i={uniforms:{tEquirect:{value:null}},vertexShader:`

				varying vec3 vWorldDirection;

				vec3 transformDirection( in vec3 dir, in mat4 matrix ) {

					return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );

				}

				void main() {

					vWorldDirection = transformDirection( position, modelMatrix );

					#include <begin_vertex>
					#include <project_vertex>

				}
			`,fragmentShader:`

				uniform sampler2D tEquirect;

				varying vec3 vWorldDirection;

				#include <common>

				void main() {

					vec3 direction = normalize( vWorldDirection );

					vec2 sampleUV = equirectUv( direction );

					gl_FragColor = texture2D( tEquirect, sampleUV );

				}
			`},s=new Ih(5,5,5),i=new zh({name:"CubemapFromEquirect",uniforms:Uh(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:Yt,blending:q}),s=(i.uniforms.tEquirect.value=e,new L(s,i)),i=e.minFilter;return e.minFilter===ee&&(e.minFilter=V),new Oc(1,10,this).update(t,s),e.minFilter=i,s.geometry.dispose(),s.material.dispose(),this}clear(e,i,s,r){var t=e.getRenderTarget();for(let t=0;t<6;t++)e.setRenderTarget(this,t),e.clear(i,s,r);e.setRenderTarget(t)}}function Bc(i){let s=new WeakMap;function r(t,e){return e===Ot?t.mapping=Pt:e===Ut&&(t.mapping=Dt),t}function n(t){var t=t.target,e=(t.removeEventListener("dispose",n),s.get(t));void 0!==e&&(s.delete(t),e.dispose())}return{get:function(t){if(t&&t.isTexture){var e=t.mapping;if(e===Ot||e===Ut)return s.has(t)?r(s.get(t).texture,t.mapping):(e=t.image)&&0<e.height?((e=new Fc(e.height)).fromEquirectangularTexture(i,t),s.set(t,e),t.addEventListener("dispose",n),r(e.texture,t.mapping)):null}return t},dispose:function(){s=new WeakMap}}}let kc=4,Gc=[.125,.215,.35,.446,.526,.582],Hc=20,Vc=new sr,zc=new Wt,Wc=null,jc=0,Xc=0,Yc=!1,Zc=(1+Math.sqrt(5))/2,qc=1/Zc,Kc=[new Gt(-Zc,qc,0),new Gt(Zc,qc,0),new Gt(-qc,0,Zc),new Gt(qc,0,Zc),new Gt(0,Zc,-qc),new Gt(0,Zc,qc),new Gt(-1,1,-1),new Gt(1,1,-1),new Gt(-1,1,1),new Gt(1,1,1)];class Jc{constructor(t){this.un=t,this.cn=null,this.dn=0,this.vn=0,this.pn=[],this.mn=[],this.gn=[],this._n=null,this.wn=null,this.Mn=null,this.yn(this._n)}fromScene(t,e=0,i=.1,s=100){Wc=this.un.getRenderTarget(),jc=this.un.getActiveCubeFace(),Xc=this.un.getActiveMipmapLevel(),Yc=this.un.xr.enabled,this.un.xr.enabled=!1,this.En(256);var r=this.xn();return r.depthBuffer=!0,this.bn(t,i,s,r),0<e&&this.Sn(r,0,0,e),this.An(r),this.Tn(r),r}fromEquirectangular(t,e=null){return this.Rn(t,e)}fromCubemap(t,e=null){return this.Rn(t,e)}compileCubemapShader(){null===this.wn&&(this.wn=rf(),this.yn(this.wn))}compileEquirectangularShader(){null===this.Mn&&(this.Mn=sf(),this.yn(this.Mn))}dispose(){this.Qt(),null!==this.wn&&this.wn.dispose(),null!==this.Mn&&this.Mn.dispose()}En(t){this.dn=Math.floor(Math.log2(t)),this.vn=Math.pow(2,this.dn)}Qt(){null!==this._n&&this._n.dispose(),null!==this.cn&&this.cn.dispose();for(let t=0;t<this.pn.length;t++)this.pn[t].dispose()}Tn(t){this.un.setRenderTarget(Wc,jc,Xc),this.un.xr.enabled=Yc,t.scissorTest=!1,tf(t,0,0,t.width,t.height)}Rn(t,e){t.mapping===Pt||t.mapping===Dt?this.En(0===t.image.length?16:t.image[0].width||t.image[0].image.width):this.En(t.image.width/4),Wc=this.un.getRenderTarget(),jc=this.un.getActiveCubeFace(),Xc=this.un.getActiveMipmapLevel(),Yc=this.un.xr.enabled,this.un.xr.enabled=!1;e=e||this.xn();return this.Ln(t,e),this.An(e),this.Tn(e),e}xn(){var t=3*Math.max(this.vn,112),e=4*this.vn,i={magFilter:V,minFilter:V,generateMipmaps:!1,type:ue,format:ge,colorSpace:Si,depthBuffer:!1},s=Qc(t,e,i);return null!==this.cn&&this.cn.width===t&&this.cn.height===e||(null!==this.cn&&this.Qt(),this.cn=Qc(t,e,i),i=this.dn,{sizeLods:this.mn,lodPlanes:this.pn,sigmas:this.gn}=$c(i),this._n=ef(i,t,e)),s}yn(t){t=new L(this.pn[0],t);this.un.compile(t,Vc)}bn(e,t,i,s){var r=new ir(90,1,t,i),n=[1,-1,1,1,1,1],a=[1,1,1,-1,-1,-1],h=this.un,t=h.autoClear,i=h.toneMapping,o=(h.getClearColor(zc),h.toneMapping=qt,h.autoClear=!1,new ro({name:"PMREM.Background",side:Yt,depthWrite:!1,depthTest:!1})),l=new L(new Ih,o);let u=!1;var c=e.background;c?c.isColor&&(o.color.copy(c),e.background=null,u=!0):(o.color.copy(zc),u=!0);for(let t=0;t<6;t++){var f=t%3,d=(0==f?(r.up.set(0,n[t],0),r.lookAt(a[t],0,0)):1==f?(r.up.set(0,0,n[t]),r.lookAt(0,a[t],0)):(r.up.set(0,n[t],0),r.lookAt(0,0,a[t])),this.vn);tf(s,f*d,2<t?d:0,d,d),h.setRenderTarget(s),u&&h.render(l,r),h.render(e,r)}l.geometry.dispose(),l.material.dispose(),h.toneMapping=i,h.autoClear=t,e.background=c}Ln(t,e){var i=this.un,s=t.mapping===Pt||t.mapping===Dt,s=(s?(null===this.wn&&(this.wn=rf()),this.wn.uniforms.flipEnvMap.value=!1===t.isRenderTargetTexture?-1:1):null===this.Mn&&(this.Mn=sf()),s?this.wn:this.Mn),r=new L(this.pn[0],s),s=(s.uniforms.envMap.value=t,this.vn);tf(e,0,0,3*s,2*s),i.setRenderTarget(e),i.render(r,Vc)}An(e){var t=this.un,i=t.autoClear,s=(t.autoClear=!1,this.pn.length);for(let t=1;t<s;t++){var r=Math.sqrt(this.gn[t]*this.gn[t]-this.gn[t-1]*this.gn[t-1]),n=Kc[(s-t-1)%Kc.length];this.Sn(e,t-1,t,r,n)}t.autoClear=i}Sn(t,e,i,s,r){var n=this.cn;this.Cn(t,n,e,i,s,"latitudinal",r),this.Cn(n,t,i,i,s,"longitudinal",r)}Cn(t,e,i,s,r,n,a){var h=this.un,o=this._n,l=("latitudinal"!==n&&"longitudinal"!==n&&console.error("blur direction must be either latitudinal or longitudinal!"),new L(this.pn[s],o)),o=o.uniforms,u=this.mn[i]-1,u=isFinite(r)?Math.PI/(2*u):2*Math.PI/(2*Hc-1),c=r/u,f=isFinite(r)?1+Math.floor(3*c):Hc,d=(f>Hc&&console.warn(`sigmaRadians, ${r}, is too large and will clip, as it requested ${f} samples when the maximum is set to `+Hc),[]);let v=0;for(let t=0;t<Hc;++t){var p=t/c,p=Math.exp(-p*p/2);d.push(p),0===t?v+=p:t<f&&(v+=2*p)}for(let t=0;t<d.length;t++)d[t]=d[t]/v;o.envMap.value=t.texture,o.samples.value=f,o.weights.value=d,o.latitudinal.value="latitudinal"===n,a&&(o.poleAxis.value=a);r=this.dn,o.dTheta.value=u,o.mipInt.value=r-i,t=this.mn[s];tf(e,3*t*(s>r-kc?s-r+kc:0),4*(this.vn-t),3*t,2*t),h.setRenderTarget(e),h.render(l,Vc)}}function $c(i){var s=[],r=[],n=[];let a=i;var t=i-kc+1+Gc.length;for(let e=0;e<t;e++){var h=Math.pow(2,a);r.push(h);let t=1/h;e>i-kc?t=Gc[e-i+kc-1]:0===e&&(t=0),n.push(t);var h=1/(h-2),o=-h,h=1+h,l=[o,o,h,o,h,h,o,o,h,h,o,h],u=new Float32Array(108),c=new Float32Array(72),f=new Float32Array(36);for(let t=0;t<6;t++){var d=t%3*2/3-1,v=2<t?0:-1,d=(u.set([d,v,0,d+2/3,v,0,d+2/3,1+v,0,d,v,0,d+2/3,1+v,0,d,1+v,0],18*t),c.set(l,12*t),[t,t,t,t,t,t]);f.set(d,6*t)}o=new Nh;o.setAttribute("position",new N(u,3)),o.setAttribute("uv",new N(c,2)),o.setAttribute("faceIndex",new N(f,1)),s.push(o),a>kc&&a--}return{lodPlanes:s,sizeLods:r,sigmas:n}}function Qc(t,e,i){t=new Ic(t,e,i);return t.texture.mapping=Ft,t.texture.name="PMREM.cubeUv",t.scissorTest=!0,t}function tf(t,e,i,s,r){t.viewport.set(e,i,s,r),t.scissor.set(e,i,s,r)}function ef(t,e,i){var s=new Float32Array(Hc),r=new Gt(0,1,0);return new zh({name:"SphericalGaussianBlur",defines:{n:Hc,CUBEUV_TEXEL_WIDTH:1/e,CUBEUV_TEXEL_HEIGHT:1/i,CUBEUV_MAX_MIP:t+".0"},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:s},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:r}},vertexShader:nf(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;
			uniform int samples;
			uniform float weights[ n ];
			uniform bool latitudinal;
			uniform float dTheta;
			uniform float mipInt;
			uniform vec3 poleAxis;

			#define ENVMAP_TYPE_CUBE_UV
			#include <cube_uv_reflection_fragment>

			vec3 getSample( float theta, vec3 axis ) {

				float cosTheta = cos( theta );
				// Rodrigues' axis-angle rotation
				vec3 sampleDirection = vOutputDirection * cosTheta
					+ cross( axis, vOutputDirection ) * sin( theta )
					+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );

				return bilinearCubeUV( envMap, sampleDirection, mipInt );

			}

			void main() {

				vec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );

				if ( all( equal( axis, vec3( 0.0 ) ) ) ) {

					axis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );

				}

				axis = normalize( axis );

				gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );
				gl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );

				for ( int i = 1; i < n; i++ ) {

					if ( i >= samples ) {

						break;

					}

					float theta = dTheta * float( i );
					gl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );
					gl_FragColor.rgb += weights[ i ] * getSample( theta, axis );

				}

			}
		`,blending:q,depthTest:!1,depthWrite:!1})}function sf(){return new zh({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:nf(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;

			#include <common>

			void main() {

				vec3 outputDirection = normalize( vOutputDirection );
				vec2 uv = equirectUv( outputDirection );

				gl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );

			}
		`,blending:q,depthTest:!1,depthWrite:!1})}function rf(){return new zh({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:nf(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			uniform float flipEnvMap;

			varying vec3 vOutputDirection;

			uniform samplerCube envMap;

			void main() {

				gl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );

			}
		`,blending:q,depthTest:!1,depthWrite:!1})}function nf(){return`

		precision mediump float;
		precision mediump int;

		attribute float faceIndex;

		varying vec3 vOutputDirection;

		// RH coordinate system; PMREM face-indexing convention
		vec3 getDirection( vec2 uv, float face ) {

			uv = 2.0 * uv - 1.0;

			vec3 direction = vec3( uv, 1.0 );

			if ( face == 0.0 ) {

				direction = direction.zyx; // ( 1, v, u ) pos x

			} else if ( face == 1.0 ) {

				direction = direction.xzy;
				direction.xz *= -1.0; // ( -u, 1, -v ) pos y

			} else if ( face == 2.0 ) {

				direction.x *= -1.0; // ( -u, v, 1 ) pos z

			} else if ( face == 3.0 ) {

				direction = direction.zyx;
				direction.xz *= -1.0; // ( -1, v, -u ) neg x

			} else if ( face == 4.0 ) {

				direction = direction.xzy;
				direction.xy *= -1.0; // ( -u, -1, v ) neg y

			} else if ( face == 5.0 ) {

				direction.z *= -1.0; // ( u, v, -1 ) neg z

			}

			return direction;

		}

		void main() {

			vOutputDirection = getDirection( uv, faceIndex );
			gl_Position = vec4( position, 1.0 );

		}
	`}function af(n){let a=new WeakMap,h=null;function o(t){var t=t.target,e=(t.removeEventListener("dispose",o),a.get(t));void 0!==e&&(a.delete(t),e.dispose())}return{get:function(e){if(e&&e.isTexture){var i=e.mapping,s=i===Ot||i===Ut,i=i===Pt||i===Dt;if(s||i){let t=a.get(e);var r=void 0!==t?t.texture.pmremVersion:0;return e.isRenderTargetTexture&&e.pmremVersion!==r?(null===h&&(h=new Jc(n)),(t=s?h.fromEquirectangular(e,t):h.fromCubemap(e,t)).texture.pmremVersion=e.pmremVersion,a.set(e,t),t.texture):void 0!==t?t.texture:(r=e.image,s&&r&&0<r.height||i&&r&&(e=>{let i=0;for(let t=0;t<6;t++)void 0!==e[t]&&i++;return 6===i})(r)?(null===h&&(h=new Jc(n)),(t=s?h.fromEquirectangular(e):h.fromCubemap(e)).texture.pmremVersion=e.pmremVersion,a.set(e,t),e.addEventListener("dispose",o),t.texture):null)}}return e},dispose:function(){a=new WeakMap,null!==h&&(h.dispose(),h=null)}}}function hf(i){let s={};function r(t){if(void 0!==s[t])return s[t];let e;switch(t){case"WEBGL_depth_texture":e=i.getExtension("WEBGL_depth_texture")||i.getExtension("MOZ_WEBGL_depth_texture")||i.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":e=i.getExtension("EXT_texture_filter_anisotropic")||i.getExtension("MOZ_EXT_texture_filter_anisotropic")||i.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":e=i.getExtension("WEBGL_compressed_texture_s3tc")||i.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||i.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":e=i.getExtension("WEBGL_compressed_texture_pvrtc")||i.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:e=i.getExtension(t)}return s[t]=e}return{has:function(t){return null!==r(t)},init:function(){r("EXT_color_buffer_float"),r("WEBGL_clip_cull_distance"),r("OES_texture_float_linear"),r("EXT_color_buffer_half_float"),r("WEBGL_multisampled_render_to_texture"),r("WEBGL_render_shared_exponent")},get:function(t){var e=r(t);return null===e&&Mh("THREE.WebGLRenderer: "+t+" extension not supported."),e}}}function of(a,f,n,h){let o={},d=new WeakMap;function l(t){var e,i,s=t.target;for(e in null!==s.index&&f.remove(s.index),s.attributes)f.remove(s.attributes[e]);for(i in s.morphAttributes){var r=s.morphAttributes[i];for(let t=0,e=r.length;t<e;t++)f.remove(r[t])}s.removeEventListener("dispose",l),delete o[s.id];t=d.get(s);t&&(f.remove(t),d.delete(s)),h.releaseStatesOfGeometry(s),!0===s.isInstancedBufferGeometry&&delete s.L,n.memory.geometries--}function s(t){var i=[],s=t.index,e=t.attributes.position;let r=0;if(null!==s){var n=s.array;r=s.version;for(let t=0,e=n.length;t<e;t+=3){var a=n[t+0],h=n[t+1],o=n[t+2];i.push(a,h,h,o,o,a)}}else{if(void 0===e)return;s=e.array;r=e.version;for(let t=0,e=s.length/3-1;t<e;t+=3){var l=t+0,u=t+1,c=t+2;i.push(l,u,u,c,c,l)}}e=new(mh(i)?vh:dh)(i,1),e.version=r,s=d.get(t);s&&f.remove(s),d.set(t,e)}return{get:function(t,e){return!0!==o[e.id]&&(e.addEventListener("dispose",l),o[e.id]=!0,n.memory.geometries++),e},update:function(t){var e,i=t.attributes;for(e in i)f.update(i[e],a.ARRAY_BUFFER);var s,r=t.morphAttributes;for(s in r){var n=r[s];for(let t=0,e=n.length;t<e;t++)f.update(n[t],a.ARRAY_BUFFER)}},getWireframeAttribute:function(t){var e,i=d.get(t);return(!i||null!==(e=t.index)&&i.version<e.version)&&s(t),d.get(t)}}}function lf(s,a,h){let o;let l,u;function e(t,e,i){0!==i&&(s.drawElementsInstanced(o,e,l,t*u,i),h.update(e,o,i))}this.setMode=function(t){o=t},this.setIndex=function(t){l=t.type,u=t.bytesPerElement},this.render=function(t,e){s.drawElements(o,e,l,t*u),h.update(e,o,1)},this.renderInstances=e,this.renderMultiDraw=function(t,i,s){if(0!==s){a.get("WEBGL_multi_draw").multiDrawElementsWEBGL(o,i,0,l,t,0,s);let e=0;for(let t=0;t<s;t++)e+=i[t];h.update(e,o,1)}},this.renderMultiDrawInstances=function(i,s,r,n){if(0!==r){var t=a.get("WEBGL_multi_draw");if(null===t)for(let t=0;t<i.length;t++)e(i[t]/u,s[t],n[t]);else{t.multiDrawElementsInstancedWEBGL(o,s,0,l,i,0,n,0,r);let e=0;for(let t=0;t<r;t++)e+=s[t];for(let t=0;t<n.length;t++)h.update(e,o,n[t])}}}}function uf(s){let r={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:r,programs:null,autoReset:!0,reset:function(){r.calls=0,r.triangles=0,r.points=0,r.lines=0},update:function(t,e,i){switch(r.calls++,e){case s.TRIANGLES:r.triangles+=i*(t/3);break;case s.LINES:r.lines+=i*(t/2);break;case s.LINE_STRIP:r.lines+=i*(t-1);break;case s.LINE_LOOP:r.lines+=i*t;break;case s.POINTS:r.points+=i*t;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",e)}}}}class cf extends c{constructor(t=null,e=1,i=1,s=1){super(null),this.isDataArrayTexture=!0,this.image={data:t,width:e,height:i,depth:s},this.magFilter=Jt,this.minFilter=Jt,this.wrapR=kt,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(t){this.layerUpdates.add(t)}clearLayerUpdates(){this.layerUpdates.clear()}}function ff(y,E,e){let x=new WeakMap,b=new Vt;return{update:function(t,n,i){var s=t.morphTargetInfluences,r=n.morphAttributes.position||n.morphAttributes.normal||n.morphAttributes.color,a=void 0!==r?r.length:0;let h=x.get(n);if(void 0===h||h.count!==a){let t=function(){r.dispose(),x.delete(n),n.removeEventListener("dispose",t)};void 0!==h&&h.texture.dispose();var o=void 0!==n.morphAttributes.position,l=void 0!==n.morphAttributes.normal,u=void 0!==n.morphAttributes.color,c=n.morphAttributes.position||[],f=n.morphAttributes.normal||[],d=n.morphAttributes.color||[];let e=!0==u?3:!0==l?2:!0==o?1:0,i=n.attributes.position.count*e,s=1;i>E.maxTextureSize&&(s=Math.ceil(i/E.maxTextureSize),i=E.maxTextureSize);var v=new Float32Array(i*s*4*a);let r=new cf(v,i,s,a);r.type=le,r.needsUpdate=!0;var p=4*e;for(let t=0;t<a;t++){var m=c[t],g=f[t],_=d[t],w=i*s*4*t;for(let t=0;t<m.count;t++){var M=t*p;!0==o&&(b.fromBufferAttribute(m,t),v[w+M]=b.x,v[w+M+1]=b.y,v[w+M+2]=b.z,v[w+M+3]=0),!0==l&&(b.fromBufferAttribute(g,t),v[w+M+4]=b.x,v[w+M+5]=b.y,v[w+M+6]=b.z,v[w+M+7]=0),!0==u&&(b.fromBufferAttribute(_,t),v[w+M+8]=b.x,v[w+M+9]=b.y,v[w+M+10]=b.z,v[w+M+11]=4===_.itemSize?b.w:1)}}h={count:a,texture:r,size:new ct(i,s)},x.set(n,h),n.addEventListener("dispose",t)}if(!0===t.isInstancedMesh&&null!==t.morphTexture)i.getUniforms().setValue(y,"morphTexture",t.morphTexture,e);else{let e=0;for(let t=0;t<s.length;t++)e+=s[t];r=n.morphTargetsRelative?1:1-e;i.getUniforms().setValue(y,"morphTargetBaseInfluence",r),i.getUniforms().setValue(y,"morphTargetInfluences",s)}i.getUniforms().setValue(y,"morphTargetsTexture",h.texture,e),i.getUniforms().setValue(y,"morphTargetsTextureSize",h.size)}}}function df(s,r,n,a){let h=new WeakMap;function o(t){t=t.target;t.removeEventListener("dispose",o),n.remove(t.instanceMatrix),null!==t.instanceColor&&n.remove(t.instanceColor)}return{update:function(t){var e=a.render.frame,i=t.geometry,i=r.get(t,i);return h.get(i)!==e&&(r.update(i),h.set(i,e)),t.isInstancedMesh&&(!1===t.hasEventListener("dispose",o)&&t.addEventListener("dispose",o),h.get(t)!==e)&&(n.update(t.instanceMatrix,s.ARRAY_BUFFER),null!==t.instanceColor&&n.update(t.instanceColor,s.ARRAY_BUFFER),h.set(t,e)),t.isSkinnedMesh&&(t=t.skeleton,h.get(t)!==e)&&(t.update(),h.set(t,e)),i},dispose:function(){h=new WeakMap}}}class vf extends c{constructor(t=null,e=1,i=1,s=1){super(null),this.isData3DTexture=!0,this.image={data:t,width:e,height:i,depth:s},this.magFilter=Jt,this.minFilter=Jt,this.wrapR=kt,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class pf extends c{constructor(t,e,i,s,r,n,a,h,o,l=Me){if(l!==Me&&l!==ye)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");super(null,s,r,n,a,h,l,i=void 0===(i=void 0===i&&l===Me?oe:i)&&l===ye?de:i,o),this.isDepthTexture=!0,this.image={width:t,height:e},this.magFilter=void 0!==a?a:Jt,this.minFilter=void 0!==h?h:Jt,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(t){return super.copy(t),this.compareFunction=t.compareFunction,this}toJSON(t){t=super.toJSON(t);return null!==this.compareFunction&&(t.compareFunction=this.compareFunction),t}}let mf=new c,gf=new pf(1,1),_f=new cf,wf=new vf,Mf=new Uc,yf=[],Ef=[],xf=new Float32Array(16),bf=new Float32Array(9),Sf=new Float32Array(4);function Af(i,s,r){var t=i[0];if(t<=0||0<t)return i;var e=s*r;let n=yf[e];if(void 0===n&&(n=new Float32Array(e),yf[e]=n),0!==s){t.toArray(n,0);for(let t=1,e=0;t!==s;++t)e+=r,i[t].toArray(n,e)}return n}function Tf(i,s){if(i.length===s.length){for(let t=0,e=i.length;t<e;t++)if(i[t]!==s[t])return;return 1}}function Rf(i,s){for(let t=0,e=s.length;t<e;t++)i[t]=s[t]}function Lf(e,i){let s=Ef[i];void 0===s&&(s=new Int32Array(i),Ef[i]=s);for(let t=0;t!==i;++t)s[t]=e.allocateTextureUnit();return s}function Cf(t,e){var i=this.cache;i[0]!==e&&(t.uniform1f(this.addr,e),i[0]=e)}function Nf(t,e){var i=this.cache;void 0!==e.x?i[0]===e.x&&i[1]===e.y||(t.uniform2f(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y):Tf(i,e)||(t.uniform2fv(this.addr,e),Rf(i,e))}function If(t,e){var i=this.cache;void 0!==e.x?i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3f(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z):void 0!==e.r?i[0]===e.r&&i[1]===e.g&&i[2]===e.b||(t.uniform3f(this.addr,e.r,e.g,e.b),i[0]=e.r,i[1]=e.g,i[2]=e.b):Tf(i,e)||(t.uniform3fv(this.addr,e),Rf(i,e))}function Pf(t,e){var i=this.cache;void 0!==e.x?i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4f(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w):Tf(i,e)||(t.uniform4fv(this.addr,e),Rf(i,e))}function Df(t,e){var i=this.cache,s=e.elements;void 0===s?Tf(i,e)||(t.uniformMatrix2fv(this.addr,!1,e),Rf(i,e)):Tf(i,s)||(Sf.set(s),t.uniformMatrix2fv(this.addr,!1,Sf),Rf(i,s))}function Of(t,e){var i=this.cache,s=e.elements;void 0===s?Tf(i,e)||(t.uniformMatrix3fv(this.addr,!1,e),Rf(i,e)):Tf(i,s)||(bf.set(s),t.uniformMatrix3fv(this.addr,!1,bf),Rf(i,s))}function Uf(t,e){var i=this.cache,s=e.elements;void 0===s?Tf(i,e)||(t.uniformMatrix4fv(this.addr,!1,e),Rf(i,e)):Tf(i,s)||(xf.set(s),t.uniformMatrix4fv(this.addr,!1,xf),Rf(i,s))}function Ff(t,e){var i=this.cache;i[0]!==e&&(t.uniform1i(this.addr,e),i[0]=e)}function Bf(t,e){var i=this.cache;void 0!==e.x?i[0]===e.x&&i[1]===e.y||(t.uniform2i(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y):Tf(i,e)||(t.uniform2iv(this.addr,e),Rf(i,e))}function kf(t,e){var i=this.cache;void 0!==e.x?i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3i(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z):Tf(i,e)||(t.uniform3iv(this.addr,e),Rf(i,e))}function Gf(t,e){var i=this.cache;void 0!==e.x?i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4i(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w):Tf(i,e)||(t.uniform4iv(this.addr,e),Rf(i,e))}function Hf(t,e){var i=this.cache;i[0]!==e&&(t.uniform1ui(this.addr,e),i[0]=e)}function Vf(t,e){var i=this.cache;void 0!==e.x?i[0]===e.x&&i[1]===e.y||(t.uniform2ui(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y):Tf(i,e)||(t.uniform2uiv(this.addr,e),Rf(i,e))}function zf(t,e){var i=this.cache;void 0!==e.x?i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3ui(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z):Tf(i,e)||(t.uniform3uiv(this.addr,e),Rf(i,e))}function Wf(t,e){var i=this.cache;void 0!==e.x?i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4ui(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w):Tf(i,e)||(t.uniform4uiv(this.addr,e),Rf(i,e))}function jf(t,e,i){var s=this.cache,r=i.allocateTextureUnit();s[0]!==r&&(t.uniform1i(this.addr,r),s[0]=r);let n;n=this.type===t.SAMPLER_2D_SHADOW?(gf.compareFunction=ki,gf):mf,i.setTexture2D(e||n,r)}function Xf(t,e,i){var s=this.cache,r=i.allocateTextureUnit();s[0]!==r&&(t.uniform1i(this.addr,r),s[0]=r),i.setTexture3D(e||wf,r)}function Yf(t,e,i){var s=this.cache,r=i.allocateTextureUnit();s[0]!==r&&(t.uniform1i(this.addr,r),s[0]=r),i.setTextureCube(e||Mf,r)}function Zf(t,e,i){var s=this.cache,r=i.allocateTextureUnit();s[0]!==r&&(t.uniform1i(this.addr,r),s[0]=r),i.setTexture2DArray(e||_f,r)}function qf(t){switch(t){case 5126:return Cf;case 35664:return Nf;case 35665:return If;case 35666:return Pf;case 35674:return Df;case 35675:return Of;case 35676:return Uf;case 5124:case 35670:return Ff;case 35667:case 35671:return Bf;case 35668:case 35672:return kf;case 35669:case 35673:return Gf;case 5125:return Hf;case 36294:return Vf;case 36295:return zf;case 36296:return Wf;case 35678:case 36198:case 36298:case 36306:case 35682:return jf;case 35679:case 36299:case 36307:return Xf;case 35680:case 36300:case 36308:case 36293:return Yf;case 36289:case 36303:case 36311:case 36292:return Zf}}function Kf(t,e){t.uniform1fv(this.addr,e)}function Jf(t,e){e=Af(e,this.size,2);t.uniform2fv(this.addr,e)}function $f(t,e){e=Af(e,this.size,3);t.uniform3fv(this.addr,e)}function Qf(t,e){e=Af(e,this.size,4);t.uniform4fv(this.addr,e)}function td(t,e){e=Af(e,this.size,4);t.uniformMatrix2fv(this.addr,!1,e)}function ed(t,e){e=Af(e,this.size,9);t.uniformMatrix3fv(this.addr,!1,e)}function id(t,e){e=Af(e,this.size,16);t.uniformMatrix4fv(this.addr,!1,e)}function sd(t,e){t.uniform1iv(this.addr,e)}function rd(t,e){t.uniform2iv(this.addr,e)}function nd(t,e){t.uniform3iv(this.addr,e)}function ad(t,e){t.uniform4iv(this.addr,e)}function hd(t,e){t.uniform1uiv(this.addr,e)}function od(t,e){t.uniform2uiv(this.addr,e)}function ld(t,e){t.uniform3uiv(this.addr,e)}function ud(t,e){t.uniform4uiv(this.addr,e)}function cd(t,e,i){var s=this.cache,r=e.length,n=Lf(i,r);Tf(s,n)||(t.uniform1iv(this.addr,n),Rf(s,n));for(let t=0;t!==r;++t)i.setTexture2D(e[t]||mf,n[t])}function fd(t,e,i){var s=this.cache,r=e.length,n=Lf(i,r);Tf(s,n)||(t.uniform1iv(this.addr,n),Rf(s,n));for(let t=0;t!==r;++t)i.setTexture3D(e[t]||wf,n[t])}function dd(t,e,i){var s=this.cache,r=e.length,n=Lf(i,r);Tf(s,n)||(t.uniform1iv(this.addr,n),Rf(s,n));for(let t=0;t!==r;++t)i.setTextureCube(e[t]||Mf,n[t])}function vd(t,e,i){var s=this.cache,r=e.length,n=Lf(i,r);Tf(s,n)||(t.uniform1iv(this.addr,n),Rf(s,n));for(let t=0;t!==r;++t)i.setTexture2DArray(e[t]||_f,n[t])}function pd(t){switch(t){case 5126:return Kf;case 35664:return Jf;case 35665:return $f;case 35666:return Qf;case 35674:return td;case 35675:return ed;case 35676:return id;case 5124:case 35670:return sd;case 35667:case 35671:return rd;case 35668:case 35672:return nd;case 35669:case 35673:return ad;case 5125:return hd;case 36294:return od;case 36295:return ld;case 36296:return ud;case 35678:case 36198:case 36298:case 36306:case 35682:return cd;case 35679:case 36299:case 36307:return fd;case 35680:case 36300:case 36308:case 36293:return dd;case 36289:case 36303:case 36311:case 36292:return vd}}class md{constructor(t,e,i){this.id=t,this.addr=i,this.cache=[],this.type=e.type,this.setValue=qf(e.type)}}class gd{constructor(t,e,i){this.id=t,this.addr=i,this.cache=[],this.type=e.type,this.size=e.size,this.setValue=pd(e.type)}}class _d{constructor(t){this.id=t,this.seq=[],this.map={}}setValue(i,s,r){var n=this.seq;for(let t=0,e=n.length;t!==e;++t){var a=n[t];a.setValue(i,s[a.id],r)}}}let wd=/(\w+)(\])?(\[|\.)?/g;function Md(t,e){t.seq.push(e),t.map[e.id]=e}function yd(t,i,s){var r=t.name,n=r.length;for(wd.lastIndex=0;;){var a=wd.exec(r),h=wd.lastIndex;let e=a[1];var o=a[3];if("]"===a[2]&&(e|=0),void 0===o||"["===o&&h+2===n){Md(s,new(void 0===o?md:gd)(e,t,i));break}{let t=s.map[e];void 0===t&&Md(s,t=new _d(e)),s=t}}}class Ed{constructor(e,i){this.seq=[],this.map={};var s=e.getProgramParameter(i,e.ACTIVE_UNIFORMS);for(let t=0;t<s;++t){var r=e.getActiveUniform(i,t);yd(r,e.getUniformLocation(i,r.name),this)}}setValue(t,e,i,s){e=this.map[e];void 0!==e&&e.setValue(t,i,s)}setOptional(t,e,i){e=e[i];void 0!==e&&this.setValue(t,i,e)}static upload(i,s,r,n){for(let t=0,e=s.length;t!==e;++t){var a=s[t],h=r[a.id];!1!==h.needsUpdate&&a.setValue(i,h.value,n)}}static seqWithValue(i,s){var r=[];for(let t=0,e=i.length;t!==e;++t){var n=i[t];n.id in s&&r.push(n)}return r}}function xd(t,e,i){e=t.createShader(e);return t.shaderSource(e,i),t.compileShader(e),e}let bd=37297,Sd=0;function Ad(e,i){var s=e.split("\n"),r=[],e=Math.max(i-6,0),n=Math.min(i+6,s.length);for(let t=e;t<n;t++){var a=t+1;r.push(`${a===i?">":" "} ${a}: `+s[t])}return r.join("\n")}function Td(t){var e=zt.getPrimaries(zt.workingColorSpace),i=zt.getPrimaries(t);let s;switch(e===i?s="":e===Ni&&i===Ci?s="LinearDisplayP3ToLinearSRGB":e===Ci&&i===Ni&&(s="LinearSRGBToLinearDisplayP3"),t){case Si:case Ti:return[s,"LinearTransferOETF"];case bi:case Ai:return[s,"sRGBTransferOETF"];default:return console.warn("THREE.WebGLProgram: Unsupported color space:",t),[s,"LinearTransferOETF"]}}function Rd(t,e,i){var s=t.getShaderParameter(e,t.COMPILE_STATUS),r=t.getShaderInfoLog(e).trim();return s&&""===r?"":(s=/ERROR: 0:(\d+)/.exec(r))?(s=parseInt(s[1]),i.toUpperCase()+"\n\n"+r+"\n\n"+Ad(t.getShaderSource(e),s)):r}function Ld(t,e){e=Td(e);return`vec4 ${t}( vec4 value ) { return ${e[0]}( ${e[1]}( value ) ); }`}function Cd(t,e){let i;switch(e){case x:i="Linear";break;case S:i="Reinhard";break;case A:i="Cineon";break;case T:i="ACESFilmic";break;case O:i="AgX";break;case U:i="Neutral";break;case R:i="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",e),i="Linear"}return"vec3 "+t+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}let Nd=new Gt;function Id(){return zt.getLuminanceCoefficients(Nd),["float luminance( const in vec3 rgb ) {",`	const vec3 weights = vec3( ${Nd.x.toFixed(4)}, ${Nd.y.toFixed(4)}, ${Nd.z.toFixed(4)} );`,"\treturn dot( weights, rgb );","}"].join("\n")}function Pd(t){return[t.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":"",t.extensionMultiDraw?"#extension GL_ANGLE_multi_draw : require":""].filter(Ud).join("\n")}function Dd(t){var e,i=[];for(e in t){var s=t[e];!1!==s&&i.push("#define "+e+" "+s)}return i.join("\n")}function Od(i,s){var r={},t=i.getProgramParameter(s,i.ACTIVE_ATTRIBUTES);for(let e=0;e<t;e++){var n=i.getActiveAttrib(s,e),a=n.name;let t=1;n.type===i.FLOAT_MAT2&&(t=2),n.type===i.FLOAT_MAT3&&(t=3),n.type===i.FLOAT_MAT4&&(t=4),r[a]={type:n.type,location:i.getAttribLocation(s,a),locationSize:t}}return r}function Ud(t){return""!==t}function Fd(t,e){var i=e.numSpotLightShadows+e.numSpotLightMaps-e.numSpotLightShadowsWithMaps;return t.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,e.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,i).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,e.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,e.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,e.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,e.numPointLightShadows)}function Bd(t,e){return t.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}function kd(t,e){return t.replace(/NUM_MASK_POLYGON/g,e.maskPolygonsNum).replace(/NUM_MASK_HOLE_POLYGON/g,e.maskHolePolygonsNum)}function Gd(t,e){return t.replace("<#ISPOINTINSIDEPOLYGON#>",e.maskParam).replace("<#ISPOINTINSIDEHOLEPOLYGON#>",e.maskHoleParam)}let Hd=/^[ \t]*#include +<([\w\d./]+)>/gm;function Vd(t){return t.replace(Hd,Wd)}let zd=new Map;function Wd(t,e){let i=b[e];if(void 0===i){var s=zd.get(e);if(void 0===s)throw new Error("Can not resolve #include <"+e+">");i=b[s],console.warn('THREE.WebGLRenderer: Shader chunk "%s" has been deprecated. Use "%s" instead.',e,s)}return Vd(i)}let jd=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function Xd(t){return t.replace(jd,Yd)}function Yd(t,e,i,s){let r="";for(let t=parseInt(e);t<parseInt(i);t++)r+=s.replace(/\[\s*i\s*\]/g,"[ "+t+" ]").replace(/UNROLLED_LOOP_INDEX/g,t);return r}function Zd(t){let e=`precision ${t.precision} float;
	precision ${t.precision} int;
	precision ${t.precision} sampler2D;
	precision ${t.precision} samplerCube;
	precision ${t.precision} sampler3D;
	precision ${t.precision} sampler2DArray;
	precision ${t.precision} sampler2DShadow;
	precision ${t.precision} samplerCubeShadow;
	precision ${t.precision} sampler2DArrayShadow;
	precision ${t.precision} isampler2D;
	precision ${t.precision} isampler3D;
	precision ${t.precision} isamplerCube;
	precision ${t.precision} isampler2DArray;
	precision ${t.precision} usampler2D;
	precision ${t.precision} usampler3D;
	precision ${t.precision} usamplerCube;
	precision ${t.precision} usampler2DArray;
	`;return"highp"===t.precision?e+="\n#define HIGH_PRECISION":"mediump"===t.precision?e+="\n#define MEDIUM_PRECISION":"lowp"===t.precision&&(e+="\n#define LOW_PRECISION"),e}function qd(t){let e="SHADOWMAP_TYPE_BASIC";return t.shadowMapType===i?e="SHADOWMAP_TYPE_PCF":t.shadowMapType===h?e="SHADOWMAP_TYPE_PCF_SOFT":t.shadowMapType===D&&(e="SHADOWMAP_TYPE_VSM"),e}function Kd(t){let e="ENVMAP_TYPE_CUBE";if(t.envMap)switch(t.envMapMode){case Pt:case Dt:e="ENVMAP_TYPE_CUBE";break;case Ft:e="ENVMAP_TYPE_CUBE_UV"}return e}function Jd(t){let e="ENVMAP_MODE_REFLECTION";return e=t.envMap&&t.envMapMode===Dt?"ENVMAP_MODE_REFRACTION":e}function $d(t){let e="ENVMAP_BLENDING_NONE";if(t.envMap)switch(t.combine){case o:e="ENVMAP_BLENDING_MULTIPLY";break;case l:e="ENVMAP_BLENDING_MIX";break;case y:e="ENVMAP_BLENDING_ADD"}return e}function Qd(t){var e,t=t.envMapCubeUVHeight;return null===t?null:(e=Math.log2(t)-2,t=1/t,{texelWidth:1/(3*Math.max(Math.pow(2,e),112)),texelHeight:t,maxMip:e})}function t0(o,t,e,i){let l=o.getContext();var s=e.defines,r=e.vertexShader,n=e.fragmentShader,a=qd(e),h=Kd(e),u=Jd(e),c=$d(e),f=Qd(e),d=Pd(e),s=Dd(s);let v=l.createProgram(),p,m,g=e.glslVersion?"#version "+e.glslVersion+"\n":"";e.isRawShaderMaterial?(0<(p=["#define SHADER_TYPE "+e.shaderType,"#define SHADER_NAME "+e.shaderName,s].filter(Ud).join("\n")).length&&(p+="\n"),0<(m=["#define SHADER_TYPE "+e.shaderType,"#define SHADER_NAME "+e.shaderName,s].filter(Ud).join("\n")).length&&(m+="\n")):(p=[Zd(e),"#define SHADER_TYPE "+e.shaderType,"#define SHADER_NAME "+e.shaderName,s,e.modelSideGradient?"#define USE_UV":"",e.modelSideGradient?"#define USE_MODEL_SIDE_GRADIENT":"",e.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",e.batching?"#define USE_BATCHING":"",e.batchingColor?"#define USE_BATCHING_COLOR":"",e.instancing?"#define USE_INSTANCING":"",e.instancingColor?"#define USE_INSTANCING_COLOR":"",e.instancingMorph?"#define USE_INSTANCING_MORPH":"",e.useFog&&e.fog?"#define USE_FOG":"",e.useFog&&e.fogExp2?"#define FOG_EXP2":"",e.map?"#define USE_MAP":"",e.envMap?"#define USE_ENVMAP":"",e.envMap?"#define "+u:"",e.lightMap?"#define USE_LIGHTMAP":"",e.aoMap?"#define USE_AOMAP":"",e.bumpMap?"#define USE_BUMPMAP":"",e.normalMap?"#define USE_NORMALMAP":"",e.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",e.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",e.displacementMap?"#define USE_DISPLACEMENTMAP":"",e.emissiveMap?"#define USE_EMISSIVEMAP":"",e.anisotropy?"#define USE_ANISOTROPY":"",e.anisotropyMap?"#define USE_ANISOTROPYMAP":"",e.clearcoatMap?"#define USE_CLEARCOATMAP":"",e.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",e.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",e.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",e.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",e.specularMap?"#define USE_SPECULARMAP":"",e.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",e.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",e.roughnessMap?"#define USE_ROUGHNESSMAP":"",e.metalnessMap?"#define USE_METALNESSMAP":"",e.alphaMap?"#define USE_ALPHAMAP":"",e.alphaHash?"#define USE_ALPHAHASH":"",e.transmission?"#define USE_TRANSMISSION":"",e.transmissionMap?"#define USE_TRANSMISSIONMAP":"",e.thicknessMap?"#define USE_THICKNESSMAP":"",e.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",e.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",e.mapUv?"#define MAP_UV "+e.mapUv:"",e.alphaMapUv?"#define ALPHAMAP_UV "+e.alphaMapUv:"",e.lightMapUv?"#define LIGHTMAP_UV "+e.lightMapUv:"",e.aoMapUv?"#define AOMAP_UV "+e.aoMapUv:"",e.emissiveMapUv?"#define EMISSIVEMAP_UV "+e.emissiveMapUv:"",e.bumpMapUv?"#define BUMPMAP_UV "+e.bumpMapUv:"",e.normalMapUv?"#define NORMALMAP_UV "+e.normalMapUv:"",e.displacementMapUv?"#define DISPLACEMENTMAP_UV "+e.displacementMapUv:"",e.metalnessMapUv?"#define METALNESSMAP_UV "+e.metalnessMapUv:"",e.roughnessMapUv?"#define ROUGHNESSMAP_UV "+e.roughnessMapUv:"",e.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+e.anisotropyMapUv:"",e.clearcoatMapUv?"#define CLEARCOATMAP_UV "+e.clearcoatMapUv:"",e.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+e.clearcoatNormalMapUv:"",e.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+e.clearcoatRoughnessMapUv:"",e.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+e.iridescenceMapUv:"",e.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+e.iridescenceThicknessMapUv:"",e.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+e.sheenColorMapUv:"",e.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+e.sheenRoughnessMapUv:"",e.specularMapUv?"#define SPECULARMAP_UV "+e.specularMapUv:"",e.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+e.specularColorMapUv:"",e.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+e.specularIntensityMapUv:"",e.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+e.transmissionMapUv:"",e.thicknessMapUv?"#define THICKNESSMAP_UV "+e.thicknessMapUv:"",e.vertexTangents&&!1===e.flatShading?"#define USE_TANGENT":"",e.vertexColors?"#define USE_COLOR":"",e.vertexAlphas?"#define USE_COLOR_ALPHA":"",e.vertexUv1s?"#define USE_UV1":"",e.vertexUv2s?"#define USE_UV2":"",e.vertexUv3s?"#define USE_UV3":"",e.pointsUvs?"#define USE_POINTS_UV":"",e.flatShading?"#define FLAT_SHADED":"",e.skinning?"#define USE_SKINNING":"",e.morphTargets?"#define USE_MORPHTARGETS":"",e.morphNormals&&!1===e.flatShading?"#define USE_MORPHNORMALS":"",e.morphColors?"#define USE_MORPHCOLORS":"",0<e.morphTargetsCount?"#define MORPHTARGETS_TEXTURE_STRIDE "+e.morphTextureStride:"",0<e.morphTargetsCount?"#define MORPHTARGETS_COUNT "+e.morphTargetsCount:"",e.doubleSided?"#define DOUBLE_SIDED":"",e.flipSided?"#define FLIP_SIDED":"",e.shadowMapEnabled?"#define USE_SHADOWMAP":"",e.shadowMapEnabled?"#define "+a:"",e.sizeAttenuation?"#define USE_SIZEATTENUATION":"",0<e.numLightProbes?"#define USE_LIGHT_PROBES":"",e.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",e.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","#ifdef USE_INSTANCING_MORPH","\tuniform sampler2D morphTexture;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","\tattribute vec2 uv1;","#endif","#ifdef USE_UV2","\tattribute vec2 uv2;","#endif","#ifdef USE_UV3","\tattribute vec2 uv3;","#endif","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(Ud).join("\n"),m=[Zd(e),"#define SHADER_TYPE "+e.shaderType,"#define SHADER_NAME "+e.shaderName,s,e.useFog&&e.fog?"#define USE_FOG":"",e.useFog&&e.fogExp2?"#define FOG_EXP2":"",e.modelSideGradient?"#define USE_UV":"",e.modelSideGradient?"#define USE_MODEL_SIDE_GRADIENT":"",e.isIgnoreLighting?"#define IGNORE_LIGHTING":"",e.alphaToCoverage?"#define ALPHA_TO_COVERAGE":"",e.map?"#define USE_MAP":"",e.matcap?"#define USE_MATCAP":"",e.envMap?"#define USE_ENVMAP":"",e.envMap?"#define "+h:"",e.envMap?"#define "+u:"",e.envMap?"#define "+c:"",f?"#define CUBEUV_TEXEL_WIDTH "+f.texelWidth:"",f?"#define CUBEUV_TEXEL_HEIGHT "+f.texelHeight:"",f?"#define CUBEUV_MAX_MIP "+f.maxMip+".0":"",e.lightMap?"#define USE_LIGHTMAP":"",e.aoMap?"#define USE_AOMAP":"",e.bumpMap?"#define USE_BUMPMAP":"",e.normalMap?"#define USE_NORMALMAP":"",e.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",e.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",e.emissiveMap?"#define USE_EMISSIVEMAP":"",e.anisotropy?"#define USE_ANISOTROPY":"",e.anisotropyMap?"#define USE_ANISOTROPYMAP":"",e.clearcoat?"#define USE_CLEARCOAT":"",e.clearcoatMap?"#define USE_CLEARCOATMAP":"",e.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",e.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",e.dispersion?"#define USE_DISPERSION":"",e.iridescence?"#define USE_IRIDESCENCE":"",e.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",e.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",e.specularMap?"#define USE_SPECULARMAP":"",e.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",e.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",e.roughnessMap?"#define USE_ROUGHNESSMAP":"",e.metalnessMap?"#define USE_METALNESSMAP":"",e.alphaMap?"#define USE_ALPHAMAP":"",e.alphaTest?"#define USE_ALPHATEST":"",e.alphaHash?"#define USE_ALPHAHASH":"",e.sheen?"#define USE_SHEEN":"",e.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",e.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",e.transmission?"#define USE_TRANSMISSION":"",e.transmissionMap?"#define USE_TRANSMISSIONMAP":"",e.thicknessMap?"#define USE_THICKNESSMAP":"",e.vertexTangents&&!1===e.flatShading?"#define USE_TANGENT":"",e.vertexColors||e.instancingColor||e.batchingColor?"#define USE_COLOR":"",e.vertexAlphas?"#define USE_COLOR_ALPHA":"",e.vertexUv1s?"#define USE_UV1":"",e.vertexUv2s?"#define USE_UV2":"",e.vertexUv3s?"#define USE_UV3":"",e.pointsUvs?"#define USE_POINTS_UV":"",e.gradientMap?"#define USE_GRADIENTMAP":"",e.flatShading?"#define FLAT_SHADED":"",e.doubleSided?"#define DOUBLE_SIDED":"",e.flipSided?"#define FLIP_SIDED":"",e.shadowMapEnabled?"#define USE_SHADOWMAP":"",e.shadowMapEnabled?"#define "+a:"",e.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",0<e.numLightProbes?"#define USE_LIGHT_PROBES":"",e.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",e.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",e.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",e.toneMapping!==qt?"#define TONE_MAPPING":"",e.toneMapping!==qt?b.tonemapping_pars_fragment:"",e.toneMapping!==qt?Cd("toneMapping",e.toneMapping):"",e.dithering?"#define DITHERING":"",e.opaque?"#define OPAQUE":"",b.colorspace_pars_fragment,Ld("linearToOutputTexel",e.outputColorSpace),Id(),e.useDepthPacking?"#define DEPTH_PACKING "+e.depthPacking:"","\n"].filter(Ud).join("\n")),r=kd(Bd(Fd(Vd(r),e),e),e),n=Gd(kd(Bd(Fd(Vd(n),e),e),e),e),r=Xd(r),n=Xd(n),!0!==e.isRawShaderMaterial&&(g="#version 300 es\n",p=[d,"#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+p,m=["#define varying in",e.glslVersion===ji?"":"layout(location = 0) out highp vec4 pc_fragColor;",e.glslVersion===ji?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+m);s=g+p+r,h=g+m+n;let _=xd(l,l.VERTEX_SHADER,s),w=xd(l,l.FRAGMENT_SHADER,h);function M(i){if(o.debug.checkShaderErrors){var s,r,n=l.getProgramInfoLog(v).trim(),a=l.getShaderInfoLog(_).trim(),h=l.getShaderInfoLog(w).trim();let t=!0,e=!0;!1===l.getProgramParameter(v,l.LINK_STATUS)?(t=!1,"function"==typeof o.debug.onShaderError?o.debug.onShaderError(l,v,_,w):(s=Rd(l,_,"vertex"),r=Rd(l,w,"fragment"),console.error("THREE.WebGLProgram: Shader Error "+l.getError()+" - VALIDATE_STATUS "+l.getProgramParameter(v,l.VALIDATE_STATUS)+"\n\nMaterial Name: "+i.name+"\nMaterial Type: "+i.type+"\n\nProgram Info Log: "+n+"\n"+s+"\n"+r))):""!==n?console.warn("THREE.WebGLProgram: Program Info Log:",n):""!==a&&""!==h||(e=!1),e&&(i.diagnostics={runnable:t,programLog:n,vertexShader:{log:a,prefix:p},fragmentShader:{log:h,prefix:m}})}l.deleteShader(_),l.deleteShader(w),y=new Ed(l,v),E=Od(l,v)}l.attachShader(v,_),l.attachShader(v,w),void 0!==e.index0AttributeName?l.bindAttribLocation(v,0,e.index0AttributeName):!0===e.morphTargets&&l.bindAttribLocation(v,0,"position"),l.linkProgram(v);let y;this.getUniforms=function(){return void 0===y&&M(this),y};let E,x=!(this.getAttributes=function(){return void 0===E&&M(this),E})===e.rendererExtensionParallelShaderCompile;return this.isReady=function(){return x=!1===x?l.getProgramParameter(v,bd):x},this.destroy=function(){i.releaseStatesOfProgram(this),l.deleteProgram(v),this.program=void 0},this.type=e.shaderType,this.name=e.shaderName,this.id=Sd++,this.cacheKey=t,this.usedTimes=1,this.program=v,this.vertexShader=_,this.fragmentShader=w,this}let e0=0;class i0{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(t){var e=t.vertexShader,i=t.fragmentShader,e=this.Nn(e),i=this.Nn(i),t=this.Pn(t);return!1===t.has(e)&&(t.add(e),e.usedTimes++),!1===t.has(i)&&(t.add(i),i.usedTimes++),this}remove(t){var e;for(e of this.materialCache.get(t))e.usedTimes--,0===e.usedTimes&&this.shaderCache.delete(e.code);return this.materialCache.delete(t),this}getVertexShaderID(t){return this.Nn(t.vertexShader).id}getFragmentShaderID(t){return this.Nn(t.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}Pn(t){var e=this.materialCache;let i=e.get(t);return void 0===i&&(i=new Set,e.set(t,i)),i}Nn(t){var e=this.shaderCache;let i=e.get(t);return void 0===i&&(i=new s0(t),e.set(t,i)),i}}class s0{constructor(t){this.id=e0++,this.code=t,this.usedTimes=0}}function r0(tt,et,it,st,rt,e,nt){let n=new Ds,at=new i0,ht=new Set,a=[],ot=rt.logarithmicDepthBuffer,lt=rt.reverseDepthBuffer,ut=rt.vertexTextures,ct=rt.precision,ft={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite",FMMeshLambertMaterial:"fmLambert",FMMeshStandardMaterial:"fmStandard",FMLineBasicMaterial:"fmbasic",FMMeshBasicMaterial:"fmbasic"};function dt(t){return ht.add(t),0===t?"uv":"uv"+t}return{getParameters:function(t,e,U,i,s){var r=i.fog,n=s.geometry,i=t.isMeshStandardMaterial?i.environment:null,F=(i=(t.isMeshStandardMaterial?it:et).get(t.envMap||i))&&i.mapping===Ft?i.image.height:null,a=ft[t.type];null!==t.precision&&(ct=rt.getMaxPrecision(t.precision))!==t.precision&&console.warn("THREE.WebGLProgram.getParameters:",t.precision,"not supported, using",ct,"instead.");var h=void 0!==(h=n.morphAttributes.position||n.morphAttributes.normal||n.morphAttributes.color)?h.length:0;let o=0;void 0!==n.morphAttributes.position&&(o=1),void 0!==n.morphAttributes.normal&&(o=2),void 0!==n.morphAttributes.color&&(o=3);let l,u,c,f;a?(d=mc[a],l=d.vertexShader,u=d.fragmentShader):(l=t.vertexShader,u=t.fragmentShader,at.update(t),c=at.getVertexShaderID(t),f=at.getFragmentShaderID(t));var d=tt.getRenderTarget(),v=!0===s.isInstancedMesh,p=!0===s.isBatchedMesh,m=!!t.map,B=!!t.matcap,g=!!i,_=!!t.aoMap,w=!!t.lightMap,M=!!t.bumpMap,y=!!t.normalMap,E=!!t.displacementMap,x=!!t.emissiveMap,b=!!t.metalnessMap,S=!!t.roughnessMap,A=0<t.anisotropy,T=0<t.clearcoat,k=0<t.dispersion,R=0<t.iridescence,L=0<t.sheen,C=0<t.transmission,N=A&&!!t.anisotropyMap,I=T&&!!t.clearcoatMap,P=T&&!!t.clearcoatNormalMap,D=T&&!!t.clearcoatRoughnessMap,G=R&&!!t.iridescenceMap,H=R&&!!t.iridescenceThicknessMap,V=L&&!!t.sheenColorMap,z=L&&!!t.sheenRoughnessMap,W=!!t.specularMap,j=!!t.specularColorMap,X=!!t.specularIntensityMap,Y=C&&!!t.transmissionMap,Z=C&&!!t.thicknessMap,q=!!t.gradientMap,O=!!t.alphaMap,K=0<t.alphaTest,J=!!t.alphaHash,$=!!t.extensions;let Q=qt;return!t.toneMapped||null!==d&&!0!==d.isXRRenderTarget||(Q=tt.toneMapping),(a={shaderID:a,shaderType:t.type,shaderName:t.name,vertexShader:l,fragmentShader:u,defines:t.defines,customVertexShaderID:c,customFragmentShaderID:f,isRawShaderMaterial:!0===t.isRawShaderMaterial,glslVersion:t.glslVersion,precision:ct,batching:p,batchingColor:p&&null!==s._colorsTexture,instancing:v,instancingColor:v&&null!==s.instanceColor,instancingMorph:v&&null!==s.morphTexture,supportsVertexTextures:ut,outputColorSpace:null===d?tt.outputColorSpace:!0===d.isXRRenderTarget?d.texture.colorSpace:Si,alphaToCoverage:!!t.alphaToCoverage,map:m,matcap:B,envMap:g,envMapMode:g&&i.mapping,envMapCubeUVHeight:F,aoMap:_,lightMap:w,bumpMap:M,normalMap:y,displacementMap:ut&&E,emissiveMap:x,normalMapObjectSpace:y&&t.normalMapType===Ei,normalMapTangentSpace:y&&t.normalMapType===yi,metalnessMap:b,roughnessMap:S,anisotropy:A,anisotropyMap:N,clearcoat:T,clearcoatMap:I,clearcoatNormalMap:P,clearcoatRoughnessMap:D,dispersion:k,iridescence:R,iridescenceMap:G,iridescenceThicknessMap:H,sheen:L,sheenColorMap:V,sheenRoughnessMap:z,specularMap:W,specularColorMap:j,specularIntensityMap:X,transmission:C,transmissionMap:Y,thicknessMap:Z,gradientMap:q,opaque:!1===t.transparent&&t.blending===vt&&!1===t.alphaToCoverage,alphaMap:O,alphaTest:K,alphaHash:J,combine:t.combine,mapUv:m&&dt(t.map.channel),aoMapUv:_&&dt(t.aoMap.channel),lightMapUv:w&&dt(t.lightMap.channel),bumpMapUv:M&&dt(t.bumpMap.channel),normalMapUv:y&&dt(t.normalMap.channel),displacementMapUv:E&&dt(t.displacementMap.channel),emissiveMapUv:x&&dt(t.emissiveMap.channel),metalnessMapUv:b&&dt(t.metalnessMap.channel),roughnessMapUv:S&&dt(t.roughnessMap.channel),anisotropyMapUv:N&&dt(t.anisotropyMap.channel),clearcoatMapUv:I&&dt(t.clearcoatMap.channel),clearcoatNormalMapUv:P&&dt(t.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:D&&dt(t.clearcoatRoughnessMap.channel),iridescenceMapUv:G&&dt(t.iridescenceMap.channel),iridescenceThicknessMapUv:H&&dt(t.iridescenceThicknessMap.channel),sheenColorMapUv:V&&dt(t.sheenColorMap.channel),sheenRoughnessMapUv:z&&dt(t.sheenRoughnessMap.channel),specularMapUv:W&&dt(t.specularMap.channel),specularColorMapUv:j&&dt(t.specularColorMap.channel),specularIntensityMapUv:X&&dt(t.specularIntensityMap.channel),transmissionMapUv:Y&&dt(t.transmissionMap.channel),thicknessMapUv:Z&&dt(t.thicknessMap.channel),alphaMapUv:O&&dt(t.alphaMap.channel),vertexTangents:!!n.attributes.tangent&&(y||A),vertexColors:t.vertexColors,vertexAlphas:!0===t.vertexColors&&!!n.attributes.color&&4===n.attributes.color.itemSize,pointsUvs:!0===s.isPoints&&!!n.attributes.uv&&(m||O),fog:!!r,useFog:!0===t.fog,fogExp2:!!r&&r.isFogExp2,flatShading:!0===t.flatShading,sizeAttenuation:!0===t.sizeAttenuation,logarithmicDepthBuffer:ot,reverseDepthBuffer:lt,skinning:!0===s.isSkinnedMesh,morphTargets:void 0!==n.morphAttributes.position,morphNormals:void 0!==n.morphAttributes.normal,morphColors:void 0!==n.morphAttributes.color,morphTargetsCount:h,morphTextureStride:o,numDirLights:e.directional.length,numPointLights:e.point.length,numSpotLights:e.spot.length,numSpotLightMaps:e.spotLightMap.length,numRectAreaLights:e.rectArea.length,numHemiLights:e.hemi.length,numDirLightShadows:e.directionalShadowMap.length,numPointLightShadows:e.pointShadowMap.length,numSpotLightShadows:e.spotShadowMap.length,numSpotLightShadowsWithMaps:e.numSpotLightShadowsWithMaps,numLightProbes:e.numLightProbes,numClippingPlanes:nt.numPlanes,numClipIntersection:nt.numIntersection,dithering:t.dithering,shadowMapEnabled:tt.shadowMap.enabled&&0<U.length,shadowMapType:tt.shadowMap.type,toneMapping:Q,decodeVideoTexture:m&&!0===t.map.isVideoTexture&&zt.getTransfer(t.map.colorSpace)===Li,premultipliedAlpha:t.premultipliedAlpha,doubleSided:t.side===Zt,flipSided:t.side===Yt,useDepthPacking:0<=t.depthPacking,depthPacking:t.depthPacking||0,index0AttributeName:t.index0AttributeName,extensionClipCullDistance:$&&!0===t.extensions.clipCullDistance&&st.has("WEBGL_clip_cull_distance"),extensionMultiDraw:($&&!0===t.extensions.multiDraw||p)&&st.has("WEBGL_multi_draw"),rendererExtensionParallelShaderCompile:st.has("KHR_parallel_shader_compile"),customProgramCacheKey:t.customProgramCacheKey(),maskPolygonsNum:void 0!==t.maskPolygons?t.maskPolygons.length:0,maskHolePolygonsNum:void 0!==t.maskHolePogygons?t.maskHolePogygons.length:0,maskParam:void 0!==t.maskParam?t.maskParam:"",maskHoleParam:void 0!==t.maskHoleParam?t.maskHoleParam:"",modelSideGradient:void 0!==t.modelSideGradient&&t.modelSideGradient,isIgnoreLighting:void 0!==t.isIgnoreLighting&&t.isIgnoreLighting}).vertexUv1s=ht.has(1),a.vertexUv2s=ht.has(2),a.vertexUv3s=ht.has(3),ht.clear(),a},getProgramCacheKey:function(t){var e,i,s=[];if(t.shaderID?s.push(t.shaderID):(s.push(t.customVertexShaderID),s.push(t.customFragmentShaderID)),void 0!==t.defines)for(var r in t.defines)s.push(r),s.push(t.defines[r]);return!1===t.isRawShaderMaterial&&((e=s).push((i=t).precision),e.push(i.outputColorSpace),e.push(i.envMapMode),e.push(i.envMapCubeUVHeight),e.push(i.mapUv),e.push(i.alphaMapUv),e.push(i.lightMapUv),e.push(i.aoMapUv),e.push(i.bumpMapUv),e.push(i.normalMapUv),e.push(i.displacementMapUv),e.push(i.emissiveMapUv),e.push(i.metalnessMapUv),e.push(i.roughnessMapUv),e.push(i.anisotropyMapUv),e.push(i.clearcoatMapUv),e.push(i.clearcoatNormalMapUv),e.push(i.clearcoatRoughnessMapUv),e.push(i.iridescenceMapUv),e.push(i.iridescenceThicknessMapUv),e.push(i.sheenColorMapUv),e.push(i.sheenRoughnessMapUv),e.push(i.specularMapUv),e.push(i.specularColorMapUv),e.push(i.specularIntensityMapUv),e.push(i.transmissionMapUv),e.push(i.thicknessMapUv),e.push(i.combine),e.push(i.fogExp2),e.push(i.sizeAttenuation),e.push(i.morphTargetsCount),e.push(i.morphAttributeCount),e.push(i.numDirLights),e.push(i.numPointLights),e.push(i.numSpotLights),e.push(i.numSpotLightMaps),e.push(i.numHemiLights),e.push(i.numRectAreaLights),e.push(i.numDirLightShadows),e.push(i.numPointLightShadows),e.push(i.numSpotLightShadows),e.push(i.numSpotLightShadowsWithMaps),e.push(i.numLightProbes),e.push(i.shadowMapType),e.push(i.toneMapping),e.push(i.numClippingPlanes),e.push(i.numClipIntersection),e.push(i.depthPacking),e.push(i.maskPolygonsNum),e.push(i.maskHolePolygonsNum),e.push(i.modelSideGradient),e.push(i.isIgnoreLighting),e=s,i=t,n.disableAll(),i.supportsVertexTextures&&n.enable(0),i.instancing&&n.enable(1),i.instancingColor&&n.enable(2),i.instancingMorph&&n.enable(3),i.matcap&&n.enable(4),i.envMap&&n.enable(5),i.normalMapObjectSpace&&n.enable(6),i.normalMapTangentSpace&&n.enable(7),i.clearcoat&&n.enable(8),i.iridescence&&n.enable(9),i.alphaTest&&n.enable(10),i.vertexColors&&n.enable(11),i.vertexAlphas&&n.enable(12),i.vertexUv1s&&n.enable(13),i.vertexUv2s&&n.enable(14),i.vertexUv3s&&n.enable(15),i.vertexTangents&&n.enable(16),i.anisotropy&&n.enable(17),i.alphaHash&&n.enable(18),i.batching&&n.enable(19),i.dispersion&&n.enable(20),i.batchingColor&&n.enable(21),e.push(n.mask),n.disableAll(),i.fog&&n.enable(0),i.useFog&&n.enable(1),i.flatShading&&n.enable(2),i.logarithmicDepthBuffer&&n.enable(3),i.reverseDepthBuffer&&n.enable(4),i.skinning&&n.enable(5),i.morphTargets&&n.enable(6),i.morphNormals&&n.enable(7),i.morphColors&&n.enable(8),i.premultipliedAlpha&&n.enable(9),i.shadowMapEnabled&&n.enable(10),i.doubleSided&&n.enable(11),i.flipSided&&n.enable(12),i.useDepthPacking&&n.enable(13),i.dithering&&n.enable(14),i.transmission&&n.enable(15),i.sheen&&n.enable(16),i.opaque&&n.enable(17),i.pointsUvs&&n.enable(18),i.decodeVideoTexture&&n.enable(19),i.alphaToCoverage&&n.enable(20),e.push(n.mask),s.push(tt.outputColorSpace)),s.push(t.customProgramCacheKey),s.join()},getUniforms:function(t){var e=ft[t.type];let i;return i=e?(e=mc[e],Gh.clone(e.uniforms)):t.uniforms},acquireProgram:function(t,i){let s;for(let t=0,e=a.length;t<e;t++){var r=a[t];if(r.cacheKey===i){++(s=r).usedTimes;break}}return void 0===s&&(s=new t0(tt,i,t,e),a.push(s)),s},releaseProgram:function(t){var e;0==--t.usedTimes&&(e=a.indexOf(t),a[e]=a[a.length-1],a.pop(),t.destroy())},releaseShaderCache:function(t){at.remove(t)},programs:a,dispose:function(){at.dispose()}}}function n0(){let s=new WeakMap;return{has:function(t){return s.has(t)},get:function(t){let e=s.get(t);return void 0===e&&(e={},s.set(t,e)),e},remove:function(t){s.delete(t)},update:function(t,e,i){s.get(t)[e]=i},dispose:function(){s=new WeakMap}}}function a0(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.material.id!==e.material.id?t.material.id-e.material.id:t.z!==e.z?t.z-e.z:t.id-e.id}function h0(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:t.id-e.id}function o0(){let h=[],o=0,a=[],l=[],u=[];function c(t,e,i,s,r,n){let a=h[o];return void 0===a?(a={id:t.id,object:t,geometry:e,material:i,groupOrder:s,renderOrder:t.renderOrder,z:r,group:n},h[o]=a):(a.id=t.id,a.object=t,a.geometry=e,a.material=i,a.groupOrder=s,a.renderOrder=t.renderOrder,a.z=r,a.group=n),o++,a}return{opaque:a,transmissive:l,transparent:u,init:function(){o=0,a.length=0,l.length=0,u.length=0},push:function(t,e,i,s,r,n){t=c(t,e,i,s,r,n),(0<i.transmission?l:!0===i.transparent?u:a).push(t)},unshift:function(t,e,i,s,r,n){t=c(t,e,i,s,r,n),(0<i.transmission?l:!0===i.transparent?u:a).unshift(t)},finish:function(){for(let t=o,e=h.length;t<e;t++){var i=h[t];if(null===i.id)break;i.id=null,i.object=null,i.geometry=null,i.material=null,i.group=null}},sort:function(t,e){1<a.length&&a.sort(t||a0),1<l.length&&l.sort(e||h0),1<u.length&&u.sort(e||h0)}}}function l0(){let r=new WeakMap;return{get:function(t,e){var i=r.get(t);let s;return void 0===i?(s=new o0,r.set(t,[s])):e>=i.length?(s=new o0,i.push(s)):s=i[e],s},dispose:function(){r=new WeakMap}}}function u0(){let i={};return{get:function(t){if(void 0!==i[t.id])return i[t.id];let e;switch(t.type){case"DirectionalLight":e={direction:new Gt,color:new Wt};break;case"SpotLight":e={position:new Gt,direction:new Gt,color:new Wt,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":e={position:new Gt,color:new Wt,distance:0,decay:0};break;case"HemisphereLight":e={direction:new Gt,skyColor:new Wt,groundColor:new Wt};break;case"RectAreaLight":e={color:new Wt,position:new Gt,halfWidth:new Gt,halfHeight:new Gt}}return i[t.id]=e}}}function c0(){let i={};return{get:function(t){if(void 0!==i[t.id])return i[t.id];let e;switch(t.type){case"DirectionalLight":case"SpotLight":e={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new ct};break;case"PointLight":e={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new ct,shadowCameraNear:1,shadowCameraFar:1e3}}return i[t.id]=e}}}let f0=0;function d0(t,e){return(e.castShadow?2:0)-(t.castShadow?2:0)+(e.map?1:0)-(t.map?1:0)}function v0(e){let A=new u0,T=c0(),R={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let t=0;t<9;t++)R.probe.push(new Gt);let d=new Gt,v=new Ht,p=new Ht;return{setup:function(i){let s=0,r=0,n=0;for(let t=0;t<9;t++)R.probe[t].set(0,0,0);let a=0,h=0,o=0,l=0,u=0,c=0,f=0,d=0,v=0,p=0,m=0;i.sort(d0);for(let t=0,e=i.length;t<e;t++){var g,_,w,M,y=i[t],E=y.color,x=y.intensity,b=y.distance,S=y.shadow&&y.shadow.map?y.shadow.map.texture:null;if(y.isAmbientLight)s+=E.r*x,r+=E.g*x,n+=E.b*x;else if(y.isLightProbe){for(let t=0;t<9;t++)R.probe[t].addScaledVector(y.sh.coefficients[t],x);m++}else y.isDirectionalLight?((w=A.get(y)).color.copy(y.color).multiplyScalar(y.intensity),y.castShadow&&(g=y.shadow,(_=T.get(y)).shadowIntensity=g.intensity,_.shadowBias=g.bias,_.shadowNormalBias=g.normalBias,_.shadowRadius=g.radius,_.shadowMapSize=g.mapSize,R.directionalShadow[a]=_,R.directionalShadowMap[a]=S,R.directionalShadowMatrix[a]=y.shadow.matrix,c++),R.directional[a]=w,a++):y.isSpotLight?((g=A.get(y)).position.setFromMatrixPosition(y.matrixWorld),g.color.copy(E).multiplyScalar(x),g.distance=b,g.coneCos=Math.cos(y.angle),g.penumbraCos=Math.cos(y.angle*(1-y.penumbra)),g.decay=y.decay,R.spot[o]=g,_=y.shadow,y.map&&(R.spotLightMap[v]=y.map,v++,_.updateMatrices(y),y.castShadow)&&p++,R.spotLightMatrix[o]=_.matrix,y.castShadow&&((w=T.get(y)).shadowIntensity=_.intensity,w.shadowBias=_.bias,w.shadowNormalBias=_.normalBias,w.shadowRadius=_.radius,w.shadowMapSize=_.mapSize,R.spotShadow[o]=w,R.spotShadowMap[o]=S,d++),o++):y.isRectAreaLight?((b=A.get(y)).color.copy(E).multiplyScalar(x),b.halfWidth.set(.5*y.width,0,0),b.halfHeight.set(0,.5*y.height,0),R.rectArea[l]=b,l++):y.isPointLight?((E=A.get(y)).color.copy(y.color).multiplyScalar(y.intensity),E.distance=y.distance,E.decay=y.decay,y.castShadow&&(b=y.shadow,(M=T.get(y)).shadowIntensity=b.intensity,M.shadowBias=b.bias,M.shadowNormalBias=b.normalBias,M.shadowRadius=b.radius,M.shadowMapSize=b.mapSize,M.shadowCameraNear=b.camera.near,M.shadowCameraFar=b.camera.far,R.pointShadow[h]=M,R.pointShadowMap[h]=S,R.pointShadowMatrix[h]=y.shadow.matrix,f++),R.point[h]=E,h++):y.isHemisphereLight&&((b=A.get(y)).skyColor.copy(y.color).multiplyScalar(x),b.groundColor.copy(y.groundColor).multiplyScalar(x),R.hemi[u]=b,u++)}0<l&&(!0===e.has("OES_texture_float_linear")?(R.rectAreaLTC1=P.LTC_FLOAT_1,R.rectAreaLTC2=P.LTC_FLOAT_2):(R.rectAreaLTC1=P.LTC_HALF_1,R.rectAreaLTC2=P.LTC_HALF_2)),R.ambient[0]=s,R.ambient[1]=r,R.ambient[2]=n;var t=R.hash;t.directionalLength===a&&t.pointLength===h&&t.spotLength===o&&t.rectAreaLength===l&&t.hemiLength===u&&t.numDirectionalShadows===c&&t.numPointShadows===f&&t.numSpotShadows===d&&t.numSpotMaps===v&&t.numLightProbes===m||(R.directional.length=a,R.spot.length=o,R.rectArea.length=l,R.point.length=h,R.hemi.length=u,R.directionalShadow.length=c,R.directionalShadowMap.length=c,R.pointShadow.length=f,R.pointShadowMap.length=f,R.spotShadow.length=d,R.spotShadowMap.length=d,R.directionalShadowMatrix.length=c,R.pointShadowMatrix.length=f,R.spotLightMatrix.length=d+v-p,R.spotLightMap.length=v,R.numSpotLightShadowsWithMaps=p,R.numLightProbes=m,t.directionalLength=a,t.pointLength=h,t.spotLength=o,t.rectAreaLength=l,t.hemiLength=u,t.numDirectionalShadows=c,t.numPointShadows=f,t.numSpotShadows=d,t.numSpotMaps=v,t.numLightProbes=m,R.version=f0++)},setupView:function(i,t){let s=0,r=0,n=0,a=0,h=0;var o=t.matrixWorldInverse;for(let t=0,e=i.length;t<e;t++){var l,u,c,f=i[t];f.isDirectionalLight?((l=R.directional[s]).direction.setFromMatrixPosition(f.matrixWorld),d.setFromMatrixPosition(f.target.matrixWorld),l.direction.sub(d),l.direction.transformDirection(o),s++):f.isSpotLight?((l=R.spot[n]).position.setFromMatrixPosition(f.matrixWorld),l.position.applyMatrix4(o),l.direction.setFromMatrixPosition(f.matrixWorld),d.setFromMatrixPosition(f.target.matrixWorld),l.direction.sub(d),l.direction.transformDirection(o),n++):f.isRectAreaLight?((u=R.rectArea[a]).position.setFromMatrixPosition(f.matrixWorld),u.position.applyMatrix4(o),p.identity(),v.copy(f.matrixWorld),v.premultiply(o),p.extractRotation(v),u.halfWidth.set(.5*f.width,0,0),u.halfHeight.set(0,.5*f.height,0),u.halfWidth.applyMatrix4(p),u.halfHeight.applyMatrix4(p),a++):f.isPointLight?((u=R.point[r]).position.setFromMatrixPosition(f.matrixWorld),u.position.applyMatrix4(o),r++):f.isHemisphereLight&&((c=R.hemi[h]).direction.setFromMatrixPosition(f.matrixWorld),c.direction.transformDirection(o),h++)}},state:R}}function p0(t){let e=new v0(t),i=[],s=[];let r={lightsArray:i,shadowsArray:s,camera:null,lights:e,transmissionRenderTarget:{}};return{init:function(t){r.camera=t,i.length=0,s.length=0},state:r,setupLights:function(){e.setup(i)},setupLightsView:function(t){e.setupView(i,t)},pushLight:function(t){i.push(t)},pushShadow:function(t){s.push(t)}}}function m0(r){let n=new WeakMap;return{get:function(t,e=0){var i=n.get(t);let s;return void 0===i?(s=new p0(r),n.set(t,[s])):e>=i.length?(s=new p0(r),i.push(s)):s=i[e],s},dispose:function(){n=new WeakMap}}}class g0 extends Oh{constructor(t){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=wi,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(t)}copy(t){return super.copy(t),this.depthPacking=t.depthPacking,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this}}class _0 extends Oh{constructor(t){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(t)}copy(t){return super.copy(t),this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this}}let w0=`
void main() {

	gl_Position = vec4( position, 1.0 );

}
`,M0=`
uniform sampler2D shadow_pass;
uniform vec2 resolution;
uniform float radius;

#include <packing>

void main() {

	const float samples = float( VSM_SAMPLES );

	float mean = 0.0;
	float squared_mean = 0.0;

	float uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );
	float uvStart = samples <= 1.0 ? 0.0 : - 1.0;
	for ( float i = 0.0; i < samples; i ++ ) {

		float uvOffset = uvStart + i * uvStride;

		#ifdef HORIZONTAL_PASS

			vec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );
			mean += distribution.x;
			squared_mean += distribution.y * distribution.y + distribution.x * distribution.x;

		#else

			float depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );
			mean += depth;
			squared_mean += depth * depth;

		#endif

	}

	mean = mean / samples;
	squared_mean = squared_mean / samples;

	float std_dev = sqrt( squared_mean - mean * mean );

	gl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );

}
`;function y0(m,g,t){let _=new Lr,w=new ct,M=new ct,y=new Vt,a=new g0({depthPacking:Mi}),h=new _0,o={},E=t.maxTextureSize,l={[Xt]:Yt,[Yt]:Xt,[Zt]:Zt},x=new zh({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new ct},radius:{value:4}},vertexShader:w0,fragmentShader:M0}),b=x.clone();b.defines.HORIZONTAL_PASS=1;t=new Nh;t.setAttribute("position",new N(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));let S=new L(t,x),A=this,T=(this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=i,this.type);function R(i,s,t,e){let r=null;i=!0===t.isPointLight?i.customDistanceMaterial:i.customDepthMaterial;if(void 0!==i)r=i;else if(r=!0===t.isPointLight?h:a,m.localClippingEnabled&&!0===s.clipShadows&&Array.isArray(s.clippingPlanes)&&0!==s.clippingPlanes.length||s.displacementMap&&0!==s.displacementScale||s.alphaMap&&0<s.alphaTest||s.map&&0<s.alphaTest){var i=r.uuid,n=s.uuid;let t=o[i],e=(void 0===t&&(t={},o[i]=t),t[n]);void 0===e&&(e=r.clone(),t[n]=e,s.addEventListener("dispose",u)),r=e}return r.visible=s.visible,r.wireframe=s.wireframe,e===D?r.side=null!==s.shadowSide?s.shadowSide:s.side:r.side=null!==s.shadowSide?s.shadowSide:l[s.side],r.alphaMap=s.alphaMap,r.alphaTest=s.alphaTest,r.map=s.map,r.clipShadows=s.clipShadows,r.clippingPlanes=s.clippingPlanes,r.clipIntersection=s.clipIntersection,r.displacementMap=s.displacementMap,r.displacementScale=s.displacementScale,r.displacementBias=s.displacementBias,r.wireframeLinewidth=s.wireframeLinewidth,r.linewidth=s.linewidth,!0===t.isPointLight&&!0===r.isMeshDistanceMaterial&&(m.properties.get(r).light=t),r}function u(t){for(var e in t.target.removeEventListener("dispose",u),o){var e=o[e],i=t.target.uuid;i in e&&(e[i].dispose(),delete e[i])}}this.render=function(i,s,r){if(!1!==A.enabled&&(!1!==A.autoUpdate||!1!==A.needsUpdate)&&0!==i.length){var t=m.getRenderTarget(),e=m.getActiveCubeFace(),n=m.getActiveMipmapLevel(),a=m.state,h=(a.setBlending(q),a.buffers.color.setClear(1,1,1,1),a.buffers.depth.setTest(!0),a.setScissorTest(!1),T!==D&&this.type===D),o=T===D&&this.type!==D;for(let t=0,e=i.length;t<e;t++){var l=i[t],u=l.shadow;if(void 0===u)console.warn("THREE.WebGLShadowMap:",l,"has no shadow.");else if(!1!==u.autoUpdate||!1!==u.needsUpdate){w.copy(u.mapSize);var c,f,d=u.getFrameExtents(),v=(w.multiply(d),M.copy(u.mapSize),(w.x>E||w.y>E)&&(w.x>E&&(M.x=Math.floor(E/d.x),w.x=M.x*d.x,u.mapSize.x=M.x),w.y>E)&&(M.y=Math.floor(E/d.y),w.y=M.y*d.y,u.mapSize.y=M.y),null!==u.map&&!0!=h&&!0!=o||(d=this.type!==D?{minFilter:Jt,magFilter:Jt}:{},null!==u.map&&u.map.dispose(),u.map=new Ic(w.x,w.y,d),u.map.texture.name=l.name+".shadowMap",u.camera.updateProjectionMatrix()),m.setRenderTarget(u.map),m.clear(),u.getViewportCount());for(let t=0;t<v;t++){var p=u.getViewport(t);y.set(M.x*p.x,M.y*p.y,M.x*p.z,M.y*p.w),a.viewport(y),u.updateMatrices(l,t),_=u.getFrustum(),!function i(a,h,o,l,u){if(!1===a.visible)return;let t=a.layers.test(h.layers);if(t&&(a.isMesh||a.isLine||a.isPoints)&&(a.castShadow||a.receiveShadow&&u===D)&&(!a.frustumCulled||_.intersectsObject(a))){a.modelViewMatrix.multiplyMatrices(o.matrixWorldInverse,a.matrixWorld);let r=g.update(a),n=a.material;if(Array.isArray(n)){let s=r.groups;for(let t=0,e=s.length;t<e;t++){let e=s[t],i=n[e.materialIndex];if(i&&i.visible){let t=R(a,i,l,u);a.onBeforeShadow(m,a,h,o,r,t,e),m.renderBufferDirect(o,null,r,t,a,e),a.onAfterShadow(m,a,h,o,r,t,e)}}}else if(n.visible){let t=R(a,n,l,u);a.onBeforeShadow(m,a,h,o,r,t,null),m.renderBufferDirect(o,null,r,t,a,null),a.onAfterShadow(m,a,h,o,r,t,null)}}let s=a.children;for(let t=0,e=s.length;t<e;t++)i(s[t],h,o,l,u)}(s,r,u.camera,l,this.type)}!0!==u.isPointLightShadow&&this.type===D&&(f=c=d=void 0,d=u,c=r,f=g.update(S),x.defines.VSM_SAMPLES!==d.blurSamples&&(x.defines.VSM_SAMPLES=d.blurSamples,b.defines.VSM_SAMPLES=d.blurSamples,x.needsUpdate=!0,b.needsUpdate=!0),null===d.mapPass&&(d.mapPass=new Ic(w.x,w.y)),x.uniforms.shadow_pass.value=d.map.texture,x.uniforms.resolution.value=d.mapSize,x.uniforms.radius.value=d.radius,m.setRenderTarget(d.mapPass),m.clear(),m.renderBufferDirect(c,null,f,x,S,null),b.uniforms.shadow_pass.value=d.mapPass.texture,b.uniforms.resolution.value=d.mapSize,b.uniforms.radius.value=d.radius,m.setRenderTarget(d.map),m.clear(),m.renderBufferDirect(c,null,f,b,S,null)),u.needsUpdate=!1}}T=this.type,A.needsUpdate=!1,m.setRenderTarget(t,e,n)}}}let E0={[St]:At,[Tt]:Nt,[Lt]:It,[Rt]:Ct,[At]:St,[Nt]:Tt,[It]:Lt,[Ct]:Rt};function x0(u){let s=new function(){let e=!1,n=new Vt,i=null,a=new Vt(0,0,0,0);return{setMask:function(t){i===t||e||(u.colorMask(t,t,t,t),i=t)},setLocked:function(t){e=t},setClear:function(t,e,i,s,r){!0===r&&(t*=s,e*=s,i*=s),n.set(t,e,i,s),!1===a.equals(n)&&(u.clearColor(t,e,i,s),a.copy(n))},reset:function(){e=!1,i=null,a.set(-1,0,0,0)}}},r=new function(){let e=!1,i=!1,s=null,r=null,n=null;return{setReversed:function(t){i=t},setTest:function(t){(t?N:I)(u.DEPTH_TEST)},setMask:function(t){s===t||e||(u.depthMask(t),s=t)},setFunc:function(t){if(i&&(t=E0[t]),r!==t){switch(t){case St:u.depthFunc(u.NEVER);break;case At:u.depthFunc(u.ALWAYS);break;case Tt:u.depthFunc(u.LESS);break;case Rt:u.depthFunc(u.LEQUAL);break;case Lt:u.depthFunc(u.EQUAL);break;case Ct:u.depthFunc(u.GEQUAL);break;case Nt:u.depthFunc(u.GREATER);break;case It:u.depthFunc(u.NOTEQUAL);break;default:u.depthFunc(u.LEQUAL)}r=t}},setLocked:function(t){e=t},setClear:function(t){n!==t&&(u.clearDepth(t),n=t)},reset:function(){e=!1,s=null,r=null,n=null}}},n=new function(){let e=!1,i=null,s=null,r=null,n=null,a=null,h=null,o=null,l=null;return{setTest:function(t){e||(t?N:I)(u.STENCIL_TEST)},setMask:function(t){i===t||e||(u.stencilMask(t),i=t)},setFunc:function(t,e,i){s===t&&r===e&&n===i||(u.stencilFunc(t,e,i),s=t,r=e,n=i)},setOp:function(t,e,i){a===t&&h===e&&o===i||(u.stencilOp(t,e,i),a=t,h=e,o=i)},setLocked:function(t){e=t},setClear:function(t){l!==t&&(u.clearStencil(t),l=t)},reset:function(){e=!1,i=null,s=null,r=null,n=null,a=null,h=null,o=null,l=null}}},U=new WeakMap,a=new WeakMap,e={},i={},h=new WeakMap,F=[],o=null,c=!1,f=null,d=null,v=null,p=null,m=null,g=null,_=null,w=new Wt(0,0,0),M=0,y=!1,l=null,E=null,x=null,b=null,S=null,B=u.getParameter(u.MAX_COMBINED_TEXTURE_IMAGE_UNITS),k=!1,t=0;var A=u.getParameter(u.VERSION);-1!==A.indexOf("WebGL")?(t=parseFloat(/^WebGL (\d)/.exec(A)[1]),k=1<=t):-1!==A.indexOf("OpenGL ES")&&(t=parseFloat(/^OpenGL ES (\d)/.exec(A)[1]),k=2<=t);let T=null,R={};var A=u.getParameter(u.SCISSOR_BOX),G=u.getParameter(u.VIEWPORT);let H=(new Vt).fromArray(A),V=(new Vt).fromArray(G);function L(e,i,s,r){var n=new Uint8Array(4),t=u.createTexture();u.bindTexture(e,t),u.texParameteri(e,u.TEXTURE_MIN_FILTER,u.NEAREST),u.texParameteri(e,u.TEXTURE_MAG_FILTER,u.NEAREST);for(let t=0;t<s;t++)e===u.TEXTURE_3D||e===u.TEXTURE_2D_ARRAY?u.texImage3D(i,0,u.RGBA,1,1,r,0,u.RGBA,u.UNSIGNED_BYTE,n):u.texImage2D(i+t,0,u.RGBA,1,1,0,u.RGBA,u.UNSIGNED_BYTE,n);return t}let C={};function N(t){!0!==e[t]&&(u.enable(t),e[t]=!0)}function I(t){!1!==e[t]&&(u.disable(t),e[t]=!1)}C[u.TEXTURE_2D]=L(u.TEXTURE_2D,u.TEXTURE_2D,1),C[u.TEXTURE_CUBE_MAP]=L(u.TEXTURE_CUBE_MAP,u.TEXTURE_CUBE_MAP_POSITIVE_X,6),C[u.TEXTURE_2D_ARRAY]=L(u.TEXTURE_2D_ARRAY,u.TEXTURE_2D_ARRAY,1,1),C[u.TEXTURE_3D]=L(u.TEXTURE_3D,u.TEXTURE_3D,1,1),s.setClear(0,0,0,1),r.setClear(1),n.setClear(0),N(u.DEPTH_TEST),r.setFunc(Rt),z(!1),W(Y),N(u.CULL_FACE),O(q);let P={[tt]:u.FUNC_ADD,[et]:u.FUNC_SUBTRACT,[it]:u.FUNC_REVERSE_SUBTRACT},D=(P[st]=u.MIN,P[rt]=u.MAX,{[ot]:u.ZERO,[lt]:u.ONE,[ut]:u.SRC_COLOR,[dt]:u.SRC_ALPHA,[Mt]:u.SRC_ALPHA_SATURATE,[_t]:u.DST_COLOR,[mt]:u.DST_ALPHA,[ft]:u.ONE_MINUS_SRC_COLOR,[pt]:u.ONE_MINUS_SRC_ALPHA,[wt]:u.ONE_MINUS_DST_COLOR,[gt]:u.ONE_MINUS_DST_ALPHA,[yt]:u.CONSTANT_COLOR,[Et]:u.ONE_MINUS_CONSTANT_COLOR,[xt]:u.CONSTANT_ALPHA,[bt]:u.ONE_MINUS_CONSTANT_ALPHA});function O(t,e,i,s,r,n,a,h,o,l){if(t===q)!0===c&&(I(u.BLEND),c=!1);else if(!1===c&&(N(u.BLEND),c=!0),t!==Q){if(t!==f||l!==y){if(d===tt&&m===tt||(u.blendEquation(u.FUNC_ADD),d=tt,m=tt),l)switch(t){case vt:u.blendFuncSeparate(u.ONE,u.ONE_MINUS_SRC_ALPHA,u.ONE,u.ONE_MINUS_SRC_ALPHA);break;case K:u.blendFunc(u.ONE,u.ONE);break;case J:u.blendFuncSeparate(u.ZERO,u.ONE_MINUS_SRC_COLOR,u.ZERO,u.ONE);break;case $:u.blendFuncSeparate(u.ZERO,u.SRC_COLOR,u.ZERO,u.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}else switch(t){case vt:u.blendFuncSeparate(u.SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA,u.ONE,u.ONE_MINUS_SRC_ALPHA);break;case K:u.blendFunc(u.SRC_ALPHA,u.ONE);break;case J:u.blendFuncSeparate(u.ZERO,u.ONE_MINUS_SRC_COLOR,u.ZERO,u.ONE);break;case $:u.blendFunc(u.ZERO,u.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}v=null,p=null,g=null,_=null,w.set(0,0,0),M=0,f=t,y=l}}else r=r||e,n=n||i,a=a||s,e===d&&r===m||(u.blendEquationSeparate(P[e],P[r]),d=e,m=r),i===v&&s===p&&n===g&&a===_||(u.blendFuncSeparate(D[i],D[s],D[n],D[a]),v=i,p=s,g=n,_=a),!1!==h.equals(w)&&o===M||(u.blendColor(h.r,h.g,h.b,o),w.copy(h),M=o),f=t,y=!1}function z(t){l!==t&&(t?u.frontFace(u.CW):u.frontFace(u.CCW),l=t)}function W(t){t!==X?(N(u.CULL_FACE),t!==E&&(t===Y?u.cullFace(u.BACK):t===Z?u.cullFace(u.FRONT):u.cullFace(u.FRONT_AND_BACK))):I(u.CULL_FACE),E=t}function j(t,e,i){t?(N(u.POLYGON_OFFSET_FILL),b===e&&S===i||(u.polygonOffset(e,i),b=e,S=i)):I(u.POLYGON_OFFSET_FILL)}return{buffers:{color:s,depth:r,stencil:n},enable:N,disable:I,bindFramebuffer:function(t,e){return i[t]!==e&&(u.bindFramebuffer(t,e),i[t]=e,t===u.DRAW_FRAMEBUFFER&&(i[u.FRAMEBUFFER]=e),t===u.FRAMEBUFFER&&(i[u.DRAW_FRAMEBUFFER]=e),!0)},drawBuffers:function(t,i){let s=F,e=!1;if(t){void 0===(s=h.get(i))&&(s=[],h.set(i,s));i=t.textures;if(s.length!==i.length||s[0]!==u.COLOR_ATTACHMENT0){for(let t=0,e=i.length;t<e;t++)s[t]=u.COLOR_ATTACHMENT0+t;s.length=i.length,e=!0}}else s[0]!==u.BACK&&(s[0]=u.BACK,e=!0);e&&u.drawBuffers(s)},useProgram:function(t){return o!==t&&(u.useProgram(t),o=t,!0)},setBlending:O,setMaterial:function(t,e){(t.side===Zt?I:N)(u.CULL_FACE);let i=t.side===Yt;z(i=e?!i:i),t.blending===vt&&!1===t.transparent?O(q):O(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.blendColor,t.blendAlpha,t.premultipliedAlpha),r.setFunc(t.depthFunc),r.setTest(t.depthTest),r.setMask(t.depthWrite),s.setMask(t.colorWrite),e=t.stencilWrite,n.setTest(e),e&&(n.setMask(t.stencilWriteMask),n.setFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask),n.setOp(t.stencilFail,t.stencilZFail,t.stencilZPass)),j(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits),(!0===t.alphaToCoverage?N:I)(u.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:z,setCullFace:W,setLineWidth:function(t){t!==x&&(k&&u.lineWidth(t),x=t)},setPolygonOffset:j,setScissorTest:function(t){(t?N:I)(u.SCISSOR_TEST)},activeTexture:function(t){void 0===t&&(t=u.TEXTURE0+B-1),T!==t&&(u.activeTexture(t),T=t)},bindTexture:function(t,e,i){void 0===i&&(i=null===T?u.TEXTURE0+B-1:T);let s=R[i];void 0===s&&(s={type:void 0,texture:void 0},R[i]=s),s.type===t&&s.texture===e||(T!==i&&(u.activeTexture(i),T=i),u.bindTexture(t,e||C[t]),s.type=t,s.texture=e)},unbindTexture:function(){var t=R[T];void 0!==t&&void 0!==t.type&&(u.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{u.compressedTexImage2D.apply(u,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},compressedTexImage3D:function(){try{u.compressedTexImage3D.apply(u,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage2D:function(){try{u.texImage2D.apply(u,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage3D:function(){try{u.texImage3D.apply(u,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},updateUBOMapping:function(t,e){let i=a.get(e);void 0===i&&(i=new WeakMap,a.set(e,i)),void 0===i.get(t)&&(e=u.getUniformBlockIndex(e,t.name),i.set(t,e))},uniformBlockBinding:function(t,e){var i=a.get(e).get(t);U.get(e)!==i&&(u.uniformBlockBinding(e,i,t.Dn),U.set(e,i))},texStorage2D:function(){try{u.texStorage2D.apply(u,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texStorage3D:function(){try{u.texStorage3D.apply(u,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texSubImage2D:function(){try{u.texSubImage2D.apply(u,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texSubImage3D:function(){try{u.texSubImage3D.apply(u,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},compressedTexSubImage2D:function(){try{u.compressedTexSubImage2D.apply(u,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},compressedTexSubImage3D:function(){try{u.compressedTexSubImage3D.apply(u,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},scissor:function(t){!1===H.equals(t)&&(u.scissor(t.x,t.y,t.z,t.w),H.copy(t))},viewport:function(t){!1===V.equals(t)&&(u.viewport(t.x,t.y,t.z,t.w),V.copy(t))},reset:function(){u.disable(u.BLEND),u.disable(u.CULL_FACE),u.disable(u.DEPTH_TEST),u.disable(u.POLYGON_OFFSET_FILL),u.disable(u.SCISSOR_TEST),u.disable(u.STENCIL_TEST),u.disable(u.SAMPLE_ALPHA_TO_COVERAGE),u.blendEquation(u.FUNC_ADD),u.blendFunc(u.ONE,u.ZERO),u.blendFuncSeparate(u.ONE,u.ZERO,u.ONE,u.ZERO),u.blendColor(0,0,0,0),u.colorMask(!0,!0,!0,!0),u.clearColor(0,0,0,0),u.depthMask(!0),u.depthFunc(u.LESS),u.clearDepth(1),u.stencilMask(4294967295),u.stencilFunc(u.ALWAYS,0,4294967295),u.stencilOp(u.KEEP,u.KEEP,u.KEEP),u.clearStencil(0),u.cullFace(u.BACK),u.frontFace(u.CCW),u.polygonOffset(0,0),u.activeTexture(u.TEXTURE0),u.bindFramebuffer(u.FRAMEBUFFER,null),u.bindFramebuffer(u.DRAW_FRAMEBUFFER,null),u.bindFramebuffer(u.READ_FRAMEBUFFER,null),u.useProgram(null),u.lineWidth(1),u.scissor(0,0,u.canvas.width,u.canvas.height),u.viewport(0,0,u.canvas.width,u.canvas.height),e={},T=null,R={},i={},h=new WeakMap,F=[],o=null,c=!1,f=null,d=null,v=null,p=null,m=null,g=null,_=null,w=new Wt(0,0,0),M=0,y=!1,l=null,E=null,x=null,b=null,S=null,H.set(0,0,u.canvas.width,u.canvas.height),V.set(0,0,u.canvas.width,u.canvas.height),s.reset(),r.reset(),n.reset()}}}function b0(t,e,i,s){var r=S0(s);switch(i){case pe:case _e:return t*e;case we:return t*e*2;case Ee:case xe:return t*e/r.components*r.byteLength;case be:case Se:return t*e*2/r.components*r.byteLength;case me:return t*e*3/r.components*r.byteLength;case ge:case Ae:return t*e*4/r.components*r.byteLength;case Te:case Re:return Math.floor((t+3)/4)*Math.floor((e+3)/4)*8;case Le:case Ce:return Math.floor((t+3)/4)*Math.floor((e+3)/4)*16;case Ie:case De:return Math.max(t,16)*Math.max(e,8)/4;case Ne:case Pe:return Math.max(t,8)*Math.max(e,8)/2;case Oe:case Ue:return Math.floor((t+3)/4)*Math.floor((e+3)/4)*8;case Fe:case Be:return Math.floor((t+3)/4)*Math.floor((e+3)/4)*16;case ke:return Math.floor((t+4)/5)*Math.floor((e+3)/4)*16;case Ge:return Math.floor((t+4)/5)*Math.floor((e+4)/5)*16;case He:return Math.floor((t+5)/6)*Math.floor((e+4)/5)*16;case Ve:return Math.floor((t+5)/6)*Math.floor((e+5)/6)*16;case ze:return Math.floor((t+7)/8)*Math.floor((e+4)/5)*16;case We:return Math.floor((t+7)/8)*Math.floor((e+5)/6)*16;case je:return Math.floor((t+7)/8)*Math.floor((e+7)/8)*16;case Xe:return Math.floor((t+9)/10)*Math.floor((e+4)/5)*16;case Ye:return Math.floor((t+9)/10)*Math.floor((e+5)/6)*16;case Ze:return Math.floor((t+9)/10)*Math.floor((e+7)/8)*16;case qe:return Math.floor((t+9)/10)*Math.floor((e+9)/10)*16;case Ke:return Math.floor((t+11)/12)*Math.floor((e+9)/10)*16;case Je:return Math.floor((t+11)/12)*Math.floor((e+11)/12)*16;case $e:case Qe:case ti:return Math.ceil(t/4)*Math.ceil(e/4)*16;case ei:case ii:return Math.ceil(t/4)*Math.ceil(e/4)*8;case si:case ri:return Math.ceil(t/4)*Math.ceil(e/4)*16}throw new Error(`Unable to determine texture byte length for ${i} format.`)}function S0(t){switch(t){case se:case re:return{byteLength:1,components:1};case ae:case ne:case ue:return{byteLength:2,components:1};case ce:case fe:return{byteLength:2,components:4};case oe:case he:case le:return{byteLength:4,components:1};case ve:return{byteLength:4,components:3}}throw new Error(`Unknown texture type ${t}.`)}function A0(x,a,b,S,A,T,d){let c=a.has("WEBGL_multisampled_render_to_texture")?a.get("WEBGL_multisampled_render_to_texture"):null,f="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),e=new ct,n=new WeakMap,h,o=new WeakMap,i=!1;try{i="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(t){}function l(t,e){return i?new OffscreenCanvas(t,e):gh("canvas")}function R(t,e,i){let s=1;var r,n=U(t);return(s=n.width>i||n.height>i?i/Math.max(n.width,n.height):s)<1?"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap||"undefined"!=typeof VideoFrame&&t instanceof VideoFrame?(i=Math.floor(s*n.width),r=Math.floor(s*n.height),void 0===h&&(h=l(i,r)),(e=e?l(i,r):h).width=i,e.height=r,e.getContext("2d").drawImage(t,0,0,i,r),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+n.width+"x"+n.height+") to ("+i+"x"+r+")."),e):("data"in t&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+n.width+"x"+n.height+")."),t):t}function L(t){return t.generateMipmaps&&t.minFilter!==Jt&&t.minFilter!==V}function C(t){x.generateMipmap(t)}function N(t,e,i,s,r=!1){if(null!==t){if(void 0!==x[t])return x[t];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+t+"'")}let n=e;return e===x.RED&&(i===x.FLOAT&&(n=x.R32F),i===x.HALF_FLOAT&&(n=x.R16F),i===x.UNSIGNED_BYTE)&&(n=x.R8),e===x.RED_INTEGER&&(i===x.UNSIGNED_BYTE&&(n=x.R8UI),i===x.UNSIGNED_SHORT&&(n=x.R16UI),i===x.UNSIGNED_INT&&(n=x.R32UI),i===x.BYTE&&(n=x.R8I),i===x.SHORT&&(n=x.R16I),i===x.INT)&&(n=x.R32I),e===x.RG&&(i===x.FLOAT&&(n=x.RG32F),i===x.HALF_FLOAT&&(n=x.RG16F),i===x.UNSIGNED_BYTE)&&(n=x.RG8),e===x.RG_INTEGER&&(i===x.UNSIGNED_BYTE&&(n=x.RG8UI),i===x.UNSIGNED_SHORT&&(n=x.RG16UI),i===x.UNSIGNED_INT&&(n=x.RG32UI),i===x.BYTE&&(n=x.RG8I),i===x.SHORT&&(n=x.RG16I),i===x.INT)&&(n=x.RG32I),e===x.RGB_INTEGER&&(i===x.UNSIGNED_BYTE&&(n=x.RGB8UI),i===x.UNSIGNED_SHORT&&(n=x.RGB16UI),i===x.UNSIGNED_INT&&(n=x.RGB32UI),i===x.BYTE&&(n=x.RGB8I),i===x.SHORT&&(n=x.RGB16I),i===x.INT)&&(n=x.RGB32I),e===x.RGBA_INTEGER&&(i===x.UNSIGNED_BYTE&&(n=x.RGBA8UI),i===x.UNSIGNED_SHORT&&(n=x.RGBA16UI),i===x.UNSIGNED_INT&&(n=x.RGBA32UI),i===x.BYTE&&(n=x.RGBA8I),i===x.SHORT&&(n=x.RGBA16I),i===x.INT)&&(n=x.RGBA32I),e===x.RGB&&i===x.UNSIGNED_INT_5_9_9_9_REV&&(n=x.RGB9_E5),(n=e===x.RGBA&&(t=r?Ri:zt.getTransfer(s),i===x.FLOAT&&(n=x.RGBA32F),i===x.HALF_FLOAT&&(n=x.RGBA16F),i===x.UNSIGNED_BYTE&&(n=t===Li?x.SRGB8_ALPHA8:x.RGBA8),i===x.UNSIGNED_SHORT_4_4_4_4&&(n=x.RGBA4),i===x.UNSIGNED_SHORT_5_5_5_1)?x.RGB5_A1:n)!==x.R16F&&n!==x.R32F&&n!==x.RG16F&&n!==x.RG32F&&n!==x.RGBA16F&&n!==x.RGBA32F||a.get("EXT_color_buffer_float"),n}function I(t,e){let i;return t?null===e||e===oe||e===de?i=x.DEPTH24_STENCIL8:e===le?i=x.DEPTH32F_STENCIL8:e===ae&&(i=x.DEPTH24_STENCIL8,console.warn("DepthTexture: 16 bit depth attachment is not supported with stencil. Using 24-bit attachment.")):null===e||e===oe||e===de?i=x.DEPTH_COMPONENT24:e===le?i=x.DEPTH_COMPONENT32F:e===ae&&(i=x.DEPTH_COMPONENT16),i}function P(t,e){return!0===L(t)||t.isFramebufferTexture&&t.minFilter!==Jt&&t.minFilter!==V?Math.log2(Math.max(e.width,e.height))+1:void 0!==t.mipmaps&&0<t.mipmaps.length?t.mipmaps.length:t.isCompressedTexture&&Array.isArray(t.image)?e.mipmaps.length:1}function u(t){var e,i,s,r,t=t.target;t.removeEventListener("dispose",u),e=t,void 0!==(i=S.get(e)).On&&(s=e.source,(r=o.get(s))&&((i=r[i.Un]).usedTimes--,0===i.usedTimes&&p(e),0===Object.keys(r).length)&&o.delete(s),S.remove(e)),t.isVideoTexture&&n.delete(t)}function v(t){var t=t.target,i=(t.removeEventListener("dispose",v),S.get(t));if(t.depthTexture&&t.depthTexture.dispose(),t.isWebGLCubeRenderTarget)for(let e=0;e<6;e++){if(Array.isArray(i.Fn[e]))for(let t=0;t<i.Fn[e].length;t++)x.deleteFramebuffer(i.Fn[e][t]);else x.deleteFramebuffer(i.Fn[e]);i.Bn&&x.deleteRenderbuffer(i.Bn[e])}else{if(Array.isArray(i.Fn))for(let t=0;t<i.Fn.length;t++)x.deleteFramebuffer(i.Fn[t]);else x.deleteFramebuffer(i.Fn);if(i.Bn&&x.deleteRenderbuffer(i.Bn),i.kn&&x.deleteFramebuffer(i.kn),i.Gn)for(let t=0;t<i.Gn.length;t++)i.Gn[t]&&x.deleteRenderbuffer(i.Gn[t]);i.Hn&&x.deleteRenderbuffer(i.Hn)}var s=t.textures;for(let t=0,e=s.length;t<e;t++){var r=S.get(s[t]);r.Vn&&(x.deleteTexture(r.Vn),d.memory.textures--),S.remove(s[t])}S.remove(t)}function p(t){var e=S.get(t),t=(x.deleteTexture(e.Vn),t.source);delete o.get(t)[e.Un],d.memory.textures--}let s=0;function F(t,e){var i,s=S.get(t);if(t.isVideoTexture&&(i=t,r=d.render.frame,n.get(i)!==r)&&(n.set(i,r),i.update()),!1===t.isRenderTargetTexture&&0<t.version&&s.zn!==t.version){var r=t.image;if(null===r)console.warn("THREE.WebGLRenderer: Texture marked for update but no image data found.");else{if(!1!==r.complete)return void m(s,t,e);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}b.bindTexture(x.TEXTURE_2D,s.Vn,x.TEXTURE0+e)}let r={[Bt]:x.REPEAT,[kt]:x.CLAMP_TO_EDGE,[Kt]:x.MIRRORED_REPEAT},B={[Jt]:x.NEAREST,[$t]:x.NEAREST_MIPMAP_NEAREST,[Qt]:x.NEAREST_MIPMAP_LINEAR,[V]:x.LINEAR,[te]:x.LINEAR_MIPMAP_NEAREST,[ee]:x.LINEAR_MIPMAP_LINEAR},k={[Ui]:x.NEVER,[zi]:x.ALWAYS,[Fi]:x.LESS,[ki]:x.LEQUAL,[Bi]:x.EQUAL,[Vi]:x.GEQUAL,[Gi]:x.GREATER,[Hi]:x.NOTEQUAL};function D(t,e){var i;e.type!==le||!1!==a.has("OES_texture_float_linear")||e.magFilter!==V&&e.magFilter!==te&&e.magFilter!==Qt&&e.magFilter!==ee&&e.minFilter!==V&&e.minFilter!==te&&e.minFilter!==Qt&&e.minFilter!==ee||console.warn("THREE.WebGLRenderer: Unable to use linear filtering with floating point textures. OES_texture_float_linear not supported on this device."),x.texParameteri(t,x.TEXTURE_WRAP_S,r[e.wrapS]),x.texParameteri(t,x.TEXTURE_WRAP_T,r[e.wrapT]),t!==x.TEXTURE_3D&&t!==x.TEXTURE_2D_ARRAY||x.texParameteri(t,x.TEXTURE_WRAP_R,r[e.wrapR]),x.texParameteri(t,x.TEXTURE_MAG_FILTER,B[e.magFilter]),x.texParameteri(t,x.TEXTURE_MIN_FILTER,B[e.minFilter]),e.compareFunction&&(x.texParameteri(t,x.TEXTURE_COMPARE_MODE,x.COMPARE_REF_TO_TEXTURE),x.texParameteri(t,x.TEXTURE_COMPARE_FUNC,k[e.compareFunction])),!0!==a.has("EXT_texture_filter_anisotropic")||e.magFilter===Jt||e.minFilter!==Qt&&e.minFilter!==ee||e.type===le&&!1===a.has("OES_texture_float_linear")||(1<e.anisotropy||S.get(e).Wn)&&(i=a.get("EXT_texture_filter_anisotropic"),x.texParameterf(t,i.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(e.anisotropy,A.getMaxAnisotropy())),S.get(e).Wn=e.anisotropy)}function G(t,e){let i=!1;void 0===t.On&&(t.On=!0,e.addEventListener("dispose",u));var s=e.source;let r=o.get(s);void 0===r&&(r={},o.set(s,r));(s=[]).push((n=e).wrapS),s.push(n.wrapT),s.push(n.wrapR||0),s.push(n.magFilter),s.push(n.minFilter),s.push(n.anisotropy),s.push(n.internalFormat),s.push(n.format),s.push(n.type),s.push(n.generateMipmaps),s.push(n.premultiplyAlpha),s.push(n.flipY),s.push(n.unpackAlignment),s.push(n.colorSpace);var n=s.join();return n!==t.Un&&(void 0===r[n]&&(r[n]={texture:x.createTexture(),usedTimes:0},d.memory.textures++,i=!0),r[n].usedTimes++,void 0!==(s=r[t.Un])&&(r[t.Un].usedTimes--,0===s.usedTimes)&&p(e),t.Un=n,t.Vn=r[n].texture),i}function m(t,r,e){let n=x.TEXTURE_2D;(r.isDataArrayTexture||r.isCompressedArrayTexture)&&(n=x.TEXTURE_2D_ARRAY),r.isData3DTexture&&(n=x.TEXTURE_3D);var a=G(t,r),h=r.source,o=(b.bindTexture(n,t.Vn,x.TEXTURE0+e),S.get(h));if(h.version!==o.zn||!0===a){b.activeTexture(x.TEXTURE0+e);var e=zt.getPrimaries(zt.workingColorSpace),l=r.colorSpace===xi?null:zt.getPrimaries(r.colorSpace),e=r.colorSpace===xi||e===l?x.NONE:x.BROWSER_DEFAULT_WEBGL;x.pixelStorei(x.UNPACK_FLIP_Y_WEBGL,r.flipY),x.pixelStorei(x.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.premultiplyAlpha),x.pixelStorei(x.UNPACK_ALIGNMENT,r.unpackAlignment),x.pixelStorei(x.UNPACK_COLORSPACE_CONVERSION_WEBGL,e);var u=H(r,u=R(r.image,!1,A.maxTextureSize)),c=T.convert(r.format,r.colorSpace),f=T.convert(r.type);let s=N(r.internalFormat,c,f,r.colorSpace,r.isVideoTexture);D(n,r);let i;var d=r.mipmaps,v=!0!==r.isVideoTexture,l=void 0===o.zn||!0===a,p=h.dataReady,m=P(r,u);if(r.isDepthTexture)s=I(r.format===ye,r.type),l&&(v?b.texStorage2D(x.TEXTURE_2D,1,s,u.width,u.height):b.texImage2D(x.TEXTURE_2D,0,s,u.width,u.height,0,c,f,null));else if(r.isDataTexture)if(0<d.length){v&&l&&b.texStorage2D(x.TEXTURE_2D,m,s,d[0].width,d[0].height);for(let t=0,e=d.length;t<e;t++)i=d[t],v?p&&b.texSubImage2D(x.TEXTURE_2D,t,0,0,i.width,i.height,c,f,i.data):b.texImage2D(x.TEXTURE_2D,t,s,i.width,i.height,0,c,f,i.data);r.generateMipmaps=!1}else v?(l&&b.texStorage2D(x.TEXTURE_2D,m,s,u.width,u.height),p&&b.texSubImage2D(x.TEXTURE_2D,0,0,0,u.width,u.height,c,f,u.data)):b.texImage2D(x.TEXTURE_2D,0,s,u.width,u.height,0,c,f,u.data);else if(r.isCompressedTexture)if(r.isCompressedArrayTexture){v&&l&&b.texStorage3D(x.TEXTURE_2D_ARRAY,m,s,d[0].width,d[0].height,u.depth);for(let t=0,e=d.length;t<e;t++)if(i=d[t],r.format!==ge)if(null!==c)if(v){if(p)if(0<r.layerUpdates.size){var g,_=b0(i.width,i.height,r.format,r.type);for(g of r.layerUpdates){var w=i.data.subarray(g*_/i.data.BYTES_PER_ELEMENT,(g+1)*_/i.data.BYTES_PER_ELEMENT);b.compressedTexSubImage3D(x.TEXTURE_2D_ARRAY,t,0,0,g,i.width,i.height,1,c,w,0,0)}r.clearLayerUpdates()}else b.compressedTexSubImage3D(x.TEXTURE_2D_ARRAY,t,0,0,0,i.width,i.height,u.depth,c,i.data,0,0)}else b.compressedTexImage3D(x.TEXTURE_2D_ARRAY,t,s,i.width,i.height,u.depth,0,i.data,0,0);else console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()");else v?p&&b.texSubImage3D(x.TEXTURE_2D_ARRAY,t,0,0,0,i.width,i.height,u.depth,c,f,i.data):b.texImage3D(x.TEXTURE_2D_ARRAY,t,s,i.width,i.height,u.depth,0,c,f,i.data)}else{v&&l&&b.texStorage2D(x.TEXTURE_2D,m,s,d[0].width,d[0].height);for(let t=0,e=d.length;t<e;t++)i=d[t],r.format!==ge?null!==c?v?p&&b.compressedTexSubImage2D(x.TEXTURE_2D,t,0,0,i.width,i.height,c,i.data):b.compressedTexImage2D(x.TEXTURE_2D,t,s,i.width,i.height,0,i.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):v?p&&b.texSubImage2D(x.TEXTURE_2D,t,0,0,i.width,i.height,c,f,i.data):b.texImage2D(x.TEXTURE_2D,t,s,i.width,i.height,0,c,f,i.data)}else if(r.isDataArrayTexture)if(v){if(l&&b.texStorage3D(x.TEXTURE_2D_ARRAY,m,s,u.width,u.height,u.depth),p)if(0<r.layerUpdates.size){var M,y=b0(u.width,u.height,r.format,r.type);for(M of r.layerUpdates){var E=u.data.subarray(M*y/u.data.BYTES_PER_ELEMENT,(M+1)*y/u.data.BYTES_PER_ELEMENT);b.texSubImage3D(x.TEXTURE_2D_ARRAY,0,0,0,M,u.width,u.height,1,c,f,E)}r.clearLayerUpdates()}else b.texSubImage3D(x.TEXTURE_2D_ARRAY,0,0,0,0,u.width,u.height,u.depth,c,f,u.data)}else b.texImage3D(x.TEXTURE_2D_ARRAY,0,s,u.width,u.height,u.depth,0,c,f,u.data);else if(r.isData3DTexture)v?(l&&b.texStorage3D(x.TEXTURE_3D,m,s,u.width,u.height,u.depth),p&&b.texSubImage3D(x.TEXTURE_3D,0,0,0,0,u.width,u.height,u.depth,c,f,u.data)):b.texImage3D(x.TEXTURE_3D,0,s,u.width,u.height,u.depth,0,c,f,u.data);else if(r.isFramebufferTexture){if(l)if(v)b.texStorage2D(x.TEXTURE_2D,m,s,u.width,u.height);else{let e=u.width,i=u.height;for(let t=0;t<m;t++)b.texImage2D(x.TEXTURE_2D,t,s,e,i,0,c,f,null),e>>=1,i>>=1}}else if(0<d.length){v&&l&&(e=U(d[0]),b.texStorage2D(x.TEXTURE_2D,m,s,e.width,e.height));for(let t=0,e=d.length;t<e;t++)i=d[t],v?p&&b.texSubImage2D(x.TEXTURE_2D,t,0,0,c,f,i):b.texImage2D(x.TEXTURE_2D,t,s,c,f,i);r.generateMipmaps=!1}else v?(l&&(a=U(u),b.texStorage2D(x.TEXTURE_2D,m,s,a.width,a.height)),p&&b.texSubImage2D(x.TEXTURE_2D,0,0,0,c,f,u)):b.texImage2D(x.TEXTURE_2D,0,s,c,f,u);L(r)&&C(n),o.zn=h.version,r.onUpdate&&r.onUpdate(r)}t.zn=r.version}function g(t,e,i,s,r,n){var a,h,o=T.convert(i.format,i.colorSpace),l=T.convert(i.type),u=N(i.internalFormat,o,l,i.colorSpace);S.get(e).jn||(a=Math.max(1,e.width>>n),h=Math.max(1,e.height>>n),r===x.TEXTURE_3D||r===x.TEXTURE_2D_ARRAY?b.texImage3D(r,n,u,a,h,e.depth,0,o,l,null):b.texImage2D(r,n,u,a,h,0,o,l,null)),b.bindFramebuffer(x.FRAMEBUFFER,t),O(e)?c.framebufferTexture2DMultisampleEXT(x.FRAMEBUFFER,s,r,S.get(i).Vn,0,E(e)):(r===x.TEXTURE_2D||r>=x.TEXTURE_CUBE_MAP_POSITIVE_X&&r<=x.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&x.framebufferTexture2D(x.FRAMEBUFFER,s,r,S.get(i).Vn,n),b.bindFramebuffer(x.FRAMEBUFFER,null)}function _(t,e,i){if(x.bindRenderbuffer(x.RENDERBUFFER,t),e.depthBuffer){var s=e.depthTexture,s=s&&s.isDepthTexture?s.type:null,s=I(e.stencilBuffer,s),r=e.stencilBuffer?x.DEPTH_STENCIL_ATTACHMENT:x.DEPTH_ATTACHMENT,n=E(e);O(e)?c.renderbufferStorageMultisampleEXT(x.RENDERBUFFER,n,s,e.width,e.height):i?x.renderbufferStorageMultisample(x.RENDERBUFFER,n,s,e.width,e.height):x.renderbufferStorage(x.RENDERBUFFER,s,e.width,e.height),x.framebufferRenderbuffer(x.FRAMEBUFFER,r,x.RENDERBUFFER,t)}else{var a=e.textures;for(let t=0;t<a.length;t++){var h=a[t],o=T.convert(h.format,h.colorSpace),l=T.convert(h.type),o=N(h.internalFormat,o,l,h.colorSpace),l=E(e);i&&!1===O(e)?x.renderbufferStorageMultisample(x.RENDERBUFFER,l,o,e.width,e.height):O(e)?c.renderbufferStorageMultisampleEXT(x.RENDERBUFFER,l,o,e.width,e.height):x.renderbufferStorage(x.RENDERBUFFER,o,e.width,e.height)}}x.bindRenderbuffer(x.RENDERBUFFER,null)}function w(i){let s=S.get(i);var e,r,t=!0===i.isWebGLCubeRenderTarget;if(s.Xn!==i.depthTexture){let e=i.depthTexture;if(s.Yn&&s.Yn(),e){let t=()=>{delete s.Xn,delete s.Yn,e.removeEventListener("dispose",t)};e.addEventListener("dispose",t),s.Yn=t}s.Xn=e}if(i.depthTexture&&!s.Zn){if(t)throw new Error("target.depthTexture not supported in Cube render targets");var n=s.Fn,a=i;if(a&&a.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(b.bindFramebuffer(x.FRAMEBUFFER,n),!a.depthTexture||!a.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");S.get(a.depthTexture).Vn&&a.depthTexture.image.width===a.width&&a.depthTexture.image.height===a.height||(a.depthTexture.image.width=a.width,a.depthTexture.image.height=a.height,a.depthTexture.needsUpdate=!0),F(a.depthTexture,0);var n=S.get(a.depthTexture).Vn,h=E(a);if(a.depthTexture.format===Me)O(a)?c.framebufferTexture2DMultisampleEXT(x.FRAMEBUFFER,x.DEPTH_ATTACHMENT,x.TEXTURE_2D,n,0,h):x.framebufferTexture2D(x.FRAMEBUFFER,x.DEPTH_ATTACHMENT,x.TEXTURE_2D,n,0);else{if(a.depthTexture.format!==ye)throw new Error("Unknown depthTexture format");O(a)?c.framebufferTexture2DMultisampleEXT(x.FRAMEBUFFER,x.DEPTH_STENCIL_ATTACHMENT,x.TEXTURE_2D,n,0,h):x.framebufferTexture2D(x.FRAMEBUFFER,x.DEPTH_STENCIL_ATTACHMENT,x.TEXTURE_2D,n,0)}}else if(t){s.Bn=[];for(let t=0;t<6;t++)b.bindFramebuffer(x.FRAMEBUFFER,s.Fn[t]),void 0===s.Bn[t]?(s.Bn[t]=x.createRenderbuffer(),_(s.Bn[t],i,!1)):(e=i.stencilBuffer?x.DEPTH_STENCIL_ATTACHMENT:x.DEPTH_ATTACHMENT,r=s.Bn[t],x.bindRenderbuffer(x.RENDERBUFFER,r),x.framebufferRenderbuffer(x.FRAMEBUFFER,e,x.RENDERBUFFER,r))}else b.bindFramebuffer(x.FRAMEBUFFER,s.Fn),void 0===s.Bn?(s.Bn=x.createRenderbuffer(),_(s.Bn,i,!1)):(a=i.stencilBuffer?x.DEPTH_STENCIL_ATTACHMENT:x.DEPTH_ATTACHMENT,h=s.Bn,x.bindRenderbuffer(x.RENDERBUFFER,h),x.framebufferRenderbuffer(x.FRAMEBUFFER,a,x.RENDERBUFFER,h));b.bindFramebuffer(x.FRAMEBUFFER,null)}let M=[],y=[];function E(t){return Math.min(A.maxSamples,t.samples)}function O(t){var e=S.get(t);return 0<t.samples&&!0===a.has("WEBGL_multisampled_render_to_texture")&&!1!==e.qn}function H(t,e){var i=t.colorSpace,s=t.format,r=t.type;return!0!==t.isCompressedTexture&&!0!==t.isVideoTexture&&i!==Si&&i!==xi&&(zt.getTransfer(i)===Li?s===ge&&r===se||console.warn("THREE.WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):console.error("THREE.WebGLTextures: Unsupported texture color space:",i)),e}function U(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement?(e.width=t.naturalWidth||t.width,e.height=t.naturalHeight||t.height):"undefined"!=typeof VideoFrame&&t instanceof VideoFrame?(e.width=t.displayWidth,e.height=t.displayHeight):(e.width=t.width,e.height=t.height),e}this.allocateTextureUnit=function(){var t=s;return t>=A.maxTextures&&console.warn("THREE.WebGLTextures: Trying to use "+t+" texture units while this GPU supports only "+A.maxTextures),s+=1,t},this.resetTextureUnits=function(){s=0},this.setTexture2D=F,this.setTexture2DArray=function(t,e){var i=S.get(t);0<t.version&&i.zn!==t.version?m(i,t,e):b.bindTexture(x.TEXTURE_2D_ARRAY,i.Vn,x.TEXTURE0+e)},this.setTexture3D=function(t,e){var i=S.get(t);0<t.version&&i.zn!==t.version?m(i,t,e):b.bindTexture(x.TEXTURE_3D,i.Vn,x.TEXTURE0+e)},this.setTextureCube=function(e,t){var i=S.get(e);if(0<e.version&&i.zn!==e.version){var s=i,r=e,e=t;if(6===r.image.length){var n=G(s,r),a=r.source,h=(b.bindTexture(x.TEXTURE_CUBE_MAP,s.Vn,x.TEXTURE0+e),S.get(a));if(a.version!==h.zn||!0===n){b.activeTexture(x.TEXTURE0+e);var e=zt.getPrimaries(zt.workingColorSpace),o=r.colorSpace===xi?null:zt.getPrimaries(r.colorSpace),e=r.colorSpace===xi||e===o?x.NONE:x.BROWSER_DEFAULT_WEBGL,l=(x.pixelStorei(x.UNPACK_FLIP_Y_WEBGL,r.flipY),x.pixelStorei(x.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.premultiplyAlpha),x.pixelStorei(x.UNPACK_ALIGNMENT,r.unpackAlignment),x.pixelStorei(x.UNPACK_COLORSPACE_CONVERSION_WEBGL,e),r.isCompressedTexture||r.image[0].isCompressedTexture),u=r.image[0]&&r.image[0].isDataTexture,c=[];for(let t=0;t<6;t++)c[t]=l||u?u?r.image[t].image:r.image[t]:R(r.image[t],!0,A.maxCubemapSize),c[t]=H(r,c[t]);var o=c[0],f=T.convert(r.format,r.colorSpace),d=T.convert(r.type),v=N(r.internalFormat,f,d,r.colorSpace),p=!0!==r.isVideoTexture,e=void 0===h.zn||!0===n,m=a.dataReady;let t=P(r,o);D(x.TEXTURE_CUBE_MAP,r);let i;if(l){p&&e&&b.texStorage2D(x.TEXTURE_CUBE_MAP,t,v,o.width,o.height);for(let e=0;e<6;e++){i=c[e].mipmaps;for(let t=0;t<i.length;t++){var g=i[t];r.format!==ge?null!==f?p?m&&b.compressedTexSubImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,t,0,0,g.width,g.height,f,g.data):b.compressedTexImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,t,v,g.width,g.height,0,g.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):p?m&&b.texSubImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,t,0,0,g.width,g.height,f,d,g.data):b.texImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,t,v,g.width,g.height,0,f,d,g.data)}}}else{i=r.mipmaps,p&&e&&(0<i.length&&t++,n=U(c[0]),b.texStorage2D(x.TEXTURE_CUBE_MAP,t,v,n.width,n.height));for(let e=0;e<6;e++)if(u){p?m&&b.texSubImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,0,0,c[e].width,c[e].height,f,d,c[e].data):b.texImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,v,c[e].width,c[e].height,0,f,d,c[e].data);for(let t=0;t<i.length;t++){var _=i[t].image[e].image;p?m&&b.texSubImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,t+1,0,0,_.width,_.height,f,d,_.data):b.texImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,t+1,v,_.width,_.height,0,f,d,_.data)}}else{p?m&&b.texSubImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,0,0,f,d,c[e]):b.texImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,v,f,d,c[e]);for(let t=0;t<i.length;t++){var w=i[t];p?m&&b.texSubImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,t+1,0,0,f,d,w.image[e]):b.texImage2D(x.TEXTURE_CUBE_MAP_POSITIVE_X+e,t+1,v,f,d,w.image[e])}}}L(r)&&C(x.TEXTURE_CUBE_MAP),h.zn=a.version,r.onUpdate&&r.onUpdate(r)}s.zn=r.version}}else b.bindTexture(x.TEXTURE_CUBE_MAP,i.Vn,x.TEXTURE0+t)},this.rebindTextures=function(t,e,i){var s=S.get(t);void 0!==e&&g(s.Fn,t,t.texture,x.COLOR_ATTACHMENT0,x.TEXTURE_2D,0),void 0!==i&&w(t)},this.setupRenderTarget=function(i){var s=i.texture,r=S.get(i),t=S.get(s),n=(i.addEventListener("dispose",v),i.textures),e=!0===i.isWebGLCubeRenderTarget,a=1<n.length;if(a||(void 0===t.Vn&&(t.Vn=x.createTexture()),t.zn=s.version,d.memory.textures++),e){r.Fn=[];for(let e=0;e<6;e++)if(s.mipmaps&&0<s.mipmaps.length){r.Fn[e]=[];for(let t=0;t<s.mipmaps.length;t++)r.Fn[e][t]=x.createFramebuffer()}else r.Fn[e]=x.createFramebuffer()}else{if(s.mipmaps&&0<s.mipmaps.length){r.Fn=[];for(let t=0;t<s.mipmaps.length;t++)r.Fn[t]=x.createFramebuffer()}else r.Fn=x.createFramebuffer();if(a)for(let t=0,e=n.length;t<e;t++){var h=S.get(n[t]);void 0===h.Vn&&(h.Vn=x.createTexture(),d.memory.textures++)}if(0<i.samples&&!1===O(i)){r.kn=x.createFramebuffer(),r.Gn=[],b.bindFramebuffer(x.FRAMEBUFFER,r.kn);for(let t=0;t<n.length;t++){var o=n[t],l=(r.Gn[t]=x.createRenderbuffer(),x.bindRenderbuffer(x.RENDERBUFFER,r.Gn[t]),T.convert(o.format,o.colorSpace)),u=T.convert(o.type),l=N(o.internalFormat,l,u,o.colorSpace,!0===i.isXRRenderTarget),u=E(i);x.renderbufferStorageMultisample(x.RENDERBUFFER,u,l,i.width,i.height),x.framebufferRenderbuffer(x.FRAMEBUFFER,x.COLOR_ATTACHMENT0+t,x.RENDERBUFFER,r.Gn[t])}x.bindRenderbuffer(x.RENDERBUFFER,null),i.depthBuffer&&(r.Hn=x.createRenderbuffer(),_(r.Hn,i,!0)),b.bindFramebuffer(x.FRAMEBUFFER,null)}}if(e){b.bindTexture(x.TEXTURE_CUBE_MAP,t.Vn),D(x.TEXTURE_CUBE_MAP,s);for(let e=0;e<6;e++)if(s.mipmaps&&0<s.mipmaps.length)for(let t=0;t<s.mipmaps.length;t++)g(r.Fn[e][t],i,s,x.COLOR_ATTACHMENT0,x.TEXTURE_CUBE_MAP_POSITIVE_X+e,t);else g(r.Fn[e],i,s,x.COLOR_ATTACHMENT0,x.TEXTURE_CUBE_MAP_POSITIVE_X+e,0);L(s)&&C(x.TEXTURE_CUBE_MAP)}else if(a)for(let t=0,e=n.length;t<e;t++){var c=n[t],f=S.get(c);b.bindTexture(x.TEXTURE_2D,f.Vn),D(x.TEXTURE_2D,c),g(r.Fn,i,c,x.COLOR_ATTACHMENT0+t,x.TEXTURE_2D,0),L(c)&&C(x.TEXTURE_2D)}else{let e=x.TEXTURE_2D;if((i.isWebGL3DRenderTarget||i.isWebGLArrayRenderTarget)&&(e=i.isWebGL3DRenderTarget?x.TEXTURE_3D:x.TEXTURE_2D_ARRAY),b.bindTexture(e,t.Vn),D(e,s),s.mipmaps&&0<s.mipmaps.length)for(let t=0;t<s.mipmaps.length;t++)g(r.Fn[t],i,s,x.COLOR_ATTACHMENT0,e,t);else g(r.Fn,i,s,x.COLOR_ATTACHMENT0,e,0);L(s)&&C(e)}b.unbindTexture(),i.depthBuffer&&w(i)},this.updateRenderTargetMipmap=function(i){var s=i.textures;for(let t=0,e=s.length;t<e;t++){var r,n=s[t];L(n)&&(r=i.isWebGLCubeRenderTarget?x.TEXTURE_CUBE_MAP:x.TEXTURE_2D,n=S.get(n).Vn,b.bindTexture(r,n),C(r),b.unbindTexture())}},this.updateMultisampleRenderTarget=function(i){if(0<i.samples)if(!1===O(i)){var s=i.textures,r=i.width,n=i.height;let e=x.COLOR_BUFFER_BIT;var a,h=i.stencilBuffer?x.DEPTH_STENCIL_ATTACHMENT:x.DEPTH_ATTACHMENT,o=S.get(i),l=1<s.length;if(l)for(let t=0;t<s.length;t++)b.bindFramebuffer(x.FRAMEBUFFER,o.kn),x.framebufferRenderbuffer(x.FRAMEBUFFER,x.COLOR_ATTACHMENT0+t,x.RENDERBUFFER,null),b.bindFramebuffer(x.FRAMEBUFFER,o.Fn),x.framebufferTexture2D(x.DRAW_FRAMEBUFFER,x.COLOR_ATTACHMENT0+t,x.TEXTURE_2D,null,0);b.bindFramebuffer(x.READ_FRAMEBUFFER,o.kn),b.bindFramebuffer(x.DRAW_FRAMEBUFFER,o.Fn);for(let t=0;t<s.length;t++)i.resolveDepthBuffer&&(i.depthBuffer&&(e|=x.DEPTH_BUFFER_BIT),i.stencilBuffer)&&i.resolveStencilBuffer&&(e|=x.STENCIL_BUFFER_BIT),l&&(x.framebufferRenderbuffer(x.READ_FRAMEBUFFER,x.COLOR_ATTACHMENT0,x.RENDERBUFFER,o.Gn[t]),a=S.get(s[t]).Vn,x.framebufferTexture2D(x.DRAW_FRAMEBUFFER,x.COLOR_ATTACHMENT0,x.TEXTURE_2D,a,0)),x.blitFramebuffer(0,0,r,n,0,0,r,n,e,x.NEAREST),!0===f&&(M.length=0,y.length=0,M.push(x.COLOR_ATTACHMENT0+t),i.depthBuffer&&!1===i.resolveDepthBuffer&&(M.push(h),y.push(h),x.invalidateFramebuffer(x.DRAW_FRAMEBUFFER,y)),x.invalidateFramebuffer(x.READ_FRAMEBUFFER,M));if(b.bindFramebuffer(x.READ_FRAMEBUFFER,null),b.bindFramebuffer(x.DRAW_FRAMEBUFFER,null),l)for(let t=0;t<s.length;t++){b.bindFramebuffer(x.FRAMEBUFFER,o.kn),x.framebufferRenderbuffer(x.FRAMEBUFFER,x.COLOR_ATTACHMENT0+t,x.RENDERBUFFER,o.Gn[t]);var u=S.get(s[t]).Vn;b.bindFramebuffer(x.FRAMEBUFFER,o.Fn),x.framebufferTexture2D(x.DRAW_FRAMEBUFFER,x.COLOR_ATTACHMENT0+t,x.TEXTURE_2D,u,0)}b.bindFramebuffer(x.DRAW_FRAMEBUFFER,o.kn)}else{var t;i.depthBuffer&&!1===i.resolveDepthBuffer&&f&&(t=i.stencilBuffer?x.DEPTH_STENCIL_ATTACHMENT:x.DEPTH_ATTACHMENT,x.invalidateFramebuffer(x.DRAW_FRAMEBUFFER,[t]))}},this.setupDepthRenderbuffer=w,this.setupFrameBufferTexture=g,this.useMultisampledRTT=O}function T0(s,r){return{convert:function(t,e=xi){let i;if(e=zt.getTransfer(e),t===se)return s.UNSIGNED_BYTE;if(t===ce)return s.UNSIGNED_SHORT_4_4_4_4;if(t===fe)return s.UNSIGNED_SHORT_5_5_5_1;if(t===ve)return s.UNSIGNED_INT_5_9_9_9_REV;if(t===re)return s.BYTE;if(t===ne)return s.SHORT;if(t===ae)return s.UNSIGNED_SHORT;if(t===he)return s.INT;if(t===oe)return s.UNSIGNED_INT;if(t===le)return s.FLOAT;if(t===ue)return s.HALF_FLOAT;if(t===pe)return s.ALPHA;if(t===me)return s.RGB;if(t===ge)return s.RGBA;if(t===_e)return s.LUMINANCE;if(t===we)return s.LUMINANCE_ALPHA;if(t===Me)return s.DEPTH_COMPONENT;if(t===ye)return s.DEPTH_STENCIL;if(t===Ee)return s.RED;if(t===xe)return s.RED_INTEGER;if(t===be)return s.RG;if(t===Se)return s.RG_INTEGER;if(t===Ae)return s.RGBA_INTEGER;if(t===Te||t===Re||t===Le||t===Ce)if(e===Li){if(null===(i=r.get("WEBGL_compressed_texture_s3tc_srgb")))return null;if(t===Te)return i.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(t===Re)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(t===Le)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(t===Ce)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(null===(i=r.get("WEBGL_compressed_texture_s3tc")))return null;if(t===Te)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(t===Re)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(t===Le)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(t===Ce)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(t===Ne||t===Ie||t===Pe||t===De){if(null===(i=r.get("WEBGL_compressed_texture_pvrtc")))return null;if(t===Ne)return i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(t===Ie)return i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(t===Pe)return i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(t===De)return i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(t===Oe||t===Ue||t===Fe){if(null===(i=r.get("WEBGL_compressed_texture_etc")))return null;if(t===Oe||t===Ue)return e===Li?i.COMPRESSED_SRGB8_ETC2:i.COMPRESSED_RGB8_ETC2;if(t===Fe)return e===Li?i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC}if(t===Be||t===ke||t===Ge||t===He||t===Ve||t===ze||t===We||t===je||t===Xe||t===Ye||t===Ze||t===qe||t===Ke||t===Je){if(null===(i=r.get("WEBGL_compressed_texture_astc")))return null;if(t===Be)return e===Li?i.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:i.COMPRESSED_RGBA_ASTC_4x4_KHR;if(t===ke)return e===Li?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:i.COMPRESSED_RGBA_ASTC_5x4_KHR;if(t===Ge)return e===Li?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:i.COMPRESSED_RGBA_ASTC_5x5_KHR;if(t===He)return e===Li?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:i.COMPRESSED_RGBA_ASTC_6x5_KHR;if(t===Ve)return e===Li?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:i.COMPRESSED_RGBA_ASTC_6x6_KHR;if(t===ze)return e===Li?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:i.COMPRESSED_RGBA_ASTC_8x5_KHR;if(t===We)return e===Li?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:i.COMPRESSED_RGBA_ASTC_8x6_KHR;if(t===je)return e===Li?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:i.COMPRESSED_RGBA_ASTC_8x8_KHR;if(t===Xe)return e===Li?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:i.COMPRESSED_RGBA_ASTC_10x5_KHR;if(t===Ye)return e===Li?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:i.COMPRESSED_RGBA_ASTC_10x6_KHR;if(t===Ze)return e===Li?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:i.COMPRESSED_RGBA_ASTC_10x8_KHR;if(t===qe)return e===Li?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:i.COMPRESSED_RGBA_ASTC_10x10_KHR;if(t===Ke)return e===Li?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:i.COMPRESSED_RGBA_ASTC_12x10_KHR;if(t===Je)return e===Li?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:i.COMPRESSED_RGBA_ASTC_12x12_KHR}if(t===$e||t===Qe||t===ti){if(null===(i=r.get("EXT_texture_compression_bptc")))return null;if(t===$e)return e===Li?i.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:i.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(t===Qe)return i.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(t===ti)return i.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(t===ei||t===ii||t===si||t===ri){if(null===(i=r.get("EXT_texture_compression_rgtc")))return null;if(t===$e)return i.COMPRESSED_RED_RGTC1_EXT;if(t===ii)return i.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(t===si)return i.COMPRESSED_RED_GREEN_RGTC2_EXT;if(t===ri)return i.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return t===de?s.UNSIGNED_INT_24_8:void 0!==s[t]?s[t]:null}}}class R0 extends ir{constructor(t=[]){super(),this.isArrayCamera=!0,this.cameras=t}}class L0 extends Js{constructor(){super(),this.isGroup=!0,this.type="Group"}}let C0={type:"move"};class N0{constructor(){this.Kn=null,this.Jn=null,this.$n=null}getHandSpace(){return null===this.$n&&(this.$n=new L0,this.$n.matrixAutoUpdate=!1,this.$n.visible=!1,this.$n.joints={},this.$n.inputState={pinching:!1}),this.$n}getTargetRaySpace(){return null===this.Kn&&(this.Kn=new L0,this.Kn.matrixAutoUpdate=!1,this.Kn.visible=!1,this.Kn.hasLinearVelocity=!1,this.Kn.linearVelocity=new Gt,this.Kn.hasAngularVelocity=!1,this.Kn.angularVelocity=new Gt),this.Kn}getGripSpace(){return null===this.Jn&&(this.Jn=new L0,this.Jn.matrixAutoUpdate=!1,this.Jn.visible=!1,this.Jn.hasLinearVelocity=!1,this.Jn.linearVelocity=new Gt,this.Jn.hasAngularVelocity=!1,this.Jn.angularVelocity=new Gt),this.Jn}dispatchEvent(t){return null!==this.Kn&&this.Kn.dispatchEvent(t),null!==this.Jn&&this.Jn.dispatchEvent(t),null!==this.$n&&this.$n.dispatchEvent(t),this}connect(t){if(t&&t.hand){var e=this.$n;if(e)for(var i of t.hand.values())this.Qn(e,i)}return this.dispatchEvent({type:"connected",data:t}),this}disconnect(t){return this.dispatchEvent({type:"disconnected",data:t}),null!==this.Kn&&(this.Kn.visible=!1),null!==this.Jn&&(this.Jn.visible=!1),null!==this.$n&&(this.$n.visible=!1),this}update(t,e,i){let s=null,r=null,n=null;var a=this.Kn,h=this.Jn,o=this.$n;if(t&&"visible-blurred"!==e.session.visibilityState){if(o&&t.hand){n=!0;for(var l of t.hand.values()){var u=e.getJointPose(l,i),l=this.Qn(o,l);null!==u&&(l.matrix.fromArray(u.transform.matrix),l.matrix.decompose(l.position,l.rotation,l.scale),l.matrixWorldNeedsUpdate=!0,l.jointRadius=u.radius),l.visible=null!==u}var c=o.joints["index-finger-tip"],f=o.joints["thumb-tip"],c=c.position.distanceTo(f.position);o.inputState.pinching&&.025<c?(o.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:t.handedness,target:this})):!o.inputState.pinching&&c<=.015&&(o.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:t.handedness,target:this}))}else null!==h&&t.gripSpace&&null!==(r=e.getPose(t.gripSpace,i))&&(h.matrix.fromArray(r.transform.matrix),h.matrix.decompose(h.position,h.rotation,h.scale),h.matrixWorldNeedsUpdate=!0,r.linearVelocity?(h.hasLinearVelocity=!0,h.linearVelocity.copy(r.linearVelocity)):h.hasLinearVelocity=!1,r.angularVelocity?(h.hasAngularVelocity=!0,h.angularVelocity.copy(r.angularVelocity)):h.hasAngularVelocity=!1);null!==a&&null!==(s=null===(s=e.getPose(t.targetRaySpace,i))&&null!==r?r:s)&&(a.matrix.fromArray(s.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,s.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(s.linearVelocity)):a.hasLinearVelocity=!1,s.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(s.angularVelocity)):a.hasAngularVelocity=!1,this.dispatchEvent(C0))}return null!==a&&(a.visible=null!==s),null!==h&&(h.visible=null!==r),null!==o&&(o.visible=null!==n),this}Qn(t,e){var i;return void 0===t.joints[e.jointName]&&((i=new L0).matrixAutoUpdate=!1,i.visible=!1,t.joints[e.jointName]=i,t.add(i)),t.joints[e.jointName]}}let I0=`
void main() {

	gl_Position = vec4( position, 1.0 );

}`,P0=`
uniform sampler2DArray depthColor;
uniform float depthWidth;
uniform float depthHeight;

void main() {

	vec2 coord = vec2( gl_FragCoord.x / depthWidth, gl_FragCoord.y / depthHeight );

	if ( coord.x >= 1.0 ) {

		gl_FragDepth = texture( depthColor, vec3( coord.x - 1.0, coord.y, 1 ) ).r;

	} else {

		gl_FragDepth = texture( depthColor, vec3( coord.x, coord.y, 0 ) ).r;

	}

}`;class D0{constructor(){this.texture=null,this.mesh=null,this.depthNear=0,this.depthFar=0}init(t,e,i){var s;null===this.texture&&(s=new c,t.properties.get(s).Vn=e.texture,e.depthNear==i.depthNear&&e.depthFar==i.depthFar||(this.depthNear=e.depthNear,this.depthFar=e.depthFar),this.texture=s)}getMesh(t){return null!==this.texture&&null===this.mesh&&(t=t.cameras[0].viewport,t=new zh({vertexShader:I0,fragmentShader:P0,uniforms:{depthColor:{value:this.texture},depthWidth:{value:t.z},depthHeight:{value:t.w}}}),this.mesh=new L(new Ph(20,20),t)),this.mesh}reset(){this.texture=null,this.mesh=null}getDepthTexture(){return this.texture}}class O0 extends Cs{constructor(o,r){super();let l=this,g=null,n=1,u=null,e="local-floor",i=1,c=null,f=null,d=null,v=null,p=null,m=null,_=new D0,a=r.getContextAttributes(),t=null,w=null,M=[],y=[],h=new ct,E=null,x=new ir,b=(x.layers.enable(1),x.viewport=new Vt,new ir),S=(b.layers.enable(2),b.viewport=new Vt,[x,b]),A=new R0,T=(A.layers.enable(1),A.layers.enable(2),null),R=null;function L(t){var e=y.indexOf(t.inputSource);-1!==e&&void 0!==(e=M[e])&&(e.update(t.inputSource,t.frame,c||u),e.dispatchEvent({type:t.type,data:t.inputSource}))}function C(){g.removeEventListener("select",L),g.removeEventListener("selectstart",L),g.removeEventListener("selectend",L),g.removeEventListener("squeeze",L),g.removeEventListener("squeezestart",L),g.removeEventListener("squeezeend",L),g.removeEventListener("end",C),g.removeEventListener("inputsourceschange",N);for(let t=0;t<M.length;t++){var e=y[t];null!==e&&(y[t]=null,M[t].disconnect(e))}T=null,R=null,_.reset(),o.setRenderTarget(t),p=null,v=null,d=null,g=null,w=null,U.stop(),l.isPresenting=!1,o.setPixelRatio(E),o.setSize(h.width,h.height,!1),l.dispatchEvent({type:"sessionend"})}function N(i){for(let t=0;t<i.removed.length;t++){var e=i.removed[t],s=y.indexOf(e);0<=s&&(y[s]=null,M[s].disconnect(e))}for(let t=0;t<i.added.length;t++){var r=i.added[t];let e=y.indexOf(r);if(-1===e){for(let t=0;t<M.length;t++){if(t>=y.length){y.push(r),e=t;break}if(null===y[t]){y[t]=r,e=t;break}}if(-1===e)break}var n=M[e];n&&n.connect(r)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(t){let e=M[t];return void 0===e&&(e=new N0,M[t]=e),e.getTargetRaySpace()},this.getControllerGrip=function(t){let e=M[t];return void 0===e&&(e=new N0,M[t]=e),e.getGripSpace()},this.getHand=function(t){let e=M[t];return void 0===e&&(e=new N0,M[t]=e),e.getHandSpace()},this.setFramebufferScaleFactor=function(t){n=t,!0===l.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(t){e=t,!0===l.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return c||u},this.setReferenceSpace=function(t){c=t},this.getBaseLayer=function(){return null!==v?v:p},this.getBinding=function(){return d},this.getFrame=function(){return m},this.getSession=function(){return g},this.setSession=async function(s){if(null!==(g=s)){if(t=o.getRenderTarget(),g.addEventListener("select",L),g.addEventListener("selectstart",L),g.addEventListener("selectend",L),g.addEventListener("squeeze",L),g.addEventListener("squeezestart",L),g.addEventListener("squeezeend",L),g.addEventListener("end",C),g.addEventListener("inputsourceschange",N),!0!==a.xrCompatible&&await r.makeXRCompatible(),E=o.getPixelRatio(),o.getSize(h),void 0===g.renderState.layers){s={antialias:a.antialias,alpha:!0,depth:a.depth,stencil:a.stencil,framebufferScaleFactor:n};p=new XRWebGLLayer(g,r,s),g.updateRenderState({baseLayer:p}),o.setPixelRatio(1),o.setSize(p.framebufferWidth,p.framebufferHeight,!1),w=new Ic(p.framebufferWidth,p.framebufferHeight,{format:ge,type:se,colorSpace:o.outputColorSpace,stencilBuffer:a.stencil})}else{let t=null,e=null,i=null;a.depth&&(i=a.stencil?r.DEPTH24_STENCIL8:r.DEPTH_COMPONENT24,t=a.stencil?ye:Me,e=a.stencil?de:oe);s={colorFormat:r.RGBA8,depthFormat:i,scaleFactor:n};d=new XRWebGLBinding(g,r),v=d.createProjectionLayer(s),g.updateRenderState({layers:[v]}),o.setPixelRatio(1),o.setSize(v.textureWidth,v.textureHeight,!1),w=new Ic(v.textureWidth,v.textureHeight,{format:ge,type:se,depthTexture:new pf(v.textureWidth,v.textureHeight,e,void 0,void 0,void 0,void 0,void 0,void 0,t),stencilBuffer:a.stencil,colorSpace:o.outputColorSpace,samples:a.antialias?4:0,resolveDepthBuffer:!1===v.ignoreDepthValues})}w.isXRRenderTarget=!0,this.setFoveation(i),c=null,u=await g.requestReferenceSpace(e),U.setContext(g),U.start(),l.isPresenting=!0,l.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==g)return g.environmentBlendMode},this.getDepthTexture=function(){return _.getDepthTexture()};let I=new Gt,P=new Gt;function D(t,e){null===e?t.matrixWorld.copy(t.matrix):t.matrixWorld.multiplyMatrices(e.matrixWorld,t.matrix),t.matrixWorldInverse.copy(t.matrixWorld).invert()}this.updateCamera=function(i){if(null!==g){let t=i.near,e=i.far;null!==_.texture&&(0<_.depthNear&&(t=_.depthNear),0<_.depthFar)&&(e=_.depthFar),A.near=b.near=x.near=t,A.far=b.far=x.far=e,T===A.near&&R===A.far||(g.updateRenderState({depthNear:A.near,depthFar:A.far}),T=A.near,R=A.far);var s,r,n,a,h,o,l,u,c,f=i.parent,d=A.cameras;D(A,f);for(let t=0;t<d.length;t++)D(d[t],f);2===d.length?(s=A,r=x,n=b,I.setFromMatrixPosition(r.matrixWorld),P.setFromMatrixPosition(n.matrixWorld),p=I.distanceTo(P),a=r.projectionMatrix.elements,n=n.projectionMatrix.elements,h=a[14]/(a[10]-1),o=a[14]/(a[10]+1),l=(a[9]+1)/a[5],u=(a[9]-1)/a[5],m=(a[8]-1)/a[0],n=(n[8]+1)/n[0],v=h*m,c=h*n,m=(n=p/(n-m))*-m,r.matrixWorld.decompose(s.position,s.quaternion,s.scale),s.translateX(m),s.translateZ(n),s.matrixWorld.compose(s.position,s.quaternion,s.scale),s.matrixWorldInverse.copy(s.matrixWorld).invert(),-1===a[10]?(s.projectionMatrix.copy(r.projectionMatrix),s.projectionMatrixInverse.copy(r.projectionMatrixInverse)):(s.projectionMatrix.makePerspective(v-m,p-m+c,l*o/(a=o+n)*(r=h+n),u*o/a*r,r,a),s.projectionMatrixInverse.copy(s.projectionMatrix).invert())):A.projectionMatrix.copy(x.projectionMatrix);var v=i,p=A,m=f;null===m?v.matrix.copy(p.matrixWorld):(v.matrix.copy(m.matrixWorld),v.matrix.invert(),v.matrix.multiply(p.matrixWorld)),v.matrix.decompose(v.position,v.quaternion,v.scale),v.updateMatrixWorld(!0),v.projectionMatrix.copy(p.projectionMatrix),v.projectionMatrixInverse.copy(p.projectionMatrixInverse),v.isPerspectiveCamera&&(v.fov=2*Ji*Math.atan(1/v.projectionMatrix.elements[5]),v.zoom=1)}},this.getCamera=function(){return A},this.getFoveation=function(){if(null!==v||null!==p)return i},this.setFoveation=function(t){i=t,null!==v&&(v.fixedFoveation=t),null!==p&&void 0!==p.fixedFoveation&&(p.fixedFoveation=t)},this.hasDepthSensing=function(){return null!==_.texture},this.getDepthSensingMesh=function(){return _.getMesh(A)};let O=null;let U=new lh;U.setAnimationLoop(function(t,e){if(f=e.getViewerPose(c||u),m=e,null!==f){var r=f.views;null!==p&&(o.setRenderTargetFramebuffer(w,p.framebuffer),o.setRenderTarget(w));let s=!1;r.length!==A.cameras.length&&(A.cameras.length=0,s=!0);for(let i=0;i<r.length;i++){var n,a=r[i];let t=null,e=(null!==p?t=p.getViewport(a):(n=d.getViewSubImage(v,a),t=n.viewport,0===i&&(o.setRenderTargetTextures(w,n.colorTexture,v.ignoreDepthValues?void 0:n.depthStencilTexture),o.setRenderTarget(w))),S[i]);void 0===e&&((e=new ir).layers.enable(i),e.viewport=new Vt,S[i]=e),e.matrix.fromArray(a.transform.matrix),e.matrix.decompose(e.position,e.quaternion,e.scale),e.projectionMatrix.fromArray(a.projectionMatrix),e.projectionMatrixInverse.copy(e.projectionMatrix).invert(),e.viewport.set(t.x,t.y,t.width,t.height),0===i&&(A.matrix.copy(e.matrix),A.matrix.decompose(A.position,A.quaternion,A.scale)),!0===s&&A.cameras.push(e)}var i=g.enabledFeatures;i&&i.includes("depth-sensing")&&(i=d.getDepthInformation(r[0]))&&i.isValid&&i.texture&&_.init(o,i,g.renderState)}for(let t=0;t<M.length;t++){var s=y[t],h=M[t];null!==s&&void 0!==h&&h.update(s,e,c||u)}O&&O(t,e),e.detectedPlanes&&l.dispatchEvent({type:"planesdetected",data:e}),m=null}),this.setAnimationLoop=function(t){O=t},this.dispose=function(){}}}let U0=new Ps,F0=new Ht;function B0(i,x){function b(t,e){!0===t.matrixAutoUpdate&&t.updateMatrix(),e.value.copy(t.matrix)}function S(t,e){t.isMask&&void 0!==e.isMask&&(t.isMask.value=e.isMask,e.isMask?(t.maskPolygons.value=e.maskPolygons,t.maskPolygons.needsUpdate=!0,t.maskHolePogygons.value=e.maskHolePogygons,t.maskHolePogygons.needsUpdate=!0,t.maskType.value=e.maskType,t.maskType.needsUpdate=!0,t.maskHeight.value=e.maskHeight,t.maskHeight.needsUpdate=!0,t.maskExtrudeHeight.value=e.maskExtrudeHeight,t.maskExtrudeHeight.needsUpdate=!0,t.boundCenter.value=e.boundCenter,t.boundCenter.needsUpdate=!0,t.boundSize.value=e.boundSize,t.boundSize.needsUpdate=!0,t.maskOpacity.value=e.maskOpacity,t.maskNodeHeight.value=e.maskNodeHeight):(t.maskPolygons.needsUpdate=!1,t.maskHolePogygons.needsUpdate=!1,t.maskType.needsUpdate=!1,t.maskHeight.needsUpdate=!1,t.maskExtrudeHeight.needsUpdate=!1,t.boundCenter.needsUpdate=!1,t.boundSize.needsUpdate=!1,t.maskOpacity.needsUpdate=!1,t.maskNodeHeight.needsUpdate=!1))}function A(t,e){t.opacity.value=e.opacity,e.color&&t.diffuse.value.copy(e.color),e.emissive&&t.emissive.value.copy(e.emissive).multiplyScalar(e.emissiveIntensity),e.map&&(t.map.value=e.map,b(e.map,t.mapTransform)),e.alphaMap&&(t.alphaMap.value=e.alphaMap,b(e.alphaMap,t.alphaMapTransform)),e.bumpMap&&(t.bumpMap.value=e.bumpMap,b(e.bumpMap,t.bumpMapTransform),t.bumpScale.value=e.bumpScale,e.side===Yt)&&(t.bumpScale.value*=-1),e.normalMap&&(t.normalMap.value=e.normalMap,b(e.normalMap,t.normalMapTransform),t.normalScale.value.copy(e.normalScale),e.side===Yt)&&t.normalScale.value.negate(),e.displacementMap&&(t.displacementMap.value=e.displacementMap,b(e.displacementMap,t.displacementMapTransform),t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias),e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap,b(e.emissiveMap,t.emissiveMapTransform)),e.specularMap&&(t.specularMap.value=e.specularMap,b(e.specularMap,t.specularMapTransform)),0<e.alphaTest&&(t.alphaTest.value=e.alphaTest);var i=x.get(e),s=i.envMap,i=i.envMapRotation;s&&(t.envMap.value=s,U0.copy(i),U0.x*=-1,U0.y*=-1,U0.z*=-1,s.isCubeTexture&&!1===s.isRenderTargetTexture&&(U0.y*=-1,U0.z*=-1),t.envMapRotation.value.setFromMatrix4(F0.makeRotationFromEuler(U0)),t.flipEnvMap.value=s.isCubeTexture&&!1===s.isRenderTargetTexture?-1:1,t.reflectivity.value=e.reflectivity,t.ior.value=e.ior,t.refractionRatio.value=e.refractionRatio),e.lightMap&&(t.lightMap.value=e.lightMap,t.lightMapIntensity.value=e.lightMapIntensity,b(e.lightMap,t.lightMapTransform)),e.aoMap&&(t.aoMap.value=e.aoMap,t.aoMapIntensity.value=e.aoMapIntensity,b(e.aoMap,t.aoMapTransform)),void 0!==e.mapMixColor&&(t.mapMixColor.value=e.mapMixColor,t.mapMixColor.needsUpdate=!0,e.mapMixColor)&&(t.heatCenter.value=e.heatCenter,t.heatSize.value=e.heatSize,t.heatCenter.needsUpdate=!0,t.heatSize.needsUpdate=!0),void 0!==e.isJsonModel&&(t.isJsonModel.value=e.isJsonModel),S(t,e)}return{refreshFogUniforms:function(t,e){e.color.getRGB(t.fogColor.value,kh(i)),e.isFog?(t.fogNear.value=e.near,t.fogFar.value=e.far):e.isFogExp2&&(t.fogDensity.value=e.density)},refreshMaterialUniforms:function(t,e,i,s,r){var n,a,h,o,l,u,c,f,d,v,p,m,g,_,w,M,y,E;e.isMeshBasicMaterial||e.isMeshLambertMaterial?A(t,e):e.isMeshToonMaterial?(A(t,e),y=t,(E=e).gradientMap&&(y.gradientMap.value=E.gradientMap)):e.isMeshPhongMaterial?(A(t,e),y=e,(E=t).specular.value.copy(y.specular),E.shininess.value=Math.max(y.shininess,1e-4)):e.isMeshStandardMaterial?(A(t,e),n=e,(M=t).metalness.value=n.metalness,n.metalnessMap&&(M.metalnessMap.value=n.metalnessMap,b(n.metalnessMap,M.metalnessMapTransform)),M.roughness.value=n.roughness,n.roughnessMap&&(M.roughnessMap.value=n.roughnessMap,b(n.roughnessMap,M.roughnessMapTransform)),n.envMap&&(M.envMapIntensity.value=n.envMapIntensity),e.isMeshPhysicalMaterial&&(M=e,n=r,(r=t).ior.value=M.ior,0<M.sheen&&(r.sheenColor.value.copy(M.sheenColor).multiplyScalar(M.sheen),r.sheenRoughness.value=M.sheenRoughness,M.sheenColorMap&&(r.sheenColorMap.value=M.sheenColorMap,b(M.sheenColorMap,r.sheenColorMapTransform)),M.sheenRoughnessMap)&&(r.sheenRoughnessMap.value=M.sheenRoughnessMap,b(M.sheenRoughnessMap,r.sheenRoughnessMapTransform)),0<M.clearcoat&&(r.clearcoat.value=M.clearcoat,r.clearcoatRoughness.value=M.clearcoatRoughness,M.clearcoatMap&&(r.clearcoatMap.value=M.clearcoatMap,b(M.clearcoatMap,r.clearcoatMapTransform)),M.clearcoatRoughnessMap&&(r.clearcoatRoughnessMap.value=M.clearcoatRoughnessMap,b(M.clearcoatRoughnessMap,r.clearcoatRoughnessMapTransform)),M.clearcoatNormalMap)&&(r.clearcoatNormalMap.value=M.clearcoatNormalMap,b(M.clearcoatNormalMap,r.clearcoatNormalMapTransform),r.clearcoatNormalScale.value.copy(M.clearcoatNormalScale),M.side===Yt)&&r.clearcoatNormalScale.value.negate(),0<M.dispersion&&(r.dispersion.value=M.dispersion),0<M.iridescence&&(r.iridescence.value=M.iridescence,r.iridescenceIOR.value=M.iridescenceIOR,r.iridescenceThicknessMinimum.value=M.iridescenceThicknessRange[0],r.iridescenceThicknessMaximum.value=M.iridescenceThicknessRange[1],M.iridescenceMap&&(r.iridescenceMap.value=M.iridescenceMap,b(M.iridescenceMap,r.iridescenceMapTransform)),M.iridescenceThicknessMap)&&(r.iridescenceThicknessMap.value=M.iridescenceThicknessMap,b(M.iridescenceThicknessMap,r.iridescenceThicknessMapTransform)),0<M.transmission&&(r.transmission.value=M.transmission,r.transmissionSamplerMap.value=n.texture,r.transmissionSamplerSize.value.set(n.width,n.height),M.transmissionMap&&(r.transmissionMap.value=M.transmissionMap,b(M.transmissionMap,r.transmissionMapTransform)),r.thickness.value=M.thickness,M.thicknessMap&&(r.thicknessMap.value=M.thicknessMap,b(M.thicknessMap,r.thicknessMapTransform)),r.attenuationDistance.value=M.attenuationDistance,r.attenuationColor.value.copy(M.attenuationColor)),0<M.anisotropy&&(r.anisotropyVector.value.set(M.anisotropy*Math.cos(M.anisotropyRotation),M.anisotropy*Math.sin(M.anisotropyRotation)),M.anisotropyMap)&&(r.anisotropyMap.value=M.anisotropyMap,b(M.anisotropyMap,r.anisotropyMapTransform)),r.specularIntensity.value=M.specularIntensity,r.specularColor.value.copy(M.specularColor),M.specularColorMap&&(r.specularColorMap.value=M.specularColorMap,b(M.specularColorMap,r.specularColorMapTransform)),M.specularIntensityMap)&&(r.specularIntensityMap.value=M.specularIntensityMap,b(M.specularIntensityMap,r.specularIntensityMapTransform)),"FMMeshStandardMaterial"===e.type&&(n=t,(M=e).sweep&&({sweepW:M,sweepH:r,se2N:o,se2RN:l,moveP:w,color_r:_,color_a:g,isRect:m,isAnnulus:c,isEnable:f,circleC:d,maxR:u,minR:p,isSweepTexture:v,sweepTexture:a,sweepStrength:h}=M.sweep,n.sweepW.value=M,n.sweepH.value=r,n.se2N.value=o,n.se2RN.value=l,n.moveP.value=w,n.color_r.value=_,n.color_a.value=g,n.isRect.value=m,n.isAnnulus.value=c,n.isEnable.value=f,n.circleC.value=d,n.maxR.value=u,n.minR.value=p,n.isSweepTexture.value=v,n.sweepTexture.value=a,n.sweepStrength.value=h),S(t,e))):e.isMeshMatcapMaterial?(A(t,e),M=t,(r=e).matcap&&(M.matcap.value=r.matcap)):e.isMeshDepthMaterial?A(t,e):e.isMeshDistanceMaterial?(A(t,e),o=t,l=e,l=x.get(l).light,o.referencePosition.value.setFromMatrixPosition(l.matrixWorld),o.nearDistance.value=l.shadow.camera.near,o.farDistance.value=l.shadow.camera.far):e.isMeshNormalMaterial?A(t,e):e.isLineBasicMaterial?(w=e,(_=t).diffuse.value.copy(w.color),_.opacity.value=w.opacity,w.map&&(_.map.value=w.map,b(w.map,_.mapTransform)),e.isLineDashedMaterial&&(g=e,(m=t).dashSize.value=g.dashSize,m.totalSize.value=g.dashSize+g.gapSize,m.scale.value=g.scale),"FMLineBasicMaterial"===e.type&&S(t,e)):e.isPointsMaterial?(c=e,f=i,d=s,(u=t).diffuse.value.copy(c.color),u.opacity.value=c.opacity,u.size.value=c.size*f,u.scale.value=.5*d,c.map&&(u.map.value=c.map,b(c.map,u.uvTransform)),c.alphaMap&&(u.alphaMap.value=c.alphaMap,b(c.alphaMap,u.alphaMapTransform)),0<c.alphaTest&&(u.alphaTest.value=c.alphaTest)):e.isSpriteMaterial?(p=e,(v=t).diffuse.value.copy(p.color),v.opacity.value=p.opacity,v.rotation.value=p.rotation,p.map&&(v.map.value=p.map,b(p.map,v.mapTransform)),p.alphaMap&&(v.alphaMap.value=p.alphaMap,b(p.alphaMap,v.alphaMapTransform)),0<p.alphaTest&&(v.alphaTest.value=p.alphaTest)):e.isShadowMaterial?(t.color.value.copy(e.color),t.opacity.value=e.opacity):e.isShaderMaterial&&(e.uniformsNeedUpdate=!1)}}}function k0(y,E,t,x){let b={},S={},A=[],T=y.getParameter(y.MAX_UNIFORM_BUFFER_BINDINGS);function R(t){var e={boundary:0,storage:0};return"number"==typeof t||"boolean"==typeof t?(e.boundary=4,e.storage=4):t.isVector2?(e.boundary=8,e.storage=8):t.isVector3||t.isColor?(e.boundary=16,e.storage=12):t.isVector4?(e.boundary=16,e.storage=16):t.isMatrix3?(e.boundary=48,e.storage=48):t.isMatrix4?(e.boundary=64,e.storage=64):t.isTexture?console.warn("THREE.WebGLRenderer: Texture samplers can not be part of an uniforms group."):console.warn("THREE.WebGLRenderer: Unsupported uniform value type.",t),e}function L(t){var t=t.target,e=(t.removeEventListener("dispose",L),A.indexOf(t.Dn));A.splice(e,1),y.deleteBuffer(b[t.id]),delete b[t.id],delete S[t.id]}return{bind:function(t,e){e=e.program,x.uniformBlockBinding(t,e)},update:function(t,e){var i;if(void 0===(i=b[t.id])){{var r=t;let i=r.uniforms,s=0;for(let t=0,e=i.length;t<e;t++){var n=Array.isArray(i[t])?i[t]:[i[t]];for(let t=0,e=n.length;t<e;t++){var a=n[t],h=Array.isArray(a.value)?a.value:[a.value];for(let t=0,e=h.length;t<e;t++){var o=R(h[t]),l=s%16,u=l%o.boundary,l=l+u;s+=u,0!=l&&16-l<o.storage&&(s+=16-l),a.ta=new Float32Array(o.storage/Float32Array.BYTES_PER_ELEMENT),a.ea=s,s+=o.storage}}}var c=s%16;0<c&&(s+=16-c),r.ia=s,r.sa={}}c=t,r=(()=>{for(let t=0;t<T;t++)if(-1===A.indexOf(t))return A.push(t),t;return console.error("THREE.WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0})(),c.Dn=r,f=y.createBuffer(),s=c.ia,c=c.usage,y.bindBuffer(y.UNIFORM_BUFFER,f),y.bufferData(y.UNIFORM_BUFFER,s,c),y.bindBuffer(y.UNIFORM_BUFFER,null),y.bindBufferBase(y.UNIFORM_BUFFER,r,f),i=f,b[t.id]=i,t.addEventListener("dispose",L)}var s=e.program,c=(x.updateUBOMapping(t,s),E.render.frame);if(S[t.id]!==c){var r=t,f=b[r.id],d=r.uniforms,v=r.sa;y.bindBuffer(y.UNIFORM_BUFFER,f);for(let i=0,t=d.length;i<t;i++){var p=Array.isArray(d[i])?d[i]:[d[i]];for(let t=0,e=p.length;t<e;t++){var m=p[t];if(!0===((t,e,i,s)=>{if(t=t.value,void 0===s[e=e+"_"+i])return s[e]="number"==typeof t||"boolean"==typeof t?t:t.clone(),!0;if(i=s[e],"number"==typeof t||"boolean"==typeof t){if(i!==t)return s[e]=t,!0}else if(!1===i.equals(t))return i.copy(t),!0;return!1})(m,i,t,v)){var g=m.ea,_=Array.isArray(m.value)?m.value:[m.value];let e=0;for(let t=0;t<_.length;t++){var w=_[t],M=R(w);"number"==typeof w||"boolean"==typeof w?(m.ta[0]=w,y.bufferSubData(y.UNIFORM_BUFFER,g+e,m.ta)):w.isMatrix3?(m.ta[0]=w.elements[0],m.ta[1]=w.elements[1],m.ta[2]=w.elements[2],m.ta[3]=0,m.ta[4]=w.elements[3],m.ta[5]=w.elements[4],m.ta[6]=w.elements[5],m.ta[7]=0,m.ta[8]=w.elements[6],m.ta[9]=w.elements[7],m.ta[10]=w.elements[8],m.ta[11]=0):(w.toArray(m.ta,e),e+=M.storage/Float32Array.BYTES_PER_ELEMENT)}y.bufferSubData(y.UNIFORM_BUFFER,g,m.ta)}}}y.bindBuffer(y.UNIFORM_BUFFER,null),S[t.id]=c}},dispose:function(){for(var t in b)y.deleteBuffer(b[t]);A=[],b={},S={}}}}class G0{constructor(t={}){let{canvas:s=_h(),context:i=null,depth:a=!0,stencil:x=!1,alpha:b=!1,antialias:S=!1,premultipliedAlpha:A=!0,preserveDrawingBuffer:T=!1,powerPreference:W="default",failIfMajorPerformanceCaveat:j=!1}=t;this.isWebGLRenderer=!0;let X;if(null!==i){if("undefined"!=typeof WebGLRenderingContext&&i instanceof WebGLRenderingContext)throw new Error("THREE.WebGLRenderer: WebGL 1 is not supported since r163.");X=i.getContextAttributes().alpha}else X=b;let o=new Uint32Array(4),l=new Int32Array(4),f=null,R=null,h=[],u=[],L=(this.domElement=s,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.ra=bi,this.toneMapping=qt,this.toneMappingExposure=1,this),Y=!1,Z=0,q=0,C=null,N=-1,I=null,d=new Vt,K=new Vt,J=null,$=new Wt(0),Q=0,r=s.width,P=s.height,D=1,tt=null,et=null,it=new Vt(0,0,r,P),st=new Vt(0,0,r,P),rt=!1,nt=new Lr,O=!1,at=!1,ht=new Ht,ot=new Ht,lt=new Gt,v=new Vt,ut={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0},ct=!1;function ft(){return null===C?D:1}let U=i;function dt(t,e){return s.getContext(t,e)}try{var vt={alpha:!0,depth:a,stencil:x,antialias:S,premultipliedAlpha:A,preserveDrawingBuffer:T,powerPreference:W,failIfMajorPerformanceCaveat:j};if("setAttribute"in s&&s.setAttribute("data-engine","three.js r"+jt),s.addEventListener("webglcontextlost",bt,!1),s.addEventListener("webglcontextrestored",St,!1),s.addEventListener("webglcontextcreationerror",At,!1),null===U)if(null===(U=dt("webgl2",vt)))throw dt("webgl2")?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}catch(t){throw console.error("THREE.WebGLRenderer: "+t.message),t}let m,F,B,n,k,G,H,V,g,pt,p,c,mt,gt,_t,z,_,w,wt,Mt,yt,y,M,Et;function xt(){(m=new hf(U)).init(),y=new T0(U,m),F=new xc(U,m,t,y),B=new x0(U),F.reverseDepthBuffer&&B.buffers.depth.setReversed(!0),n=new uf(U),k=new n0,G=new A0(U,m,B,k,F,y,n),H=new Bc(L),V=new af(L),g=new uh(U),M=new yc(U,g),pt=new of(U,g,n,M),p=new df(U,pt,g,n),wt=new ff(U,F,G),z=new bc(k),c=new r0(L,H,V,m,F,M,z),mt=new B0(L,k),gt=new l0,_t=new m0(m),w=new Mc(L,H,V,B,p,X,A),_=new y0(L,p,F),Et=new k0(U,n,F,B),Mt=new Ec(U,m,n),yt=new lf(U,m,n),n.programs=c.programs,L.capabilities=F,L.extensions=m,L.properties=k,L.renderLists=gt,L.shadowMap=_,L.state=B,L.info=n}xt();let E=new O0(L,U);function bt(t){t.preventDefault(),Y=!0}function St(){Y=!1;var t=n.autoReset,e=_.enabled,i=_.autoUpdate,s=_.needsUpdate,r=_.type;xt(),n.autoReset=t,_.enabled=e,_.autoUpdate=i,_.needsUpdate=s,_.type=r}function At(t){console.error("THREE.WebGLRenderer: A WebGL context could not be created. Reason: ",t.statusMessage)}function Tt(t){var t=t.target,e=(t.removeEventListener("dispose",Tt),t=t),i=k.get(e).programs;void 0!==i&&(i.forEach(function(t){c.releaseProgram(t)}),e.isShaderMaterial)&&c.releaseShaderCache(e),k.remove(t)}function Rt(t,e,i){!0===t.transparent&&t.side===Zt&&!1===t.forceSinglePass?(t.side=Yt,t.needsUpdate=!0,Ft(t,e,i),t.side=Xt,t.needsUpdate=!0,Ft(t,e,i),t.side=Zt):Ft(t,e,i)}this.xr=E,this.getContext=function(){return U},this.getContextAttributes=function(){return U.getContextAttributes()},this.forceContextLoss=function(){var t=m.get("WEBGL_lose_context");t&&t.loseContext()},this.forceContextRestore=function(){var t=m.get("WEBGL_lose_context");t&&t.restoreContext()},this.getPixelRatio=function(){return D},this.setPixelRatio=function(t){void 0!==t&&(D=t,this.setSize(r,P,!1))},this.getSize=function(t){return t.set(r,P)},this.setSize=function(t,e,i=!0){E.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(r=t,P=e,s.width=Math.floor(t*D),s.height=Math.floor(e*D),!0===i&&(s.style.width=t+"px",s.style.height=e+"px"),this.setViewport(0,0,t,e))},this.getDrawingBufferSize=function(t){return t.set(r*D,P*D).floor()},this.setDrawingBufferSize=function(t,e,i){r=t,P=e,D=i,s.width=Math.floor(t*i),s.height=Math.floor(e*i),this.setViewport(0,0,t,e)},this.getCurrentViewport=function(t){return t.copy(d)},this.getViewport=function(t){return t.copy(it)},this.setViewport=function(t,e,i,s){t.isVector4?it.set(t.x,t.y,t.z,t.w):it.set(t,e,i,s),B.viewport(d.copy(it).multiplyScalar(D).round())},this.getScissor=function(t){return t.copy(st)},this.setScissor=function(t,e,i,s){t.isVector4?st.set(t.x,t.y,t.z,t.w):st.set(t,e,i,s),B.scissor(K.copy(st).multiplyScalar(D).round())},this.getScissorTest=function(){return rt},this.setScissorTest=function(t){B.setScissorTest(rt=t)},this.setOpaqueSort=function(t){tt=t},this.setTransparentSort=function(t){et=t},this.getClearColor=function(t){return t.copy(w.getClearColor())},this.setClearColor=function(){w.setClearColor.apply(w,arguments)},this.getClearAlpha=function(){return w.getClearAlpha()},this.setClearAlpha=function(){w.setClearAlpha.apply(w,arguments)},this.clear=function(e=!0,t=!0,i=!0){let s=0;if(e){let t=!1;var r,n,a,h;null!==C&&(e=C.texture.format,t=e===Ae||e===Se||e===xe),t?(e=(e=C.texture.type)===se||e===oe||e===ae||e===de||e===ce||e===fe,h=w.getClearColor(),r=w.getClearAlpha(),n=h.r,a=h.g,h=h.b,e?(o[0]=n,o[1]=a,o[2]=h,o[3]=r,U.clearBufferuiv(U.COLOR,0,o)):(l[0]=n,l[1]=a,l[2]=h,l[3]=r,U.clearBufferiv(U.COLOR,0,l))):s|=U.COLOR_BUFFER_BIT}t&&(s|=U.DEPTH_BUFFER_BIT,U.clearDepth(this.capabilities.reverseDepthBuffer?0:1)),i&&(s|=U.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),U.clear(s)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){s.removeEventListener("webglcontextlost",bt,!1),s.removeEventListener("webglcontextrestored",St,!1),s.removeEventListener("webglcontextcreationerror",At,!1),gt.dispose(),_t.dispose(),k.dispose(),H.dispose(),V.dispose(),p.dispose(),M.dispose(),Et.dispose(),c.dispose(),E.dispose(),E.removeEventListener("sessionstart",Ct),E.removeEventListener("sessionend",Nt),e.stop()},this.renderBufferDirect=function(t,i,s,r,n,a){null===i&&(i=ut);var h=n.isMesh&&n.matrixWorld.determinant()<0,t=((t,e,i,s,r)=>{!0!==e.isScene&&(e=ut),G.resetTextureUnits();let n=e.fog,a=s.isMeshStandardMaterial?e.environment:null,h=null===C?L.outputColorSpace:!0===C.isXRRenderTarget?C.texture.colorSpace:Si,o=(s.isMeshStandardMaterial?V:H).get(s.envMap||a),l=!0===s.vertexColors&&!!i.attributes.color&&4===i.attributes.color.itemSize,u=!!i.attributes.tangent&&(!!s.normalMap||0<s.anisotropy),c=!!i.morphAttributes.position,f=!!i.morphAttributes.normal,d=!!i.morphAttributes.color,v=qt;!s.toneMapped||null!==C&&!0!==C.isXRRenderTarget||(v=L.toneMapping);var p,m=void 0!==(m=i.morphAttributes.position||i.morphAttributes.normal||i.morphAttributes.color)?m.length:0,g=k.get(s),_=R.state.lights;!0!==O||!0!==at&&t===I||(p=t===I&&s.id===N,z.setState(s,t,p));let w=!1,M=(s.version===g.zn?(g.needsLights&&g.lightsStateVersion!==_.state.version||g.outputColorSpace!==h||r.isBatchedMesh&&!1===g.batching||!r.isBatchedMesh&&!0===g.batching||r.isBatchedMesh&&!0===g.batchingColor&&null===r.colorTexture||r.isBatchedMesh&&!1===g.batchingColor&&null!==r.colorTexture||r.isInstancedMesh&&!1===g.instancing||!r.isInstancedMesh&&!0===g.instancing||r.isSkinnedMesh&&!1===g.skinning||!r.isSkinnedMesh&&!0===g.skinning||r.isInstancedMesh&&!0===g.instancingColor&&null===r.instanceColor||r.isInstancedMesh&&!1===g.instancingColor&&null!==r.instanceColor||r.isInstancedMesh&&!0===g.instancingMorph&&null===r.morphTexture||r.isInstancedMesh&&!1===g.instancingMorph&&null!==r.morphTexture||g.envMap!==o||!0===s.fog&&g.fog!==n||void 0!==g.numClippingPlanes&&(g.numClippingPlanes!==z.numPlanes||g.numIntersection!==z.numIntersection)||g.vertexAlphas!==l||g.vertexTangents!==u||g.morphTargets!==c||g.morphNormals!==f||g.morphColors!==d||g.toneMapping!==v||g.morphTargetsCount!==m)&&(w=!0):(w=!0,g.zn=s.version),g.currentProgram),y=(!0===w&&(M=Ft(s,e,r)),!1),E=!1,x=!1,b=M.getUniforms(),S=g.uniforms;B.useProgram(M.program)&&(y=!0,E=!0,x=!0),s.id!==N&&(N=s.id,E=!0),!y&&I===t||(F.reverseDepthBuffer?(ht.copy(t.projectionMatrix),Eh(ht),xh(ht),b.setValue(U,"projectionMatrix",ht)):b.setValue(U,"projectionMatrix",t.projectionMatrix),b.setValue(U,"viewMatrix",t.matrixWorldInverse),void 0!==(p=b.map.cameraPosition)&&p.setValue(U,lt.setFromMatrixPosition(t.matrixWorld)),F.logarithmicDepthBuffer&&b.setValue(U,"logDepthBufFC",2/(Math.log(t.far+1)/Math.LN2)),(s.isMeshPhongMaterial||s.isMeshToonMaterial||s.isMeshLambertMaterial||s.isMeshBasicMaterial||s.isMeshStandardMaterial||s.isShaderMaterial)&&b.setValue(U,"isOrthographic",!0===t.isOrthographicCamera),I===t)||(I=t,E=!0,x=!0),r.isSkinnedMesh&&(b.setOptional(U,r,"bindMatrix"),b.setOptional(U,r,"bindMatrixInverse"),_=r.skeleton)&&(null===_.boneTexture&&_.computeBoneTexture(),b.setValue(U,"boneTexture",_.boneTexture,G)),r.isBatchedMesh&&(b.setOptional(U,r,"batchingTexture"),b.setValue(U,"batchingTexture",r._matricesTexture,G),b.setOptional(U,r,"batchingIdTexture"),b.setValue(U,"batchingIdTexture",r._indirectTexture,G),b.setOptional(U,r,"batchingColorTexture"),null!==r._colorsTexture)&&b.setValue(U,"batchingColorTexture",r._colorsTexture,G),void 0===(m=i.morphAttributes).position&&void 0===m.normal&&void 0===m.color||wt.update(r,i,M),!E&&g.receiveShadow===r.receiveShadow||(g.receiveShadow=r.receiveShadow,b.setValue(U,"receiveShadow",r.receiveShadow)),s.isMeshGouraudMaterial&&null!==s.envMap&&(S.envMap.value=o,S.flipEnvMap.value=o.isCubeTexture&&!1===o.isRenderTargetTexture?-1:1),s.isMeshStandardMaterial&&null===s.envMap&&null!==e.environment&&(S.envMapIntensity.value=e.environmentIntensity),E&&(b.setValue(U,"toneMappingExposure",L.toneMappingExposure),g.needsLights&&(_=S,m=x,_.ambientLightColor.needsUpdate=m,_.lightProbe.needsUpdate=m,_.directionalLights.needsUpdate=m,_.directionalLightShadows.needsUpdate=m,_.pointLights.needsUpdate=m,_.pointLightShadows.needsUpdate=m,_.spotLights.needsUpdate=m,_.spotLightShadows.needsUpdate=m,_.rectAreaLights.needsUpdate=m,_.hemisphereLights.needsUpdate=m),n&&!0===s.fog&&mt.refreshFogUniforms(S,n),mt.refreshMaterialUniforms(S,s,D,P,R.state.transmissionRenderTarget[t.id]),Ed.upload(U,Bt(g),S,G));if(s.isShaderMaterial&&!0===s.uniformsNeedUpdate&&(Ed.upload(U,Bt(g),S,G),s.uniformsNeedUpdate=!1),s.isSpriteMaterial&&b.setValue(U,"center",r.center),b.setValue(U,"modelViewMatrix",r.modelViewMatrix),b.setValue(U,"normalMatrix",r.normalMatrix),b.setValue(U,"modelMatrix",r.matrixWorld),s.isShaderMaterial||s.isRawShaderMaterial){var A=s.uniformsGroups;for(let t=0,e=A.length;t<e;t++){var T=A[t];Et.update(T,M),Et.bind(T,M)}}return M})(t,i,s,r,n);B.setMaterial(r,h);let o=s.index,e=1;if(!0===r.wireframe){if(void 0===(o=pt.getWireframeAttribute(s)))return;e=2}i=s.drawRange,h=s.attributes.position;let l=i.start*e,u=(i.start+i.count)*e;null!==a&&(l=Math.max(l,a.start*e),u=Math.min(u,(a.start+a.count)*e)),null!==o?(l=Math.max(l,0),u=Math.min(u,o.count)):null!=h&&(l=Math.max(l,0),u=Math.min(u,h.count));i=u-l;if(!(i<0||i==1/0)){M.setup(n,r,t,s,o);let e=Mt;if(null!==o&&(a=g.get(o),(e=yt).setIndex(a)),n.isMesh)!0===r.wireframe?(B.setLineWidth(r.wireframeLinewidth*ft()),e.setMode(U.LINES)):e.setMode(U.TRIANGLES);else if(n.isLine){let t=r.linewidth;void 0===t&&(t=1),B.setLineWidth(t*ft()),n.isLineSegments?e.setMode(U.LINES):n.isLineLoop?e.setMode(U.LINE_LOOP):e.setMode(U.LINE_STRIP)}else n.isPoints?e.setMode(U.POINTS):n.isSprite&&e.setMode(U.TRIANGLES);if(n.isBatchedMesh)if(null!==n._multiDrawInstances)e.renderMultiDrawInstances(n._multiDrawStarts,n._multiDrawCounts,n._multiDrawCount,n._multiDrawInstances);else if(m.get("WEBGL_multi_draw"))e.renderMultiDraw(n._multiDrawStarts,n._multiDrawCounts,n._multiDrawCount);else{var c=n._multiDrawStarts,f=n._multiDrawCounts,d=n._multiDrawCount,v=o?g.get(o).bytesPerElement:1,p=k.get(r).currentProgram.getUniforms();for(let t=0;t<d;t++)p.setValue(U,"_gl_DrawID",t),e.render(c[t]/v,f[t])}else n.isInstancedMesh?e.renderInstances(l,i,n.count):s.isInstancedBufferGeometry?(h=void 0!==s.L?s.L:1/0,t=Math.min(s.instanceCount,h),e.renderInstances(l,i,t)):e.render(l,i)}},this.compile=function(t,e,r=null){null===r&&(r=t),(R=_t.get(r)).init(e),u.push(R),r.traverseVisible(function(t){t.isLight&&t.layers.test(e.layers)&&(R.pushLight(t),t.castShadow)&&R.pushShadow(t)}),t!==r&&t.traverseVisible(function(t){t.isLight&&t.layers.test(e.layers)&&(R.pushLight(t),t.castShadow)&&R.pushShadow(t)}),R.setupLights();let n=new Set;return t.traverse(function(e){if(e.isMesh||e.isPoints||e.isLine||e.isSprite){var i=e.material;if(i)if(Array.isArray(i))for(let t=0;t<i.length;t++){var s=i[t];Rt(s,r,e),n.add(s)}else Rt(i,r,e),n.add(i)}}),u.pop(),R=null,n},this.compileAsync=function(i,t,e=null){let s=this.compile(i,t,e);return new Promise(t=>{function e(){s.forEach(function(t){k.get(t).currentProgram.isReady()&&s.delete(t)}),0===s.size?t(i):setTimeout(e,10)}null!==m.get("KHR_parallel_shader_compile")?e():setTimeout(e,10)})};let Lt=null;function Ct(){e.stop()}function Nt(){e.start()}let e=new lh;function It(i,s,r,n){if(!1!==i.visible){var t,e;if(i.layers.test(s.layers))if(i.isGroup)r=i.renderOrder;else if(i.isLOD)!0===i.autoUpdate&&i.update(s);else if(i.isLight)R.pushLight(i),i.castShadow&&R.pushShadow(i);else if(i.isSprite)!i.frustumCulled||nt.intersectsSprite(i)?(n&&v.setFromMatrixPosition(i.matrixWorld).applyMatrix4(ot),t=p.update(i),(e=i.material).visible&&f.push(i,t,e,r,v.z,null),i.frustumCulledFailCallback&&i.frustumCulledFailCallback()):i.frustumCulledSuccCallback&&i.frustumCulledSuccCallback();else if((i.isMesh||i.isLine||i.isPoints)&&(!i.frustumCulled||nt.intersectsObject(i))){var a=p.update(i),h=i.material;if(n&&(void 0!==i.boundingSphere?(null===i.boundingSphere&&i.computeBoundingSphere(),v.copy(i.boundingSphere.center)):(null===a.boundingSphere&&a.computeBoundingSphere(),v.copy(a.boundingSphere.center)),v.applyMatrix4(i.matrixWorld).applyMatrix4(ot)),Array.isArray(h)){var o=a.groups;for(let t=0,e=o.length;t<e;t++){var l=o[t],u=h[l.materialIndex];u&&u.visible&&f.push(i,a,u,r,v.z,l)}}else h.visible&&f.push(i,a,h,r,v.z,null)}var c=i.children;for(let t=0,e=c.length;t<e;t++)It(c[t],s,r,n)}}function Pt(t,e,i,s){var r=t.opaque,n=t.transmissive,t=t.transparent;R.setupLightsView(i),!0===O&&z.setGlobalState(L.clippingPlanes,i),s&&B.viewport(d.copy(s)),0<r.length&&Ot(r,e,i),0<n.length&&Ot(n,e,i),0<t.length&&Ot(t,e,i),B.buffers.depth.setTest(!0),B.buffers.depth.setMask(!0),B.buffers.color.setMask(!0),B.setPolygonOffset(!1)}function Dt(t,s,r,n){var e=!0===r.isScene?r.overrideMaterial:null;if(null===e){void 0===R.state.transmissionRenderTarget[n.id]&&(R.state.transmissionRenderTarget[n.id]=new Ic(1,1,{generateMipmaps:!0,type:m.has("EXT_color_buffer_half_float")||m.has("EXT_color_buffer_float")?ue:se,minFilter:ee,samples:4,stencilBuffer:x,resolveDepthBuffer:!1,resolveStencilBuffer:!1,colorSpace:zt.workingColorSpace}));var e=R.state.transmissionRenderTarget[n.id],i=n.viewport||d,i=(e.setSize(i.z,i.w),L.getRenderTarget()),a=(L.setRenderTarget(e),L.getClearColor($),(Q=L.getClearAlpha())<1&&L.setClearColor(16777215,.5),L.clear(),ct&&w.render(r),L.toneMapping),h=(L.toneMapping=qt,n.viewport);if(void 0!==n.viewport&&(n.viewport=void 0),R.setupLightsView(n),!0===O&&z.setGlobalState(L.clippingPlanes,n),Ot(t,r,n),G.updateMultisampleRenderTarget(e),G.updateRenderTargetMipmap(e),!1===m.has("WEBGL_multisampled_render_to_texture")){let i=!1;for(let t=0,e=s.length;t<e;t++){var o,l=s[t],u=l.object,c=l.geometry,f=l.material,l=l.group;f.side===Zt&&u.layers.test(n.layers)&&(o=f.side,f.side=Yt,f.needsUpdate=!0,Ut(u,r,n,c,f,l),f.side=o,f.needsUpdate=!0,i=!0)}!0===i&&(G.updateMultisampleRenderTarget(e),G.updateRenderTargetMipmap(e))}L.setRenderTarget(i),L.setClearColor($,Q),void 0!==h&&(n.viewport=h),L.toneMapping=a}}function Ot(i,s,r){var n=!0===s.isScene?s.overrideMaterial:null;for(let t=0,e=i.length;t<e;t++){var a=i[t],h=a.object,o=a.geometry,l=null===n?a.material:n,a=a.group;h.layers.test(r.layers)&&Ut(h,s,r,o,l,a)}}function Ut(t,e,i,s,r,n){t.onBeforeRender(L,e,i,s,r,n),t.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,t.matrixWorld),t.normalMatrix.getNormalMatrix(t.modelViewMatrix),r.onBeforeRender(L,e,i,s,t,n),!0===r.transparent&&r.side===Zt&&!1===r.forceSinglePass?(r.side=Yt,r.needsUpdate=!0,L.renderBufferDirect(i,e,s,r,t,n),r.side=Xt,r.needsUpdate=!0,L.renderBufferDirect(i,e,s,r,t,n),r.side=Zt):L.renderBufferDirect(i,e,s,r,t,n),t.onAfterRender(L,e,i,s,r,n)}function Ft(t,e,i){!0!==e.isScene&&(e=ut);var s=k.get(t),r=R.state.lights,n=R.state.shadowsArray,a=r.state.version,n=c.getParameters(t,r.state,n,e,i),i=c.getProgramCacheKey(n);let h=s.programs,o=(s.environment=t.isMeshStandardMaterial?e.environment:null,s.fog=e.fog,s.envMap=(t.isMeshStandardMaterial?V:H).get(t.envMap||s.environment),s.envMapRotation=null!==s.environment&&null===t.envMap?e.environmentRotation:t.envMapRotation,void 0===h&&(t.addEventListener("dispose",Tt),h=new Map,s.programs=h),h.get(i));if(void 0!==o){if(s.currentProgram===o&&s.lightsStateVersion===a)return kt(t,n),o}else n.uniforms=c.getUniforms(t),t.onBeforeCompile(n,L),o=c.acquireProgram(n,i),h.set(i,o),s.uniforms=n.uniforms;e=s.uniforms;return(t.isShaderMaterial||t.isRawShaderMaterial)&&!0!==t.clipping||(e.clippingPlanes=z.uniform),kt(t,n),s.needsLights=(i=t).isMeshLambertMaterial||i.isMeshToonMaterial||i.isMeshPhongMaterial||i.isMeshStandardMaterial||i.isShadowMaterial||i.isShaderMaterial&&!0===i.lights,s.lightsStateVersion=a,s.needsLights&&(e.ambientLightColor.value=r.state.ambient,e.lightProbe.value=r.state.probe,e.directionalLights.value=r.state.directional,e.directionalLightShadows.value=r.state.directionalShadow,e.spotLights.value=r.state.spot,e.spotLightShadows.value=r.state.spotShadow,e.rectAreaLights.value=r.state.rectArea,e.ltc_1.value=r.state.rectAreaLTC1,e.ltc_2.value=r.state.rectAreaLTC2,e.pointLights.value=r.state.point,e.pointLightShadows.value=r.state.pointShadow,e.hemisphereLights.value=r.state.hemi,e.directionalShadowMap.value=r.state.directionalShadowMap,e.directionalShadowMatrix.value=r.state.directionalShadowMatrix,e.spotShadowMap.value=r.state.spotShadowMap,e.spotLightMatrix.value=r.state.spotLightMatrix,e.spotLightMap.value=r.state.spotLightMap,e.pointShadowMap.value=r.state.pointShadowMap,e.pointShadowMatrix.value=r.state.pointShadowMatrix),s.currentProgram=o,s.uniformsList=null,o}function Bt(t){var e;return null===t.uniformsList&&(e=t.currentProgram.getUniforms(),t.uniformsList=Ed.seqWithValue(e.seq,t.uniforms)),t.uniformsList}function kt(t,e){t=k.get(t);t.outputColorSpace=e.outputColorSpace,t.batching=e.batching,t.batchingColor=e.batchingColor,t.instancing=e.instancing,t.instancingColor=e.instancingColor,t.instancingMorph=e.instancingMorph,t.skinning=e.skinning,t.morphTargets=e.morphTargets,t.morphNormals=e.morphNormals,t.morphColors=e.morphColors,t.morphTargetsCount=e.morphTargetsCount,t.numClippingPlanes=e.numClippingPlanes,t.numIntersection=e.numClipIntersection,t.vertexAlphas=e.vertexAlphas,t.vertexTangents=e.vertexTangents,t.toneMapping=e.toneMapping}e.setAnimationLoop(function(t){Lt&&Lt(t)}),"undefined"!=typeof self&&e.setContext(self),this.setAnimationLoop=function(t){Lt=t,E.setAnimationLoop(t),null===t?e.stop():e.start()},E.addEventListener("sessionstart",Ct),E.addEventListener("sessionend",Nt),this.render=function(i,t){if(void 0!==t&&!0!==t.isCamera)console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");else if(!0!==Y){!0===i.matrixWorldAutoUpdate&&i.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0===E.enabled&&!0===E.isPresenting&&(!0===E.cameraAutoUpdate&&E.updateCamera(t),t=E.getCamera()),!0===i.isScene&&i.onBeforeRender(L,i,t,C),(R=_t.get(i,u.length)).init(t),u.push(R),ot.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),nt.setFromProjectionMatrix(ot),at=this.localClippingEnabled,O=z.init(this.clippingPlanes,at),(f=gt.get(i,h.length)).init(),h.push(f),!0===E.enabled&&!0===E.isPresenting&&null!==(e=L.xr.getDepthSensingMesh())&&It(e,t,-1/0,L.sortObjects),It(i,t,0,L.sortObjects),f.finish(),!0===L.sortObjects&&f.sort(tt,et),(ct=!1===E.enabled||!1===E.isPresenting||!1===E.hasDepthSensing())&&w.addToRenderList(f,i),this.info.render.frame++,!0===O&&z.beginShadows();var e=R.state.shadowsArray,s=(_.render(e,i,t),!0===O&&z.endShadows(),!0===this.info.autoReset&&this.info.reset(),f.opaque),r=f.transmissive;if(R.setupLights(),t.isArrayCamera){var n=t.cameras;if(0<r.length)for(let t=0,e=n.length;t<e;t++)Dt(s,r,i,n[t]);ct&&w.render(i);for(let t=0,e=n.length;t<e;t++){var a=n[t];Pt(f,i,a,a.viewport)}}else 0<r.length&&Dt(s,r,i,t),ct&&w.render(i),Pt(f,i,t);null!==C&&(G.updateMultisampleRenderTarget(C),G.updateRenderTargetMipmap(C)),!0===i.isScene&&i.onAfterRender(L,i,t),M.resetDefaultState(),N=-1,I=null,u.pop(),0<u.length?(R=u[u.length-1],!0===O&&z.setGlobalState(L.clippingPlanes,R.state.camera)):R=null,h.pop(),f=0<h.length?h[h.length-1]:null}},this.getActiveCubeFace=function(){return Z},this.getActiveMipmapLevel=function(){return q},this.getRenderTarget=function(){return C},this.setRenderTargetTextures=function(t,e,i){k.get(t.texture).Vn=e,k.get(t.depthTexture).Vn=i;e=k.get(t);e.jn=!0,e.Zn=void 0===i,e.Zn||!0===m.has("WEBGL_multisampled_render_to_texture")&&(console.warn("THREE.WebGLRenderer: Render-to-texture extension was disabled because an external texture was provided"),e.qn=!1)},this.setRenderTargetFramebuffer=function(t,e){t=k.get(t);t.Fn=e,t.na=void 0===e},this.setRenderTarget=function(t,e=0,i=0){C=t,Z=e,q=i;let s=!0,r=null,n=!1,a=!1;if(t){var h=k.get(t);if(void 0!==h.na)B.bindFramebuffer(U.FRAMEBUFFER,null),s=!1;else if(void 0===h.Fn)G.setupRenderTarget(t);else if(h.jn)G.rebindTextures(t,k.get(t.texture).Vn,k.get(t.depthTexture).Vn);else if(t.depthBuffer){var o=t.depthTexture;if(h.Xn!==o){if(null!==o&&k.has(o)&&(t.width!==o.image.width||t.height!==o.image.height))throw new Error("WebGLRenderTarget: Attached DepthTexture is initialized to the incorrect size.");G.setupDepthRenderbuffer(t)}}h=t.texture,o=((h.isData3DTexture||h.isDataArrayTexture||h.isCompressedArrayTexture)&&(a=!0),k.get(t).Fn);t.isWebGLCubeRenderTarget?(r=Array.isArray(o[e])?o[e][i]:o[e],n=!0):r=0<t.samples&&!1===G.useMultisampledRTT(t)?k.get(t).kn:Array.isArray(o)?o[i]:o,d.copy(t.viewport),K.copy(t.scissor),J=t.scissorTest}else d.copy(it).multiplyScalar(D).floor(),K.copy(st).multiplyScalar(D).floor(),J=rt;B.bindFramebuffer(U.FRAMEBUFFER,r)&&s&&B.drawBuffers(t,r),B.viewport(d),B.scissor(K),B.setScissorTest(J),n?(h=k.get(t.texture),U.framebufferTexture2D(U.FRAMEBUFFER,U.COLOR_ATTACHMENT0,U.TEXTURE_CUBE_MAP_POSITIVE_X+e,h.Vn,i)):a&&(o=k.get(t.texture),h=e||0,U.framebufferTextureLayer(U.FRAMEBUFFER,U.COLOR_ATTACHMENT0,o.Vn,i||0,h)),N=-1},this.readRenderTargetPixels=function(e,i,s,r,n,a,h){if(e&&e.isWebGLRenderTarget){let t=k.get(e).Fn;if(t=e.isWebGLCubeRenderTarget&&void 0!==h?t[h]:t){B.bindFramebuffer(U.FRAMEBUFFER,t);try{var o=e.texture,l=o.format,u=o.type;F.textureFormatReadable(l)?F.textureTypeReadable(u)?0<=i&&i<=e.width-r&&0<=s&&s<=e.height-n&&U.readPixels(i,s,r,n,y.convert(l),y.convert(u),a):console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type."):console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.")}finally{h=null!==C?k.get(C).Fn:null;B.bindFramebuffer(U.FRAMEBUFFER,h)}}}else console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.")},this.readRenderTargetPixelsAsync=async function(t,e,i,s,r,n,a){if(!t||!t.isWebGLRenderTarget)throw new Error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let h=k.get(t).Fn;if(h=t.isWebGLCubeRenderTarget&&void 0!==a?h[a]:h){var a=t.texture,o=a.format,a=a.type;if(!F.textureFormatReadable(o))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in RGBA or implementation defined format.");if(!F.textureTypeReadable(a))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in UnsignedByteType or implementation defined type.");if(0<=e&&e<=t.width-s&&0<=i&&i<=t.height-r)return B.bindFramebuffer(U.FRAMEBUFFER,h),t=U.createBuffer(),U.bindBuffer(U.PIXEL_PACK_BUFFER,t),U.bufferData(U.PIXEL_PACK_BUFFER,n.byteLength,U.STREAM_READ),U.readPixels(e,i,s,r,y.convert(o),y.convert(a),0),e=null!==C?k.get(C).Fn:null,B.bindFramebuffer(U.FRAMEBUFFER,e),i=U.fenceSync(U.SYNC_GPU_COMMANDS_COMPLETE,0),U.flush(),await yh(U,i,4),U.bindBuffer(U.PIXEL_PACK_BUFFER,t),U.getBufferSubData(U.PIXEL_PACK_BUFFER,0,n),U.deleteBuffer(t),U.deleteSync(i),n;throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: requested read bounds are out of range.")}},this.copyFramebufferToTexture=function(t,e=null,i=0){!0!==t.isTexture&&(Mh("WebGLRenderer: copyFramebufferToTexture function signature has changed."),e=arguments[0]||null,t=arguments[1]);var s=Math.pow(2,-i),r=Math.floor(t.image.width*s),s=Math.floor(t.image.height*s),n=null!==e?e.x:0,e=null!==e?e.y:0;G.setTexture2D(t,0),U.copyTexSubImage2D(U.TEXTURE_2D,i,0,0,n,e,r,s),B.unbindTexture()},this.copyTextureToTexture=function(t,e,i=null,s=null,r=0){!0!==t.isTexture&&(Mh("WebGLRenderer: copyTextureToTexture function signature has changed."),s=arguments[0]||null,t=arguments[1],e=arguments[2],r=arguments[3]||0,i=null);let n,a,h,o,l,u;o=null!==i?(n=i.max.x-i.min.x,a=i.max.y-i.min.y,h=i.min.x,i.min.y):(n=t.image.width,a=t.image.height,h=0),u=null!==s?(l=s.x,s.y):l=0;var i=y.convert(e.format),s=y.convert(e.type),c=(G.setTexture2D(e,0),U.pixelStorei(U.UNPACK_FLIP_Y_WEBGL,e.flipY),U.pixelStorei(U.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha),U.pixelStorei(U.UNPACK_ALIGNMENT,e.unpackAlignment),U.getParameter(U.UNPACK_ROW_LENGTH)),f=U.getParameter(U.UNPACK_IMAGE_HEIGHT),d=U.getParameter(U.UNPACK_SKIP_PIXELS),v=U.getParameter(U.UNPACK_SKIP_ROWS),p=U.getParameter(U.UNPACK_SKIP_IMAGES),m=t.isCompressedTexture?t.mipmaps[r]:t.image;U.pixelStorei(U.UNPACK_ROW_LENGTH,m.width),U.pixelStorei(U.UNPACK_IMAGE_HEIGHT,m.height),U.pixelStorei(U.UNPACK_SKIP_PIXELS,h),U.pixelStorei(U.UNPACK_SKIP_ROWS,o),t.isDataTexture?U.texSubImage2D(U.TEXTURE_2D,r,l,u,n,a,i,s,m.data):t.isCompressedTexture?U.compressedTexSubImage2D(U.TEXTURE_2D,r,l,u,m.width,m.height,i,m.data):U.texSubImage2D(U.TEXTURE_2D,r,l,u,n,a,i,s,m),U.pixelStorei(U.UNPACK_ROW_LENGTH,c),U.pixelStorei(U.UNPACK_IMAGE_HEIGHT,f),U.pixelStorei(U.UNPACK_SKIP_PIXELS,d),U.pixelStorei(U.UNPACK_SKIP_ROWS,v),U.pixelStorei(U.UNPACK_SKIP_IMAGES,p),0===r&&e.generateMipmaps&&U.generateMipmap(U.TEXTURE_2D),B.unbindTexture()},this.copyTextureToTexture3D=function(t,e,i=null,s=null,r=0){!0!==t.isTexture&&(Mh("WebGLRenderer: copyTextureToTexture3D function signature has changed."),i=arguments[0]||null,s=arguments[1]||null,t=arguments[2],e=arguments[3],r=arguments[4]||0);let n,a,h,o,l,u,c,f,d;var v=t.isCompressedTexture?t.mipmaps[r]:t.image,i=(u=null!==i?(n=i.max.x-i.min.x,a=i.max.y-i.min.y,h=i.max.z-i.min.z,o=i.min.x,l=i.min.y,i.min.z):(n=v.width,a=v.height,h=v.depth,o=0,l=0),d=null!==s?(c=s.x,f=s.y,s.z):(c=0,f=0),y.convert(e.format)),s=y.convert(e.type);let p;if(e.isData3DTexture)G.setTexture3D(e,0),p=U.TEXTURE_3D;else{if(!e.isDataArrayTexture&&!e.isCompressedArrayTexture)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: only supports THREE.DataTexture3D and THREE.DataTexture2DArray.");G.setTexture2DArray(e,0),p=U.TEXTURE_2D_ARRAY}U.pixelStorei(U.UNPACK_FLIP_Y_WEBGL,e.flipY),U.pixelStorei(U.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha),U.pixelStorei(U.UNPACK_ALIGNMENT,e.unpackAlignment);var m=U.getParameter(U.UNPACK_ROW_LENGTH),g=U.getParameter(U.UNPACK_IMAGE_HEIGHT),_=U.getParameter(U.UNPACK_SKIP_PIXELS),w=U.getParameter(U.UNPACK_SKIP_ROWS),M=U.getParameter(U.UNPACK_SKIP_IMAGES);U.pixelStorei(U.UNPACK_ROW_LENGTH,v.width),U.pixelStorei(U.UNPACK_IMAGE_HEIGHT,v.height),U.pixelStorei(U.UNPACK_SKIP_PIXELS,o),U.pixelStorei(U.UNPACK_SKIP_ROWS,l),U.pixelStorei(U.UNPACK_SKIP_IMAGES,u),t.isDataTexture||t.isData3DTexture?U.texSubImage3D(p,r,c,f,d,n,a,h,i,s,v.data):e.isCompressedArrayTexture?U.compressedTexSubImage3D(p,r,c,f,d,n,a,h,i,v.data):U.texSubImage3D(p,r,c,f,d,n,a,h,i,s,v),U.pixelStorei(U.UNPACK_ROW_LENGTH,m),U.pixelStorei(U.UNPACK_IMAGE_HEIGHT,g),U.pixelStorei(U.UNPACK_SKIP_PIXELS,_),U.pixelStorei(U.UNPACK_SKIP_ROWS,w),U.pixelStorei(U.UNPACK_SKIP_IMAGES,M),0===r&&e.generateMipmaps&&U.generateMipmap(p),B.unbindTexture()},this.initRenderTarget=function(t){void 0===k.get(t).Fn&&G.setupRenderTarget(t)},this.initTexture=function(t){t.isCubeTexture?G.setTextureCube(t,0):t.isData3DTexture?G.setTexture3D(t,0):t.isDataArrayTexture||t.isCompressedArrayTexture?G.setTexture2DArray(t,0):G.setTexture2D(t,0),B.unbindTexture()},this.resetState=function(){Z=0,q=0,C=null,B.reset(),M.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return Xi}get outputColorSpace(){return this.ra}set outputColorSpace(t){this.ra=t;var e=this.getContext();e.drawingBufferColorSpace=t===Ai?"display-p3":"srgb",e.unpackColorSpace=zt.workingColorSpace===Ti?"display-p3":"srgb"}}let H0={};H0.vert=`
                      
                        uniform vec2 offset;
                        uniform float rotation;
                        uniform vec2 scale;
                        varying vec2 vUv;
                        void main() {
                          vUv = uv;
                  
                          
                          vec2 rotatedPosition;
                            rotatedPosition.x = cos( rotation ) * position.x - sin( rotation ) * position.y;
                            rotatedPosition.y = sin( rotation ) * position.x + cos( rotation ) * position.y;
                      
        
                            rotatedPosition.x *= scale.x * abs(projectionMatrix[0][0] / projectionMatrix[1][1]);
                            rotatedPosition.y *= scale.y;
                          
                          rotatedPosition.xy += offset;
                          gl_Position = vec4(rotatedPosition,0.0,1.0);
                        }
                        `,H0.frag=`
                    uniform vec3 diffuse;
                    uniform sampler2D mmap;
                    #include <common>
                    varying vec2 vUv;
               
                    void main() {
                
                        // vec2 muv = vec2(vUv.x , 1.0 - vUv.y);
                        vec4 diffuseColor = texture2D( mmap, vUv );
                       
                        
                        gl_FragColor = diffuseColor;
                    }
                    `;class V0 extends zh{constructor(t){super(t),this.uniforms.offset={value:new ct},this.uniforms.rotation={value:0},this.uniforms.scale={value:new ct(1,1)},this.depthTest=!1,this.vertexShader=H0.vert,this.fragmentShader=H0.frag}}class z0{constructor(t,e){this.isInterleavedBuffer=!0,this.array=t,this.stride=e,this.count=void 0!==t?t.length/e:0,this.usage=Wi,this.updateRanges=[],this.version=0,this.uuid=$i()}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}setUsage(t){return this.usage=t,this}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}copy(t){return this.array=new t.array.constructor(t.array),this.count=t.count,this.stride=t.stride,this.usage=t.usage,this}copyAt(i,s,r){i*=this.stride,r*=s.stride;for(let t=0,e=this.stride;t<e;t++)this.array[i+t]=s.array[r+t];return this}set(t,e=0){return this.array.set(t,e),this}clone(t){void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer.j&&(this.array.buffer.j=$i()),void 0===t.arrayBuffers[this.array.buffer.j]&&(t.arrayBuffers[this.array.buffer.j]=this.array.slice(0).buffer);t=new this.array.constructor(t.arrayBuffers[this.array.buffer.j]),t=new this.constructor(t,this.stride);return t.setUsage(this.usage),t}onUpload(t){return this.onUploadCallback=t,this}toJSON(t){return void 0===t.arrayBuffers&&(t.arrayBuffers={}),void 0===this.array.buffer.j&&(this.array.buffer.j=$i()),void 0===t.arrayBuffers[this.array.buffer.j]&&(t.arrayBuffers[this.array.buffer.j]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer.j,type:this.array.constructor.name,stride:this.stride}}}let W0=new Gt;class j0{constructor(t,e,i,s=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=t,this.itemSize=e,this.offset=i,this.normalized=s}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(t){this.data.needsUpdate=t}applyMatrix4(i){for(let t=0,e=this.data.count;t<e;t++)W0.fromBufferAttribute(this,t),W0.applyMatrix4(i),this.setXYZ(t,W0.x,W0.y,W0.z);return this}applyNormalMatrix(i){for(let t=0,e=this.count;t<e;t++)W0.fromBufferAttribute(this,t),W0.applyNormalMatrix(i),this.setXYZ(t,W0.x,W0.y,W0.z);return this}transformDirection(i){for(let t=0,e=this.count;t<e;t++)W0.fromBufferAttribute(this,t),W0.transformDirection(i),this.setXYZ(t,W0.x,W0.y,W0.z);return this}getComponent(t,e){let i=this.array[t*this.data.stride+this.offset+e];return i=this.normalized?_s(i,this.array):i}setComponent(t,e,i){return this.normalized&&(i=n(i,this.array)),this.data.array[t*this.data.stride+this.offset+e]=i,this}setX(t,e){return this.normalized&&(e=n(e,this.array)),this.data.array[t*this.data.stride+this.offset]=e,this}setY(t,e){return this.normalized&&(e=n(e,this.array)),this.data.array[t*this.data.stride+this.offset+1]=e,this}setZ(t,e){return this.normalized&&(e=n(e,this.array)),this.data.array[t*this.data.stride+this.offset+2]=e,this}setW(t,e){return this.normalized&&(e=n(e,this.array)),this.data.array[t*this.data.stride+this.offset+3]=e,this}getX(t){let e=this.data.array[t*this.data.stride+this.offset];return e=this.normalized?_s(e,this.array):e}getY(t){let e=this.data.array[t*this.data.stride+this.offset+1];return e=this.normalized?_s(e,this.array):e}getZ(t){let e=this.data.array[t*this.data.stride+this.offset+2];return e=this.normalized?_s(e,this.array):e}getW(t){let e=this.data.array[t*this.data.stride+this.offset+3];return e=this.normalized?_s(e,this.array):e}setXY(t,e,i){return t=t*this.data.stride+this.offset,this.normalized&&(e=n(e,this.array),i=n(i,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=i,this}setXYZ(t,e,i,s){return t=t*this.data.stride+this.offset,this.normalized&&(e=n(e,this.array),i=n(i,this.array),s=n(s,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=s,this}setXYZW(t,e,i,s,r){return t=t*this.data.stride+this.offset,this.normalized&&(e=n(e,this.array),i=n(i,this.array),s=n(s,this.array),r=n(r,this.array)),this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=s,this.data.array[t+3]=r,this}clone(t){if(void 0!==t)return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.clone(t)),new j0(t.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized);var e=[];for(let t=0;t<this.count;t++){var i=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[i+t])}return new N(new this.array.constructor(e),this.itemSize,this.normalized)}toJSON(t){if(void 0!==t)return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.toJSON(t)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized};var e=[];for(let t=0;t<this.count;t++){var i=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[i+t])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}}class X0 extends Nh{constructor(){super();var t=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),t=new z0(t,5);this.setIndex([0,1,2,0,2,3]),this.setAttribute("position",new j0(t,3,0,!1)),this.setAttribute("uv",new j0(t,2,3,!1))}}class Y0 extends c{constructor(t,e,i,s,r,n,a,h,o){super(t,e,i,s,r,n,a,h,o),this.isCanvasTexture=!0,this.needsUpdate=!0}}function Z0(t,e,i,s,r,n){var a=(t+i)/2,h=(e+s)/2,o=((t-i)*(t-i)+(e-s)*(e-s))/4,l=Math.sqrt(o),l=l*(l/Math.sqrt(r*r-o)),r=Math.PI/2,o=(i-t)/(e-s),u=(t-i)/(e-s),c=Math.sqrt(1+o*o),f=Math.sqrt(1+u*u),o={x:a+l*(1/c),y:h+l*(o/c),theta:r},c={x:a+l*(-1/f),y:h+l*(u/f),theta:r};return 0<(i-t)*(o.y-e)-(s-e)*(o.x-t)?0===n?o:c:0===n?c:o}function q0(e,i,s,r){for(let t=0;t<e.length;t++)switch(e[t]){case"m":i.moveTo(r.x+parseFloat(e[t+1]),r.y+parseFloat(e[t+2])),s.x=r.x+parseFloat(e[t+1]),s.y=r.y+parseFloat(e[t+2]),r.x=s.x,r.y=s.y,t+=2;break;case"M":i.moveTo(parseFloat(e[t+1]),parseFloat(e[t+2])),s.x=parseFloat(e[t+1]),s.y=parseFloat(e[t+2]),r.x=s.x,r.y=s.y,t+=2;break;case"l":i.lineTo(s.x+parseFloat(e[t+1]),s.y+parseFloat(e[t+2])),s.x=s.x+parseFloat(e[t+1]),s.y=s.y+parseFloat(e[t+2]),t+=2;break;case"L":i.lineTo(parseFloat(e[t+1]),parseFloat(e[t+2])),s.x=parseFloat(e[t+1]),s.y=parseFloat(e[t+2]),t+=2;break;case"A":var n=parseFloat(e[t+1]),a=parseFloat(e[t+2]),h=(parseFloat(e[t+3]),Math.PI,parseFloat(e[t+4]),parseFloat(e[t+5])),o=s.x,l=s.y,u=parseFloat(e[t+6]),c=parseFloat(e[t+7]);n===a&&(f=Z0(o,l,u,c,n,h),i.arcTo(f.x,f.y,u,c,f.theta),s.x=u,s.y=c),t+=7;break;case"a":var f,n=parseFloat(e[t+1]),a=parseFloat(e[t+2]),h=(parseFloat(e[t+3]),Math.PI,parseFloat(e[t+4]),parseFloat(e[t+5])),o=s.x,l=s.y,u=o+parseFloat(e[t+6]),c=l+parseFloat(e[t+7]);n===a&&(f=Z0(o,l,u,c,n,h),i.arcTo(f.x,f.y,u,c,f.theta),s.x=u,s.y=c),t+=7;break;case"h":i.lineTo(s.x+parseFloat(e[t+1]),s.y),s.x=s.x+parseFloat(e[t+1]),t+=1;break;case"H":i.lineTo(parseFloat(e[t+1]),s.y),s.x=parseFloat(e[t+1]),t+=1;break;case"z":case"Z":i.lineTo(r.x,r.y)}}let K0=["M","0","15.07","L","0.69","1.92","A","2","2","0","0","1","2.66","0","L","11.8","0","l","-0.07","1.37","H","3.09","A","1.09","1.09","0","0","0","2","2.44","l","-0.2","4.44","h","9.37","l","-0.07","1.37","H","1.72","l","-0.36","6.82","Z"],J0=["M","13.79","11","l","-0.08","1.63","a","1","1","0","0","0","1","1.08","h","8.53","l","-0.07","1.36","h","-9","A","1.84","1.84","0","0","1","12.31","13","l","0.48","-9.16","h","8.9","a","2","2","0","0","1","2","2","L","23.53","9","A","2.11","2.11","0","0","1","21.47","11","Z","m","8.4","-2.49","l","0.08","-2.16","a","1.07","1.07","0","0","0","-1.09","-1.09","H","14.09","l","-0.22","4.33","H","21","A","1.15","1.15","0","0","0","22.19","8.51","Z"],$0=["M","33.94","3.86","a","1.93","1.93","0","0","1","2","1.95","l","-0.47","9.27","H","34.07","l","0.45","-8.72","a","1.09","1.09","0","0","0","-1.09","-1.1","H","26.3","l","-0.51","9.82","H","24.41","L","25","3.85","Z"],Q0=["M","36.48","17.72","H","45","a","1.16","1.16","0","0","0","1.16","-1.22","l","0.07","-1.43","H","38.72","a","2","2","0","0","1","-2","-2.06","l","0.37","-7.19","a","2","2","0","0","1","2.15","-2","H","48.2","l","-0.69","13.28","a","2.09","2.09","0","0","1","-2.06","2","h","-9","Z","m","9.85","-4.05","l","0.44","-8.45","H","39.53","a","1.07","1.07","0","0","0","-1.08","1.1","l","-0.32","6.27","a","1.16","1.16","0","0","0","1.1","1.1","Z"],tv=["M","57.43","11.59","L","63.48","0","h","1.83","l","-0.79","15.05","H","63.15","l","0.67","-12.79","L","57.67","14","h","-0.75","L","52.07","2.34","l","-0.64","12.72","H","50","L","50.83","0","H","52.6","Z"],ev=["M","69.6","10.2","l","-2.37","4.87","h","-1.5","L","73.09","0","h","1.49","l","5.77","15.05","h","-1.5","L","77","10.2","Z","m","6.86","-1.39","L","73.74","1.73","L","70.28","8.81","Z"],iv=["M","82.95","15.07","H","81.57","L","82.35","0","h","10","a","1.94","1.94","0","0","1","1.85","2","L","93.89","7.4","a","2","2","0","0","1","-2","1.92","H","83.25","Z","m","8.43","-7.15","a","1.13","1.13","0","0","0","1.09","-1.09","l","0.35","-4.37","a","1.1","1.1","0","0","0","-1.08","-1.06","H","83.66","l","-0.34","6.53","Z"];function sv(){var t=nt.document.createElement("canvas"),e=t.getContext("2d"),i=(t.width=500,t.height=120,t.style.width="500px",t.style.height="120px",{x:0,y:0}),s={x:0,y:0},r=(e.transform(5,0,0,5,10,10),e.createLinearGradient(5.9,15.07,5.9,0)),r=(r.addColorStop(0,"#232323"),r.addColorStop(1,"#585858"),e.fillStyle=r,e.beginPath(),q0(K0,e,s,i),e.closePath(),e.fill(),e.beginPath(),q0(J0,e,s,i),e.closePath(),e.fill(),e.beginPath(),q0($0,e,s,i),e.closePath(),e.fill(),e.beginPath(),q0(Q0,e,s,i),e.closePath(),e.fill(),e.createLinearGradient(57.68,15.07,57.68,0));r.addColorStop(0,"#77bf00"),r.addColorStop(1,"#addc0c"),e.fillStyle=r,e.beginPath(),q0(tv,e,s,i),e.closePath(),e.fill(),e.beginPath(),q0(ev,e,s,i),e.closePath(),e.fill(),e.beginPath(),q0(iv,e,s,i),e.closePath(),e.fill();let n;return nt.environment==I.BROWSER?n=new Y0(t):(r=t.toDataURL("image/png"),e.restore(),n=new c,nt.textureHelper.createImage({url:r,onload:t=>{n.image=t,n.needsUpdate=!0}})),n}let rv={aa:!0},nv=t=>{var e=sv(),i=new ct(.4,.096),s=new V0,t=-1*(.5*i.x/t-1),r=-1*(1-.5*i.y);return e.minFilter=V,e.generateMipmaps=!1,s.transparent=!0,s.depthTest=!1,s.uniforms={scale:{value:i},offset:{value:new ct(t,r)},mmap:{value:e}},s.needsUpdate=!0,new L(new X0,s)};class av{constructor(t,e,i){this.ha=0,this.Ns=0,this.st=t,this.Ls=e,this.nt=i,this.renderer=this.oa(e.container,e.logarithmicDepthBuffer,e.preserveDrawingBuffer),this.rn=new Map;i=this.st.getMapOptions().depthPeeling;i&&nt.environment===I.BROWSER&&(this.la=new nt.DepthPeelingRenderer({map:t,renderManager:this,mode:i.mode,layers:i.layers,type:i.types})),this.ua=JSON.parse(JSON.stringify(e.renderOrder)),this.ca=0,this.fa=!1,this.da=null,this.va=rv.aa,this.va&&(this.da=nv(this.renderer.domElement.clientWidth/this.renderer.domElement.clientHeight),this.da.frustumCulled=!1,this.xx45f6=this.da),this.pa=!1,this.ma=!1,this._=this.renderer.domElement.clientWidth,this.ga=this.renderer.domElement.clientHeight,this.type="basic",this._a=null,this.k=!0,this.an=void 0,this.wa=void 0,this.nn=[],this.Ma()}getRenderer(){return this.la||this.renderer}setTileLayScene(t){this.an=t}getTileLayScene(){return this.an}setGroundLayerScene(t){this.wa=t}getGroundLayerScene(){return this.wa}set3DTilesLayerSceneArr(t){this.nn.push(t)}get3DTilesLayerSceneArr(){return this.nn}get needLogo(){return this.va}render(){let n=this;if(this.renderer&&(this.ha+=1,15e6<this.ha&&(this.ha=0),nt.environment!==I.WX||1!=this.Ns||this.ha%2!=0)){this.Ls.interaction.zoomCenterType==Ca.CENTER&&(this.st.bi.Is.re(),this.st.bi.Is.ne(this.rn),this.st.bi.Is.ne([this.an,this.wa,...this.nn])),this.renderer.clear(),this.an&&this.renderer.render(this.an,this.st.ct),this.wa&&this.renderer.render(this.wa,this.st.ct);for(let t=0;t<this.nn.length;t++)this.renderer.render(this.nn[t],this.st.ct);this.st.getMapOptions().depthPeeling?this.la.render():this.rn.forEach(t=>this.renderer.render(t,this.st.ct));let r={min:1/0,max:-1/0},s=(this.st.ya.Ft.forEach(e=>{let s=[];e.Ea.forEach(t=>{let e=t.buildingID;var i;e=e||this.st.getMapOptions().mapID,t.isCross&&(e=>{let i=!1,s=Array.from(n.getRenderList());for(let t=0;t<s.length;t++)if(s[t][0].split("%A%B%C%D")[0]===e){i=!0;break}return i})(e)&&(s.push(t),i=Math.min(t.levelRange[0],t.levelRange[1]),r.min>i&&(r.min=i),i=Math.max(t.levelRange[0],t.levelRange[1]),r.max<i)&&(r.max=i)}),s.forEach(t=>{t.line&&i(t.buildingID,t.levelRange[0])&&i(t.buildingID,t.levelRange[1])&&e.visible&&(t.line.visible=!0,this.renderer.render(t.line,this.st.ct),t.line.visible=!1)})}),this.ua.indexOf(p.LINE_MARKER));function i(t,i){t=t||n.st.getMapOptions().mapID;var s=n.st.getBuilding(t).visibleLevels;if(1!==s.length){let e=!1;for(let t=0;t<s.length;t++)if(""+s[t]==""+i){e=!0;break}return e}}this.rn.forEach((t,e)=>{var e=e.split("%A%B%C%D"),i=e[1],e=e[2];+i===r.max&&this.ua.indexOf(p.LAYER_NODE_TYPE.get(+e))>s&&this.renderer.render(t,this.st.ct)}),this.st.ya&&this.renderer.render(this.st.ya.xa,this.st.ct),this.va&&this.da&&this.renderer.render(this.da,this.st.ct)}}resize(){this.renderer&&(5<Math.abs(this.renderer.domElement.parentElement.clientHeight-this.ga)||5<Math.abs(this.renderer.domElement.parentElement.clientWidth-this._))&&(this.ba(this.renderer.domElement.parentElement.clientWidth,this.renderer.domElement.parentElement.clientHeight),this._=this.renderer.domElement.clientWidth,this.ga=this.renderer.domElement.clientHeight,this.st.Yt.Xt({type:"resize"}))}getRenderList(){return this.rn}get parent(){return this.st}getWebGLRenderer(){return G0}}Object.assign(av.prototype,{Sa(){for(var t in this.st=null,this.Ls=null,this.nt=null,this)this[""+t]=null,delete this[""+t]},Qt(){this.k=!1,this.rn.clear(),nt.window.cancelAnimationFrame(this.Aa)},oa(t,e,i){var s=this.st.getMapOptions().depthPeeling,r=nt.environment==I.BROWSER?void 0:t,s=new G0({useWebGL2:s,antialias:!0,alpha:!0,stencil:!0,logarithmicDepthBuffer:e,preserveDrawingBuffer:i,canvas:r});return s.toneMapping=x,s.outputColorSpace=Hr,s.setPixelRatio(nt.window.devicePixelRatio),nt.environment===I.BROWSER&&s.setSize(t.clientWidth,t.clientHeight),s.autoClear=!1,s.domElement.style.position="absolute",s.domElement.style.top=0,s.domElement.style.zIndex=0,s.setClearAlpha(0),nt.environment==I.BROWSER&&t.appendChild(s.domElement),s},Ta(t){this.renderer=t},Ra(t){t="3D"===t?this.st.Ps:this.st.Lt;return t.updateMatrixWorld(!0),(new Lr).setFromProjectionMatrix((new Ht).multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse))},La(e){var i=[],s=[];for(let t=0;t<e.length;t++){var r=this.ua.indexOf(e[t]);-1!==r&&(i.push(r),s.push(e[t]))}i.sort((t,e)=>t-e);for(let t=0;t<i.length;t++)this.ua[i[t]]=s[t];this.Vt()},Ca(t){this.ua=t,this.Vt()},Na(t,e){let i,s=1;var r=this.renderer.domElement.clientHeight;i=this.st.ct.isPerspectiveCamera?e?e/(r/(2*Math.tan(this.st.Ps.fov*u.DEG2RAD/2))):t.mapNode.Ia/(r/(2*Math.tan(this.st.Ps.fov*u.DEG2RAD/2))):e?e*Math.abs(this.st.ct.top-this.st.ct.bottom)/this.st.ct.zoom/r:t.mapNode.Ia*Math.abs(this.st.ct.top-this.st.ct.bottom)/this.st.ct.zoom/r,t.material.userData.scaleRatio&&(s=t.material.userData.scaleRatio),t.scale.set(i,i/s,i)},xt(){this.rn.forEach(e=>{switch(e.userData.type){case"label":for(let t=0;t<e.children.length;t++)e.children[t].mapNode.Pa(this.st.Wt);break;case"facility":for(let t=0;t<e.children.length;t++)this.Na(e.children[t]);break;default:for(let t=0;t<e.children.length;t++)!e.children[t].mapNode||e.children[t].mapNode.type!==p.IMAGE_MARKER&&e.children[t].mapNode.type!==p.LOCATION_MARKER||e.children[t].mapNode.Da()}})},ba(t,e){var i=this.st.Ps,s=this.st.Lt,r=new ct(.4,.096),n=-1*(.5*r.x/(t/e)-1),a=-1*(1-.5*r.y);for(i.aspect=t/e,i.updateProjectionMatrix(),s.left=-t/2,s.right=t/2,s.top=e/2,s.bottom=-e/2,s.updateProjectionMatrix(),this.da&&(this.da.material.uniforms.scale={value:r},this.da.material.uniforms.offset={value:new ct(n,a)}),this.renderer.setSize(t,e),this.xt(),this.st.enableUpdateRender(),this.st.enableUpdateNode(),this.st.Wt.Oa();0<this.st.Wt.Ua.length;)this.st.Wt.Fa()},Ba(t,e){let i;var s;i=t.ndcPos||(nt.environment===I.BROWSER&&(t.updateMatrixWorld(!0),t.parent.updateMatrixWorld(!0)),s=this.st.ct,(new Gt).setFromMatrixPosition(t.matrixWorld).applyMatrix4(s.matrixWorldInverse).applyMatrix4(s.projectionMatrix));let r=t.mapNode.Ia,n;if(e){if("string"==typeof t.mapNode.text){if(!t.material.map.image)return;n=t.mapNode.type===p.LABEL?(r=t.material.map.image.height/2/1.2,t.material.map.image.width/2/1.2):(t.material.userData.media||(s=t.mapNode.text.split("%rn%").length,r*=s),r/t.material.userData.scaleRatio)}else n=(t.material.userData.media||(e=t.mapNode.text.length,r*=e),r/t.material.userData.scaleRatio);void 0!==t.material.userData.style&&(s=t.material.userData.style,e=r*t.material.userData.itHeightRatio*1.1,"limage-rtext"===s||"ltext-rimage"===s?r<e&&(r=e,n=r/t.material.userData.scaleRatio):"timage-btext"===s||"ttext-bimage"===s?(r+=e,n=r/t.material.userData.scaleRatio):"overlay-text"===s&&r<e&&(r=e,n=r/t.material.userData.scaleRatio))}else r=(n=r)/t.material.userData.scaleRatio;return r=r/this.renderer.domElement.clientHeight*2,n=n/this.renderer.domElement.clientWidth*2,{leftTop:new ct(i.x-n/2,i.y+r/2),rightDown:new ct(i.x+n/2,i.y-r/2)}},ka(u,c=!0){return new Promise((n,t)=>{if(0===u.length)n();else{var e=[],i=new Gt;let r=[];for(let t=0;t<u.length;t++){var s=u[t].children[0]||u[t];"Sprite"===s.type&&(c&&(s.updateMatrixWorld(!0),s.parent.updateMatrixWorld(!0)),s.getWorldPosition(i),e.push(i.x,i.y,i.z),r.push(s))}var a=new ArrayBuffer(8*e.length);let t=new Float64Array(a);t.set(e);var h=this.st.ct,o=new ArrayBuffer(128),l=((t=new Float64Array(o)).set(h.matrixWorldInverse.elements),new ArrayBuffer(128));(t=new Float64Array(l)).set(h.projectionMatrix.elements),this.st.Wt.Ha.Ga({type:p.LABEL,spritePositions:a,matrixWorldInverse:o,projectionMatrix:l}).then(t=>{var e=t.result.ndcPositions;let i=0;for(let t=0;t<e.length;t+=2){var s=r[i];s&&(s.ndcPos={x:e[t],y:e[t+1]}),i+=1}n()})}})},Va(t,e){t.mapNode.za?(t.mapNode.collisitionVisible=e,t.visible=t.mapNode.collisitionVisible):t.visible=e},Wa(i,s,e,r,n){for(let t=0;t<s.length;t++){var a=s[t].mapNode.ja;if(!s[t].mapNode.Qs||s[t].mapNode.sn)a?s[t].mapNode.collisionTargetShow=!1:s[t].visible=!1;else if(s[t].mapNode.qs&&(s[t].mapNode.qs.maxlevel<=r||s[t].mapNode.qs.minlevel>r))a?s[t].mapNode.collisionTargetShow=!1:s[t].visible=!1;else if(!1===n)a?s[t].mapNode.collisionTargetShow=!0:this.Va(s[t],!0);else if(!1===s[t].mapNode.Xa)a?s[t].mapNode.collisionTargetShow=!0:this.Va(s[t],!0);else{var h=s[t].children[0]||s[t];if("Sprite"===h.type&&h.material.map){var o=this.Ba(h,e);if(o){s[t].userData.bounds=o;let e=!0;for(let t=0;t<i.length;t++){var l=i[t].userData.bounds;if(!(e=!G.Me(o.leftTop,o.rightDown,l.leftTop,l.rightDown)))break}e?(a?s[t].mapNode.collisionTargetShow=!0:this.Va(s[t],!0),i.push(s[t])):a?s[t].mapNode.collisionTargetShow=!1:this.Va(s[t],!1)}}}}for(let t=0;t<s.length;t++)s[t].mapNode.ja&&s[t].mapNode.Ya()},Za(){!0!==this.nt.qa&&!0!==this.nt.Ka||(this.ma=!0)},Vt(){this.pa=!0},ht(t){this.rn.delete(t)},Ja(){this.rn.clear()},$a(){if(this.pa){this.rn.clear();let s=[];this.st.traverse(e=>{if(this.st.Wt.Qa(e))for(let t=0;t<e.visibleLevels.length;t++){var i=e.getFloor(e.visibleLevels[t]);i&&s.push(i)}}),s.sort((t,e)=>t.height<e.height?-1:t.height>e.height?1:t.parent===this.st.jt?-1:e.parent===this.st.jt?1:0),s.forEach(t=>{let e=[];t.traverse(t=>{e.unshift(t)}),e.sort((t,e)=>{let i=this.ua.indexOf(p.LAYER_NODE_TYPE.get(t.Ai)),s=this.ua.indexOf(p.LAYER_NODE_TYPE.get(e.Ai));t=this.ua.length-1;return-1===i&&(i=t),-1===s&&(s=t),i-s}),e.forEach((t,e,i)=>{var s=t.parent,s=s.parent.Ht+"%A%B%C%D"+s.level+"%A%B%C%D"+t.Ai;this.rn.set(s,t.scene)})}),this.pa=!1,this.xt(),this.Za()}},V(){this.rn&&0<this.rn.size&&!this.fa&&(this.st.Yt.Xt({type:"firstRender"}),this.fa=!0)},Ma(t){this.st&&this.k&&(null==this._a&&(this._a=t),this.k&&(this.Aa=nt.window.requestAnimationFrame(this.Ma.bind(this))),this.st.Yt.Xt({type:"beforeRender"}),this.resize(),t={type:"update",renderType:this.nt.th?0:1},this.nt.th&&(this.st.bi.yt.zoomCenterType===Ca.MOUSE&&this.st.bi.yt.update(),this.render(),this.V(),this.nt.th=!1),this.st.Yt.Xt(t))}});let hv=null;class ov{constructor(){}static global(){if("undefined"!=typeof self&&null!==self&&0!==Object.keys(self).length)return self;if("undefined"!=typeof window&&null!==window&&0!==Object.keys(window).length)return window;if("undefined"!=typeof global&&null!==global&&0!==Object.keys(global).length)return global;var t;if("undefined"!=typeof my)return hv||(t=my.getAppIdSync(),hv={location:{host:t.appId+".hybrid.alipay-eco.com"}}),hv;if(nt.environment==I.WX)return{};throw new Error("unable to locate global object")}}class lv{constructor(t){this.eh={data:null,method:"GET",responseType:"json",...t},this.ih=null}}Object.assign(lv.prototype,{sh(t,e,i){var{data:s,method:r,url:n,responseType:a,header:h}=this.eh;let o=null;if((o=new(nt.environment===I.WX?nt.XMLHttpRequest:"undefined"!=typeof XMLHttpRequest?XMLHttpRequest:ov.global().fengmap.XMLHttpRequest)).responseType=a,o.open(r,n),"object"==typeof h)for(var l in h)o.setRequestHeader(l,h[l]);o.addEventListener("load",()=>{200===o.status||0===o.status||201===o.status?t&&t(o.response):e&&(404===o.status?e(Nr.PATH_ERROR):2069===o.response.error_code?e(Nr.NAME_KEY_ERROR):2063===o.response.error_code?e(Nr.MAP_ID_URL_ERROR):400===o.response.error_code?e(Nr.THEME_ID_URL_ERROR):e(o.response))}),o.addEventListener("timeout",t=>{i&&i(t)}),o.addEventListener("error",t=>{e&&e(t)}),o.send(JSON.stringify(s)),this.ih=o},Qt(){this.ih&&this.ih.abort&&(this.ih.abort(),this.ih=null)}});var uv={exports:{}},cv={},fv={},dv,vv;function pv(){return vv||(vv=1,dv=function(t,e){var i=new Array(arguments.length-1),n=0,s=2,a=!0;for(;s<arguments.length;)i[n++]=arguments[s++];return new Promise(function(s,r){i[n]=function(t){if(a)if(a=!1,t)r(t);else{for(var e=new Array(arguments.length-1),i=0;i<e.length;)e[i++]=arguments[i];s.apply(null,e)}};try{t.apply(e||null,i)}catch(t){a&&(a=!1,r(t))}})}),dv}var mv={},gv,_v,wv,Mv,yv,Ev,xv;function bv(){if(!gv){gv=1;for(var t=mv,l=(t.length=function(t){var e=t.length;if(!e)return 0;for(var i=0;1<--e%4&&"="===t.charAt(e);)++i;return Math.ceil(3*t.length)/4-i},new Array(64)),o=new Array(123),e=0;e<64;)o[l[e]=e<26?e+65:e<52?e+71:e<62?e-4:e-59|43]=e++;t.encode=function(t,e,i){for(var s,r=null,n=[],a=0,h=0;e<i;){var o=t[e++];switch(h){case 0:n[a++]=l[o>>2],s=(3&o)<<4,h=1;break;case 1:n[a++]=l[s|o>>4],s=(15&o)<<2,h=2;break;case 2:n[a++]=l[s|o>>6],n[a++]=l[63&o],h=0}8191<a&&((r=r||[]).push(String.fromCharCode.apply(String,n)),a=0)}return h&&(n[a++]=l[s],n[a++]=61,1===h)&&(n[a++]=61),r?(a&&r.push(String.fromCharCode.apply(String,n.slice(0,a))),r.join("")):String.fromCharCode.apply(String,n.slice(0,a))};var u="invalid encoding";t.decode=function(t,e,i){for(var s,r=i,n=0,a=0;a<t.length;){var h=t.charCodeAt(a++);if(61===h&&1<n)break;if(void 0===(h=o[h]))throw Error(u);switch(n){case 0:s=h,n=1;break;case 1:e[i++]=s<<2|(48&h)>>4,s=h,n=2;break;case 2:e[i++]=(15&s)<<4|(60&h)>>2,s=h,n=3;break;case 3:e[i++]=(3&s)<<6|h,n=0}}if(1===n)throw Error(u);return i-r},t.test=function(t){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(t)}}return mv}function Sv(){return wv||(wv=1,(_v=t).prototype.on=function(t,e,i){return(this.T[t]||(this.T[t]=[])).push({fn:e,ctx:i||this}),this},t.prototype.off=function(t,e){if(void 0===t)this.T={};else if(void 0===e)this.T[t]=[];else for(var i=this.T[t],s=0;s<i.length;)i[s].fn===e?i.splice(s,1):++s;return this},t.prototype.emit=function(t){var e=this.T[t];if(e){for(var i=[],s=1;s<arguments.length;)i.push(arguments[s++]);for(s=0;s<e.length;)e[s].fn.apply(e[s++].ctx,i)}return this}),_v;function t(){this.T={}}}function Av(){return yv||(yv=1,Mv=t(t)),Mv;function t(t){function e(t,e,i,s){var r=e<0?1:0;0===(e=r?-e:e)?t(0<1/e?0:2147483648,i,s):isNaN(e)?t(2143289344,i,s):t(34028234663852886e22<e?(r<<31|2139095040)>>>0:e<11754943508222875e-54?(r<<31|Math.round(e/1401298464324817e-60))>>>0:(r<<31|(t=Math.floor(Math.log(e)/Math.LN2))+127<<23|8388607&Math.round(e*Math.pow(2,-t)*8388608))>>>0,i,s)}function i(t,e,i){t=t(e,i),e=2*(t>>31)+1,i=t>>>23&255,t&=8388607;return 255==i?t?NaN:1/0*e:0==i?1401298464324817e-60*e*t:e*Math.pow(2,i-150)*(8388608+t)}function s(t,e,i){h[0]=t,e[i]=o[0],e[i+1]=o[1],e[i+2]=o[2],e[i+3]=o[3]}function r(t,e,i){h[0]=t,e[i]=o[3],e[i+1]=o[2],e[i+2]=o[1],e[i+3]=o[0]}function n(t,e){return o[0]=t[e],o[1]=t[e+1],o[2]=t[e+2],o[3]=t[e+3],h[0]}function a(t,e){return o[3]=t[e],o[2]=t[e+1],o[1]=t[e+2],o[0]=t[e+3],h[0]}var h,o,l,u,c;function f(t,e,i,s,r,n){var a,h,o=s<0?1:0;0===(s=o?-s:s)?(t(0,r,n+e),t(0<1/s?0:2147483648,r,n+i)):isNaN(s)?(t(0,r,n+e),t(2146959360,r,n+i)):17976931348623157e292<s?(t(0,r,n+e),t((o<<31|2146435072)>>>0,r,n+i)):s<22250738585072014e-324?(t((a=s/5e-324)>>>0,r,n+e),t((o<<31|a/4294967296)>>>0,r,n+i)):(1024===(h=Math.floor(Math.log(s)/Math.LN2))&&(h=1023),t(4503599627370496*(a=s*Math.pow(2,-h))>>>0,r,n+e),t((o<<31|h+1023<<20|1048576*a&1048575)>>>0,r,n+i))}function d(t,e,i,s,r){e=t(s,r+e),t=t(s,r+i),s=2*(t>>31)+1,r=t>>>20&2047,i=4294967296*(1048575&t)+e;return 2047==r?i?NaN:1/0*s:0==r?5e-324*s*i:s*Math.pow(2,r-1075)*(i+4503599627370496)}function v(t,e,i){l[0]=t,e[i]=u[0],e[i+1]=u[1],e[i+2]=u[2],e[i+3]=u[3],e[i+4]=u[4],e[i+5]=u[5],e[i+6]=u[6],e[i+7]=u[7]}function p(t,e,i){l[0]=t,e[i]=u[7],e[i+1]=u[6],e[i+2]=u[5],e[i+3]=u[4],e[i+4]=u[3],e[i+5]=u[2],e[i+6]=u[1],e[i+7]=u[0]}function m(t,e){return u[0]=t[e],u[1]=t[e+1],u[2]=t[e+2],u[3]=t[e+3],u[4]=t[e+4],u[5]=t[e+5],u[6]=t[e+6],u[7]=t[e+7],l[0]}function g(t,e){return u[7]=t[e],u[6]=t[e+1],u[5]=t[e+2],u[4]=t[e+3],u[3]=t[e+4],u[2]=t[e+5],u[1]=t[e+6],u[0]=t[e+7],l[0]}return"undefined"!=typeof Float32Array?(h=new Float32Array([-0]),o=new Uint8Array(h.buffer),c=128===o[3],t.writeFloatLE=c?s:r,t.writeFloatBE=c?r:s,t.readFloatLE=c?n:a,t.readFloatBE=c?a:n):(t.writeFloatLE=e.bind(null,_),t.writeFloatBE=e.bind(null,w),t.readFloatLE=i.bind(null,M),t.readFloatBE=i.bind(null,y)),"undefined"!=typeof Float64Array?(l=new Float64Array([-0]),u=new Uint8Array(l.buffer),c=128===u[7],t.writeDoubleLE=c?v:p,t.writeDoubleBE=c?p:v,t.readDoubleLE=c?m:g,t.readDoubleBE=c?g:m):(t.writeDoubleLE=f.bind(null,_,0,4),t.writeDoubleBE=f.bind(null,w,4,0),t.readDoubleLE=d.bind(null,M,0,4),t.readDoubleBE=d.bind(null,y,4,0)),t}function _(t,e,i){e[i]=255&t,e[i+1]=t>>>8&255,e[i+2]=t>>>16&255,e[i+3]=t>>>24}function w(t,e,i){e[i]=t>>>24,e[i+1]=t>>>16&255,e[i+2]=t>>>8&255,e[i+3]=255&t}function M(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24)>>>0}function y(t,e){return(t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3])>>>0}}function Tv(){return xv||(xv=1,Ev=t),Ev;function t(t){try{var e=eval("quire".replace(/^/,"re"))(t);if(e&&(e.length||Object.keys(e).length))return e}catch(t){}return null}}var Rv={},Lv,Cv,Nv,Iv,Pv,Dv;function Ov(){var t;return Lv||(Lv=1,(t=Rv).length=function(t){for(var e,i=0,s=0;s<t.length;++s)(e=t.charCodeAt(s))<128?i+=1:e<2048?i+=2:55296==(64512&e)&&56320==(64512&t.charCodeAt(s+1))?(++s,i+=4):i+=3;return i},t.read=function(t,e,i){if(i-e<1)return"";for(var s,r=null,n=[],a=0;e<i;)(s=t[e++])<128?n[a++]=s:191<s&&s<224?n[a++]=(31&s)<<6|63&t[e++]:239<s&&s<365?(s=((7&s)<<18|(63&t[e++])<<12|(63&t[e++])<<6|63&t[e++])-65536,n[a++]=55296+(s>>10),n[a++]=56320+(1023&s)):n[a++]=(15&s)<<12|(63&t[e++])<<6|63&t[e++],8191<a&&((r=r||[]).push(String.fromCharCode.apply(String,n)),a=0);return r?(a&&r.push(String.fromCharCode.apply(String,n.slice(0,a))),r.join("")):String.fromCharCode.apply(String,n.slice(0,a))},t.write=function(t,e,i){for(var s,r,n=i,a=0;a<t.length;++a)(s=t.charCodeAt(a))<128?e[i++]=s:(s<2048?e[i++]=s>>6|192:(55296==(64512&s)&&56320==(64512&(r=t.charCodeAt(a+1)))?(++a,e[i++]=(s=65536+((1023&s)<<10)+(1023&r))>>18|240,e[i++]=s>>12&63|128):e[i++]=s>>12|224,e[i++]=s>>6&63|128),e[i++]=63&s|128);return i-n}),Rv}function Uv(){return Nv||(Nv=1,Cv=function(e,i,t){var s=t||8192,r=s>>>1,n=null,a=s;return function(t){if(t<1||r<t)return e(t);s<a+t&&(n=e(s),a=0);t=i.call(n,a,a+=t);return 7&a&&(a=1+(7|a)),t}}),Cv}function Fv(){var e,s,i;return Pv||(Pv=1,Iv=r,e=Bv(),(s=r.zero=new r(0,0)).toNumber=function(){return 0},s.zzEncode=s.zzDecode=function(){return this},s.length=function(){return 1},r.zeroHash="\0\0\0\0\0\0\0\0",r.fromNumber=function(t){var e,i;return 0===t?s:(i=(t=(e=t<0)?-t:t)>>>0,t=(t-i)/4294967296>>>0,e&&(t=~t>>>0,i=~i>>>0,4294967295<++i)&&(i=0,4294967295<++t)&&(t=0),new r(i,t))},r.from=function(t){if("number"==typeof t)return r.fromNumber(t);if(e.isString(t)){if(!e.Long)return r.fromNumber(parseInt(t,10));t=e.Long.fromString(t)}return t.low||t.high?new r(t.low>>>0,t.high>>>0):s},r.prototype.toNumber=function(t){var e;return!t&&this.hi>>>31?(t=1+~this.lo>>>0,e=~this.hi>>>0,-(t+4294967296*(e=t?e:e+1>>>0))):this.lo+4294967296*this.hi},r.prototype.toLong=function(t){return e.Long?new e.Long(0|this.lo,0|this.hi,Boolean(t)):{low:0|this.lo,high:0|this.hi,unsigned:Boolean(t)}},i=String.prototype.charCodeAt,r.fromHash=function(t){return"\0\0\0\0\0\0\0\0"===t?s:new r((i.call(t,0)|i.call(t,1)<<8|i.call(t,2)<<16|i.call(t,3)<<24)>>>0,(i.call(t,4)|i.call(t,5)<<8|i.call(t,6)<<16|i.call(t,7)<<24)>>>0)},r.prototype.toHash=function(){return String.fromCharCode(255&this.lo,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,255&this.hi,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},r.prototype.zzEncode=function(){var t=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^t)>>>0,this.lo=(this.lo<<1^t)>>>0,this},r.prototype.zzDecode=function(){var t=-(1&this.lo);return this.lo=((this.lo>>>1|this.hi<<31)^t)>>>0,this.hi=(this.hi>>>1^t)>>>0,this},r.prototype.length=function(){var t=this.lo,e=(this.lo>>>28|this.hi<<4)>>>0,i=this.hi>>>24;return 0==i?0==e?t<16384?t<128?1:2:t<2097152?3:4:e<16384?e<128?5:6:e<2097152?7:8:i<128?9:10}),Iv;function r(t,e){this.lo=t>>>0,this.hi=e>>>0}}function Bv(){var s;return Dv||(Dv=1,(s=fv).asPromise=pv(),s.base64=bv(),s.EventEmitter=Sv(),s.float=Av(),s.inquire=Tv(),s.utf8=Ov(),s.pool=Uv(),s.LongBits=Fv(),s.isNode=Boolean(void 0!==ha&&ha&&ha.process&&ha.process.versions&&ha.process.versions.node),s.global=s.isNode&&ha||"undefined"!=typeof window&&window||"undefined"!=typeof self&&self||ha,s.emptyArray=Object.freeze?Object.freeze([]):[],s.emptyObject=Object.freeze?Object.freeze({}):{},s.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},s.isString=function(t){return"string"==typeof t||t instanceof String},s.isObject=function(t){return t&&"object"==typeof t},s.isset=s.isSet=function(t,e){var i=t[e];return!(null==i||!t.hasOwnProperty(e))&&("object"!=typeof i||0<(Array.isArray(i)?i:Object.keys(i)).length)},s.Buffer=(()=>{try{var t=s.inquire("buffer").Buffer;return t.prototype.utf8Write?t:null}catch(t){return null}})(),s.rh=null,s.nh=null,s.newBuffer=function(t){return"number"==typeof t?s.Buffer?s.nh(t):new s.Array(t):s.Buffer?s.rh(t):"undefined"==typeof Uint8Array?t:new Uint8Array(t)},s.Array="undefined"!=typeof Uint8Array?Uint8Array:Array,s.Long=s.global.dcodeIO&&s.global.dcodeIO.Long||s.global.Long||s.inquire("long"),s.key2Re=/^true|false|0|1$/,s.key32Re=/^-?(?:0|[1-9][0-9]*)$/,s.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,s.longToHash=function(t){return t?s.LongBits.from(t).toHash():s.LongBits.zeroHash},s.longFromHash=function(t,e){t=s.LongBits.fromHash(t);return s.Long?s.Long.fromBits(t.lo,t.hi,e):t.toNumber(Boolean(e))},s.merge=r,s.lcFirst=function(t){return t.charAt(0).toLowerCase()+t.substring(1)},s.newError=t,s.ProtocolError=t("ProtocolError"),s.oneOfGetter=function(t){for(var i={},e=0;e<t.length;++e)i[t[e]]=1;return function(){for(var t=Object.keys(this),e=t.length-1;-1<e;--e)if(1===i[t[e]]&&null!=this[t[e]])return t[e]}},s.oneOfSetter=function(i){return function(t){for(var e=0;e<i.length;++e)i[e]!==t&&delete this[i[e]]}},s.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},s.ah=function(){var i=s.Buffer;i?(s.rh=i.from!==Uint8Array.from&&i.from||function(t,e){return new i(t,e)},s.nh=i.allocUnsafe||function(t){return new i(t)}):s.rh=s.nh=null}),fv;function r(t,e,i){for(var s=Object.keys(e),r=0;r<s.length;++r)void 0!==t[s[r]]&&i||(t[s[r]]=e[s[r]]);return t}function t(t){function i(t,e){if(!(this instanceof i))return new i(t,e);Object.defineProperty(this,"message",{get:function(){return t}}),Error.captureStackTrace?Error.captureStackTrace(this,i):Object.defineProperty(this,"stack",{value:(new Error).stack||""}),e&&r(this,e)}return(i.prototype=Object.create(Error.prototype)).constructor=i,Object.defineProperty(i.prototype,"name",{get:function(){return t}}),i.prototype.toString=function(){return this.name+": "+this.message},i}}var kv=s,Gv=Bv(),Hv,Vv=Gv.LongBits,zv=Gv.base64,Wv=Gv.utf8;function jv(t,e,i){this.fn=t,this.len=e,this.next=void 0,this.val=i}function Xv(){}function Yv(t){this.head=t.head,this.tail=t.tail,this.len=t.len,this.next=t.states}function s(){this.len=0,this.head=new jv(Xv,0,0),this.tail=this.head,this.states=null}var Zv=function(){return Gv.Buffer?function(){return(s.create=function(){return new Hv})()}:function(){return new s}};function qv(t,e,i){e[i]=255&t}function Kv(t,e,i){for(;127<t;)e[i++]=127&t|128,t>>>=7;e[i]=t}function Jv(t,e){this.len=t,this.next=void 0,this.val=e}function $v(t,e,i){for(;t.hi;)e[i++]=127&t.lo|128,t.lo=(t.lo>>>7|t.hi<<25)>>>0,t.hi>>>=7;for(;127<t.lo;)e[i++]=127&t.lo|128,t.lo=t.lo>>>7;e[i++]=t.lo}function Qv(t,e,i){e[i]=255&t,e[i+1]=t>>>8&255,e[i+2]=t>>>16&255,e[i+3]=t>>>24}s.create=Zv(),s.alloc=function(t){return new Gv.Array(t)},Gv.Array!==Array&&(s.alloc=Gv.pool(s.alloc,Gv.Array.prototype.subarray)),s.prototype.hh=function(t,e,i){return this.tail=this.tail.next=new jv(t,e,i),this.len+=e,this},Jv.prototype=Object.create(jv.prototype),Jv.prototype.fn=Kv,s.prototype.uint32=function(t){return this.len+=(this.tail=this.tail.next=new Jv((t>>>=0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},s.prototype.int32=function(t){return t<0?this.hh($v,10,Vv.fromNumber(t)):this.uint32(t)},s.prototype.sint32=function(t){return this.uint32((t<<1^t>>31)>>>0)},s.prototype.uint64=function(t){t=Vv.from(t);return this.hh($v,t.length(),t)},s.prototype.int64=s.prototype.uint64,s.prototype.sint64=function(t){t=Vv.from(t).zzEncode();return this.hh($v,t.length(),t)},s.prototype.bool=function(t){return this.hh(qv,1,t?1:0)},s.prototype.fixed32=function(t){return this.hh(Qv,4,t>>>0)},s.prototype.sfixed32=s.prototype.fixed32,s.prototype.fixed64=function(t){t=Vv.from(t);return this.hh(Qv,4,t.lo).hh(Qv,4,t.hi)},s.prototype.sfixed64=s.prototype.fixed64,s.prototype.float=function(t){return this.hh(Gv.float.writeFloatLE,4,t)},s.prototype.double=function(t){return this.hh(Gv.float.writeDoubleLE,8,t)};var t1=Gv.Array.prototype.set?function(t,e,i){e.set(t,i)}:function(t,e,i){for(var s=0;s<t.length;++s)e[i+s]=t[s]},e1=(s.prototype.bytes=function(t){var e,i=t.length>>>0;return i?(Gv.isString(t)&&(e=s.alloc(i=zv.length(t)),zv.decode(t,e,0),t=e),this.uint32(i).hh(t1,i,t)):this.hh(qv,1,0)},s.prototype.string=function(t){var e=Wv.length(t);return e?this.uint32(e).hh(Wv.write,e,t):this.hh(qv,1,0)},s.prototype.fork=function(){return this.states=new Yv(this),this.head=this.tail=new jv(Xv,0,0),this.len=0,this},s.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new jv(Xv,0,0),this.len=0),this},s.prototype.ldelim=function(){var t=this.head,e=this.tail,i=this.len;return this.reset().uint32(i),i&&(this.tail.next=t.next,this.tail=e,this.len+=i),this},s.prototype.finish=function(){for(var t=this.head.next,e=this.constructor.alloc(this.len),i=0;t;)t.fn(t.val,e,i),i+=t.len,t=t.next;return e},s.ah=function(t){Hv=t,s.create=Zv(),Hv.ah()},r1),i1=kv,s1=((r1.prototype=Object.create(i1.prototype)).constructor=r1,Bv());function r1(){i1.call(this)}function n1(t,e,i){t.length<40?s1.utf8.write(t,e,i):e.utf8Write?e.utf8Write(t,i):e.write(t,i)}r1.ah=function(){r1.alloc=s1.nh,r1.writeBytesBuffer=s1.Buffer&&s1.Buffer.prototype instanceof Uint8Array&&"set"===s1.Buffer.prototype.set.name?function(t,e,i){e.set(t,i)}:function(t,e,i){if(t.copy)t.copy(e,i,0,t.length);else for(var s=0;s<t.length;)e[i++]=t[s++]}},r1.prototype.bytes=function(t){var e=(t=s1.isString(t)?s1.rh(t,"base64"):t).length>>>0;return this.uint32(e),e&&this.hh(r1.writeBytesBuffer,e,t),this},r1.prototype.string=function(t){var e=s1.Buffer.byteLength(t);return this.uint32(e),e&&this.hh(n1,e,t),this},r1.ah();var a1=f1,h1=Bv(),o1,l1=h1.LongBits,u1=h1.utf8;function c1(t,e){return RangeError("index out of range: "+t.pos+" + "+(e||1)+" > "+t.len)}function f1(t){this.buf=t,this.pos=0,this.len=t.length}var d1="undefined"!=typeof Uint8Array?function(t){if(t instanceof Uint8Array||Array.isArray(t))return new f1(t);throw Error("illegal buffer")}:function(t){if(Array.isArray(t))return new f1(t);throw Error("illegal buffer")},v1=function(){return h1.Buffer?function(t){return(f1.create=function(t){return h1.Buffer.isBuffer(t)?new o1(t):d1(t)})(t)}:d1};function p1(){var t=new l1(0,0),e=0;if(!(4<this.len-this.pos)){for(;e<3;++e){if(this.pos>=this.len)throw c1(this);if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t}return t.lo=(t.lo|(127&this.buf[this.pos++])<<7*e)>>>0,t}for(;e<4;++e)if(t.lo=(t.lo|(127&this.buf[this.pos])<<7*e)>>>0,this.buf[this.pos++]<128)return t;if(t.lo=(t.lo|(127&this.buf[this.pos])<<28)>>>0,t.hi=(t.hi|(127&this.buf[this.pos])>>4)>>>0,this.buf[this.pos++]<128)return t;if(e=0,4<this.len-this.pos){for(;e<5;++e)if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}else for(;e<5;++e){if(this.pos>=this.len)throw c1(this);if(t.hi=(t.hi|(127&this.buf[this.pos])<<7*e+3)>>>0,this.buf[this.pos++]<128)return t}throw Error("invalid varint encoding")}function m1(t,e){return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0}function g1(){if(this.pos+8>this.len)throw c1(this,8);return new l1(m1(this.buf,this.pos+=4),m1(this.buf,this.pos+=4))}f1.create=v1(),f1.prototype.oh=h1.Array.prototype.subarray||h1.Array.prototype.slice,f1.prototype.uint32=(()=>{var t=4294967295;return function(){if(t=(127&this.buf[this.pos])>>>0,this.buf[this.pos++]<128||(t=(t|(127&this.buf[this.pos])<<7)>>>0,this.buf[this.pos++]<128)||(t=(t|(127&this.buf[this.pos])<<14)>>>0,this.buf[this.pos++]<128)||(t=(t|(127&this.buf[this.pos])<<21)>>>0,this.buf[this.pos++]<128)||(t=(t|(15&this.buf[this.pos])<<28)>>>0,this.buf[this.pos++]<128)||!((this.pos+=5)>this.len))return t;throw this.pos=this.len,c1(this,10)}})(),f1.prototype.int32=function(){return 0|this.uint32()},f1.prototype.sint32=function(){var t=this.uint32();return t>>>1^-(1&t)|0},f1.prototype.bool=function(){return 0!==this.uint32()},f1.prototype.fixed32=function(){if(this.pos+4>this.len)throw c1(this,4);return m1(this.buf,this.pos+=4)},f1.prototype.sfixed32=function(){if(this.pos+4>this.len)throw c1(this,4);return 0|m1(this.buf,this.pos+=4)},f1.prototype.float=function(){if(this.pos+4>this.len)throw c1(this,4);var t=h1.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},f1.prototype.double=function(){if(this.pos+8>this.len)throw c1(this,4);var t=h1.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},f1.prototype.bytes=function(){var t=this.uint32(),e=this.pos,i=this.pos+t;if(i>this.len)throw c1(this,t);return this.pos+=t,Array.isArray(this.buf)?this.buf.slice(e,i):e===i?new this.buf.constructor(0):this.oh.call(this.buf,e,i)},f1.prototype.string=function(){var t=this.bytes();return u1.read(t,0,t.length)},f1.prototype.skip=function(t){if("number"==typeof t){if(this.pos+t>this.len)throw c1(this,t);this.pos+=t}else do{if(this.pos>=this.len)throw c1(this)}while(128&this.buf[this.pos++]);return this},f1.prototype.skipType=function(t){switch(t){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;4!=(t=7&this.uint32());)this.skipType(t);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+t+" at offset "+this.pos)}return this},f1.ah=function(t){o1=t,f1.create=v1(),o1.ah();var e=h1.Long?"toLong":"toNumber";h1.merge(f1.prototype,{int64:function(){return p1.call(this)[e](!1)},uint64:function(){return p1.call(this)[e](!0)},sint64:function(){return p1.call(this).zzDecode()[e](!1)},fixed64:function(){return g1.call(this)[e](!0)},sfixed64:function(){return g1.call(this)[e](!1)}})};var _1=y1,w1=a1,M1=((y1.prototype=Object.create(w1.prototype)).constructor=y1,Bv());function y1(t){w1.call(this,t)}y1.ah=function(){M1.Buffer&&(y1.prototype.oh=M1.Buffer.prototype.slice)},y1.prototype.string=function(){var t=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+t,this.len))},y1.ah();var E1={},x1=S1,b1=Bv();function S1(t,e,i){if("function"!=typeof t)throw TypeError("rpcImpl must be a function");b1.EventEmitter.call(this),this.rpcImpl=t,this.requestDelimited=Boolean(e),this.responseDelimited=Boolean(i)}(S1.prototype=Object.create(b1.EventEmitter.prototype)).constructor=S1,S1.prototype.rpcCall=function t(i,e,s,r,n){if(!r)throw TypeError("request must be specified");var a=this;if(!n)return b1.asPromise(t,a,i,e,s,r);if(a.rpcImpl)try{return a.rpcImpl(i,e[a.requestDelimited?"encodeDelimited":"encode"](r).finish(),function(t,e){if(t)return a.emit("error",t,i),n(t);if(null!==e){if(!(e instanceof s))try{e=s[a.responseDelimited?"decodeDelimited":"decode"](e)}catch(t){return a.emit("error",t,i),n(t)}return a.emit("data",e,i),n(null,e)}a.end(!0)})}catch(t){a.emit("error",t,i),setTimeout(function(){n(t)},0)}else setTimeout(function(){n(Error("already ended"))},0)},S1.prototype.end=function(t){return this.rpcImpl&&(t||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this},E1.Service=x1;var A1={},T1=((()=>{var t=cv;function e(){t.util.ah(),t.Writer.ah(t.BufferWriter),t.Reader.ah(t.BufferReader)}t.build="minimal",t.Writer=kv,t.BufferWriter=e1,t.Reader=a1,t.BufferReader=_1,t.util=Bv(),t.rpc=E1,t.roots=A1,t.configure=e,e()})(),{exports:{}}),R1=L1;function L1(e,i){"string"==typeof e&&(i=e,e=void 0);var o=[];function l(t){if("string"!=typeof t){var e=u();if(L1.verbose,e="return "+e,t){for(var i=Object.keys(t),s=new Array(i.length+1),r=new Array(i.length),n=0;n<i.length;)s[n]=i[n],r[n]=t[i[n++]];return s[n]=e,Function.apply(null,s).apply(null,r)}return Function(e)()}for(var a=new Array(arguments.length-1),h=0;h<a.length;)a[h]=arguments[++h];if(h=0,t=t.replace(/%([%dfijs])/g,function(t,e){var i=a[h++];switch(e){case"d":case"f":return String(Number(i));case"i":return String(Math.floor(i));case"j":return JSON.stringify(i);case"s":return String(i)}return"%"}),h!==a.length)throw Error("parameter count mismatch");return o.push(t),l}function u(t){return"function "+(t||i||"")+"("+(e&&e.join(",")||"")+"){\n  "+o.join("\n  ")+"\n}"}return l.toString=u,l}L1.verbose=!1;var C1=D1,N1=pv(),I1=Tv(),P1=I1("fs");function D1(i,s,r){return s="function"==typeof s?(r=s,{}):s||{},r?!s.xhr&&P1&&P1.readFile?P1.readFile(i,function(t,e){return t&&"undefined"!=typeof XMLHttpRequest?D1.xhr(i,s,r):t?r(t):r(null,s.binary?e:e.toString("utf8"))}):D1.xhr(i,s,r):N1(D1,this,i,s)}D1.xhr=function(t,i,s){var r=new XMLHttpRequest;r.onreadystatechange=function(){if(4===r.readyState){if(0!==r.status&&200!==r.status)return s(Error("status "+r.status));if(i.binary){if(!(t=r.response))for(var t=[],e=0;e<r.responseText.length;++e)t.push(255&r.responseText.charCodeAt(e));return s(null,"undefined"!=typeof Uint8Array?new Uint8Array(t):t)}return s(null,r.responseText)}},i.binary&&("overrideMimeType"in r&&r.overrideMimeType("text/plain; charset=x-user-defined"),r.responseType="arraybuffer"),r.open("GET",t),r.send()};var O1={},U1=((()=>{var t=O1,r=t.isAbsolute=function(t){return/^(?:\/|\w+:)/.test(t)},s=t.normalize=function(t){var e=(t=t.replace(/\\/g,"/").replace(/\/{2,}/g,"/")).split("/"),i=r(t),t="";i&&(t=e.shift()+"/");for(var s=0;s<e.length;)".."===e[s]?0<s&&".."!==e[s-1]?e.splice(--s,2):i?e.splice(s,1):++s:"."===e[s]?e.splice(s,1):++s;return t+e.join("/")};t.resolve=function(t,e,i){return i||(e=s(e)),!r(e)&&(t=(t=i?t:s(t)).replace(/(?:\/|^)[^/]+$/,"")).length?s(t+"/"+e):e}})(),{}),F1,B1,k1,G1,H1,V1,z1,W1,j1,X1,Y1,Z1,q1;function K1(){var t,e,r;return F1||(F1=1,t=U1,e=Lp(),r=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"],t.basic=i([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),t.defaults=i([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",e.emptyArray,null]),t.long=i([0,0,0,1,1],7),t.mapKey=i([0,0,0,5,5,0,0,0,1,1,0,2],2),t.packed=i([1,5,0,0,0,5,5,0,0,0,1,1,0])),U1;function i(t,e){var i=0,s={};for(e|=0;i<t.length;)s[r[i+e]]=t[i++];return s}}function J1(){var h,e,o,l,i,u;return k1||(k1=1,B1=a,h=Cp(),((a.prototype=Object.create(h.prototype)).constructor=a).className="Field",e=Np(),o=K1(),l=Lp(),u=/^required|optional|repeated$/,a.fromJSON=function(t,e){return new a(t,e.id,e.type,e.rule,e.extend,e.options,e.comment)},Object.defineProperty(a.prototype,"packed",{get:function(){return null===this.lh&&(this.lh=!1!==this.getOption("packed")),this.lh}}),a.prototype.setOption=function(t,e,i){return"packed"===t&&(this.lh=null),h.prototype.setOption.call(this,t,e,i)},a.prototype.toJSON=function(t){t=!!t&&Boolean(t.keepComments);return l.toObject(["rule","optional"!==this.rule&&this.rule||void 0,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:void 0])},a.prototype.resolve=function(){var t;return this.resolved?this:(void 0===(this.typeDefault=o.defaults[this.type])&&(this.resolvedType=(this.declaringField||this).parent.lookupTypeOrEnum(this.type),this.resolvedType instanceof i?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]),this.options&&null!=this.options.default&&(this.typeDefault=this.options.default,this.resolvedType instanceof e)&&"string"==typeof this.typeDefault&&(this.typeDefault=this.resolvedType.values[this.typeDefault]),this.options&&(!0!==this.options.packed&&(void 0===this.options.packed||!this.resolvedType||this.resolvedType instanceof e)||delete this.options.packed,Object.keys(this.options).length||(this.options=void 0)),this.long?(this.typeDefault=l.Long.fromNumber(this.typeDefault,"u"===this.type.charAt(0)),Object.freeze&&Object.freeze(this.typeDefault)):this.bytes&&"string"==typeof this.typeDefault&&(l.base64.test(this.typeDefault)?l.base64.decode(this.typeDefault,t=l.newBuffer(l.base64.length(this.typeDefault)),0):l.utf8.write(this.typeDefault,t=l.newBuffer(l.utf8.length(this.typeDefault)),0),this.typeDefault=t),this.map?this.defaultValue=l.emptyObject:this.repeated?this.defaultValue=l.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof i&&(this.parent.ctor.prototype[this.name]=this.defaultValue),h.prototype.resolve.call(this))},a.d=function(i,s,r,n){return"function"==typeof s?s=l.decorateType(s).name:s&&"object"==typeof s&&(s=l.decorateEnum(s).name),function(t,e){l.decorateType(t.constructor).add(new a(e,i,s,r,{default:n}))}},a.ah=function(t){i=t}),B1;function a(t,e,i,s,r,n,a){if(l.isObject(s)?(a=r,n=s,s=r=void 0):l.isObject(r)&&(a=n,n=r,r=void 0),h.call(this,t,n),!l.isInteger(e)||e<0)throw TypeError("id must be a non-negative integer");if(!l.isString(i))throw TypeError("type must be a string");if(void 0!==s&&!u.test(s=s.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(void 0!==r&&!l.isString(r))throw TypeError("extend must be a string");this.rule=(s="proto3_optional"===s?"optional":s)&&"optional"!==s?s:void 0,this.type=i,this.id=e,this.extend=r||void 0,this.required="required"===s,this.optional=!this.required,this.repeated="repeated"===s,this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=!!l.Long&&void 0!==o.long[i],this.bytes="bytes"===i,this.resolvedType=null,this.extensionField=null,this.declaringField=null,this.lh=null,this.comment=a}}function $1(){var r,i,s;return H1||(H1=1,G1=n,r=Cp(),((n.prototype=Object.create(r.prototype)).constructor=n).className="OneOf",i=J1(),s=Lp(),n.fromJSON=function(t,e){return new n(t,e.oneof,e.options,e.comment)},n.prototype.toJSON=function(t){t=!!t&&Boolean(t.keepComments);return s.toObject(["options",this.options,"oneof",this.oneof,"comment",t?this.comment:void 0])},n.prototype.add=function(t){if(t instanceof i)return t.parent&&t.parent!==this.parent&&t.parent.remove(t),this.oneof.push(t.name),this.fieldsArray.push(t),a(t.partOf=this),this;throw TypeError("field must be a Field")},n.prototype.remove=function(t){if(!(t instanceof i))throw TypeError("field must be a Field");var e=this.fieldsArray.indexOf(t);if(e<0)throw Error(t+" is not a member of "+this);return this.fieldsArray.splice(e,1),-1<(e=this.oneof.indexOf(t.name))&&this.oneof.splice(e,1),t.partOf=null,this},n.prototype.onAdd=function(t){r.prototype.onAdd.call(this,t);for(var e=0;e<this.oneof.length;++e){var i=t.get(this.oneof[e]);i&&!i.partOf&&(i.partOf=this).fieldsArray.push(i)}a(this)},n.prototype.onRemove=function(t){for(var e,i=0;i<this.fieldsArray.length;++i)(e=this.fieldsArray[i]).parent&&e.parent.remove(e);r.prototype.onRemove.call(this,t)},n.d=function(){for(var i=new Array(arguments.length),t=0;t<arguments.length;)i[t]=arguments[t++];return function(t,e){s.decorateType(t.constructor).add(new n(e,i)),Object.defineProperty(t,e,{get:s.oneOfGetter(i),set:s.oneOfSetter(i)})}}),G1;function n(t,e,i,s){if(Array.isArray(e)||(i=e,e=void 0),r.call(this,t,i),void 0!==e&&!Array.isArray(e))throw TypeError("fieldNames must be an Array");this.oneof=e||[],this.fieldsArray=[],this.comment=s}function a(t){if(t.parent)for(var e=0;e<t.fieldsArray.length;++e)t.fieldsArray[e].parent||t.parent.add(t.fieldsArray[e])}}function Q1(){var i,r,n,a,h,o,l;return z1||(z1=1,V1=u,i=Cp(),((u.prototype=Object.create(i.prototype)).constructor=u).className="Namespace",r=J1(),n=$1(),a=Lp(),u.fromJSON=function(t,e){return new u(t,e.options).addJSON(e.nested)},u.arrayToJSON=e,u.isReservedId=function(t,e){if(t)for(var i=0;i<t.length;++i)if("string"!=typeof t[i]&&t[i][0]<=e&&t[i][1]>e)return!0;return!1},u.isReservedName=function(t,e){if(t)for(var i=0;i<t.length;++i)if(t[i]===e)return!0;return!1},Object.defineProperty(u.prototype,"nestedArray",{get:function(){return this.uh||(this.uh=a.toArray(this.nested))}}),u.prototype.toJSON=function(t){return a.toObject(["options",this.options,"nested",e(this.nestedArray,t)])},u.prototype.addJSON=function(t){if(t)for(var e,i=Object.keys(t),s=0;s<i.length;++s)e=t[i[s]],this.add((void 0!==e.fields?h:void 0!==e.values?l:void 0!==e.methods?o:void 0!==e.id?r:u).fromJSON(i[s],e));return this},u.prototype.get=function(t){return this.nested&&this.nested[t]||null},u.prototype.getEnum=function(t){if(this.nested&&this.nested[t]instanceof l)return this.nested[t].values;throw Error("no such enum: "+t)},u.prototype.add=function(t){if(!(t instanceof r&&void 0!==t.extend||t instanceof h||t instanceof l||t instanceof o||t instanceof u||t instanceof n))throw TypeError("object must be a valid nested object");if(this.nested){var e=this.get(t.name);if(e){if(!(e instanceof u&&t instanceof u)||e instanceof h||e instanceof o)throw Error("duplicate name '"+t.name+"' in "+this);for(var i=e.nestedArray,s=0;s<i.length;++s)t.add(i[s]);this.remove(e),this.nested||(this.nested={}),t.setOptions(e.options,!0)}}else this.nested={};return(this.nested[t.name]=t).onAdd(this),c(this)},u.prototype.remove=function(t){if(!(t instanceof i))throw TypeError("object must be a ReflectionObject");if(t.parent!==this)throw Error(t+" is not a member of "+this);return delete this.nested[t.name],Object.keys(this.nested).length||(this.nested=void 0),t.onRemove(this),c(this)},u.prototype.define=function(t,e){if(a.isString(t))t=t.split(".");else if(!Array.isArray(t))throw TypeError("illegal path");if(t&&t.length&&""===t[0])throw Error("path must be relative");for(var i=this;0<t.length;){var s=t.shift();if(i.nested&&i.nested[s]){if(!((i=i.nested[s])instanceof u))throw Error("path conflicts with non-namespace objects")}else i.add(i=new u(s))}return e&&i.addJSON(e),i},u.prototype.resolveAll=function(){for(var t=this.nestedArray,e=0;e<t.length;)t[e]instanceof u?t[e++].resolveAll():t[e++].resolve();return this.resolve()},u.prototype.lookup=function(t,e,i){if("boolean"==typeof e?(i=e,e=void 0):e&&!Array.isArray(e)&&(e=[e]),a.isString(t)&&t.length){if("."===t)return this.root;t=t.split(".")}else if(!t.length)return this;if(""===t[0])return this.root.lookup(t.slice(1),e);var s=this.get(t[0]);if(s){if(1===t.length){if(!e||-1<e.indexOf(s.constructor))return s}else if(s instanceof u&&(s=s.lookup(t.slice(1),e,!0)))return s}else for(var r=0;r<this.nestedArray.length;++r)if(this.uh[r]instanceof u&&(s=this.uh[r].lookup(t,e,!0)))return s;return null===this.parent||i?null:this.parent.lookup(t,e)},u.prototype.lookupType=function(t){var e=this.lookup(t,[h]);if(e)return e;throw Error("no such type: "+t)},u.prototype.lookupEnum=function(t){var e=this.lookup(t,[l]);if(e)return e;throw Error("no such Enum '"+t+"' in "+this)},u.prototype.lookupTypeOrEnum=function(t){var e=this.lookup(t,[h,l]);if(e)return e;throw Error("no such Type or Enum '"+t+"' in "+this)},u.prototype.lookupService=function(t){var e=this.lookup(t,[o]);if(e)return e;throw Error("no such Service '"+t+"' in "+this)},u.ah=function(t,e,i){h=t,o=e,l=i}),V1;function e(t,e){if(t&&t.length){for(var i={},s=0;s<t.length;++s)i[t[s].name]=t[s].toJSON(e);return i}}function u(t,e){i.call(this,t,e),this.nested=void 0,this.uh=null}function c(t){return t.uh=null,t}}function tp(){var a,t,h;return j1||(j1=1,W1=n,a=J1(),((n.prototype=Object.create(a.prototype)).constructor=n).className="MapField",t=K1(),h=Lp(),n.fromJSON=function(t,e){return new n(t,e.id,e.keyType,e.type,e.options,e.comment)},n.prototype.toJSON=function(t){t=!!t&&Boolean(t.keepComments);return h.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",t?this.comment:void 0])},n.prototype.resolve=function(){if(this.resolved)return this;if(void 0===t.mapKey[this.keyType])throw Error("invalid key type: "+this.keyType);return a.prototype.resolve.call(this)},n.d=function(i,s,r){return"function"==typeof r?r=h.decorateType(r).name:r&&"object"==typeof r&&(r=h.decorateEnum(r).name),function(t,e){h.decorateType(t.constructor).add(new n(e,i,s,r))}}),W1;function n(t,e,i,s,r,n){if(a.call(this,t,e,s,void 0,void 0,r,n),!h.isString(i))throw TypeError("keyType must be a string");this.keyType=i,this.resolvedKeyType=null,this.map=!0}}function ep(){var l,u;return Y1||(Y1=1,X1=i,l=Cp(),((i.prototype=Object.create(l.prototype)).constructor=i).className="Method",u=Lp(),i.fromJSON=function(t,e){return new i(t,e.type,e.requestType,e.responseType,e.requestStream,e.responseStream,e.options,e.comment,e.parsedOptions)},i.prototype.toJSON=function(t){t=!!t&&Boolean(t.keepComments);return u.toObject(["type","rpc"!==this.type&&this.type||void 0,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",t?this.comment:void 0,"parsedOptions",this.parsedOptions])},i.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),l.prototype.resolve.call(this))}),X1;function i(t,e,i,s,r,n,a,h,o){if(u.isObject(r)?(a=r,r=n=void 0):u.isObject(n)&&(a=n,n=void 0),void 0!==e&&!u.isString(e))throw TypeError("type must be a string");if(!u.isString(i))throw TypeError("requestType must be a string");if(!u.isString(s))throw TypeError("responseType must be a string");l.call(this,t,a),this.type=e||"rpc",this.requestType=i,this.requestStream=!!r||void 0,this.responseType=s,this.responseStream=!!n||void 0,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=h,this.parsedOptions=o}}function ip(){var s,n,h,o;return q1||(q1=1,Z1=a,s=Q1(),((a.prototype=Object.create(s.prototype)).constructor=a).className="Service",n=ep(),h=Lp(),o=E1,a.fromJSON=function(t,e){var i=new a(t,e.options);if(e.methods)for(var s=Object.keys(e.methods),r=0;r<s.length;++r)i.add(n.fromJSON(s[r],e.methods[s[r]]));return e.nested&&i.addJSON(e.nested),i.comment=e.comment,i},a.prototype.toJSON=function(t){var e=s.prototype.toJSON.call(this,t),i=!!t&&Boolean(t.keepComments);return h.toObject(["options",e&&e.options||void 0,"methods",s.arrayToJSON(this.methodsArray,t)||{},"nested",e&&e.nested||void 0,"comment",i?this.comment:void 0])},Object.defineProperty(a.prototype,"methodsArray",{get:function(){return this.fh||(this.fh=h.toArray(this.methods))}}),a.prototype.get=function(t){return this.methods[t]||s.prototype.get.call(this,t)},a.prototype.resolveAll=function(){for(var t=this.methodsArray,e=0;e<t.length;++e)t[e].resolve();return s.prototype.resolve.call(this)},a.prototype.add=function(t){if(this.get(t.name))throw Error("duplicate name '"+t.name+"' in "+this);return t instanceof n?e((this.methods[t.name]=t).parent=this):s.prototype.add.call(this,t)},a.prototype.remove=function(t){if(t instanceof n){if(this.methods[t.name]!==t)throw Error(t+" is not a member of "+this);return delete this.methods[t.name],t.parent=null,e(this)}return s.prototype.remove.call(this,t)},a.prototype.create=function(t,e,i){for(var s,r=new o.Service(t,e,i),n=0;n<this.methodsArray.length;++n){var a=h.lcFirst((s=this.fh[n]).resolve().name).replace(/[^$\w_]/g,"");r[a]=h.codegen(["r","c"],h.isReserved(a)?a+"_":a)("return this.rpcCall(m,q,s,r,c)")({m:s,q:s.resolvedRequestType.ctor,s:s.resolvedResponseType.ctor})}return r}),Z1;function a(t,e){s.call(this,t,e),this.methods={},this.fh=null}function e(t){return t.fh=null,t}}var sp=lp,rp=Bv(),np,ap,hp,op;function lp(t){if(t)for(var e=Object.keys(t),i=0;i<e.length;++i)this[e[i]]=t[e[i]]}function up(){var h,o,l;return ap||(ap=1,np=function(t){var e=l.codegen(["r","l"],t.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(t.fieldsArray.filter(function(t){return t.map}).length?",k,value":""))("while(r.pos<c){")("var t=r.uint32()");t.group&&e("if((t&7)===4)")("break");e("switch(t>>>3){");for(var i=0;i<t.fieldsArray.length;++i){var s=t.dh[i].resolve(),r=s.resolvedType instanceof h?"int32":s.type,n="m"+l.safeProp(s.name);e("case %i:",s.id),s.map?(e("if(%s===util.emptyObject)",n)("%s={}",n)("var c2 = r.uint32()+r.pos"),void 0!==o.defaults[s.keyType]?e("k=%j",o.defaults[s.keyType]):e("k=null"),void 0!==o.defaults[r]?e("value=%j",o.defaults[r]):e("value=null"),e("while(r.pos<c2){")("var tag2=r.uint32()")("switch(tag2>>>3){")("case 1: k=r.%s(); break",s.keyType)("case 2:"),void 0===o.basic[r]?e("value=types[%i].decode(r,r.uint32())",i):e("value=r.%s()",r),e("break")("default:")("r.skipType(tag2&7)")("break")("}")("}"),void 0!==o.long[s.keyType]?e('%s[typeof k==="object"?util.longToHash(k):k]=value',n):e("%s[k]=value",n)):s.repeated?(e("if(!(%s&&%s.length))",n,n)("%s=[]",n),void 0!==o.packed[r]&&e("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",n,r)("}else"),void 0===o.basic[r]?e(s.resolvedType.group?"%s.push(types[%i].decode(r))":"%s.push(types[%i].decode(r,r.uint32()))",n,i):e("%s.push(r.%s())",n,r)):void 0===o.basic[r]?e(s.resolvedType.group?"%s=types[%i].decode(r)":"%s=types[%i].decode(r,r.uint32())",n,i):e("%s=r.%s()",n,r),e("break")}for(e("default:")("r.skipType(t&7)")("break")("}")("}"),i=0;i<t.dh.length;++i){var a=t.dh[i];a.required&&e("if(!m.hasOwnProperty(%j))",a.name)("throw util.ProtocolError(%j,{instance:m})","missing required '"+a.name+"'")}return e("return m")},h=Np(),o=K1(),l=Lp()),np}function cp(){var a,o;return op||(op=1,hp=function(t){var e=o.codegen(["m"],t.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),i=t.oneofsArray,s={};i.length&&e("var p={}");for(var r=0;r<t.fieldsArray.length;++r){var n,a=t.dh[r].resolve(),h="m"+o.safeProp(a.name);a.optional&&e("if(%s!=null&&m.hasOwnProperty(%j)){",h,a.name),a.map?(e("if(!util.isObject(%s))",h)("return%j",l(a,"object"))("var k=Object.keys(%s)",h)("for(var i=0;i<k.length;++i){"),((t,e,i)=>{switch(e.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":t("if(!util.key32Re.test(%s))",i)("return%j",l(e,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":t("if(!util.key64Re.test(%s))",i)("return%j",l(e,"integer|Long key"));break;case"bool":t("if(!util.key2Re.test(%s))",i)("return%j",l(e,"boolean key"))}})(e,a,"k[i]"),u(e,a,r,h+"[k[i]]")("}")):a.repeated?(e("if(!Array.isArray(%s))",h)("return%j",l(a,"array"))("for(var i=0;i<%s.length;++i){",h),u(e,a,r,h+"[i]")("}")):(a.partOf&&(n=o.safeProp(a.partOf.name),1===s[a.partOf.name]&&e("if(p%s===1)",n)("return%j",a.partOf.name+": multiple values"),s[a.partOf.name]=1,e("p%s=1",n)),u(e,a,r,h)),a.optional&&e("}")}return e("return null")},a=Np(),o=Lp()),hp;function l(t,e){return t.name+": "+e+(t.repeated&&"array"!==e?"[]":t.map&&"object"!==e?"{k:"+t.keyType+"}":"")+" expected"}function u(t,e,i,s){if(e.resolvedType)if(e.resolvedType instanceof a){t("switch(%s){",s)("default:")("return%j",l(e,"enum value"));for(var r=Object.keys(e.resolvedType.values),n=0;n<r.length;++n)t("case %i:",e.resolvedType.values[r[n]]);t("break")("}")}else t("{")("var e=types[%i].verify(%s);",i,s)("if(e)")("return%j+e",e.name+".")("}");else switch(e.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":t("if(!util.isInteger(%s))",s)("return%j",l(e,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":t("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",s,s,s,s)("return%j",l(e,"integer|Long"));break;case"float":case"double":t('if(typeof %s!=="number")',s)("return%j",l(e,"number"));break;case"bool":t('if(typeof %s!=="boolean")',s)("return%j",l(e,"boolean"));break;case"string":t("if(!util.isString(%s))",s)("return%j",l(e,"string"));break;case"bytes":t('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',s,s,s)("return%j",l(e,"buffer"))}return t}}lp.create=function(t){return this.$type.create(t)},lp.encode=function(t,e){return this.$type.encode(t,e)},lp.encodeDelimited=function(t,e){return this.$type.encodeDelimited(t,e)},lp.decode=function(t){return this.$type.decode(t)},lp.decodeDelimited=function(t){return this.$type.decodeDelimited(t)},lp.verify=function(t){return this.$type.verify(t)},lp.fromObject=function(t){return this.$type.fromObject(t)},lp.toObject=function(t,e){return this.$type.toObject(t,e)},lp.prototype.toJSON=function(){return this.$type.toObject(this,rp.toJSONOptions)};var fp={},dp;function vp(){var t,f,d;return dp||(dp=1,t=fp,f=Np(),d=Lp(),t.fromObject=function(t){var e=t.fieldsArray,i=d.codegen(["d"],t.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!e.length)return i("return new this.ctor");i("var m=new this.ctor");for(var s=0;s<e.length;++s){var r=e[s].resolve(),n=d.safeProp(r.name);r.map?(i("if(d%s){",n)('if(typeof d%s!=="object")',n)("throw TypeError(%j)",r.fullName+": object expected")("m%s={}",n)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",n),a(i,r,s,n+"[ks[i]]")("}")("}")):r.repeated?(i("if(d%s){",n)("if(!Array.isArray(d%s))",n)("throw TypeError(%j)",r.fullName+": array expected")("m%s=[]",n)("for(var i=0;i<d%s.length;++i){",n),a(i,r,s,n+"[i]")("}")("}")):(r.resolvedType instanceof f||i("if(d%s!=null){",n),a(i,r,s,n),r.resolvedType instanceof f||i("}"))}return i("return m")},t.toObject=function(t){var e=t.fieldsArray.slice().sort(d.compareFieldsById);if(!e.length)return d.codegen()("return {}");for(var i=d.codegen(["m","o"],t.name+"$toObject")("if(!o)")("o={}")("var d={}"),s=[],r=[],n=[],a=0;a<e.length;++a)e[a].partOf||(e[a].resolve().repeated?s:e[a].map?r:n).push(e[a]);if(s.length){for(i("if(o.arrays||o.defaults){"),a=0;a<s.length;++a)i("d%s=[]",d.safeProp(s[a].name));i("}")}if(r.length){for(i("if(o.objects||o.defaults){"),a=0;a<r.length;++a)i("d%s={}",d.safeProp(r[a].name));i("}")}if(n.length){for(i("if(o.defaults){"),a=0;a<n.length;++a){var h,o=n[a],l=d.safeProp(o.name);o.resolvedType instanceof f?i("d%s=o.enums===String?%j:%j",l,o.resolvedType.valuesById[o.typeDefault],o.typeDefault):o.long?i("if(util.Long){")("var n=new util.Long(%i,%i,%j)",o.typeDefault.low,o.typeDefault.high,o.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",l)("}else")("d%s=o.longs===String?%j:%i",l,o.typeDefault.toString(),o.typeDefault.toNumber()):o.bytes?(h="["+Array.prototype.slice.call(o.typeDefault).join(",")+"]",i("if(o.bytes===String)d%s=%j",l,String.fromCharCode.apply(String,o.typeDefault))("else{")("d%s=%s",l,h)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",l,l)("}")):i("d%s=%j",l,o.typeDefault)}i("}")}for(var u=!1,a=0;a<e.length;++a){var o=e[a],c=t.dh.indexOf(o),l=d.safeProp(o.name);o.map?(u||(u=!0,i("var ks2")),i("if(m%s&&(ks2=Object.keys(m%s)).length){",l,l)("d%s={}",l)("for(var j=0;j<ks2.length;++j){"),v(i,o,c,l+"[ks2[j]]")("}")):o.repeated?(i("if(m%s&&m%s.length){",l,l)("d%s=[]",l)("for(var j=0;j<m%s.length;++j){",l),v(i,o,c,l+"[j]")("}")):(i("if(m%s!=null&&m.hasOwnProperty(%j)){",l,o.name),v(i,o,c,l),o.partOf&&i("if(o.oneofs)")("d%s=%j",d.safeProp(o.partOf.name),o.name)),i("}")}return i("return d")}),fp;function a(t,e,i,s){if(e.resolvedType)if(e.resolvedType instanceof f){t("switch(d%s){",s);for(var r=e.resolvedType.values,n=Object.keys(r),a=0;a<n.length;++a)e.repeated&&r[n[a]]===e.typeDefault&&t("default:"),t("case%j:",n[a])("case %i:",r[n[a]])("m%s=%j",s,r[n[a]])("break");t("}")}else t('if(typeof d%s!=="object")',s)("throw TypeError(%j)",e.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",s,i,s);else{var h=!1;switch(e.type){case"double":case"float":t("m%s=Number(d%s)",s,s);break;case"uint32":case"fixed32":t("m%s=d%s>>>0",s,s);break;case"int32":case"sint32":case"sfixed32":t("m%s=d%s|0",s,s);break;case"uint64":h=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":t("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",s,s,h)('else if(typeof d%s==="string")',s)("m%s=parseInt(d%s,10)",s,s)('else if(typeof d%s==="number")',s)("m%s=d%s",s,s)('else if(typeof d%s==="object")',s)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",s,s,s,h?"true":"");break;case"bytes":t('if(typeof d%s==="string")',s)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",s,s,s)("else if(d%s.length)",s)("m%s=d%s",s,s);break;case"string":t("m%s=String(d%s)",s,s);break;case"bool":t("m%s=Boolean(d%s)",s,s)}}return t}function v(t,e,i,s){if(e.resolvedType)e.resolvedType instanceof f?t("d%s=o.enums===String?types[%i].values[m%s]:m%s",s,i,s,s):t("d%s=types[%i].toObject(m%s,o)",s,i,s);else{var r=!1;switch(e.type){case"double":case"float":t("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",s,s,s,s);break;case"uint64":r=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":t('if(typeof m%s==="number")',s)("d%s=o.longs===String?String(m%s):m%s",s,s,s)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",s,s,s,s,r?"true":"",s);break;case"bytes":t("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",s,s,s,s,s);break;default:t("d%s=m%s",s,s)}}return t}}var pp={},mp,gp,_p,wp,Mp,yp,Ep,xp,bp,Sp,Ap;function Tp(){var a,h,o,l,u,c,r,n,f,d,v,p,m,g,_;return gp||(gp=1,mp=w,a=Q1(),((w.prototype=Object.create(a.prototype)).constructor=w).className="Type",h=Np(),o=$1(),l=J1(),u=tp(),c=ip(),r=sp,n=a1,f=kv,d=Lp(),v=Ip(),p=up(),m=cp(),g=vp(),_=pp,Object.defineProperties(w.prototype,{fieldsById:{get:function(){if(!this.ph){this.ph={};for(var t=Object.keys(this.fields),e=0;e<t.length;++e){var i=this.fields[t[e]],s=i.id;if(this.ph[s])throw Error("duplicate id "+s+" in "+this);this.ph[s]=i}}return this.ph}},fieldsArray:{get:function(){return this.dh||(this.dh=d.toArray(this.fields))}},oneofsArray:{get:function(){return this.mh||(this.mh=d.toArray(this.oneofs))}},ctor:{get:function(){return this.gh||(this.ctor=w.generateConstructor(this)())},set:function(t){for(var e=t.prototype,i=(e instanceof r||((t.prototype=new r).constructor=t,d.merge(t.prototype,e)),t.$type=t.prototype.$type=this,d.merge(t,r,!0),this.gh=t,0);i<this.fieldsArray.length;++i)this.dh[i].resolve();for(var s={},i=0;i<this.oneofsArray.length;++i)s[this.mh[i].resolve().name]={get:d.oneOfGetter(this.mh[i].oneof),set:d.oneOfSetter(this.mh[i].oneof)};i&&Object.defineProperties(t.prototype,s)}}}),w.generateConstructor=function(t){for(var e,i=d.codegen(["p"],t.name),s=0;s<t.fieldsArray.length;++s)(e=t.dh[s]).map?i("this%s={}",d.safeProp(e.name)):e.repeated&&i("this%s=[]",d.safeProp(e.name));return i("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")},w.fromJSON=function(t,e){for(var i=new w(t,e.options),s=(i.extensions=e.extensions,i.reserved=e.reserved,Object.keys(e.fields)),r=0;r<s.length;++r)i.add((void 0!==e.fields[s[r]].keyType?u:l).fromJSON(s[r],e.fields[s[r]]));if(e.oneofs)for(s=Object.keys(e.oneofs),r=0;r<s.length;++r)i.add(o.fromJSON(s[r],e.oneofs[s[r]]));if(e.nested)for(s=Object.keys(e.nested),r=0;r<s.length;++r){var n=e.nested[s[r]];i.add((void 0!==n.id?l:void 0!==n.fields?w:void 0!==n.values?h:void 0!==n.methods?c:a).fromJSON(s[r],n))}return e.extensions&&e.extensions.length&&(i.extensions=e.extensions),e.reserved&&e.reserved.length&&(i.reserved=e.reserved),e.group&&(i.group=!0),e.comment&&(i.comment=e.comment),i},w.prototype.toJSON=function(t){var e=a.prototype.toJSON.call(this,t),i=!!t&&Boolean(t.keepComments);return d.toObject(["options",e&&e.options||void 0,"oneofs",a.arrayToJSON(this.oneofsArray,t),"fields",a.arrayToJSON(this.fieldsArray.filter(function(t){return!t.declaringField}),t)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:void 0,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"group",this.group||void 0,"nested",e&&e.nested||void 0,"comment",i?this.comment:void 0])},w.prototype.resolveAll=function(){for(var t=this.fieldsArray,e=0;e<t.length;)t[e++].resolve();for(var i=this.oneofsArray,e=0;e<i.length;)i[e++].resolve();return a.prototype.resolveAll.call(this)},w.prototype.get=function(t){return this.fields[t]||this.oneofs&&this.oneofs[t]||this.nested&&this.nested[t]||null},w.prototype.add=function(t){if(this.get(t.name))throw Error("duplicate name '"+t.name+"' in "+this);if(t instanceof l&&void 0===t.extend){if((this.ph||this.fieldsById)[t.id])throw Error("duplicate id "+t.id+" in "+this);if(this.isReservedId(t.id))throw Error("id "+t.id+" is reserved in "+this);if(this.isReservedName(t.name))throw Error("name '"+t.name+"' is reserved in "+this);return t.parent&&t.parent.remove(t),(this.fields[t.name]=t).message=this,t.onAdd(this),e(this)}return t instanceof o?(this.oneofs||(this.oneofs={}),(this.oneofs[t.name]=t).onAdd(this),e(this)):a.prototype.add.call(this,t)},w.prototype.remove=function(t){if(t instanceof l&&void 0===t.extend){if(this.fields&&this.fields[t.name]===t)return delete this.fields[t.name],t.parent=null,t.onRemove(this),e(this);throw Error(t+" is not a member of "+this)}if(t instanceof o){if(this.oneofs&&this.oneofs[t.name]===t)return delete this.oneofs[t.name],t.parent=null,t.onRemove(this),e(this);throw Error(t+" is not a member of "+this)}return a.prototype.remove.call(this,t)},w.prototype.isReservedId=function(t){return a.isReservedId(this.reserved,t)},w.prototype.isReservedName=function(t){return a.isReservedName(this.reserved,t)},w.prototype.create=function(t){return new this.ctor(t)},w.prototype.setup=function(){for(var t=this.fullName,e=[],i=0;i<this.fieldsArray.length;++i)e.push(this.dh[i].resolve().resolvedType);this.encode=v(this)({Writer:f,types:e,util:d}),this.decode=p(this)({Reader:n,types:e,util:d}),this.verify=m(this)({types:e,util:d}),this.fromObject=g.fromObject(this)({types:e,util:d}),this.toObject=g.toObject(this)({types:e,util:d});var s,t=_[t];return t&&((s=Object.create(this)).fromObject=this.fromObject,this.fromObject=t.fromObject.bind(s),s.toObject=this.toObject,this.toObject=t.toObject.bind(s)),this},w.prototype.encode=function(t,e){return this.setup().encode(t,e)},w.prototype.encodeDelimited=function(t,e){return this.encode(t,e&&e.len?e.fork():e).ldelim()},w.prototype.decode=function(t,e){return this.setup().decode(t,e)},w.prototype.decodeDelimited=function(t){return t instanceof n||(t=n.create(t)),this.decode(t,t.uint32())},w.prototype.verify=function(t){return this.setup().verify(t)},w.prototype.fromObject=function(t){return this.setup().fromObject(t)},w.prototype.toObject=function(t,e){return this.setup().toObject(t,e)},w.d=function(e){return function(t){d.decorateType(t,e)}}),mp;function w(t,e){a.call(this,t,e),this.fields={},this.oneofs=void 0,this.extensions=void 0,this.reserved=void 0,this.group=void 0,this.ph=null,this.dh=null,this.mh=null,this.gh=null}function e(t){return t.ph=t.dh=t.mh=null,delete t.encode,delete t.decode,delete t.verify,t}}function Rp(){var s,r,n,a,d,h,v,p,o;return wp||(wp=1,_p=i,s=Q1(),((i.prototype=Object.create(s.prototype)).constructor=i).className="Root",r=J1(),n=Np(),a=$1(),d=Lp(),i.fromJSON=function(t,e){return e=e||new i,t.options&&e.setOptions(t.options),e.addJSON(t.nested)},i.prototype.resolvePath=d.path.resolve,i.prototype.fetch=d.fetch,i.prototype.load=function t(e,n,r){"function"==typeof n&&(r=n,n=void 0);var a=this;if(!r)return d.asPromise(t,a,e,n);var h=r===m;function o(t,e){if(r){var i=r;if(r=null,h)throw t;i(t,e)}}function l(t){var e=t.lastIndexOf("google/protobuf/");if(-1<e){t=t.substring(e);if(t in p)return t}return null}function u(t,e){try{if(d.isString(e)&&"{"===e.charAt(0)&&(e=JSON.parse(e)),d.isString(e)){v.filename=t;var i,s=v(e,a,n),r=0;if(s.imports)for(;r<s.imports.length;++r)(i=l(s.imports[r])||a.resolvePath(t,s.imports[r]))&&c(i);if(s.weakImports)for(r=0;r<s.weakImports.length;++r)(i=l(s.weakImports[r])||a.resolvePath(t,s.weakImports[r]))&&c(i,!0)}else a.setOptions(e.options).addJSON(e.nested)}catch(t){o(t)}h||f||o(null,a)}function c(i,s){if(!(-1<a.files.indexOf(i)))if(a.files.push(i),i in p)h?u(i,p[i]):(++f,setTimeout(function(){--f,u(i,p[i])}));else if(h){var t;try{t=d.fs.readFileSync(i).toString("utf8")}catch(t){return void(s||o(t))}u(i,t)}else++f,a.fetch(i,function(t,e){--f,r&&(t?s?f||o(null,a):o(t):u(i,e))})}var f=0;d.isString(e)&&(e=[e]);for(var i,s=0;s<e.length;++s)(i=a.resolvePath("",e[s]))&&c(i);if(h)return a;f||o(null,a)},i.prototype.loadSync=function(t,e){if(d.isNode)return this.load(t,e,m);throw Error("not supported")},i.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map(function(t){return"'extend "+t.extend+"' in "+t.parent.fullName}).join(", "));return s.prototype.resolveAll.call(this)},o=/^[A-Z]/,i.prototype._h=function(t){if(t instanceof r)void 0===t.extend||t.extensionField||l(0,t)||this.deferred.push(t);else if(t instanceof n)o.test(t.name)&&(t.parent[t.name]=t.values);else if(!(t instanceof a)){if(t instanceof h)for(var e=0;e<this.deferred.length;)l(0,this.deferred[e])?this.deferred.splice(e,1):++e;for(var i=0;i<t.nestedArray.length;++i)this._h(t.uh[i]);o.test(t.name)&&(t.parent[t.name]=t)}},i.prototype.wh=function(t){var e;if(t instanceof r)void 0!==t.extend&&(t.extensionField?(t.extensionField.parent.remove(t.extensionField),t.extensionField=null):-1<(e=this.deferred.indexOf(t))&&this.deferred.splice(e,1));else if(t instanceof n)o.test(t.name)&&delete t.parent[t.name];else if(t instanceof s){for(var i=0;i<t.nestedArray.length;++i)this.wh(t.uh[i]);o.test(t.name)&&delete t.parent[t.name]}},i.ah=function(t,e,i){h=t,v=e,p=i}),_p;function i(t){s.call(this,"",t),this.deferred=[],this.files=[]}function m(){}function l(t,e){var i,s=e.parent.lookup(e.extend);if(s)return((i=new r(e.fullName,e.id,e.type,e.rule,void 0,e.options)).declaringField=e).extensionField=i,s.add(i),1}}function Lp(){var i,t,s,r,e,n,a,h;return Mp||(Mp=1,i=T1.exports=Bv(),t=A1,i.codegen=R1,i.fetch=C1,i.path=O1,i.fs=i.inquire("fs"),i.toArray=function(t){if(t){for(var e=Object.keys(t),i=new Array(e.length),s=0;s<e.length;)i[s]=t[e[s++]];return i}return[]},i.toObject=function(t){for(var e={},i=0;i<t.length;){var s=t[i++],r=t[i++];void 0!==r&&(e[s]=r)}return e},e=/\\/g,n=/"/g,i.isReserved=function(t){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(t)},i.safeProp=function(t){return!/^[$\w_]+$/.test(t)||i.isReserved(t)?'["'+t.replace(e,"\\\\").replace(n,'\\"')+'"]':"."+t},i.ucFirst=function(t){return t.charAt(0).toUpperCase()+t.substring(1)},a=/_([a-z])/g,i.camelCase=function(t){return t.substring(0,1)+t.substring(1).replace(a,function(t,e){return e.toUpperCase()})},i.compareFieldsById=function(t,e){return t.id-e.id},i.decorateType=function(t,e){return t.$type?(e&&t.$type.name!==e&&(i.decorateRoot.remove(t.$type),t.$type.name=e,i.decorateRoot.add(t.$type)),t.$type):(e=new(s=s||Tp())(e||t.name),i.decorateRoot.add(e),e.ctor=t,Object.defineProperty(t,"$type",{value:e,enumerable:!1}),Object.defineProperty(t.prototype,"$type",{value:e,enumerable:!1}),e)},h=0,i.decorateEnum=function(t){var e;return t.$type||(e=new(r=r||Np())("Enum"+h++,t),i.decorateRoot.add(e),Object.defineProperty(t,"$type",{value:e,enumerable:!1}),e)},i.setProperty=function(t,e,i){if("object"!=typeof t)throw TypeError("dst must be an object");if(e)return function t(e,i,s){var r=i.shift();return"__proto__"!==r&&"prototype"!==r&&(0<i.length?e[r]=t(e[r]||{},i,s):((i=e[r])&&(s=[].concat(i).concat(s)),e[r]=s)),e}(t,e=e.split("."),i);throw TypeError("path must be specified")},Object.defineProperty(i,"decorateRoot",{get:function(){return t.decorated||(t.decorated=new(Rp()))}})),T1.exports}function Cp(){var a,e;return Ep||(Ep=1,(yp=t).className="ReflectionObject",a=Lp(),Object.defineProperties(t.prototype,{root:{get:function(){for(var t=this;null!==t.parent;)t=t.parent;return t}},fullName:{get:function(){for(var t=[this.name],e=this.parent;e;)t.unshift(e.name),e=e.parent;return t.join(".")}}}),t.prototype.toJSON=function(){throw Error()},t.prototype.onAdd=function(t){this.parent&&this.parent!==t&&this.parent.remove(this),this.parent=t,this.resolved=!1;t=t.root;t instanceof e&&t._h(this)},t.prototype.onRemove=function(t){t=t.root;t instanceof e&&t.wh(this),this.parent=null,this.resolved=!1},t.prototype.resolve=function(){return this.resolved||this.root instanceof e&&(this.resolved=!0),this},t.prototype.getOption=function(t){if(this.options)return this.options[t]},t.prototype.setOption=function(t,e,i){return i&&this.options&&void 0!==this.options[t]||((this.options||(this.options={}))[t]=e),this},t.prototype.setParsedOption=function(e,t,i){this.parsedOptions||(this.parsedOptions=[]);var s,r,n=this.parsedOptions;return i?(s=n.find(function(t){return Object.prototype.hasOwnProperty.call(t,e)}))?(r=s[e],a.setProperty(r,i,t)):((s={})[e]=a.setProperty({},i,t),n.push(s)):((r={})[e]=t,n.push(r)),this},t.prototype.setOptions=function(t,e){if(t)for(var i=Object.keys(t),s=0;s<i.length;++s)this.setOption(i[s],t[i[s]],e);return this},t.prototype.toString=function(){var t=this.constructor.className,e=this.fullName;return e.length?t+" "+e:t},t.ah=function(t){e=t}),yp;function t(t,e){if(!a.isString(t))throw TypeError("name must be a string");if(e&&!a.isObject(e))throw TypeError("options must be an object");this.options=e,this.parsedOptions=null,this.name=t,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}}function Np(){var h,e,s;return bp||(bp=1,xp=i,h=Cp(),((i.prototype=Object.create(h.prototype)).constructor=i).className="Enum",e=Q1(),s=Lp(),i.fromJSON=function(t,e){t=new i(t,e.values,e.options,e.comment,e.comments);return t.reserved=e.reserved,t},i.prototype.toJSON=function(t){t=!!t&&Boolean(t.keepComments);return s.toObject(["options",this.options,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"comment",t?this.comment:void 0,"comments",t?this.comments:void 0])},i.prototype.add=function(t,e,i){if(!s.isString(t))throw TypeError("name must be a string");if(!s.isInteger(e))throw TypeError("id must be an integer");if(void 0!==this.values[t])throw Error("duplicate name '"+t+"' in "+this);if(this.isReservedId(e))throw Error("id "+e+" is reserved in "+this);if(this.isReservedName(t))throw Error("name '"+t+"' is reserved in "+this);if(void 0!==this.valuesById[e]){if(!this.options||!this.options.allow_alias)throw Error("duplicate id "+e+" in "+this);this.values[t]=e}else this.valuesById[this.values[t]=e]=t;return this.comments[t]=i||null,this},i.prototype.remove=function(t){if(!s.isString(t))throw TypeError("name must be a string");var e=this.values[t];if(null==e)throw Error("name '"+t+"' does not exist in "+this);return delete this.valuesById[e],delete this.values[t],delete this.comments[t],this},i.prototype.isReservedId=function(t){return e.isReservedId(this.reserved,t)},i.prototype.isReservedName=function(t){return e.isReservedName(this.reserved,t)}),xp;function i(t,e,i,s,r){if(h.call(this,t,i),e&&"object"!=typeof e)throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=s,this.comments=r||{},this.reserved=void 0,e)for(var n=Object.keys(e),a=0;a<n.length;++a)"number"==typeof e[n[a]]&&(this.valuesById[this.values[n[a]]=e[n[a]]]=n[a])}}function Ip(){var l,u,c;return Ap||(Ap=1,Sp=function(t){for(var e,i=c.codegen(["m","w"],t.name+"$encode")("if(!w)")("w=Writer.create()"),s=t.fieldsArray.slice().sort(c.compareFieldsById),r=0;r<s.length;++r){var n=s[r].resolve(),a=t.dh.indexOf(n),h=n.resolvedType instanceof l?"int32":n.type,o=u.basic[h];e="m"+c.safeProp(n.name),n.map?(i("if(%s!=null&&Object.hasOwnProperty.call(m,%j)){",e,n.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",e)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(n.id<<3|2)>>>0,8|u.mapKey[n.keyType],n.keyType),void 0===o?i("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",a,e):i(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|o,h,e),i("}")("}")):n.repeated?(i("if(%s!=null&&%s.length){",e,e),n.packed&&void 0!==u.packed[h]?i("w.uint32(%i).fork()",(n.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",e)("w.%s(%s[i])",h,e)("w.ldelim()"):(i("for(var i=0;i<%s.length;++i)",e),void 0===o?f(i,n,a,e+"[i]"):i("w.uint32(%i).%s(%s[i])",(n.id<<3|o)>>>0,h,e)),i("}")):(n.optional&&i("if(%s!=null&&Object.hasOwnProperty.call(m,%j))",e,n.name),void 0===o?f(i,n,a,e):i("w.uint32(%i).%s(%s)",(n.id<<3|o)>>>0,h,e))}return i("return w")},l=Np(),u=K1(),c=Lp()),Sp;function f(t,e,i,s){e.resolvedType.group?t("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",i,s,(e.id<<3|3)>>>0,(e.id<<3|4)>>>0):t("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",i,s,(e.id<<3|2)>>>0)}}(()=>{var a=sp;pp[".google.protobuf.Any"]={fromObject:function(t){if(t&&t["@type"]){var e,i=t["@type"].substring(t["@type"].lastIndexOf("/")+1),i=this.lookup(i);if(i)return-1===(e="."===t["@type"].charAt(0)?t["@type"].substr(1):t["@type"]).indexOf("/")&&(e="/"+e),this.create({type_url:e,value:i.encode(i.fromObject(t)).finish()})}return this.fromObject(t)},toObject:function(t,e){var i,s,r="",n="";return!((t=e&&e.json&&t.type_url&&t.value&&(n=t.type_url.substring(t.type_url.lastIndexOf("/")+1),r=t.type_url.substring(0,t.type_url.lastIndexOf("/")+1),i=this.lookup(n))?i.decode(t.value):t)instanceof this.ctor)&&t instanceof a?(i=t.$type.toObject(t,e),s="."===t.$type.fullName[0]?t.$type.fullName.substr(1):t.$type.fullName,i["@type"]=n=(r=""===r?"type.googleapis.com/":r)+s,i):this.toObject(t,e)}}})();var r=uv.exports=cv;function Pp(t,e,i){return(e="function"==typeof e?(i=e,new r.Root):e||new r.Root).load(t,i)}function Dp(t,e){return(e=e||new r.Root).loadSync(t)}r.build="light",r.load=Pp,r.loadSync=Dp,r.encoder=Ip(),r.decoder=up(),r.verifier=cp(),r.converter=vp(),r.ReflectionObject=Cp(),r.Namespace=Q1(),r.Root=Rp(),r.Enum=Np(),r.Type=Tp(),r.Field=J1(),r.OneOf=$1(),r.MapField=tp(),r.Service=ip(),r.Method=ep(),r.Message=sp,r.wrappers=pp,r.types=K1(),r.util=Lp(),r.ReflectionObject.ah(r.Root),r.Namespace.ah(r.Type,r.Service,r.Enum),r.Root.ah(r.Type),r.Field.ah(r.Type);var Op=uv.exports,Up=Op,Fp=oa(Up),Bp=["TmF2aVNlZ21lbg==","YWNjZXNzaWJsZQ==","Zmlk","bmZv","Rmxvb3JHZW8=","bGlmdFR5cGU=","bGVu","dmVs","ZXh0ZW50TGF5ZQ==","RXh0ZW50Qml6SQ==","cmVhZE9ubHk=","LnByb3RvYnVm","aW50MzI=","ZG9vcnR5cGU=","R0VPUE9JTlRfTQ==","TmF2aVpvbmU=","ZW50cmFuY2VGbA==","bGVuZ3Ro","ZWxCaXpJbmZv","c3RhaXJMYXllcg==","dG9CaWQ=","R2F0ZQ==","b2Zmc2V0WQ==","Zmlkcw==","aXNTZWxlY3RhYg==","ZmxhZw==","ZXh0ZXJuYWxNbw==","bGlmdEVudHJ5","VklTRUdNRU5U","SW5kZXhJbmZv","ZGF0YQ==","ZGVsQml6SW5mbw==","bWlk","cG9pTGF5ZXI=","bW9kZWxpZA==","cGFja2Vk","dGhyb3VnaA==","bmF2aVNlZ21lbg==","bGlmdExheWVy","cmVwZWF0ZWQ=","ZGVmQ2VuWQ==","b29y","bm9kZUlk","TmF2aU1vZGVs","cmFuaw==","c25vZGU=","cHRz","ZGVmR2lk","aGFzaENvZGU=","bmVzdGVk","Ymlk","cmVxdWlyZWQ=","R0VPTElORV9OQQ==","b2Zmc2V0WA==","TmF2aU5vZGU=","bHR5cGU=","T1ZFUkxBWURBVA==","ZGVmQ2VuWA==","b3B0aW9ucw==","YmFzZUxldmVs","YXJlYQ==","TGF5ZXJHcm91cA==","ZmllbGRz","cGFzcw==","Zmxvb3Jz","SUZU","Rmxvb3JOYXZp","amF2YV9vdXRlcg==","UG9seWdvbkxhYg==","ZW50cmFuY2VUeQ==","VHlwZQ==","bmF2aVpvbmVz","ZWxMYXllcg==","YWxpYXM=","d2lkdGg=","YXllcg==","ZW50cnl0eXBlcw==","TGlmdEJpekluZg==","bm9kZXR5cGVz","amF2YV9wYWNrYQ==","bmF2aVR5cGU=","ZGF0ZVZlcg==","bGlmdEZsYWc=","Z2lk","bWF4WA==","bW5hbWU=","bWluU2NhbGVMZQ==","Zmxvb3JJZA==","X2NsYXNzbmFtZQ==","TW9kZWxCaXpJbg==","Zmxvb3I=","bmFtZQ==","c2NhbGVMZXZlbA==","RXh0ZXJuYWxNbw==","cGdpZA==","ZmlsZVZlcg==","VEFJUg==","bWlubGV2ZWw=","Rmxvb3JDb25maQ==","R2VuZXJhbEdlbw==","ZHJpdmU=","Ym9vbA==","a2V5","R0VPUE9MWUdPTg==","dG9HaWQ=","ZGVmQ2VuWg==","YnR5cGU=","R0VPUE9JTlRfUw==","cC5wbGF0Zm9ybQ==","TmF2aUZsb29y","ZmxvYXQ=","bmF2aUV4dGVudA==","UE9JQml6SW5mbw==","TGFiZWxCaXpJbg==","TGF5ZXI=","cnVsZQ==","bGlk","Y29tLmZlbmdtYQ==","c2NhbGU=","c2VnbWVudElk","ZGVzYw==","ZGVsTGF5ZXI=","R0VPUE9JTlRfUA==","cm90YXRlQW5nbA==","X0xBQkVM","cG9seWdvbkxheQ==","ZmlsZURhdGU=","R0VPUE9JTlRfTA==","U3RhaXJCaXpJbg==","ZXNjYWxhdG9yTA==","bGlua1NlZw==","QnVmZmVy","TmF2aUV4dGVudA==","Z2Vv","R0VPTElORQ==","bmF2aU5vZGVz","cmVqZWN0cw==","UG9seWdvbkJpeg==","aXNWaXNpYmxl","b25zaGlw","YnVmZmVycw==","bWF4bGV2ZWw=","ZG91Ymxl","R0VPUE9JTlRfRQ==","bmF2aQ==","Rmxvb3JCaXo=","Z1Byb3RvQnVm","T0RFTA==","ZW5hbWU=","bW9kZWxMYXllcg==","a2V5cw==","ZWlk","bGF5ZXJz","QU5PUkFNQQ==","UkRFUg==","R0VPUE9JTlQ=","QnVpbGRpbmc=","bWluWA==","TWFw","aGVpZ2h0","c3RyaW5n","dHlwZQ==","ZGVmYXVsdA==","cG9seWdvbkxhYg==","TmF2aVJlbGF0aQ==","dWludDY0","aWR4cw==","SW5mbw==","X0VYVEVOVA=="];(t=>{for(var e=218;--e;)t.push(t.shift())})(Bp);class kp{constructor(){this.id={nested:{protobuf:{options:{java_package:"com.fengmap.platform.protobuf",java_outer_classname:"FloorConfigProtoBuf"},nested:{Map:{fields:{mid:{rule:"required",type:"string",id:1},fileVer:{rule:"required",type:"int32",id:2},dateVer:{rule:"required",type:"uint64",id:3},mname:{rule:"required",type:"string",id:4},hashCode:{rule:"required",type:"string",id:5},key:{type:"string",id:6},fileDate:{type:"string",id:7},desc:{type:"string",id:8},readOnly:{type:"bool",id:9,options:{default:!1}},buffers:{rule:"repeated",type:"Buffer",id:10},keys:{rule:"repeated",type:"string",id:11}},nested:{Buffer:{fields:{gid:{rule:"required",type:"int32",id:1},fileVer:{rule:"required",type:"int32",id:2},btype:{rule:"required",type:"int32",id:3},len:{rule:"required",type:"uint64",id:4},data:{rule:"required",type:"bytes",id:5}}}}},Scene:{fields:{mid:{rule:"required",type:"string",id:19},fileVer:{rule:"required",type:"int32",id:20},dateVer:{rule:"required",type:"uint64",id:21},mname:{rule:"required",type:"string",id:22},hashCode:{rule:"required",type:"string",id:23},key:{type:"string",id:24},desc:{type:"string",id:25},readOnly:{type:"bool",id:26,options:{default:!1}},x:{type:"float",id:1},y:{type:"float",id:2},z:{type:"float",id:3},minX:{type:"float",id:4},minY:{type:"float",id:5},maxX:{type:"float",id:6},maxY:{type:"float",id:7},defGid:{type:"string",id:8},defCenX:{type:"float",id:9},defCenY:{type:"float",id:10},defCenZ:{type:"float",id:11},height:{type:"float",id:12},rotateAngleX:{type:"float",id:13},rotateAngleY:{type:"float",id:14},rotateAngleZ:{type:"float",id:15},scale:{type:"float",id:16},scaleLevel:{type:"string",id:17},naviType:{type:"int32",id:28},layerGroups:{rule:"repeated",type:"LayerGroup",id:18},buildings:{rule:"repeated",type:"Building",id:27}},nested:{Layer:{fields:{lid:{type:"int32",id:1},lname:{type:"string",id:2},alias:{type:"string",id:3},ltype:{type:"Type",id:4},offsetX:{type:"float",id:5},offsetY:{type:"float",id:6},height:{type:"float",id:7},rotateAngleX:{type:"float",id:8},rotateAngleY:{type:"float",id:9},rotateAngleZ:{type:"float",id:10},minScaleLevel:{type:"float",id:11},maxScaleLevel:{type:"float",id:12},isVisible:{type:"bool",id:13},isSelectable:{type:"bool",id:14},isEditable:{type:"bool",id:15},desc:{type:"string",id:16}},nested:{Type:{values:{GEOPOINT:1,GEOPOINT_ESCALATOR:2,GEOPOINT_LIFT:3,GEOPOINT_STAIR:4,GEOPOINT_PANORAMA:5,GEOPOINT_POI:6,GEOPOINT_STORELABEL:7,GEOPOINT_NAVINODE:8,GEOPOINT_MODEL:9,GEOLINE:20,GEOLINE_NAVISEGMENT:21,GEOLINE_BORDER:22,GEOPOLYGON:30,GEOPOLYGON_EXTENT:31,GEOPOLYGON_STORE:32,GEOPOLYGON_LABEL:33,RASTERATA:40,OVERLAYDATA:50}}}},LayerGroup:{fields:{gid:{type:"int32",id:1},gname:{type:"string",id:2},alias:{type:"string",id:3},height:{type:"float",id:4},desc:{type:"string",id:5},layers:{rule:"repeated",type:"Layer",id:6},floorId:{type:"string",id:7},naviType:{type:"int32",id:8}}},Floor:{fields:{gid:{type:"int32",id:1},x:{type:"float",id:2},y:{type:"float",id:3},offsetX:{type:"float",id:4},offsetY:{type:"float",id:5},angle:{type:"float",id:6},scale:{type:"float",id:7},fids:{rule:"repeated",type:"string",id:8},pgid:{type:"int32",id:9},baseLevel:{type:"bool",id:10},minlevel:{type:"int32",id:11},maxlevel:{type:"int32",id:12},floorId:{type:"string",id:13},idxs:{rule:"repeated",type:"IndexInfo",id:14},pts:{rule:"repeated",type:"double",id:15,options:{packed:!1}}},nested:{IndexInfo:{fields:{idxs:{rule:"repeated",type:"int32",id:1,options:{packed:!1}}}}}},Building:{fields:{bid:{type:"string",id:1},name:{type:"string",id:2},ename:{type:"string",id:3},alias:{type:"string",id:4},x:{type:"float",id:5},y:{type:"float",id:6},mid:{type:"string",id:7},version:{type:"int32",id:8},floors:{rule:"repeated",type:"Floor",id:9},bcode:{type:"int32",id:10}}}}},Gate:{fields:{mid:{rule:"required",type:"string",id:1},floors:{rule:"repeated",type:"NaviFloor",id:2}},nested:{NaviFloor:{fields:{gid:{type:"int32",id:1},floorId:{type:"string",id:2},bid:{type:"string",id:3},mid:{type:"string",id:4},navi:{rule:"repeated",type:"NaviRelationship",id:5},drive:{rule:"repeated",type:"NaviRelationship",id:6},accessible:{rule:"repeated",type:"NaviRelationship",id:7}}},NaviRelationship:{fields:{eid:{rule:"required",type:"int32",id:1},type:{type:"int32",id:2},accessible:{type:"int32",id:3},idxs:{rule:"repeated",type:"IndexInfo",id:4},pts:{rule:"repeated",type:"double",id:5,options:{packed:!1}},flag:{type:"int32",id:6},toBid:{rule:"repeated",type:"string",id:7},toGid:{rule:"repeated",type:"string",id:8}},nested:{IndexInfo:{fields:{idxs:{rule:"repeated",type:"int32",id:1,options:{packed:!1}}}}}}}},FloorGeo:{fields:{mid:{rule:"required",type:"string",id:1},gid:{rule:"required",type:"int32",id:2},height:{type:"float",id:3},extentLayer:{rule:"repeated",type:"GeneralGeoInfo",id:4},modelLayer:{rule:"repeated",type:"GeneralGeoInfo",id:5},labelLayer:{rule:"repeated",type:"GeneralGeoInfo",id:6},poiLayer:{rule:"repeated",type:"GeneralGeoInfo",id:7},polygonLayer:{rule:"repeated",type:"GeneralGeoInfo",id:8},polygonLabelLayer:{rule:"repeated",type:"GeneralGeoInfo",id:9},liftLayer:{rule:"repeated",type:"GeneralGeoInfo",id:10},stairLayer:{rule:"repeated",type:"GeneralGeoInfo",id:11},escalatorLayer:{rule:"repeated",type:"GeneralGeoInfo",id:12},externalModelLayer:{rule:"repeated",type:"GeneralGeoInfo",id:13}},nested:{GeneralGeoInfo:{fields:{eid:{rule:"required",type:"int32",id:1},geo:{type:"string",id:2},height:{type:"float",id:3},area:{type:"float",id:4},idxs:{rule:"repeated",type:"IndexInfo",id:5},pts:{rule:"repeated",type:"double",id:6,options:{packed:!1}},baseheight:{type:"float",id:7}},nested:{IndexInfo:{fields:{idxs:{rule:"repeated",type:"int32",id:1,options:{packed:!1}}}}}}}},FloorBiz:{fields:{mid:{rule:"required",type:"string",id:1},gid:{rule:"required",type:"int32",id:2},extentLayer:{rule:"repeated",type:"ExtentBizInfo",id:3},modelLayer:{rule:"repeated",type:"ModelBizInfo",id:4},labelLayer:{rule:"repeated",type:"LabelBizInfo",id:5},poiLayer:{rule:"repeated",type:"POIBizInfo",id:6},polygonLayer:{rule:"repeated",type:"PolygonBizInfo",id:7},liftLayer:{rule:"repeated",type:"LiftBizInfo",id:8},stairLayer:{rule:"repeated",type:"StairBizInfo",id:9},polygonLabelLayer:{rule:"repeated",type:"PolygonLabelBizInfo",id:10},externalModelLayer:{rule:"repeated",type:"ExternalModelBizInfo",id:11}},nested:{ExtentBizInfo:{fields:{eid:{rule:"required",type:"int32",id:1},fid:{type:"string",id:2},type:{type:"int32",id:3},name:{type:"string",id:4},ename:{type:"string",id:5},minlevel:{type:"int32",id:6},maxlevel:{type:"int32",id:7}}},ModelBizInfo:{fields:{eid:{rule:"required",type:"int32",id:1},fid:{type:"string",id:2},type:{type:"int32",id:3},name:{type:"string",id:4},ename:{type:"string",id:5},minlevel:{type:"int32",id:6},maxlevel:{type:"int32",id:7},pass:{type:"int32",id:8}}},LabelBizInfo:{fields:{eid:{rule:"required",type:"int32",id:1},fid:{type:"string",id:2},type:{type:"int32",id:3},name:{type:"string",id:4},ename:{type:"string",id:5},minlevel:{type:"int32",id:6},maxlevel:{type:"int32",id:7}}},PolygonBizInfo:{fields:{eid:{rule:"required",type:"int32",id:1},fid:{type:"string",id:2},type:{type:"int32",id:3},name:{type:"string",id:4},ename:{type:"string",id:5},minlevel:{type:"int32",id:6},maxlevel:{type:"int32",id:7}}},POIBizInfo:{fields:{eid:{rule:"required",type:"int32",id:1},fid:{type:"string",id:2},type:{type:"int32",id:3},name:{type:"string",id:4},ename:{type:"string",id:5},minlevel:{type:"int32",id:6},maxlevel:{type:"int32",id:7}}},LiftBizInfo:{fields:{eid:{rule:"required",type:"int32",id:1},fid:{type:"string",id:2},type:{type:"int32",id:3},flag:{type:"int32",id:4},floor:{type:"string",id:5},minlevel:{type:"int32",id:6},maxlevel:{type:"int32",id:7}}},StairBizInfo:{fields:{eid:{rule:"required",type:"int32",id:1},fid:{type:"string",id:2},type:{type:"int32",id:3},flag:{type:"int32",id:4},minlevel:{type:"int32",id:5},maxlevel:{type:"int32",id:6}}},PolygonLabelBizInfo:{fields:{eid:{rule:"required",type:"int32",id:1},fid:{type:"string",id:2},type:{type:"int32",id:3},width:{type:"float",id:4},name:{type:"string",id:5},ename:{type:"string",id:6},angle:{type:"float",id:7}}},ExternalModelBizInfo:{fields:{eid:{rule:"required",type:"int32",id:1},fid:{type:"string",id:2},type:{type:"int32",id:3},name:{type:"string",id:4},ename:{type:"string",id:5},minlevel:{type:"int32",id:6},maxlevel:{type:"int32",id:7}}}}},FloorNavi:{fields:{mid:{rule:"required",type:"string",id:1},gid:{rule:"required",type:"int32",id:2},naviNodes:{rule:"repeated",type:"NaviNode",id:3},naviSegments:{rule:"repeated",type:"NaviSegment",id:4},naviZones:{rule:"repeated",type:"NaviZone",id:5},naviModels:{rule:"repeated",type:"NaviModel",id:6},nextFloors:{rule:"repeated",type:"int32",id:7,options:{packed:!1}},naviExtents:{rule:"repeated",type:"NaviExtent",id:8}},nested:{NaviNode:{fields:{nodeId:{type:"int32",id:1},nodeType:{type:"int32",id:2},liftType:{type:"int32",id:3},liftFlag:{type:"int32",id:4},liftEntry:{type:"int32",id:5},liftFloor:{type:"string",id:6},linkSeg:{type:"string",id:7},geo:{type:"string",id:8},entranceType:{type:"int32",id:9},entranceFloor:{type:"string",id:10},doortype:{type:"int32",id:11},idxs:{rule:"repeated",type:"int32",id:12,options:{packed:!1}},pts:{rule:"repeated",type:"double",id:13,options:{packed:!1}},accessible:{type:"int32",id:14,options:{default:0}}}},NaviSegment:{fields:{segmentId:{type:"int32",id:1},snode:{type:"int32",id:2},enode:{type:"int32",id:3},length:{type:"double",id:4},rank:{type:"int32",id:5},name:{type:"string",id:6},entry:{type:"int32",id:7},desc:{type:"string",id:8},geo:{type:"string",id:9},through:{type:"int32",id:10},idxs:{rule:"repeated",type:"int32",id:11,options:{packed:!1}},pts:{rule:"repeated",type:"double",id:12,options:{packed:!1}}}},NaviZone:{fields:{id:{rule:"required",type:"int32",id:1},type:{rule:"required",type:"int32",id:2,options:{default:0}},geo:{type:"string",id:3},rejects:{rule:"repeated",type:"string",id:4},idxs:{rule:"repeated",type:"int32",id:5,options:{packed:!1}},pts:{rule:"repeated",type:"double",id:6,options:{packed:!1}}}},NaviModel:{fields:{modelid:{rule:"required",type:"int32",id:1},doorids:{rule:"repeated",type:"int32",id:2,options:{packed:!1}},nodetypes:{rule:"repeated",type:"int32",id:3,options:{packed:!1}},entrytypes:{rule:"repeated",type:"int32",id:4,options:{packed:!1}}}},NaviExtent:{fields:{id:{rule:"required",type:"int32",id:1},pts:{rule:"repeated",type:"double",id:2,options:{packed:!1}},idxs:{rule:"repeated",type:"IndexInfo",id:3}},nested:{IndexInfo:{fields:{idxs:{rule:"repeated",type:"int32",id:1,options:{packed:!1}}}}}}}}}}}}}}class Gp{constructor(){this.Mh=null}}Object.assign(Gp.prototype,{yh(){this.Mh||(this.Mh=Fp.Root.fromJSON((new("undefined"!=typeof KjWzhWlSj&&KjWzhWlSj.ProtoDef?KjWzhWlSj.ProtoDef:kp)).id))},Eh(t){return this.yh(),this.Mh.lookup("Map").decode(t)},xh(e){for(let t=0;t<e.buffers.length;t++){var i=e.buffers[t];if(1==i.btype)return this.bh(i.data)}return null},Sh(e){for(let t=0;t<e.buffers.length;t++){var i=e.buffers[t];if(7==i.btype)return this.Ah(i.data)}return null},Th(e,i){for(let t=0;t<e.buffers.length;t++){var s=e.buffers[t];if(2==s.btype&&s.gid==i)return this.Rh(s.data)}return null},Lh(e,i){for(let t=0;t<e.buffers.length;t++){var s=e.buffers[t];if(3==s.btype&&s.gid==i)return this.Ch(s.data)}return null},Nh(e,i){for(let t=0;t<e.buffers.length;t++){var s=e.buffers[t];if(4==s.btype&&s.gid==i)return this.Ih(s.data)}return null},Ph(e,i){for(let t=0;t<e.buffers.length;t++){var s=e.buffers[t];if(5===s.btype&&s.gid===i)return this.Ih(s.data)}return null},Dh(e,i){for(let t=0;t<e.buffers.length;t++){var s=e.buffers[t];if(6===s.btype&&s.gid===i)return this.Ih(s.data)}return null},bh(t){this.yh();let e=this.Mh.lookup("Scene").decode(t);return e.levels=[],e.layerGroups.forEach(t=>{e.levels.push(t.gid)}),e},Ah(t){return this.yh(),this.Mh.lookup("Gate").decode(t)},Rh(t){return this.yh(),this.Mh.lookup("FloorGeo").decode(t)},Ch(t){return this.yh(),this.Mh.lookup("FloorBiz").decode(t)},Ih(t){return this.yh(),this.Mh.lookup("FloorNavi").decode(t)}});class Hp{constructor(){var t;nt.environment===I.WX?this.Oh=new nt.ProtoReaderStatic:void 0!==ov.global().KjWzhWlSj&&ov.global().KjWzhWlSj.ProtoReaderStatic?(t=ov.global().KjWzhWlSj.ProtoReaderStatic,this.Oh=new t):this.Oh=new Gp}}Object.assign(Hp.prototype,{Eh(t){return this.Oh.Eh(t)},xh(t){return this.Oh.xh(t)},Sh(t){return this.Oh.Sh(t)},Th(t,e){return this.Oh.Th(t,e)},Lh(t,e){return this.Oh.Lh(t,e)},Nh(t,e){return this.Oh.Nh(t,e)},Ph(t,e){return this.Oh.Ph(t,e)},Dh(t,e){return this.Oh.Dh(t,e)},bh(t){return this.Oh.bh(t)},Ah(t){return this.Oh.Ah(t)},Rh(t){return this.Oh.Rh(t)},Ch(t){return this.Oh.Ch(t)},Ih(t){return this.Oh.Ih(t)}});let Vp="https://console.fengmap.com/api-s/",zp="https://console.fengmap.cool/api-s/",Wp={domain:Vp,online:Vp+"sdk/check",check:Vp+"sdk/auth/web",download:Vp+"sdk/auth/obtainMapRoute",downloadTile:Vp+"sdk/authLayered/obtainMapRoute",collect:Vp+"sdk/collect",themeUrl:Vp+"webtheme/",externalModelURL:Vp+"webmodel/"},jp=function(){Wp={domain:zp,online:zp+"sdk/check",check:zp+"sdk/auth/web",download:zp+"sdk/auth/obtainMapRoute",downloadTile:zp+"sdk/authLayered/obtainMapRoute",collect:zp+"sdk/collect",themeUrl:zp+"webtheme/",externalModelURL:zp+"webmodel/"}},Xp=(()=>{function v(t,e){for(var i,s=0,r=0,r=0;r<8;r++)1&e&&(s^=t),i=128&t,t<<=1,i&&(t^=27),e>>=1;return s}function p(t,e,i){for(var s=0;s<4;s++)t[0+s]^=e[16*i+4*s],t[4+s]^=e[16*i+4*s+1],t[8+s]^=e[16*i+4*s+2],t[12+s]^=e[16*i+4*s+3]}function m(t){for(var e,i,s,r=1;r<4;r++)for(i=0;i<r;){for(s=t[4*r+4-1],e=3;0<e;e--)t[4*r+e]=t[4*r+e-1];t[4*r+0]=s,i++}}function g(t){for(var e,i,s=0;s<4;s++)for(e=0;e<4;e++)i=(240&t[4*s+e])>>4,t[4*s+e]=r[16*i+(15&t[4*s+e])]}function _(t){for(var e=0;e<4;e++)t[e]=i[16*((240&t[e])>>4)+(15&t[e])]}function w(t){return parseInt(t,16)}var i=[99,124,119,123,242,107,111,197,48,1,103,43,254,215,171,118,202,130,201,125,250,89,71,240,173,212,162,175,156,164,114,192,183,253,147,38,54,63,247,204,52,165,229,241,113,216,49,21,4,199,35,195,24,150,5,154,7,18,128,226,235,39,178,117,9,131,44,26,27,110,90,160,82,59,214,179,41,227,47,132,83,209,0,237,32,252,177,91,106,203,190,57,74,76,88,207,208,239,170,251,67,77,51,133,69,249,2,127,80,60,159,168,81,163,64,143,146,157,56,245,188,182,218,33,16,255,243,210,205,12,19,236,95,151,68,23,196,167,126,61,100,93,25,115,96,129,79,220,34,42,144,136,70,238,184,20,222,94,11,219,224,50,58,10,73,6,36,92,194,211,172,98,145,149,228,121,231,200,55,109,141,213,78,169,108,86,244,234,101,122,174,8,186,120,37,46,28,166,180,198,232,221,116,31,75,189,139,138,112,62,181,102,72,3,246,14,97,53,87,185,134,193,29,158,225,248,152,17,105,217,142,148,155,30,135,233,206,85,40,223,140,161,137,13,191,230,66,104,65,153,45,15,176,84,187,22],r=[82,9,106,213,48,54,165,56,191,64,163,158,129,243,215,251,124,227,57,130,155,47,255,135,52,142,67,68,196,222,233,203,84,123,148,50,166,194,35,61,238,76,149,11,66,250,195,78,8,46,161,102,40,217,36,178,118,91,162,73,109,139,209,37,114,248,246,100,134,104,152,22,212,164,92,204,93,101,182,146,108,112,72,80,253,237,185,218,94,21,70,87,167,141,157,132,144,216,171,0,140,188,211,10,247,228,88,5,184,179,69,6,208,44,30,143,202,63,15,2,193,175,189,3,1,19,138,107,58,145,17,65,79,103,220,234,151,242,207,206,240,180,230,115,150,172,116,34,231,173,53,133,226,249,55,232,28,117,223,110,71,241,26,113,29,41,197,137,111,183,98,14,170,24,190,27,252,86,62,75,198,210,121,32,154,219,192,254,120,205,90,244,31,221,168,51,136,7,199,49,177,18,16,89,39,128,236,95,96,81,127,169,25,181,74,13,45,229,122,159,147,201,156,239,160,224,59,77,174,42,245,176,200,235,187,60,131,83,153,97,23,43,4,126,186,119,214,38,225,105,20,99,85,33,12,125],M=0,y=0,E=[2,0,0,0];return{decryption:function(t,e){for(var i=Array(16),s=0;s<16;s++)i[s]=16*w(e.substr(2*s,1))+w(e.substr(2*s+1,1));var r=Array(16);for(s=0;s<16;s++)r[s]=16*w(t.substr(2*s,1))+w(t.substr(2*s+1,1));var n=Array(16);switch(s=[],i.length){default:case 16:M=4,y=10;break;case 24:M=6,y=12;break;case 32:M=8,y=14}for(var a=s=Array(16*(y+1)),h=Array(4),o=4*(y+1),l=0;l<M;l++)a[4*l+0]=i[4*l+0],a[4*l+1]=i[4*l+1],a[4*l+2]=i[4*l+2],a[4*l+3]=i[4*l+3];for(l=M;l<o;l++){if(h[0]=a[4*(l-1)+0],h[1]=a[4*(l-1)+1],h[2]=a[4*(l-1)+2],h[3]=a[4*(l-1)+3],0==l%M){for(var u=void 0,c=void 0,u=(i=h)[0],c=0;c<3;c++)i[c]=i[c+1];if(i[3]=u,_(h),1==(i=l/M))E[0]=1;else if(1<i)for(E[0]=2,i--;0<i-1;)E[0]=v(E[0],2),i--;(c=i=h)[0]=i[0]^(u=E)[0],c[1]=i[1]^u[1],c[2]=i[2]^u[2],c[3]=i[3]^u[3]}else 6<M&&4==l%M&&_(h);a[4*l+0]=a[4*(l-M)+0]^h[0],a[4*l+1]=a[4*(l-M)+1]^h[1],a[4*l+2]=a[4*(l-M)+2]^h[2],a[4*l+3]=a[4*(l-M)+3]^h[3]}for(a=Array(16),h=0;h<4;h++)for(l=0;l<4;l++)a[4*h+l]=r[h+4*l];for(p(a,s,y),r=y-1;1<=r;r--)for(m(a),g(a),p(a,s,r),h=a,l=[14,9,13,11],o=c=void 0,i=Array(4),u=Array(4),o=0;o<4;o++){for(c=0;c<4;c++)i[c]=h[4*c+o];var c=l,f=i,d=u;for(d[0]=v(c[0],f[0])^v(c[3],f[1])^v(c[2],f[2])^v(c[1],f[3]),d[1]=v(c[1],f[0])^v(c[0],f[1])^v(c[3],f[2])^v(c[2],f[3]),d[2]=v(c[2],f[0])^v(c[1],f[1])^v(c[0],f[2])^v(c[3],f[3]),d[3]=v(c[3],f[0])^v(c[2],f[1])^v(c[1],f[2])^v(c[0],f[3]),c=0;c<4;c++)h[4*c+o]=u[c]}for(m(a),g(a),p(a,s,0),h=0;h<4;h++)for(l=0;l<4;l++)n[h+4*l]=a[4*h+l];for(r="",s=0;s<16;++s)r+=a=(a=n[s].toString(16)).length<2?"0"+a:a;return r}}})(),Yp=(()=>{function c(t,e){var i=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(i>>16)<<16|65535&i}function h(t,e,i,s,r,n){return c((e=c(c(e,t),c(s,n)))<<r|e>>>32-r,i)}function f(t,e,i,s,r,n,a){return h(e&i|~e&s,t,e,r,n,a)}function d(t,e,i,s,r,n,a){return h(e&s|i&~s,t,e,r,n,a)}function v(t,e,i,s,r,n,a){return h(e^i^s,t,e,r,n,a)}function p(t,e,i,s,r,n,a){return h(i^(e|~s),t,e,r,n,a)}function a(t,e){t[e>>5]|=128<<e%32,t[14+(e+64>>>9<<4)]=e;for(var i,s,r,n,a=1732584193,h=-271733879,o=-1732584194,l=271733878,u=0;u<t.length;u+=16)a=f(i=a,s=h,r=o,n=l,t[u],7,-680876936),l=f(l,a,h,o,t[u+1],12,-389564586),o=f(o,l,a,h,t[u+2],17,606105819),h=f(h,o,l,a,t[u+3],22,-1044525330),a=f(a,h,o,l,t[u+4],7,-176418897),l=f(l,a,h,o,t[u+5],12,1200080426),o=f(o,l,a,h,t[u+6],17,-1473231341),h=f(h,o,l,a,t[u+7],22,-45705983),a=f(a,h,o,l,t[u+8],7,1770035416),l=f(l,a,h,o,t[u+9],12,-1958414417),o=f(o,l,a,h,t[u+10],17,-42063),h=f(h,o,l,a,t[u+11],22,-1990404162),a=f(a,h,o,l,t[u+12],7,1804603682),l=f(l,a,h,o,t[u+13],12,-40341101),o=f(o,l,a,h,t[u+14],17,-1502002290),a=d(a,h=f(h,o,l,a,t[u+15],22,1236535329),o,l,t[u+1],5,-165796510),l=d(l,a,h,o,t[u+6],9,-1069501632),o=d(o,l,a,h,t[u+11],14,643717713),h=d(h,o,l,a,t[u],20,-373897302),a=d(a,h,o,l,t[u+5],5,-701558691),l=d(l,a,h,o,t[u+10],9,38016083),o=d(o,l,a,h,t[u+15],14,-660478335),h=d(h,o,l,a,t[u+4],20,-405537848),a=d(a,h,o,l,t[u+9],5,568446438),l=d(l,a,h,o,t[u+14],9,-1019803690),o=d(o,l,a,h,t[u+3],14,-187363961),h=d(h,o,l,a,t[u+8],20,1163531501),a=d(a,h,o,l,t[u+13],5,-1444681467),l=d(l,a,h,o,t[u+2],9,-51403784),o=d(o,l,a,h,t[u+7],14,1735328473),a=v(a,h=d(h,o,l,a,t[u+12],20,-1926607734),o,l,t[u+5],4,-378558),l=v(l,a,h,o,t[u+8],11,-2022574463),o=v(o,l,a,h,t[u+11],16,1839030562),h=v(h,o,l,a,t[u+14],23,-35309556),a=v(a,h,o,l,t[u+1],4,-1530992060),l=v(l,a,h,o,t[u+4],11,1272893353),o=v(o,l,a,h,t[u+7],16,-155497632),h=v(h,o,l,a,t[u+10],23,-1094730640),a=v(a,h,o,l,t[u+13],4,681279174),l=v(l,a,h,o,t[u],11,-358537222),o=v(o,l,a,h,t[u+3],16,-722521979),h=v(h,o,l,a,t[u+6],23,76029189),a=v(a,h,o,l,t[u+9],4,-640364487),l=v(l,a,h,o,t[u+12],11,-421815835),o=v(o,l,a,h,t[u+15],16,530742520),a=p(a,h=v(h,o,l,a,t[u+2],23,-995338651),o,l,t[u],6,-198630844),l=p(l,a,h,o,t[u+7],10,1126891415),o=p(o,l,a,h,t[u+14],15,-1416354905),h=p(h,o,l,a,t[u+5],21,-57434055),a=p(a,h,o,l,t[u+12],6,1700485571),l=p(l,a,h,o,t[u+3],10,-1894986606),o=p(o,l,a,h,t[u+10],15,-1051523),h=p(h,o,l,a,t[u+1],21,-2054922799),a=p(a,h,o,l,t[u+8],6,1873313359),l=p(l,a,h,o,t[u+15],10,-30611744),o=p(o,l,a,h,t[u+6],15,-1560198380),h=p(h,o,l,a,t[u+13],21,1309151649),a=p(a,h,o,l,t[u+4],6,-145523070),l=p(l,a,h,o,t[u+11],10,-1120210379),o=p(o,l,a,h,t[u+2],15,718787259),h=p(h,o,l,a,t[u+9],21,-343485551),a=c(a,i),h=c(h,s),o=c(o,r),l=c(l,n);return[a,h,o,l]}function o(t){for(var e="",i=32*t.length,s=0;s<i;s+=8)e+=String.fromCharCode(t[s>>5]>>>s%32&255);return e}function l(t){var e=[];for(e[(t.length>>2)-1]=void 0,s=0;s<e.length;s+=1)e[s]=0;for(var i=8*t.length,s=0;s<i;s+=8)e[s>>5]|=(255&t.charCodeAt(s/8))<<s%32;return e}function s(t){for(var e,i="0123456789abcdef",s="",r=0;r<t.length;r+=1)e=t.charCodeAt(r),s+=i.charAt(e>>>4&15)+i.charAt(15&e);return s}function u(t){return unescape(encodeURIComponent(t))}function r(t){return o(a(l(t=u(t)),8*t.length))}function n(t,e){var i,t=u(t),e=u(e),s=l(t),r=[],n=[];for(r[15]=n[15]=void 0,16<s.length&&(s=a(s,8*t.length)),i=0;i<16;i+=1)r[i]=909522486^s[i],n[i]=1549556828^s[i];return t=a(r.concat(l(e)),512+8*e.length),o(a(n.concat(t),640))}function e(t,e,i){return e?i?n(e,t):s(n(e,t)):i?r(t):s(r(t))}return{encryption:function(t){return e(t)}}})(),Zp="026685bf295f587b5dffc1f18d5dc27c",qp="fengmap.localhost:",Kp="0.0.0.0";class Jp{constructor(){}}Object.assign(Jp.prototype,{Uh(t,e,i,s,r){void 0===nt.KjWzhWlSj||!nt.KjWzhWlSj.license||!nt.KjWzhWlSj.license||"string"==typeof e&&0!=e.length&&(e=Xp.decryption(e,Zp),i=Yp.encryption(i),e=Xp.decryption(e,i),-1!==t.indexOf(e))?s&&s():r&&r()},Fh(t,e,i,s){var r;-1!==e.indexOf("")||-1!==e.indexOf("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa")||void 0===t.mapURL||(r=Yp.encryption(qp+t.appName),r=Xp.decryption(t.key,r),-1!==e.indexOf(r))?this.Uh(e,t.license,t.buildingID,()=>{i&&i()},()=>{s&&s(Nr.LICENSE_ERROR)}):s&&s(Nr.NAME_KEY_ERROR)},Bh(t,e,i){void 0!==t.mapURL?e&&e():(t.enableCollect&&this.kh(t),this.Gh(()=>{new lv({method:"POST",url:Wp.check,header:{"X-Requested-With":"XMLHttpRequest","Content-type":"application/json;charset=utf-8"},data:this.Hh(t)}).sh(()=>{e&&e()},t=>{i&&i(t)},()=>{e&&e()})},()=>{e&&e()}))},Gh(t,e){new lv({method:"GET",url:Wp.online}).sh(()=>{t&&t()},()=>{e&&e()},()=>{e&&e()})},Hh(t,e){let i;nt.environment===I.BROWSER&&(s=ov.global(),-1!==(s=(i=s.location.host).indexOf(":")))&&(i=i.slice(0,s));var s={mapId:t.buildingID,appName:t.appName};return e?s.keyValue=t.key:s.appKey=t.key,e?s.webUrl=i||Kp:s.webURL=i||Kp,s},kh(t){if("undefined"!=typeof navigator&&"undefined"!=typeof document){var i={};-1!==navigator.userAgent.indexOf("Opera")?i.userAgent="Opera":-1!==navigator.userAgent.indexOf("Firefox")?i.userAgent="FF":-1!==navigator.userAgent.indexOf("Chrome")?i.userAgent="Chrome":-1!==navigator.userAgent.indexOf("Safari")&&0===navigator.userAgent.indexOf("Chrome")?i.userAgent="Safari":-1!==navigator.userAgent.indexOf("compatible")&&-1!==navigator.userAgent.indexOf("MSIE")?i.userAgent="IE":-1!==navigator.userAgent.indexOf("Trident")&&(i.userAgent="Edge"),i.product="JS",i.sdkVersion=a.VERSION+"."+a.BUILD,i.appName=t.appName,i.appkey=t.key;var t=nt.document.createElement("canvas").getContext("experimental-webgl"),s=t.getExtension("WEBGL_debug_renderer_info");i.gpu=s?t.getParameter(s.UNMASKED_RENDERER_WEBGL):null,i.os=navigator.platform;let e=!0;var r=navigator.userAgent,n=["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"];for(let t=0;t<n.length;t++)if(0<r.indexOf(n[t])){e=!1;break}e?i.device="pc":i.device="mobile",new lv({method:"POST",url:Wp.collect,header:{"X-Requested-With":"XMLHttpRequest","Content-type":"application/json;charset=utf-8"},data:i}).sh()}}});let $p=new Jp;class Qp{constructor(t={}){this.Vh=t.disposeCallback,this.zh=!1,this.Wh=!1,this.jh=void 0!==t.enable&&t.enable,this.name=void 0!==t.name?t.name:"",this.Xh=new Map,this.Yh=t.mapCreateTime}}Object.assign(Qp.prototype,{Zh(){!this.jh||this.Wh||this.zh&&0===this.Xh.size&&(this.Vh({mapCreateTime:this.Yh}),this.Wh=!0)},qh(t){this.jh&&(this.zh=t,this.Zh())},Kh(t){this.jh&&(this.Xh.has(t),this.Xh.set(t,0))},Jh(t){this.jh&&this.Xh.has(t)&&(this.Xh.delete(t),this.Zh())}});let tm="2",em=3,im=!0;class sm{constructor(){this.Oh=new Hp,this.$h=[],this.Qh=new Qp({enable:!0,name:"DataManager"})}}function rm(n){var a=[],t=n.length;for(let r=0;r<t;r++){let t=n[r],e={x:this.eo(t.x),y:this.eo(t.y)},i=a.length,s=!1;for(let t=0;t<i;t++){var h=a[t];if(h.x==e.x&&h.y==e.y){s=!0;break}}s||a.push(e)}return a}function nm(t){return+t.toFixed(2)}Object.assign(sm.prototype,{Qt(t){this.Qh.Vh=t,this.$h.forEach(t=>{200!==t.ih.status&&this.Qh.Jh(t.eh.url),t.Qt()}),this.$h.length=0,this.Qh.qh(!0)},io(e,i,s,r){if(e.mapURL){let t;t=e.isPreview?e.isOutdoor?e.tile?e.mapURL+e.buildingID+"/separate/"+e.buildingID+i+".fmap":e.mapURL+e.buildingID+"/"+e.buildingID+i+".fmap":e.tile?e.mapURL+e.mapID+"/"+e.bid+"/"+e.buildingID+"/separate/"+e.buildingID+i+".fmap":e.mapURL+e.mapID+"/"+e.bid+"/"+e.buildingID+"/"+e.buildingID+i+".fmap":e.mapURLAbsolute?e.mapURL+e.buildingID+i+".fmap":e.isOutdoor?e.mapURL+e.buildingID+"/"+e.buildingID+i+".fmap":e.mapURL+e.mapID+"/"+e.bid+"/"+e.buildingID+"/"+e.buildingID+i+".fmap",void(s&&s(t))}else{var t={newFlag:tm,keyType:em,isSeparate:!1},i=(e.isOutdoor||(t.bId=e.bid,t.rootMid=e.mapID),new lv({method:"POST",url:""===i?Wp.download:Wp.downloadTile+"/"+e.buildingID+i+".fmap",header:{"X-Requested-With":"XMLHttpRequest","Content-type":"application/json;charset=utf-8"},data:Object.assign(t,$p.Hh(e,!0))}));this.$h.push(i),i.sh(t=>{s&&s(t.replace('"',"").replace('"',""))},t=>{r&&r(t)},t=>{r&&r(t)})}},so(s,r,n){s.enableCollect=im,$p.Bh(s,()=>{this.io(s,"",i=>{var t=new lv({method:"GET",responseType:"arraybuffer",url:i});this.$h.push(t),this.Qh.Kh(i),t.sh(t=>{this.Qh.Jh(i);var t=new Uint8Array(t);let e=this.Oh.Eh(t);!s.isOutdoor||(t=[],e.keys&&0!==e.keys.length?t.push(...e.keys):t.push(e.key),s.isPreview)?r&&r(e):$p.Fh(s,t,()=>{r&&r(e)},t=>{n&&n(t)})},t=>{n&&(t===Nr.PATH_ERROR?n(Nr.MAP_ID_URL_ERROR):n(t)),this.Qh.Jh(i)},t=>{n&&n(t),this.Qh.Jh(i)})},t=>{n&&n(t)})},t=>{n&&n(t)})},ro(s,r,n){s.enableCollect=im,$p.Bh(s,()=>{this.io(s,".scene",i=>{this.Qh.Kh(i);var t=new lv({method:"GET",responseType:"arraybuffer",url:i});this.$h.push(t),t.sh(t=>{var t=new Uint8Array(t);let e=this.Oh.bh(t);this.Qh.Jh(i),!s.isOutdoor||(t=[],e.keys&&0!==e.keys.length?t.push(...e.keys):t.push(e.key),s.isPreview)?r&&r(e):$p.Fh(s,t,()=>{r&&r(e)},t=>{n&&n(t)})},t=>{n&&n(t),this.Qh.Jh(i)},t=>{n&&n(t),this.Qh.Jh(i)})},t=>{n&&n(t)})},t=>{n&&n(t)})},no(t,i,s){this.io(t,".gate",e=>{this.Qh.Kh(e);var t=new lv({method:"GET",responseType:"arraybuffer",url:e});this.$h.push(t),t.sh(t=>{t=new Uint8Array(t),t=this.Oh.Ah(t);i&&i(t),this.Qh.Jh(e)},t=>{s&&s(t),this.Qh.Jh(e)},t=>{s&&s(t),this.Qh.Jh(e)})},t=>{s&&s(t)})},ao(t,e,i,s){this.io(t,".floor."+e+".geo",e=>{var t=new lv({method:"GET",responseType:"arraybuffer",url:e});this.Qh.Kh(e),this.$h.push(t),t.sh(t=>{t=new Uint8Array(t),t=this.Oh.Rh(t);i&&i(t),this.Qh.Jh(e)},t=>{s&&s(t),this.Qh.Jh(e)},t=>{s&&s(t),this.Qh.Jh(e)})},t=>{s&&s(t)})},ho(t,e,i,s){this.io(t,".floor."+e+".biz",e=>{var t=new lv({method:"GET",responseType:"arraybuffer",url:e});this.Qh.Kh(e),this.$h.push(t),t.sh(t=>{t=new Uint8Array(t),t=this.Oh.Ch(t);i&&i(t),this.Qh.Jh(e)},t=>{s&&s(t),this.Qh.Jh(e)},t=>{s&&s(t),this.Qh.Jh(e)})},t=>{s&&s(t)})},oo(t,e,i,s){this.io(t,e,e=>{var t=new lv({method:"GET",responseType:"arraybuffer",url:e});this.Qh.Kh(e),this.$h.push(t),t.sh(t=>{t=new Uint8Array(t),t=this.Oh.Ih(t);i&&i(t),this.Qh.Jh(e)},t=>{s&&s(t),this.Qh.Jh(e)})},t=>{s&&s(t)},t=>{s&&s(t)})},uo(t,e,i,s){this.oo(t,".floor."+e+".navi",i,s)},co(t,e,i,s){this.oo(t,".floor."+e+".drive.navi",i,s)},fo(t,e,i,s){this.oo(t,".floor."+e+".accessible.navi",i,s)}});class am{constructor(){}}Object.assign(am.prototype,{do(i,s){var r=[];let n=0;for(let t=0;t<i.length;t++){let e=i[t].idxs;if("number"==typeof(e=e||i[t]))for(;n<e;)r.push({x:s[n],y:s[n+1]}),n+=2;else for(let t=0;t<e.length;t++)for(var a=e[t];n<a;)r.push({x:s[n],y:s[n+1]}),n+=2}return r},vo(i,s){var r=[];let n=0;for(let t=0;t<i.length;t++){let e=i[t].idxs;if("number"==typeof(e=e||i[t])){for(var a=[];n<e;)a.push({x:s[n],y:s[n+1]}),n+=2;r.push(a)}else for(let t=0;t<e.length;t++){for(var h=e[t],o=[];n<h;)o.push({x:s[n],y:s[n+1]}),n+=2;r.push(o)}}return r},po(i,s){var r=[],n=[];let a=0;for(let t=0;t<i.length;t++){let e=i[t].idxs;if("number"==typeof(e=e||i[t]))for(;a<e;)r.push({x:s[a],y:s[a+1]}),a+=2;else for(let t=0;t<e.length;t++)if(0===t)for(var h=e[t];a<h;)r.push({x:s[a],y:s[a+1]}),a+=2;else{for(var o=[],l=e[t];a<l;)o.push({x:s[a],y:s[a+1]}),a+=2;n.push(o)}}var t=[];return t.push(r),t.push(...n),t},mo(t){return rm(t)},eo(t){return nm(t)}});let hm=new am,om={G1:"MULTIPOLYGON(((",G2:"POINT(",G3:"MULTILINESTRING(("};om.GLEN1="MULTIPOLYGON(((".length,om.GLEN2="POINT(".length,om.GLEN3="MULTILINESTRING((".length;class lm{constructor(){}}Object.assign(lm.prototype,{do(t){var e=[];return 0!=t.indexOf(om.G2)?[]:(t=t.substring(om.GLEN2,t.length-1).split(" "),e.push({x:parseFloat(t[0]),y:parseFloat(t[1])}),e)},_o(e,i){for(let t=0;t<e.length;t++){var s=e[t].split(" ");i.push({x:parseFloat(s[0]),y:parseFloat(s[1])})}},vo(t){return 0!=t.indexOf(om.G3)?[]:(t=t.substring(om.GLEN3,t.length-2).split(","),this._o(t,t=[]),[t])},po(t){var e=[],i=[];if(0!=t.indexOf(om.G1))return[];var s=t.substring(om.GLEN1,t.length-3).split(/\),\(/);for(let t=0;t<s.length;t++){var r=s[t].split(/,/);if(0==t)this._o(r,e);else{var n=[];for(let t=0;t<r.length;t++){var a=r[t].split(" ");n.push({x:parseFloat(a[0]),y:parseFloat(a[1])})}i.push(n)}}t=[];return t.push(e),t.push(...i),t},mo(t){return rm(t)},eo(t){return nm(t)}});let um=new lm;class cm{constructor(t){this.Ai=vn.GROUP,this.Ft=new Map,this.Ht=-1,this.mi=null,Object.assign(this,t)}getType(){return this.Ai}getBound(){return this.mi||this.Ri(),this.mi}getChildren(){return this.Ft}}Object.assign(cm.prototype,{Qt(){for(var t of this.Ft.values())t.Qt&&t.Qt();this.Ft.clear()},Li(e){var t=e._support(this);t==fa.PASS?this.Ft.forEach(t=>{t.Li(e)}):t==fa.PUSH&&e._result.push(this)},Ri(){this.mi=new sa,0!=this.Ft.size&&this.Ft.forEach(t=>{this.mi.di(t.getBound())})}});class fm extends da{constructor(t){super(),this.Ht=t.eid,this.Ai=vn.POINT,Object.assign(this,t)}}Object.assign(fm.prototype,{Ri(){this.mi=new sa,this.Ti&&this.mi.vi(this.Ti)},Li(t){t._support(this)==fa.PUSH&&t._result.push(this)}});class dm{constructor(){this.wo=[1,2,3,4],this.Mo=[6,7,9],this.yo=[31,32],this.Eo=new Map,this.Eo.set(31,vn.EXTENTGROUP),this.Eo.set(32,vn.MODELGROUP),this.Eo.set(6,vn.FACILITYGROUP),this.Eo.set(7,vn.LABELGROUP),this.Eo.set(9,vn.EXTERNALMODELGROUP),this.xo=new Map,this.xo.set(31,["extentLayer",null]),this.xo.set(32,["modelLayer","labelLayer"]),this.xo.set(6,["poiLayer",null]),this.xo.set(7,["labelLayer",null]),this.xo.set(9,["externalModelLayer",null]),this.Oh=new Hp}}Object.assign(dm.prototype,{bo(t){var e;return t?(e=t.scene,this.So(e,t)):null},So(t,i){let{layerGroups:e,...s}=t,r=t.fileVer,n=new cm(s);return e.forEach(t=>{var e=this.Ao(t,i,r);n.Ft.set(t.gid,e)}),n},Ao(t,e,i){let{layers:s,...r}=t,n=new cm(r),a=e&&e.floors?e.floors.get(t.gid).geo[0]:null,h=e&&e.floors?e.floors.get(t.gid).biz[0]:null;return s.forEach(t=>{6===t.ltype&&-1!==t.lname.indexOf("storelabel")&&(t.ltype=7);var e=this.To(t,a,h,i);null!==e&&n.Ft.set(this.Eo.get(t.ltype),e)}),this.Ro(n),n},Ro(t){var e=Array.from(t.Ft);e.sort((t,e)=>t[0]-e[0]),t.Ft=new Map(e)},To(t,e,i,s){var r;return-1===this.wo.indexOf(t.ltype)&&this.xo.get(t.ltype)?(r=new cm(t),this.Lo(r,e,i,s),r&&(r.Ai=this.Eo.get(t.ltype)),r):null},Lo(t,e,i,s){if(t){var r=this.xo.get(t.ltype);if(r){var n=e?e[r[0]]:[],a=i?i[r[0]]:[];switch(t.ltype){case 6:this.Co(t,n,a,s,vn.FACILITY);break;case 7:this.Co(t,n,a,s,vn.LABEL);break;case 9:this.Co(t,n,a,s,vn.EXTERNALMODEL);break;case 31:this.No(t,n,a,s,vn.EXTENT,null);break;case 32:this.No(t,n,a,s,vn.MODEL,e?e[r[1]]:null)}}}},Co(e,i,s,r,n){for(let t=0;t<i.length;t++){var a=this.Io(i[t],s[t],r);a.Ai=n,e.Ft.set(i[t].eid,a)}},Io(t,e,i){e=Object.assign({},e,{area:t.area,eid:t.eid,height:t.height}),e=new fm(e);return t.coordinates?e.Ti=t.coordinates:(e.Ti=1==i?um.do(t.geo):hm.do(t.idxs,t.pts),t.coordinates=e.Ti),e},No(e,i,s,r,n,a){for(let t=0;t<i.length;t++){var h=this.Po(i[t],s[t],r,a?a[t]:null);h.Ai=n,e.Ft.set(i[t].eid,h)}},Po(t,e,i,s){e=Object.assign({},e,{area:t.area,eid:t.eid,height:t.height,baseheight:t.baseheight}),e=new va(e);return e.Ti=1===i?um.po(t.geo):hm.po(t.idxs,t.pts),s&&(s.coordinates||(s.coordinates=1===i?um.do(s.geo):hm.do(s.idxs,s.pts)),e.yi=s.coordinates[0]),e}});let vm={NONE_RODE_NETWORK:1,WALK_RODE_NETWORK:2,DRIVE_RODE_NETWORK:4,ACCESSIBLE_RODE_NETWORK:8};class pm{constructor(){this.Dr=new Map,this.Do=new Map,this.eh=new Map,this.Oo=new Map,this.Uo=new Map,this.Fo=new Map,this.Bo=[2,3],this.ko=!1,this.Oh=new Hp,this.Go=new dm,this.Ho=new sm}load(t,e){this.Vo(t,e)}loadWhole(t,e){this.zo(t,e)}getDecode(t){t=void 0!==t.buildingID?t.buildingID:t.mapID;return this.Wo({buildingID:t})}getData(t){t=void 0!==t.buildingID?t.buildingID:t.mapID;return this.Dr.get(t)}setCache(t){this.Dr=t[0],this.Do=t[1]}getCache(){return[this.Dr,this.Do]}}function mm(t){t.fmcommon={diffuse:{value:new Wt(15658734)},opacity:{value:1},map:{value:null},uvTransform:{value:new _}}}function gm(t){let e=mc.line.fragmentShader;if(!t.gradient)return e=(e=e.replace("#include <line_gradient_defined>","")).replace("#include <line_gradient>","");var{percent:i,color:s}=t.gradient,r=i.length,n=new Wt;let a=`
		float stops[${r}];
		vec3 gradients[${r}];
		float fromPercent = ${Number(t.distancePercent[0]).toFixed(2)};
		float toPercent = ${Number(t.distancePercent[1]).toFixed(2)};
		`;for(let t=0;t<r;t++)a+=`stops[${t}] = ${Number(i[t]).toFixed(2)};
		`,n.setStyle(s[t]),a+=`gradients[${t}] = vec3(${Number(n.r).toFixed(2)},${Number(n.g).toFixed(2)}, ${Number(n.b).toFixed(2)});
		`;var h=`
		#ifdef GRADIENT
			float remap(float a0,float a1,float b0,float b1,float a) {
				return (a - a0) / (a1 - a0) * (b1 - b0) + b0;
			}

			vec3 getGradientColor(float gradientValue) {
				${a}

				gradientValue = remap(0., 1., fromPercent, toPercent, gradientValue);
				float t = 0.0;
				vec3 color = vec3(0.0);
				for (int i = 0; i < ${r}; i++) {
						if (gradientValue <= stops[i + 1]) {
								t = (gradientValue - stops[i]) / (stops[i + 1] - stops[i]);
								color = mix(gradients[i], gradients[i + 1], t);
								break;
						}
				}

				return color;
			}
		#endif
		`;let o="";return o=t.isNeedArrow?`
		#ifdef GRADIENT
			diffuseColor.rgb += getGradientColor( vUv2.y);
		#endif`:`
			#ifdef GRADIENT
				diffuseColor.rgb = getGradientColor( vUv2.y);
			#endif
		`,e=(e=e.replace("#include <line_gradient_defined>",h)).replace("#include <line_gradient>",o)}Object.assign(pm.prototype,{Qt(t){this.Ho.Qt(t),this.Sa()},Sa(){this.Dr.clear(),this.Dr=null,this.Do.clear(),this.Do=null,this.eh.clear(),this.eh=null,this.Oo.clear(),this.Oo=null,this.Uo.clear(),this.Uo=null,this.Fo.clear(),this.Fo=null,this.jo&&this.jo({name:"DataManager"})},Xo(t){this.Oo.set(t.buildingID+t.uuid,null),this.Uo.set(t.buildingID+t.uuid,null),this.Fo.set(t.buildingID+t.uuid,0)},Vo(n,a){this.Xo(n),this.ro(n,(e,t)=>{a&&a(e,t);let r=this.Yo(n);t=n.loadNavi&&r.buildings&&0<r.buildings.length;this.no(n,t,(t,e)=>{a&&a(t,e);var i=void 0!==n.level?n.level:parseInt(r.defGid),s=(this.Zo(n,i,a),n.visibleLevels||r.levels);for(let t=0;t<s.length;t++)s[t]===i||r.levels.indexOf(s[t])<0||this.Zo(n,s[t],a);if(n.preLoad)for(let t=0;t<r.levels.length;t++)r.levels[t]!==i&&-1===s.indexOf(r.levels[t])&&this.Zo(n,r.levels[t],a)},t=>{a&&a(e,t)})},(t,e)=>{a&&a(t,e)})},no(i,t,s,r){t?(t=this.qo(i))?s&&s("gate",t):this.Ho.no(i,t=>{this.Do.get(i.buildingID).gate=t,s&&s("gate",t)},t=>{var e;i.navigationData?((e=this.Do.get(i.buildingID)).gate=i.navigationData,s&&s("gate",e.gate)):r("error",t)}):s&&s("gate",null)},ro(e,i,s){var t=this.Yo(e);t?(i&&i("scene",t),e.justDecode||(t=this.Dr.get(e.buildingID),i&&i("building",t))):this.Ho.ro(e,t=>{e.isOutdoor&&this.Ko(t),this.Do.set(e.buildingID,{scene:t}),i&&i("scene",t),e.justDecode||(t=this.Go.So(t),this.Dr.set(e.buildingID,t),i&&i("building",t))},t=>{s&&(t===Nr.PATH_ERROR?s("error",Nr.MAP_ID_URL_ERROR):s("error",t))})},Ko(t){var e=t.fileVer;t.buildings&&1<e&&t.buildings.forEach(e=>{e.floors&&(e.levelChart=[],e.fids=[],e.floors.forEach(t=>{t.Ti=hm.po(t.idxs,t.pts),t.pgid&&e.levelChart.push(t.pgid,t.gid),t.baseLevel&&(e.minlevel=t.minlevel,e.maxlevel=t.maxlevel),t.fids&&e.fids.push.apply(e.fids,t.fids)}))})},Zo(t,e,i,s){let r=this.Oo.get(t.buildingID+t.uuid);r||(r=[],this.Oo.set(t.buildingID+t.uuid,r)),s?r.unshift(e):r.push(e),this.ko&&1!==r.length||this.Jo(t,i)},Jo(n,a){let h=this.Yo(n);if(h){let r=this.Oo.get(n.buildingID+n.uuid);if(r&&0!==r.length){let t=this.Uo.get(n.buildingID+n.uuid),s=(t||(t=[],this.Uo.set(n.buildingID+n.uuid,t)),r[0]);-1!==t.indexOf(s)?(r.splice(r.indexOf(s),1),this.Jo(n,a)):(t.push(s),this.$o(n,s,(t,e)=>{let i=this.Fo.get(n.buildingID+n.uuid);"layerGroup"===t&&(a&&a(t,e),i++,this.Fo.set(n.buildingID+n.uuid,i),i===h.layerGroups.length&&a&&a("decode",this.Wo(n)),r.splice(r.indexOf(s),1),this.Jo(n,a)),"layer"===t&&a&&a(t,e),"floor"===t&&(a&&a(t,e),i===h.layerGroups.length)&&a&&a("complete",this.Qo(n))},(t,e)=>{a&&a(t,e)}))}}},$o(a,h,o,l){let u=this.Yo(a);var t=this.tl(u,h);if(t){var c=t.gname,t=t.naviType||0;let e=this.Bo[0],i=0,r=new Map,n=a.merge,s=function(s){if(i++,e===i){let e=r.get("geo"),i=r.get("biz");var t;n&&n.merge(h,e,i,u.fileVer),o&&o("layerGroup",r),a.justDecode||((t=s.Vs(a,h)).Ft.forEach(t=>{s.Go.Lo(t,e,i,u.fileVer),o&&o("layer",t)}),o&&o("floor",t))}};a.loadNavi&&((0!=(t&vm.WALK_RODE_NETWORK)||u.fileVer<3)&&(e++,this.uo(a,h,c,(t,e)=>{r.set(t,e),o&&o(t,e),s(this)},t=>{l&&l(t)})),0!=(t&vm.DRIVE_RODE_NETWORK)&&(e++,this.co(a,h,c,(t,e)=>{r.set(t,e),o&&o(t,e),s(this)},t=>{l&&l(t)})),0!=(t&vm.ACCESSIBLE_RODE_NETWORK))&&(e++,this.fo(a,h,c,(t,e)=>{r.set(t,e),o&&o(t,e),s(this)},t=>{l&&l(t)})),this.ao(a,h,c,(t,e)=>{r.set(t,e),o&&o(t,e),s(this)},t=>{l&&l(t)}),this.ho(a,h,c,(t,e)=>{r.set(t,e),o&&o(t,e),s(this)},t=>{l&&l(t)})}else l&&l("error",Nr.DEFAULT_LEVEL_ERROR)},ao(e,i,t,s,r){var n=this.el(e,i,"geo");n?s&&s("geo",n):this.Ho.ao(e,t,t=>{this.il(e,i,"geo",t),s&&s("geo",t)},t=>{r&&r("error",t)})},ho(e,i,t,s,r){var n=this.el(e,i,"biz");n?s&&s("biz",n):this.Ho.ho(e,t,t=>{this.il(e,i,"biz",t),s&&s("biz",t)},t=>{r&&r("error",t)})},uo(e,i,t,s,r){var n=this.el(e,i,"navi");n?s&&s("navi",n):this.Ho.uo(e,t,t=>{this.il(e,i,"navi",t),s&&s("navi",t)},t=>{r&&r("error",t)})},co(e,i,t,s,r){var n=this.el(e,i,"drive_navi");n?s&&s("drive_navi",n):this.Ho.co(e,t,t=>{this.il(e,i,"drive_navi",t),s&&s("drive_navi",t)},t=>{r&&r("error",t)})},fo(e,i,t,s,r){var n=this.el(e,i,"accessible_navi");n?s&&s("drive_navi",n):this.Ho.fo(e,t,t=>{this.il(e,i,"accessible_navi",t),s&&s("accessible_navi",t)},t=>{r&&r("error",t)})},zo(t,i){this.so(t,(t,e)=>{i&&i(t,e)},(t,e)=>{i&&i(t,e)})},so(e,i,s){let r=this.Wo(e);r?i&&i("decode",r):this.Ho.so(e,t=>{this.sl(e,t),r=this.Wo(e),i&&i("decode",r),e.justDecode||(t=this.Go.bo(r),this.Dr.set(e.buildingID,t),i&&i("complete",t))},t=>{s&&s("error",t)})},Qo(t){if(this.Dr)return this.Dr.get(t.buildingID)||null},Vs(t,e){t=this.Dr.get(t.buildingID);return t?t.Ft.get(e):null},sl(e,i){var s={scene:null,floors:new Map},r=this.Oh.xh(i);e.isOutdoor&&this.Ko(r),s.scene=r,s.gate=this.Oh.Sh(i);for(let t=0;t<r.layerGroups.length;t++){var n=r.layerGroups[t],a=this.Oh.Th(i,n.gid),h=this.Oh.Lh(i,n.gid),o=this.Oh.Nh(i,n.gid),l=this.Oh.Ph(i,n.gid),u=this.Oh.Dh(i,n.gid),c=(e.merge&&e.merge.merge(n.gid,a,h,r.fileVer),new Map);c.set("geo",a),c.set("biz",h),c.set("navi",o),c.set("drive_navi",l),c.set("accessible_navi",u),s.floors.set(n.gid,c)}this.Do.set(e.buildingID,s)},Wo(e){var t=this.Do.get(e.buildingID);if(!t)return null;var i=t.scene,s=new Map,t={scene:i,floors:s,gate:t.gate};for(let t=0;t<i.layerGroups.length;t++){var r=i.layerGroups[t],n=r.gid,a={gid:n,gname:r.gname,level:n,geo:[],biz:[],navi:[],naviDrive:[],naviAccessible:[]},h=(a.geo.push(this.el(e,n,"geo")),a.biz.push(this.el(e,n,"biz")),this.el(e,n,"navi")),h=(h&&a.navi.push(h),this.el(e,n,"drive_navi")),h=(h&&a.naviDrive.push(h),this.el(e,n,"accessible_navi"));h&&a.naviAccessible.push(h),s.set(r.gid,a)}return t},Yo(t){t=this.Do.get(t.buildingID);return t?t.scene:null},qo(t){t=this.Do.get(t.buildingID);return t?t.gate:null},il(i,s,r,n){i=this.Do.get(i.buildingID);if(i){let t=i.floors,e=(t||(t=new Map,i.floors=t),t.get(s));e||(e=new Map,t.set(s,e)),e.set(r,n)}},el(t,e,i){var t=this.Do.get(t.buildingID);return(t=t&&t.floors)&&(t=t.get(e))?t.get(i):null},tl(t,e){if(null!=t){var i=t.layerGroups;for(let t=0;t<i.length;t++)if(i[t].gid==e)return i[t]}return null}}),mm(P),P.line={lineWidth:{value:1},resolution:{value:new ct(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1},mmap:{value:null},offset:{value:new ct(0,0)},repeat:{value:new ct(1,1)},miny:{value:0},pcolor:{value:new Wt(11447982)},usePassOpacity:{value:0},passOpacity:{value:1}},mc.line={uniforms:Gh.merge([P.fmcommon,P.line]),vertexShader:`
		#include <common>
		#include <color_pars_vertex>

		uniform float lineWidth;
		uniform vec2 resolution;

		attribute float uvyStart;
		attribute float uvyEnd;

		attribute vec3 instanceStart;
		attribute vec3 instanceEnd;

		attribute vec3 instanceColorStart;
		attribute vec3 instanceColorEnd;
		attribute vec2 uv2;


		varying vec2 vUv;
		varying vec2 vUv2;
		varying float uvScale;

		#ifdef USE_DASH

			uniform float dashScale;
			attribute float instanceDistanceStart;
			attribute float instanceDistanceEnd;
			varying float vLineDistance;

		#endif

		void trimSegment( const in vec4 start, inout vec4 end ) {

			// trim end segment so it terminates between the camera plane and the near plane

			// conservative estimate of the near plane
			float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
			float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
			float nearEstimate = - 0.5 * b / a;

			float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

			end.xyz = mix( start.xyz, end.xyz, alpha );

		}

		#include <logdepthbuf_pars_vertex>

		void main() {

			#ifdef USE_COLOR

				vColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

			#endif

			#ifdef USE_DASH

				vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;

			#endif

			float aspect = resolution.x / resolution.y;

			vUv = uv;

			float duvy = uvyEnd - uvyStart;
			float uvy = uvyStart + duvy * uv2.y;
			// vUv2 = vec2(uv2.x ,uvy);
			vUv2 = ( position.y < 0.5 ) ? vec2(uv2.x ,uvyStart) : vec2(uv2.x ,uvyEnd);
			// camera space
			vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
			vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

			// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
			// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
			// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
			// perhaps there is a more elegant solution -- WestLangley

			bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

			if ( perspective ) {

				if ( start.z < 0.0 && end.z >= 0.0 ) {

					trimSegment( start, end );

				} else if ( end.z < 0.0 && start.z >= 0.0 ) {

					trimSegment( end, start );

				}

			}

			// clip space
			vec4 clipStart = projectionMatrix * start;
			vec4 clipEnd = projectionMatrix * end;

			// ndc space
			vec2 ndcStart = clipStart.xy / clipStart.w;
			vec2 ndcEnd = clipEnd.xy / clipEnd.w;

			// direction
			vec2 dir = ndcEnd - ndcStart;

			// account for clip-space aspect ratio
			dir.x *= aspect;
			float scaleDir = length(dir);
			uvScale = 0.05/scaleDir;
			dir = normalize( dir );

			// perpendicular to dir
			vec2 offset = vec2( dir.y, - dir.x );

			// undo aspect ratio adjustment
			dir.x /= aspect;
			offset.x /= aspect;

			// sign flip
			if ( position.x < 0.0 ) offset *= - 1.0;

			// endcaps
			if ( position.y < 0.0 ) {

				offset += - dir;

			} else if ( position.y > 1.0 ) {

				offset += dir;

			}

			// adjust for lineWidth
			offset *= lineWidth;

			// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
			offset /= resolution.y;

			// select end
			vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

			// back to clip space
			offset *= clip.w;

			clip.xy += offset;

			gl_Position = clip;

			#include <logdepthbuf_vertex>

			vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

		}
		`,fragmentShader:`
		uniform vec3 diffuse;
		uniform float opacity;
		uniform vec2 repeat;
		uniform vec2 offset;
		uniform float miny;
		uniform vec3 pcolor;
		uniform float usePassOpacity;
		uniform float passOpacity;
	  #include <line_gradient_defined>

		#ifdef USE_DASH

			uniform float dashSize;
			uniform float gapSize;

		#endif

			uniform sampler2D mmap;

		varying float vLineDistance;

		#include <common>
		#include <color_pars_fragment>

		varying float uvScale;
		varying vec2 vUv;
		varying vec2 vUv2;

		#include <logdepthbuf_pars_fragment>

		void main() {

			#ifdef USE_DASH

				if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

				if ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

			#endif

			vec4 diffuseColor = vec4( diffuse, opacity );

			#include <logdepthbuf_fragment>

			#ifdef USE_MMAP

				if(vUv2.y >= miny && miny != 1.0){
				    vec4 texColor = texture2D( mmap, vUv2 * repeat + offset );
					diffuseColor = vec4(texColor.xyz,min(texColor.w, opacity));
				}else{
					float ret = opacity;
					if(usePassOpacity == 1.0) {
						ret = passOpacity;
					}
					diffuseColor = vec4(pcolor, ret);

					if(usePassOpacity == 1.0 && ret < 0.1) {
						discard;
					}
				}

			#endif

			#include <line_gradient>

			gl_FragColor = diffuseColor;
		}
		`};class _m extends zh{constructor(t){super({type:"FMLineMaterial",uniforms:Gh.clone(mc.line.uniforms),vertexShader:mc.line.vertexShader,fragmentShader:gm(t)}),t.gradient&&(this.defines={GRADIENT:!0}),this.dashed=!1,delete t.gradient,delete t.distancePercent,delete t.isNeedArrow,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},lineWidth:{enumerable:!0,get:function(){return this.uniforms.lineWidth.value},set:function(t){this.uniforms.lineWidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value=t}},pcolor:{enumerable:!0,get:function(){return this.uniforms.pcolor.value},set:function(t){this.uniforms.pcolor.value=t}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(t){this.uniforms.opacity.value=t}}}),this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.lineWidth=t.lineWidth,this.resolution=t.resolution,this}}class wm extends Oh{constructor(t){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new Wt(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.linewidth=t.linewidth,this.linecap=t.linecap,this.linejoin=t.linejoin,this.fog=t.fog,this}}class Mm extends wm{constructor(t){super(t),this.type="FMLineBasicMaterial",this.isMask=!1,this.maskType=0,this.maskPolygons=[],this.maskHolePogygons=[],this.maskHeight=0,this.maskExtrudeHeight=0,this.boundCenter=null,this.boundSize=null,this.maskOpacity=null,this.maskNodeHeight=0,this.maskParam="",this.maskHoleParam=""}}class ym extends Oh{constructor(t){super(),this.isSpriteMaterial=!0,this.type="SpriteMaterial",this.color=new Wt(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.rotation=t.rotation,this.sizeAttenuation=t.sizeAttenuation,this.fog=t.fog,this}}class Em extends zh{constructor(t){super(t),this.isRawShaderMaterial=!0,this.type="RawShaderMaterial"}}class xm{constructor(){this.rl=!1,this.nl=new Map,this.al=new Map}}Object.assign(xm.prototype,{hl(t,e){this.al.has(t)||this.al.set(t,new Set),this.al.get(t).add(e)},ol(){this.nl.clear(),this.nl=null,this.al.clear(),this.al=null}});class bm{static getBrowser(){if(void 0!==navigator){var t,e,i,s,r,n,a=navigator.userAgent;if(void 0!==a)return t=-1<a.indexOf("Opera"),n=-1<a.indexOf("compatible")&&-1<a.indexOf("MSIE")&&!t,e=-1<a.indexOf("Edge"),i=-1<a.indexOf("Firefox"),s=-1<a.indexOf("Safari")&&-1===a.indexOf("Chrome"),r=-1<a.indexOf("Chrome")&&-1<a.indexOf("Safari"),n?(new RegExp("MSIE (\\d+\\.\\d+);").test(a),7===(n=parseFloat(RegExp.$1))?"IE7":8===n?"IE8":9===n?"IE9":10===n?"IE10":11===n?"IE11":"IE"):t?"Opera":e?"Edge":i?"FF":s?"Safari":r?"Chrome":void 0}}}let Sm=bm.getBrowser();class Am extends xm{constructor(){super(),this.ll=0,this.ul=0,this.cl=new Map}}Object.assign(Am.prototype,{fl(t,e,i){let s;return this.nl.has(t)?(s=this.nl.get(t),e&&(s.isComplete?s.isError?e(null):e(s):this.hl(t,e))):s=this.dl(t,e,i),s},dl(e,t,i){let s=this;this.ll++;let r;return(r=nt.environment===I.WX?nt.textureHelper.createImage(i):new Image).crossOrigin="Anonymous","IE11"===Sm?r.onload=new function(){this.ul++,r.isComplete=!0,s.vl(e,r)}:r.onload=function(){s.ul++,r.isComplete=!0,s.vl(e,r)},r.onerror=function(t){s.ul++,r.isComplete=!0,r.isError=!0,s.vl(e,null)},r.src=e,r.isComplete=!1,this.nl.set(e,r),t&&this.hl(e,t),r},vl(t,s){this.al.has(t)&&(this.al.get(t).forEach((t,e,i)=>{e(s),i.delete(t)}),this.al.delete(t)),0<this.cl.size&&this.ll===this.ul&&this.cl.forEach((t,e)=>{t(e)})},ol(){this.nl.clear(),this.al.clear()}});let Tm=new Am,Rm={Left:0,Center:2,Right:4};class Lm{constructor(t){this.pl=t}}Object.assign(Lm.prototype,{ml(t,e){var i=nt.document.createElement("canvas"),s=i.getContext("2d");return i.width=t,i.height=e,i.style.width=t+"px",i.style.height=e+"px",{canvas:i,ctx:s}},gl(t,e,i,s,r){var n=r,a={x:r.x+e,y:r.y},h={x:r.x,y:r.y+i},e={x:r.x+e,y:r.y+i},r={x:n.x+s,y:n.y},i={x:a.x-s,y:a.y},o={x:a.x,y:a.y+s},l={x:e.x,y:e.y-s},u={x:e.x-s,y:e.y},c={x:h.x+s,y:h.y},f={x:h.x,y:h.y-s},d={x:n.x,y:n.y+s};t.beginPath(),t.moveTo(r.x,r.y),t.lineTo(i.x,i.y),t.arcTo(a.x,a.y,o.x,o.y,s),t.lineTo(l.x,l.y),t.arcTo(e.x,e.y,u.x,u.y,s),t.lineTo(c.x,c.y),t.arcTo(h.x,h.y,f.x,f.y,s),t.lineTo(d.x,d.y),t.arcTo(n.x,n.y,r.x,r.y,s),t.closePath()},_l(t,n){if(t){let r=new Image;r.crossOrigin="Anonymous",r.onload=()=>{var t=r.width,e=r.height,{canvas:i,ctx:s}=this.ml(t,e);i.width=t,i.height=e,s.drawImage(r,0,0,t,e),n&&n(i)},r.src=t}else n(null)},wl(t,i,e,s){var r=s.scale??2;let n=1;var a=void 0!==s.needSize&&s.needSize,h=e.fontsize*r*1.2,o=2*r;let l=0,u=0;var c=(void 0!==e.fontWeight?e.fontWeight:400)+` ${h}px `+this.Ml(s.family,e.fontFamily);let f=void 0!==e.space?e.space*r:2*r;var d,v;let p=0;void 0!==e.plateSize&&(p=(e.plateSize-e.fontsize)/2*r),p=Math.max(p,3*r);var m=h/3;let g=0,_=[],w,M;var y=0*r,E=0*r,x=nt.document.createElement("canvas"),b=x.getContext("2d");b.font=c,b.textBaseline="alphabetic";let S=1.2*e.fontsize*r;void 0!==e.imageSize&&(S=1.2*e.imageSize*r),i&&0!=S||(S=0,f=0);var A=-1<t.indexOf("%rn%");if(A){for(var T of _=t.split("%rn%"))l=Math.max(b.measureText(T).width+o,l),u+=h;u+=_.length*o}else l=b.measureText(t).width+o,u=h+o;d=Math.ceil(u)+2*p,v=Math.ceil(l)+2*p,w=2*E+S+f+v,M=2*y+Math.max(d,S);let R=0;if(e.plateStrokeColor&&(R=r,w+=2*R,M+=2*R),!0===s.onlyNeedSize)return{width:w,height:M};g=A?u/_.length/2+m+y+p:M/2+m,A&&(n=M/(h+2*y+2*p)),x.width=w,x.height=M,x.style.width=w+"px",x.style.height=M+"px",x.spriteScale=n,b.font=c,nt.environment===I.WX&&(b.shadowOffsetX=0,b.shadowOffsetY=0,b.shadowBlur=0,b.shadowColor="rgba(0,0,0,0.0)"),b.clearRect(0,0,x.width,x.height),(e.plateColor||e.plateStrokeColor)&&(e.plateColor&&(b.fillStyle=e.plateColor),b.lineWidth=r,this.gl(b,v,d,5*r,{x:S+E+f+R,y:M/2-d/2}),e.plateColor&&b.fill(),e.plateStrokeColor&&(b.strokeStyle=e.plateStrokeColor,b.stroke()),b.beginPath()),i&&(m=(M-S)/2,b.drawImage(i,E,m,S,S));var L=S+E+f+p+o/2;b.lineWidth=2*r*(void 0!==e.strokeWidth?e.strokeWidth:1);let C=1;if(void 0!==e.strokeWidth&&(C=parseFloat(e.strokeWidth)),e.strokeColor&&0!==C)if(b.strokeStyle=e.strokeColor,A){let e=g;for(let t=0;t<_.length;t++)t&&(e+=h+o),i?(b.textAlign="left",b.strokeText(_[t],L,e)):s.textAlign===Rm.Left?(b.textAlign="left",b.strokeText(_[t],0,e)):s.textAlign===Rm.Right?(b.textAlign="right",b.strokeText(_[t],w,e)):(b.textAlign="center",b.strokeText(_[t],w/2,e))}else i?(b.textAlign="left",b.strokeText(t,L,g)):s.textAlign===Rm.Left?b.strokeText(t,0,g):s.textAlign===Rm.Right?(b.textAlign="right",b.strokeText(t,w,g)):(b.textAlign="center",b.strokeText(t,w/2,g));if(b.fillStyle=e.fillColor,A||!1===s.drawText){if(!1!==s.drawText){let e=g;for(let t=0;t<_.length;t++)t&&(e+=h+o),i?(b.textAlign="left",b.fillText(_[t],L,e)):s.textAlign===Rm.Left?(b.textAlign="left",b.fillText(_[t],0,e)):s.textAlign===Rm.Right?(b.textAlign="right",b.fillText(_[t],w,e)):(b.textAlign="center",b.fillText(_[t],w/2,e))}}else i?(b.textAlign="left",b.fillText(t,L,g)):s.textAlign===Rm.Left?(b.textAlign="left",b.fillText(t,0,g)):s.textAlign===Rm.Right?(b.textAlign="right",b.fillText(t,w,g)):(b.textAlign="center",b.fillText(t,w/2,g));let N=0;return a&&(N=A?e.fontsize+(o*(_.length-1)+y+p)/_.length:e.fontsize+y+p,x.size=N),x.drawTextWidth=l,x.drawTextLeft=L,x},yl(t){var e=t.width,i=t.height,s=t.arrowWidth||10,{canvas:r,ctx:n}=this.ml(e,i),a=(n.fillStyle=t.godEdgeColor,n.fillRect(0,0,e,i),e*(1-t.godEdgePercent));n.fillStyle=t.godColor,n.fillRect((e-a)/2,0,a,i),n.fillStyle="#ffffff",n.shadowOffsetX=-2,n.shadowOffsetY=2,n.shadowBlur=4,n.shadowColor="rgba(0,0,0,0.5)";let h=e/2,o=i/2;var e=i*t.godArrowPercent,i=a*t.godArrowWidthPercent,a=h-i/2,l=o+e/2;return n.beginPath(),n.moveTo(a,l),n.lineTo(a,l+s),n.lineTo(a+i/2,l-e+s),n.lineTo(a+i,l+s),n.lineTo(a+i,l),n.lineTo(a+i/2,l-e),n.closePath(),n.fillStyle=t.godArrowColor,n.fill(),r},El(t){var e=t.width,i=t.height,{canvas:s,ctx:r}=this.ml(e,i),e=(this.xl(r,e,i),t.height*t.arrowHeightPercent),i=(1-t.arrowHeightPercent)*t.height/2,n=t.width*(t.arrowWidthPercent-t.arrowPercent);return r.beginPath(),r.moveTo(0,i),r.lineTo(n,i),r.lineTo(t.width*t.arrowWidthPercent,i+e/2),r.lineTo(n,i+e),r.lineTo(0,i+e),r.lineTo(t.width*t.arrowPercent,i+e/2),r.closePath(),r.fillStyle=t.color,r.fill(),s},xl(t,e,i){var s=new _,r=(s.set(Math.cos(Math.PI/2),-Math.sin(Math.PI/2),+e/2,Math.sin(Math.PI/2),Math.cos(Math.PI/2),+i/2,0,0,1),new _),e=(r.set(1,0,-e/2,0,1,-i/2,0,0,1),s.multiply(r),s.elements);t.transform(e[0],e[3],e[1],e[4],e[2],e[6])},bl(i){var t=i.width,e=i.height,s=i.dashArray;let{canvas:r,ctx:n}=this.ml(t,e),a=(this.xl(n,t,e),s.reduce(function(t,e){return t+e})),h=0;s.forEach(function(t,e){e%2==0&&(n.fillStyle=i.color,n.fillRect(h/a*i.width,0,t/a*i.width,i.height)),h+=t});s=this.ml(e,t);return s.ctx.translate(e/2,t/2),s.ctx.rotate(Math.PI/2),s.ctx.drawImage(r,-t/2,-e/2,t,e),s.canvas},Ml(t,e){var i=this.pl.Wt.Ls.fontFamily;return void 0!==t?t+","+i:void 0!==e&&'"Microsoft Yahei","",Tahoma,Arial'===i?e:i},Qt(){}});class Cm extends xm{constructor(){super()}}Object.assign(Cm.prototype,{Sl(t){var e,i=[];for(e in t)i.push(t[e]);return i.join()}});class Nm extends Cm{constructor(t){super(),this.jo=null,this.Sa=this.Sa.bind(this),this.Qh=new Qp({disposeCallback:this.Sa,enable:!0,name:"TextureManager",mapCreateTime:t.mapCreateTime})}}Object.assign(Nm.prototype,{Al(i,s){let r;if(nt.environment==I.BROWSER)r=new Y0(i);else{let e=s.paramKey;if(r=new c,s.labelImageCatch[e].image)return r.image=s.labelImageCatch[e].image,r.minFilter=V,r.generateMipmaps=!1,r.needsUpdate=!0,t=s.labelImageCatch[e].texture,r.scaleRatio=t.scaleRatio,r.mspriteScale=t.mspriteScale,s.needSize&&(r.size=t.size),r.needsUpdate=!0,s&&s.callback&&s.callback(r),r.useCatch=!0,r;s.labelImageCatch[e].texture={scaleRatio:i.height/i.width,mspriteScale:i.spriteScale,size:i.size};var t=i.toDataURL("image/png");nt.textureHelper.createImage({url:t,onload:t=>{r.image=t,r.needsUpdate=!0,s&&s.callback&&s.callback(r),s.labelImageCatch[e].canvas={size:i.size,spriteScale:i.spriteScale,width:i.width,height:i.height},s.labelImageCatch[e].image=t}})}return r.minFilter=V,r.generateMipmaps=!1,r.needsUpdate=!0,r},Tl(t){var e=new c;return e.minFilter=V,e.generateMipmaps=!1,e.flipY=t.flipY,e},Rl(e,i){void 0===e.flipY&&(e.flipY=!0);let r,n=this.Sl(e);if(this.nl.has(n))this.al.has(n)?this.hl(n,i):i(r=this.nl.get(n));else{r=this.Tl(e),this.nl.set(n,r),this.hl(n,i);let t="_getTexture"+ws.generateUUID();this.Qh.Kh(t),Tm.fl(e.url,s=>{r.image=s,r.needsUpdate=!0,this.al.get(n).forEach((t,e,i)=>{s&&e(r),i.delete(t)}),this.al.delete(n),this.Qh.Jh(t)},{needDraw:e.needDraw})}return r},Ll(t,e){var i=this.Al(t,e);return i.useCatch||(i.scaleRatio=t.height/t.width,i.mspriteScale=t.spriteScale,e.needSize&&(i.size=t.size)),i},Qt(t){this.jo=t,this.Qh.qh(!0)},Sa(){this.nl.forEach(function(t,e,i){t.dispose(),i.delete(e)}),this.nl.clear(),this.nl=null,this.al.forEach(function(t,e,i){t.forEach(function(t,e,i){i.delete(e)}),i.delete(e)}),this.al.clear(),this.al=null,this.jo&&this.jo({name:"TextureManager"})}});let Im=`
precision mediump float;
precision mediump int;

attribute vec3 position;

uniform mat4 modelViewMatrix;
uniform mat4 projectionMatrix;

void main() {
  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}
 `,Pm=`
precision mediump float;
precision mediump int;

uniform vec3 color;
uniform float alpha;

void main() {
    gl_FragColor = vec4(color,alpha);
}
 `,Dm=`
attribute float gradientAlpha;

varying float v_gradientAlpha;

void main() {
  v_gradientAlpha = gradientAlpha;
  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}
 `,Om=`

uniform vec3 color;
uniform float alpha;

varying float v_gradientAlpha;

void main() {
  gl_FragColor = vec4(color, alpha * v_gradientAlpha);
}
 `;class Um extends Oh{constructor(t){super(),this.isMeshLambertMaterial=!0,this.type="MeshLambertMaterial",this.color=new Wt(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Wt(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=yi,this.normalScale=new ct(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Ps,this.combine=o,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapRotation.copy(t.envMapRotation),this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this.fog=t.fog,this}}class Fm extends Um{constructor(t){super(t),this.type="FMMeshLambertMaterial",this.mapMixColor=!1,this.heatCenter=null,this.heatSize=null,this.isMask=!1,this.maskType=0,this.maskPolygons=[],this.maskHolePogygons=[],this.maskHeight=0,this.maskExtrudeHeight=0,this.boundCenter=null,this.boundSize=null,this.maskOpacity=null,this.maskNodeHeight=0,this.maskParam="",this.maskHoleParam="",this.isJsonModel=!1}clone(){var t=(new this.constructor).copy(this);return t.mapMixColor=this.mapMixColor,t.heatCenter=this.heatCenter,t.heatSize=this.heatSize,t.isMask=this.isMask,t.maskType=this.maskType,t.maskPolygons=this.maskPolygons,t.maskHolePogygons=this.maskHolePogygons,t.maskHeight=this.maskHeight,t.maskExtrudeHeight=this.maskExtrudeHeight,t.boundCenter=this.boundCenter,t.boundSize=this.boundSize,t.maskOpacity=this.maskOpacity,t.maskNodeHeight=this.maskNodeHeight,t.maskParam=this.maskParam,t.maskHoleParam=this.maskHoleParam,t.isJsonModel=this.isJsonModel,t}}class Bm extends ro{constructor(t){super(t),this.type="FMMeshBasicMaterial",this.isMask=!1,this.maskType=0,this.maskPolygons=[],this.maskHolePogygons=[],this.maskHeight=0,this.maskExtrudeHeight=0,this.boundCenter=null,this.boundSize=null,this.maskOpacity=null,this.maskNodeHeight=0,this.maskParam="",this.maskHoleParam=""}}class km extends Oh{constructor(t){super(),this.isMeshStandardMaterial=!0,this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new Wt(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Wt(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=yi,this.normalScale=new ct(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Ps,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.defines={STANDARD:""},void 0!==t.defines.SHADING_MODE&&(this.defines.SHADING_MODE=t.defines.SHADING_MODE),this.color.copy(t.color),this.roughness=t.roughness,this.metalness=t.metalness,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.roughnessMap=t.roughnessMap,this.metalnessMap=t.metalnessMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapRotation.copy(t.envMapRotation),this.envMapIntensity=t.envMapIntensity,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this.fog=t.fog,this}}class Gm extends km{constructor(t){super(t),this.type="FMMeshStandardMaterial",this.isMask=!1,this.maskType=0,this.maskPolygons=[],this.maskHolePogygons=[],this.maskHeight=0,this.maskExtrudeHeight=0,this.boundCenter=null,this.boundSize=null,this.maskOpacity=null,this.maskNodeHeight=0,this.maskParam="",this.maskHoleParam=""}clone(){var t=(new this.constructor).copy(this);return t.isMask=this.isMask,t.maskType=this.maskType,t.maskPolygons=this.maskPolygons,t.maskHolePogygons=this.maskHolePogygons,t.maskHeight=this.maskHeight,t.maskExtrudeHeight=this.maskExtrudeHeight,t.boundCenter=this.boundCenter,t.boundSize=this.boundSize,t.maskOpacity=this.maskOpacity,t.maskNodeHeight=this.maskNodeHeight,t.maskParam=this.maskParam,t.maskHoleParam=this.maskHoleParam,t}}class Hm{static setPixel({x:t,y:e,color:i,d:s,width:r}){s[4*(e*r+t)+0]=i[0],s[4*(e*r+t)+1]=i[1],s[4*(e*r+t)+2]=i[2],s[4*(e*r+t)+3]=i[3]}static getPowerOfTwoSizeCanvas(t){var e=ws.floorPowerOfTwo(t.width),i=ws.floorPowerOfTwo(t.height),s=nt.document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return s.width=e,s.height=i,s.getContext("2d").drawImage(t,0,0,e,i),s}static sizeCanvas(t,e,i){var s=nt.document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),e=(s.width=e,s.height=i,s.getContext("2d")),i=s.width/2,r=s.height/2,n=Math.min(s.width/t.width,s.height/t.height),a=t.width*n,n=t.height*n,i=i-a/2,r=r-n/2;return e.clearRect(0,0,s.width,s.height),e.drawImage(t,0,0,t.width,t.height,i,r,a,n),s}}class Vm{constructor(t){this.Wt=t,this.Cl=new Lm(this),this.Nl=new Nm({mapCreateTime:this.Wt.st.Il}),this.Pl=this.Wt.st.Ls.materialMode,this.Dl={},this.Ol=new Map,this.Ul=new Map,this.Fl=new Map,this.Bl=new Map,this.kl=new Map,this.Gl=new Map,this.Hl={},this.Vl={},this.jo=null,this.Sa=this.Sa.bind(this),this.Qh=new Qp({disposeCallback:this.Sa,enable:!0,name:"MaterialManager",mapCreateTime:this.Wt.st.Il}),this.zl=null,this.Wl={},this.jl()}get lamberMaterials(){return this.Ul}getMaterialCacheKey(t){return this.Xl(t)}regHook(t,e){this.Wl[t]||(this.Wl[t]=[]),this.Wl[t].push(e)}callHook(t,...e){t=this.Wl[t];t&&t.forEach(t=>t(...e))}}Object.assign(Vm.prototype,{Xl(t){var e,i=[];for(e in t)t[e]?t[e].isTexture?i.push(t[e].uuid):t[e].isColor?i.push(t[e].getStyle()):t[e].isVector2?(i.push(t[e].x),i.push(t[e].y)):i.push(t[e]):i.push(t[e]);return i.join()},Yl(t,e){var i=this.Zl(t),i=this.Xl(i);return this.Ol.has(i)||(t=this.ql(t,e),this.Ol.set(i,t)),this.Ol.get(i)},Kl(e,i,s){void 0!==e.url&&this.Nl.Rl({url:e.url,flipY:e.flipY},function(t){t.image&&(i.map=t,i.needsUpdate=!0),e.finish&&e.finish(i),s&&s(i)})},ql(t,e){var i;return t.isline?(i=new Mm({color:t.color,linewidth:1,transparent:!0,opacity:t.opacity}),t.isMask&&(i.isMask=t.isMask,i.maskType=t.maskType,i.maskPolygons=t.maskPolygons,i.maskHolePogygons=t.maskHolePogygons,i.maskHeight=t.maskHeight,i.maskExtrudeHeight=t.maskExtrudeHeight,i.boundCenter=t.boundCenter,i.boundSize=t.boundSize,i.maskOpacity=t.maskOpacity,i.maskNodeHeight=t.maskNodeHeight)):(i=new Bm,void 0!==t.color&&(i.color=new Wt(t.color)),void 0!==t.opacity&&(i.opacity=t.opacity),void 0!==t.isMask&&(i.isMask=t.isMask,i.maskType=t.maskType,i.maskPolygons=t.maskPolygons,i.maskHolePogygons=t.maskHolePogygons,i.maskHeight=t.maskHeight,i.maskExtrudeHeight=t.maskExtrudeHeight,i.boundCenter=t.boundCenter,i.boundSize=t.boundSize,i.maskOpacity=t.maskOpacity,i.maskNodeHeight=t.maskNodeHeight,i.transparent=!0),this.Kl(t,i,e),e=void 0!==t.needDepth&&t.needDepth,i.transparent=!0,i.depthTest=e,i.depthWrite=e),i},Jl(t){var e=this.$l(t),e=this.Xl(e);return this.Ul.has(e)||(t=this.Ql(t),this.Ul.set(e,t)),this.Ul.get(e)},tu(t){if(void 0!==t)return"number"==typeof t?new Wt(t):t.constructor===Wt?t.clone():t.constructor===String?(new Wt).setStyle(t):void 0},eu(t){var e=this.iu(t),e=this.Xl(e);if(!this.kl.has(e)){var i,s={};for(i in t)s[i]=t[i];var r=new Gm(s);this.kl.set(e,r)}return this.kl.get(e)},iu(t){return{color:this.tu(t.color),emissive:t.emissive?t.emissive.clone():new Wt(0,0,0),depthWrite:t.depthWrite??!0,map:t.map,emissiveMap:t.emissiveMap,metalness:t.metalness??0,roughness:t.roughness,opacity:t.opacity??t.alpha,side:t.side,type:t.type}},$l(t){var e={color:this.tu(t.color),depthWrite:t.depthWrite??!0,map:t.map,opacity:t.opacity??t.alpha,side:t.side,type:t.type,modelSideGradient:t.modelSideGradient,isIgnoreLighting:t.isIgnoreLighting,stencilWrite:t.stencilWrite,polygonOffset:t.polygonOffset};return t.isMask&&(e.isMask=t.isMask,e.maskType=t.maskType,e.maskPolygons=JSON.stringify(t.maskPolygons),e.maskHolePogygons=JSON.stringify(t.maskHolePogygons),e.maskHeight=t.maskHeight,e.maskExtrudeHeight=t.maskExtrudeHeight,e.boundCenter=t.boundCenter,e.boundSize=t.boundSize,e.level=t.level,e.buildingId=t.buildingId,e.maskID=t.maskID,e.maskOpacity=t.maskOpacity,e.maskNodeHeight=t.maskNodeHeight),t.url&&(e.url=t.url),e},Zl(t){var e,i={};for(e in t)"maskPolygons"===e||"maskHolePogygons"===e?i[e]=JSON.stringify(t[e]):i[e]=t[e];return i},su(t,e){(e=e||{}).uuid=t.uuid;var i=this.Xl(e);return this.Gl.has(i)||(t=t.clone(),e.color&&(t.color=new Wt(e.color)),e.opacity&&(t.opacity=e.opacity),e.transparent&&(t.transparent=e.transparent),this.Gl.set(i,t)),this.Gl.get(i)},Ql(t){var e=new Fm;return e.color=new Wt(t.color),e.opacity=t.alpha??t.opacity,e.transparent=e.opacity<1,e.modelSideGradient=t.modelSideGradient,e.isIgnoreLighting=t.isIgnoreLighting,t.isMask&&(e.isMask=t.isMask,e.maskType=t.maskType,e.maskPolygons=t.maskPolygons,e.maskHolePogygons=t.maskHolePogygons,e.maskHeight=t.maskHeight,e.maskExtrudeHeight=t.maskExtrudeHeight,e.boundCenter=t.boundCenter,e.boundSize=t.boundSize,e.maskOpacity=t.maskOpacity,e.maskNodeHeight=t.maskNodeHeight,e.transparent=!0),t.map&&(e.map=t.map),this.Kl(t,e),e},ru(t){var e=void 0===t.needDepth||t.needDepth,t=new _m({color:t.color,opacity:t.opacity,lineWidth:t.lineWidth,dashed:!1,transparent:!0,gradient:t.gradient}),e=(t.depthWrite=e,t.depthTest=e,this.Wt.st);return nt.environment===I.BROWSER?t.resolution.set(e.bt.renderer.domElement.clientWidth,e.bt.renderer.domElement.clientHeight):t.resolution.set(e.bt.renderer.domElement.width,e.bt.renderer.domElement.height),t},nu(t){var e=this.Xl(t);return this.Fl.has(e)||(t=this.ru(t),this.Fl.set(e,t)),this.Fl.get(e)},au(t,e,i){var s=new ym,t=(s.sizeAttenuation=!1,s.depthTest=!1,s.depthWrite=!1,s.transparent=!0,s.opacity=i.opacity,s.side=Zt,this.hu(t,null,e,i));return s.map=t,i.needSize&&(s.size=t.size),s.userData.scaleRatio=t.scaleRatio,s.userData.mspriteScale=t.mspriteScale,s.needsUpdate=!0,s},ou(s,r,n,a){let h=new ym;if(h.sizeAttenuation=!1,h.depthTest=!1,h.depthWrite=!1,h.opacity=n.opacity,h.transparent=!0,n.imageUrl){h.visible=!1;let e="_createLabelMaterial"+ws.generateUUID(),i=(this.Qh.Kh(e),this);Tm.fl(n.imageUrl,t=>{t=this.hu(s,t,r,{...n,callback:t=>{h.map=t,h.visible=!0,h.userData.scaleRatio=t.scaleRatio,h.userData.mspriteScale=t.mspriteScale,a&&a(h),h.needsUpdate=!0}});nt.environment===I.BROWSER&&(h.map=t,h.visible=!0,h.needsUpdate=!0,h.userData.scaleRatio=t.scaleRatio,h.userData.mspriteScale=t.mspriteScale,a)&&a(h),i.Qh.Jh(e)},{needDraw:!0})}else{var t;""!==s?(t=this.hu(s,null,r,{...n,callback:t=>{h.map=t,h.needsUpdate=!0,h.userData.scaleRatio=t.scaleRatio,h.userData.mspriteScale=t.mspriteScale,a&&a(h),h.visible=!0}}),nt.environment===I.BROWSER?(h.map=t,h.needsUpdate=!0,h.userData.scaleRatio=t.scaleRatio,h.userData.mspriteScale=t.mspriteScale,a&&a(h)):h.map||(h.visible=!1)):(a&&a(h),h.visible=!1)}return h},lu(t,e,i){return this.uu(t,i.imageUrl,e,i)},cu(s,r,n,a){let h=new ro({transparent:!0});if(n.imageUrl){h.visible=!1;let e="_createLabelTopMaterial"+ws.generateUUID(),i=(this.Qh.Kh(e),this);Tm.fl(n.imageUrl,t=>{t=this.hu(s,t,r,{...n,scale:n.scale,callback:t=>{h.map=t,h.visible=!0,a&&a(h),h.needsUpdate=!0}});nt.environment===I.BROWSER&&(h.map=t,h.visible=!0,h.needsUpdate=!0,a)&&a(h),i.Qh.Jh(e)},{needDraw:!0})}else{var t;""!==s?(t=this.hu(s,null,r,{...n,scale:n.scale,callback:t=>{t.magFilter=V,t.minFilter=ie,h.map=t,h.needsUpdate=!0,a&&a(h),h.visible=!0}}),nt.environment===I.BROWSER?(h.map=t,h.needsUpdate=!0,a&&a(h)):h.map||(h.visible=!1)):(a&&a(h),h.visible=!1)}return h},hu(t,e,i,s){var r=this.fu(t,i);this.Vl[r]||(this.Vl[r]={});let n;return n=this.Vl[r].canvas||this.Cl.wl(t,e,i,s),this.Nl?.Ll(n,{paramKey:r,labelImageCatch:this.Vl,needSize:s.needSize,callback:s.callback})},uu(t,e,i,s){return this.Cl.wl(t,e,i,s)},fu(t,e){var{alpha:e,fontsize:i,fillColor:s,image:r}=e;return[t,e,i,s,r].join()},du(t,e){var i=this.Xl(t);return this.Bl.has(i)||(t=this.vu(t,e),this.Bl.set(i,t)),e&&e(this.Bl.get(i)),this.Bl.get(i)},vu(t,e){var i=void 0!==t.opacity?t.opacity:1;let s=new ym;return s.sizeAttenuation=!1,s.depthTest=t.needDepth,s.depthWrite=t.needDepth,s.transparent=!0,s.opacity=i,s.visible=!1,this.Nl.Rl({url:t.url},function(t){t.image&&(s.map=t,s.needsUpdate=!0,s.visible=!0,s.userData.scaleRatio=t.image.width/t.image.height),e&&e(s)}),s},createArrowWidthBackTexture(i){var t=this.Cl.yl(i);if(nt.environment===I.BROWSER)return(s=new Y0(Hm.getPowerOfTwoSizeCanvas(t))).rotation=-Math.PI/2,s.updateMatrix(),s;{var s=t.toDataURL("image/png");let e=new c;return nt.textureHelper.createImage({url:s,onload:t=>{e.image=t,e.needsUpdate=!0,e.rotation=-Math.PI/2,e.updateMatrix(),i.callback&&i.callback()}}),e}},createNormalLineTexture(i){var t=this.Cl.bl(i);if(nt.environment===I.BROWSER)return new Y0(Hm.getPowerOfTwoSizeCanvas(t));{t=t.toDataURL("image/png");let e=new c;return nt.textureHelper.createImage({url:t,onload:t=>{e.image=t,e.needsUpdate=!0,i.callback&&i.callback()}}),e}},pu(i){var t=this.Cl.El(i);if(nt.environment===I.BROWSER)return new Y0(Hm.getPowerOfTwoSizeCanvas(t));{t=t.toDataURL("image/png");let e=new c;return nt.textureHelper.createImage({url:t,onload:t=>{e.image=t,e.needsUpdate=!0,i.callback&&i.callback()}}),e}},mu(t,e){var i;return this.Dl[t+e]||((i=new Em({uniforms:{color:{value:new Wt(t)},alpha:{value:e}},vertexShader:Im,fragmentShader:Pm})).transparent=!0,this.Dl[t+e]=i)},gu(t,e){t=new zh({uniforms:{color:{value:new Wt(t)},alpha:{value:e}},vertexShader:Dm,fragmentShader:Om});return t.depthTest=!0,t.depthWrite=!1,t.transparent=!0,t},_u(t,e,i={}){let s=new c,r=(s.minFilter=i.generateMipmaps?ie:V,s.generateMipmaps=!!i.generateMipmaps,s.anisotropy=4,s.wrapS=Bt,s.wrapT=Bt,"_loadTexture"+ws.generateUUID()),n=(this.Qh.Kh(r),this);return Tm.fl(t,function(t){t&&(s.image=t,s.needsUpdate=!0),e(s),n.Qh.Jh(r)}),s},Qt(t){this.jo=t,this.Nl.Qt(()=>{this.Nl=null,this.Qh.qh(!0)}),this.Vl={}},Sa(){Tm.ol(),this.Cl.Qt(),this.Cl=null,this.Ol.clear(),this.Ul.clear(),this.Fl.clear(),this.Bl.clear(),this.jo&&this.jo({name:"MaterialManager"})},jl(){this.Wt.st.Ls.hdr&&this.Wt.st.Ls.hdr.load(this.Wt.st,t=>{this.zl=t;for(var[e,i]of this.kl)i.envMap||(i.uniforms.envMap.value=this.zl,i.envMap=this.zl)})}});class zm{constructor(){this.wu={clearColor:16777215,clearAlpha:1,alphaTest:null},this.Mu=null,this.yu=new Map,this.Eu=new Map,this.xu=new Map,this.bu=new Map,this.Su=new Map,this.Au=new Map,this.Tu=new Map,this.Ru=new Map,this.Lu=new Map,this.Cu=new Map,this.Nu=new Map,this.Iu=new Map,this.Pu=new Map,this.Du=new Map,this.Ou=new Map,this.Uu=null}resize(){this.wu={clearColor:16777215,clearAlpha:1,alphaTest:null},this.yu.clear(),this.Eu.clear(),this.xu.clear(),this.bu.clear(),this.Su.clear(),this.Au.clear(),this.Tu.clear(),this.Ru.clear(),this.Lu.clear(),this.Cu.clear(),this.Nu.clear(),this.Iu.clear(),this.Pu.clear(),this.Du.clear(),this.Ou.clear()}}Object.assign(zm.prototype,{Fu(e,t,i){for(var s in t)e[s]=t[s];if(i)for(var r in i){let t=e[r];if(t){if(i[r].type)switch(i[r].type){case"toColor":t=nn.toColor(t);break;case"toFloat":t=parseFloat(t);break;case"toRgba":t=nn.toRgba(t);break;case"toString":t+=""}i[r].name?(e[i[r].name]=t,delete e[r]):e[r]=t}}return e},Bu(t){this.resize(),t&&(this.sysPath=t.sysPath,this.userPath=t.userPath,this.logoPath=t.logoPath,this.sysModelPath=t.sysModelPath,this.userModelPath=t.userModelPath,this.ku(t),this.Gu(t.extenttheme,p.EXTENT),this.Hu(t.floorextentapply,p.EXTENT),this.Vu(t.extentapply,p.EXTENT),this.Gu(t.storetheme,p.MODEL),this.Hu(t.floorapply,p.MODEL),this.Vu(t.storeapply,p.MODEL),this.Gu(t.storelabeltheme,p.LABEL),this.Hu(t.floorstorelabelapply,p.LABEL),this.Vu(t.storelabelapply,p.LABEL),this.Gu(t.poiimagetheme,p.FACILITY),this.Hu(t.floorpoiimageapply,p.FACILITY),this.Vu(t.poiimageapply,p.FACILITY),this.Gu(t.externalmodeltheme,p.EXTERNAL_MODEL),this.Hu(t.floorexternalapply,p.EXTERNAL_MODEL),this.Vu(t.externalmodelapply,p.EXTERNAL_MODEL),this.zu())},ku(t){t.viewtheme&&((t=t.viewtheme).clearcolor&&(this.wu.clearColor=nn.toColor(t.clearcolor)),t.clearalpha&&(this.wu.clearAlpha=parseFloat(t.clearalpha)),t.lighttheme&&(this.Mu=t.lighttheme),null!=t.alphatest)&&(this.wu.alphaTest=t.alphatest)},Gu:function(t,e){if(t)for(var i of t)if(i.id)switch(e){case p.EXTERNAL_MODEL:this.Pu.set(i.id,this.Fu({},i,{color:{type:"toColor"}}));break;case p.FACILITY:i.imagename&&this.Cu.set(i.id,this.Fu({},i,{imagename:{name:"imageName"}}));break;case p.LABEL:this.Tu.set(i.id,this.Fu({},i,{alpha:{type:"toFloat"},fillcolor:{name:"fillColor",type:"toRgba"},strokecolor:{name:"strokeColor",type:"toRgba"},platesize:{name:"plateSize"},platestrokecolor:{name:"plateStrokeColor",type:"toRgba"},platecolor:{name:"plateColor",type:"toRgba"},strokewidth:{name:"strokeWidth",type:"toFloat"},space:{type:"toFloat"},fontfamily:{name:"fontFamily"},fontweight:{name:"fontWeight",type:"toFloat"},imagesize:{name:"imageSize",type:"toFloat"}}));break;case p.MODEL:this.yu.set(i.id,this.Fu({},i,{color:{type:"toColor"},alpha:{type:"toFloat"},strokecolor:{name:"strokeColor",type:"toColor"},strokewidth:{name:"strokeWidth",type:"toFloat"}}));break;case p.EXTENT:this.bu.set(i.id,this.Fu({},i,{color:{type:"toColor"},alpha:{type:"toFloat"}}))}},Hu:function(t,e){if(t)for(var i of t)for(var s of i.typeapply){var r,n=this.Fu({},s,{normalid:{name:"normalID",type:"toString"},selectedid:{name:"selectID",type:"toString"}});for(r of s.type.split(","))this.Wu(e).set(r,n)}},Vu:function(t,e){if(t)for(var i of t)if(i.fids){var s,r=this.Fu({},i,{normalid:{name:"normalID",type:"toString"},selectedid:{name:"selectID",type:"toString"}});for(s of i.fids.split(","))this.ju(e).set(s,r)}},zu(){this.Eu.get("0")&&this.yu.get(this.Eu.get("0").selectID)&&(this.Uu=this.yu.get(this.Eu.get("0").selectID).color)},ju:function(t){switch(t){case p.EXTENT:return this.Au;case p.LABEL:return this.Lu;case p.FACILITY:return this.Iu;case p.MODEL:return this.xu;case p.EXTERNAL_MODEL:return this.Ou}},Wu:function(t){switch(t){case p.EXTENT:return this.Su;case p.LABEL:return this.Ru;case p.FACILITY:return this.Nu;case p.MODEL:return this.Eu;case p.EXTERNAL_MODEL:return this.Du}},Xu:function(t){switch(t){case p.EXTENT:return this.bu;case p.LABEL:return this.Tu;case p.FACILITY:return this.Cu;case p.MODEL:return this.yu;case p.EXTERNAL_MODEL:return this.Pu}},Qt(){for(var t in this.resize(),this)this[""+t]=null,delete this[""+t]}});class Wm{constructor(t){this.Wt=t}}Object.assign(Wm.prototype,{Yu(t){var t=this.Wt.Zu.get(t),e=this.Wt.Zu.get(this.Wt.Ls.buildingID);let i={};return(i=t?{theme:t.theme,themeExtension:t.themeExtension}:i).theme||(i.theme=e.theme),i.themeExtension||(i.themeExtension=e.themeExtension),i},qu(t){t=this.Yu(t);return Object.assign({},t.theme.wu,t.themeExtension.wu)},Ku(t){var e;return void 0===t.fid?(e=this.Yu(t.bid),Object.assign({},e.theme.bu.get("0"),e.themeExtension.bu.get("0"))):this.Ju(p.EXTENT,t)},$u(t){return this.Ju(p.MODEL,t)},Qu(t){return this.Ju(p.FACILITY,t)},tc(t){return this.Ju(p.LABEL,t)},ec(t){return this.Ju(p.EXTERNAL_MODEL,t)},Ju(t,e){var i=this.Yu(e.bid);let s,r;var n={},a={},h=i.themeExtension.ju(t).get(e.fid),o=i.theme.ju(t).get(e.fid);if(h||o){var l=(h&&void 0!==h.normalID?h:o).normalID;if(s=i.themeExtension.Xu(t).get(l),r=i.theme.Xu(t).get(l),s||r)return a.themeUseDetail={content:e.fid,name:"fid",isExtension:!!h},Object.assign(a,r,s,o,h)}return h=i.themeExtension.Wu(t).get(e.typeID),o=i.theme.Wu(t).get(e.typeID),(h||o)&&(a.themeUseDetail={content:e.typeID,name:"typeId",isExtension:!!h},Object.assign(n,o,h)),n.normalID||(h=i.themeExtension.Wu(t).get("0"),o=i.theme.Wu(t).get("0"),Object.assign(n,h,o)),s=i.themeExtension.Xu(t).get(n.normalID),r=i.theme.Xu(t).get(n.normalID),Object.assign(a,r,s)},ic(t){t=this.Yu(t);let e=t.themeExtension.Uu;return e=e||t.theme.Uu},Qt(){this.Wt=null},sc(t){let o=t.Ls.buildingOptions,l=o.buildings||o.theme,u=null,c=()=>{var e=t.getBuildings(),i=e.map(t=>t.Ht);if(!1===t.rc)u=setTimeout(c,1);else{null!==u&&clearTimeout(u);var s=[];if(l)for(let t=0;t<o.buildings.length;t++){var r,n=o.buildings[t],a=n.buildingID;i.includes(a)&&(r=this.Wt.nt.Gt(a),this.Wt.Zu.set(a,{theme:new zm}),r.themeLoaded=!0,r.themeNeedLoad=!1,this.Wt.nc({bid:a,theme:n.theme||o.theme,themeExtension:n.themeExtension||o.themeExtension}),s.push(a))}if(s.length!==e.length)for(let t=0;t<e.length;t++){var h=e[t].buildingID;s.includes(h)||((h=this.Wt.nt.Gt(h)).themeLoaded=!0,h.themeNeedLoad=!1)}this.Wt.nt.ac=this.Wt.hc()}};c()}});class jm{static decodeText(i){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(i);let s="";for(let t=0,e=i.length;t<e;t++)s+=String.fromCharCode(i[t]);try{return decodeURIComponent(escape(s))}catch(t){return s}}static extractUrlBase(t){var e=t.lastIndexOf("/");return-1===e?"./":t.slice(0,e+1)}static resolveURL(t,e){return"string"!=typeof t||""===t?"":(/^https?:\/\//i.test(e)&&/^\//.test(t)&&(e=e.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(t)||nt.environment==I.WX&&nt.WX_USER_DATA_PATH.test(t)||/^data:.*,.*$/i.test(t)||/^blob:.*$/i.test(t)?t:e+t)}}let Xm={enabled:!1,files:{},add:function(t,e){!1!==this.enabled&&(this.files[t]=e)},get:function(t){if(!1!==this.enabled)return this.files[t]},remove:function(t){delete this.files[t]},clear:function(){this.files={}}};class Ym{constructor(t,e,i){let s=this,r=!1,n=0,a=0,h=void 0,o=[];this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=i,this.record=new Map,this.itemStart=function(t){this.record.has(t)||this.record.set(t,{}),a++,!1===r&&void 0!==s.onStart&&s.onStart(t,n,a),r=!0},this.itemEnd=function(t){this.record.delete(t),n++,void 0!==s.onProgress&&s.onProgress(t,n,a),n===a&&(r=!1,void 0!==s.onLoad)&&s.onLoad()},this.itemError=function(t){this.record.delete(t),void 0!==s.onError&&s.onError(t)},this.resolveURL=function(t){return h?h(t):t},this.setURLModifier=function(t){return h=t,this},this.addHandler=function(t,e){return o.push(t,e),this},this.removeHandler=function(t){t=o.indexOf(t);return-1!==t&&o.splice(t,2),this},this.getHandler=function(i){for(let t=0,e=o.length;t<e;t+=2){var s=o[t],r=o[t+1];if(s.global&&(s.lastIndex=0),s.test(i))return r}return null},this.isLoaded=function(){return 0===this.record.size}}}let Zm=new Ym;class qm{constructor(t){this.manager=void 0!==t?t:Zm,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(i,s){let r=this;return new Promise(function(t,e){r.load(i,t,s,e)})}parse(){}setCrossOrigin(t){return this.crossOrigin=t,this}setWithCredentials(t){return this.withCredentials=t,this}setPath(t){return this.path=t,this}setResourcePath(t){return this.resourcePath=t,this}setRequestHeader(t){return this.requestHeader=t,this}}qm.DEFAULT_MATERIAL_NAME="__DEFAULT";var Km={};class Jm extends qm{constructor(t){super(t)}load(a,t,e,i){void 0===a&&(a=""),void 0!==this.path&&(a=this.path+a),a=this.manager.resolveURL(a);var h=this,s=Xm.get(a);if(void 0!==s)return setTimeout(function(){t&&t(s)},0),s;if(void 0===Km[a]){var r=a.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){var n=r[1],o=!!r[2],l=r[3],l=decodeURIComponent(l);o&&(l=atob(l));try{var u=(this.responseType||"").toLowerCase();switch(u){case"arraybuffer":case"blob":for(var c=new Uint8Array(l.length),f=0;f<l.length;f++)c[f]=l.charCodeAt(f);d="blob"===u?new Blob([c.buffer],{type:n}):c.buffer;break;case"document":var d=(new DOMParser).parseFromString(l,n);break;case"json":d=JSON.parse(l);break;default:d=l}setTimeout(function(){t&&t(d),h.manager.itemEnd(a)},0)}catch(t){setTimeout(function(){i&&i(t),h.manager.itemError(a),h.manager.itemEnd(a)},0)}}else{Km[a]=[],Km[a].push({onLoad:t,onProgress:e,onError:i});var v,p=new nt.XMLHttpRequest;for(v in p.open("GET",a,!0),p.addEventListener("load",function(t){var e=this.response,i=Km[a];if(delete Km[a],200===this.status||0===this.status){0===this.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),Xm.add(a,e);for(var s=0,r=i.length;s<r;s++)(n=i[s]).onLoad&&n.onLoad(e)}else{for(var n,s=0,r=i.length;s<r;s++)(n=i[s]).onError&&n.onError(t);h.manager.itemError(a)}h.manager.itemEnd(a)},!1),p.addEventListener("progress",function(t){for(var e=Km[a],i=0,s=e.length;i<s;i++){var r=e[i];r.onProgress&&r.onProgress(t)}},!1),p.addEventListener("error",function(t){var e=Km[a];delete Km[a];for(var i=0,s=e.length;i<s;i++){var r=e[i];r.onError&&r.onError(t)}h.manager.itemError(a),h.manager.itemEnd(a)},!1),p.addEventListener("abort",function(t){var e=Km[a];delete Km[a];for(var i=0,s=e.length;i<s;i++){var r=e[i];r.onError&&r.onError(t)}h.manager.itemError(a),h.manager.itemEnd(a)},!1),void 0!==this.responseType&&(p.responseType=this.responseType),void 0!==this.withCredentials&&(p.withCredentials=this.withCredentials),p.overrideMimeType&&p.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain"),this.requestHeader)p.setRequestHeader(v,this.requestHeader[v]);p.send(null)}return h.manager.itemStart(a),p}Km[a].push({onLoad:t,onProgress:e,onError:i})}setResponseType(t){return this.responseType=t,this}setWithCredentials(t){return this.withCredentials=t,this}setMimeType(t){return this.mimeType=t,this}setRequestHeader(t){return this.requestHeader=t,this}dispose(){Km={}}}class $m extends qm{constructor(t){super(t),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(t){return this.decoderPath=t,this}setDecoderConfig(t){return this.decoderConfig=t,this}setWorkerLimit(t){return this.workerLimit=t,this}setVerbosity(){console.warn("THREE.DRACOLoader: The .setVerbosity() method has been removed.")}setDrawMode(){console.warn("THREE.DRACOLoader: The .setDrawMode() method has been removed.")}setSkipDequantization(){console.warn("THREE.DRACOLoader: The .setSkipDequantization() method has been removed.")}load(t,i,e,s){var r=new Jm(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),"use-credentials"===this.crossOrigin&&r.setWithCredentials(!0),r.load(t,t=>{var e={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(t,e).then(i).catch(s)},e,s)}decodeDracoFile(t,e,i,s){s={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!i};this.decodeGeometry(t,s).then(e)}decodeGeometry(i,s){for(var t in s.attributeTypes){var e=s.attributeTypes[t];void 0!==e.BYTES_PER_ELEMENT&&(s.attributeTypes[t]=e.name)}var r,n=JSON.stringify(s);if($m.taskCache.has(i)){var a=$m.taskCache.get(i);if(a.key===n)return a.promise;if(0===i.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var h=this.workerNextTaskID++,a=i.byteLength,a=this.oc(h,a).then(t=>(r=t,new Promise((t,e)=>{r.lc[h]={resolve:t,reject:e},r.postMessage({type:"decode",id:h,taskConfig:s,buffer:i},[i])}))).then(t=>this.uc(t.geometry));return a.finally(()=>{r&&h&&this.cc(r,h)}),$m.taskCache.set(i,{key:n,promise:a}),a}uc(t){var e=new Nh;t.index&&e.setIndex(new N(t.index.array,1));for(var i=0;i<t.attributes.length;i++){var s=t.attributes[i],r=s.name,n=s.array,s=s.itemSize;e.setAttribute(r,new N(n,s))}return e}fc(i,t){var s=new Jm(this.manager);return s.setPath(this.decoderPath),s.setResponseType(t),new Promise((t,e)=>{s.load(i,t,void 0,e)})}preload(){return this.dc(),this}dc(){var i,t;return this.decoderPending||(t=[],(i="object"!=typeof WebAssembly||"js"===this.decoderConfig.type)?t.push(this.fc("draco_decoder.js","text")):(t.push(this.fc("draco_wasm_wrapper.js","text")),t.push(this.fc("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(t=>{var e=t[0],t=(i||(this.decoderConfig.wasmBinary=t[1]),$m.DRACOWorker.toString()),e=["/* draco decoder */",e,"","/* worker */",t.substring(t.indexOf("{")+1,t.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([e]))})),this.decoderPending}oc(t,e){return this.dc().then(()=>{var i;return this.workerPool.length<this.workerLimit?((i=new Worker(this.workerSourceURL)).lc={},i.vc={},i.mc=0,i.postMessage({type:"init",decoderConfig:this.decoderConfig}),i.onmessage=function(t){var e=t.data;switch(e.type){case"decode":i.lc[e.id].resolve(e);break;case"error":i.lc[e.id].reject(e);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+e.type+'"')}},this.workerPool.push(i)):this.workerPool.sort(function(t,e){return t.mc>e.mc?-1:1}),(i=this.workerPool[this.workerPool.length-1]).vc[t]=e,i.mc+=e,i})}cc(t,e){t.mc-=t.vc[e],delete t.lc[e],delete t.vc[e]}debug(){this.workerPool.map(t=>t.mc)}dispose(){for(var t=0;t<this.workerPool.length;++t)this.workerPool[t].terminate();return this.workerPool.length=0,this}}function Qm(t,e,i){return!t||!i&&t.constructor===e?t:"number"==typeof e.BYTES_PER_ELEMENT?new e(t):Array.prototype.slice.call(t)}function tg(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)}function eg(i){var e=i.length,s=new Array(e);for(let t=0;t!==e;++t)s[t]=t;return s.sort(function(t,e){return i[t]-i[e]}),s}function ig(i,s,r){var n=i.length,a=new i.constructor(n);for(let t=0,e=0;e!==n;++t){var h=r[t]*s;for(let t=0;t!==s;++t)a[e++]=i[h+t]}return a}function sg(e,i,s,r){let n=1,a=e[0];for(;void 0!==a&&void 0===a[r];)a=e[n++];if(void 0!==a){let t=a[r];if(void 0!==t)if(Array.isArray(t))for(;void 0!==(t=a[r])&&(i.push(a.time),s.push.apply(s,t)),void 0!==(a=e[n++]););else if(void 0!==t.toArray)for(;void 0!==(t=a[r])&&(i.push(a.time),t.toArray(s,s.length)),void 0!==(a=e[n++]););else for(;void 0!==(t=a[r])&&(i.push(a.time),s.push(t)),void 0!==(a=e[n++]););}}$m.DRACOWorker=function(){var i,e;onmessage=function(t){var n=t.data;switch(n.type){case"init":i=n.decoderConfig,e=new Promise(function(e){i.onModuleLoaded=function(t){e({draco:t})},DracoDecoderModule(i)});break;case"decode":var a=n.buffer,h=n.taskConfig;e.then(t=>{var t=t.draco,e=new t.Decoder,i=new t.DecoderBuffer;i.Init(new Int8Array(a),a.byteLength);try{var s=((t,e,i,s)=>{var r,n,a=s.attributeIDs,h=s.attributeTypes,o=e.GetEncodedGeometryType(i);if(o===t.TRIANGULAR_MESH)r=new t.Mesh,n=e.DecodeBufferToMesh(i,r);else{if(o!==t.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");r=new t.PointCloud,n=e.DecodeBufferToPointCloud(i,r)}if(!n.ok()||0===r.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+n.error_msg());var l,u,c,f={index:null,attributes:[]};for(l in a){var d=self[h[l]];if(s.useUniqueIDs)c=a[l],u=e.GetAttributeByUniqueId(r,c);else{if(-1===(c=e.GetAttributeId(r,t[a[l]])))continue;u=e.GetAttribute(r,c)}f.attributes.push(((t,e,i,s,r,n)=>{var a,h,o=n.num_components(),l=i.num_points()*o;switch(r){case Float32Array:a=new t.DracoFloat32Array,e.GetAttributeFloatForAllPoints(i,n,a),h=new Float32Array(l);break;case Int8Array:a=new t.DracoInt8Array,e.GetAttributeInt8ForAllPoints(i,n,a),h=new Int8Array(l);break;case Int16Array:a=new t.DracoInt16Array,e.GetAttributeInt16ForAllPoints(i,n,a),h=new Int16Array(l);break;case Int32Array:a=new t.DracoInt32Array,e.GetAttributeInt32ForAllPoints(i,n,a),h=new Int32Array(l);break;case Uint8Array:a=new t.DracoUInt8Array,e.GetAttributeUInt8ForAllPoints(i,n,a),h=new Uint8Array(l);break;case Uint16Array:a=new t.DracoUInt16Array,e.GetAttributeUInt16ForAllPoints(i,n,a),h=new Uint16Array(l);break;case Uint32Array:a=new t.DracoUInt32Array,e.GetAttributeUInt32ForAllPoints(i,n,a),h=new Uint32Array(l);break;default:throw new Error("THREE.DRACOLoader: Unexpected attribute type.")}for(var u=0;u<l;u++)h[u]=a.GetValue(u);return t.destroy(a),{name:s,array:h,itemSize:o}})(t,e,r,l,d,u))}if(o===t.TRIANGULAR_MESH){for(var v=r.num_faces(),p=new Uint32Array(3*v),m=new t.DracoInt32Array,g=0;g<v;++g){e.GetFaceFromMesh(r,g,m);for(var _=0;_<3;++_)p[3*g+_]=m.GetValue(_)}f.index={array:p,itemSize:1},t.destroy(m)}return t.destroy(r),f})(t,e,i,h),r=s.attributes.map(t=>t.array.buffer);s.index&&r.push(s.index.array.buffer),self.postMessage({type:"decode",id:n.id,geometry:s},r)}catch(t){console.error(t),self.postMessage({type:"error",id:n.id,error:t.message})}finally{t.destroy(i),t.destroy(e)}})}}},$m.taskCache=new WeakMap,$m.setDecoderPath=function(){console.warn("THREE.DRACOLoader: The .setDecoderPath() method has been removed. Use instance methods.")},$m.setDecoderConfig=function(){console.warn("THREE.DRACOLoader: The .setDecoderConfig() method has been removed. Use instance methods.")},$m.releaseDecoderModule=function(){console.warn("THREE.DRACOLoader: The .releaseDecoderModule() method has been removed. Use instance methods.")},$m.getDecoderModule=function(){console.warn("THREE.DRACOLoader: The .getDecoderModule() method has been removed. Use instance methods.")};class rg{constructor(t,e,i,s){this.parameterPositions=t,this.gc=0,this.resultBuffer=void 0!==s?s:new e.constructor(i),this.sampleValues=e,this.valueSize=i,this.settings=null,this.DefaultSettings_={}}evaluate(e){var i=this.parameterPositions;let s=this.gc,r=i[s],n=i[s-1];t:{e:{let t;i:{s:if(!(e<r)){for(var a=s+2;;){if(void 0===r){if(e<n)break s;return s=i.length,this.gc=s,this.copySampleValue_(s-1)}if(s===a)break;if(n=r,e<(r=i[++s]))break e}t=i.length;break i}if(e>=n)break t;var h=i[1];e<h&&(s=2,n=h);for(var o=s-2;;){if(void 0===n)return this.gc=0,this.copySampleValue_(0);if(s===o)break;if(r=n,e>=(n=i[--s-1]))break e}t=s,s=0}for(;s<t;){var l=s+t>>>1;e<i[l]?t=l:s=1+l}if(r=i[s],void 0===(n=i[s-1]))return this.gc=0,this.copySampleValue_(0);if(void 0===r)return s=i.length,this.gc=s,this.copySampleValue_(s-1)}this.gc=s,this.intervalChanged_(s,n,r)}return this.interpolate_(s,n,e,r)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(t){var e=this.resultBuffer,i=this.sampleValues,s=this.valueSize,r=t*s;for(let t=0;t!==s;++t)e[t]=i[r+t];return e}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class ng extends rg{constructor(t,e,i,s){super(t,e,i,s),this._c=-0,this.wc=-0,this.Mc=-0,this.yc=-0,this.DefaultSettings_={endingStart:ci,endingEnd:ci}}intervalChanged_(t,e,i){var s=this.parameterPositions;let r=t-2,n=t+1,a=s[r],h=s[n];if(void 0===a)switch(this.getSettings_().endingStart){case fi:r=t,a=2*e-i;break;case di:r=s.length-2,a=e+s[r]-s[r+1];break;default:r=t,a=i}if(void 0===h)switch(this.getSettings_().endingEnd){case fi:n=t,h=2*i-e;break;case di:n=1,h=i+s[1]-s[0];break;default:n=t-1,h=e}var o=.5*(i-e),l=this.valueSize;this._c=o/(e-a),this.Mc=o/(h-i),this.wc=r*l,this.yc=n*l}interpolate_(t,e,i,s){var r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,h=t*a,o=h-a,l=this.wc,u=this.yc,t=this._c,c=this.Mc,i=(i-e)/(s-e),s=i*i,e=s*i,f=-t*e+2*t*s-t*i,d=(1+t)*e+(-1.5-2*t)*s+(-.5+t)*i+1,v=(-1-c)*e+(1.5+c)*s+.5*i,p=c*e-c*s;for(let t=0;t!==a;++t)r[t]=f*n[l+t]+d*n[o+t]+v*n[h+t]+p*n[u+t];return r}}class ag extends rg{constructor(t,e,i,s){super(t,e,i,s)}interpolate_(t,e,i,s){var r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,h=t*a,o=h-a,l=(i-e)/(s-e),u=1-l;for(let t=0;t!==a;++t)r[t]=n[o+t]*u+n[h+t]*l;return r}}class hg extends rg{constructor(t,e,i,s){super(t,e,i,s)}interpolate_(t){return this.copySampleValue_(t-1)}}class og{constructor(t,e,i,s){if(void 0===t)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===e||0===e.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+t);this.name=t,this.times=Qm(e,this.TimeBufferType),this.values=Qm(i,this.ValueBufferType),this.setInterpolation(s||this.DefaultInterpolation)}static toJSON(t){var e=t.constructor;let i;return e.toJSON!==this.toJSON?i=e.toJSON(t):(i={name:t.name,times:Qm(t.times,Array),values:Qm(t.values,Array)},(e=t.getInterpolation())!==t.DefaultInterpolation&&(i.interpolation=e)),i.type=t.ValueTypeName,i}InterpolantFactoryMethodDiscrete(t){return new hg(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodLinear(t){return new ag(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodSmooth(t){return new ng(this.times,this.values,this.getValueSize(),t)}setInterpolation(t){let e;switch(t){case oi:e=this.InterpolantFactoryMethodDiscrete;break;case li:e=this.InterpolantFactoryMethodLinear;break;case ui:e=this.InterpolantFactoryMethodSmooth}if(void 0===e){var i="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(t===this.DefaultInterpolation)throw new Error(i);this.setInterpolation(this.DefaultInterpolation)}console.warn("THREE.KeyframeTrack:",i)}else this.createInterpolant=e;return this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return oi;case this.InterpolantFactoryMethodLinear:return li;case this.InterpolantFactoryMethodSmooth:return ui}}getValueSize(){return this.values.length/this.times.length}shift(i){if(0!==i){var s=this.times;for(let t=0,e=s.length;t!==e;++t)s[t]+=i}return this}scale(i){if(1!==i){var s=this.times;for(let t=0,e=s.length;t!==e;++t)s[t]*=i}return this}trim(t,e){var i,s=this.times,r=s.length;let n=0,a=r-1;for(;n!==r&&s[n]<t;)++n;for(;-1!==a&&s[a]>e;)--a;return++a,0===n&&a===r||(n>=a&&(a=Math.max(a,1),n=a-1),i=this.getValueSize(),this.times=s.slice(n,a),this.values=this.values.slice(n*i,a*i)),this}validate(){let i=!0;var t=this.getValueSize(),e=(t-Math.floor(t)!=0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),i=!1),this.times),s=this.values,r=e.length;0===r&&(console.error("THREE.KeyframeTrack: Track is empty.",this),i=!1);let n=null;for(let t=0;t!==r;t++){var a=e[t];if("number"==typeof a&&isNaN(a)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,t,a),i=!1;break}if(null!==n&&n>a){console.error("THREE.KeyframeTrack: Out of order keys.",this,t,a,n),i=!1;break}n=a}if(void 0!==s&&tg(s))for(let t=0,e=s.length;t!==e;++t){var h=s[t];if(isNaN(h)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,t,h),i=!1;break}}return i}optimize(){var i=this.times.slice(),s=this.values.slice(),r=this.getValueSize(),n=this.getInterpolation()===ui,a=i.length-1;let h=1;for(let t=1;t<a;++t){let e=!1;var o=i[t];if(o!==i[t+1]&&(1!==t||o!==i[0]))if(n)e=!0;else{var l=t*r,u=l-r,c=l+r;for(let t=0;t!==r;++t){var f=s[l+t];if(f!==s[u+t]||f!==s[c+t]){e=!0;break}}}if(e){if(t!==h){i[h]=i[t];var d=t*r,v=h*r;for(let t=0;t!==r;++t)s[v+t]=s[d+t]}++h}}if(0<a){i[h]=i[a];for(let t=a*r,e=h*r,i=0;i!==r;++i)s[e+i]=s[t+i];++h}return h!==i.length?(this.times=i.slice(0,h),this.values=s.slice(0,h*r)):(this.times=i,this.values=s),this}clone(){var t=this.times.slice(),e=this.values.slice(),t=new this.constructor(this.name,t,e);return t.createInterpolant=this.createInterpolant,t}}og.prototype.TimeBufferType=Float32Array,og.prototype.ValueBufferType=Float32Array,og.prototype.DefaultInterpolation=li;class lg extends og{constructor(t,e,i){super(t,e,i)}}lg.prototype.ValueTypeName="bool",lg.prototype.ValueBufferType=Array,lg.prototype.DefaultInterpolation=oi,lg.prototype.InterpolantFactoryMethodLinear=void 0,lg.prototype.InterpolantFactoryMethodSmooth=void 0;class ug extends og{}ug.prototype.ValueTypeName="color";class cg extends og{}cg.prototype.ValueTypeName="number";class fg extends rg{constructor(t,e,i,s){super(t,e,i,s)}interpolate_(t,e,i,s){var r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,h=(i-e)/(s-e);let o=t*a;for(var l=o+a;o!==l;o+=4)Ms.slerpFlat(r,0,n,o-a,n,o,h);return r}}class dg extends og{InterpolantFactoryMethodLinear(t){return new fg(this.times,this.values,this.getValueSize(),t)}}dg.prototype.ValueTypeName="quaternion",dg.prototype.InterpolantFactoryMethodSmooth=void 0;class vg extends og{constructor(t,e,i){super(t,e,i)}}vg.prototype.ValueTypeName="string",vg.prototype.ValueBufferType=Array,vg.prototype.DefaultInterpolation=oi,vg.prototype.InterpolantFactoryMethodLinear=void 0,vg.prototype.InterpolantFactoryMethodSmooth=void 0;class pg extends og{}pg.prototype.ValueTypeName="vector";class mg{constructor(t="",e=-1,i=[],s=vi){this.name=t,this.tracks=i,this.duration=e,this.blendMode=s,this.uuid=$i(),this.duration<0&&this.resetDuration()}static parse(t){var i=[],s=t.tracks,r=1/(t.fps||1);for(let t=0,e=s.length;t!==e;++t)i.push(_g(s[t]).scale(r));var e=new this(t.name,t.duration,i,t.blendMode);return e.uuid=t.uuid,e}static toJSON(t){var i=[],s=t.tracks,t={name:t.name,duration:t.duration,tracks:i,uuid:t.uuid,blendMode:t.blendMode};for(let t=0,e=s.length;t!==e;++t)i.push(og.toJSON(s[t]));return t}static CreateFromMorphTargetSequence(t,s,r,n){var a=s.length,h=[];for(let i=0;i<a;i++){let t=[],e=[];t.push((i+a-1)%a,i,(i+1)%a),e.push(0,1,0);var o=eg(t);t=ig(t,1,o),e=ig(e,1,o),n||0!==t[0]||(t.push(a),e.push(e[0])),h.push(new cg(".morphTargetInfluences["+s[i].name+"]",t,e).scale(1/r))}return new this(t,-1,h)}static findByName(t,e){let i=t;Array.isArray(t)||(i=t.geometry&&t.geometry.animations||t.animations);for(let t=0;t<i.length;t++)if(i[t].name===e)return i[t];return null}static CreateClipsFromMorphTargetSequences(i,t,e){var s={},r=/^([\w-]*?)([\d]+)$/;for(let t=0,e=i.length;t<e;t++){var n=i[t],a=n.name.match(r);if(a&&1<a.length){a=a[1];let t=s[a];t||(s[a]=t=[]),t.push(n)}}var h,o=[];for(h in s)o.push(this.CreateFromMorphTargetSequence(h,s[h],t,e));return o}static parseAnimation(t,e){if(!t)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;function i(t,e,i,s,r){var n;0!==i.length&&(sg(i,i=[],n=[],s),0!==i.length)&&r.push(new t(e,i,n))}var s=[],r=t.name||"default",n=t.fps||30,a=t.blendMode;let h=t.length||-1;var o=t.hierarchy||[];for(let t=0;t<o.length;t++){var l=o[t].keys;if(l&&0!==l.length)if(l[0].morphTargets){var u,c={};let e;for(e=0;e<l.length;e++)if(l[e].morphTargets)for(let t=0;t<l[e].morphTargets.length;t++)c[l[e].morphTargets[t]]=-1;for(u in c){var f=[],d=[];for(let t=0;t!==l[e].morphTargets.length;++t){var v=l[e];f.push(v.time),d.push(v.morphTarget===u?1:0)}s.push(new cg(".morphTargetInfluence["+u+"]",f,d))}h=c.length*n}else{var p=".bones["+e[t].name+"]";i(pg,p+".position",l,"pos",s),i(dg,p+".quaternion",l,"rot",s),i(pg,p+".scale",l,"scl",s)}}return 0===s.length?null:new this(r,h,s,a)}resetDuration(){let i=0;for(let t=0,e=this.tracks.length;t!==e;++t){var s=this.tracks[t];i=Math.max(i,s.times[s.times.length-1])}return this.duration=i,this}trim(){for(let t=0;t<this.tracks.length;t++)this.tracks[t].trim(0,this.duration);return this}validate(){let e=!0;for(let t=0;t<this.tracks.length;t++)e=e&&this.tracks[t].validate();return e}optimize(){for(let t=0;t<this.tracks.length;t++)this.tracks[t].optimize();return this}clone(){var e=[];for(let t=0;t<this.tracks.length;t++)e.push(this.tracks[t].clone());return new this.constructor(this.name,this.duration,e,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}}function gg(t){switch(t.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return cg;case"vector":case"vector2":case"vector3":case"vector4":return pg;case"color":return ug;case"quaternion":return dg;case"bool":case"boolean":return lg;case"string":return vg}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+t)}function _g(t){if(void 0===t.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");var e,i,s=gg(t.type);return void 0===t.times&&(sg(t.keys,e=[],i=[],"value"),t.times=e,t.values=i),void 0!==s.parse?s.parse(t):new s(t.name,t.times,t.values,t.interpolation)}class wg extends Js{constructor(t,e=1){super(),this.isLight=!0,this.type="Light",this.color=new Wt(t),this.intensity=e}dispose(){}copy(t,e){return super.copy(t,e),this.color.copy(t.color),this.intensity=t.intensity,this}toJSON(t){t=super.toJSON(t);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),void 0!==this.target&&(t.object.target=this.target.uuid),t}}let Mg=new Ht,yg=new Gt,Eg=new Gt;class xg{constructor(t){this.camera=t,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new ct(512,512),this.map=null,this.mapPass=null,this.matrix=new Ht,this.autoUpdate=!0,this.needsUpdate=!1,this.Ec=new Lr,this.xc=new ct(1,1),this.bc=1,this.Sc=[new Vt(0,0,1,1)]}getViewportCount(){return this.bc}getFrustum(){return this.Ec}updateMatrices(t){var e=this.camera,i=this.matrix;yg.setFromMatrixPosition(t.matrixWorld),e.position.copy(yg),Eg.setFromMatrixPosition(t.target.matrixWorld),e.lookAt(Eg),e.updateMatrixWorld(),Mg.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this.Ec.setFromProjectionMatrix(Mg),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(Mg)}getViewport(t){return this.Sc[t]}getFrameExtents(){return this.xc}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(t){return this.camera=t.camera.clone(),this.intensity=t.intensity,this.bias=t.bias,this.radius=t.radius,this.mapSize.copy(t.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){var t={};return 1!==this.intensity&&(t.intensity=this.intensity),0!==this.bias&&(t.bias=this.bias),0!==this.normalBias&&(t.normalBias=this.normalBias),1!==this.radius&&(t.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(t.mapSize=this.mapSize.toArray()),t.camera=this.camera.toJSON(!1).object,delete t.camera.matrix,t}}class bg extends xg{constructor(){super(new sr(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class Sg extends wg{constructor(t,e){super(t,e),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(Js.DEFAULT_UP),this.updateMatrix(),this.target=new Js,this.shadow=new bg}dispose(){this.shadow.dispose()}copy(t){return super.copy(t),this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}class Ag extends Js{constructor(){super(),this.isBone=!0,this.type="Bone"}}class Tg extends N{constructor(t,e,i,s=1){super(t,e,i),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=s}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}toJSON(){var t=super.toJSON();return t.meshPerAttribute=this.meshPerAttribute,t.isInstancedBufferAttribute=!0,t}}class Rg extends c{constructor(t=null,e=1,i=1,s,r,n,a,h,o=Jt,l=Jt,u,c){super(null,n,a,h,o,l,s,r,u,c),this.isDataTexture=!0,this.image={data:t,width:e,height:i},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}let Lg=new Ht,Cg=new Ht,Ng=[],Ig=new rr,Pg=new Ht,Dg=new L,Og=new Er;class Ug extends L{constructor(t,e,i){super(t,e),this.isInstancedMesh=!0,this.instanceMatrix=new Tg(new Float32Array(16*i),16),this.instanceColor=null,this.morphTexture=null,this.count=i,this.boundingBox=null,this.boundingSphere=null;for(let t=0;t<i;t++)this.setMatrixAt(t,Pg)}computeBoundingBox(){var e=this.geometry,i=this.count;null===this.boundingBox&&(this.boundingBox=new rr),null===e.boundingBox&&e.computeBoundingBox(),this.boundingBox.makeEmpty();for(let t=0;t<i;t++)this.getMatrixAt(t,Lg),Ig.copy(e.boundingBox).applyMatrix4(Lg),this.boundingBox.union(Ig)}computeBoundingSphere(){var e=this.geometry,i=this.count;null===this.boundingSphere&&(this.boundingSphere=new Er),null===e.boundingSphere&&e.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let t=0;t<i;t++)this.getMatrixAt(t,Lg),Og.copy(e.boundingSphere).applyMatrix4(Lg),this.boundingSphere.union(Og)}copy(t,e){return super.copy(t,e),this.instanceMatrix.copy(t.instanceMatrix),null!==t.morphTexture&&(this.morphTexture=t.morphTexture.clone()),null!==t.instanceColor&&(this.instanceColor=t.instanceColor.clone()),this.count=t.count,null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),this}getColorAt(t,e){e.fromArray(this.instanceColor.array,3*t)}getMatrixAt(t,e){e.fromArray(this.instanceMatrix.array,16*t)}getMorphAt(t,e){var i=e.morphTargetInfluences,s=this.morphTexture.source.data.data,r=t*(i.length+1)+1;for(let t=0;t<i.length;t++)i[t]=s[r+t]}raycast(t,s){var e=this.matrixWorld,r=this.count;if(Dg.geometry=this.geometry,Dg.material=this.material,void 0!==Dg.material&&(null===this.boundingSphere&&this.computeBoundingSphere(),Og.copy(this.boundingSphere),Og.applyMatrix4(e),!1!==t.ray.intersectsSphere(Og)))for(let i=0;i<r;i++){this.getMatrixAt(i,Lg),Cg.multiplyMatrices(e,Lg),Dg.matrixWorld=Cg,Dg.raycast(t,Ng);for(let t=0,e=Ng.length;t<e;t++){var n=Ng[t];n.instanceId=i,n.object=this,s.push(n)}Ng.length=0}}setColorAt(t,e){null===this.instanceColor&&(this.instanceColor=new Tg(new Float32Array(3*this.instanceMatrix.count).fill(1),3)),e.toArray(this.instanceColor.array,3*t)}setMatrixAt(t,e){e.toArray(this.instanceMatrix.array,16*t)}setMorphAt(t,e){var i=e.morphTargetInfluences,e=i.length+1,s=(null===this.morphTexture&&(this.morphTexture=new Rg(new Float32Array(e*this.count),e,this.count,Ee,le)),this.morphTexture.source.data.data);let r=0;for(let t=0;t<i.length;t++)r+=i[t];var n=this.geometry.morphTargetsRelative?1:1-r,e=e*t;s[e]=n,s.set(i,1+e)}updateMorphTargets(){}dispose(){return this.dispatchEvent({type:"dispose"}),null!==this.morphTexture&&(this.morphTexture.dispose(),this.morphTexture=null),this}}class Fg extends qm{constructor(t){super(t),this.isImageBitmapLoader=!0,"undefined"==typeof createImageBitmap&&console.warn("THREE.ImageBitmapLoader: createImageBitmap() not supported."),"undefined"==typeof fetch&&console.warn("THREE.ImageBitmapLoader: fetch() not supported."),this.options={premultiplyAlpha:"none"}}setOptions(t){return this.options=t,this}load(e,i,t,s){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);let r=this,n=Xm.get(e);if(void 0!==n)return r.manager.itemStart(e),n.then?void n.then(t=>{i&&i(t),r.manager.itemEnd(e)}).catch(t=>{s&&s(t)}):(setTimeout(function(){i&&i(n),r.manager.itemEnd(e)},0),n);var a={},a=(a.credentials="anonymous"===this.crossOrigin?"same-origin":"include",a.headers=this.requestHeader,fetch(e,a).then(function(t){return t.blob()}).then(function(t){return createImageBitmap(t,Object.assign(r.options,{colorSpaceConversion:"none"}))}).then(function(t){return Xm.add(e,t),i&&i(t),r.manager.itemEnd(e),t}).catch(function(t){s&&s(t),Xm.remove(e),r.manager.itemError(e),r.manager.itemEnd(e)}));Xm.add(e,a),r.manager.itemStart(e)}}let Bg=new Gt,kg=new Gt,Gg=new Ht,Hg=new Ja,Vg=new Er,zg=new Gt,Wg=new Gt;class jg extends Js{constructor(t=new Nh,e=new wm){super(),this.isLine=!0,this.type="Line",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}computeLineDistances(){var t=this.geometry;if(null===t.index){var i=t.attributes.position,s=[0];for(let t=1,e=i.count;t<e;t++)Bg.fromBufferAttribute(i,t-1),kg.fromBufferAttribute(i,t),s[t]=s[t-1],s[t]+=Bg.distanceTo(kg);t.setAttribute("lineDistance",new ph(s,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(i,s){var r=this.geometry,n=this.matrixWorld,t=i.params.Line.threshold,e=r.drawRange;if(null===r.boundingSphere&&r.computeBoundingSphere(),Vg.copy(r.boundingSphere),Vg.applyMatrix4(n),Vg.radius+=t,!1!==i.ray.intersectsSphere(Vg)){Gg.copy(n).invert(),Hg.copy(i.ray).applyMatrix4(Gg);var n=t/((this.scale.x+this.scale.y+this.scale.z)/3),a=n*n,h=this.isLineSegments?2:1,o=r.index,t=r.attributes.position;if(null!==o){var n=Math.max(0,e.start),r=Math.min(o.count,e.start+e.count);for(let t=n,e=r-1;t<e;t+=h){var l=o.getX(t),u=o.getX(t+1),l=Xg(this,i,Hg,a,l,u);l&&s.push(l)}this.isLineLoop&&(r=o.getX(r-1),n=o.getX(n),r=Xg(this,i,Hg,a,r,n))&&s.push(r)}else{n=Math.max(0,e.start),r=Math.min(t.count,e.start+e.count);for(let t=n,e=r-1;t<e;t+=h){var c=Xg(this,i,Hg,a,t,t+1);c&&s.push(c)}this.isLineLoop&&(t=Xg(this,i,Hg,a,r-1,n))&&s.push(t)}}}updateMorphTargets(){var t=this.geometry.morphAttributes,e=Object.keys(t);if(0<e.length){var i=t[e[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=i.length;t<e;t++){var s=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[s]=t}}}}}function Xg(t,e,i,s,r,n){var a=t.geometry.attributes.position,a=(Bg.fromBufferAttribute(a,r),kg.fromBufferAttribute(a,n),i.distanceSqToSegment(Bg,kg,zg,Wg));if(!(s<a)){zg.applyMatrix4(t.matrixWorld);n=e.ray.origin.distanceTo(zg);if(!(n<e.near||n>e.far))return{distance:n,point:Wg.clone().applyMatrix4(t.matrixWorld),index:r,face:null,faceIndex:null,barycoord:null,object:t}}}class Yg extends jg{constructor(t,e){super(t,e),this.isLineLoop=!0,this.type="LineLoop"}}let Zg=new Gt,qg=new Gt;class Kg extends jg{constructor(t,e){super(t,e),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){var t=this.geometry;if(null===t.index){var i=t.attributes.position,s=[];for(let t=0,e=i.count;t<e;t+=2)Zg.fromBufferAttribute(i,t),qg.fromBufferAttribute(i,t+1),s[t]=0===t?0:s[t-1],s[t+1]=s[t]+Zg.distanceTo(qg);t.setAttribute("lineDistance",new ph(s,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}let Jg=new Ht,$g=new Gt,Qg=new Gt;class t_ extends xg{constructor(){super(new ir(90,1,.5,500)),this.isPointLightShadow=!0,this.xc=new ct(4,2),this.bc=6,this.Sc=[new Vt(2,1,1,1),new Vt(0,1,1,1),new Vt(3,1,1,1),new Vt(1,1,1,1),new Vt(3,0,1,1),new Vt(1,0,1,1)],this.Ac=[new Gt(1,0,0),new Gt(-1,0,0),new Gt(0,0,1),new Gt(0,0,-1),new Gt(0,1,0),new Gt(0,-1,0)],this.Tc=[new Gt(0,1,0),new Gt(0,1,0),new Gt(0,1,0),new Gt(0,1,0),new Gt(0,0,1),new Gt(0,0,-1)]}updateMatrices(t,e=0){var i=this.camera,s=this.matrix,r=t.distance||i.far;r!==i.far&&(i.far=r,i.updateProjectionMatrix()),$g.setFromMatrixPosition(t.matrixWorld),i.position.copy($g),Qg.copy(i.position),Qg.add(this.Ac[e]),i.up.copy(this.Tc[e]),i.lookAt(Qg),i.updateMatrixWorld(),s.makeTranslation(-$g.x,-$g.y,-$g.z),Jg.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),this.Ec.setFromProjectionMatrix(Jg)}}class e_ extends wg{constructor(t,e,i=0,s=2){super(t,e),this.isPointLight=!0,this.type="PointLight",this.distance=i,this.decay=s,this.shadow=new t_}get power(){return 4*this.intensity*Math.PI}set power(t){this.intensity=t/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(t,e){return super.copy(t,e),this.distance=t.distance,this.decay=t.decay,this.shadow=t.shadow.clone(),this}}class i_ extends Oh{constructor(t){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new Wt(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.size=t.size,this.sizeAttenuation=t.sizeAttenuation,this.fog=t.fog,this}}let s_=new Ht,r_=new Ja,n_=new Er,a_=new Gt;class h_ extends Js{constructor(t=new Nh,e=new i_){super(),this.isPoints=!0,this.type="Points",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}raycast(i,s){var t=this.geometry,r=this.matrixWorld,e=i.params.Points.threshold,n=t.drawRange;if(null===t.boundingSphere&&t.computeBoundingSphere(),n_.copy(t.boundingSphere),n_.applyMatrix4(r),n_.radius+=e,!1!==i.ray.intersectsSphere(n_)){s_.copy(r).invert(),r_.copy(i.ray).applyMatrix4(s_);var e=e/((this.scale.x+this.scale.y+this.scale.z)/3),a=e*e,h=t.index,o=t.attributes.position;if(null!==h)for(let t=Math.max(0,n.start),e=Math.min(h.count,n.start+n.count);t<e;t++){var l=h.getX(t);a_.fromBufferAttribute(o,l),o_(a_,l,a,r,i,s,this)}else for(let t=Math.max(0,n.start),e=Math.min(o.count,n.start+n.count);t<e;t++)a_.fromBufferAttribute(o,t),o_(a_,t,a,r,i,s,this)}}updateMorphTargets(){var t=this.geometry.morphAttributes,e=Object.keys(t);if(0<e.length){var i=t[e[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=i.length;t<e;t++){var s=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[s]=t}}}}}function o_(t,e,i,s,r,n,a){var h=r_.distanceSqToPoint(t);h<i&&(i=new Gt,r_.closestPointToPoint(t,i),i.applyMatrix4(s),(t=r.ray.origin.distanceTo(i))<r.near||t>r.far||n.push({distance:t,distanceToRay:Math.sqrt(h),point:i,index:e,face:null,faceIndex:null,barycoord:null,object:a}))}let l_="\\[\\]\\.:\\/",u_=new RegExp("["+l_+"]","g"),c_="[^"+l_+"]",f_="[^"+l_.replace("\\.","")+"]",d_=/((?:WC+[\/:])*)/.source.replace("WC",c_),v_=/(WCOD+)?/.source.replace("WCOD",f_),p_=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",c_),m_=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",c_),g_=new RegExp("^"+d_+v_+p_+m_+"$"),__=["material","materials","bones","map"];class w_{constructor(t,e,i){i=i||d.parseTrackName(e);this.Rc=t,this.Lc=t.subscribe_(e,i)}getValue(t,e){this.bind();var i=this.Rc.nCachedObjects_,i=this.Lc[i];void 0!==i&&i.getValue(t,e)}setValue(i,s){var r=this.Lc;for(let t=this.Rc.nCachedObjects_,e=r.length;t!==e;++t)r[t].setValue(i,s)}bind(){var i=this.Lc;for(let t=this.Rc.nCachedObjects_,e=i.length;t!==e;++t)i[t].bind()}unbind(){var i=this.Lc;for(let t=this.Rc.nCachedObjects_,e=i.length;t!==e;++t)i[t].unbind()}}class d{constructor(t,e,i){this.path=e,this.parsedPath=i||d.parseTrackName(e),this.node=d.findNode(t,this.parsedPath.nodeName),this.rootNode=t,this.getValue=this.Cc,this.setValue=this.Nc}static create(t,e,i){return new(t&&t.isAnimationObjectGroup?d.Composite:d)(t,e,i)}static sanitizeNodeName(t){return t.replace(/\s/g,"_").replace(u_,"")}static parseTrackName(t){var e=g_.exec(t);if(null===e)throw new Error("PropertyBinding: Cannot parse trackName: "+t);var i,e={nodeName:e[2],objectName:e[3],objectIndex:e[4],propertyName:e[5],propertyIndex:e[6]},s=e.nodeName&&e.nodeName.lastIndexOf(".");if(void 0!==s&&-1!==s&&(i=e.nodeName.substring(s+1),-1!==__.indexOf(i))&&(e.nodeName=e.nodeName.substring(0,s),e.objectName=i),null===e.propertyName||0===e.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+t);return e}static findNode(t,r){if(void 0===r||""===r||"."===r||-1===r||r===t.name||r===t.uuid)return t;if(t.skeleton){var e=t.skeleton.getBoneByName(r);if(void 0!==e)return e}if(t.children){let s=function(e){for(let t=0;t<e.length;t++){var i=e[t];if(i.name===r||i.uuid===r)return i;i=s(i.children);if(i)return i}return null};e=s(t.children);if(e)return e}return null}Ic(){}Pc(){}Dc(t,e){t[e]=this.targetObject[this.propertyName]}Oc(i,s){var r=this.resolvedProperty;for(let t=0,e=r.length;t!==e;++t)i[s++]=r[t]}Uc(t,e){t[e]=this.resolvedProperty[this.propertyIndex]}Fc(t,e){this.resolvedProperty.toArray(t,e)}Bc(t,e){this.targetObject[this.propertyName]=t[e]}kc(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.needsUpdate=!0}Gc(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}Hc(i,s){var r=this.resolvedProperty;for(let t=0,e=r.length;t!==e;++t)r[t]=i[s++]}Vc(i,s){var r=this.resolvedProperty;for(let t=0,e=r.length;t!==e;++t)r[t]=i[s++];this.targetObject.needsUpdate=!0}zc(i,s){var r=this.resolvedProperty;for(let t=0,e=r.length;t!==e;++t)r[t]=i[s++];this.targetObject.matrixWorldNeedsUpdate=!0}Wc(t,e){this.resolvedProperty[this.propertyIndex]=t[e]}jc(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.needsUpdate=!0}Xc(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}Yc(t,e){this.resolvedProperty.fromArray(t,e)}Zc(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.needsUpdate=!0}qc(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.matrixWorldNeedsUpdate=!0}Cc(t,e){this.bind(),this.getValue(t,e)}Nc(t,e){this.bind(),this.setValue(t,e)}bind(){let i=this.node;var t=this.parsedPath,s=t.objectName,r=t.propertyName;let n=t.propertyIndex;if(i||(i=d.findNode(this.rootNode,t.nodeName),this.node=i),this.getValue=this.Ic,this.setValue=this.Pc,i){if(s){let e=t.objectIndex;switch(s){case"materials":if(!i.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!i.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);i=i.material.materials;break;case"bones":if(!i.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);i=i.skeleton.bones;for(let t=0;t<i.length;t++)if(i[t].name===e){e=t;break}break;case"map":if("map"in i)i=i.map;else{if(!i.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!i.material.map)return void console.error("THREE.PropertyBinding: Can not bind to material.map as node.material does not have a map.",this);i=i.material.map}break;default:if(void 0===i[s])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);i=i[s]}if(void 0!==e){if(void 0===i[e])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,i);i=i[e]}}var a=i[r];if(void 0===a)t=t.nodeName,console.error("THREE.PropertyBinding: Trying to update property for track: "+t+"."+r+" but it wasn't found.",i);else{let t=this.Versioning.None,e=(void 0!==(this.targetObject=i).needsUpdate?t=this.Versioning.NeedsUpdate:void 0!==i.matrixWorldNeedsUpdate&&(t=this.Versioning.MatrixWorldNeedsUpdate),this.BindingType.Direct);if(void 0!==n){if("morphTargetInfluences"===r){if(!i.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!i.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==i.morphTargetDictionary[n]&&(n=i.morphTargetDictionary[n])}e=this.BindingType.ArrayElement,this.resolvedProperty=a,this.propertyIndex=n}else void 0!==a.fromArray&&void 0!==a.toArray?(e=this.BindingType.HasFromToArray,this.resolvedProperty=a):Array.isArray(a)?(e=this.BindingType.EntireArray,this.resolvedProperty=a):this.propertyName=r;this.getValue=this.GetterByBindingType[e],this.setValue=this.SetterByBindingTypeAndVersioning[e][t]}}else console.warn("THREE.PropertyBinding: No target node found for track: "+this.path+".")}unbind(){this.node=null,this.getValue=this.Cc,this.setValue=this.Nc}}d.Composite=w_,d.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},d.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},d.prototype.GetterByBindingType=[d.prototype.Dc,d.prototype.Oc,d.prototype.Uc,d.prototype.Fc],d.prototype.SetterByBindingTypeAndVersioning=[[d.prototype.Bc,d.prototype.kc,d.prototype.Gc],[d.prototype.Hc,d.prototype.Vc,d.prototype.zc],[d.prototype.Wc,d.prototype.jc,d.prototype.Xc],[d.prototype.Yc,d.prototype.Zc,d.prototype.qc]];let M_=new Ht,y_=new Ht;class E_{constructor(t=[],e=[]){this.uuid=$i(),this.bones=t.slice(0),this.boneInverses=e,this.boneMatrices=null,this.boneTexture=null,this.init()}init(){var t=this.bones,e=this.boneInverses;if(this.boneMatrices=new Float32Array(16*t.length),0===e.length)this.calculateInverses();else if(t.length!==e.length){console.warn("THREE.Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let t=0,e=this.bones.length;t<e;t++)this.boneInverses.push(new Ht)}}calculateInverses(){for(let t=this.boneInverses.length=0,e=this.bones.length;t<e;t++){var i=new Ht;this.bones[t]&&i.copy(this.bones[t].matrixWorld).invert(),this.boneInverses.push(i)}}pose(){for(let t=0,e=this.bones.length;t<e;t++){var i=this.bones[t];i&&i.matrixWorld.copy(this.boneInverses[t]).invert()}for(let t=0,e=this.bones.length;t<e;t++){var s=this.bones[t];s&&(s.parent&&s.parent.isBone?(s.matrix.copy(s.parent.matrixWorld).invert(),s.matrix.multiply(s.matrixWorld)):s.matrix.copy(s.matrixWorld),s.matrix.decompose(s.position,s.quaternion,s.scale))}}update(){var i=this.bones,s=this.boneInverses,r=this.boneMatrices,t=this.boneTexture;for(let t=0,e=i.length;t<e;t++){var n=i[t]?i[t].matrixWorld:y_;M_.multiplyMatrices(n,s[t]),M_.toArray(r,16*t)}null!==t&&(t.needsUpdate=!0)}clone(){return new E_(this.bones,this.boneInverses)}computeBoneTexture(){var t=Math.sqrt(4*this.bones.length),t=4*Math.ceil(t/4),e=(t=Math.max(t,4),new Float32Array(t*t*4)),t=(e.set(this.boneMatrices),new Rg(e,t,t,ge,le));return t.needsUpdate=!0,this.boneMatrices=e,this.boneTexture=t,this}getBoneByName(i){for(let t=0,e=this.bones.length;t<e;t++){var s=this.bones[t];if(s.name===i)return s}}dispose(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(i,s){this.uuid=i.uuid;for(let e=0,t=i.bones.length;e<t;e++){var r=i.bones[e];let t=s[r];void 0===t&&(console.warn("THREE.Skeleton: No bone found with UUID:",r),t=new Ag),this.bones.push(t),this.boneInverses.push((new Ht).fromArray(i.boneInverses[e]))}return this.init(),this}toJSON(){var i={metadata:{version:4.6,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]},s=(i.uuid=this.uuid,this.bones),r=this.boneInverses;for(let t=0,e=s.length;t<e;t++){var n=s[t],n=(i.bones.push(n.uuid),r[t]);i.boneInverses.push(n.toArray())}return i}}let x_=new Gt,b_=new Vt,S_=new Vt,A_=new Gt,T_=new Ht,R_=new Gt,L_=new Er,C_=new Ht,N_=new Ja;class I_ extends L{constructor(t,e){super(t,e),this.isSkinnedMesh=!0,this.type="SkinnedMesh",this.bindMode=F,this.bindMatrix=new Ht,this.bindMatrixInverse=new Ht,this.boundingBox=null,this.boundingSphere=null}computeBoundingBox(){var t=this.geometry,e=(null===this.boundingBox&&(this.boundingBox=new rr),this.boundingBox.makeEmpty(),t.getAttribute("position"));for(let t=0;t<e.count;t++)this.getVertexPosition(t,R_),this.boundingBox.expandByPoint(R_)}computeBoundingSphere(){var t=this.geometry,e=(null===this.boundingSphere&&(this.boundingSphere=new Er),this.boundingSphere.makeEmpty(),t.getAttribute("position"));for(let t=0;t<e.count;t++)this.getVertexPosition(t,R_),this.boundingSphere.expandByPoint(R_)}copy(t,e){return super.copy(t,e),this.bindMode=t.bindMode,this.bindMatrix.copy(t.bindMatrix),this.bindMatrixInverse.copy(t.bindMatrixInverse),this.skeleton=t.skeleton,null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),this}raycast(t,e){var i=this.material,s=this.matrixWorld;void 0!==i&&(null===this.boundingSphere&&this.computeBoundingSphere(),L_.copy(this.boundingSphere),L_.applyMatrix4(s),!1!==t.ray.intersectsSphere(L_))&&(C_.copy(s).invert(),N_.copy(t.ray).applyMatrix4(C_),null===this.boundingBox||!1!==N_.intersectsBox(this.boundingBox))&&this.ln(t,e,N_)}getVertexPosition(t,e){return super.getVertexPosition(t,e),this.applyBoneTransform(t,e),e}bind(t,e){this.skeleton=t,void 0===e&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),e=this.matrixWorld),this.bindMatrix.copy(e),this.bindMatrixInverse.copy(e).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){var i=new Vt,s=this.geometry.attributes.skinWeight;for(let t=0,e=s.count;t<e;t++){i.fromBufferAttribute(s,t);var r=1/i.manhattanLength();r!=1/0?i.multiplyScalar(r):i.set(1,0,0,0),s.setXYZW(t,i.x,i.y,i.z,i.w)}}updateMatrixWorld(t){super.updateMatrixWorld(t),this.bindMode===F?this.bindMatrixInverse.copy(this.matrixWorld).invert():this.bindMode===e?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}applyBoneTransform(t,e){var i=this.skeleton,s=this.geometry;b_.fromBufferAttribute(s.attributes.skinIndex,t),S_.fromBufferAttribute(s.attributes.skinWeight,t),x_.copy(e).applyMatrix4(this.bindMatrix),e.set(0,0,0);for(let t=0;t<4;t++){var r,n=S_.getComponent(t);0!==n&&(r=b_.getComponent(t),T_.multiplyMatrices(i.bones[r].matrixWorld,i.boneInverses[r]),e.addScaledVector(A_.copy(x_).applyMatrix4(T_),n))}return e.applyMatrix4(this.bindMatrixInverse)}}class P_ extends xg{constructor(){super(new ir(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1}updateMatrices(t){var e=this.camera,i=2*Ji*t.angle*this.focus,s=this.mapSize.width/this.mapSize.height,r=t.distance||e.far;i===e.fov&&s===e.aspect&&r===e.far||(e.fov=i,e.aspect=s,e.far=r,e.updateProjectionMatrix()),super.updateMatrices(t)}copy(t){return super.copy(t),this.focus=t.focus,this}}class D_ extends wg{constructor(t,e,i=0,s=Math.PI/3,r=0,n=2){super(t,e),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(Js.DEFAULT_UP),this.updateMatrix(),this.target=new Js,this.distance=i,this.angle=s,this.penumbra=r,this.decay=n,this.map=null,this.shadow=new P_}get power(){return this.intensity*Math.PI}set power(t){this.intensity=t/Math.PI}dispose(){this.shadow.dispose()}copy(t,e){return super.copy(t,e),this.distance=t.distance,this.angle=t.angle,this.penumbra=t.penumbra,this.decay=t.decay,this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}function O_(s,r,t,e,n,a){let i;if(s.includes(wx.env.USER_DATA_PATH)){let i=wx.getFileSystemManager();i.readFile({filePath:s,encoding:"base64",success:t=>{t="data:image/png;base64,"+t.data;let e=nt.textureHelper.createImage({url:t,onload:()=>{n.add(s,e),r&&r(e),a.manager.itemEnd(s),i.unlink({filePath:s,fail(t){},success:()=>{}})}})},fail:t=>{console.error(t),e&&e(t),a.manager.itemError(s),a.manager.itemEnd(s)}})}else i=nt.textureHelper.createImage({url:s,onload:()=>{n.add(s,i),r&&r(i),a.manager.itemEnd(s)},onerror:t=>{console.error(t),e&&e(t),a.manager.itemError(s),a.manager.itemEnd(s)}});return i}class U_ extends qm{constructor(t){super(t)}load(e,t,i,s){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);let r=this,n=Xm.get(e);if(void 0!==n)return r.manager.itemStart(e),setTimeout(function(){t&&t(n),r.manager.itemEnd(e)},0),n;if(nt.environment===I.WX)return O_(e,t,i,s,Xm,r);let a=gh("img");function h(){l(),Xm.add(e,this),t&&t(this),r.manager.itemEnd(e)}function o(t){l(),s&&s(t),r.manager.itemError(e),r.manager.itemEnd(e)}function l(){a.removeEventListener("load",h,!1),a.removeEventListener("error",o,!1)}return a.addEventListener("load",h,!1),a.addEventListener("error",o,!1),"data:"!==e.slice(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),r.manager.itemStart(e),a.src=e,a}}class F_ extends qm{constructor(t){super(t)}load(t,e,i,s){let r=new c;var n=new U_(this.manager);return n.setCrossOrigin(this.crossOrigin),n.setPath(this.path),n.load(t,function(t){r.image=t,r.needsUpdate=!0,void 0!==e&&e(r)},i,s),r}}function B_(t,i){if(i===mi)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),t;if(i!==_i&&i!==gi)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",i),t;{let e=t.getIndex();if(null===e){var s=[],r=t.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),t;for(let t=0;t<r.count;t++)s.push(t);t.setIndex(s),e=t.getIndex()}var n=e.count-2,a=[];if(i===_i)for(let t=1;t<=n;t++)a.push(e.getX(0)),a.push(e.getX(t)),a.push(e.getX(t+1));else for(let t=0;t<n;t++)t%2==0?(a.push(e.getX(t)),a.push(e.getX(t+1)),a.push(e.getX(t+2))):(a.push(e.getX(t+2)),a.push(e.getX(t+1)),a.push(e.getX(t)));a.length/3!=n&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");i=t.clone();return i.setIndex(a),i.clearGroups(),i}}class k_ extends km{constructor(t){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new ct(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return Qi(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(t){this.ior=(1+.4*t)/(1-.4*t)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new Wt(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new Wt(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new Wt(1,1,1),this.specularColorMap=null,this.Kc=0,this.Jc=0,this.$c=0,this.Qc=0,this.tf=0,this.ef=0,this.setValues(t)}get anisotropy(){return this.Kc}set anisotropy(t){0<this.Kc!=0<t&&this.version++,this.Kc=t}get clearcoat(){return this.Jc}set clearcoat(t){0<this.Jc!=0<t&&this.version++,this.Jc=t}get iridescence(){return this.Qc}set iridescence(t){0<this.Qc!=0<t&&this.version++,this.Qc=t}get dispersion(){return this.$c}set dispersion(t){0<this.$c!=0<t&&this.version++,this.$c=t}get sheen(){return this.tf}set sheen(t){0<this.tf!=0<t&&this.version++,this.tf=t}get transmission(){return this.ef}set transmission(t){0<this.ef!=0<t&&this.version++,this.ef=t}copy(t){return super.copy(t),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=t.anisotropy,this.anisotropyRotation=t.anisotropyRotation,this.anisotropyMap=t.anisotropyMap,this.clearcoat=t.clearcoat,this.clearcoatMap=t.clearcoatMap,this.clearcoatRoughness=t.clearcoatRoughness,this.clearcoatRoughnessMap=t.clearcoatRoughnessMap,this.clearcoatNormalMap=t.clearcoatNormalMap,this.clearcoatNormalScale.copy(t.clearcoatNormalScale),this.dispersion=t.dispersion,this.ior=t.ior,this.iridescence=t.iridescence,this.iridescenceMap=t.iridescenceMap,this.iridescenceIOR=t.iridescenceIOR,this.iridescenceThicknessRange=[...t.iridescenceThicknessRange],this.iridescenceThicknessMap=t.iridescenceThicknessMap,this.sheen=t.sheen,this.sheenColor.copy(t.sheenColor),this.sheenColorMap=t.sheenColorMap,this.sheenRoughness=t.sheenRoughness,this.sheenRoughnessMap=t.sheenRoughnessMap,this.transmission=t.transmission,this.transmissionMap=t.transmissionMap,this.thickness=t.thickness,this.thicknessMap=t.thicknessMap,this.attenuationDistance=t.attenuationDistance,this.attenuationColor.copy(t.attenuationColor),this.specularIntensity=t.specularIntensity,this.specularIntensityMap=t.specularIntensityMap,this.specularColor.copy(t.specularColor),this.specularColorMap=t.specularColorMap,this}}function G_(t){let e;var i;return(e=nt.environment===I.BROWSER&&"undefined"!=typeof TextDecoder?(i=new TextDecoder).decode.bind(i):jm.decodeText)(t)}let H_=0;class V_ extends qm{constructor(t,e){super(t),this.materialManager=e,this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new Y_(t)}),this.register(function(t){return new Z_(t)}),this.register(function(t){return new s2(t)}),this.register(function(t){return new r2(t)}),this.register(function(t){return new n2(t)}),this.register(function(t){return new K_(t)}),this.register(function(t){return new J_(t)}),this.register(function(t){return new $_(t)}),this.register(function(t){return new Q_(t)}),this.register(function(t){return new X_(t)}),this.register(function(t){return new t2(t)}),this.register(function(t){return new q_(t)}),this.register(function(t){return new i2(t)}),this.register(function(t){return new e2(t)}),this.register(function(t){return new W_(t)}),this.register(function(t){return new a2(t)}),this.register(function(t){return new h2(t)})}load(i,s,t,e){let r=this,n;n=""!==this.resourcePath?this.resourcePath:""!==this.path?(h=jm.extractUrlBase(i),jm.resolveURL(h,this.path)):jm.extractUrlBase(i),this.manager.itemStart(i);function a(t){e?e(t):console.error(t),r.manager.itemError(i),r.manager.itemEnd(i)}var h=new Jm(this.manager);h.setPath(this.path),h.setResponseType("arraybuffer"),h.setRequestHeader(this.requestHeader),h.setWithCredentials(this.withCredentials),h.load(i,function(e){try{r.parse(e,n,function(t){s(t,e),r.manager.itemEnd(i)},a)}catch(t){a(t)}},t,a)}setDRACOLoader(t){return this.dracoLoader=t,this}setKTX2Loader(t){return this.ktx2Loader=t,this}setMeshoptDecoder(t){return this.meshoptDecoder=t,this}register(t){return-1===this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.push(t),this}unregister(t){return-1!==this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this}parse(t,e,i,s){let r;var n={},a={};if("string"==typeof t)r=JSON.parse(t);else if(t instanceof ArrayBuffer)if(G_(new Uint8Array(t,0,4))===o2){try{n[f.KHR_BINARY_GLTF]=new c2(t)}catch(t){return void(s&&s(t))}r=JSON.parse(n[f.KHR_BINARY_GLTF].content)}else r=JSON.parse(G_(t));else r=t;if(void 0===r.asset||r.asset.version[0]<2)s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{var h=new F2(r,{path:e||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder},this.materialManager);h.fileLoader.setRequestHeader(this.requestHeader);for(let t=0;t<this.pluginCallbacks.length;t++){var o=this.pluginCallbacks[t](h);o.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),n[(a[o.name]=o).name]=!0}if(r.extensionsUsed)for(let t=0;t<r.extensionsUsed.length;++t){var l=r.extensionsUsed[t],u=r.extensionsRequired||[];switch(l){case f.KHR_MATERIALS_UNLIT:n[l]=new j_;break;case f.KHR_DRACO_MESH_COMPRESSION:n[l]=new f2(r,this.dracoLoader);break;case f.KHR_TEXTURE_TRANSFORM:n[l]=new d2;break;case f.KHR_MESH_QUANTIZATION:n[l]=new v2;break;default:0<=u.indexOf(l)&&void 0===a[l]&&console.warn('THREE.GLTFLoader: Unknown extension "'+l+'".')}}h.setExtensions(n),h.setPlugins(a),h.parse(i,s)}}parseAsync(i,s){let r=this;return new Promise(function(t,e){r.parse(i,s,t,e)})}}function z_(){let i={};return{get:function(t){return i[t]},add:function(t,e){i[t]=e},remove:function(t){delete i[t]},removeAll:function(){i={}}}}let f={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class W_{constructor(t){this.parser=t,this.name=f.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}if(){var i=this.parser,s=this.parser.json.nodes||[];for(let t=0,e=s.length;t<e;t++){var r=s[t];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&i.sf(this.cache,r.extensions[this.name].light)}}rf(e){var i=this.parser,s="light:"+e,r=i.cache.get(s);if(!r){var n=i.json,a=((n.extensions&&n.extensions[this.name]||{}).lights||[])[e];let t;var h=new Wt(16777215),o=(void 0!==a.color&&h.setRGB(a.color[0],a.color[1],a.color[2],Si),void 0!==a.range?a.range:0);switch(a.type){case"directional":(t=new Sg(h)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new e_(h)).distance=o;break;case"spot":(t=new D_(h)).distance=o,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,t.angle=a.spot.outerConeAngle,t.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}t.position.set(0,0,0),t.decay=2,L2(t,a),void 0!==a.intensity&&(t.intensity=a.intensity),t.name=i.createUniqueName(a.name||"light_"+e),r=Promise.resolve(t),i.cache.add(s,r)}return r}getDependency(t,e){if("light"===t)return this.rf(e)}createNodeAttachment(t){let e=this,i=this.parser;t=i.json.nodes[t];let s=(t.extensions&&t.extensions[this.name]||{}).light;return void 0===s?null:this.rf(s).then(function(t){return i.nf(e.cache,s,t)})}}class j_{constructor(){this.name=f.KHR_MATERIALS_UNLIT}getMaterialType(){return ro}extendParams(t,e,i){var s,r=[],e=(t.color=new Wt(1,1,1),t.opacity=1,e.pbrMetallicRoughness);return e&&(Array.isArray(e.baseColorFactor)&&(s=e.baseColorFactor,t.color.setRGB(s[0],s[1],s[2],Si),t.opacity=s[3]),void 0!==e.baseColorTexture)&&r.push(i.assignTexture(t,"map",e.baseColorTexture,Yr())),Promise.all(r)}}class X_{constructor(t){this.parser=t,this.name=f.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(t,e){var t=this.parser.json.materials[t];return t.extensions&&t.extensions[this.name]&&void 0!==(t=t.extensions[this.name].emissiveStrength)&&(e.emissiveIntensity=t),Promise.resolve()}}class Y_{constructor(t){this.parser=t,this.name=f.KHR_MATERIALS_CLEARCOAT}getMaterialType(t){t=this.parser.json.materials[t];return t.extensions&&t.extensions[this.name]?k_:null}extendMaterialParams(t,e){var i,s=this.parser,t=s.json.materials[t];return t.extensions&&t.extensions[this.name]?(i=[],void 0!==(t=t.extensions[this.name]).clearcoatFactor&&(e.clearcoat=t.clearcoatFactor),void 0!==t.clearcoatTexture&&i.push(s.assignTexture(e,"clearcoatMap",t.clearcoatTexture)),void 0!==t.clearcoatRoughnessFactor&&(e.clearcoatRoughness=t.clearcoatRoughnessFactor),void 0!==t.clearcoatRoughnessTexture&&i.push(s.assignTexture(e,"clearcoatRoughnessMap",t.clearcoatRoughnessTexture)),void 0!==t.clearcoatNormalTexture&&(i.push(s.assignTexture(e,"clearcoatNormalMap",t.clearcoatNormalTexture)),void 0!==t.clearcoatNormalTexture.scale)&&(s=t.clearcoatNormalTexture.scale,e.clearcoatNormalScale=new ct(s,s)),Promise.all(i)):Promise.resolve()}}class Z_{constructor(t){this.parser=t,this.name=f.KHR_MATERIALS_DISPERSION}getMaterialType(t){t=this.parser.json.materials[t];return t.extensions&&t.extensions[this.name]?k_:null}extendMaterialParams(t,e){var t=this.parser.json.materials[t];return t.extensions&&t.extensions[this.name]&&(t=t.extensions[this.name],e.dispersion=void 0!==t.dispersion?t.dispersion:0),Promise.resolve()}}class q_{constructor(t){this.parser=t,this.name=f.KHR_MATERIALS_IRIDESCENCE}getMaterialType(t){t=this.parser.json.materials[t];return t.extensions&&t.extensions[this.name]?k_:null}extendMaterialParams(t,e){var i,s=this.parser,t=s.json.materials[t];return t.extensions&&t.extensions[this.name]?(i=[],void 0!==(t=t.extensions[this.name]).iridescenceFactor&&(e.iridescence=t.iridescenceFactor),void 0!==t.iridescenceTexture&&i.push(s.assignTexture(e,"iridescenceMap",t.iridescenceTexture)),void 0!==t.iridescenceIor&&(e.iridescenceIOR=t.iridescenceIor),void 0===e.iridescenceThicknessRange&&(e.iridescenceThicknessRange=[100,400]),void 0!==t.iridescenceThicknessMinimum&&(e.iridescenceThicknessRange[0]=t.iridescenceThicknessMinimum),void 0!==t.iridescenceThicknessMaximum&&(e.iridescenceThicknessRange[1]=t.iridescenceThicknessMaximum),void 0!==t.iridescenceThicknessTexture&&i.push(s.assignTexture(e,"iridescenceThicknessMap",t.iridescenceThicknessTexture)),Promise.all(i)):Promise.resolve()}}class K_{constructor(t){this.parser=t,this.name=f.KHR_MATERIALS_SHEEN}getMaterialType(t){t=this.parser.json.materials[t];return t.extensions&&t.extensions[this.name]?k_:null}extendMaterialParams(t,e){var i,s,r=this.parser,t=r.json.materials[t];return t.extensions&&t.extensions[this.name]?(i=[],e.sheenColor=new Wt(0,0,0),e.sheenRoughness=0,e.sheen=1,void 0!==(t=t.extensions[this.name]).sheenColorFactor&&(s=t.sheenColorFactor,e.sheenColor.setRGB(s[0],s[1],s[2],Si)),void 0!==t.sheenRoughnessFactor&&(e.sheenRoughness=t.sheenRoughnessFactor),void 0!==t.sheenColorTexture&&i.push(r.assignTexture(e,"sheenColorMap",t.sheenColorTexture,Yr())),void 0!==t.sheenRoughnessTexture&&i.push(r.assignTexture(e,"sheenRoughnessMap",t.sheenRoughnessTexture)),Promise.all(i)):Promise.resolve()}}class J_{constructor(t){this.parser=t,this.name=f.KHR_MATERIALS_TRANSMISSION}getMaterialType(t){t=this.parser.json.materials[t];return t.extensions&&t.extensions[this.name]?k_:null}extendMaterialParams(t,e){var i,s=this.parser,t=s.json.materials[t];return t.extensions&&t.extensions[this.name]?(i=[],void 0!==(t=t.extensions[this.name]).transmissionFactor&&(e.transmission=t.transmissionFactor),void 0!==t.transmissionTexture&&i.push(s.assignTexture(e,"transmissionMap",t.transmissionTexture)),Promise.all(i)):Promise.resolve()}}class $_{constructor(t){this.parser=t,this.name=f.KHR_MATERIALS_VOLUME}getMaterialType(t){t=this.parser.json.materials[t];return t.extensions&&t.extensions[this.name]?k_:null}extendMaterialParams(t,e){var i,s=this.parser,t=s.json.materials[t];return t.extensions&&t.extensions[this.name]?(i=[],t=t.extensions[this.name],e.thickness=void 0!==t.thicknessFactor?t.thicknessFactor:0,void 0!==t.thicknessTexture&&i.push(s.assignTexture(e,"thicknessMap",t.thicknessTexture)),e.attenuationDistance=t.attenuationDistance||1/0,s=t.attenuationColor||[1,1,1],e.attenuationColor=(new Wt).setRGB(s[0],s[1],s[2],Si),Promise.all(i)):Promise.resolve()}}class Q_{constructor(t){this.parser=t,this.name=f.KHR_MATERIALS_IOR}getMaterialType(t){t=this.parser.json.materials[t];return t.extensions&&t.extensions[this.name]?k_:null}extendMaterialParams(t,e){var t=this.parser.json.materials[t];return t.extensions&&t.extensions[this.name]&&(t=t.extensions[this.name],e.ior=void 0!==t.ior?t.ior:1.5),Promise.resolve()}}class t2{constructor(t){this.parser=t,this.name=f.KHR_MATERIALS_SPECULAR}getMaterialType(t){t=this.parser.json.materials[t];return t.extensions&&t.extensions[this.name]?k_:null}extendMaterialParams(t,e){var i,s,r=this.parser,t=r.json.materials[t];return t.extensions&&t.extensions[this.name]?(i=[],t=t.extensions[this.name],e.specularIntensity=void 0!==t.specularFactor?t.specularFactor:1,void 0!==t.specularTexture&&i.push(r.assignTexture(e,"specularIntensityMap",t.specularTexture)),s=t.specularColorFactor||[1,1,1],e.specularColor=(new Wt).setRGB(s[0],s[1],s[2],Si),void 0!==t.specularColorTexture&&i.push(r.assignTexture(e,"specularColorMap",t.specularColorTexture,Yr())),Promise.all(i)):Promise.resolve()}}class e2{constructor(t){this.parser=t,this.name=f.EXT_MATERIALS_BUMP}getMaterialType(t){t=this.parser.json.materials[t];return t.extensions&&t.extensions[this.name]?k_:null}extendMaterialParams(t,e){var i,s=this.parser,t=s.json.materials[t];return t.extensions&&t.extensions[this.name]?(i=[],t=t.extensions[this.name],e.bumpScale=void 0!==t.bumpFactor?t.bumpFactor:1,void 0!==t.bumpTexture&&i.push(s.assignTexture(e,"bumpMap",t.bumpTexture)),Promise.all(i)):Promise.resolve()}}class i2{constructor(t){this.parser=t,this.name=f.KHR_MATERIALS_ANISOTROPY}getMaterialType(t){t=this.parser.json.materials[t];return t.extensions&&t.extensions[this.name]?k_:null}extendMaterialParams(t,e){var i,s=this.parser,t=s.json.materials[t];return t.extensions&&t.extensions[this.name]?(i=[],void 0!==(t=t.extensions[this.name]).anisotropyStrength&&(e.anisotropy=t.anisotropyStrength),void 0!==t.anisotropyRotation&&(e.anisotropyRotation=t.anisotropyRotation),void 0!==t.anisotropyTexture&&i.push(s.assignTexture(e,"anisotropyMap",t.anisotropyTexture)),Promise.all(i)):Promise.resolve()}}class s2{constructor(t){this.parser=t,this.name=f.KHR_TEXTURE_BASISU}loadTexture(t){var e=this.parser,i=e.json,s=i.textures[t];if(s.extensions&&s.extensions[this.name]){var s=s.extensions[this.name],r=e.options.ktx2Loader;if(r)return e.loadTextureImage(t,s.source,r);if(i.extensionsRequired&&0<=i.extensionsRequired.indexOf(this.name))throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures")}return null}}class r2{constructor(t){this.parser=t,this.name=f.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){let i=this.name,s=this.parser,r=s.json;var t=r.textures[e];if(!t.extensions||!t.extensions[i])return null;let n=t.extensions[i];var t=r.images[n.source];let a=s.textureLoader;return t.uri&&null!==(t=s.options.manager.getHandler(t.uri))&&(a=t),this.detectSupport().then(function(t){if(t)return s.loadTextureImage(e,n.source,a);if(r.extensionsRequired&&0<=r.extensionsRequired.indexOf(i))throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(t){let e=new Image;e.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",e.onload=e.onerror=function(){t(1===e.height)}})),this.isSupported}}class n2{constructor(t){this.parser=t,this.name=f.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){let i=this.name,s=this.parser,r=s.json;var t=r.textures[e];if(!t.extensions||!t.extensions[i])return null;let n=t.extensions[i];var t=r.images[n.source];let a=s.textureLoader;return t.uri&&null!==(t=s.options.manager.getHandler(t.uri))&&(a=t),this.detectSupport().then(function(t){if(t)return s.loadTextureImage(e,n.source,a);if(r.extensionsRequired&&0<=r.extensionsRequired.indexOf(i))throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(t){let e=new Image;e.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",e.onload=e.onerror=function(){t(1===e.height)}})),this.isSupported}}class a2{constructor(t){this.name=f.EXT_MESHOPT_COMPRESSION,this.parser=t}loadBufferView(t){var e=this.parser.json,t=e.bufferViews[t];if(t.extensions&&t.extensions[this.name]){let a=t.extensions[this.name];t=this.parser.getDependency("buffer",a.buffer);let h=this.parser.options.meshoptDecoder;if(h&&h.supported)return t.then(function(t){var e=a.byteOffset||0,i=a.byteLength||0;let s=a.count,r=a.byteStride,n=new Uint8Array(t,e,i);return h.decodeGltfBufferAsync?h.decodeGltfBufferAsync(s,r,n,a.mode,a.filter).then(function(t){return t.buffer}):h.ready.then(function(){var t=new ArrayBuffer(s*r);return h.decodeGltfBuffer(new Uint8Array(t),s,r,n,a.mode,a.filter),t})});if(e.extensionsRequired&&0<=e.extensionsRequired.indexOf(this.name))throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files")}return null}}class h2{constructor(t){this.name=f.EXT_MESH_GPU_INSTANCING,this.parser=t}createNodeMesh(t){var e,i=this.parser.json,s=i.nodes[t];if(!s.extensions||!s.extensions[this.name]||void 0===s.mesh)return null;for(e of i.meshes[s.mesh].primitives)if(e.mode!==_2.TRIANGLES&&e.mode!==_2.TRIANGLE_STRIP&&e.mode!==_2.TRIANGLE_FAN&&void 0!==e.mode)return null;var r=s.extensions[this.name].attributes,n=[];let d={};for(let e in r)n.push(this.parser.getDependency("accessor",r[e]).then(t=>(d[e]=t,d[e])));return n.length<1?null:(n.push(this.parser.createNodeMesh(t)),Promise.all(n).then(t=>{var e,i=t.pop(),s=i.isGroup?i.children:[i],r=t[0].count,n=[];for(e of s){var a,h,o=new Ht,l=new Gt,u=new Ms,c=new Gt(1,1,1),f=new Ug(e.geometry,e.material,r);for(let t=0;t<r;t++)d.TRANSLATION&&l.fromBufferAttribute(d.TRANSLATION,t),d.ROTATION&&u.fromBufferAttribute(d.ROTATION,t),d.SCALE&&c.fromBufferAttribute(d.SCALE,t),f.setMatrixAt(t,o.compose(l,u,c));for(a in d)"_COLOR_0"===a?(h=d[a],f.instanceColor=new Tg(h.array,h.itemSize,h.normalized)):"TRANSLATION"!==a&&"ROTATION"!==a&&"SCALE"!==a&&e.geometry.setAttribute(a,d[a]);Js.prototype.copy.call(f,e),this.parser.assignFinalMaterial(f),n.push(f)}return i.isGroup?(i.clear(),i.add(...n),i):n[0]}))}}let o2="glTF",l2=12,u2={JSON:1313821514,BIN:5130562};class c2{constructor(t){this.name=f.KHR_BINARY_GLTF,this.content=null,this.body=null;var e=new DataView(t,0,l2);if(this.header={magic:G_(new Uint8Array(t.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0)},this.header.magic!==o2)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");var i=this.header.length-l2,s=new DataView(t,l2);let r=0;for(;r<i;){var n,a=s.getUint32(r,!0),h=(r+=4,s.getUint32(r,!0));r+=4,h===u2.JSON?(n=new Uint8Array(t,l2+r,a),this.content=G_(n)):h===u2.BIN&&(n=l2+r,this.body=t.slice(n,n+a)),r+=a}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class f2{constructor(t,e){if(!e)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=f.KHR_DRACO_MESH_COMPRESSION,this.json=t,this.dracoLoader=e,this.dracoLoader.preload()}decodePrimitive(t,e){var i=this.json;let r=this.dracoLoader;var s,n,a=t.extensions[this.name].bufferView,h=t.extensions[this.name].attributes;let o={},l={},u={};for(s in h){var c=x2[s]||s.toLowerCase();o[c]=h[s]}for(n in t.attributes){var f,d,v=x2[n]||n.toLowerCase();void 0!==h[n]&&(f=i.accessors[t.attributes[n]],d=w2[f.componentType],u[v]=d.name,l[v]=!0===f.normalized)}return e.getDependency("bufferView",a).then(function(e){return new Promise(function(s,t){r.decodeDracoFile(e,function(t){for(var e in t.attributes){var i=t.attributes[e],e=l[e];void 0!==e&&(i.normalized=e)}s(t)},o,u,Si,t)})})}}class d2{constructor(){this.name=f.KHR_TEXTURE_TRANSFORM}extendTexture(t,e){return(void 0!==e.texCoord&&e.texCoord!==t.channel||void 0!==e.offset||void 0!==e.rotation||void 0!==e.scale)&&(t=t.clone(),void 0!==e.texCoord&&(t.channel=e.texCoord),void 0!==e.offset&&t.offset.fromArray(e.offset),void 0!==e.rotation&&(t.rotation=e.rotation),void 0!==e.scale&&t.repeat.fromArray(e.scale),t.needsUpdate=!0),t}}class v2{constructor(){this.name=f.KHR_MESH_QUANTIZATION}}class p2 extends rg{constructor(t,e,i,s){super(t,e,i,s)}copySampleValue_(t){var e=this.resultBuffer,i=this.sampleValues,s=this.valueSize,r=t*s*3+s;for(let t=0;t!==s;t++)e[t]=i[r+t];return e}interpolate_(t,e,i,s){var r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,h=2*a,o=3*a,l=s-e,s=(i-e)/l,i=s*s,e=i*s,u=t*o,c=u-o,f=-2*e+3*i,d=e-i,v=1-f,p=d-i+s;for(let t=0;t!==a;t++){var m=n[c+t+a],g=n[c+t+h]*l,_=n[u+t+a],w=n[u+t]*l;r[t]=v*m+p*g+f*_+d*w}return r}}let m2=new Ms;class g2 extends p2{interpolate_(t,e,i,s){t=super.interpolate_(t,e,i,s);return m2.fromArray(t).normalize().toArray(t),t}}let _2={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},w2={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},M2={9728:Jt,9729:V,9984:$t,9985:te,9986:Qt,9987:ee},y2={33071:kt,33648:Kt,10497:Bt},E2={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},x2={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},b2={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},S2={CUBICSPLINE:void 0,LINEAR:li,STEP:oi},A2={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function T2(t){return void 0===t.DefaultMaterial&&(t.DefaultMaterial=new km({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Xt})),t.DefaultMaterial}function R2(t,e,i){for(var s in i.extensions)void 0===t[s]&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[s]=i.extensions[s])}function L2(t,e){void 0!==e.extras&&("object"==typeof e.extras?Object.assign(t.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function C2(s,i,r){let n=!1,a=!1,h=!1;for(let t=0,e=i.length;t<e;t++){var o=i[t];if(void 0!==o.POSITION&&(n=!0),void 0!==o.NORMAL&&(a=!0),void 0!==o.COLOR_0&&(h=!0),n&&a&&h)break}if(!n&&!a&&!h)return Promise.resolve(s);var l=[],u=[],c=[];for(let t=0,e=i.length;t<e;t++){var f,d=i[t];n&&(f=void 0!==d.POSITION?r.getDependency("accessor",d.POSITION):s.attributes.position,l.push(f)),a&&(f=void 0!==d.NORMAL?r.getDependency("accessor",d.NORMAL):s.attributes.normal,u.push(f)),h&&(d=void 0!==d.COLOR_0?r.getDependency("accessor",d.COLOR_0):s.attributes.color,c.push(d))}return Promise.all([Promise.all(l),Promise.all(u),Promise.all(c)]).then(function(t){var e=t[0],i=t[1],t=t[2];return n&&(s.morphAttributes.position=e),a&&(s.morphAttributes.normal=i),h&&(s.morphAttributes.color=t),s.morphTargetsRelative=!0,s})}function N2(i,s){if(i.updateMorphTargets(),void 0!==s.weights)for(let t=0,e=s.weights.length;t<e;t++)i.morphTargetInfluences[t]=s.weights[t];if(s.extras&&Array.isArray(s.extras.targetNames)){var r=s.extras.targetNames;if(i.morphTargetInfluences.length===r.length){i.morphTargetDictionary={};for(let t=0,e=r.length;t<e;t++)i.morphTargetDictionary[r[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function I2(i){let s;var t=i.extensions&&i.extensions[f.KHR_DRACO_MESH_COMPRESSION];if(s=t?"draco:"+t.bufferView+":"+t.indices+":"+P2(t.attributes):i.indices+":"+P2(i.attributes)+":"+i.mode,void 0!==i.targets)for(let t=0,e=i.targets.length;t<e;t++)s+=":"+P2(i.targets[t]);return s}function P2(i){let s="";var r=Object.keys(i).sort();for(let t=0,e=r.length;t<e;t++)s+=r[t]+":"+i[r[t]]+";";return s}function D2(t){switch(t){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function O2(t){return 0<t.search(/\.jpe?g($|\?)/i)||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":0<t.search(/\.webp($|\?)/i)||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"}let U2=new Ht;class F2{constructor(t={},e={},i){this.materialManager=i,this.json=t,this.extensions={},this.plugins={},this.options=e,this.cache=new z_,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={};let s=!(this.nodeNamesUsed={}),r=-1,n=!1,a=-1;"undefined"!=typeof navigator&&(i=navigator.userAgent,s=!0===/^((?!chrome|android).)*safari/i.test(i),t=i.match(/Version\/(\d+)/),r=s&&t?parseInt(t[1],10):-1,n=-1<i.indexOf("Firefox"),a=n?i.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||s&&r<17||n&&a<98?this.textureLoader=new F_(this.options.manager):this.textureLoader=new Fg(this.options.manager),nt.environment===I.WX&&(this.textureLoader=new F_(this.options.manager)),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Jm(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(t){this.extensions=t}setPlugins(t){this.plugins=t}parse(i,t){let s=this,r=this.json,n=this.extensions;this.cache.removeAll(),this.nodeCache={},this.af(function(t){return t.if&&t.if()}),Promise.all(this.af(function(t){return t.beforeRoot&&t.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(t){let e={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:s,userData:{}};return R2(n,e,r),L2(e,r),Promise.all(s.af(function(t){return t.afterRoot&&t.afterRoot(e)})).then(function(){for(var t of e.scenes)t.updateMatrixWorld();i(e)})}).catch(t)}if(){var i=this.json.nodes||[],s=this.json.skins||[],r=this.json.meshes||[];for(let t=0,e=s.length;t<e;t++){var n=s[t].joints;for(let t=0,e=n.length;t<e;t++)i[n[t]].isBone=!0}for(let t=0,e=i.length;t<e;t++){var a=i[t];void 0!==a.mesh&&(this.sf(this.meshCache,a.mesh),void 0!==a.skin)&&(r[a.mesh].isSkinnedMesh=!0),void 0!==a.camera&&this.sf(this.cameraCache,a.camera)}}sf(t,e){void 0!==e&&(void 0===t.refs[e]&&(t.refs[e]=t.uses[e]=0),t.refs[e]++)}nf(t,e,i){if(t.refs[e]<=1)return i;var s=i.clone();let n=(t,e)=>{var i,s,r=this.associations.get(t);null!=r&&this.associations.set(e,r);for([i,s]of t.children.entries())n(s,e.children[i])};return n(i,s),s.name+="_instance_"+t.uses[e]++,s}hf(e){var i=Object.values(this.plugins);i.push(this);for(let t=0;t<i.length;t++){var s=e(i[t]);if(s)return s}return null}af(e){var i=Object.values(this.plugins),s=(i.unshift(this),[]);for(let t=0;t<i.length;t++){var r=e(i[t]);r&&s.push(r)}return s}getDependency(e,i){var t=e+":"+i;let s=this.cache.get(t);if(!s){switch(e){case"scene":s=this.loadScene(i);break;case"node":s=this.hf(function(t){return t.loadNode&&t.loadNode(i)});break;case"mesh":s=this.hf(function(t){return t.loadMesh&&t.loadMesh(i)});break;case"accessor":s=this.loadAccessor(i);break;case"bufferView":s=this.hf(function(t){return t.loadBufferView&&t.loadBufferView(i)});break;case"buffer":s=this.loadBuffer(i);break;case"material":s=this.hf(function(t){return t.loadMaterial&&t.loadMaterial(i)});break;case"texture":s=this.hf(function(t){return t.loadTexture&&t.loadTexture(i)});break;case"skin":s=this.loadSkin(i);break;case"animation":s=this.hf(function(t){return t.loadAnimation&&t.loadAnimation(i)});break;case"camera":s=this.loadCamera(i);break;default:if(s=this.hf(function(t){return t!=this&&t.getDependency&&t.getDependency(e,i)}))break;throw new Error("Unknown type: "+e)}this.cache.add(t,s)}return s}getDependencies(s){let t=this.cache.get(s);if(!t){let i=this;var e=this.json[s+("mesh"===s?"es":"s")]||[];t=Promise.all(e.map(function(t,e){return i.getDependency(s,e)})),this.cache.add(s,t)}return t}loadBuffer(t){let i=this.json.buffers[t],s=this.fileLoader;if(i.type&&"arraybuffer"!==i.type)throw new Error("THREE.GLTFLoader: "+i.type+" buffer type is not supported.");if(void 0===i.uri&&0===t)return Promise.resolve(this.extensions[f.KHR_BINARY_GLTF].body);let r=this.options;return new Promise(function(t,e){s.load(jm.resolveURL(i.uri,r.path),t,void 0,function(){e(new Error('THREE.GLTFLoader: Failed to load buffer "'+i.uri+'".'))})})}loadBufferView(t){let s=this.json.bufferViews[t];return this.getDependency("buffer",s.buffer).then(function(t){var e=s.byteLength||0,i=s.byteOffset||0;return t.slice(i,i+e)})}loadAccessor(t){let p=this,m=this.json,g=this.json.accessors[t];var e,i;return void 0===g.bufferView&&void 0===g.sparse?(t=E2[g.type],i=w2[g.componentType],e=!0===g.normalized,i=new i(g.count*t),Promise.resolve(new N(i,t,e))):(i=[],void 0!==g.bufferView?i.push(this.getDependency("bufferView",g.bufferView)):i.push(null),void 0!==g.sparse&&(i.push(this.getDependency("bufferView",g.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",g.sparse.values.bufferView))),Promise.all(i).then(function(t){var e=t[0],i=E2[g.type],s=w2[g.componentType],r=s.BYTES_PER_ELEMENT,n=r*i,a=g.byteOffset||0,h=void 0!==g.bufferView?m.bufferViews[g.bufferView].byteStride:void 0,o=!0===g.normalized;let l,u;if(h&&h!==n){var n=Math.floor(a/h),c="InterleavedBuffer:"+g.bufferView+":"+g.componentType+":"+n+":"+g.count;let t=p.cache.get(c);t||(l=new s(e,n*h,g.count*h/r),t=new z0(l,h/r),p.cache.add(c,t)),u=new j0(t,i,a%h/r,o)}else l=null===e?new s(g.count*i):new s(e,a,g.count*i),u=new N(l,i,o);if(void 0!==g.sparse){var n=E2.SCALAR,c=w2[g.sparse.indices.componentType],h=g.sparse.indices.byteOffset||0,r=g.sparse.values.byteOffset||0,f=new c(t[1],h,g.sparse.count*n),d=new s(t[2],r,g.sparse.count*i);(u=null!==e?new N(u.array.slice(),u.itemSize,u.normalized):u).normalized=!1;for(let t=0,e=f.length;t<e;t++){var v=f[t];if(u.setX(v,d[t*i]),2<=i&&u.setY(v,d[t*i+1]),3<=i&&u.setZ(v,d[t*i+2]),4<=i&&u.setW(v,d[t*i+3]),5<=i)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}u.normalized=o}return u}))}loadTexture(t){var e=this.json,i=this.options,s=e.textures[t].source,e=e.images[s];let r=this.textureLoader;return e.uri&&null!==(i=i.manager.getHandler(e.uri))&&(r=i),this.loadTextureImage(t,s,r)}loadTextureImage(i,t,e){let s=this,r=this.json,n=r.textures[i],a=r.images[t];var h=(a.uri||a.bufferView)+":"+n.sampler;return this.textureCache[h]||(t=this.loadImageSource(t,e).then(function(t){t.flipY=!1,t.name=n.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);var e=(r.samplers||{})[n.sampler]||{};return t.magFilter=M2[e.magFilter]||V,t.minFilter=M2[e.minFilter]||ee,t.wrapS=y2[e.wrapS]||Bt,t.wrapT=y2[e.wrapT]||Bt,s.associations.set(t,{textures:i}),t}).catch(function(t){return console.error(t),null}),this.textureCache[h]=t)}loadImageSource(t,r){var e=this.json;let n=this.options;if(void 0!==this.sourceCache[t])return this.sourceCache[t].then(t=>t.clone());let i=e.images[t],s,a=(nt.environment===I.BROWSER&&(s=self.URL||self.webkitURL),i.uri||""),h=!1;if(void 0!==i.bufferView)a=this.getDependency("bufferView",i.bufferView).then(function(r){var t;if(nt.environment===I.BROWSER)return h=!0,t=new Blob([r],{type:i.mimeType}),a=s.createObjectURL(t);{let t=wx.getFileSystemManager();return new Promise(function(e,i){let s=wx.env.USER_DATA_PATH+"/"+H_+".png";H_++,t.writeFile({filePath:s,data:r,encoding:"binary",success:t=>{e(s)},fail:t=>{console.error("******",s,t),i(s)}})})}});else if(void 0===i.uri)throw new Error("THREE.GLTFLoader: Image "+t+" is missing URI and bufferView");e=Promise.resolve(a).then(function(s){return new Promise(function(e,t){let i=e;!0===r.isImageBitmapLoader&&(i=function(t){t=new c(t);t.needsUpdate=!0,e(t)}),r.load(jm.resolveURL(s,n.path),i,void 0,t)})}).then(function(t){return!0===h&&s.revokeObjectURL(a),L2(t,i),t.userData.mimeType=i.mimeType||O2(i.uri),t}).catch(function(t){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),t});return this.sourceCache[t]=e}assignTexture(s,r,n,a){let h=this;return this.getDependency("texture",n.index).then(function(t){var e,i;return t?(void 0!==n.texCoord&&0<n.texCoord&&((t=t.clone()).channel=n.texCoord),h.extensions[f.KHR_TEXTURE_TRANSFORM]&&(e=void 0!==n.extensions?n.extensions[f.KHR_TEXTURE_TRANSFORM]:void 0)&&(i=h.associations.get(t),t=h.extensions[f.KHR_TEXTURE_TRANSFORM].extendTexture(t,e),h.associations.set(t,i)),void 0!==a&&(t.colorSpace=a),s[r]=t):null})}assignFinalMaterial(t){var e=t.geometry;let i=t.material;var s=void 0===e.attributes.tangent,r=void 0!==e.attributes.color,n=void 0===e.attributes.normal;if(t.isPoints){var a="PointsMaterial:"+i.uuid;let t=this.cache.get(a);t||(t=new i_,Oh.prototype.copy.call(t,i),t.color.copy(i.color),t.map=i.map,t.sizeAttenuation=!1,this.cache.add(a,t)),i=t}else if(t.isLine){a="LineBasicMaterial:"+i.uuid;let t=this.cache.get(a);t||(t=new wm,Oh.prototype.copy.call(t,i),t.color.copy(i.color),t.map=i.map,this.cache.add(a,t)),i=t}if(s||r||n){let t="ClonedMaterial:"+i.uuid+":",e=(s&&(t+="derivative-tangents:"),r&&(t+="vertex-colors:"),n&&(t+="flat-shading:"),this.cache.get(t));e||(e=i.clone(),r&&(e.vertexColors=!0),n&&(e.flatShading=!0),s&&(e.normalScale&&(e.normalScale.y*=-1),e.clearcoatNormalScale)&&(e.clearcoatNormalScale.y*=-1),this.cache.add(t,e),this.associations.set(e,this.associations.get(i))),i=e}i.aoMap&&void 0===e.attributes.uv1&&void 0!==e.attributes.uv&&e.setAttribute("uv1",new N(e.attributes.uv.array,2)),t.material=i}getMaterialType(){return{name:"MeshStandardMaterial"}}loadMaterial(r){let n=this;var t=this.json;let a=this.extensions,h=t.materials[r],o,l={};var e,t=[],i=((h.extensions||{})[f.KHR_MATERIALS_UNLIT]?(e=a[f.KHR_MATERIALS_UNLIT],o=e.getMaterialType(),t.push(e.extendParams(l,h,n))):(e=h.pbrMetallicRoughness||{},l.color=new Wt(1,1,1),l.opacity=1,Array.isArray(e.baseColorFactor)&&(i=e.baseColorFactor,l.color.setRGB(i[0],i[1],i[2],Si),l.opacity=i[3]),void 0!==e.baseColorTexture&&t.push(n.assignTexture(l,"map",e.baseColorTexture,Yr())),l.metalness=void 0!==e.metallicFactor?e.metallicFactor:1,l.roughness=void 0!==e.roughnessFactor?e.roughnessFactor:1,void 0!==e.metallicRoughnessTexture&&(t.push(n.assignTexture(l,"metalnessMap",e.metallicRoughnessTexture)),t.push(n.assignTexture(l,"roughnessMap",e.metallicRoughnessTexture))),o=this.hf(function(t){return t.getMaterialType&&t.getMaterialType(r)}),t.push(Promise.all(this.af(function(t){return t.extendMaterialParams&&t.extendMaterialParams(r,l)})))),!0===h.doubleSided&&(l.side=Zt),h.alphaMode||A2.OPAQUE);return i===A2.BLEND?l.transparent=!0:(l.transparent=!1,i===A2.MASK&&(l.alphaTest=void 0!==h.alphaCutoff?h.alphaCutoff:.5)),void 0!==h.normalTexture&&o!==ro&&(t.push(n.assignTexture(l,"normalMap",h.normalTexture)),l.normalScale=new ct(1,1),void 0!==h.normalTexture.scale)&&(e=h.normalTexture.scale,l.normalScale.set(e,e)),void 0!==h.occlusionTexture&&o!==ro&&(h.occlusionTexture.texCoord=1,t.push(n.assignTexture(l,"aoMap",h.occlusionTexture)),void 0!==h.occlusionTexture.strength)&&(l.aoMapIntensity=h.occlusionTexture.strength),void 0!==h.emissiveFactor&&o!==ro&&(i=h.emissiveFactor,l.emissive=(new Wt).setRGB(i[0],i[1],i[2],Si)),void 0!==h.emissiveTexture&&o!==ro&&t.push(n.assignTexture(l,"emissiveMap",h.emissiveTexture,Yr())),Promise.all(t).then(function(){let t;if("MeshStandardMaterial"===o.name)t=n.materialManager.eu(l);else if("MeshPhysicalMaterial"===(t=new o(l)).type){var e,i={},s=new km;for(e in l)void 0!==s[e]&&(i[e]=l[e]);t=n.materialManager.eu(i),s.dispose()}return h.name&&(t.name=h.name),L2(t,h),n.associations.set(t,{materials:r}),h.extensions&&R2(a,t,h),t})}createUniqueName(t){t=d.sanitizeNodeName(t||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(i){let s=this,r=this.extensions;var n=this.primitiveCache;var a=[];for(let t=0,e=i.length;t<e;t++){var h=i[t],o=I2(h),l=n[o];if(l)a.push(l.promise);else{let t;t=h.extensions&&h.extensions[f.KHR_DRACO_MESH_COMPRESSION]?(e=>r[f.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,s).then(function(t){return k2(t,e,s)}))(h):k2(new Nh,h,s),n[o]={primitive:h,promise:t},a.push(t)}}return Promise.all(a)}loadMesh(l){let u=this;var t=this.json;let c=this.extensions,f=t.meshes[l],d=f.primitives;var i=[];for(let t=0,e=d.length;t<e;t++){var s=void 0===d[t].material?T2(this.cache):this.getDependency("material",d[t].material);i.push(s)}return i.push(u.loadGeometries(d)),Promise.all(i).then(function(t){var i=t.slice(0,t.length-1),s=t[t.length-1],r=[];for(let e=0,t=s.length;e<t;e++){var n=s[e],a=d[e];let t;var h=i[e];if(a.mode===_2.TRIANGLES||a.mode===_2.TRIANGLE_STRIP||a.mode===_2.TRIANGLE_FAN||void 0===a.mode)!0===(t=new(!0===f.isSkinnedMesh?I_:L)(n,h)).isSkinnedMesh&&t.normalizeSkinWeights(),a.mode===_2.TRIANGLE_STRIP?t.geometry=B_(t.geometry,gi):a.mode===_2.TRIANGLE_FAN&&(t.geometry=B_(t.geometry,_i));else if(a.mode===_2.LINES)t=new Kg(n,h);else if(a.mode===_2.LINE_STRIP)t=new jg(n,h);else if(a.mode===_2.LINE_LOOP)t=new Yg(n,h);else{if(a.mode!==_2.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+a.mode);t=new h_(n,h)}0<Object.keys(t.geometry.morphAttributes).length&&N2(t,f),t.name=u.createUniqueName(f.name||"mesh_"+l),L2(t,f),a.extensions&&R2(c,t,a),u.assignFinalMaterial(t),r.push(t)}for(let t=0,e=r.length;t<e;t++)u.associations.set(r[t],{meshes:l,primitives:t});if(1===r.length)return f.extensions&&R2(c,r[0],f),r[0];var o=new L0;f.extensions&&R2(c,o,f),u.associations.set(o,{meshes:l});for(let t=0,e=r.length;t<e;t++)o.add(r[t]);return o})}loadCamera(t){let e;var t=this.json.cameras[t],i=t[t.type];if(i)return"perspective"===t.type?e=new ir(ws.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===t.type&&(e=new sr(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),t.name&&(e.name=this.createUniqueName(t.name)),L2(e,t),Promise.resolve(e);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(t){let h=this.json.skins[t];var i=[];for(let t=0,e=h.joints.length;t<e;t++)i.push(this.lf(h.joints[t]));return void 0!==h.inverseBindMatrices?i.push(this.getDependency("accessor",h.inverseBindMatrices)):i.push(null),Promise.all(i).then(function(t){var i=t.pop(),s=t,r=[],n=[];for(let t=0,e=s.length;t<e;t++){var a=s[t];a?(r.push(a),a=new Ht,null!==i&&a.fromArray(i.array,16*t),n.push(a)):console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',h.joints[t])}return new E_(r,n)})}loadAnimation(t){var e=this.json;let v=this;var i=e.animations[t];let p=i.name||"animation_"+t;var s=[],r=[],n=[],a=[],h=[];for(let t=0,e=i.channels.length;t<e;t++){var o=i.channels[t],l=i.samplers[o.sampler],o=o.target,u=o.node,c=void 0!==i.parameters?i.parameters[l.input]:l.input,f=void 0!==i.parameters?i.parameters[l.output]:l.output;void 0!==o.node&&(s.push(this.getDependency("node",u)),r.push(this.getDependency("accessor",c)),n.push(this.getDependency("accessor",f)),a.push(l),h.push(o))}return Promise.all([Promise.all(s),Promise.all(r),Promise.all(n),Promise.all(a),Promise.all(h)]).then(function(t){var i=t[0],s=t[1],r=t[2],n=t[3],a=t[4],h=[];for(let t=0,e=i.length;t<e;t++){var o=i[t],l=s[t],u=r[t],c=n[t],f=a[t];if(void 0!==o){o.updateMatrix&&o.updateMatrix();var d=v.uf(o,l,u,c,f);if(d)for(let t=0;t<d.length;t++)h.push(d[t])}}return new mg(p,void 0,h)})}createNodeMesh(t){var e=this.json;let i=this,s=e.nodes[t];return void 0===s.mesh?null:i.getDependency("mesh",s.mesh).then(function(t){t=i.nf(i.meshCache,s.mesh,t);return void 0!==s.weights&&t.traverse(function(i){if(i.isMesh)for(let t=0,e=s.weights.length;t<e;t++)i.morphTargetInfluences[t]=s.weights[t]}),t})}loadNode(t){var e=this.json.nodes[t],t=this.lf(t),i=[],s=e.children||[];for(let t=0,e=s.length;t<e;t++)i.push(this.getDependency("node",s[t]));e=void 0===e.skin?Promise.resolve(null):this.getDependency("skin",e.skin);return Promise.all([t,Promise.all(i),e]).then(function(t){var i=t[0],s=t[1];let e=t[2];null!==e&&i.traverse(function(t){t.isSkinnedMesh&&t.bind(e,U2)});for(let t=0,e=s.length;t<e;t++)i.add(s[t]);return i})}lf(n){var t=this.json;let a=this.extensions,h=this;if(void 0===this.nodeCache[n]){let e=t.nodes[n],r=e.name?h.createUniqueName(e.name):"",i=[];t=h.hf(function(t){return t.createNodeMesh&&t.createNodeMesh(n)});t&&i.push(t),void 0!==e.camera&&i.push(h.getDependency("camera",e.camera).then(function(t){return h.nf(h.cameraCache,e.camera,t)})),h.af(function(t){return t.createNodeAttachment&&t.createNodeAttachment(n)}).forEach(function(t){i.push(t)}),this.nodeCache[n]=Promise.all(i).then(function(i){let s;if((s=!0===e.isBone?new Ag:1<i.length?new L0:1===i.length?i[0]:new Js)!==i[0])for(let t=0,e=i.length;t<e;t++)s.add(i[t]);var t;return e.name&&(s.userData.name=e.name,s.name=r),L2(s,e),e.extensions&&R2(a,s,e),void 0!==e.matrix?((t=new Ht).fromArray(e.matrix),s.applyMatrix4(t)):(void 0!==e.translation&&s.position.fromArray(e.translation),void 0!==e.rotation&&s.quaternion.fromArray(e.rotation),void 0!==e.scale&&s.scale.fromArray(e.scale)),h.associations.has(s)||h.associations.set(s,{}),h.associations.get(s).nodes=n,s})}return this.nodeCache[n]}loadScene(t){var e=this.extensions,t=this.json.scenes[t];let r=this,s=new L0;t.name&&(s.name=r.createUniqueName(t.name)),L2(s,t),t.extensions&&R2(e,s,t);var i=t.nodes||[],n=[];for(let t=0,e=i.length;t<e;t++)n.push(r.getDependency("node",i[t]));return Promise.all(n).then(function(i){for(let t=0,e=i.length;t<e;t++)s.add(i[t]);return r.associations=(t=>{let i=new Map;for(var[e,s]of r.associations)(e instanceof Oh||e instanceof c)&&i.set(e,s);return t.traverse(t=>{var e=r.associations.get(t);null!=e&&i.set(t,e)}),i})(s),s})}uf(t,i,e,s,r){var n=[],a=t.name||t.uuid;let h=[];b2[r.path]===b2.weights?t.traverse(function(t){t.morphTargetInfluences&&h.push(t.name||t.uuid)}):h.push(a);let o;switch(b2[r.path]){case b2.weights:o=cg;break;case b2.rotation:o=dg;break;case b2.position:case b2.scale:o=pg;break;default:o=1===e.itemSize?cg:pg}var l=void 0!==s.interpolation?S2[s.interpolation]:li,u=this.cf(e);for(let t=0,e=h.length;t<e;t++){var c=new o(h[t]+"."+b2[r.path],i.array,u,l);"CUBICSPLINE"===s.interpolation&&this.ff(c),n.push(c)}return n}cf(t){let i=t.array;if(t.normalized){var s=D2(i.constructor),r=new Float32Array(i.length);for(let t=0,e=i.length;t<e;t++)r[t]=i[t]*s;i=r}return i}ff(t){t.createInterpolant=function(t){return new(this instanceof dg?g2:p2)(this.times,this.values,this.getValueSize()/3,t)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function B2(t,e,i){var s=e.attributes,r=new rr;if(void 0!==s.POSITION){var s=i.json.accessors[s.POSITION],n=s.min,a=s.max;if(void 0===n||void 0===a)console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");else{r.set(new Gt(n[0],n[1],n[2]),new Gt(a[0],a[1],a[2])),s.normalized&&(n=D2(w2[s.componentType]),r.min.multiplyScalar(n),r.max.multiplyScalar(n));var h=e.targets;if(void 0!==h){var o=new Gt,l=new Gt;for(let t=0,e=h.length;t<e;t++){var u,c,f=h[t];void 0!==f.POSITION&&(c=(f=i.json.accessors[f.POSITION]).min,u=f.max,void 0!==c&&void 0!==u?(l.setX(Math.max(Math.abs(c[0]),Math.abs(u[0]))),l.setY(Math.max(Math.abs(c[1]),Math.abs(u[1]))),l.setZ(Math.max(Math.abs(c[2]),Math.abs(u[2]))),f.normalized&&(c=D2(w2[f.componentType]),l.multiplyScalar(c)),o.max(l)):console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION."))}r.expandByVector(o)}t.boundingBox=r;a=new Er;r.getCenter(a.center),a.radius=r.min.distanceTo(r.max)/2,t.boundingSphere=a}}}function k2(i,t,s){var e,r,n=t.attributes,a=[];for(e in n){var h=x2[e]||e.toLowerCase();h in i.attributes||a.push(((t,e)=>s.getDependency("accessor",t).then(function(t){i.setAttribute(e,t)}))(n[e],h))}return void 0===t.indices||i.index||(r=s.getDependency("accessor",t.indices).then(function(t){i.setIndex(t)}),a.push(r)),zt.workingColorSpace!==Si&&"COLOR_0"in n&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${zt.workingColorSpace}" not supported.`),L2(i,t),B2(i,t,s),Promise.all(a).then(function(){return void 0!==t.targets?C2(i,t.targets,s):i})}class G2 extends xm{constructor(t,e){super(),this.st=t,this.df=new V_(void 0,e.pl),this.vf=!1,this.pf=!1,this.st.Ls.decoderURL&&((t=new $m).setDecoderPath(this.st.Ls.decoderURL),this.df.setDRACOLoader(t))}load(t,e,i){try{return this.Vo(t,e,i)}catch(t){console.error(t)}}}Object.assign(G2.prototype,{Vo(s,r,n){if(!this.nl.has(s))return this.nl.set(s,{loadComplete:!1}),this.df.load(s,(t,e)=>{var i;!0!==this.pf&&(this.nl.set(s,{gltf:t,data:e,isAnimate:0<t.animations.length,loadComplete:!0}),i={animations:t.animations},0<t.animations.length?this.df.parse(e,jm.extractUrlBase(s),t=>{r&&r(t),this.st.Wt.mf(),this.gf(s,!1)},t=>{n&&n(t),this.st.Wt.mf()}):(i.scene=t.scene.clone(!0),r&&r(i),this.st.Wt.mf(),this.gf(s,!1)))},function(t){},e=>{var t;!0!==this.pf&&(this.nl.delete(s),n&&n(e),(t=this.al.get(s))&&t.forEach(t=>{t.fail&&t.fail(e)}),this.al.delete(s),this.st.Wt.mf(),this.gf(s,e))});this.hl(s,{success:r,fail:n}),!0===this.nl.get(s).loadComplete&&(this.st.Wt.mf(),this.gf(s))},gf(n,a){if(this.al.has(n)){let r=this.nl.get(n);r&&(this.al.get(n).forEach((t,e,i)=>{var s;a?e.fail&&e.fail(a):r.isAnimate?this.df.parse(r.data,jm.extractUrlBase(n),function(t){e.success&&e.success(t)},function(t){e.fail&&e.fail(t)}):((s={animations:[]}).scene=r.gltf.scene.clone(!0),e.success&&e.success(s)),i.delete(t)}),this.al.delete(n))}},Qt(){this.pf=!0,this.nl.clear(),this.al.clear(),this._f=null,this.df=null}});class H2{constructor(){this.type="Curve",this.arcLengthDivisions=200}getPoint(){return console.warn("THREE.Curve: .getPoint() not implemented."),null}getPointAt(t,e){t=this.getUtoTmapping(t);return this.getPoint(t,e)}getPoints(e=5){var i=[];for(let t=0;t<=e;t++)i.push(this.getPoint(t/e));return i}getSpacedPoints(e=5){var i=[];for(let t=0;t<=e;t++)i.push(this.getPointAt(t/e));return i}getLength(){var t=this.getLengths();return t[t.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var i=[];let s,r=this.getPoint(0),n=0;i.push(0);for(let t=1;t<=e;t++)s=this.getPoint(t/e),n+=s.distanceTo(r),i.push(n),r=s;return this.cacheArcLengths=i}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(t,e){var i=this.getLengths();let s=0;var r=i.length;let n,a=(n=e||t*i[r-1],0),h=r-1,o;for(;a<=h;)if((o=i[s=Math.floor(a+(h-a)/2)]-n)<0)a=s+1;else{if(!(0<o)){h=s;break}h=s-1}return i[s=h]===n?s/(r-1):(e=i[s],t=i[s+1],t=(n-e)/(t-e),(s+t)/(r-1))}getTangent(t,e){let i=t-1e-4,s=t+1e-4;i<0&&(i=0),1<s&&(s=1);var t=this.getPoint(i),r=this.getPoint(s),e=e||new(t.isVector2?ct:Gt);return e.copy(r).sub(t).normalize(),e}getTangentAt(t,e){t=this.getUtoTmapping(t);return this.getTangent(t,e)}computeFrenetFrames(i,t){var e=new Gt,s=[],r=[],n=[],a=new Gt,h=new Ht;for(let t=0;t<=i;t++){var o=t/i;s[t]=this.getTangentAt(o,new Gt)}r[0]=new Gt,n[0]=new Gt;let l=Number.MAX_VALUE;var u,c=Math.abs(s[0].x),f=Math.abs(s[0].y),d=Math.abs(s[0].z);c<=l&&(l=c,e.set(1,0,0)),f<=l&&(l=f,e.set(0,1,0)),d<=l&&e.set(0,0,1),a.crossVectors(s[0],e).normalize(),r[0].crossVectors(s[0],a),n[0].crossVectors(s[0],r[0]);for(let t=1;t<=i;t++)r[t]=r[t-1].clone(),n[t]=n[t-1].clone(),a.crossVectors(s[t-1],s[t]),a.length()>Number.EPSILON&&(a.normalize(),u=Math.acos(Qi(s[t-1].dot(s[t]),-1,1)),r[t].applyMatrix4(h.makeRotationAxis(a,u))),n[t].crossVectors(s[t],r[t]);if(!0===t){let e=Math.acos(Qi(r[0].dot(r[i]),-1,1));e/=i,0<s[0].dot(a.crossVectors(r[0],r[i]))&&(e=-e);for(let t=1;t<=i;t++)r[t].applyMatrix4(h.makeRotationAxis(s[t],e*t)),n[t].crossVectors(s[t],r[t])}return{tangents:s,normals:r,binormals:n}}clone(){return(new this.constructor).copy(this)}copy(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}toJSON(){var t={metadata:{version:4.6,type:"Curve",generator:"Curve.toJSON"}};return t.arcLengthDivisions=this.arcLengthDivisions,t.type=this.type,t}fromJSON(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}}class V2 extends H2{constructor(t=0,e=0,i=1,s=1,r=0,n=2*Math.PI,a=!1,h=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=t,this.aY=e,this.xRadius=i,this.yRadius=s,this.aStartAngle=r,this.aEndAngle=n,this.aClockwise=a,this.aRotation=h}getPoint(t,e=new ct){var i=2*Math.PI;let s=this.aEndAngle-this.aStartAngle;for(var r=Math.abs(s)<Number.EPSILON;s<0;)s+=i;for(;s>i;)s-=i;s<Number.EPSILON&&(s=r?0:i),!0!==this.aClockwise||r||(s===i?s=-i:s-=i);var n,a,r=this.aStartAngle+t*s;let h=this.aX+this.xRadius*Math.cos(r),o=this.aY+this.yRadius*Math.sin(r);return 0!==this.aRotation&&(t=Math.cos(this.aRotation),r=Math.sin(this.aRotation),n=h-this.aX,a=o-this.aY,h=n*t-a*r+this.aX,o=n*r+a*t+this.aY),e.set(h,o)}copy(t){return super.copy(t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this}toJSON(){var t=super.toJSON();return t.aX=this.aX,t.aY=this.aY,t.xRadius=this.xRadius,t.yRadius=this.yRadius,t.aStartAngle=this.aStartAngle,t.aEndAngle=this.aEndAngle,t.aClockwise=this.aClockwise,t.aRotation=this.aRotation,t}fromJSON(t){return super.fromJSON(t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this}}class z2 extends V2{constructor(t,e,i,s,r,n){super(t,e,i,i,s,r,n),this.isArcCurve=!0,this.type="ArcCurve"}}function W2(){let r=0,n=0,a=0,h=0;function o(t,e,i,s){r=t,n=i,a=-3*t+3*e-2*i-s,h=2*t-2*e+i+s}return{initCatmullRom:function(t,e,i,s,r){o(e,i,r*(i-t),r*(s-e))},initNonuniformCatmullRom:function(t,e,i,s,r,n,a){t=(e-t)/r-(i-t)/(r+n)+(i-e)/n,r=(i-e)/n-(s-e)/(n+a)+(s-i)/a;o(e,i,t*=n,r*=n)},calc:function(t){var e=t*t,i=e*t;return r+n*t+a*e+h*i}}}let j2=new Gt,X2=new W2,Y2=new W2,Z2=new W2;class q2 extends H2{constructor(t=[],e=!1,i="centripetal",s=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=t,this.closed=e,this.curveType=i,this.tension=s}getPoint(s,t=new Gt){var r=this.points,e=r.length,s=(e-(this.closed?0:1))*s;let i=Math.floor(s),n=s-i;this.closed?i+=0<i?0:(Math.floor(Math.abs(i)/e)+1)*e:0===n&&i===e-1&&(i=e-2,n=1);let a,h;a=this.closed||0<i?r[(i-1)%e]:(j2.subVectors(r[0],r[1]).add(r[0]),j2);var s=r[i%e],o=r[(i+1)%e];if(h=this.closed||i+2<e?r[(i+2)%e]:(j2.subVectors(r[e-1],r[e-2]).add(r[e-1]),j2),"centripetal"===this.curveType||"chordal"===this.curveType){r="chordal"===this.curveType?.5:.25;let t=Math.pow(a.distanceToSquared(s),r),e=Math.pow(s.distanceToSquared(o),r),i=Math.pow(o.distanceToSquared(h),r);e<1e-4&&(e=1),t<1e-4&&(t=e),i<1e-4&&(i=e),X2.initNonuniformCatmullRom(a.x,s.x,o.x,h.x,t,e,i),Y2.initNonuniformCatmullRom(a.y,s.y,o.y,h.y,t,e,i),Z2.initNonuniformCatmullRom(a.z,s.z,o.z,h.z,t,e,i)}else"catmullrom"===this.curveType&&(X2.initCatmullRom(a.x,s.x,o.x,h.x,this.tension),Y2.initCatmullRom(a.y,s.y,o.y,h.y,this.tension),Z2.initCatmullRom(a.z,s.z,o.z,h.z,this.tension));return t.set(X2.calc(n),Y2.calc(n),Z2.calc(n)),t}copy(i){super.copy(i),this.points=[];for(let t=0,e=i.points.length;t<e;t++){var s=i.points[t];this.points.push(s.clone())}return this.closed=i.closed,this.curveType=i.curveType,this.tension=i.tension,this}toJSON(){var i=super.toJSON();i.points=[];for(let t=0,e=this.points.length;t<e;t++){var s=this.points[t];i.points.push(s.toArray())}return i.closed=this.closed,i.curveType=this.curveType,i.tension=this.tension,i}fromJSON(i){super.fromJSON(i),this.points=[];for(let t=0,e=i.points.length;t<e;t++){var s=i.points[t];this.points.push((new Gt).fromArray(s))}return this.closed=i.closed,this.curveType=i.curveType,this.tension=i.tension,this}}function K2(t,e,i,s,r){var e=.5*(s-e),r=.5*(r-i),n=t*t;return(2*i-2*s+e+r)*(t*n)+(-3*i+3*s-2*e-r)*n+e*t+i}function J2(t,e){t=1-t;return t*t*e}function $2(t,e){return 2*(1-t)*t*e}function Q2(t,e){return t*t*e}function tw(t,e,i,s){return J2(t,e)+$2(t,i)+Q2(t,s)}function ew(t,e){t=1-t;return t*t*t*e}function iw(t,e){var i=1-t;return 3*i*i*t*e}function sw(t,e){return 3*(1-t)*t*t*e}function rw(t,e){return t*t*t*e}function nw(t,e,i,s,r){return ew(t,e)+iw(t,i)+sw(t,s)+rw(t,r)}class aw extends H2{constructor(t=new ct,e=new ct,i=new ct,s=new ct){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=t,this.v1=e,this.v2=i,this.v3=s}getPoint(t,e=new ct){var i=this.v0,s=this.v1,r=this.v2,n=this.v3;return e.set(nw(t,i.x,s.x,r.x,n.x),nw(t,i.y,s.y,r.y,n.y)),e}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this}toJSON(){var t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this}}class hw extends H2{constructor(t=new Gt,e=new Gt,i=new Gt,s=new Gt){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=t,this.v1=e,this.v2=i,this.v3=s}getPoint(t,e=new Gt){var i=this.v0,s=this.v1,r=this.v2,n=this.v3;return e.set(nw(t,i.x,s.x,r.x,n.x),nw(t,i.y,s.y,r.y,n.y),nw(t,i.z,s.z,r.z,n.z)),e}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this}toJSON(){var t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this}}class ow extends H2{constructor(t=new ct,e=new ct){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=t,this.v2=e}getPoint(t,e=new ct){return 1===t?e.copy(this.v2):(e.copy(this.v2).sub(this.v1),e.multiplyScalar(t).add(this.v1)),e}getPointAt(t,e){return this.getPoint(t,e)}getTangent(t,e=new ct){return e.subVectors(this.v2,this.v1).normalize()}getTangentAt(t,e){return this.getTangent(t,e)}copy(t){return super.copy(t),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){var t=super.toJSON();return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class lw extends H2{constructor(t=new Gt,e=new Gt){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=t,this.v2=e}getPoint(t,e=new Gt){return 1===t?e.copy(this.v2):(e.copy(this.v2).sub(this.v1),e.multiplyScalar(t).add(this.v1)),e}getPointAt(t,e){return this.getPoint(t,e)}getTangent(t,e=new Gt){return e.subVectors(this.v2,this.v1).normalize()}getTangentAt(t,e){return this.getTangent(t,e)}copy(t){return super.copy(t),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){var t=super.toJSON();return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class uw extends H2{constructor(t=new ct,e=new ct,i=new ct){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=t,this.v1=e,this.v2=i}getPoint(t,e=new ct){var i=this.v0,s=this.v1,r=this.v2;return e.set(tw(t,i.x,s.x,r.x),tw(t,i.y,s.y,r.y)),e}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){var t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class cw extends H2{constructor(t=new Gt,e=new Gt,i=new Gt){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=t,this.v1=e,this.v2=i}getPoint(t,e=new Gt){var i=this.v0,s=this.v1,r=this.v2;return e.set(tw(t,i.x,s.x,r.x),tw(t,i.y,s.y,r.y),tw(t,i.z,s.z,r.z)),e}copy(t){return super.copy(t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this}toJSON(){var t=super.toJSON();return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t}fromJSON(t){return super.fromJSON(t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this}}class fw extends H2{constructor(t=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=t}getPoint(t,e=new ct){var i=this.points,t=(i.length-1)*t,s=Math.floor(t),t=t-s,r=i[0===s?s:s-1],n=i[s],a=i[s>i.length-2?i.length-1:s+1],i=i[s>i.length-3?i.length-1:s+2];return e.set(K2(t,r.x,n.x,a.x,i.x),K2(t,r.y,n.y,a.y,i.y)),e}copy(i){super.copy(i),this.points=[];for(let t=0,e=i.points.length;t<e;t++){var s=i.points[t];this.points.push(s.clone())}return this}toJSON(){var i=super.toJSON();i.points=[];for(let t=0,e=this.points.length;t<e;t++){var s=this.points[t];i.points.push(s.toArray())}return i}fromJSON(i){super.fromJSON(i),this.points=[];for(let t=0,e=i.points.length;t<e;t++){var s=i.points[t];this.points.push((new ct).fromArray(s))}return this}}var dw=Object.freeze({__proto__:null,ArcCurve:z2,CatmullRomCurve3:q2,CubicBezierCurve:aw,CubicBezierCurve3:hw,EllipseCurve:V2,LineCurve:ow,LineCurve3:lw,QuadraticBezierCurve:uw,QuadraticBezierCurve3:cw,SplineCurve:fw});class vw extends H2{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(t){this.curves.push(t)}closePath(){var t,e=this.curves[0].getPoint(0),i=this.curves[this.curves.length-1].getPoint(1);return e.equals(i)||(t=!0===e.isVector2?"LineCurve":"LineCurve3",this.curves.push(new dw[t](i,e))),this}getPoint(t,e){var i,s,r,n=t*this.getLength(),a=this.getCurveLengths();let h=0;for(;h<a.length;){if(a[h]>=n)return i=a[h]-n,r=(s=this.curves[h]).getLength(),s.getPointAt(0===r?0:1-i/r,e);h++}return null}getLength(){var t=this.getCurveLengths();return t[t.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;var i=[];let s=0;for(let t=0,e=this.curves.length;t<e;t++)s+=this.curves[t].getLength(),i.push(s);return this.cacheLengths=i}getSpacedPoints(e=40){var i=[];for(let t=0;t<=e;t++)i.push(this.getPoint(t/e));return this.autoClose&&i.push(i[0]),i}getPoints(i=12){var s=[];let r;for(let t=0,e=this.curves;t<e.length;t++){var n=e[t],a=n.isEllipseCurve?2*i:n.isLineCurve||n.isLineCurve3?1:n.isSplineCurve?i*n.points.length:i,h=n.getPoints(a);for(let t=0;t<h.length;t++){var o=h[t];r&&r.equals(o)||(s.push(o),r=o)}}return this.autoClose&&1<s.length&&!s[s.length-1].equals(s[0])&&s.push(s[0]),s}copy(i){super.copy(i),this.curves=[];for(let t=0,e=i.curves.length;t<e;t++){var s=i.curves[t];this.curves.push(s.clone())}return this.autoClose=i.autoClose,this}toJSON(){var i=super.toJSON();i.autoClose=this.autoClose,i.curves=[];for(let t=0,e=this.curves.length;t<e;t++){var s=this.curves[t];i.curves.push(s.toJSON())}return i}fromJSON(i){super.fromJSON(i),this.autoClose=i.autoClose,this.curves=[];for(let t=0,e=i.curves.length;t<e;t++){var s=i.curves[t];this.curves.push((new dw[s.type]).fromJSON(s))}return this}}class pw extends vw{constructor(t){super(),this.type="Path",this.currentPoint=new ct,t&&this.setFromPoints(t)}setFromPoints(i){this.moveTo(i[0].x,i[0].y);for(let t=1,e=i.length;t<e;t++)this.lineTo(i[t].x,i[t].y);return this}moveTo(t,e){return this.currentPoint.set(t,e),this}lineTo(t,e){var i=new ow(this.currentPoint.clone(),new ct(t,e));return this.curves.push(i),this.currentPoint.set(t,e),this}quadraticCurveTo(t,e,i,s){t=new uw(this.currentPoint.clone(),new ct(t,e),new ct(i,s));return this.curves.push(t),this.currentPoint.set(i,s),this}bezierCurveTo(t,e,i,s,r,n){t=new aw(this.currentPoint.clone(),new ct(t,e),new ct(i,s),new ct(r,n));return this.curves.push(t),this.currentPoint.set(r,n),this}splineThru(t){var e=[this.currentPoint.clone()].concat(t),e=new fw(e);return this.curves.push(e),this.currentPoint.copy(t[t.length-1]),this}arc(t,e,i,s,r,n){var a=this.currentPoint.x,h=this.currentPoint.y;return this.absarc(t+a,e+h,i,s,r,n),this}absarc(t,e,i,s,r,n){return this.absellipse(t,e,i,i,s,r,n),this}ellipse(t,e,i,s,r,n,a,h){var o=this.currentPoint.x,l=this.currentPoint.y;return this.absellipse(t+o,e+l,i,s,r,n,a,h),this}absellipse(t,e,i,s,r,n,a,h){t=new V2(t,e,i,s,r,n,a,h),0<this.curves.length&&((e=t.getPoint(0)).equals(this.currentPoint)||this.lineTo(e.x,e.y)),this.curves.push(t),i=t.getPoint(1);return this.currentPoint.copy(i),this}copy(t){return super.copy(t),this.currentPoint.copy(t.currentPoint),this}toJSON(){var t=super.toJSON();return t.currentPoint=this.currentPoint.toArray(),t}fromJSON(t){return super.fromJSON(t),this.currentPoint.fromArray(t.currentPoint),this}}class mw extends pw{constructor(t){super(t),this.uuid=$i(),this.type="Shape",this.holes=[]}getPointsHoles(i){var s=[];for(let t=0,e=this.holes.length;t<e;t++)s[t]=this.holes[t].getPoints(i);return s}extractPoints(t){return{shape:this.getPoints(t),holes:this.getPointsHoles(t)}}copy(i){super.copy(i),this.holes=[];for(let t=0,e=i.holes.length;t<e;t++){var s=i.holes[t];this.holes.push(s.clone())}return this}toJSON(){var i=super.toJSON();i.uuid=this.uuid,i.holes=[];for(let t=0,e=this.holes.length;t<e;t++){var s=this.holes[t];i.holes.push(s.toJSON())}return i}fromJSON(i){super.fromJSON(i),this.uuid=i.uuid,this.holes=[];for(let t=0,e=i.holes.length;t<e;t++){var s=i.holes[t];this.holes.push((new pw).fromJSON(s))}return this}}let gw={triangulate:function(h,o,l=2){var u=o&&o.length,c=u?o[0]*l:h.length;let f=_w(h,0,c,l,!0);var d=[];if(f&&f.next!==f.prev){let e,i,s,r,n,a,t;if(u&&(f=Sw(h,o,f,l)),h.length>80*l){e=s=h[0],i=r=h[1];for(let t=l;t<c;t+=l)n=h[t],a=h[t+1],n<e&&(e=n),a<i&&(i=a),n>s&&(s=n),a>r&&(r=a);t=0!==(t=Math.max(s-e,r-i))?32767/t:0}Mw(f,d,l,e,i,t,0)}return d}};function _w(t,e,i,s,r){let n,a;if(r===0<Zw(t,e,i,s))for(n=e;n<i;n+=s)a=jw(n,t[n],t[n+1],a);else for(n=i-s;n>=e;n-=s)a=jw(n,t[n],t[n+1],a);return a&&Fw(a,a.next)&&(Xw(a),a=a.next),a}function ww(t,e){if(!t)return t;e=e||t;let i=t,s;do{if(s=!1,i.steiner||!Fw(i,i.next)&&0!==Uw(i.prev,i,i.next))i=i.next;else{if(Xw(i),(i=e=i.prev)===i.next)break;s=!0}}while(s||i!==e);return e}function Mw(s,r,n,a,h,o,l){if(s){!l&&o&&Cw(s,a,h,o);let t=s,e,i;for(;s.prev!==s.next;)if(e=s.prev,i=s.next,o?Ew(s,a,h,o):yw(s))r.push(e.i/n|0),r.push(s.i/n|0),r.push(i.i/n|0),Xw(s),s=i.next,t=i.next;else if((s=i)===t){l?1===l?Mw(s=xw(ww(s),r,n),r,n,a,h,o,2):2===l&&bw(s,r,n,a,h,o):Mw(ww(s),r,n,a,h,o,1);break}}}function yw(e){var i=e.prev,s=e,e=e.next;if(!(0<=Uw(i,s,e))){var r=i.x,n=s.x,a=e.x,h=i.y,o=s.y,l=e.y,u=r<n?r<a?r:a:n<a?n:a,c=h<o?h<l?h:l:o<l?o:l,f=n<r?a<r?r:a:a<n?n:a,d=o<h?l<h?h:l:l<o?o:l;let t=e.next;for(;t!==i;){if(t.x>=u&&t.x<=f&&t.y>=c&&t.y<=d&&Dw(r,h,n,o,a,l,t.x,t.y)&&0<=Uw(t.prev,t,t.next))return;t=t.next}return 1}}function Ew(i,s,r,n){var a=i.prev,h=i,o=i.next;if(!(0<=Uw(a,h,o))){var l=a.x,u=h.x,c=o.x,f=a.y,d=h.y,v=o.y,p=l<u?l<c?l:c:u<c?u:c,m=f<d?f<v?f:v:d<v?d:v,g=u<l?c<l?l:c:c<u?u:c,_=d<f?v<f?f:v:v<d?d:v,w=Iw(p,m,s,r,n),M=Iw(g,_,s,r,n);let t=i.prevZ,e=i.nextZ;for(;t&&t.z>=w&&e&&e.z<=M;){if(t.x>=p&&t.x<=g&&t.y>=m&&t.y<=_&&t!==a&&t!==o&&Dw(l,f,u,d,c,v,t.x,t.y)&&0<=Uw(t.prev,t,t.next))return;if(t=t.prevZ,e.x>=p&&e.x<=g&&e.y>=m&&e.y<=_&&e!==a&&e!==o&&Dw(l,f,u,d,c,v,e.x,e.y)&&0<=Uw(e.prev,e,e.next))return;e=e.nextZ}for(;t&&t.z>=w;){if(t.x>=p&&t.x<=g&&t.y>=m&&t.y<=_&&t!==a&&t!==o&&Dw(l,f,u,d,c,v,t.x,t.y)&&0<=Uw(t.prev,t,t.next))return;t=t.prevZ}for(;e&&e.z<=M;){if(e.x>=p&&e.x<=g&&e.y>=m&&e.y<=_&&e!==a&&e!==o&&Dw(l,f,u,d,c,v,e.x,e.y)&&0<=Uw(e.prev,e,e.next))return;e=e.nextZ}return 1}}function xw(t,e,i){let s=t;do{var r=s.prev,n=s.next.next;!Fw(r,n)&&Bw(r,s,s.next,n)&&Vw(r,n)&&Vw(n,r)&&(e.push(r.i/i|0),e.push(s.i/i|0),e.push(n.i/i|0),Xw(s),Xw(s.next),s=t=n),s=s.next}while(s!==t);return ww(s)}function bw(t,e,i,s,r,n){let a=t;do{let t=a.next.next;for(;t!==a.prev;){var h;if(a.i!==t.i&&Ow(a,t))return h=Ww(a,t),a=ww(a,a.next),h=ww(h,h.next),Mw(a,e,i,s,r,n,0),void Mw(h,e,i,s,r,n,0);t=t.next}}while((a=a.next)!==t)}function Sw(t,e,i,s){var r=[];let n,a,h,o,l;for(n=0,a=e.length;n<a;n++)h=e[n]*s,o=n<a-1?e[n+1]*s:t.length,(l=_w(t,h,o,s,!1))===l.next&&(l.steiner=!0),r.push(Pw(l));for(r.sort(Aw),n=0;n<r.length;n++)i=Tw(r[n],i);return i}function Aw(t,e){return t.x-e.x}function Tw(t,e){var i=Rw(t,e);return i?(ww(t=Ww(i,t),t.next),ww(i,i.next)):e}function Rw(t,e){let i=e,s=-1/0,r;var n=t.x,a=t.y;do{if(a<=i.y&&a>=i.next.y&&i.next.y!==i.y){var h=i.x+(a-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(h<=n&&h>s&&(s=h,r=i.x<i.next.x?i:i.next,h===n))return r}}while((i=i.next)!==e);if(!r)return null;var o=r,l=r.x,u=r.y;let c=1/0,f;for(i=r;n>=i.x&&i.x>=l&&n!==i.x&&Dw(a<u?n:s,a,l,u,a<u?s:n,a,i.x,i.y)&&(f=Math.abs(a-i.y)/(n-i.x),Vw(i,t))&&(f<c||f===c&&(i.x>r.x||i.x===r.x&&Lw(r,i)))&&(r=i,c=f),(i=i.next)!==o;);return r}function Lw(t,e){return Uw(t.prev,t,e.prev)<0&&Uw(e.next,t,t.next)<0}function Cw(t,e,i,s){let r=t;for(;0===r.z&&(r.z=Iw(r.x,r.y,e,i,s)),r.prevZ=r.prev,r.nextZ=r.next,(r=r.next)!==t;);r.prevZ.nextZ=null,r.prevZ=null,Nw(r)}function Nw(t){let e,i,s,r,n,a,h,o,l=1;do{for(i=t,t=null,n=null,a=0;i;){for(a++,s=i,h=0,e=0;e<l&&(h++,s=s.nextZ);e++);for(o=l;0<h||0<o&&s;)0!==h&&(0===o||!s||i.z<=s.z)?(i=(r=i).nextZ,h--):(s=(r=s).nextZ,o--),n?n.nextZ=r:t=r,r.prevZ=n,n=r;i=s}}while(n.nextZ=null,l*=2,1<a)}function Iw(t,e,i,s,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Pw(t){let e=t,i=t;for(;(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),(e=e.next)!==t;);return i}function Dw(t,e,i,s,r,n,a,h){return(t-a)*(n-h)<=(r-a)*(e-h)&&(i-a)*(e-h)<=(t-a)*(s-h)&&(r-a)*(s-h)<=(i-a)*(n-h)}function Ow(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!Hw(t,e)&&(Vw(t,e)&&Vw(e,t)&&zw(t,e)&&(Uw(t.prev,t,e.prev)||Uw(t,e.prev,e))||Fw(t,e)&&0<Uw(t.prev,t,t.next)&&0<Uw(e.prev,e,e.next))}function Uw(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function Fw(t,e){return t.x===e.x&&t.y===e.y}function Bw(t,e,i,s){var r=Gw(Uw(t,e,i)),n=Gw(Uw(t,e,s)),a=Gw(Uw(i,s,t)),h=Gw(Uw(i,s,e));return r!==n&&a!==h||0===r&&kw(t,i,e)||0===n&&kw(t,s,e)||0===a&&kw(i,t,s)||!(0!==h||!kw(i,e,s))}function kw(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function Gw(t){return 0<t?1:t<0?-1:0}function Hw(t,e){let i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&Bw(i,i.next,t,e))return 1}while((i=i.next)!==t)}function Vw(t,e){return Uw(t.prev,t,t.next)<0?0<=Uw(t,e,t.next)&&0<=Uw(t,t.prev,e):Uw(t,e,t.prev)<0||Uw(t,t.next,e)<0}function zw(t,e){let i=t,s=!1;for(var r=(t.x+e.x)/2,n=(t.y+e.y)/2;i.y>n!=i.next.y>n&&i.next.y!==i.y&&r<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(s=!s),(i=i.next)!==t;);return s}function Ww(t,e){var i=new Yw(t.i,t.x,t.y),s=new Yw(e.i,e.x,e.y),r=t.next,n=e.prev;return(t.next=e).prev=t,(i.next=r).prev=i,(s.next=i).prev=s,(n.next=s).prev=n,s}function jw(t,e,i,s){t=new Yw(t,e,i);return s?(t.next=s.next,(t.prev=s).next.prev=t,s.next=t):(t.prev=t).next=t,t}function Xw(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Yw(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Zw(i,s,r,n){let a=0;for(let t=s,e=r-n;t<r;t+=n)a+=(i[e]-i[t])*(i[t+1]+i[e+1]),e=t;return a}class qw{static area(i){var s=i.length;let r=0;for(let t=s-1,e=0;e<s;t=e++)r+=i[t].x*i[e].y-i[e].x*i[t].y;return.5*r}static isClockWise(t){return qw.area(t)<0}static triangulateShape(t,e){var i=[],s=[],r=[];Kw(t),Jw(i,t);let n=t.length;e.forEach(Kw);for(let t=0;t<e.length;t++)s.push(n),n+=e[t].length,Jw(i,e[t]);var a=gw.triangulate(i,s);for(let t=0;t<a.length;t+=3)r.push(a.slice(t,t+3));return r}}function Kw(t){var e=t.length;2<e&&t[e-1].equals(t[0])&&t.pop()}function Jw(e,i){for(let t=0;t<i.length;t++)e.push(i[t].x),e.push(i[t].y)}class $w extends Nh{constructor(e=new mw([new ct(0,.5),new ct(-.5,-.5),new ct(.5,-.5)]),f=12){super(),this.type="ShapeGeometry",this.parameters={shapes:e,curveSegments:f};let d=[],v=[],p=[],m=[],i=0,g=0;if(!1===Array.isArray(e))s(e);else for(let t=0;t<e.length;t++)s(e[t]),this.addGroup(i,g,t),i+=g,g=0;function s(t){var i=v.length/3,t=t.extractPoints(f);let s=t.shape;var r=t.holes;!1===qw.isClockWise(s)&&(s=s.reverse());for(let t=0,e=r.length;t<e;t++){var n=r[t];!0===qw.isClockWise(n)&&(r[t]=n.reverse())}var a=qw.triangulateShape(s,r);for(let t=0,e=r.length;t<e;t++){var h=r[t];s=s.concat(h)}for(let t=0,e=s.length;t<e;t++){var o=s[t];v.push(o.x,o.y,0),p.push(0,0,1),m.push(o.x,o.y)}for(let t=0,e=a.length;t<e;t++){var l=a[t],u=l[0]+i,c=l[1]+i,l=l[2]+i;d.push(u,c,l),g+=3}}this.setIndex(d),this.setAttribute("position",new ph(v,3)),this.setAttribute("normal",new ph(p,3)),this.setAttribute("uv",new ph(m,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}toJSON(){var t=super.toJSON();return Qw(this.parameters.shapes,t)}static fromJSON(i,s){var r=[];for(let t=0,e=i.shapes.length;t<e;t++){var n=s[i.shapes[t]];r.push(n)}return new $w(r,i.curveSegments)}}function Qw(i,s){if(s.shapes=[],Array.isArray(i))for(let t=0,e=i.length;t<e;t++){var r=i[t];s.shapes.push(r.uuid)}else s.shapes.push(i.uuid);return s}class t3 extends Nh{constructor(i=new mw([new ct(.5,.5),new ct(-.5,.5),new ct(-.5,-.5),new ct(.5,-.5)]),ht={}){super(),this.type="ExtrudeGeometry",this.parameters={shapes:i,options:ht},i=Array.isArray(i)?i:[i];let ot=this,lt=[],ut=[];for(let t=0,e=i.length;t<e;t++)(t=>{let s=[],U=void 0!==ht.curveSegments?ht.curveSegments:12,d=void 0!==ht.steps?ht.steps:1,i=void 0!==ht.depth?ht.depth:1,r=void 0===ht.bevelEnabled||ht.bevelEnabled,e=void 0!==ht.bevelThickness?ht.bevelThickness:.2,n=void 0!==ht.bevelSize?ht.bevelSize:e-.1,a=void 0!==ht.bevelOffset?ht.bevelOffset:0,v=void 0!==ht.bevelSegments?ht.bevelSegments:3,h=ht.extrudePath,F=void 0!==ht.UVGenerator?ht.UVGenerator:e3,o,l=!1,u,c,f,p,B=(h&&(o=h.getSpacedPoints(d),l=!0,r=!1,u=h.computeFrenetFrames(d,!1),c=new Gt,f=new Gt,p=new Gt),r||(v=0,e=0,n=0,a=0),t.extractPoints(U)),m=B.shape,g=B.holes,k=!qw.isClockWise(m);if(k){m=m.reverse();for(let t=0,e=g.length;t<e;t++){var G=g[t];qw.isClockWise(G)&&(g[t]=G.reverse())}}let _=qw.triangulateShape(m,g),w=m;for(let t=0,e=g.length;t<e;t++){var H=g[t];m=m.concat(H)}function M(t,e,i){return e||console.error("THREE.ExtrudeGeometry: vec does not exist"),t.clone().addScaledVector(e,i)}let y=m.length,E=_.length;function V(t,e,i){let s,r,n;var a=t.x-e.x,h=t.y-e.y,o=i.x-t.x,l=i.y-t.y,u=a*a+h*h;if(Math.abs(a*l-h*o)>Number.EPSILON){var c=Math.sqrt(u),f=Math.sqrt(o*o+l*l),d=e.x-h/c,e=e.y+a/c,c=((i.x-l/f-d)*l-(i.y+o/f-e)*o)/(a*l-h*o),i=(s=d+a*c-t.x,r=e+h*c-t.y,s*s+r*r);if(i<=2)return new ct(s,r);n=Math.sqrt(i/2)}else{let t=!1;a>Number.EPSILON?o>Number.EPSILON&&(t=!0):a<-Number.EPSILON?o<-Number.EPSILON&&(t=!0):Math.sign(h)===Math.sign(l)&&(t=!0),n=t?(s=-h,r=a,Math.sqrt(u)):(s=a,r=h,Math.sqrt(u/2))}return new ct(s/n,r/n)}var x=[];for(let t=0,e=w.length,i=e-1,s=t+1;t<e;t++,i++,s++)i===e&&(i=0),s===e&&(s=0),x[t]=V(w[t],w[i],w[s]);let b=[],S,A=x.concat();for(let t=0,e=g.length;t<e;t++){var T=g[t];S=[];for(let t=0,e=T.length,i=e-1,s=t+1;t<e;t++,i++,s++)i===e&&(i=0),s===e&&(s=0),S[t]=V(T[t],T[i],T[s]);b.push(S),A=A.concat(S)}for(let t=0;t<v;t++){var z=t/v,W=e*Math.cos(z*Math.PI/2),j=n*Math.sin(z*Math.PI/2)+a;for(let t=0,e=w.length;t<e;t++){var X=M(w[t],x[t],j);I(X.x,X.y,-W)}for(let t=0,e=g.length;t<e;t++){var Y=g[t];S=b[t];for(let t=0,e=Y.length;t<e;t++){var Z=M(Y[t],S[t],j);I(Z.x,Z.y,-W)}}}var q=n+a;for(let t=0;t<y;t++){var R=r?M(m[t],A[t],q):m[t];l?(f.copy(u.normals[0]).multiplyScalar(R.x),c.copy(u.binormals[0]).multiplyScalar(R.y),p.copy(o[0]).add(f).add(c),I(p.x,p.y,p.z)):I(R.x,R.y,0)}for(let e=1;e<=d;e++)for(let t=0;t<y;t++){var L=r?M(m[t],A[t],q):m[t];l?(f.copy(u.normals[e]).multiplyScalar(L.x),c.copy(u.binormals[e]).multiplyScalar(L.y),p.copy(o[e]).add(f).add(c),I(p.x,p.y,p.z)):I(L.x,L.y,i/d*e)}for(let t=v-1;0<=t;t--){var K=t/v,C=e*Math.cos(K*Math.PI/2),J=n*Math.sin(K*Math.PI/2)+a;for(let t=0,e=w.length;t<e;t++){var $=M(w[t],x[t],J);I($.x,$.y,i+C)}for(let t=0,e=g.length;t<e;t++){var Q=g[t];S=b[t];for(let t=0,e=Q.length;t<e;t++){var N=M(Q[t],S[t],J);l?I(N.x,N.y+o[d-1].y,o[d-1].x+C):I(N.x,N.y,i+C)}}}function tt(t,s){let e=t.length;for(;0<=--e;){var r=e;let i=e-1;i<0&&(i=t.length-1);for(let t=0,e=d+2*v;t<e;t++){var n=y*t,a=y*(t+1),h=s+i+n,o=s+i+a,l=(f=c=u=l=void 0,s+r+n),u=h,c=o,f=s+r+a;D(l),D(u),D(f),D(u),D(c),D(f),l=lt.length/3,O((u=F.generateSideWallUV(ot,lt,l-6,l-3,l-2,l-1))[0]),O(u[1]),O(u[3]),O(u[1]),O(u[2]),O(u[3])}}}function I(t,e,i){s.push(t),s.push(e),s.push(i)}function P(t,e,i){D(t),D(e),D(i);t=lt.length/3,e=F.generateTopUV(ot,lt,t-3,t-2,t-1);O(e[0]),O(e[1]),O(e[2])}function D(t){lt.push(s[3*t+0]),lt.push(s[3*t+1]),lt.push(s[3*t+2])}function O(t){ut.push(t.x),ut.push(t.y)}var et,t=lt.length/3;if(r){let e=0*y;for(let t=0;t<E;t++){var it=_[t];P(it[2]+e,it[1]+e,it[0]+e)}et=d+2*v,e=y*et;for(let t=0;t<E;t++){var st=_[t];P(st[0]+e,st[1]+e,st[2]+e)}}else{for(let t=0;t<E;t++){var rt=_[t];P(rt[2],rt[1],rt[0])}for(let t=0;t<E;t++){var nt=_[t];P(nt[0]+y*d,nt[1]+y*d,nt[2]+y*d)}}ot.addGroup(t,lt.length/3-t,0);{t=lt.length/3;let i=0;tt(w,i),i+=w.length;for(let t=0,e=g.length;t<e;t++){var at=g[t];tt(at,i),i+=at.length}ot.addGroup(t,lt.length/3-t,1)}})(i[t]);this.setAttribute("position",new ph(lt,3)),this.setAttribute("uv",new ph(ut,2)),this.computeVertexNormals()}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}toJSON(){var t=super.toJSON();return i3(this.parameters.shapes,this.parameters.options,t)}static fromJSON(i,s){var r=[];for(let t=0,e=i.shapes.length;t<e;t++){var n=s[i.shapes[t]];r.push(n)}var t=i.options.extrudePath;return void 0!==t&&(i.options.extrudePath=(new dw[t.type]).fromJSON(t)),new t3(r,i.options)}}let e3={generateTopUV:function(t,e,i,s,r){var n=e[3*i],i=e[3*i+1],a=e[3*s],s=e[3*s+1],h=e[3*r],e=e[3*r+1];return[new ct(n,i),new ct(a,s),new ct(h,e)]},generateSideWallUV:function(t,e,i,s,r,n){var a=e[3*i],h=e[3*i+1],i=e[3*i+2],o=e[3*s],l=e[3*s+1],s=e[3*s+2],u=e[3*r],c=e[3*r+1],r=e[3*r+2],f=e[3*n],d=e[3*n+1],e=e[3*n+2];return Math.abs(h-l)<Math.abs(a-o)?[new ct(a,1-i),new ct(o,1-s),new ct(u,1-r),new ct(f,1-e)]:[new ct(h,1-i),new ct(l,1-s),new ct(c,1-r),new ct(d,1-e)]}};function i3(i,t,s){if(s.shapes=[],Array.isArray(i))for(let t=0,e=i.length;t<e;t++){var r=i[t];s.shapes.push(r.uuid)}else s.shapes.push(i.uuid);return s.options=Object.assign({},t),void 0!==t.extrudePath&&(s.options.extrudePath=t.extrudePath.toJSON()),s}let s3=new ct;class r3{constructor(t=new ct(1/0,1/0),e=new ct(-1/0,-1/0)){this.isBox2=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromPoints(i){this.makeEmpty();for(let t=0,e=i.length;t<e;t++)this.expandByPoint(i[t]);return this}setFromCenterAndSize(t,e){e=s3.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(e),this.max.copy(t).add(e),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(t){return this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}containsPoint(t){return t.x>=this.min.x&&t.x<=this.max.x&&t.y>=this.min.y&&t.y<=this.max.y}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(t){return t.max.x>=this.min.x&&t.min.x<=this.max.x&&t.max.y>=this.min.y&&t.min.y<=this.max.y}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,s3).distanceTo(t)}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}class n3{constructor(){}static findNearNthPowerOfTwo(t){t-=1;return(t=(t=(t=(t=(t|=t>>1)|t>>2)|t>>4)|t>>8)|t>>16)<0?1:1+t}static polygonArea(e){if(e.length<3)return 0;let i=e.length;if(e[0].x===e[i-1].x&&e[0].y===e[i-1].y&&--i,i<3)return 0;let s=e[0].y*(e[i-1].x-e[1].x);for(let t=1;t<i-1;++t)s+=e[t].y*(e[t-1].x-e[t+1].x);return.5*(s=e[i-1].y*(e[i-2].x-e[0].x))}static closedPoints(t){var e=t.length;return!(e<3||(t[0].x===t[e-1].x&&t[0].y===t[e-1].y||(t[e]={x:t[e-1].x,y:t[e-1].y}),0))}static IsRectCross(t,e,i,s){return Math.min(t.x,e.x)<=Math.max(i.x,s.x)&&Math.min(i.x,s.x)<=Math.max(t.x,e.x)&&Math.min(t.y,e.y)<=Math.max(i.y,s.y)&&Math.min(i.y,s.y)<=Math.max(t.y,e.y)}static IsLineSegmentCross(t,e,i,s){var r=t.x*(i.y-e.y)+e.x*(t.y-i.y)+i.x*(e.y-t.y),n=t.x*(s.y-e.y)+e.x*(t.y-s.y)+s.x*(e.y-t.y);return!(0<=(r^n)&&(0!=r||0!=n)||0<=((r=i.x*(t.y-s.y)+s.x*(i.y-t.y)+t.x*(s.y-i.y))^(n=i.x*(e.y-s.y)+s.x*(i.y-e.y)+e.x*(s.y-i.y)))&&(0!=r||0!=n))}static computerFocus(t,e,i,s){var r,n,a;return 0==(n=(s.x-i.x)*(t.y-e.y)-(e.x-t.x)*(i.y-s.y))||(r=(a=(t.y-i.y)*(e.x-t.x)*(s.x-i.x)+i.x*(s.y-i.y)*(e.x-t.x)-t.x*(e.y-t.y)*(s.x-i.x))/n,a=e.y*(t.x-e.x)*(s.y-i.y)+(s.x-e.x)*(s.y-i.y)*(t.y-e.y)-s.y*(i.x-s.x)*(e.y-t.y),0==(n=(t.x-e.x)*(s.y-i.y)-(e.y-t.y)*(i.x-s.x)))?null:{x:r,y:a/n}}static GetLineSegmentCrossPoint(t,e,i,s){return this.IsRectCross(t,e,i,s)?this.computerFocus(t,e,i,s):null}static IsPointInPolygon(i,s){let r=!1;for(let t=0,e=i.length-1;t<i.length;e=t++)(i[t].y<=s.y&&s.y<i[e].y||i[e].y<=s.y&&s.y<i[t].y)&&s.x<(i[e].x-i[t].x)*(s.y-i[t].y)/(i[e].y-i[t].y)+i[t].x&&(r=!r);return r}static PointCmp(t,e,i){var s;return 0<=t.x&&e.x<0||(0===t.x&&0===e.x?t.y>e.y:(s=(t.x-i.x)*(e.y-i.y)-(e.x-i.x)*(t.y-i.y))<0||!(0<s)&&(e.x-i.x)*(e.x-i.y)+(e.y-i.y)*(e.y-i.y)<(t.x-i.x)*(t.x-i.x)+(t.y-i.y)*(t.y-i.y))}static ClockwiseSortPoints(i){var s,r={x:0,y:0};let e=0,n=0;for(let t=0;t<i.length;t++)e+=i[t].x,n+=i[t].y;r.x=e/i.length,r.y=n/i.length;for(let e=0;e<i.length-1;e++)for(let t=0;t<i.length-e-1;t++)this.PointCmp(i[t],i[t+1],r)&&(s=i[t],i[t]=i[t+1],i[t+1]=s)}static PolygonClip(i,s,r){if(i.length<3||s.length<3)return!1;for(let e=0;e<i.length;e++){var n=(e+1)%i.length;for(let t=0;t<s.length;t++){var a=(t+1)%s.length,a=this.GetLineSegmentCrossPoint(i[e],i[n],s[t],s[a]);a&&r.push(a)}}for(let t=0;t<i.length;t++)this.IsPointInPolygon(s,i[t])&&r.push(i[t]);for(let t=0;t<s.length;t++)this.IsPointInPolygon(i,s[t])&&r.push(s[t]);return!(r.length<=0||(this.ClockwiseSortPoints(r),0))}}class a3 extends zm{constructor(){super(),this.wu={}}resize(){super.resize(),this.wu={}}}class h3{constructor(){}}Object.assign(h3.prototype,{sh(t,e,i,s,r){r=void 0!==r?"?contentVersion="+r:"";t=new lv({method:"GET",url:t+e+"/"+e+".theme"+r});return t.sh(function(t){i&&i(t)},function(t){s&&(t===Nr.PATH_ERROR?s(Nr.THEME_ID_URL_ERROR):s(t))}),t}});let o3=new h3,l3={NORMAL:1,INDOOR:2,OUTDOOR:4};Object.freeze(l3);let u3,c3=new Gt,f3=new Gt,d3=new Gt,v3=new ct,p3=new ct,m3=new Ht,g3=new Gt,_3=new Gt,w3=new Gt,M3=new ct,y3=new ct,E3=new ct;class x3 extends Js{constructor(t=new ym){var e;super(),this.isSprite=!0,this.type="Sprite",void 0===u3&&(u3=new Nh,e=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),e=new z0(e,5),u3.setIndex([0,1,2,0,2,3]),u3.setAttribute("position",new j0(e,3,0,!1)),u3.setAttribute("uv",new j0(e,2,3,!1))),this.geometry=u3,this.material=t,this.center=new ct(.5,.5)}raycast(t,e){null===t.camera&&console.error('THREE.Sprite: "Raycaster.camera" needs to be set in order to raycast against sprites.'),f3.setFromMatrixScale(this.matrixWorld),m3.copy(t.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(t.camera.matrixWorldInverse,this.matrixWorld),d3.setFromMatrixPosition(this.modelViewMatrix),t.camera.isPerspectiveCamera&&!1===this.material.sizeAttenuation&&f3.multiplyScalar(-d3.z);var i=this.material.rotation;let s,r;0!==i&&(r=Math.cos(i),s=Math.sin(i));var i=this.center,n=(b3(g3.set(-.5,-.5,0),d3,i,f3,s,r),b3(_3.set(.5,-.5,0),d3,i,f3,s,r),b3(w3.set(.5,.5,0),d3,i,f3,s,r),M3.set(0,0),y3.set(1,0),E3.set(1,1),t.ray.intersectTriangle(g3,_3,w3,!1,c3));null===n&&(b3(_3.set(-.5,.5,0),d3,i,f3,s,r),y3.set(0,1),null===(n=t.ray.intersectTriangle(g3,w3,_3,!1,c3)))||(i=t.ray.origin.distanceTo(c3))<t.near||i>t.far||e.push({distance:i,point:c3.clone(),uv:so.getInterpolation(c3,g3,_3,w3,M3,y3,E3,new ct),face:null,object:this})}copy(t,e){return super.copy(t,e),void 0!==t.center&&this.center.copy(t.center),this.material=t.material,this}}function b3(t,e,i,s,r,n){v3.subVectors(t,i).addScalar(.5).multiply(s),void 0!==r?(p3.x=n*v3.x-r*v3.y,p3.y=r*v3.x+n*v3.y):p3.copy(v3),t.copy(e),t.x+=p3.x,t.y+=p3.y,t.applyMatrix4(m3)}class S3{constructor(t){this.wf=t,this.Qs=!0,this.Mf=new Map,this.yf={x:1,y:1,z:1},this.Ef=!0,this.As=null}get visible(){return this.Qs}set visible(t){this.Qs=t,this.Mf.forEach(t=>{t.xf()})}get show(){return this.Ef}set show(t){t!==this.Ef&&(this.Ef=t,this.bf({opacity:t?1:0,duration:1,finish:()=>{}}))}setFacadeNode(t){let e=t.FID;t.type===p.LABEL&&(e="label"+t.FID),this.Mf.set(e,t)}}Object.assign(S3.prototype,{Bu(t){var e;this.Ef=!this.wf.parent.Wt.Qa(this.wf),this.wf.Sf===l3.NORMAL&&(this.wf.Af(),e=this.wf.parent.nt.Gt(this.wf.Ht),this.yf.z=e.isZoomLimit?.2:1),t.Zs&&(t.Ai===p.EXTERNAL_MODEL?(t.Zs.scale.x=this.yf.x,t.Zs.scale.y=this.yf.z,t.Zs.scale.z=this.yf.y):t.Ai===p.MODEL&&(t.Zs.scale.x=this.yf.x,t.Zs.scale.y=this.yf.y,t.Zs.scale.z=this.yf.z)),this.bf({opacity:this.Ef?1:0,duration:1,finish:()=>{}})},Tf(n,a){if(a.scale.z!==this.yf.z||a.scale.y!==this.yf.y){let t=void 0!==a.duration?a.duration:.5;this.yf=a.scale,this.Mf.forEach(r=>{if((r.Ai===p.MODEL||r.Ai===p.EXTERNAL_MODEL)&&r.Zs){let e={x:r.Zs.scale.x,y:r.Zs.scale.y,z:r.Zs.scale.z},i={x:a.scale.x-e.x,y:a.scale.z-e.y,z:a.scale.y-e.z},s=(r.Ai===p.MODEL&&(i={x:a.scale.x-e.x,y:a.scale.y-e.y,z:a.scale.z-e.z}),new an({src:[0],dest:[1]}));s.K(t).J(t=>{t=t.destination[0];r.Zs?(r.Zs.scale.x=i.x*t+e.x,r.Zs.scale.y=i.y*t+e.y,r.Zs.scale.z=i.z*t+e.z,n.enableUpdateRender()):n.ot.ht(s)}).$(()=>{n.ot.ht(s),a.finish&&a.finish()}),n.ot.lt(s.X())}})}},bf(r){this.As?this.As.finish():this.As=new an,this.visible=!0;let i=this.wf.parent,n=[];if(this.Mf.forEach(s=>{s.Zs&&s.Zs.traverse(e=>{if(e.constructor===L){var i;s.Ai===p.MODEL&&(i=e.material.clone(),e.material.dispose(),e.material=i);let t=e.material;Array.isArray(t)||(t=[t]),s.Rf&&t.push(s.Rf.material),t.forEach(t=>{n.push({material:t,offset:r.opacity-t.opacity,opacity:t.opacity})})}})}),this.As.Y([0]).Z([1]).K(r.duration).J(t=>{var e=t.destination[0];for(let t=0;t<n.length;t++)n[t].material.opacity=n[t].offset*e+n[t].opacity,n[t].material.transparent=!0;i.enableUpdateRender()}).$(()=>{this.visible=this.Ef;for(let t=0;t<n.length;t++)n[t].material.opacity=n[t].opacity;i.ot.ht(this.As),r.finish&&r.finish(),i.enableUpdateRender()}).play(),i.ot.lt(this.As),0===r.duration){this.As.finish();for(let t=0;t<n.length;t++)n[t].material.opacity=r.opacity,i.enableUpdateRender()}}});class A3 extends rh{constructor(t){super(t),this.Lf=t.minlevel,this.Cf=t.maxlevel,this.Nf=t.levelChart,this.If=t.fids,this.Sf=l3.NORMAL,this.Pf=!1,this.Df=null,this.Of=new S3(this),this.Uf=!1,this.Ff=new Map,this.Bf=!0}get zoomRange(){return{minLevel:this.Lf,maxLevel:this.Cf}}get alignHeight(){return this.Bf&&(this.kf(),this.Bf=!1),this.Ff}get overviewMode(){return this.Sf}get visible(){return this.Qs}set visible(t){this.Qs=t,this.P.Wt.Gf(this),this.P.enableUpdateNode()}get levelChart(){return this.Nf}setTheme(t){this.P.Wt.Hf({themeID:t,bid:this.Ht})}setThemeExtension(t){this.P.Wt.Vf({data:t,bid:this.Ht})}clearThemeExtension(){this.P.Wt.Vf({bid:this.Ht})}getFadeFeatures(){var t,e=[];for(t of this.Of.Mf.values())e.push(t);return e}dispose(){super.dispose()}}function T3(t,e){return Object.assign({},e.Ls,{buildingID:t.dr,level:t.level,visibleLevels:t.visibleLevels,bid:t.Ht})}function R3(t){Object.assign(t.prototype,{zf(e,i,t){var s=this.nt.Gt(this.st.jt.Ht).themeID,r=this.Ls,n=this.Zu.get(this.Ls.buildingID).theme;let a="";if(a=t===this.Ls.buildingID?r.userThemeURL?r.userThemeURL+s:r.themeURL+s:(t=(t=this.Zu.get(t))&&t.theme?t.theme.themeID:s,r.userThemeURL?r.userThemeURL+t:r.themeURL+t),r.isPreview){let t=r.themeURL;return"path"===i?("1"===e.isuser?t+=n.userPath+"/":t+=n.sysPath+"/",t):"logoPath"===i?t+=n.logoPath+"/":"model"===i?("1"===e.isuser?t+=n.userModelPath+"/":t+=n.sysModelPath+"/",t):void 0}if("model"===i){if(r.externalModelURL)return r.externalModelURL+"models/";if(r.userThemeURL)return a+"/models/"}return a+"/"},Wf(e){if(this.jf||(this.jf=[0,0,0,0,0]),!this.jf.every(t=>1==t)){let t=!0;switch(e){case"sceneLoaded":this.jf[0]=1,t=1===this.jf[0],this.Xf=5;break;case"loaded":this.jf[1]=1,t=1===this.jf[1],this.Xf=85;break;case"externalFirstLoaded":this.jf[2]=1,this.jf[4]?this.Xf=100:t=!1;break;case"visibleLevelsLoaded":this.jf[3]=1,t=1===this.jf[3],this.Xf=55;break;case"firstViewLoaded":this.jf[4]=1,this.jf[2]?this.Xf=100:t=!1}t&&this.st.Yt.Xt({type:"progress",progressBar:this.Xf})}},mf(){if(this.nt&&!this.nt.Yf){if(this.nt.Ka&&0===this.Ua.length){let e=!0;if(this.Zf.nl.forEach(t=>{t.loadComplete||(e=!1)}),e=nt.environment==I.BROWSER&&window.fengmap.FMJSONLoader?window.fengmap.FMJSONLoader.getLoader(this.st)?.isAllLoadComplete:e)t:for(let t=0;t<this.st.children.length;t++){var i=this.st.children[t];if(!this.qf(i)){var s=i.getFloor(i.level).getLayers(p.EXTERNAL_MODEL_LAYER)[0];if(s)for(let t=0;t<s.children.length;t++){var r=s.children[t];if(-3!==r.Kf&&(1===r.Kf||0===r.Kf||!0!==r.Jf)){e=!1;break t}}}}e&&(this.nt.Yf=!0,this.st.Yt.Xt({type:"externalFirstLoaded"}),this.Wf("externalFirstLoaded"))}this.nt&&!this.nt.Yf&&(clearTimeout(this.$f),this.$f=setTimeout(()=>{this.mf()},50))}},Qf(t,a){if(this.Ls.tile&&!this.Ls.preLoad){let r=[],n=t.building;for(let t=0;t<n.visibleLevels.length;t++){var e=n.getFloor(n.visibleLevels[t]);e&&0===this.td(e)&&(this.ed(e)?(e.sd(),this.rd(e)):r.push(n.visibleLevels[t]))}0<r.length?((t=T3(n,this)).buildings=null,this.st.Or.Vo(t,(t,i)=>{if("floor"===t){var s=this.nt.nd(n.Ht);if(s.set(i.gid,!0),-1<r.indexOf(i.gid)){t=n.getFloor(i.gid);this.ad(t);let e=!0;for(let t=0;t<r.length;t++)if(!s.get(r[t])){e=!1;break}e&&a&&a()}}})):a&&a()}else a&&a()},hd(t,e={}){var i=this.nt.Gt(t),s=i.themeExtension||e.themeExtension,r=i.themeID||e.themeID;(i.themeID=r)&&t?(this.Zu.set(t,{theme:new zm}),i.themeLoaded=!1,i.themeNeedLoad=!0,this.nc({bid:t,themeID:r,themeExtension:s,contentVersion:e.contentVersion})):(i.themeLoaded=!0,i.themeNeedLoad=!1)},od(a){a=a||[];var t=this.st.Ls.buildingOptions;let h=t.buildings||t.themeID,o=null,l=()=>{var e=this.st.getBuildings();if(!1===this.st.rc)o=setTimeout(l,1);else{null!==o&&clearTimeout(o);var i=[];if(0<a.length)for(let t=0;t<a.length;t++){var s=a[t].bcode,s=this.ld(s);this.hd(s,a[t]),i.push(s)}if(h)for(let t=0;t<e.length;t++){var r=e[t].buildingID;i.includes(r)||this.hd(r)}if(i.length!==e.length)for(let t=0;t<e.length;t++){var n=e[t].buildingID;i.includes(n)||((n=this.nt.Gt(n)).themeLoaded=!0,n.themeNeedLoad=!1)}}};l()},nc(s){return new Promise((i,t)=>{this.ud(s,t=>{var e=this.Zu.get(s.bid);e.theme.Bu(t),e.theme.themeID=s.themeID,s.themeExtension&&(e.themeExtension=new a3,e.themeExtension.Bu(s.themeExtension)),this.nt.Gt(s.bid).themeLoaded=!0,s.bid===this.Ls.buildingID&&(this.nt.fd(this.dd),this.st.setBackgroundColor(this.nt.backgroundColor,this.nt.backgroundAlpha),this.Ls.isPreview?this.dd.sc(this.st):this.od(t.buildings)),this.nt.ac=this.hc(),(this.nt.vd||this.nt.pd)&&(this.W(null,null,this.nt.vd,!1,this.nt.pd,this.nt.ac),this.nt.vd)&&(this.nt.vd=!1),i()})})},ud(t,i){if(t.theme)i(t.theme);else{let e="_loadTheme"+ws.generateUUID();this.Qh.Kh(e),o3.sh(this.Ls.themeURL,t.themeID,t=>{i&&i(t),this.Qh.Jh(e)},t=>{this.st.Yt.Xt({type:"info",InfoMode:t}),this.Qh.Jh(e)},t.contentVersion)}},md(t){var e,i=this.nt.Gt(t.Ht);i.buildingLoaded||(this.Ls.tile?this.Qa(t)?((e=T3(t,this)).buildings=null,e.isOutdoor=!1,this.gd(e)):i.sceneLoaded||this.Ls.tile&&((e=T3(t,this)).buildings=null,e.isOutdoor=!1,this._d(e)):((i=Object.assign({},this.Ls)).isOutdoor=!1,i.buildingID=t.dr,i.bid=t.Ht,i.buildings=null,this.wd(i)))},Md(t,e){let i=null;t=this.st.getBuilding(t.bid),e={type:"info",InfoMode:e,buildingID:i=t?t.Ht:i};this.st.js.error.push(e),this.st.Yt.Xt(e)},yd(t,e){let i=null;t.buildingID!==t.mapID&&(i=t.bid),this.Ed({bid:t.bid,levels:e.levels}),this.st.Yt.Xt({type:"sceneLoaded",buildingID:i}),this.st.Yt.Xt({type:"info",InfoMode:Nr.INFO,mapID:e.mid,buildingID:i})},wd(h){this.st.Or.zo(h,(t,n)=>{if(!(0<this.st.js.error.length))if("complete"===t)if(h.isOutdoor){var e=this.xd(n);if(!(0<this.st.js.error.length)){var i=this.nt.Gt(e.Ht);if(i.buildingLoaded=!0,!(i.sceneLoaded=!0)!==this.bd(n,!0)){var s=this.nt.nd(e.Ht);for(let t=0;t<e.gr.length;t++){var r=n.Ft.get(e.gr[t]),a=(s.set(r.gid,!0),this.Ao(e,r,e.gr[t]));this.ad(a),this.Sd(e,r.gid)}}}}else this.st.Ft.forEach(e=>{if(e.dr===n.mid){e.gr=n.levels,e.R=new rr(new Gt(n.minX,n.minY),new Gt(n.maxX,n.maxY));var t=this.nt.Gt(e.Ht),i=(t.buildingLoaded=!0,t.sceneLoaded=!0,this.nt.nd(e.Ht));for(let t=0;t<n.levels.length;t++){var s=n.Ft.get(n.levels[t]),r=(i.set(s.gid,!0),this.Ao(e,s,n.levels[t]));this.ad(r),this.Sd(e,s.gid)}}});else if("decode"===t){let t=null;i=this.st.getBuilding(h.bid);i&&(t=i.Ht),this.Ed({bid:void 0!==h.bid?h.bid:h.buildingID,levels:n.scene.levels}),this.st.Yt.Xt({type:"sceneLoaded",buildingID:t}),this.st.Yt.Xt({type:"info",InfoMode:Nr.INFO,mapID:n.scene.mid,buildingID:t})}else"error"===t&&this.Md(h,n)})},bd(e,i){if(e.buildings)for(let t=0;t<e.buildings.length;t++){var s=this.Ad(e.buildings[t]);if(0<this.st.js.error.length&&i)return!1;this.md(s)}return e.buildings&&0!==e.buildings.length&&e.buildings.length!==this.st.Ft.length-1||(this.st.rc=!0),!0},Td(e,i){for(let t=0;t<e.gr.length;t++){var s=i.Ft.get(e.gr[t]);this.Ao(e,s,e.gr[t])}},gd(r){this.st.Or.Vo(r,(t,e)=>{if(!(0<this.st.js.error.length)){if("building"===t){let t=null;var i=this.nt.Gt(r.bid),s=i.sceneLoaded;i.buildingLoaded=!0,i.sceneLoaded=!0,r.buildingID===r.mapID?(t=this.xd(e),this.bd(e,!1)):(t=this.st.getBuilding(r.bid),s||(t.gr=e.levels,t.R=new rr(new Gt(e.minX,e.minY),new Gt(e.maxX,e.maxY)))),s||this.Td(t,e)}"scene"===t&&this.yd(r,e),"floor"===t&&(i=this.st.getBuilding(r.bid),this.nt.nd(i.Ht).set(e.gid,!0),(s=i.getFloor(e.gid)).qs=e,this.ad(s),this.Sd(i,e.gid)),"error"===t&&this.Md(r,e)}})},_d(r){let i=null;this.st.Or.ro(r,(t,e)=>{"building"===t?((i=this.st.getBuilding(r.bid)).gr=e.levels,i.R=new rr(new Gt(e.minX,e.minY),new Gt(e.maxX,e.maxY)),this.nt.Gt(i.Ht).sceneLoaded=!0,this.Td(i,e),this.Sd(i,void 0)):"scene"===t&&this.yd(r,e)},(t,e)=>{let i=null;var s=this.st.getBuilding(r.bid);s&&(i=s.Ht),this.st.Yt.Xt({type:"info",InfoMode:e,buildingID:i})})},Gf(t){this.md(t)},Sd(t,e){var i=this.nt.Gt(t.Ht),s=i.loaded,r=i.visibleLevelsLoaded;this.Rd(t),!r&&i.visibleLevelsLoaded&&(this.nt.vd&&this.nt.ac?(this.W(null,e,!0,!0,!1,this.nt.ac),this.nt.vd=!1):this.W(null,e,!1,!0,!1,this.nt.ac),r={type:"visibleLevelsLoaded"},t!==this.st.jt&&(r.buildingID=t.Ht),this.st.Yt.Xt(r)),!s&&i.loaded&&(t!==this.st.jt?this.st.Yt.Xt({type:"buildingLoaded",buildingID:t.Ht}):this.st.Yt.Xt({type:"mapLoaded"})),this.nt.pd&&this.nt.ac&&this.W(null,e,!1,!1,!0,this.nt.ac)},hc(){let e=!0;for(let t=0;t<this.st.Ft.length;t++){var i=this.st.Ft[t];if(i.constructor===A3){if(this.Qa(i)&&!this.nt.hc(i.Ht)){e=!1;break}}else if(!this.nt.hc(i.Ht)){e=!1;break}}return e}})}Object.assign(A3.prototype,{lt(t){(t.P=this).Ft.push(t)},Af(){var t,e=this.parent.nt.Gt(this.Ht);this.Sf===l3.OUTDOOR?e.isZoomLimit=!1:(t=this.parent.getZoom(),e.isZoomLimit=!(t<this.Lf||t>=this.Cf))},Ld(t={}){this.Af();var e=this.parent.nt.Gt(this.Ht);this.Of.Tf(this.parent,{scale:{x:1,y:1,z:e.isZoomLimit?.2:1},duration:void 0!==t.duration?t.duration:1,finish:()=>{}})},kf(){if(this.P){var e=this.P.jt;for(let t=0;t<this.Nf.length;t+=2){var i=e.floorSpace*this.Nf[t];this.Ff.set(this.Nf[t+1],i)}}},Cd(e){if(null==this.level)for(let t=0;t<this.Nf.length;t+=2){var i;this.Nf[t]===e&&((i=this.parent.nt.Gt(this.Ht)).level=this.Nf[t+1],i.visibleLevels=[this.Nf[t+1]])}},Nd(t){var e=[...this.visibleLevels];"remove"===t&&void 0!==this.yr&&2===e.length&&0<=e.indexOf(this.yr)&&e.splice(e.indexOf(this.yr),1),this.setVisibleLevels(e)}});let L3={NAME:2,ENAME:4,FID:8};Object.freeze(L3);class C3 extends rh{constructor(t){super(t),this.Jt=t.height,this.R=t.bounds,this.ns=t.zoom,this.lr=!0}get height(){return this.Jt}get floorSpace(){return super.floorSpace}set floorSpace(t){super.floorSpace=t,this.P.traverse(t=>{t!==this&&(t.Bf=!0,t.traverse(t=>{t.br({animate:!1})}))})}getFloors(){return this.Ft}}Object.assign(C3.prototype,{lt(t){(t.P=this).Ft.push(t)}});class N3{constructor(t=0,e=0,i=0){Object.defineProperty(this,"isVector3",{value:!0}),this.x=t,this.y=e,this.z=i}set(t,e,i){return void 0===i&&(i=this.z),this.x=t,this.y=e,this.z=i,this}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}cross(t,e){return void 0!==e?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(t,e)):this.crossVectors(this,t)}crossVectors(t,e){var i=t.x,s=t.y,t=t.z,r=e.x,n=e.y,e=e.z;return this.x=s*e-t*n,this.y=t*r-i*e,this.z=i*n-s*r,this}angleTo(t){var e=Math.sqrt(this.lengthSq()*t.lengthSq());return 0===e?Math.PI/2:(t=this.dot(t)/e,e=Math.max(-1,Math.min(1,t)),Math.acos(e))}normalize(){return this.divideScalar(this.length()||1)}divideScalar(t){return this.multiplyScalar(1/t)}}class I3{constructor(t){this.Ia=t.size,this.yi=t.center,this.Id=t.points}get size(){return this.Ia}get min(){return{x:this.yi.x-this.Ia.x/2,y:this.yi.y-this.Ia.y/2}}get max(){return{x:this.yi.x+this.Ia.x/2,y:this.yi.y+this.Ia.y/2}}get center(){return{x:this.yi.x,y:this.yi.y}}get points(){return this.Id}}class P3{constructor(t){this.Pd=[],this.Ia=null,this.Dd=[],this.Te=void 0!==t.distance?t.distance:0,this.Od=void 0!==t.circleSegment?t.circleSegment:8,this.Ud=Math.PI/2/this.Od,this.Fd=void 0!==t.endCapStyle?t.endCapStyle:"circle",this.Bd=void 0!==t.isSingleSide&&t.isSingleSide}computeOffsetCurve(e){this.Dd=[];let i=null;var t,s,r=this.Te,n="left";for(let t=2;t<e.length;t++){var a=e[t-2],h=e[t-1],o=e[t],l={p0:{x:null,y:null},p1:{x:null,y:null}},u=(this.kd({p0:a,p1:h},n,r,l),{p0:h,p1:o}),c={p0:{x:null,y:null},p1:{x:null,y:null}},u=(this.kd(u,n,r,c),this.Gd(a,h,o));0==u?this.Hd(l,c):-1==u?this.Vd(u,l,c,h):this.zd(u,l,c,h),i=c}this.Dd.push(i.p1),this.Wd(e[e.length-2],e[e.length-1]);for(let t=e.length-1;2<=t;t--){var f=e[t],d=e[t-1],v=e[t-2],p={p0:{x:null,y:null},p1:{x:null,y:null}},m=(this.kd({p0:f,p1:d},n,r,p),{p0:d,p1:v}),g={p0:{x:null,y:null},p1:{x:null,y:null}},m=(this.kd(m,n,r,g),this.Gd(f,d,v));0==m?this.Hd(p,g):-1==m?this.Vd(m,p,g,d):this.zd(m,p,g,d),i=g}return this.Dd.push(i.p1),this.Wd(e[1],e[0]),this.Dd=this.jd(this.Dd),this.Dd.length<1||(t=this.Dd[0],s=this.Dd[this.Dd.length-1],t.x===s.x&&t.y===s.y||this.Dd.push(t),this.Dd=this.Xd(this.Dd,e),this.Dd.length<1)?[]:this.Dd}computeSingleSidedBufferCurve(i,s){this.Dd=[];let r=null,n=this.Te;if("left"==s){let e=!1;for(let t=2;t<i.length;t++){var a=i[t-2],h=i[t-1],o=i[t],l={p0:{x:null,y:null},p1:{x:null,y:null}},u=(this.kd({p0:a,p1:h},s,n,l),{p0:h,p1:o}),c={p0:{x:null,y:null},p1:{x:null,y:null}},u=(this.kd(u,s,n,c),this.Gd(a,h,o));e||(this.Dd.push(l.p0),e=!0),0==u?this.Hd(l,c):-1==u&&"left"===s||1==u&&"right"===s?this.Vd(u,l,c,h):this.zd(u,l,c,h),r=c}this.Dd.push(r.p1),this.Yd(i[i.length-2],i[i.length-1],"left");for(let t=i.length-1;0<=t;t--)this.Dd.push(i[t]);this.Yd(i[1],i[0],"right")}else if("right"==s){s="left",n=-n,this.Te=n;let e=!1;for(let t=i.length-1;2<=t;t--){var f=i[t],d=i[t-1],v=i[t-2],p={p0:{x:null,y:null},p1:{x:null,y:null}},m=(this.kd({p0:f,p1:d},s,n,p),{p0:d,p1:v}),g={p0:{x:null,y:null},p1:{x:null,y:null}},m=(this.kd(m,s,n,g),this.Gd(f,d,v));e||(this.Dd.push(p.p0),e=!0),0==m?this.Hd(p,g):-1==m&&"left"===s||1==m&&"right"===s?this.Vd(m,p,g,d):this.zd(m,p,g,d),r=g}this.Dd.push(r.p1),this.Yd(i[1],i[0],"left");for(let t=0;t<i.length;t++)this.Dd.push(i[t]);this.Yd(i[i.length-2],i[i.length-1],"right")}var t,e;return this.Dd=this.jd(this.Dd),this.Dd=this.Xd(this.Dd),this.Dd.length<1?[]:(t=this.Dd[0],e=this.Dd[this.Dd.length-1],t.x===e.x&&t.y===e.y||this.Dd.push(t),this.Dd)}computeSingleSideRingBufferCurve(e,i,t){this.Dd=[],!t&&this.Bd&&(this.Te=-this.Te);var s,r=this.Te;if("left"===i){this.Zd(e[e.length-2],e[0],e[1],i);for(let t=2;t<e.length;t++){var n=e[t-2],a=e[t-1],h=e[t],o={p0:{x:null,y:null},p1:{x:null,y:null}},l=(this.kd({p0:n,p1:a},i,r,o),{p0:a,p1:h}),u={p0:{x:null,y:null},p1:{x:null,y:null}},l=(this.kd(l,i,r,u),this.Gd(n,a,h));0==l?this.Hd(o,u):-1==l&&"left"===i||1==l&&"right"===i?this.Vd(l,o,u,a):this.zd(l,o,u,a)}}else if("right"===i){this.Zd(e[1],e[0],e[e.length-2],i="left");for(let t=e.length-1;2<=t;t--){var c=e[t],f=e[t-1],d=e[t-2],v={p0:{x:null,y:null},p1:{x:null,y:null}},p=(this.kd({p0:c,p1:f},i,r,v),{p0:f,p1:d}),m={p0:{x:null,y:null},p1:{x:null,y:null}},p=(this.kd(p,i,r,m),this.Gd(c,f,d));0==p?this.Hd(v,m):-1==p&&"left"===i||1==p&&"right"===i?this.Vd(p,v,m,f):this.zd(p,v,m,f)}}return this.Dd=this.jd(this.Dd),this.Dd=this.Xd(this.Dd),this.Dd.length<1?[]:(t=this.Dd[0],s=this.Dd[this.Dd.length-1],t.x===s.x&&t.y===s.y||this.Dd.push(t),this.Dd)}isCCW(e){let i=0;for(let t=0;t<e.length-1;t++)i+=e[t].x*e[t+1].y-e[t].y*e[t+1].x;return!(i<0)}kd(t,e,i,s){var e="left"===e?1:-1,r=t.p1.x-t.p0.x,n=t.p1.y-t.p0.y,a=Math.sqrt(r*r+n*n),r=e*i*r/a,e=e*i*n/a;s.p0.x=t.p0.x-e,s.p0.y=t.p0.y+r,s.p1.x=t.p1.x-e,s.p1.y=t.p1.y+r}Gd(t,e,i){var s=e.x-t.x,r=i.x-e.x,s=s*(i.y-e.y)-(e.y-t.y)*r;return 0<s?1:s<0?-1:0}Hd(t,e){this.Dd.push(t.p1),this.Dd.push(e.p0)}Vd(t,e,i,s){G.Te(e,i)<.001*this.Te?this.Dd.push(e.p1):(this.Dd.push(e.p1),this.qd(s,e.p1,i.p0,t,this.Te),this.Dd.push(i.p0))}zd(t,e,i,s){var r={x:null,y:null};let n=e.p1.x-e.p0.x,a=e.p1.y-e.p0.y,h=i.p1.x-i.p0.x,o=i.p1.y-i.p0.y;if(Math.abs(n*o-h*a)<.001){if(G.we(i.p0,i.p1,e.p1))return void this.Dd.push(e.p1);this.Dd.push(i.p0)}G.De(e.p0,e.p1,i.p0,i.p1,r)?this.Dd.push(r):(this.Kd=!0,G.Te(e.p1,i.p0)<.001*this.Te?this.Dd.push(e.p1):(this.Dd.push(e.p1),this.Dd.push(i.p0)))}qd(t,e,i,s,r){var n=e.x-t.x;let a=Math.atan2(e.y-t.y,n);n=i.x-t.x,n=Math.atan2(i.y-t.y,n);-1===s?a<=n&&(a+=2*Math.PI):a>=n&&(a-=2*Math.PI),this.Dd.push(e),this.Jd(t,a,n,s,r),this.Dd.push(i)}Jd(e,i,t,s,r){var n=-1===s?-1:1,s=Math.abs(i-t),a=Math.trunc(s/this.Ud+.5);if(a<1)return null;var h=s/a;for(let t=0;t<a;t++){var o=i+n*t*h,l={x:null,y:null};l.x=e.x+r*Math.cos(o),l.y=e.y+r*Math.sin(o),this.Dd.push(l)}}Wd(t,e){var i={p0:t,p1:e},s={p0:{x:null,y:null},p1:{x:null,y:null}},r=(this.kd(i,"left",this.Te,s),{p0:{x:null,y:null},p1:{x:null,y:null}}),i=(this.kd(i,"right",this.Te,r),e.x-t.x),n=Math.atan2(e.y-t.y,i);switch(this.Fd){case"circle":this.Dd.push(s.p1),this.Jd(e,n+Math.PI/2,n-Math.PI/2,-1,this.Te),this.Dd.push(r.p1);break;case"flat":this.Dd.push(s.p1),this.Dd.push(r.p1);break;case"square":var a={x:null,y:null},h=(a.x=Math.abs(this.Te)*Math.cos(n),a.y=Math.abs(this.Te)*Math.sin(n),{x:s.p1.x+a.x,y:s.p1.y+a.y}),a={x:r.p1.x+a.x,y:r.p1.y+a.y};this.Dd.push(h),this.Dd.push(a)}}Yd(t,e,i){var s,r,n={p0:t,p1:e},a={p0:{x:null,y:null},p1:{x:null,y:null}},n=("left"==i?this.kd(n,"left",this.Te,a):"right"==i&&this.kd(n,"right",this.Te,a),e.x-t.x),h=Math.atan2(e.y-t.y,n),o={x:null,y:null};switch(o.x=Math.abs(this.Te)*Math.cos(h),o.y=Math.abs(this.Te)*Math.sin(h),this.Fd){case"circle":"left"==i?(this.Dd.push(a.p1),this.Jd(e,h+Math.PI/2,h,-1,this.Te),this.Dd.push({x:e.x+o.x,y:e.y+o.y})):"right"==i&&(this.Dd.push({x:e.x+o.x,y:e.y+o.y}),this.Jd(e,h,h-Math.PI/2,-1,this.Te),this.Dd.push(a.p1));break;case"flat":break;case"square":"left"==i?(s={x:a.p1.x+o.x,y:a.p1.y+o.y},r={x:e.x+o.x,y:e.y+o.y},this.Dd.push(s),this.Dd.push(r)):"right"==i&&(s={x:a.p1.x+o.x,y:a.p1.y+o.y},r={x:e.x+o.x,y:e.y+o.y},this.Dd.push(r),this.Dd.push(s))}}jd(e){var i=[];for(let t=0;t<e.length-1;t++)G.distance(e[t],e[t+1])<1e-4||i.push(e[t]);return 1e-4<G.distance(e[e.length-1],e[e.length-2])&&i.push(e[e.length-1]),i}Xd(s,r){if(s.length<=4)return s;for(;;){let i=null;for(let e=1;e<s.length;e++){var n=s[e-1],a=s[e];for(let t=e+2;t<s.length;t++){var h=s[t-1],o=s[t];if(1!==e||t!==s.length-1){var l={x:null,y:null};if(G.De(n,a,h,o,l)){i={start:e,length:t-e,cross:l};break}}}if(i)break}if(!i)return s;var{start:u,length:c,cross:f}=i;let t=!1;for(let e of[[...s.slice(0,u),f,...s.slice(u+c),s[0]],[f,...s.slice(u,u+c),f]])if(!r||"circle"!==this.Fd&&"square"!==this.Fd?r&&"flat"===this.Fd?2<=r.length&&(t=r.slice(1,r.length-1).every(t=>G.Se(t,e,e.length-1))):t=!0:t=r.every(t=>G.Se(t,e,e.length-1)),t){s=e;break}}}Zd(t,e,i,s){var r={p0:{x:null,y:null},p1:{x:null,y:null}},n=(this.kd({p0:t,p1:e},s,this.Te,r),{p0:e,p1:i}),a={p0:{x:null,y:null},p1:{x:null,y:null}},n=(this.kd(n,s,this.Te,a),this.Gd(t,e,i));0==n?this.Hd(r,a):-1==n&&"left"===s||1==n&&"right"===s?this.Vd(n,r,a,e):this.zd(n,r,a,e)}}class D3{constructor(){}static distance(t,e){return G.distance(t,e)}static isContain(t,e){return G.isPolygonContainPoint(t,e)}static inExtents(t){let s=!1;var e=t.type,r=t.point,i=t.level,n=t.map;let a=t.buildingID;a=a||n.getMapOptions().mapID,void 0===e&&p.EXTENT_LAYER;var h=n.getBuilding(a).getFloor(i).getLayers(p.EXTENT_LAYER)[0].children;for(let i=0;i<h.length;i++){let e=!1;if((s=G.Se(r,h[i].coordinates[0],h[i].coordinates[0].length-1))&&1<h[i].coordinates.length)for(let t=1;t<h[i].coordinates.length;t++)if(G.Se(r,h[i].coordinates[t],h[i].coordinates[t].length-1)){e=!0;break}if(s){e&&(s=!1);break}}return s}static bound(e){let i=-Number.MAX_VALUE,s=-Number.MAX_VALUE,r=Number.MAX_VALUE,n=Number.MAX_VALUE;for(let t=0;t<e.length;t++)e[t].x>i&&(i=e[t].x),e[t].y>s&&(s=e[t].y),e[t].x<r&&(r=e[t].x),e[t].y<n&&(n=e[t].y);return{max:{x:i,y:s},min:{x:r,y:n},size:{x:i-r,y:s-n},center:{x:(i+r)/2,y:(s+n)/2}}}static orientedBound(n){var t={center:{x:0,y:0},size:{x:0,y:0},rotation:{x:0,y:0},corners:[]};if(n&&0!=n.length){var a=nn.cov(n),h=nn.eig(a).eigVect;let e=Number.MAX_VALUE,i=Number.MAX_VALUE,s=-Number.MAX_VALUE,r=-Number.MAX_VALUE;for(let t=0;t<n.length;t++){var o=n[t].x*h[0][0]+n[t].y*h[0][1],l=n[t].x*h[1][0]+n[t].y*h[1][1];o<e&&(e=o),l<i&&(i=l),o>s&&(s=o),l>r&&(r=l)}var a=[(s+e)/2,(r+i)/2],u=h[0][0]*h[1][1]-h[1][0]*h[0][1],u=[[h[1][1]/u,-h[0][1]/u],[-h[1][0]/u,h[0][0]/u]],a=[u[0][0]*a[0]+u[0][1]*a[1],u[1][0]*a[0]+u[1][1]*a[1]],a=(t.center.x=a[0],t.center.y=a[1],t.size.x=s-e,t.size.y=r-i,[[e,i],[e,r],[s,r],[s,i]]),c=[[],[],[],[]],u=(c[0]=[u[0][0]*a[0][0]+u[0][1]*a[0][1],u[1][0]*a[0][0]+u[1][1]*a[0][1]],c[1]=[u[0][0]*a[1][0]+u[0][1]*a[1][1],u[1][0]*a[1][0]+u[1][1]*a[1][1]],c[2]=[u[0][0]*a[2][0]+u[0][1]*a[2][1],u[1][0]*a[2][0]+u[1][1]*a[2][1]],c[3]=[u[0][0]*a[3][0]+u[0][1]*a[3][1],u[1][0]*a[3][0]+u[1][1]*a[3][1]],new N3(1,0,0)),a=new N3(c[0][0],0,c[0][1]),a=new N3(c[3][0],0,c[3][1]).clone().sub(a).normalize(),f=a.angleTo(u)*G.de(),a=0<a.clone().cross(u).y?f:360-f,f=new N3(c[0][0],0,c[0][1]),f=new N3(c[1][0],0,c[1][1]).clone().sub(f).normalize(),d=f.angleTo(u)*G.de(),f=0<f.clone().cross(u).y;return t.rotation={x:a,y:f?d:360-d},t.corners=[{x:c[0][0],y:c[0][1]},{x:c[1][0],y:c[1][1]},{x:c[2][0],y:c[2][1]},{x:c[3][0],y:c[3][1]}],t}}static scaleBound(t,e){var{max:t,min:i}=t,t=new ct(t.x,t.y),i=new ct(i.x,i.y),s=t.clone().add(i).multiplyScalar(.5),t=t.clone().sub(i),i=t.clone().normalize(),t=t.clone().length()*e,e=s.clone().add(i.clone().multiplyScalar(t/2)),s=s.clone().add(i.clone().multiplyScalar(-t/2)),i=e.x,t=e.y,e=s.x,s=s.y;return{max:{x:i,y:t},min:{x:e,y:s},size:{x:Math.abs(i-e),y:Math.abs(t-s)},center:{x:(i+e)/2,y:(t+s)/2}}}static rectangleBuilder(t,e,i){var s=[];return s.push({x:i.x-t/2,y:i.y+e/2}),s.push({x:i.x+t/2,y:i.y+e/2}),s.push({x:i.x+t/2,y:i.y-e/2}),s.push({x:i.x-t/2,y:i.y-e/2}),s}static circleBuilder(e,i,s){var r=[];for(let t=0;t<=s;t++){var n=t/s*Math.PI*2;r.push({x:i.x+e*Math.cos(n),y:i.y+e*Math.sin(n)})}return r}static fanBuilder(e,i,s,t){var r=[],n=(r.push(i),[t[0]/180*Math.PI,t[1]/180*Math.PI]),a=(n[1]-n[0])/s;for(let t=0;t<=s;t++){var h=n[0]+t*a;r.push({x:i.x+e*Math.sin(h),y:i.y+e*Math.cos(h)})}return r}static area(t){return G.Pe(t,t.length)}static TriangleCentroid(t,e,i,s){var r=e.x-t.x,n=i.x-t.x;return s.area=(r*(i.y-t.y)-n*(e.y-t.y))/2,s.centroid={},s.centroid.x=(t.x+e.x+i.x)/3,s.centroid.y=(t.y+e.y+i.y)/3,!0}static calculatorInsideCentroid(e,t){var i=e.length;if(i<3)return!1;var r=[];for(let t=1;t<i-1;t++){var s={};this.TriangleCentroid(e[0],e[t],e[t+1],s),r.push(s)}let n=[],a=(r.forEach(function(t,e,i){n.push(t)}),!1);n.sort(function(t,e){return(0<t.area?t.area:-t.area)-(0<e.area?e.area:-e.area)});for(;0<n.length&&!(a=this.calculatorCentroid(e,n,t));)n.shift();if(!a){let s=[];r.forEach(function(t,e,i){s.push(t)});for(;0<s.length&&!(a=this.calculatorCentroid(e,s,t));)s.shift()}return a}static calculatorCentroid(t,e,i){let s=0;var r={x:0,y:0};for(let t=0;t<e.length;t++)r.x+=e[t].centroid.x*e[t].area,r.y+=e[t].centroid.y*e[t].area,s+=e[t].area;return i.x=r.x/s,i.y=r.y/s,this.isContain(t,i)}static latlngToMapCoordinate(t){return{x:20037508.34*parseFloat(t.x)/180,y:Math.log(Math.tan((90+parseFloat(t.y))*Math.PI/360))/(Math.PI/180)*20037508.34/180}}static mapCoordinateToLatlng(t){var e=parseFloat(t.y)/20037508.34*180;return{x:parseFloat(t.x)/20037508.34*180,y:180/Math.PI*(2*Math.atan(Math.exp(e*Math.PI/180))-Math.PI/2)}}static maxInnerRect(v,t){if(v&&0!=v.length){var p=new N3(0,0,1),m={center:{x:0,y:0},size:{x:0,y:0},rotation:{x:0,y:0},corners:[]};let i=Number.MAX_VALUE,s=Number.MAX_VALUE,e=-Number.MAX_VALUE,r=-Number.MAX_VALUE;var g=[];for(let t=0;t<v.length;t++){var _=v[t].x,w=v[t].y;_<i&&(i=_),w<s&&(s=w),_>e&&(e=_),w>r&&(r=w),g.push({x:_,y:w})}var M=(e-i<r-s?e-i:r-s)/100,y=Math.ceil((e-i)/M),E=Math.ceil((r-s)/M),x=[];for(let e=0;e<E-1;e++){var b=new Array(y-1).fill(0);for(let t=0;t<y-1;t++){var S=i+M*t,A=i+M*(t+1),T=s+M*e,R=s+M*(e+1),S=[{x:S,y:T},{x:S,y:R},{x:A,y:R},{x:A,y:T}];G.isPolygonInPolygon(S,g)&&(b[t]=1)}x.push(b)}var L=new Array(y).fill(0);let n=0,a=0,h=0,o=0,l=0;for(let e=0;e<E-1;e++){var C=[];for(let t=0;t<y;t++){for(L[y-1]=0,t<y-1&&(L[t]=1==x[e][t]?L[t]+1:0);0<C.length&&L[C[C.length-1]]>=L[t];){var N=C[C.length-1],I=(C.pop(),L[N]*(0==C.length?t:t-C[C.length-1]-1));I>n&&(n=I,a=0==C.length?0:C[C.length-1]+1,h=t,o=e,l=e-L[N]+1)}C.push(t)}}var P=i+a*M,D=s+(o+1)*M,O=i+(h+1)*M,U=s+l*M,F=[[P,U],[P,D],[O,D],[O,U]];let u=0,c=2,f=Number.MAX_VALUE,d=-Number.MAX_VALUE;for(let t=0;t<F.length;t++)F[t][0]*F[t][0]+F[t][1]*F[t][1]<f&&(u=t,f=F[t][0]*F[t][0]+F[t][1]*F[t][1]),F[t][0]*F[t][0]+F[t][1]*F[t][1]>d&&(c=t,d=F[t][0]*F[t][0]+F[t][1]*F[t][1]);m.corners=[{x:F[0][0],y:F[0][1]},{x:F[1][0],y:F[1][1]},{x:F[2][0],y:F[2][1]},{x:F[3][0],y:F[3][1]}],m.center.x=(F[c][0]+F[u][0])/2,m.center.y=(F[c][1]+F[u][1])/2;var P=new N3(F[u][0],0,F[u][1]),D=new N3(F[(u+c)/2][0],0,F[(u+c)/2][1]),O=D.clone().sub(P).normalize(),U=(O.angleTo(p),G.de(),O.clone().cross(p).y,new N3(F[(u+c)/2][0],0,F[(u+c)/2][1])),B=new N3(F[c][0],0,F[c][1]),k=B.clone().sub(U).normalize();return k.angleTo(p),G.de(),k.clone().cross(p).y,O.clone().cross(k).y<0?(m.size.x=D.clone().sub(P).length(),m.size.y=B.clone().sub(U).length()):(m.size.x=B.clone().sub(U).length(),m.size.y=D.clone().sub(P).length()),new I3({center:m.center,size:m.size,points:m.corners})}}static angle(t){var e=new N3(0,0,1),i=new N3(t.start.x,0,t.start.y),t=new N3(t.end.x,0,t.end.y).clone().sub(i).normalize(),i=t.angleTo(e)*G.de();return t.clone().cross(e).y<0?i:360-i}static intersection(t,e){var i={x:null,y:null};return 2<=t.length&&2<=e.length&&G.De(t[0],t[1],e[0],e[1],i),i}static lineBufferBuilder(e,i){var s={points:[],holes:[]};if(void 0!==i.distance&&0!=i.distance){var r=i.distance,n=(i.endCapStyle=void 0!==i.endCapStyle?i.endCapStyle:"circle",i.circleSegment=void 0!==i.circleSegment?i.circleSegment:8,null!=i.isSingleSide&&i.isSingleSide),a=e[e.length-1].x==e[0].x&&e[e.length-1].y==e[0].y;if(!(a&&e.length<4)){let t=!1;i=new P3(i);a&&(t=i.isCCW(e)),n?a?0<r?t?s.points=i.computeSingleSideRingBufferCurve(e,"right",!0):s.points=i.computeSingleSideRingBufferCurve(e,"left",!0):(t?s.points=i.computeSingleSideRingBufferCurve(e,"left",!1):s.points=i.computeSingleSideRingBufferCurve(e,"right",!1),i.isCCW(s.points)!=t&&(s.points=[])):s.points=0<r?i.computeSingleSidedBufferCurve(e,"left"):i.computeSingleSidedBufferCurve(e,"right"):a?(t?(s.points=i.computeSingleSideRingBufferCurve(e,"right",!0),s.holes=i.computeSingleSideRingBufferCurve(e,"left",!1)):(s.points=i.computeSingleSideRingBufferCurve(e,"left",!0),s.holes=i.computeSingleSideRingBufferCurve(e,"right",!1)),i.isCCW(s.holes)!=t&&(s.holes=[])):s.points=i.computeOffsetCurve(e)}}return s}}class O3{constructor(t){this.$d=nn.generateUUID(),this.Id=t.points,this.Qd=t.polygons,this.t0=[],this.e0=[],this.i0=t.extrudeHeight,void 0===this.i0&&(this.i0=2e13),this.Jt=t.height,void 0===this.Jt&&(this.Jt=-1e13),this.s0=t.types,this.Kr=t.opacity,void 0===this.Kr&&(this.Kr=0),void 0===this.s0&&(this.s0=[p.EXTENT_LAYER,p.FACILITY_LAYER,p.LABEL_LAYER,p.MODEL_LAYER,p.EXTERNAL_MODEL_LAYER]),this.r0=t.showRegion,void 0===this.r0&&(this.r0="inside"),this.hr=null,this.st=null,this.n0=[],this.a0=[],this.mi=null,this.h0=null,this.V=this.V.bind(this),this.o0=this.o0.bind(this),this.l0=this.l0.bind(this)}get points(){return this.Id}set points(t){this.Qd=void 0,this.Id=t,this.remove(),this.addTo(this.hr)}get opacity(){return this.Kr}set opacity(t){this.Kr=t,this.remove(),this.addTo(this.hr)}get polygons(){return this.Qd}set polygons(t){this.Qd=t,this.remove(),this.addTo(this.hr)}get types(){return this.s0}get showRegion(){return this.r0}set showRegion(t){this.r0=t,this.remove(),this.addTo(this.hr)}addTo(t){if(this.hr=t,(this.hr.Sr=this).h0=this.hr.parent.buildingID,this.st=t.parent.parent,void 0!==this.Qd)for(let t=0;t<this.Qd.length;t++){this.t0.push(this.Qd[t].points);var e=this.Qd[t].holes;if(void 0!==e)for(let t=0;t<e.length;t++)this.e0.push(e[t])}else this.t0.push(this.Id);this.st.Wt.nt.Gt(this.h0).loaded?(t=this.hr.getLayers(p.EXTENT_LAYER)[0],this.mi=t.bound,this.Bu()):this.st.on("update",this.V)}remove(){this.t0.length=0,this.e0.length=0,this.hr.Sr=null;for(let e=0;e<this.s0.length;e++){var i,s=this.hr.getLayers(this.s0[e])[0];for(let t=0;t<s.children.length;t++)""+this.s0[e]==""+p.FACILITY_LAYER||""+this.s0[e]==""+p.LABEL_LAYER?(s.children[t].visible=!0,this.u0(s.children[t],!1)):""+this.s0[e]!=""+p.EXTENT_LAYER&&""+this.s0[e]!=""+p.MODEL_LAYER&&""+this.s0[e]!=""+p.EXTERNAL_MODEL_LAYER||(s.children[t].c0=!1,s.children[t].f0=[],s.children[t].d0=[],s.children[t].m0=0,s.children[t].g0=void 0,s.children[t]._0=void 0,s.children[t].w0=null,s.children[t].M0=null,s.children[t].y0=null,s.children[t].Zs&&(""+this.s0[e]==""+p.MODEL_LAYER||""+this.s0[e]==""+p.EXTENT_LAYER?(i=s.children[t].E0(this.st.Wt.pl),s.children[t].Zs.material.dispose(),s.children[t].Zs.material=i,""+this.s0[e]==""+p.MODEL_LAYER&&(this.x0(s.children[t]),this.b0(s.children[t]))):s.children[t].Pr()))}this.S0(this.st.Wt.pl.Ol),this.S0(this.st.Wt.pl.Ul),this.st.enableUpdateNode(),0<this.n0.length&&(this.n0.length=0,this.st.off("update",this.o0)),0<this.a0.length&&(this.a0.length=0,this.st.off("update",this.a0))}}function U3(t){Object.assign(t.prototype,{A0(t){var t=this.map.getBuilding(t);return null===t?-1:(t=t.bounds,Math.sqrt((t.maxX-t.minX)*(t.maxX-t.minX)+(t.maxY-t.minY)*(t.maxY-t.minY)))},T0(t){t=this.st.getBuilding(t.bid);let e=!0;this.Qa(t)&&(this.Gf(t),e=!1),t.Of&&(t.Of.show=e),this.Vt(),this.st.enableUpdateNode()},R0(e){e=this.st.getBuilding(e.bid);if(e.Pf&&null===this.L0){var i=this.C0(e);this.L0=new O3({polygons:i,showRegion:"outside"}),e.Df=this.L0;let t=e.Nf[1];1===e.visibleLevels.length&&(t=e.level),this.L0.childMapBid=e.buildingID,this.L0.childMapLevel=t,this.L0.addTo(this.st.getFloor(e.Nf[0]))}},C0(t){let e=t.Nf[1];1===t.visibleLevels.length&&(e=t.level);var i=t.getFloor(e).getLayers(p.EXTENT_LAYER)[0],s=[];if(i)for(let t=0;t<i.children.length;t++){var r=i.children[t].N0;s.push({points:r})}return s},qf(t){if(this.Qa(t))return!1;{t=t.getFloor(t.level);if(!t)return!0;t=t.getLayers(p.EXTENT_LAYER)[0];if(null==t)return!0;let e=!1;return t&&t.traverse(t=>{e=!D3.isContain(t.coordinates[0],this.st.I0())}),!!e}},Qa(t){return!1!==t.visible&&(t.overviewMode===l3.INDOOR||(t.overviewMode!==l3.OUTDOOR||this.nt.bs===t.buildingID)&&(this.nt.bs!==this.st.Ls.buildingID?this.nt.bs===t.Ht:t===this.st.jt||!!this.st.P0(t)&&!!this.st.D0()))},xd(t){var e=new C3({bid:this.Ls.buildingID,mid:this.Ls.mapID,height:t.height,scaleLevel:t.scaleLevel,name:t.mname,levels:t.levels,x:t.x,y:t.y,groundLevel:this.Ls.groundLevel,bounds:new rr(new Gt(t.minX,t.minY),new Gt(t.maxX,t.maxY))});return this.st.lt(e),this.st.jt=e,this.st.t=t.x,this.st.o=t.y,e},Ad(i){var e=this.nt.Gt(i.bid);if(!e.visibleLevels||0===e.visibleLevels.length){var s=[];for(let e=0;e<i.levelChart.length;e+=2)for(let t=0;t<this.st.jt.visibleLevels.length;t++)i.levelChart[e]===this.st.jt.visibleLevels[t]&&s.push(i.levelChart[e+1]);e.visibleLevels=s}if(void 0===e.level)for(let t=0;t<i.levelChart.length;t+=2)i.levelChart[t]===this.st.jt.level&&(e.level=i.levelChart[t+1]);var r=new Map;if(i.floors)for(let t=0;t<i.floors.length;t++){var n=i.floors[t].Ti,a=i.floors[t].gid;r.set(a,n)}var t=new A3(i);return e.minLevel&&(t.Lf=e.minLevel),e.maxLevel&&(t.Cf=e.maxLevel),t.Sf=e.overviewMode,t.O0=r,t.Pf=e.isExcavate,t.yr=e.groundLevel,this.st.lt(t),t},ld(e){var t=this.st.getBuildings().find(t=>String(t.bcode)===String(e));return t?t.buildingID:null}}),Object.assign(t.prototype,{U0(){this.st.traverse(t=>{t.traverse(t=>{t=t.getLayers(p.LABEL_LAYER)[0];t&&t.traverse(t=>{this.nt.F0===L3.FID?t.text=t.qs.fid:this.nt.F0===L3.ENAME?t.text=t.qs.ename:t.text=t.qs.name})})})},B0(t){let e=0;return e=this.st.ct.isPerspectiveCamera?t/(this.st.bt.renderer.domElement.clientHeight/(2*Math.tan(this.st.ct.fov*u.DEG2RAD/2))):t*Math.abs(this.st.ct.top-this.st.ct.bottom)/this.st.ct.zoom/this.st.bt.renderer.domElement.clientHeight,e=isNaN(e)?1:e},k0(t,e){var i;return this.st.ct.isPerspectiveCamera?(i=new Ht,t.updateMatrixWorld(),this.st.Ps.updateMatrixWorld(),i.multiplyMatrices(this.st.Ps.matrixWorldInverse,t.matrixWorld),t=(new Gt).applyMatrix4(i),this.B0(e)*Math.abs(t.z)):this.B0(e)}}),Object.assign(t.prototype,{G0(t){null!==this.H0&&(clearTimeout(this.H0),this.H0=null),this.H0=setTimeout(()=>{this.V0({changeScopeTypes:t.changeScopeTypes,fids:t.fids,succCallback:t.succCallback})},t.time||0)},V0(t={}){let{changeScopeTypes:e,fids:i}=t,s=(e=e||[p.EXTENT,p.MODEL,p.LABEL,p.FACILITY,p.EXTERNAL_MODEL],i=i||[],[]),r=()=>{if(s.length<=0)this.st.off("update",r),t.succCallback&&t.succCallback();else{let e=0;for(let t=0;t<s.length&&!(20<++e);t++)s[t].z0(this,this.dd),s.splice(t,1),t--;this.st.enableUpdateRender()}};this.st.off("update",r),this.st.traverse(t=>{t.traverse(t=>{t.parent.visibleLevels.includes(t.level)&&t.traverse(t=>{t.traverse(t=>{(!(0<i.length)||i.includes(t.FID))&&e.includes(t.type)&&t.visible&&t.z0&&t.Zs&&s.push(t)})})})}),this.st.on("update",r)},W0(t,e){t.Zs&&((!t.Of||t.Of.visible)&&t.Qs?t.Zs.visible=t.qs.maxlevel&&e>=t.qs.minlevel&&e<t.qs.maxlevel:t.Zs.visible=!1)},j0(){this.Zu.set(this.Ls.buildingID,{theme:new zm});let e=this.nt.Gt(this.Ls.buildingID);e.themeNeedLoad=!0,e.themeLoaded=!1,this.nc({bid:this.Ls.buildingID,themeID:this.Ls.themeID,theme:this.Ls.X0,themeExtension:this.Ls.themeExtension}).then(()=>{var t;this.Ls.tile?((t=Object.assign({},this.Ls,{level:e.level,visibleLevels:e.visibleLevels})).bid=t.buildingID,this.gd(t)):this.wd(this.Ls)})},Oa(r=!1,t){if(this.nt.Y0&&this.Z0&&(nt.environment!==I.WX||1!=this.st.bt.Ns||this.st.bt.ha%2==0)){this.Ua=[];var n=t||this.st.getZoom(),e=this.Ls.tile&&!this.Ls.preLoad;for(let s=0;s<this.st.Ft.length;s++){var a=this.st.Ft[s],h=this.qf(a),o=(e=>{var i=[],t=e.getFloor(e.level),s=(t&&i.push(t),e.visibleLevels);for(let t=0;t<s.length;t++)s[t]!==e.level&&e.getFloor(s[t])&&i.push(e.getFloor(s[t]));var r=e.Ft;for(let t=0;t<r.length;t++)s.indexOf(r[t].level)<0&&i.push(r[t]);return i})(a);for(let t=0;t<o.length;t++){var l=o[t];let i=null;var u=-1<a.visibleLevels.indexOf(l.level),c=(a.isGroundLevel?void 0!==a.yr&&a.visibleLevels.length<=2?(0!==a.floorSpace&&(a.Er=a.floorSpace,a.floorSpace=0),l.level===a.yr&&l.q0(a.getFloor(a.level))):void 0!==a.yr&&2<a.visibleLevels.length&&(null!==a.Er&&(a.floorSpace=a.Er,a.Er=null),l.level===a.yr)&&l.q0():void 0!==a.yr&&l.level===a.yr&&(a.visibleLevels.length<=2&&0!==a.floorSpace&&(a.Er=a.floorSpace,a.floorSpace=0),l.q0()),u&&!h&&(i=this.K0(a,l.level),0===this.td(l))&&this.ed(l)&&(l.sd(),this.rd(l),this.Vt()),[]);for(let t=0;t<l.Ft.length;t++){var f=l.Ft[t];if(!u||h&&e)this.J0(f)&&e&&c.push(f);else for(let e=0;e<f.Ft.length;e++){var d=f.Ft[e];let t=!0;h||!d.visible||d.Of&&!d.Of.visible?t=!1:d.qs&&d.qs.maxlevel&&(n>=d.qs.maxlevel||n<d.qs.minlevel)?((t=!1)===d.canDispose&&(t=!0),d.type===p.EXTERNAL_MODEL&&(d.Kf=-3)):this.$0(d,i)||!0===r||(t=!1),!d.Zs&&t&&this.Ua.push([s,d]),d.initTargetShow=t,!d.Zs||t||d.fading||d.ja||d.Q0&&d.Q0(),d.ja&&d.Ya(1)}}for(let t=0;t<c.length;t++)l.remove(c[t]),c[t].dispose()}}this.nt.Y0=!1,this.st.enableUpdateRender()}},J0(t){var e=p.EXTENT_LAYER|p.FACILITY_LAYER|p.LABEL_LAYER|p.MODEL_LAYER|p.EXTERNAL_MODEL_LAYER;return 0!=(t.Ai&e)},Fa(){if(0<this.Ua.length){let e=!1,i=0;for(let t=0;t<this.Ua.length&&!(20<++i);t++){var s=this.Ua[t][1];s.Ai!==p.FACILITY&&s.Ai!==p.LABEL||(e=!0),s.Bu(),this.Ua.splice(t,1),t--}e&&this.Za(),this.mf(),this.st.enableUpdateRender(),this.nt.qa&&0===this.Ua.length&&!this.tv&&(this.st.Yt.Xt({type:"firstViewLoaded"}),this.tv=!0)}!this.tv&&this.nt.qa&&0===this.Ua.length&&(this.st.Yt.Xt({type:"firstViewLoaded"}),this.tv=!0)},ev(t,e){var{typeID:e,FID:i}=e,t=this.st.getMapOptions().hideList[t];if(void 0===t)return!0;let s=t.typeIDs,r=t.FIDs;return void 0===s&&(s=[]),void 0===r&&(r=[]),!s.includes(e)&&!r.includes(i)},rd(t){t.P.Ht===this.Ls.buildingID&&t.traverse(t=>{t.type!==p.MODEL_LAYER&&t.type!==p.EXTERNAL_MODEL_LAYER&&t.type!==p.LABEL_LAYER||t.traverse(i=>{this.st.traverse(e=>{if(e!==this.st.jt)for(let t=0;t<e.If.length;t++)e.If[t]===i.FID&&(e.Of.setFacadeNode(i),i.iv(e.Ht),i.Of=e.Of)})})})}})}Object.assign(O3.prototype,{Bu(){var e=this.hr.getLayers();for(let t=0;t<e.length;t++)this.Jr(e[t].type)&&this.sv(e[t].children,e[t].type)},Ar(){var e=this.hr.getLayers();for(let t=0;t<e.length;t++)this.Jr(e[t].type)&&this.rv(e[t].children,e[t].type)},S0(e){var i,t,s=[];for([i,t]of e){var r=i.split(",");for(let t=0;t<r.length;t++)if(r[t]===this.$d){s.push(i);break}}for(let t=0;t<s.length;t++)e.get(s[t]).dispose(),e.delete(s[t])},Jr(e){let i=!1;for(let t=0;t<this.s0.length;t++)if(""+e==""+this.s0[t]){i=!0;break}return i},$r(t){if(0<this.Kr)return!0;let e=!this.Se(t);return e||0<this.i0&&(t.height<this.Jt||t.height>this.Jt+this.i0)&&(e=!0),e="inside"===this.r0?!e:e},Se(e){let i=!1;for(let t=0;t<this.t0.length;t++)if(G.Se(e,this.t0[t],this.t0[t].length)){i=!0;break}if(i)for(let t=0;t<this.e0.length;t++)if(G.Se(e,this.e0[t],this.e0[t].length)){i=!1;break}return i},nv(t,e){var i=[];let s=this.mi.center.x-this.st.x,r=this.st.y-this.mi.center.y,n=null;n=t.type===p.MODEL||t.type===p.EXTENT?t.qs:{Ti:[[{x:(t=t.getBound()).minX,y:t.minY},{x:t.minX,y:t.maxY},{x:t.maxX,y:t.maxY},{x:t.maxX,y:t.minY},{x:t.minX,y:t.minY}]]};for(let t=0;t<e.length;t++)if(1===this.wi(n,e[t])){var a=e[t];for(let t=0;t<a.length;t++){var h=(a[t].x-this.st.x-(s-this.mi.size.x/2))/this.mi.size.x,o=(this.st.y-a[t].y-(r-this.mi.size.y/2))/this.mi.size.y;i.push(new ct(h,o))}i.push(new ct(222222222.22222,222222222.22222))}else if(2===this.wi(n,e[t])){i.push(new ct(222222222.22222,222222222.22222)),i.push(new ct(222222222.22222,222222222.22222));break}return 0===i.length&&i.push(new ct(222222222.22222,222222222.22222)),i},wi(t,s){var e=new sa,i=(e.expandByCoords(t.Ti[0]),new sa);if(i.expandByCoords(s),G.Me(i.min,i.fi,e.min,e.max)){var r=t.Ti[0];let e=!0;for(let t=0;t<r.length;t++)if(!G.Se(r[t],s,s.length)){e=!1;break}if(e)return 2;for(let t=0;t<r.length;t++)if(G.Se(r[t],s,s.length))return 1;for(let t=0;t<s.length;t++)if(G.Se(s[t],r,r.length))return 1;var n=s.length-1;for(let t=0;t<=n;t++){let e=null,i=null;i=t===n?(e=s[0],s[t]):(e=s[t],s[t+1]);for(let t=0;t<r.length-1;t++){var a=r[t],h=r[t+1];if(G.ye(e,i,a,h))return 1}}}return 0},rv(i,t){if(t===p.MODEL_LAYER||t===p.EXTENT_LAYER){for(let e=0;e<i.length;e++)if(i[e].av=this.hr.height,i[e].Zs)if(i[e].Zs.material.maskNodeHeight=this.hr.height,t===p.MODEL_LAYER){i[e].Rf.material.maskNodeHeight=this.hr.height;var s=i[e].Rf.children;for(let t=0;t<i[e].Rf.children.length;t++)s[t].material.maskNodeHeight=this.hr.height;null!==i[e].en.top&&(i[e].en.top.material.maskNodeHeight=this.hr.height)}}else if(t===p.EXTERNAL_MODEL_LAYER)for(let t=0;t<i.length;t++)i[t].av=this.hr.height,i[t].Zs&&i[t].Zs.traverse(t=>{"Mesh"!==t.type&&"SkinnedMesh"!==t.type||(t.material.maskNodeHeight=this.hr.height)})},sv(i,e){if(e===p.FACILITY_LAYER||e===p.LABEL_LAYER)for(let e=0;e<i.length;e++){let t=this.Se({x:i[e].x,y:i[e].y});"inside"===this.r0&&(t=!t),this.u0(i[e],t)}else if(e===p.MODEL_LAYER||e===p.EXTENT_LAYER){for(let t=0;t<i.length;t++){var s;i[t].c0=!0,i[t].f0=this.nv(i[t],this.t0),i[t].d0=this.nv(i[t],this.e0),i[t].m0=0,i[t].g0=this.Jt,i[t]._0=this.i0,i[t].w0=new ct(this.mi.center.x-this.st.x,this.st.y-this.mi.center.y),i[t].M0=new ct(this.mi.size.x,this.mi.size.y),i[t].$d=this.$d,i[t].y0=this.Kr,i[t].av=this.hr.height,"outside"===this.r0&&(i[t].m0=1),i[t].Zs&&(s=i[t].E0(this.st.Wt.pl),i[t].Zs.material.dispose(),i[t].Zs.material=s,e===p.MODEL_LAYER)&&(this.x0(i[t]),this.b0(i[t]))}this.st.enableUpdateNode()}else if(e===p.EXTERNAL_MODEL_LAYER)for(let t=0;t<i.length;t++)i[t].Zs?this.hv(i[t]):this.a0.push(i[t]);0<this.n0.length&&this.st.on("update",this.o0),0<this.a0.length&&this.st.on("update",this.l0)},hv(t){t.c0=!0,t.f0=this.nv(t,this.t0),t.d0=this.nv(t,this.e0),t.m0=0,t.g0=this.Jt,t._0=this.i0,t.w0=new ct(this.mi.center.x-this.st.x,this.st.y-this.mi.center.y),t.M0=new ct(this.mi.size.x,this.mi.size.y),t.$d=this.$d,t.y0=this.Kr,t.av=this.hr.height,"outside"===this.r0&&(t.m0=1),t.Pr()},b0(t){var e;null!==t.en.top&&(e=t.ov(this.st,t.lv),t.en.top.material.dispose(),t.en.top.material=e)},x0(e){if(null!==e.Rf){var i=e.cv(this.st.Wt.pl);e.Rf.material.dispose(),e.Rf.material=i;for(let t=0;t<e.Rf.children.length;t++)e.Rf.children[t].material.dispose(),e.Rf.children[t].material=i}},u0(t,e){(t.c0=e)&&0<this.i0&&(t.height<this.Jt||t.height>this.Jt+this.i0)&&(t.c0=!1),t.c0&&0===this.Kr?t.visible=!1:(t.m0=0,t.g0=this.Jt,t._0=this.i0,t.y0=this.Kr,"outside"===this.r0&&(t.m0=1),t.Zs?t.Pr():t.type===p.LABEL&&this.n0.push(t))},V(){var t;this.st.Wt.nt.Gt(this.h0).loaded&&(t=this.hr.getLayers(p.EXTENT_LAYER)[0],this.mi=t.bound,this.Bu(),this.st.off("update",this.V))},o0(){let e=0;for(let t=0;t<this.n0.length;t++)this.n0[t].isMeskUpdate?e++:this.n0[t].Zs&&(this.n0[t].Pr(),this.n0[t].isMeskUpdate=!0);e===this.n0.length&&(this.n0.length=0,this.st.off("update",this.o0))},l0(){let e=0;for(let t=0;t<this.a0.length;t++)this.a0[t].c0?e++:this.a0[t].Zs&&(this.hv(this.a0[t]),this.a0[t].c0=!0);e===this.a0.length&&(this.a0.length=0,this.st.off("update",this.l0))}});class F3 extends Js{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new Ps,this.environmentIntensity=1,this.environmentRotation=new Ps,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(t,e){return super.copy(t,e),null!==t.background&&(this.background=t.background.clone()),null!==t.environment&&(this.environment=t.environment.clone()),null!==t.fog&&(this.fog=t.fog.clone()),this.backgroundBlurriness=t.backgroundBlurriness,this.backgroundIntensity=t.backgroundIntensity,this.backgroundRotation.copy(t.backgroundRotation),this.environmentIntensity=t.environmentIntensity,this.environmentRotation.copy(t.environmentRotation),null!==t.overrideMaterial&&(this.overrideMaterial=t.overrideMaterial.clone()),this.matrixAutoUpdate=t.matrixAutoUpdate,this}toJSON(t){t=super.toJSON(t);return null!==this.fog&&(t.object.fog=this.fog.toJSON()),0<this.backgroundBlurriness&&(t.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(t.object.backgroundIntensity=this.backgroundIntensity),t.object.backgroundRotation=this.backgroundRotation.toArray(),1!==this.environmentIntensity&&(t.object.environmentIntensity=this.environmentIntensity),t.object.environmentRotation=this.environmentRotation.toArray(),t}}function B3(i,t){var s=void 0!==(t=t||{}).duration?t.duration:1,r=void 0!==t.size?t.size:8;let n=t.times||void 0,a=void 0!==t.delay?t.delay:0,h=1,o=i.ur(E);if(o){let e;return i.As.has("boost")?((e=i.As.get("boost")).stop(),o.ot.ht(e)):(e=new an({src:[i.Ia],dest:[r]}),i.As.set("boost",e)),e.K(s).X().J(t=>{i.Zs&&o.bt.Na(i.Zs,t.destination[0]),o.enableUpdateRender()}).$(()=>{if(!(h>n)){let t=a;0<h%1&&(t=0),e.tt().et(t).X(),o.enableUpdateRender(),h+=.5}}),o.ot.lt(e),e}}function k3(t){var e=t.ur(E),i=t.As.get("boost");i&&e&&(e.ot.ht(i),t.As.delete("boost"),t.Zs&&e.bt.Na(t.Zs,t.Ia),e.enableUpdateRender())}function G3(r,n){let a=r.ur(E);if(a){var h=void 0!==n.duration?n.duration:1;let t=void 0!==n.times?n.times:1/0,e=void 0!==n.delay?n.delay:0,i=(0===t&&(t=1/0),0),s;return r.As.has("jump")?((s=r.As.get("jump")).Y([r.Jt]),s.Z([r.Jt+n.height])):(s=new an({src:[r.Jt],dest:[r.Jt+n.height]}),r.As.set("jump",s),a.ot.lt(s)),s.K(h).et(0).J(t=>{r.Zs&&(r.Zs.position.y=t.destination[0]),a.enableUpdateRender()}).$(()=>{if((i+=.5)<t){let t=e;i%1==0&&(t=0),s.tt().et(t),s.X()}}),s.X(),s}}function H3(t){var e,i;t.Zs&&(e=t.ur(E))&&((i=t.As.get("jump"))&&(e.ot.ht(i),t.As.delete("jump")),t.Zs.position.y=t.Jt,e.enableUpdateRender())}function V3(e,i){if(i.Zs){e=e.B0(i.size||i.Ia);let t=1;i.Zs.material.userData.scaleRatio&&(t=i.Zs.material.userData.scaleRatio),i.Zs.scale.set(e,e/t,e)}}function z3(e){return!0===e.needUpdateBound&&(e.mi.reset(),e.Ft.forEach(t=>{e.mi.expand(t.bound)}),e.needUpdateBound=!1),e.mi.clone()}class W3 extends sh{constructor(){super(),this.xa=new F3,this.nr=!0}get scene(){return this.xa}get bound(){return z3(this)}get isLayer(){return!0}get visible(){return super.visible}set visible(t){(super.visible=t)?this.xa.parent||this.parent.effectScene.add(this.xa):this.xa.parent&&this.parent.effectScene.remove(this.xa)}init(){this.xa.position.y=this.parent.Jt}}class j3 extends W3{constructor(t){super(),this.fv=[],void 0!==t&&void 0!==t.type&&(this.Ai=t.type)}getMarkers(){return this.Ft}add(t){t.P=this,t.dv||t.Bu()?this.hh(t):this.fv.push(t),this.needUpdateBound=!0}remove(t){this.vv(t),t.dispose();var e=this.Ft.indexOf(t),e=(-1<e&&this.Ft.splice(e,1),this.fv.indexOf(t));-1<e&&this.fv.splice(e,1),this.needUpdateBound=!0}clear(){for(var t of this.Ft)this.vv(t),t.dispose();this.Ft.length=0}traverse(t){for(var e of this.Ft)t&&t(e)}dispose(){for(var t of this.Ft)this.vv(t),t.dispose();this.Ft.length=0,this.xa=void 0}}Object.assign(j3.prototype,{pv(){for(var t of this.fv){var e;t.Bu()&&(-1<(e=this.fv.indexOf(t))&&this.fv.splice(e,1),this.hh(t))}},hh(t){this.Ft.push(t),t.Zs&&this.xa.add(t.Zs)},vv(t){t.P=void 0,this.xa.remove(t.Zs)}});class X3 extends j3{constructor(){super(),this.Ai=p.IMAGE_MARKER,this.Xa=!0}get collision(){return this.Xa}}class Y3 extends j3{constructor(){super(),this.Ai=p.TEXT_MARKER,this.isHasText=!0,this.Xa=!0}get collision(){return this.Xa}}class Z3 extends j3{constructor(){super(),this.Ai=p.POLYGON_MARKER}}class q3 extends wg{constructor(t,e){super(t,e),this.isAmbientLight=!0,this.type="AmbientLight"}}class K3{constructor(t){this.st=t,this.mv=null,this.gv=null,this._v=null,this.wv=null,this.createLight=this.createLight.bind(this)}createLight(t,e){var i=this.st.getMapOptions(),s=i.lockedLight,i=i.lightConfig[e];return t.Mv=new q3(i[1].color,i[1].intensity),t.Ki=new Js,t.yv=new Sg(i[0].color,i[0].intensity),t.yv.position.set(i[0].position.x,i[0].position.y,i[0].position.z),t.yv.target=t.Ki,t.Ev=new Sg(i[2].color,i[2].intensity),t.Ev.position.set(i[2].position.x,i[2].position.y,i[2].position.z),t.Ev.target=t.Ki,this.mv=t,this.gv=e,s&&(this.xv=this.xv.bind(this),this.st.on("viewChanged",this.xv)),this}createLightByTheme(t,e,i){return t.Mv=new q3(new Wt("rgb("+i[1].color+")"),i[1].intensity),t.yv=new Sg(new Wt("rgb("+i[0].color+")"),i[0].intensity),t.yv.position.set(i[0].position.x,i[0].position.y,i[0].position.z),t.Ki=new Js,t.Ki.position.set(i[0].target.x,i[0].target.y,i[0].target.z),t.yv.target=t.Ki,t.Ev=new Sg(new Wt("rgb("+i[2].color+")"),i[2].intensity),t.Ev.position.set(i[2].position.x,i[2].position.y,i[2].position.z),t.bv=new Js,t.bv.position.set(i[2].target.x,i[2].target.y,i[2].target.z),t.Ev.target=t.bv,this.mv=t,this.gv=e,this}}Object.assign(K3.prototype,{Sv(t){var e=new ma;return e.setFromVector3(t),e.theta},Av(t,e){var i=new ma,e=(i.setFromVector3(t),i.theta=e,new Gt);e.setFromSpherical(i),t.copy(e)},xv(){var t,e,i;this.mv&&(t=this.Sv(this.st.camera.position),null===this._v&&(e=this.Sv(this.mv.yv.position),i=this.Sv(this.mv.Ev.position),this._v=e-t,this.wv=i-t),e=t+this._v,this.Av(this.mv.yv.position,e),i=t+this.wv,this.Av(this.mv.Ev.position,i))},Qt(){var t=this.st.getMapOptions().lockedLight;t&&this.st.off("viewChanged",this.xv)}});class J3 extends j3{constructor(){super(),this.Ai=p.EXTRUDE_MARKER}init(){super.init(),this.Tv(),this.Rv()}}Object.assign(J3.prototype,{Tv(){var t=this.ur(E);this.Lv=new K3(t).createLight(this,"FMModelLayer")},Rv(){this.xa.add(this.yv),this.xa.add(this.Mv),this.xa.add(this.Ev),this.xa.add(this.Ki),this.xa.removeLight=()=>{this.Cv()}},Cv(){this.xa.remove(this.yv),this.xa.remove(this.Mv),this.xa.remove(this.Ev),this.Lv.Qt()}});class $3 extends j3{constructor(){super(),this.Ai=p.HEAT_MAP_MARKER,this.Nv=!1,this.Iv=this.Iv.bind(this)}add(t){super.add(t),t.dv&&!t.Pv&&this.Dv(t.Ov,t),0<this.fv.length&&this.ur(E).on("update",this.Iv)}remove(t){super.remove(t),this.Nv&&this.Dv(null,t)}}function Q3(t,e,i){i.Zs=new L(t,e),(i.Zs.mapNode=i).Zs.rotation.set(-Math.PI/2,0,0,"XYZ")}function tM(e){let i=e.ur(E);i.Ls.hdr&&i.Ls.hdr.load(i,t=>{e.xa.environment=t,i.enableUpdateRender()})}function eM(t,e,i){var s=new Ph(200,200,1,1),r=new ro({color:"#38382f",side:2}),s=new L(s,r);return void 0!==t&&(s.rotation.y=t),s.position.set(e.x,e.y,e.z),i.parent.xa.add(s),s}Object.assign($3.prototype,{pv(){for(var t of this.fv){var e;t.Bu()&&(-1<(e=this.fv.indexOf(t))&&this.fv.splice(e,1),this.hh(t),t.Pv||this.Dv(t.Ov,t),t.needUpdateBound=!0)}},Dv(i,t){var e=this.ur(v);let s=this.ur(E),r=t.Uv;var n,a,h=e.getLayers(p.EXTENT_LAYER)[0].children;if(null!==i)for(let t=0;t<h.length;t++)h[t].Fv=!0,h[t].Bv=new ct(r.center.x-s.x,s.y-r.center.y),h[t].kv=new ct(r.size.x,r.size.y),h[t].Gv=i,h[t].Zs&&((n=h[t].Zs.material.clone()).map=i,n.mapMixColor=!0,n.heatCenter=new ct(r.center.x-s.x,s.y-r.center.y),n.heatSize=new ct(r.size.x,r.size.y),n.needsUpdate=!0,h[t].Zs.material.dispose(),h[t].Zs.material=n);else for(let t=0;t<h.length;t++)h[t].Fv=!1,h[t].Bv=null,h[t].kv=null,h[t].Gv=null,h[t].Zs&&(a=e.parent.buildingID,a=h[t].E0(s,a,h[t]),h[t].Zs.material.dispose(),h[t].Zs.material=a);e.getModelMeshs(r).forEach(function(t){var e;t&&(i?(t.Fv=!0,t.Bv=new ct(r.center.x-s.x,s.y-r.center.y),t.kv=new ct(r.size.x,r.size.y),t.Gv=i):(t.Fv=!1,t.Bv=null,t.kv=null,t.Gv=null),e=t.Zs)&&(t=t.E0(),e.material.dispose(),e.material=t)}),this.Nv=!0},Iv(){this.pv(),0===this.fv.length&&this.ur(E).off("update",this.Iv)}});class iM extends j3{constructor(){super(),this.scene.name="dynamicModel",this.Ai=p.DYNAMIC_MODEL_MARKER}init(){super.init(),this.Tv(),this.Rv(),tM(this)}remove(e){var t;e.Hv?e.Vv({src:[1],dest:[0],duration:1,callback:()=>{var t=e.Zs?.parent;t&&t.remove(e.Zs),super.remove(e)}}):((t=e.Zs?.parent)&&t.remove(e.Zs),super.remove(e))}}Object.assign(iM.prototype,{Tv(){var t=this.ur(E);this.Lv=new K3(t).createLight(this,"FMDynamicModelLayer")},Rv(){this.xa.add(this.yv),this.xa.add(this.Mv),this.xa.add(this.Ev),this.xa.add(this.Ki),this.xa.removeLight=()=>{this.Cv()}},Cv(){this.xa.remove(this.yv),this.xa.remove(this.Mv),this.xa.remove(this.Ev),this.Lv.Qt()}});class sM extends j3{constructor(){super(),this.Ai=p.LINE_MARKER}getBelongedBuildingID(){}init(){super.init(),this.xa.position.y=0}}class rM extends j3{constructor(){super(),this.Ai=p.LOCATION_MARKER}init(){super.init(),this.xa.position.y=0}}class nM extends j3{constructor(){super(),this.Ai=p.DOM_MARKER}init(){}add(t){this.Ft.push(t),this.needUpdateBound=!0}remove(t){t=this.Ft.indexOf(t);-1<t&&this.Ft.splice(t,1),this.needUpdateBound=!0}clear(){for(;0<this.Ft.length;)this.Ft[0].dispose();this.Ft.length=0,this.needUpdateBound=!0}dispose(){this.Ft.length=0,this.xa=void 0}get visible(){return this.Qs}set visible(e){for(let t=0;t<this.Ft.length;t++)this.Ft[t].visible=e}}function aM(t){var e=t.ur(E);e&&(t.Zs&&e.Wt.Za(),e.enableUpdateNode(),e.enableUpdateRender())}function hM(t){var e,i=t.ur(E);i&&(t.Zs&&(e=i.getZoom(),i.Wt.W0(t,e)),i.enableUpdateNode(),i.enableUpdateRender())}function oM(t){t.zv&&t.zv(),t.Zs&&(t.Zs.parent&&t.Zs.parent.remove(t.Zs),t.Zs instanceof L0?t.Zs.children.forEach(t=>{t.geometry&&t.geometry.dispose(),t.geometry=void 0,t.material=void 0,t.mapNode=void 0}):(t.Zs.geometry.dispose(),t.Zs.geometry=void 0,t.Zs.material=void 0,t.Zs.mapNode=void 0),t.Zs=void 0)}class lM extends sh{constructor(t){super(t),this.Wv=void 0,this.c0=!1,this.f0=[],this.d0=[],this.m0=0,this.g0=void 0,this._0=void 0,this.w0=null,this.M0=null,this.$d=null,this.y0=null,this.av=0,this.ar=!0}get isbloom(){return this.Wv}set isbloom(t){this.Wv=t}get ID(){return this.qs.Ht}get level(){return this.P.P.Tr}get x(){return this.bound.center.x}get y(){return this.bound.center.y}get height(){return this.qs.height}get bound(){return!0===this.tr&&(this.qs.mi=null,this.mi=this.qs.getBound(),this.tr=!1),this.mi.clone()}get boundNoClone(){return 1==this.tr&&(this.qs.mi=null,this.mi=this.qs.getBound(),this.tr=!1),this.mi}get zoomRange(){return{maxLevel:this.qs.maxlevel,minLevel:this.qs.minlevel}}get visible(){return this.Qs}set visible(t){this.Qs=t,this.xf()}getData(){var t=this.qs;return{ID:t.Ht,typeID:t.type,FID:t.fid,height:t.height,name:t.name,eName:t.ename,minLevel:t.minlevel,maxLevel:t.maxlevel}}getBound(){var t=this.bound;return{maxY:t.max.y,maxX:t.max.x,minX:t.min.x,minY:t.min.y}}getRenderNode(){return this.Zs}dispose(){this.Q0(),this.st=null,super.dispose()}}function uM(t,e){var i=[];for(let t=0;t<e.count;t++)i.push(new Gt(e.getX(t),0,e.getY(t)));t=t*Math.PI/180;let s=(new Ht).makeRotationY(t),r=(i.forEach(t=>{var e=new Gt(t.x,t.y,t.z);e.applyMatrix4(s),t.x=e.x,t.y=e.y,t.z=e.z}),1/0),n=-1/0,a=1/0,h=-1/0;return i.forEach(t=>{r=Math.min(r,t.x),n=Math.max(n,t.x),a=Math.min(a,t.z),h=Math.max(h,t.z)}),i.map(t=>({u:(t.x-r)/(n-r),v:(t.z-a)/(h-a)}))}Object.assign(lM.prototype,{xf(){(this.Ai===p.LABEL||this.Ai===p.FACILITY?aM:hM)(this)},Q0(){oM(this)},jv(t){function e(t){let e="";if(!(t.length<=2)){var i=(t=>{let e=[],i=0;for(;i<t.length;){var s=((t,e)=>{let i=e;for(;i<t.length&&(222222222.22222!=t[i].x||222222222.22222!=t[i].y);)i++;return i})(t,i);e.push({start:i,end:s}),i=s+1}return e})(t);e=(e+="bool oddNodes = false;\n")+"vec2 p1;\n"+"vec2 p2;\n";for(let t=0;t<i.length;t++){var s=i[t].end-i[t].start;e=e+"for (int i = "+i[t].start+"; i < "+i[t].end+"; i++) {\n",e=(e+="     p1 = polygon2[i];\n")+"     p2 = polygon2[(i + 1 - "+i[t].start+") % "+s+" + "+i[t].start+"];\n",e=(e=(e=(e=(e+="     if (((p1.y < point.y && p2.y >= point.y) || (p2.y < point.y && p1.y >= point.y)) && (p1.x <= point.x || p2.x <= point.x)) {\n")+"         if (p1.x + (point.y - p1.y) / (p2.y - p1.y) * (p2.x - p1.x) < point.x) {\n"+"             oddNodes = !oddNodes;\n")+"         }\n"+"     }\n")+"}\n"+"if (oddNodes) {\n")+"     return oddNodes;\n"+"}\n"}e+="return oddNodes;\n"}return e}t.maskParam=e(t.maskPolygons),t.maskHoleParam=e(t.maskHolePogygons)}});class cM extends lM{constructor(t){super(),this.qs=t,this.Jt=t.height,this.Ai=p.EXTENT,this.X0=null,this.Xv=null,this.Zs=null,this.Yv=0,this.Zv=0,this.Fv=!1,this.Bv=null,this.kv=null,this.Gv=null,this.N0=null}get FID(){return this.qs.fid}get zoomRange(){}getData(){var t=this.qs;return{ID:t.Ht,height:t.height,area:t.area,FID:t.fid}}getArea(){return D3.area(this.qs.Ti[0])}get coordinates(){return this.qs.Ti}}Object.assign(cM.prototype,{Bu(){if(!this.Zs&&1!==this.Yv){let r=this.ur(E);if(r){let s=this.ur(rh);var t=r.Wt,e=r.nt.qv?t.Kv:t.Jv;this.Yv=1,e.bind(t)({type:this.type,data:this.qs,amount:this.Jt}).then(t=>{this.Yv=2,this.fd(t.geometry),this.$v=s===r.jt&&1!==r.children.length&&1===r.jt.Ft.length,this.Qv=s!==r.jt;var e=this.E0(r,s.Ht,this),i=(this.Qv&&(e.polygonOffset=!0,e.polygonOffsetFactor=1,e.polygonOffsetUnits=1),this.$v&&(e.stencilWrite=!0,e.stencilRef=1,e.stencilFunc=Di,e.stencilFail=Pi,e.stencilZFail=Pi,e.stencilZPass=Pi),this.qs.getBound());this.Zs=new L(t.geometry,e),this.Zs.rotation.set(-Math.PI/2,0,0,"XYZ"),this.Zs.position.set(i.center.x-r.t,-this.Jt,r.o-i.center.y),this.Zs.receiveShadow=!0,this.Zs.visible=this.Qs,(this.Zs.mapNode=this).P.xa.add(this.Zs)})}}},fd(t){var e=this.ur(E),i=this.ur(rh);this.X0=e.Wt.dd.Ku({fid:this.qs.fid??"0",typeID:this.qs.type+"",bid:i.Ht}),0===this.Zv&&(this.X0.image?this.Xv=e.Wt.zf(this.X0,"logoPath",i.buildingID)+this.X0.image:this.Xv=null,this.X0.offset&&(e=this.X0.offset.split(","),this.t1=[-parseFloat(e[0]),-parseFloat(e[1])]),this.X0.center?(i=this.X0.center.split(","),this.yi=[parseFloat(i[0]),parseFloat(i[1])]):this.yi=[.5,.5],this.X0.sizes&&(e=this.X0.sizes.split(","),this.e1=[1/parseFloat(e[0]),1/parseFloat(e[1])]),this.X0.angle)&&(i=t??this.Zs.geometry,e=uM(Number(this.X0.angle),i.attributes.position),t=new Float32Array(e.flatMap(t=>[t.u,t.v])),i.setAttribute("uv",new N(t,2)))},z0(t,e){this.Zs&&(this.fd(),this.Pr())},i1(t){t!==this.Xv&&(this.Zv=1,this.Xv=t,this.Pr())},Pr(){var t,e;this.Zs&&(t=this.ur(E))&&(e=this.ur(rh),this.Zs.material=this.E0(t,e.Ht,this),t.enableUpdateRender())},E0(t,e,i){var s=this.ur(v),e={color:this.X0.color,alpha:this.X0.alpha*s.Kr,buildingID:e,isIgnoreLighting:Jr(),stencilWrite:this.$v,polygonOffset:this.Qv};void 0!==this.ir&&(e.alpha=this.ir),this.c0&&(e.isMask=this.c0,e.maskType=this.m0,e.maskPolygons=this.f0,e.maskHolePogygons=this.d0,e.maskHeight=this.g0,e.maskExtrudeHeight=this._0,e.boundCenter=this.w0,e.boundSize=this.M0,e.level=s.level,e.maskID=this.$d,e.maskOpacity=this.y0,e.maskNodeHeight=this.av),this.Xv&&(e.url=this.Xv,e.finish=()=>{t.enableUpdateRender(),0===this.Zv&&(this.t1&&i.Zs.material.map.offset.set(this.t1[0],this.t1[1]),this.e1&&i.Zs.material.map.repeat.set(this.e1[0],this.e1[1]),this.yi&&i.Zs.material.map.center.set(this.yi[0],this.yi[1]),i.Zs.material.map.needsUpdate=!0)});let r=t.Wt.pl.Jl(e);return this.jv(r),this.Fv&&((r=r.clone()).mapMixColor=this.Fv,r.heatCenter=this.Bv,r.heatSize=this.kv,r.map=this.Gv,r.map.needsUpdate=!0),r.polygonOffset=!0,r.polygonOffsetFactor=1,r.polygonOffsetUnits=4,r.userData.opacity=r.opacity,r},xf(){var t=this.ur(E);t&&(this.Zs&&(this.Zs.visible=this.Qs),t.enableUpdateNode(),t.enableUpdateRender())},updateMaterialByThemeTool(t){this.X0=t,this.Pr()}});let fM=new rr;class dM extends Kg{constructor(t,e=16776960){var i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),s=new Float32Array(24),r=new Nh;r.setIndex(new N(i,1)),r.setAttribute("position",new N(s,3)),super(r,new wm({color:e,toneMapped:!1})),this.object=t,this.type="BoxHelper",this.matrixAutoUpdate=!1,this.update()}update(t){var e,i,s;void 0!==t&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&fM.setFromObject(this.object),fM.isEmpty()||(t=fM.min,e=fM.max,(s=(i=this.geometry.attributes.position).array)[0]=e.x,s[1]=e.y,s[2]=e.z,s[3]=t.x,s[4]=e.y,s[5]=e.z,s[6]=t.x,s[7]=t.y,s[8]=e.z,s[9]=e.x,s[10]=t.y,s[11]=e.z,s[12]=e.x,s[13]=e.y,s[14]=t.z,s[15]=t.x,s[16]=e.y,s[17]=t.z,s[18]=t.x,s[19]=t.y,s[20]=t.z,s[21]=e.x,s[22]=t.y,s[23]=t.z,i.needsUpdate=!0,this.geometry.computeBoundingSphere())}setFromObject(t){return this.object=t,this.update(),this}copy(t,e){return super.copy(t,e),this.object=t.object,this}dispose(){this.geometry.dispose(),this.material.dispose()}}class vM{constructor(t,e,i=null,s=e.blendMode){this.s1=t,this.n1=e,this.a1=i,this.blendMode=s;var r=e.tracks,n=r.length,a=new Array(n),h={endingStart:ci,endingEnd:ci};for(let t=0;t!==n;++t){var o=r[t].createInterpolant(null);(a[t]=o).settings=h}this.h1=h,this.o1=a,this.l1=new Array(n),this.u1=null,this.c1=null,this.f1=null,this.d1=null,this.loop=ai,this.m1=-1,this.g1=null,this.time=0,this.timeScale=1,this._1=1,this.weight=1,this.w1=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this.s1.M1(this),this}stop(){return this.s1.E1(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this.m1=-1,this.g1=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this.g1&&this.s1.b1(this)}isScheduled(){return this.s1.b1(this)}startAt(t){return this.g1=t,this}setLoop(t,e){return this.loop=t,this.repetitions=e,this}setEffectiveWeight(t){return this.weight=t,this.w1=this.enabled?t:0,this.stopFading()}getEffectiveWeight(){return this.w1}fadeIn(t){return this.S1(t,0,1)}fadeOut(t){return this.S1(t,1,0)}crossFadeFrom(t,e,i){var s,r;return t.fadeOut(e),this.fadeIn(e),i&&(r=(i=this.n1.duration)/(s=t.n1.duration),t.warp(1,s/i,e),this.warp(r,1,e)),this}crossFadeTo(t,e,i){return t.crossFadeFrom(this,e,i)}stopFading(){var t=this.d1;return null!==t&&(this.d1=null,this.s1.A1(t)),this}setEffectiveTimeScale(t){return this.timeScale=t,this._1=this.paused?0:t,this.stopWarping()}getEffectiveTimeScale(){return this._1}setDuration(t){return this.timeScale=this.n1.duration/t,this.stopWarping()}syncWith(t){return this.time=t.time,this.timeScale=t.timeScale,this.stopWarping()}halt(t){return this.warp(this._1,0,t)}warp(t,e,i){var s=this.s1,r=s.time,n=this.timeScale;let a=this.f1;null===a&&(a=s.T1(),this.f1=a);var s=a.parameterPositions,h=a.sampleValues;return s[0]=r,s[1]=r+i,h[0]=t/n,h[1]=e/n,this}stopWarping(){var t=this.f1;return null!==t&&(this.f1=null,this.s1.A1(t)),this}getMixer(){return this.s1}getClip(){return this.n1}getRoot(){return this.a1||this.s1.Mh}V(t,e,i,s){if(this.enabled){var r=this.g1,n=(null!==r&&(e=(r=(t-r)*i)<0||0===i?0:(this.g1=null,i*r)),e*=this.R1(t),this.L1(e)),a=this.C1(t);if(0<a){var h=this.o1,o=this.l1;if(this.blendMode===pi)for(let t=0,e=h.length;t!==e;++t)h[t].evaluate(n),o[t].accumulateAdditive(a);else{vi;for(let t=0,e=h.length;t!==e;++t)h[t].evaluate(n),o[t].accumulate(s,a)}}}else this.C1(t)}C1(t){let e=0;var i,s;return this.enabled&&(e=this.weight,null!==(i=this.d1))&&(s=i.evaluate(t)[0],e*=s,t>i.parameterPositions[1])&&(this.stopFading(),0===s)&&(this.enabled=!1),this.w1=e}R1(t){let e=0;var i,s;return this.paused||(e=this.timeScale,null!==(i=this.f1)&&(s=i.evaluate(t)[0],e*=s,t>i.parameterPositions[1])&&(this.stopWarping(),0===e?this.paused=!0:this.timeScale=e)),this._1=e}L1(t){var e=this.n1.duration,i=this.loop;let s=this.time+t,r=this.m1;var n,a=i===hi;if(0===t)return-1!==r&&a&&1==(1&r)?e-s:s;if(i===ni){-1===r&&(this.m1=0,this.N1(!0,!0,!1));t:{if(s>=e)s=e;else{if(!(s<0)){this.time=s;break t}s=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=s,this.s1.dispatchEvent({type:"finished",action:this,direction:t<0?-1:1})}}else if(-1===r&&(0<=t?(r=0,this.N1(!0,0===this.repetitions,a)):this.N1(0===this.repetitions,!0,a)),s>=e||s<0?(i=Math.floor(s/e),s-=e*i,r+=Math.abs(i),(n=this.repetitions-r)<=0?(this.clampWhenFinished?this.paused=!0:this.enabled=!1,s=0<t?e:0,this.time=s,this.s1.dispatchEvent({type:"finished",action:this,direction:0<t?1:-1})):(1==n?this.N1(n=t<0,!n,a):this.N1(!1,!1,a),this.m1=r,this.time=s,this.s1.dispatchEvent({type:"loop",action:this,loopDelta:i}))):this.time=s,a&&1==(1&r))return e-s;return s}N1(t,e,i){var s=this.h1;i?(s.endingStart=fi,s.endingEnd=fi):(s.endingStart=t?this.zeroSlopeAtStart?fi:ci:di,s.endingEnd=e?this.zeroSlopeAtEnd?fi:ci:di)}S1(t,e,i){var s=this.s1,r=s.time;let n=this.d1;null===n&&(n=s.T1(),this.d1=n);var s=n.parameterPositions,a=n.sampleValues;return s[0]=r,a[0]=e,s[1]=r+t,a[1]=i,this}}class pM{constructor(t,e,i){this.binding=t,this.valueSize=i;let s,r,n;switch(e){case"quaternion":s=this.I1,r=this.P1,n=this.D1,this.buffer=new Float64Array(6*i),this.O1=5;break;case"string":case"bool":s=this.U1,r=this.U1,n=this.F1,this.buffer=new Array(5*i);break;default:s=this.B1,r=this.H1,n=this.V1,this.buffer=new Float64Array(5*i)}this.z1=s,this.W1=r,this.j1=n,this.X1=3,this.Y1=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}accumulate(t,e){var i=this.buffer,s=this.valueSize,r=t*s+s;let n=this.cumulativeWeight;if(0===n){for(let t=0;t!==s;++t)i[r+t]=i[t];n=e}else{t=e/(n+=e);this.z1(i,r,0,t,s)}this.cumulativeWeight=n}accumulateAdditive(t){var e=this.buffer,i=this.valueSize,s=i*this.Y1;0===this.cumulativeWeightAdditive&&this.j1(),this.W1(e,s,0,t,i),this.cumulativeWeightAdditive+=t}apply(t){var e,i=this.valueSize,s=this.buffer,r=t*i+i,t=this.cumulativeWeight,n=this.cumulativeWeightAdditive,a=this.binding;this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,t<1&&(e=i*this.X1,this.z1(s,r,e,1-t,i)),0<n&&this.W1(s,r,this.Y1*i,1,i);for(let t=i,e=i+i;t!==e;++t)if(s[t]!==s[t+i]){a.setValue(s,r);break}}saveOriginalState(){var t=this.binding,i=this.buffer,s=this.valueSize,r=s*this.X1;t.getValue(i,r);for(let t=s,e=r;t!==e;++t)i[t]=i[r+t%s];this.j1(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0}restoreOriginalState(){var t=3*this.valueSize;this.binding.setValue(this.buffer,t)}V1(){var e=this.Y1*this.valueSize,i=e+this.valueSize;for(let t=e;t<i;t++)this.buffer[t]=0}D1(){this.V1(),this.buffer[this.Y1*this.valueSize+3]=1}F1(){var e=this.X1*this.valueSize,i=this.Y1*this.valueSize;for(let t=0;t<this.valueSize;t++)this.buffer[i+t]=this.buffer[e+t]}U1(e,i,s,t,r){if(.5<=t)for(let t=0;t!==r;++t)e[i+t]=e[s+t]}I1(t,e,i,s){Ms.slerpFlat(t,e,t,e,t,i,s)}P1(t,e,i,s,r){r=this.O1*r;Ms.multiplyQuaternionsFlat(t,r,t,e,t,i),Ms.slerpFlat(t,e,t,e,t,r,s)}B1(e,i,s,r,n){var a=1-r;for(let t=0;t!==n;++t){var h=i+t;e[h]=e[h]*a+e[s+t]*r}}H1(e,i,s,r,n){for(let t=0;t!==n;++t){var a=i+t;e[a]=e[a]+e[s+t]*r}}}let mM=new Float32Array(1);class gM extends Cs{constructor(t){super(),this.Mh=t,this.Z1(),this.q1=0,this.time=0,this.timeScale=1}K1(t,i){var s=t.a1||this.Mh,r=t.n1.tracks,n=r.length,a=t.l1,h=t.o1,o=s.uuid,t=this.J1;let l=t[o];void 0===l&&(l={},t[o]=l);for(let e=0;e!==n;++e){var u=r[e],c=u.name;let t=l[c];if(void 0!==t)++t.referenceCount;else{if(void 0!==(t=a[e])){null===t.u1&&(++t.referenceCount,this.Q1(t,o,c));continue}var f=i&&i.l1[e].binding.parsedPath;++(t=new pM(d.create(s,c,f),u.ValueTypeName,u.getValueSize())).referenceCount,this.Q1(t,o,c)}a[e]=t,h[e].resultBuffer=t.buffer}}M1(t){if(!this.b1(t)){null===t.u1&&(e=(t.a1||this.Mh).uuid,i=t.n1.uuid,s=this.tp[i],this.K1(t,s&&s.knownActions[0]),this.ep(t,i,e));var e,i,s,r=t.l1;for(let t=0,e=r.length;t!==e;++t){var n=r[t];0==n.useCount++&&(this.ip(n),n.saveOriginalState())}this.sp(t)}}E1(t){if(this.b1(t)){var i=t.l1;for(let t=0,e=i.length;t!==e;++t){var s=i[t];0==--s.useCount&&(s.restoreOriginalState(),this.rp(s))}this.np(t)}}Z1(){this.ap=[],this.hp=0,this.tp={},this.Lc=[],this.op=0,this.J1={},this.lp=[],this.cp=0;let t=this;this.stats={actions:{get total(){return t.ap.length},get inUse(){return t.hp}},bindings:{get total(){return t.Lc.length},get inUse(){return t.op}},controlInterpolants:{get total(){return t.lp.length},get inUse(){return t.cp}}}}b1(t){t=t.u1;return null!==t&&t<this.hp}ep(t,e,i){var s=this.ap,r=this.tp;let n=r[e];void 0===n?(n={knownActions:[t],actionByRoot:{}},t.c1=0,r[e]=n):(r=n.knownActions,t.c1=r.length,r.push(t)),t.u1=s.length,s.push(t),n.actionByRoot[i]=t}fp(t){var e=this.ap,i=e[e.length-1],s=t.u1,s=(e[i.u1=s]=i,e.pop(),t.u1=null,t.n1.uuid),i=this.tp,e=i[s],r=e.knownActions,n=r[r.length-1],a=t.c1;r[n.c1=a]=n,r.pop(),t.c1=null,delete e.actionByRoot[(t.a1||this.Mh).uuid],0===r.length&&delete i[s],this.dp(t)}dp(t){var i=t.l1;for(let t=0,e=i.length;t!==e;++t){var s=i[t];0==--s.referenceCount&&this.vp(s)}}sp(t){var e=this.ap,i=t.u1,s=this.hp++,r=e[s];e[t.u1=s]=t,e[r.u1=i]=r}np(t){var e=this.ap,i=t.u1,s=--this.hp,r=e[s];e[t.u1=s]=t,e[r.u1=i]=r}Q1(t,e,i){var s=this.J1,r=this.Lc;let n=s[e];void 0===n&&(n={},s[e]=n),(n[i]=t).u1=r.length,r.push(t)}vp(t){var e=this.Lc,i=t.binding,s=i.rootNode.uuid,i=i.path,r=this.J1,n=r[s],a=e[e.length-1],t=t.u1;e[a.u1=t]=a,e.pop(),delete n[i],0===Object.keys(n).length&&delete r[s]}ip(t){var e=this.Lc,i=t.u1,s=this.op++,r=e[s];e[t.u1=s]=t,e[r.u1=i]=r}rp(t){var e=this.Lc,i=t.u1,s=--this.op,r=e[s];e[t.u1=s]=t,e[r.u1=i]=r}T1(){var t=this.lp,e=this.cp++;let i=t[e];return void 0===i&&(t[(i=new ag(new Float32Array(2),new Float32Array(2),1,mM)).pp=e]=i),i}A1(t){var e=this.lp,i=t.pp,s=--this.cp,r=e[s];e[t.pp=s]=t,e[r.pp=i]=r}clipAction(t,e,i){var s=e||this.Mh,r=s.uuid;let n="string"==typeof t?mg.findByName(s,t):t;s=null!==n?n.uuid:t,t=this.tp[s];let a=null;if(void 0===i&&(i=null!==n?n.blendMode:vi),void 0!==t){var h=t.actionByRoot[r];if(void 0!==h&&h.blendMode===i)return h;a=t.knownActions[0],null===n&&(n=a.n1)}return null===n?null:(h=new vM(this,n,e,i),this.K1(h,a),this.ep(h,s,r),h)}existingAction(t,e){var e=e||this.Mh,i=e.uuid,e="string"==typeof t?mg.findByName(e,t):t,e=e?e.uuid:t,t=this.tp[e];return void 0!==t&&t.actionByRoot[i]||null}stopAllAction(){var e=this.ap;for(let t=this.hp-1;0<=t;--t)e[t].stop();return this}update(e){e*=this.timeScale;var i=this.ap,s=this.hp,r=this.time+=e,n=Math.sign(e),a=this.q1^=1;for(let t=0;t!==s;++t)i[t].V(r,e,n,a);var h=this.Lc,o=this.op;for(let t=0;t!==o;++t)h[t].apply(a);return this}setTime(t){for(let t=this.time=0;t<this.ap.length;t++)this.ap[t].time=0;return this.update(t)}getRoot(){return this.Mh}uncacheClip(t){var i=this.ap,t=t.uuid,e=this.tp,s=e[t];if(void 0!==s){var r=s.knownActions;for(let t=0,e=r.length;t!==e;++t){var n=r[t],a=(this.E1(n),n.u1),h=i[i.length-1];n.u1=null,n.c1=null,i[h.u1=a]=h,i.pop(),this.dp(n)}delete e[t]}}uncacheRoot(t){var e,i=t.uuid,s=this.tp;for(e in s){var r=s[e].actionByRoot[i];void 0!==r&&(this.E1(r),this.fp(r))}var n=this.J1[i];if(void 0!==n)for(var a in n){a=n[a];a.restoreOriginalState(),this.vp(a)}}uncacheAction(t,e){t=this.existingAction(t,e);null!==t&&(this.E1(t),this.fp(t))}}class _M{constructor(t,e,i,s){this.vr=e,this.mp=t,this.gp=i,this.B=i.getClip().duration,this.st=s,this._p=0,this.wp=1,this.Mp=!1,this.yp=null,this.Ep=this.Ep.bind(this)}get name(){return this.vr}get start(){return this._p}set start(t){this._p=t,this.action.playInfo&&(this.pause(),this.play(this.yp))}get end(){return this.wp}set end(t){this.wp=t,this.action.playInfo&&(this.pause(),this.play(this.yp))}get duration(){return this.B}get action(){return this.gp}get once(){return this.Mp}set once(t){this.Mp=t,this.action.playInfo&&(this.pause(),this.action.playInfo.once=t,this.action.playInfo.param>this.action.playInfo.count&&(this.action.playInfo.param=0),this.resume())}get feature(){return this.mp}play(t){null==t&&(t=this.B),this.yp=t,this.stop(),this.mp.pf=!1,this.mp.xp(),this.st.ot.Ks(this.Ep);var e=this.action,t=Math.abs((this.end-this.start)/(60*t));e.playInfo={action:e,stepLong:t,once:this.Mp,beginTime:(new Date).getTime()},this.start===this.end?this.Ep():this.st.ot.$s(this.Ep)}pause(){this.st.ot.Ks(this.Ep),this.st.enableUpdateRender()}resume(){this.action.playInfo&&void 0!==this.action.playInfo.playTimelong&&(this.end,this.start,this.action.playInfo.beginTime=(new Date).getTime()-this.action.playInfo.playTimelong,this.st.ot.$s(this.Ep))}stop(){this.action.stop(),this.st.ot.Ks(this.Ep),this.st.enableUpdateRender()}}Object.assign(_M.prototype,{Ep(){var e=(e=>{let i=null;for(let t=0;t<e.length;t++)(null===i||i.length<e[t].times.length)&&(i=e[t].times);return i})(this.action.getClip().tracks),i=(void 0===this.action.playInfo.param&&(this.action.playInfo.param=this.start),this.action.playInfo.param);let t=!1;if(this.end>this.start)i>this.end&&(t=!0);else{if(!(this.end<this.start))return this.action.loop=ni,this.action.clampWhenFinished=!0,this.action.time=e[s(this.action,this.start,e)],this.action.play(),this.action.paused=!0,this.st.enableUpdateRender(),void(this.action.playInfo=null);i<this.end&&(t=!0)}if(t)this.action.loop=ni,this.action.clampWhenFinished=!0,this.action.time=e[s(this.action,this.end,e)],this.action.play(),this.action.paused=!0,this.st.enableUpdateRender(),this.action.playInfo.once?(this.action.playInfo=null,this.st.ot.Ks(this.Ep),this._p=this.wp):(this.action.playInfo.param=this.start,this.action.playInfo.beginTime=(new Date).getTime());else{this.action.loop=ni,this.action.clampWhenFinished=!0,this.action.time=e[s(this.action,i,e)],this.action.play(),this.action.paused=!0,this.st.enableUpdateRender();let t=this.end-this.start;t=0<t?1:-1,this.action.playInfo.playTimelong=(new Date).getTime()-this.action.playInfo.beginTime,this.action.playInfo.param=this.start+t*this.action.playInfo.stepLong*60*this.action.playInfo.playTimelong/1e3}function s(t,e,i){var s=t.getClip().duration*e;let r=i.length-1;for(let t=0;t<i.length;t++)if(s<=i[t]){r=t;break}return r}}});var wM={exports:{}},MM=(wM.exports,(t=>{var l,u,st,c,rt;t.exports=(l=function(t){return t.reduce(function(t,e){return 2*t+e},0)},u=function(t){for(var e=[],i=7;0<=i;i--)e.push(!!(t&1<<i));return e},st=function(t){this.data=t,this.len=this.data.length,this.pos=0,this.readByte=function(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return t instanceof Uint8Array?t[this.pos++]:255&t.charCodeAt(this.pos++)},this.readBytes=function(t){for(var e=[],i=0;i<t;i++)e.push(this.readByte());return e},this.read=function(t){for(var e="",i=0;i<t;i++)e+=String.fromCharCode(this.readByte());return e},this.readUnsigned=function(){var t=this.readBytes(2);return(t[1]<<8)+t[0]}},c=function(t,s){for(var e,i,r=0,n=[],a=1<<t,h=1+a,o=t+1,l=[];;)if(i=e,(e=(t=>{for(var e=0,i=0;i<t;i++)s.charCodeAt(r>>3)&1<<(7&r)&&(e|=1<<i),r++;return e})(o))===a){u=void 0,l=[],o=t+1;for(var u=0;u<a;u++)l[u]=[u];l[a]=[],l[h]=null}else{if(e===h)break;if(e<l.length)i!==a&&l.push(l[i].concat(l[e][0]));else{if(e!==l.length)throw new Error("Invalid LZW code.");l.push(l[i].concat(l[i][0]))}n.push.apply(n,l[e]),l.length===1<<o&&o<12&&o++}return n},rt=function(n,a){a=a||{};var s=function(t){for(var e=[],i=0;i<t;i++)e.push(n.readBytes(3));return e},h=function(){for(var t,e="";t=n.readByte(),e+=n.read(t),0!==t;);return e},e=function(t){function e(t){var e;n.readByte(),t.identifier=n.read(8),t.authCode=n.read(3),"NETSCAPE"===t.identifier?(e=t,n.readByte(),e.unknown=n.readByte(),e.iterations=n.readUnsigned(),e.terminator=n.readByte(),a.app&&a.app.NETSCAPE&&a.app.NETSCAPE(e)):((e=t).appData=h(),a.app&&a.app[e.identifier]&&a.app[e.identifier](e))}var i,s,r;switch(t.label=n.readByte(),t.label){case 249:t.extType="gce",s=t,n.readByte(),r=u(n.readByte()),s.reserved=r.splice(0,3),s.disposalMethod=l(r.splice(0,3)),s.userInput=r.shift(),s.transparencyGiven=r.shift(),s.delayTime=n.readUnsigned(),s.transparencyIndex=n.readByte(),s.terminator=n.readByte(),a.gce&&a.gce(s);break;case 254:t.extType="com",(r=t).comment=h(),a.com&&a.com(r);break;case 1:t.extType="pte",s=t,n.readByte(),s.ptHeader=n.readBytes(12),s.ptData=h(),a.pte&&a.pte(s);break;case 255:t.extType="app",e(t);break;default:t.extType="unknown",(i=t).data=h(),a.unknown&&a.unknown(i)}},i=function(t){function e(t,e){for(var i=new Array(t.length),s=t.length/e,r=[0,4,2,1],n=[8,8,4,2],a=0,h=0;h<4;h++)for(var o=r[h];o<s;o+=n[h]){u=l=void 0;var l=o,u=a;u=t.slice(u*e,(u+1)*e),i.splice.apply(i,[l*e,e].concat(u)),a++}return i}t.leftPos=n.readUnsigned(),t.topPos=n.readUnsigned(),t.width=n.readUnsigned(),t.height=n.readUnsigned();var i=u(n.readByte()),i=(t.lctFlag=i.shift(),t.interlaced=i.shift(),t.sorted=i.shift(),t.reserved=i.splice(0,2),t.lctSize=l(i.splice(0,3)),t.lctFlag&&(t.lct=s(1<<t.lctSize+1)),t.lzwMinCodeSize=n.readByte(),h());t.pixels=c(t.lzwMinCodeSize,i),t.interlaced&&(t.pixels=e(t.pixels,t.width)),a.img&&a.img(t)},r=function(){var t={};switch(t.sentinel=n.readByte(),String.fromCharCode(t.sentinel)){case"!":t.type="ext",e(t);break;case",":t.type="img",i(t);break;case";":t.type="eof",a.eof&&a.eof(t);break;default:throw new Error("Unknown block: 0x"+t.sentinel.toString(16))}"eof"!==t.type&&setTimeout(r,0)},t={};if(t.sig=n.read(3),t.ver=n.read(3),"GIF"!==t.sig)throw new Error("Not a GIF file.");t.width=n.readUnsigned(),t.height=n.readUnsigned();var o=u(n.readByte());t.gctFlag=o.shift(),t.colorRes=l(o.splice(0,3)),t.sorted=o.shift(),t.gctSize=l(o.splice(0,3)),t.bgColor=n.readByte(),t.pixelAspectRatio=n.readByte(),t.gctFlag&&(t.gct=s(1<<t.gctSize+1)),a.hdr&&a.hdr(t),setTimeout(r,0)},function(t){var e,i,r,a={vp_l:0,vp_t:0,vp_w:null,vp_h:null,c_w:null,c_h:null};for(e in t)a[e]=t[e];a.vp_w&&a.vp_h&&(a.is_vp=!0);function s(){x=y,b=y=M=w=null}function U(){try{rt(i,it)}catch(t){n("parse")}}function F(t,e){v.width=t*P(),v.height=e*P(),m.style.minWidth=t*P()+"px",g.width=t,g.height=e,g.style.width=t+"px",g.style.height=e+"px",g.getContext("2d").setTransform(1,0,0,1,0,0)}function n(t){Y=t,r={width:C.width,height:C.height},R=[],p.fillStyle="black",p.fillRect(0,0,a.c_w||r.width,a.c_h||r.height),p.strokeStyle="red",p.lineWidth=3,p.moveTo(0,0),p.lineTo(a.c_w||r.width,a.c_h||r.height),p.moveTo(0,a.c_h||r.height),p.lineTo(a.c_w||r.width,0),p.stroke()}function B(){b&&(R.push({data:b.getImageData(0,0,r.width,r.height),delay:M}),L.push({x:0,y:0}))}function k(t){et(i.pos,i.data.length,t)}function G(){}function h(e,i){return function(t){e(t),k(i)}}function H(){var t=C.parentNode,e=document.createElement("div");v=document.createElement("canvas"),p=v.getContext("2d"),m=document.createElement("div"),g=document.createElement("canvas"),e.width=v.width=C.width,e.height=v.height=C.height,m.style.minWidth=C.width+"px",e.className="jsgif",m.className="jsgif_toolbar",e.appendChild(v),e.appendChild(m),t.insertBefore(e,C),t.removeChild(C),a.c_w&&a.c_h&&F(a.c_w,a.c_h),D=!0}function V(t){return!(_||(O=t||!1,_=!0,R=[],s(),S=b=x=E=null))}function z(){return R.reduce(function(t,e){return t+e.delay},0)}var o,W,l,u,c,j,X,f,d,v,p,m,g,Y=null,_=!1,w=null,M=null,y=null,E=null,x=null,b=null,S=null,A=!0,T=!1,R=[],L=[],C=a.gif,Z=(void 0===a.auto_play&&(a.auto_play=!C.getAttribute("rel:auto_play")||"1"==C.getAttribute("rel:auto_play")),a.hasOwnProperty("on_end")?a.on_end:null),q=a.hasOwnProperty("loop_delay")?a.loop_delay:0,K=a.hasOwnProperty("loop_mode")?a.loop_mode:"auto",N=!a.hasOwnProperty("draw_while_loading")||a.draw_while_loading,J=!!N&&(!a.hasOwnProperty("show_progress_bar")||a.show_progress_bar),$=a.hasOwnProperty("progressbar_height")?a.progressbar_height:25,Q=a.hasOwnProperty("progressbar_background_color")?a.progressbar_background_color:"rgba(255,255,255,0.4)",tt=a.hasOwnProperty("progressbar_foreground_color")?a.progressbar_foreground_color:"rgba(255,0,22,.8)",et=function(t,e,i){var s,r,n;i&&J&&(i=$,a.is_vp?n=T?(r=(a.vp_t+a.vp_h-i)/P(),i/=P(),s=a.vp_l/P()+t/e*(a.vp_w/P()),v.width/P()):(r=a.vp_t+a.vp_h-i,s=a.vp_l+t/e*a.vp_w,v.width):(r=(v.height-i)/(T?P():1),s=t/e*v.width/(T?P():1),n=v.width/(T?P():1),i/=T?P():1),p.fillStyle=Q,p.fillRect(s,r,n-s,i),p.fillStyle=tt,p.fillRect(0,r,s,i))},I=(u=-1,c=0,W=function(){null!==Z&&Z(C),c++,!1!==K||c<0?l():A=o=!1},{init:function(){Y||(a.c_w&&a.c_h||p.scale(P(),P()),(a.auto_play?f:(u=0,d))())},step:f=function(){o||setTimeout(l,0)},play:function(){A=!0,f()},pause:function(){A=!1},playing:A,move_relative:X=function(t){u+=t,d()},current_frame:function(){return u},length:function(){return R.length},move_to:function(t){u=t,d()}}),it={hdr:h(function(t){F((r=t).width,r.height)}),gce:h(function(t){B(),s(),w=t.transparencyGiven?t.transparencyIndex:null,M=t.delayTime,y=t.disposalMethod}),com:h(G),app:{NETSCAPE:h(G)},img:h(function(t){b=b||g.getContext("2d");var e=R.length,i=t.lctFlag?t.lct:r.gct,s=(0<e&&(3===x?null!==E?b.putImageData(R[E].data,0,0):b.clearRect(S.leftPos,S.topPos,S.width,S.height):E=e-1,2===x)&&b.clearRect(S.leftPos,S.topPos,S.width,S.height),b.getImageData(t.leftPos,t.topPos,t.width,t.height));t.pixels.forEach(function(t,e){t!==w&&(s.data[4*e+0]=i[t][0],s.data[4*e+1]=i[t][1],s.data[4*e+2]=i[t][2],s.data[4*e+3]=255)}),b.putImageData(s,t.leftPos,t.topPos),T||(p.scale(P(),P()),T=!0),N&&(p.drawImage(g,0,0),N=a.auto_play),S=t},!(o=!(j=function(){return(u+1+R.length)%R.length}))),eof:function(t){B(),k(!1),a.c_w&&a.c_h||(v.width=r.width*P(),v.height=r.height*P()),I.init(),_=!1,O&&O(C)}},P=function(){var t=a.max_width&&r&&r.width>a.max_width?a.max_width/r.width:1;return t},D=!(d=function(){var t;(u=parseInt(u,10))>R.length-1&&(u=0),t=L[u=u<0?0:u],g.getContext("2d").putImageData(R[u].data,t.x,t.y),p.globalCompositeOperation="copy",p.drawImage(g,0,0)}),O=!(l=function(){var t;(o=A)&&(X(1),t=(t=10*R[u].delay)||100,0===j()?(t+=q,setTimeout(W,t)):setTimeout(l,t))});return{play:I.play,pause:I.pause,move_relative:I.move_relative,move_to:I.move_to,get_playing:function(){return A},get_canvas:function(){return v},get_canvas_scale:function(){return P()},get_loading:function(){return _},get_auto_play:function(){return a.auto_play},get_length:function(){return I.length()},get_frames:function(){return R},get_duration:z,get_duration_ms:function(){return 10*z()},get_current_frame:function(){return I.current_frame()},load_url:function(t,e){V(e)&&((e=new XMLHttpRequest).open("GET",t,!0),"overrideMimeType"in e?e.overrideMimeType("text/plain; charset=x-user-defined"):"responseType"in e?e.responseType="arraybuffer":e.setRequestHeader("Accept-Charset","x-user-defined"),e.onloadstart=function(){D||H()},e.onload=function(t){200!=this.status&&n("xhr - response"),"response"in this||(this.response=new VBArray(this.responseText).toArray().map(String.fromCharCode).join(""));var e=this.response;0<e.toString().indexOf("ArrayBuffer")&&(e=new Uint8Array(e)),i=new st(e),setTimeout(U,0)},e.onprogress=function(t){t.lengthComputable&&et(t.loaded,t.total,!0)},e.onerror=function(){n("xhr")},e.send())},load:function(t){this.load_url(C.getAttribute("rel:animated_src")||C.src,t)},load_raw:function(t,e){V(e)&&(D||H(),i=new st(t),setTimeout(U,0))},set_frame_offset:function(t,e){L[t]?(void 0!==e.x&&(L[t].x=e.x),void 0!==e.y&&(L[t].y=e.y)):L[t]=e}}})})(wM),wM.exports),yM=oa(MM);class EM{constructor(t){this.eh=t,this.st=this.eh.map,this.bp={},this.Xv=null,this.Sp={},this.Ap=0,this.Jt=512,this.Tp=512,this.Rp=!1,this.O=null,this.V=this.V.bind(this)}get isAdded(){return this.Rp}add(t){null===this.Xv&&(this.Xv=t),this.Lp(t=>{this.Cp(t)})}dispose(t){this.st.off("update",this.V),t&&t()}stop(){this.st.off("update",this.V)}}Object.assign(EM.prototype,{Lp(e){var t=this.eh.externalModel.getRenderNode();t.renderOrder=1,this.eh.externalModel.Np?t.traverse(t=>{"Mesh"===t.type&&(t.renderOrder=1,e(t))}):e(t)},Cp(s){let r=this,n=0,a=null;Array.isArray(s.material)?(this.bp[s.name]=[],function i(){n<s.material.length?r.Pr(s.material[n],(t,e)=>{r.bp[s.name].push(s.material[n].clone()),e&&(s.material[n].dispose(),s.material[n]=t),n++,a=setTimeout(i,0)}):(null!==a&&clearTimeout(a),r.O=(new Date).getTime(),r.st.on("update",r.V))}()):this.Pr(s.material,(t,e)=>{this.bp[s.name]=s.material.clone(),e&&(s.material.dispose(),s.material=t),this.O=(new Date).getTime(),this.st.on("update",r.V)})},Pr(t,e){let i=null;var s;t&&(this.eh.externalModel.Np?t.uniforms&&t.uniforms.map&&t.uniforms.map.value?i=t.uniforms.map.value.name:t.map&&(i=""+t.map.name):t.map&&(i=""+t.map.name).indexOf(".gif")<0&&(i=t.name)),(null===i||!this.eh.parent.Ip||!this.eh.parent.Ip[i])&&null!==i&&0<=i.indexOf(".gif")?(t=(t=i.split("."))[0]+"."+t[1],(s=this.Sp[t])?s.canvasArray&&0<s.canvasArray.length&&(s=new Y0(s.canvasArray[s.canvascount]),this.eh.externalModel.Np&&(s.flipY=!1),s.repeat.set(1,1),s.name=i,s.magFilter=V,s.minFilter=ie,(s=new ro({map:s})).isBasic=!0,s.gifname=t,s.transparent=!0,e(s,!0)):this.Pp(this.Xv+t,t,t=>{e(t,!0)})):e(null,!1)},Pp(t,i,s){var r=document.createElement("div");r.style.display="none",document.body.appendChild(r);let n=new Image;n.crossOrigin="Anonymous",n.onload=()=>{s&&((t=document.createElement("canvas")).width=this.Tp,t.height=this.Jt,t.getContext("2d").drawImage(n,0,0,this.Tp,this.Jt),t=new Y0(t),this.eh.externalModel.Np&&(t.flipY=!1),t.repeat.set(1,1),t.magFilter=V,t.minFilter=ie,(t=new ro({map:t})).transparent=!0,t.isBasic=!0,t.gifname=i,s(t)),this.Sp[i]={canvascount:0,canvasArray:[]},r.appendChild(n);var t,e=new yM({gif:n});e.load(()=>{this.Dp(e,i,r)})},n.src=t},Dp(s,r,t){let n=this,a=null,e=s.get_length(),h=1;this.Sp[r].canvascount=0,function i(){if(h>e)document.body.removeChild(t),null!==a&&clearTimeout(a);else{s.move_to(h);let t=document.createElement("canvas"),e=(t.width=n.Tp,t.height=n.Jt,t.getContext("2d"));e.drawImage(s.get_canvas(),0,0,n.Tp,n.Jt),n.Sp[r].canvasArray.push(t),h++,a=setTimeout(i,0)}}()},Op(t,e){t=t.split("."),t=t[0]+"."+t[1];this.Sp[t]&&(this.Sp[t].canvasArray.length=0,this.Sp[t].canvascount=0),this.Pp(e,t),this.V(),this.Rp||(this.Rp=!0,this.st.on("update",this.V))},Xo(t){var e=t.split("."),e=e[0]+"."+e[1];this.Op(t,this.Xv+e)},V(){var t=(new Date).getTime();let e=t-this.O,r=(50<=e&&(this.O=t),t=>{50<=e&&t&&(t.canvascount<t.canvasArray.length-1?t.canvascount++:t.canvascount=0)});this.eh.externalModel.getRenderNode()&&(this.Lp(s=>{if(Array.isArray(s.material)){var t,e=s.material;for(let i=0;i<e.length;i++)!e[i].isBasic||s.material[i].isupdate?this.Pr(this.bp[s.name][i],(t,e)=>{e&&(s.material[i].dispose(),s.material[i]=t)}):((t=this.Sp[e[i].gifname])&&t.canvasArray[t.canvascount]&&(s.material.isupdate?this.Pr(this.bp[s.name][i],(t,e)=>{e&&(s.material[i].dispose(),s.material[i]=t)}):(s.material[i].map.image=t.canvasArray[t.canvascount],s.material[i].map.needsUpdate=!0)),r(t))}else{var i;s.material.isBasic&&!s.material.isupdate?((i=this.Sp[s.material.gifname])&&i.canvasArray[i.canvascount]&&(s.material.isupdate?this.Pr(this.bp[s.name],(t,e)=>{e&&(s.material.dispose(),s.material=t)}):(s.material.map.image=i.canvasArray[i.canvascount],s.material.map.needsUpdate=!0)),r(i)):this.Pr(this.bp[s.name],(t,e)=>{e&&(s.material.dispose(),s.material=t)})}}),this.st.enableUpdateRender())}});class xM extends c{constructor(e,t,i,s,r,n,a,h,o){super(e,t,i,s,r,n,a,h,o),this.isVideoTexture=!0,this.minFilter=void 0!==n?n:V,this.magFilter=void 0!==r?r:V,this.generateMipmaps=!1;let l=this;"requestVideoFrameCallback"in e&&e.requestVideoFrameCallback(function t(){l.needsUpdate=!0,e.requestVideoFrameCallback(t)})}clone(){return new this.constructor(this.image).copy(this)}update(){var t=this.image;!1=="requestVideoFrameCallback"in t&&t.readyState>=t.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}class bM{constructor(t){this.eh=t,this.Up=t.externalModel,this.st=this.eh.map,this.Fp=[],this.Bp=null,this.kp={},this.Gp=null,this.Rp=!1,this.oldmaterial={},this.Xv=null,this.Hp={},this.V=this.V.bind(this)}get isAdded(){return this.Rp}add(t){null===this.Xv&&(this.Xv=t),this.Lp(t=>{this.Cp(t)}),this.st.on("update",this.V)}dispose(){for(let t=0;t<this.Fp.length;t++){var e=this.Fp[t];null!==document.getElementById(e)&&document.getElementById(e).parentNode.removeChild(document.getElementById(e))}this.st.off("update",this.V)}stop(){this.st.off("update",this.V)}}Object.assign(bM.prototype,{Lp(e){var t=this.eh.externalModel.getRenderNode();this.Up.Np?t.traverse(t=>{"Mesh"===t.type&&e(t)}):e(t)},Cp(s){let r=this,n=s.material,a=0,h=null;Array.isArray(n)?(this.oldmaterial[s.name]=[],function i(){a<n.length?r.Pr(n[a],(t,e)=>{r.oldmaterial[s.name].push(n[a].clone()),e&&(s.material[a].dispose(),s.material[a]=t),a++,h=setTimeout(i,0)}):null!==h&&clearTimeout(h)}()):this.Pr(n,(t,e)=>{this.oldmaterial[s.name]=n.clone(),e&&(s.material.dispose(),s.material=t)})},Pr(i,s){let r=null;if(i&&(this.Up.Np?i.uniforms&&i.uniforms.map&&i.uniforms.map.value?r=i.uniforms.map.value.name:i.map&&(r=""+i.map.name):i.map&&(r=""+i.map.name).indexOf(".mp4")<0&&r.indexOf(".webm")<0&&r.indexOf(".ogg")<0&&(r=i.name)),null!==r&&this.eh.parent.Ip&&this.eh.parent.Ip[r])s(null,!1);else if(null!==r&&(0<=r.indexOf(".mp4")||0<=r.indexOf(".webm")||0<=r.indexOf(".ogg"))){let e=r.split("."),t=this.Hp[r];(t=t||this.kp[e[0]+"."+e[1]])?((i=new ro({map:t.clone()})).isBasic=!0,s&&s(i,!0)):this.Vp(this.Xv+e[0]+"."+e[1],t=>{t.name=r,this.kp[e[0]+"."+e[1]]=t;t=new ro({map:t.clone()});t.isBasic=!0,s(t,!0)})}else s(null,!1)},Vp(t,i){let s=this,r=(this.Gp=t,null);var e=document.createElement("div");e.style.display="none";let n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)});this.Bp=n+"_div",this.Fp.push(this.Bp),e.setAttribute("id",this.Bp),e.innerHTML='<video id="'+n+'" loop crossOrigin="anonymous" muted><source src="'+t+'"></video>',document.body.appendChild(e),function t(){let e=document.getElementById(n);e?(null!==r&&clearTimeout(r),e.addEventListener("loadeddata",()=>{var t=new xM(e);t.video_id=n+"_div",s.Up.Np&&(t.flipY=!1),i&&i(t),e.play()})):r=setTimeout(t,0)}()},zp(s){this.eh.externalModel.getRenderNode()&&this.Lp(i=>{var t=i.material;if(Array.isArray(t))for(let e=0;e<t.length;e++)this.Pr(this.oldmaterial[i.name][e],t=>{t&&t.map&&t.map.name===s&&(i.material[e].dispose(),i.material[e]=t)});else this.Pr(this.oldmaterial[i.name],t=>{t&&t.map&&t.map.name===s&&(i.material.dispose(),i.material=t)})})},Xo(t){var e;this.Hp[t]&&(e=this.Hp[t].video_id,null!==document.getElementById(e)&&document.getElementById(e).parentNode.removeChild(document.getElementById(e)),this.Hp[t].dispose(),this.Hp[t]=void 0,this.zp(t))},Op(e,t){this.Vp(t,t=>{this.Hp[e]&&this.Xo(e),t.name=e,this.Hp[e]=t,this.zp(e)}),this.Rp||(this.Rp=!0,this.st.on("update",this.V))},V(){this.eh.externalModel.getRenderNode()&&(this.Lp(i=>{var t=i.material;if(Array.isArray(t))for(let e=0;e<t.length;e++)t[e].isBasic&&!t[e].isupdate||this.Pr(this.oldmaterial[i.name][e],t=>{t&&(i.material[e].dispose(),i.material[e]=t)});else t.isBasic?t.isupdate&&this.Pr(this.oldmaterial[i.name],t=>{t&&(i.material.dispose(),i.material=t)}):this.Pr(this.oldmaterial[i.name],t=>{t&&(i.material.dispose(),i.material=t)})}),this.st.enableUpdateRender())}});class SM{constructor(t){this.st=t.parent.parent.parent.parent,this.Up=t,this.V=this.V.bind(this),this.Ai="no",this.Wp=new EM({map:this.st,externalModel:t,parent:this}),this.jp=new bM({map:this.st,externalModel:t,parent:this}),this.Ip=null,this.Xp=[],this.Yp={},this.st.on("update",this.V)}get gifTool(){return this.Wp}get videoTool(){return this.jp}get isGltf(){return this.Up.Np}get textureNames(){return this.Xp}get oldMaterial(){return this.Yp}replace(t,e){null===this.Ip&&(this.Ip={}),this.Ip[t]=!0}reset(t){this.Ip[t]=!1}dispose(){this.Wp.Rp&&this.Wp.dispose(),this.jp.Rp&&this.jp.dispose()}}Object.assign(SM.prototype,{V(){var t=this.Up.getRenderNode();let i=(t,e)=>{t=this.Jr(t);t.needgif&&!this.Wp.Rp&&(this.Wp.add(e),this.Wp.Rp=!0),t.needvideo&&!this.jp.Rp&&(this.jp.add(e),this.jp.Rp=!0)};if(t){this.st.off("update",this.V);let e=this.Up.Zp;this.Up.Np?t.traverse(t=>{"Mesh"===t.type&&i(t,e)}):i(t,e)}},Jr(t){var e={needgif:!1,needvideo:!1};let i=!1,s=!1;var r=t.material,n=t=>{0<=t.indexOf(".gif")?(i=!0,this.Xp.push(t)):(0<=t.indexOf(".mp4")||0<=t.indexOf(".webm")||0<=t.indexOf(".ogg"))&&(s=!0,this.Xp.push(t))},a=(t,e)=>{0<=t.indexOf(".gif")||0<=e.indexOf(".gif")?(i=!0,0<=t.indexOf(".gif")?this.Xp.push(t):this.Xp.push(e)):(0<=t.indexOf(".mp4")||0<=t.indexOf(".webm")||0<=t.indexOf(".ogg")||0<=e.indexOf(".mp4")||0<=e.indexOf(".webm")||0<=e.indexOf(".ogg"))&&(s=!0,0<=t.indexOf(".mp4")||0<=t.indexOf(".webm")||0<=t.indexOf(".ogg")?this.Xp.push(t):this.Xp.push(e))};if(Array.isArray(r)){this.Yp[t.name]=[];for(let e=0;e<r.length;e++)if(this.Yp[t.name].push(r[e].clone()),this.Up.Np){let t="";r[e].uniforms&&r[e].uniforms.map&&r[e].uniforms.map.value?t=r[e].uniforms.map.value.name:r[e].map&&n(t=r[e].map.name)}else{let t="";r[e].map&&(t=""+r[e].map.name);var h=""+r[e].name;a(t,h)}}else if(this.Yp[t.name]=r.clone(),this.Up.Np){let t="";r.uniforms&&r.uniforms.map&&r.uniforms.map.value?t=r.uniforms.map.value.name:r.map&&(t=r.map.name),n(t)}else{let t="";r.map&&(t=""+r.map.name);var o=""+r.name;a(t,o)}return e.needgif=i,e.needvideo=s,e}});class AM{constructor(t,e){this.st=t,this.Up=e,this.qp=null,this.Kp=null,this.Jp=null,this.$p=null,this.Qp=null,this.tm=new Jm(Zm),this.tm.setResponseType("json"),this.im=this.im.bind(this),this.st.on("viewChanged",this.im)}}function TM(e){let t=[];var i=e.Zs;if(i.userData.sourceMaterial||(i.userData.sourceMaterial=i.material),Array.isArray(e.Zs.material)){var s=[];for(let t=0;t<e.Zs.material.length;t++){var r=e.Zs.material[t];r.transparent=!0,s.push(r.clone())}e.Zs.material=s,t=t.concat(s)}else{i=e.Zs.material.clone();i.transparent=!0,t.push(i),e.Zs.material=i}return t}function RM(e,i){var s=e.Zs.material;if(Array.isArray(s))for(let t=0;t<s.length;t++)s[t]=e.sm(s[t],i);else e.Zs.material=e.sm(s,i)}function LM(t,e){var i,s=t.Zs;(s=s)&&s.userData.sourceMaterial&&(i=s.material,s.material=s.userData.sourceMaterial,delete s.userData.sourceMaterial,Array.isArray(i)?i.forEach(t=>{t.dispose()}):i.dispose()),t.Pr()}function CM(t,r){t=void 0!==(t=t||{}).duration?t.duration:.5;let n=r.ur(v),a=n.ur(E);if(r.rm&&!1===r.rm.H){if(r.nm)return;r.rm.stop()}r.nm=!0;let h=TM(r);r.rm.Y([0]).Z([1]).K(t).J(t=>{var e=t.destination[0];for(let t=0;t<h.length;t++){var i=h[t],s=r.Kr||i.userData.sourceOpacity;i.opacity=e*s*n.Kr}a.enableUpdateRender()}).$(()=>{a.ot.ht(r.rm),LM(r)}),a.ot.lt(r.rm.play())}function NM(t,a){if(a.pf){var e=void 0!==(t=t||{}).duration?t.duration:.5;let s=a.ur(v),r=s.ur(E);if(a.rm&&!1===a.rm.H){if(!a.nm)return;a.rm.stop()}a.nm=!1;let n=TM(a);a.rm.Y([1]).Z([0]).K(e).J(t=>{var e=t.destination[0];for(let t=0;t<n.length;t++){var i=void 0!==a.Kr?a.Kr:n[t].userData.sourceOpacity;n[t].opacity=e*i*s.Kr}r.enableUpdateRender()}).$(()=>{r.ot.ht(a.rm),a.Q0(),r.enableUpdateNode(),t.finish&&t.finish()}),r.ot.lt(a.rm.play())}}function IM(t,e){"Mesh"===t.type&&t.material.map&&e.Xp.push(t.material.map.name);var i=t.children;for(let t=0;t<i.length;t++)IM(i[t],e)}Object.assign(AM.prototype,{am(){this.Up.hm({needFadeIn:!1,needFadeOut:!1,initLODMesh:!1,lodName:this.Kp,callback:t=>{t!==this.Kp&&this.am()}})},im(){var t=this.om(this.qp,this.st.getZoom());this.Kp!==t&&null!==t&&(this.Kp=t,null!==this.Qp&&clearTimeout(this.Qp),this.am(),this.Qp=setTimeout(()=>{},50))},om(e,i){if(!e)return null;var{maxlevel:t,minlevel:s}=this.Up.qs;if(i<s||t<i)return null;let r=null;for(let t=0;t<e.length;t++){var n=e[t],{maxlevel:a,minlevel:h}=n;if(h<=i&&i<=a){r=n.name;break}}return r},lm(n){return this.$p!==n&&(this.$p=n,this.Jp=null),new Promise((s,r)=>{this.um(n).then(t=>{t.lod&&Array.isArray(t.lod)||r("lod format error");var e=this.om(t.lod,this.st.getZoom()),i=(null===e&&r(null),jm.extractUrlBase(n));this.qp=t.lod,s(""+i+e)}).catch(r)})},um(i){return new Promise((e,t)=>{this.Jp?e(this.Jp):this.tm.load(i,t=>{this.Jp=t,e(this.Jp)},null,t)})},Qt(){this.st.off("viewChanged",this.im),this.tm=null}});class PM extends lM{constructor(t){super(),this.qs=t,this.Ai=p.EXTERNAL_MODEL,this.X0=null,this.Zs=null,this.fm=null,this.dm=null,this.vm=null,this.Kr=null,this.pm=!1,this.Ir=null,this.Np=null,this.s1=null,this.ap=[],this.Of=null,this.gm=this.gm.bind(this),this.rm=new an,this.nm=!0,this._m=null,this.Zp=null,this.Kf=null,this.Jf=!1,this.wm=!1,this.Mm=null,this.ym=null,this.Em=!1,this.xm=null,this.Xp=[],this.bm=!1,this.Sm=null,this.Am=0,this.pf=!0,this.Tm=void 0,this.Rm=[],this.Lm=!1}get bindBuildingID(){return this.Cm}get multiMediaTool(){return this._m}get fading(){return!this.rm.H}get FID(){return this.qs.fid}get typeID(){return this.qs.type}get name(){return this.qs.name}get eName(){return this.qs.ename}get color(){return this.vm}set color(t){this.vm=t,this.Pr()}get opacity(){return this.Kr}set opacity(t){this.Kr=t,this.Pr()}get canDispose(){return this._canDispose}get show(){return this.Ef}set show(t){t?this.Of&&!this.Of.show||this.Nm():this.Im()}get isGltf(){return this.Np}get boundNoClone(){var t=this.getBound();return t?{min:{x:t.minX,y:t.minY},max:{x:t.maxX,y:t.maxY}}:null}get renderNode(){return this.Zs}set renderNode(t){this.Zs=t}resetColor(){this.pm=!0,this.Pr(!0)}setColor(t,e){this.vm=t,this.Kr=e,this.Pr()}beforRemove(){var t=this.parent?.parent?.parent;this.wm=!t||!t.visibleLevels.includes(this.level)}getBound(){if(this.dm)return this.dm;var e={};if(this.Zs){var t=new dM(this.Zs,16776960),i=t.geometry.attributes.position.array,s=t.geometry.attributes.position.count;for(let t=0;t<s;t++){var r=i[3*t],n=i[3*t+2],a=i[3*t+1];(!e.minX||r<e.minX)&&(e.minX=r),(!e.maxX||e.maxX<r)&&(e.maxX=r),(!e.minY||n<e.minY)&&(e.minY=n),(!e.maxY||e.maxY<n)&&(e.maxY=n),(!e.minH||a<e.minH)&&(e.minH=a),(!e.maxH||e.maxH<a)&&(e.maxH=a)}t.material.dispose(),t.geometry.dispose(),t.material=void 0,t.geometry=void 0;var t=this.ur(E);return e.minX=e.minX+t.x,e.maxX=e.maxX+t.x,e.minY=t.y-e.minY,e.maxY=t.y-e.maxY,e.maxY<e.minY&&(t=e.minY,e.minY=e.maxY,e.maxY=t),this.dm=e,this.dm}}startAction(e,t,i){var s=this.ap[e];if(s){if(t){var r=this.getActionNames();for(let t=0;t<r.length;t++)r[t]!==e&&!0===this.ap[r[t]].clampWhenFinished&&!0===this.ap[r[t]].paused&&this.ap[r[t]].stop();s.loop=ni,s.clampWhenFinished=!0}else s.clampWhenFinished=!1,s.loop=ai;if(this.Mm&&this.Mm===e){if(this.Mm===e){let t=!1;s.time=this.ym,i?this.Em?t=!0:(t=!1,this.Mm=null,this.ym=null):(this.Mm=null,this.ym=null,this.Em=!1),s.paused=t,s.play()}}else s.reset().setEffectiveTimeScale(1).setEffectiveWeight(1).play()}t=this.ur(E);t&&t.on("beforeRender",this.gm)}getActionNames(){return Object.keys(this.ap)}stopAction(t,e){var i=this.ur(E),i=(i&&i.off("beforeRender",this.gm),this.ap[t]);i&&(i.paused=!0,this.Mm=t,this.ym=i.time,this.xm=i.loop,e||(this.Em=!0))}dispose(){null!==this._m&&this._m.dispose(),this.Q0(),super.dispose()}getTextureNames(){return this.Xp}setMaterialParam(t){this.vm&&(t.color=(new Wt).setStyle(this.vm)),null!==this.Kr&&(t.opacity=this.Kr)}resetMaterial(t,e){var i;this.pm&&void 0!==t.userData.originColor&&(i=new Wt(t.userData.originColor),this.vm=i,t.color=i,void 0!==t.userData.originOpacity)&&(t.opacity=t.userData.originOpacity*e.Kr,this.Kr=t.userData.originOpacity)}getActions(){let r=this;return new Promise((i,t)=>{{var s=t=>{i(t)};let e=null;!function t(){r.Zs?(null!==e&&clearTimeout(e),s(r.Rm)):e=setTimeout(t,0)}()}})}}Object.assign(PM.prototype,{iv(t){this.Cm=t},Bu(t){this.Jf=!0,this.wm=!1,!this.Zs&&this.qs&&this.Pm(()=>{this.Of&&this.Of.Bu(this),t&&t()},{initLODMesh:!0})},am(t={needFadeIn:!0,needFadeOut:!0,initLODMesh:!0}){this.Zs&&this.P.xa.remove(this.Zs),this.Zs=null,this.Am=0,this.Pm(null,t)},hm(e={needFadeIn:!0,needFadeOut:!0,initLODMesh:!1}){1===this.Am&&this.pf&&(this.Am=0),this.Pm(t=>{e.onLoaded=()=>{this.Zs&&this.P.xa.remove(this.Zs),this.fm=this.Zs,this.Zs=null},this.Dm(t,()=>{e.callback&&e.callback(e.lodName),!this.visible&&this.Zs&&(this.Zs.visible=!1)},e)},e)},z0(){this.am()},Dm(t,r,n={}){let a=this.ur(E);if(a&&a.Wt){let i=this.ur(v),s=-1===t.indexOf(".js");var e;nt.environment!=I.BROWSER||s||window.fengmap.FMJSONLoader?(e=s?a.Wt.Zf:window.fengmap.FMJSONLoader.getLoader(a))&&(e=e.load(t,(t,e)=>{this.Np=s,n.onLoaded&&n.onLoaded(),s?this.Om(t,n):(window.fengmap.FMJSONLoader.initMeshJSON(t,e,this.X0,this,a,i,{x:this.qs.Ti[0].x,y:this.qs.Ti[0].y,z:-1===this.qs.height?2.2:this.qs.height}),this.Nm({duration:!1===n.needFadeIn?0:void 0})),nt.environment===I.BROWSER&&null===this._m&&(this._m=new SM(this)),a.enableUpdateRender(),r&&r(),this.Kf=2},t=>{this.Kf=-2}))&&a.Um.add(t,e):console.error(" .js ")}},Pm(e,i){var t,s,r;1!==this.Am&&(this.Am=1,i=i||{},t=this.ur(E),s=this.ur(rh),this.X0=t.Wt.dd.ec({fid:this.qs.fid,typeID:this.qs.type+"",bid:s.Ht}),this.X0)&&this.X0.normalID&&(r=t.Wt.zf(this.X0,"model",s.buildingID)+this.X0.model+"?keyValue="+t.Ls.key,null===this.Zp&&(this.Zp=t.Wt.zf(this.X0,"model",s.buildingID)),r.includes(".json")?(this.Fm||(this.Fm=new AM(t,this)),this.Fm.lm(r).then(t=>{!1!==i.initLODMesh?this.Dm(t,e,i):e&&e(t)})):this.Dm(r,e))},Om(t,e){if(e=e||{},!this.Zs){var i=this.ur(E);if(i){var s=t.scene,r=this.X0.rotate.split(","),n=new Gt,a=Math.PI/180,r=(n.set(parseFloat(r[0])*a,parseFloat(r[2])*a,parseFloat(r[1])*a),s.rotation.setFromVector3(n,"YXZ"),this.X0.scale.split(",")),a=(s.scale.set(parseFloat(r[0]),parseFloat(r[2]),parseFloat(r[1])),this.X0.translate.split(",")),n=new Gt(this.qs.Ti[0].x-i.t,this.qs.Ti[0].y-i.o,0).applyEuler(new Ps(-Math.PI/2,0,0,"XYZ")).add(new Gt(0,-1===this.qs.height?2.2:this.qs.height,0));if(n.add(new Gt(parseFloat(a[0]),parseFloat(a[2]),parseFloat(a[1]))),s.position.set(n.x,n.y,n.z),this.Zs=s,(this.Zs.mapNode=this).bm||(IM(this.Zs,this),this.bm=!0),this.Pr(),this.P.xa.add(this.Zs),this.Qs&&(this.Zs.visible=!0),this.Of||this.c0||void 0!==this.ir||this.Nm({duration:!1===e.needFadeIn?0:void 0}),0<t.animations.length){this.s1=new gM(this.Zs),this.Rm.length=0;for(var h of t.animations){this.ap[h.name]=this.s1.clipAction(h);h=new _M(this,h.name,this.s1.clipAction(h),i);this.Rm.push(h)}if(i.ot.Bm(this.s1),i.Ls.autoPlay){let t=!1;null!==this.xm&&this.xm===ni&&(t=!0),this.startAction(this.getActionNames()[0],t,!0)}}}}},km(i){let s=[],r=null;this.c0?(function e(t){"Mesh"===t.type&&s.push(t);let i=t.children;for(let t=0;t<i.length;t++)e(i[t])}(this.Zs),function t(){let e=!0;for(let t=0;t<s.length;t++)if(!s[t].isUpdateComplete){e=!1;break}e?(i&&i(),null!==r&&clearTimeout(r)):r=setTimeout(t,10)}()):i&&i()},Gm(){if(this.Np){let i=[];return this.Zs.traverse(t=>{var e;"Mesh"===t.type&&(t.userData.sourceMaterial||(t.userData.sourceMaterial=t.material),(e=t.material.clone()).transparent=!0,t.material=e,i.push(e))}),i}},Hm(){var t=this.Zs;let e=t=>{var e;t&&t.userData.sourceMaterial&&(e=t.material,t.material=t.userData.sourceMaterial,delete t.userData.sourceMaterial,e.dispose())};this.Np&&t?this.Zs.traverse(t=>{"Mesh"===t.type&&e(t)}):e(t),this.Pr()},Nm(t){if(this.pf)if(this.Np){var e=void 0!==(t=t||{}).duration?t.duration:.5;let r=this.ur(v),n=r.ur(E);if(this.rm&&!1===this.rm.H){if(this.nm)return;this.rm.stop()}this.nm=!0;let a=this.Gm();this.rm.Y([0]).Z([1]).K(e).J(t=>{var e=t.destination[0];for(let t=0;t<a.length;t++){var i=a[t],s=this.Kr||i.userData.sourceOpacity;void 0===this.ir?i.opacity=e*s*r.Kr:i.opacity=e*this.ir}n.enableUpdateRender()}).$(()=>{n.ot.ht(this.rm),this.Hm()}),n.ot.lt(this.rm.play())}else CM(t,this)},Im(t){if(this.pf)if(this.Np){var e=void 0!==(t=t||{}).duration?t.duration:.5;let s=this.ur(v),r=s.ur(E);if(this.rm&&!1===this.rm.H){if(!this.nm)return;this.rm.stop()}this.nm=!1;let n=this.Gm();this.rm.Y([1]).Z([0]).K(e).J(t=>{var e=t.destination[0];for(let t=0;t<n.length;t++){var i=void 0!==this.Kr?this.Kr:n[t].userData.sourceOpacity;n[t].opacity=e*i*s.Kr}r.enableUpdateRender()}).$(()=>{r.ot.ht(this.rm),this.Q0(),r.enableUpdateNode(),t.finish&&t.finish()}),r.ot.lt(this.rm.play())}else NM(t,this)},sm(t,e,i){null==t.userData.sourceOpacity&&(t.userData.sourceOpacity=t.opacity),void 0===t.userData.sourceTransparent&&(t.userData.sourceTransparent=t.transparent),void 0===t.userData.originColor&&(t.userData.originColor=t.color.getHex()),void 0===t.userData.originOpacity&&(t.userData.originOpacity=t.opacity),null===this.Kr&&(this.Kr=t.opacity),this.resetMaterial(t,e),null===this.vm&&(this.vm=t.color.getStyle()),null===this.Kr&&(this.Kr=t.opacity);let s=this.Kr;return i&&(s=t.userData.sourceOpacity),(t=t.clone()).opacity=s*e.Kr,t.color=(new Wt).setStyle(this.vm),t.transparent=t.userData.sourceTransparent||t.opacity<1,void 0!==this.ir&&(t.opacity=this.ir,t.transparent=!0),this.Vm(t),null!==this.Ir&&(t.color=new Wt(this.Ir)),t},Pr(i){if(this.Zs){var t=this.ur(E);let e=this.ur(v);t&&(this.Zs.traverse(t=>{"Mesh"!==t.type&&"SkinnedMesh"!==t.type||(Array.isArray(t.material)?RM(this,e):t.material&&(t.material=this.sm(t.material,e,i)))}),this.pm&&(this.pm=!1),t.enableUpdateRender())}},Vm(t){this.c0?(t.isMask=this.c0,t.maskType=this.m0,t.maskPolygons=this.f0,t.maskHolePogygons=this.d0,t.maskHeight=this.g0,t.maskExtrudeHeight=this._0,t.boundCenter=this.w0,t.boundSize=this.M0,t.maskOpacity=this.y0,t.maskNodeHeight=this.av,t.transparent=!0):(t.isMask=!1,t.maskType=0,t.maskPolygons=[],t.maskHolePogygons=[],t.maskHeight=0,t.maskExtrudeHeight=0,t.boundCenter=null,t.boundSize=null,t.maskNodeHeight=0),this.jv(t)},zm(t){!t||"Scene"!==t.type&&"Group"!==t.type||(t.parent&&t.parent.remove(t),this.wm&&t.traverse(t=>{"Mesh"===t.type&&t.material?.uniforms?.map?.value.dispose()}),t.mapNode=void 0)},Q0(){if(this.pf){var t;if(this.s1&&(this.stopAction(this.getActionNames()[0],!0),(t=this.ur(E))&&t.ot.Wm(this.s1),this.s1=null),this.rm&&!1===this.rm.H&&this.rm.finish(),this.Zs&&"Mesh"===this.Zs.type){if(this.Zs.parent&&this.Zs.parent.remove(this.Zs),Array.isArray(this.Zs.material))for(var e of this.Zs.material)e.map&&this.wm&&e.map.dispose(),e.dispose();else this.Zs.material.map&&this.wm&&this.Zs.material.map.dispose(),this.Zs.material.dispose();this.Zs.geometry.dispose(),this.Zs.geometry=void 0,this.Zs.material=void 0,this.Zs.mapNode=void 0,this.Zs=void 0}else this.zm(this.Zs),this.zm(this.fm),this.Zs=void 0,this.fm=void 0,this.Fm&&(this.Fm.Kp=null);this.Am=0}},gm(){var t=this.ur(E);t&&t.enableUpdateRender()},xp(){if(!this.Lm){var e=this.getActionNames();for(let t=0;t<e.length;t++)this.ap[e[t]].stop();this.Lm=!0}}});class DM extends lM{constructor(t){super(),this.qs=t,this.Jt=t.height,this.Ai=p.FACILITY,this.Ia=0,this.jm=null,this.As=new Map,this.X0=null}get FID(){return this.qs.fid}get typeID(){return this.qs.type}get eName(){return this.qs.ename}get name(){return this.qs.name}get size(){return this.jm||this.X0.height}set size(t){var e;this.jm=t,this.jm?this.Ia=this.jm:(t=this.ur(E),e=this.ur(rh),this.fd(t,e),this.Ia=this.X0.height),this.Pr()}get scaleSize(){return this.size/this.Ia||1}jump(t){return G3(this,t)}stopJump(){return H3(this)}boost(t){return B3(this,t)}stopBoost(){return k3(this)}getPosition(){return{x:this.qs.Ti[0].x,y:this.qs.Ti[0].y,z:this.Jt}}updateMaterialByThemeTool(t){this.X0=t,this.Ia=parseInt(this.X0.height),this.jm&&(this.Ia=this.jm),this.Pr(),this.Zs.userData.size=this.Ia}}Object.assign(DM.prototype,{fd(t,e){this.X0=t.Wt.dd.Qu({fid:this.qs.fid,typeID:""+this.qs.type,bid:e.Ht})},Bu(){var t,e;if(!this.Zs)return t=this.ur(E),e=this.ur(rh),this.fd(t,e),this.Ia=parseInt(this.X0.height),(e=this.E0(t)).userData.opacity=e.opacity,this.Zs=new x3(e),e=this.qs.Ti[0],e=new Gt(e.x-t.t,-e.y+t.o,0).applyEuler(new Ps(Math.PI/2,0,0,"XYZ")).add(new Gt(0,this.Jt,0)),this.Zs.position.copy(e),this.Pa(t.Wt),this.Zs.userData.size=this.Ia,(this.Zs.mapNode=this).P.xa.add(this.Zs),!0},z0(t,e){var i;this.Zs&&(i=this.ur(rh),this.X0=e.Qu({fid:this.qs.fid,typeID:""+this.qs.type,bid:i.Ht}),this.Ia=parseInt(this.X0.height),this.Pr(),this.Zs.userData.size=this.Ia)},Pr(){var t;this.Zs&&(t=this.ur(E))&&(this.Zs.material=this.E0(t))},E0(t){var e=this.ur(v),i=e.parent;let s=e.Kr;return this.c0&&(s=this.y0),void 0!==this.ir&&(s=this.ir),t.Wt.pl.du({opacity:s,needDepth:!1,url:t.Wt.zf(this.X0,"path",i.buildingID)+this.X0.imageName},()=>{this.Pa(t.Wt),t.Wt.Za(),t.enableUpdateRender()})},Pa(t){V3(t,this)}});class OM{constructor(t){this.Xm=t,this.Ym=0,this.lv="";t=this.Xm.parent.parent.Zm(this.Xm.FID);this.Ti=t.qs.Ti[0],this.qm=t.getArea()}get renderNode(){return this.Km}}Object.assign(OM.prototype,{Jm(r){return new Promise((i,t)=>{if(this.$m)i();else if(r){let e=[];this.Ti.forEach(t=>{e.push(t.x,t.y)});var s=new ArrayBuffer(8*e.length);new Float64Array(s).set(e),r.Ga({type:"maxInnerRect",coords:s},[s]).then(t=>{this.$m=t.result.rect,i()})}else this.$m=D3.maxInnerRect(this.Ti),i()})},Qt(){this.Km&&(this.Km=null,this.Ti=null)},Qm(t){var e=this.$m;let i=e.size.x,s=e.size.y;return i<=0||s<=0?{x:1,y:1}:(i/s<(t=t.width/t.height)?s=i/t:i=s*t,{x:i/e.size.x,y:s/e.size.y})},Bu(t){var e;"MeshBasicMaterial"===t.type&&0<this.Xm.tg.length&&(e=new Ph(this.$m.size.x,this.$m.size.y,1,1),this.Km=new L(e,t),this.Km.renderOrder=10,this.Ym=0,this.eg=this.Xm.qs.mi.center,this.Km.rotation.set(-Math.PI/2,0,0,"XYZ"),this.ig(t))},ig(i){if(this.Km&&i&&"MeshBasicMaterial"===i.type&&i.map){this.Km.material=i;var s=this.Xm.X0;let t=this.Qm(i.map.image);s.sizes&&(i=s.sizes.split(","),t={x:t.x*parseFloat(i[0]),y:t.y*parseFloat(i[1])});i=void 0!==s.angle?s.angle:0,i=(this.Km.scale.set(t.x,t.y,1),this.Km.rotation.z=-i*Math.PI/180,this.Xm.st);let e=[this.$m.center.x-i.x,i.y-this.$m.center.y];s.coords&&(s=s.coords.split(","),e=[parseFloat(s[0])-i.x,i.y-parseFloat(s[1])]),this.Xm?.Zs?.position.set(e[0],this.Xm.qs.height+.01,e[1])}}});let UM=Object.freeze({Cubic:Object.freeze({In:function(t){return t*t*t},Out:function(t){return--t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}})});class FM extends lM{constructor(t,e){super(),this.qs=t,this.st=e,this.Ai=p.LABEL,this.X0=null,this.sg=null,this.sn=!1,this.Of=null,e.nt.F0===L3.ENAME?this.tg=t.ename:e.nt.F0===L3.FID?this.tg=t.fid:this.tg=t.name,this.tg||(this.tg="",this.sn=!0),this.rg=e.Ls.HDText,!0===this.rg&&nt.environment===I.BROWSER&&(this.ng=new nt.LabelCollection,this.Xm=null),this.ag=null,this.hg=!0,this.og=!0,this.lg=!0,this.ug=!0,this.cg=!0,this.fg=!0,this.dg={show:!1},this.ja=this.st.getMapOptions().labelFade,this.Q0=this.Q0.bind(this),this.vg=new an,this.Cm=void 0}get bindBuildingID(){return this.Cm}get FID(){return this.qs.fid}get typeID(){return this.qs.type}get name(){return this.qs.name}get eName(){return this.qs.ename}get text(){return this.tg}set text(t){t?(this.tg=t,this.sn=!1):(this.tg="",this.sn=!0),this.Zs&&(this.Pr(),this.xf()),this.cg=!0,this.fg=!0}set fontSize(t){this.ag=t,this.ag?this.X0&&(this.X0.fontsize=this.ag):this.fd(this.st.Wt,this.st.Wt.dd),this.Zs&&this.Pr(),this.cg=!0,this.fg=!0}get fontSize(){return this.ag||this.X0.fontsize}setText(t){this.text=t}get fading(){return!this.vg.H}get initTargetShow(){return this.og}set initTargetShow(t){t!==this.og&&(this.og=t,this.fg=!0)}get collisionTargetShow(){return this.ug}set collisionTargetShow(t){t!==this.ug&&(this.ug=t,this.cg=!0)}}Object.assign(FM.prototype,{iv(t){this.Cm=t},zv(){this.st.ot.ht(this.vg)},Ya(){if(this.ja&&(!1!==this.fg||0!=this.cg)){let t=null;var e;this.og&&this.ug&&!this.dg.show&&(t=this.pg(0,1)),(t=this.og&&this.ug&&this.dg.show?this.pg(1,1):this.og&&this.ug||!this.dg.show?(e=this.fg?this.Q0:null,this.pg(0,0,e)):(e=this.fg?this.Q0:null,this.pg(1,0,e)))&&(this.fg&&(this.fg=!1,this.hg=this.og),this.cg)&&(this.cg=!1,this.lg=this.ug),"1"!==this.X0?.mode||this.og||this.Q0()}},mg(t){return this.fontSize=t,new Promise(t=>{!1===this.rg&&t(),this.readyCallback=t})},gg(){return new Promise(t=>{!1===this.rg||this.rg&&this.Zs&&1<this.Zs.children.length?t():this.readyCallback=t})},_g(a,t){if(a&&t){this.ng||(this.ng=new nt.LabelCollection,this.Xm=null);let{width:e,drawTextWidth:i,drawTextLeft:s}=t;t=this.fontSize;this.ng.map=a;let r,n=(this.Xm?(r=this.Xm).labelMeshInstance&&(this.Zs.remove(r.labelMeshInstance.mesh),this.Zs.remove(r.labelOutlineMeshInstance.mesh)):(r=this.ng.add(),this.Xm=r),r.wg=!0,r.Mg=[],r.yg=!0,r.rootNode=this.Zs,r.text=this.tg,r.font=t+"px "+(this.X0.fontFamily||'"Microsoft Yahei","",Tahoma,Arial'),r.Eg=nn.rgbToArray(this.X0.fillColor),r.xg=Rm.Center,this.X0.image&&""!==this.X0.image&&(r.xg=Rm.Left),r.outlineWidth=void 0!==this.X0.strokeWidth?2*this.X0.strokeWidth:4,r.outlineColor=nn.rgbToArray(this.X0.strokeColor),r.pixelRatio=a.bt.renderer.getPixelRatio(),this.Zs?.children[0]&&(this.Zs.children[0].visible=!1),()=>{var t;this.ng.update(),!1===r.wg&&(t=(s+i/2-e/2)/2/1.2,r.pixelOffset=[t,0],a.enableUpdateRender(),a.off("update",n),this.readyCallback&&this.readyCallback(),this.Zs?.children[0])&&(this.Zs.children[0].visible=!0)});this.bg=n,a.on("update",n),a.on("pixelRatioChanged",()=>{r.pixelRatio=a.bt.renderer.getPixelRatio()})}},Sg(){var t=this.E0();t.userData.opacity=t.opacity,this.Ag&&this.Ag.Qt();let e=new x3(t);e.scale.set(0,0,0),e.visible=!this.rg,this.Zs.add(e),e.frustumCulledFailCallback=()=>{this.Zs&&this.Zs.children.forEach(t=>{t!==e&&(t.visible=!0)})},e.frustumCulledSuccCallback=()=>{this.Zs&&this.Zs.children.forEach(t=>{t!==e&&(t.visible=!1)})};var t=(e.mapNode=this).ur(v).P.P,i=this.qs.Ti[0],i=new Gt(i.x-t.t,-i.y+t.o,0).applyEuler(new Ps(Math.PI/2,0,0,"XYZ")).add(new Gt(0,this.qs.height,0));this.Zs.position.copy(i)},initTopMesh(){this.Ag||(this.Ag=new OM(this,this.st)),this.Ag.Jm(this.st.Wt.Tg).then(()=>{var t;this.Zs&&"1"===this.X0?.mode&&((t=this.E0()).opacity=1,t.userData.opacity=t.opacity,this.Zs.visible=!0,this.Ag?.Bu(t),this.Ag?.renderNode)&&((this.Ag.renderNode.mapNode=this).Zs.add(this.Ag.renderNode),this.st.enableUpdateNode())})},Bu(){var t;this.Zs||(t=this.ur(v).P.P,this.fd(this.st.Wt,t.Wt.dd),this.Zs=new L0,"1"===(this.Zs.mapNode=this).X0.mode?(this.rg=!1,this.Xm&&(this.Xm.labelMeshInstance&&(this.Zs.remove(this.Xm.labelMeshInstance.mesh),this.Zs.remove(this.Xm.labelOutlineMeshInstance.mesh)),this.Xm=null,t.off("update",this.bg)),0<this.tg.length&&this.initTopMesh()):(this.rg=t.Ls.HDText,this.Sg()),this.Pa(this.st.Wt),this.P.xa.add(this.Zs),this.Of&&this.Of.Bu(this))},z0(t,e){this.Zs&&(this.fg=!0,this.cg=!0,this.fd(t,e),this.Pr())},Pr(){var t,e;this.Zs&&(this.Zs.children[0]?this.ur(E)&&(t="1"===this.X0.mode?"Mesh":"Sprite","Mesh"===(e=this.Zs.children[0].type)&&"Mesh"!=t||"Sprite"===e&&"Sprite"!=t?(this.Q0(),this.Bu()):this.E0(t=>{var e;this.Zs&&(e=this.Zs.children[0].material,this.Zs.children[0].material=t,e.map&&(e.map.dispose(),e.map=null),e.dispose())})):this.Ag&&(this.Q0(),this.st.enableUpdateNode()))},pg(i=0,s=1,t){if(!this.Zs||this.Zs.children.length<1)return null;if(this.tg.length<1)return this.Zs.visible=!1,null;var e=this.ur(v);let r=this.X0.alpha*e.Kr;if(void 0!==this.ir&&(r=this.ir),this.c0&&(r=this.y0),1===s&&(this.Zs.visible=!0),i===s){e=0===i?0:r;if(this.Zs.children[0].material.opacity===e)return 1;0===(i=this.Zs.children[0].material.opacity)&&0==s?s=0:1===i&&1===s&&(s=e)}this.vg.stop(),this.dg.show=1==s;e="1"!==this.X0?.mode;return e||(s=1),this.st.bi.controls.activeing&&e?(1===i?i=r:1===s&&(s=r),this.vg.Y([i]).Z([s]).K(.2).J(t=>{let e=t.destination[0];this.Zs.children.forEach(t=>{t.material.opacity=e,this.st.enableUpdateRender()});t=UM.Cubic.In(e/Math.max(i,s));this.Xm&&(this.Xm.opacity=Math.min(t,s))}).$(()=>{t&&t(this),this.st.ot.ht(this.vg)}).X(),this.st.ot.lt(this.vg)):(this.Zs.visible=1==s,this.Zs.children.forEach(t=>{t.material.opacity=r}),this.Xm&&(this.Xm.opacity=r),this.st.enableUpdateRender()),1},E0(e){var t=this.ur(v);let i={scale:2,needSize:!0,opacity:this.X0.alpha*t.Kr,drawText:!this.rg};void 0!==this.ir&&(i.opacity=this.ir),this.c0&&(i.opacity=this.y0),this.X0.image&&(i.imageUrl=this.sg+this.X0.image);t=this.st.Wt.pl;let s="1"===this.X0.mode?t.cu:t.ou;return(s=s.bind(t))(this.tg,this.X0,i,t=>{e&&e(t),this.ja&&(t.opacity=0,this.fg=!0,this.cg=!0,this.Ya()),this.Zs&&this.Pa(this.st.Wt),void 0!==i.imageUrl&&this.st.Wt.Za(),nt.environment===I.WX&&this.st.Wt.Za(),this.Ag&&this.Ag.ig(t),!0===this.rg?(t.map&&(t.map.minFilter=Jt,t.map.magFilter=Jt),this._g(this.st,t.map?.image),this.Xm&&(this.Xm.opacity=t.opacity)):this.readyCallback&&this.readyCallback(),this.Ya(1),this.st.enableUpdateRender()})},Pa(t){var e,i,s=this.Zs.children[0];s&&s.material.map&&s.material.map.image&&(e=s.material).userData.mspriteScale&&(t=t.B0(this.fontSize),i=2*this.fontSize*1.2,i=e.map.image.height/i,e.userData.mspriteScale=Math.max(i,e.userData.mspriteScale),s.scale.set(t,t,t),s.scale.multiplyScalar(e.userData.mspriteScale),s.scale.setX(s.scale.x/e.userData.scaleRatio))},fd(t,e){var i=this.ur(rh);this.X0=e.tc({fid:this.qs.fid,typeID:this.qs.type+"",bid:i.Ht}),this.ag&&(this.X0.fontsize=this.ag),this.sg=t.zf(this.X0,"path",i.buildingID),parseInt(this.fontSize)},updateMaterialByThemeTool(t){this.X0=t;var t=this.ur(v).P,e=t.P.Wt;this.sg=e.zf(this.X0,"path",t.buildingID),this.Pr()}});class BM extends sh{constructor(t){super(),this.Jt=void 0!==(t=t||{}).height?t.height:1,this.t=t.x,this.o=t.y,this.Zs=null,this.dv=!1,this.Wv=void 0,this.Rg=t.userID,void 0===this.Rg&&(this.Rg=""+nn.generateUUID()),this.ar=!0,this.qs={minlevel:1,maxlevel:29}}set userID(t){this.Rg=t}get userID(){return this.Rg}get isInit(){return this.dv}set isInit(t){this.dv=t}get isbloom(){return this.Wv}set isbloom(t){this.Wv=t}get x(){return this.t}get y(){return this.o}get height(){return this.Jt}set height(t){this.Jt=t,this.Lg()}get level(){var t=this.ur(v);return t?t.level:null}get visible(){return this.Qs}set visible(t){this.Qs=t,this.Zs&&(this.Zs.visible=this.Qs,t=this.ur(E))&&t.enableUpdateRender()}get opacity(){return this.Kr}set opacity(t){this.Kr=t,this.Zs&&(this.Zs.material.opacity=this.Kr)}get isMarker(){return!0}get zoomRange(){return[this.qs.minlevel,this.qs.maxlevel]}set zoomRange(t){this.qs.minlevel=t[0],this.qs.maxlevel=t[1];t=this.ur(E);t&&t.collisionCheck()}get bound(){return[p.IMAGE_MARKER,p.DOM_MARKER,p.DYNAMIC_MODEL_MARKER,p.LOCATION_MARKER,p.TEXT_MARKER].find(t=>t===this.Ai)?!0===this.needUpdateBound&&(this.mi.reset(),void 0!==this.t)&&void 0!==this.o&&(this.mi.expandByCoords([{x:this.t,y:this.o}]),this.needUpdateBound=!1):!0===this.needUpdateBound&&(this.mi.reset(),this.mi.expandByCoords(this.Id),this.needUpdateBound=!1),this.mi.clone()}addTo(t){t.getOrCreateLayer(this.Ai).add(this),this.Zs&&(this.Zs?.updateMatrixWorld(!0),this.Zs?.parent?.updateMatrixWorld(!0))}remove(){var t=this.ur(E);this.P&&this.P.remove(this),t&&t.enableUpdateRender()}dispose(){this.remove(),this.Zs&&(this.Zs.traverse(t=>{t instanceof L&&(t.geometry.dispose(),t.geometry=void 0,Array.isArray(t.material)?t.material.forEach(t=>{this.Cg(t)}):this.Cg(t.material)),"SkinnedMesh"===t.type&&(t.skeleton.boneTexture&&t.skeleton.boneTexture.dispose(),t.skeleton.dispose())}),this.Zs.mapNode=void 0,this.Zs=void 0),this.dv=!1}}Object.assign(BM.prototype,{Cg(t){if(t){if(t instanceof Gm){var e,i=t.uniforms;for(e in i)i[e]&&i[e].value instanceof c&&i[e].value.dispose();t.dispose()}else for(var s in t)t[s]&&t[s]instanceof c&&t[s].dispose();t.dispose()}},Ng(){var t;void 0!==this.t&&void 0!==this.o||(t=this.ur(v),this.t=t.center.x,this.o=t.center.y)},Bu(){return!1},Lg(){}});var kM={exports:{}},GM=(kM.exports,(t=>{function s(t,e){var i=t.length-1,s=[t[0]];return function t(e,i,s,r,n){for(var a,h,o,l,u,c,f,d=r,v=i+1;v<s;v++){h=e[v],p=e[s],f=c=u=l=void 0,u=(o=e[i]).x,o=o.y,c=p.x-u,f=p.y-o,0==c&&0==f||(1<(l=((h.x-u)*c+(h.y-o)*f)/(c*c+f*f))?(u=p.x,o=p.y):0<l&&(u+=c*l,o+=f*l));var p=(c=h.x-u)*c+(f=h.y-o)*f;d<p&&(a=v,d=p)}r<d&&(1<a-i&&t(e,i,a,r,n),n.push(e[a]),1<s-a)&&t(e,a,s,r,n)}(t,0,i,e,s),s.push(t[i]),s}function e(t,e,i){return t.length<=2||(e=void 0!==e?e*e:1,t=s(t=i?t:((t,e)=>{for(var i,s,r,n,a=t[0],h=[a],o=1,l=t.length;o<l;o++)i=t[o],r=a,n=void 0,(n=(s=i).x-r.x)*n+(s=s.y-r.y)*s>e&&(h.push(i),a=i);return a!==i&&h.push(i),h})(t,e),e)),t}t.exports=e,t.exports.default=e})(kM),kM.exports),HM=oa(GM);class VM extends Nh{constructor(){super(),this.isMeshLine=!0,this.type="MeshLine",this.positions=[],this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[],this.counters=[],this.Id=[],this.Ig=null,this.widthCallback=null,this.totalLength=0,this.matrixWorld=new Ht,Object.defineProperties(this,{geometry:{enumerable:!0,get:function(){return this}},geom:{enumerable:!0,get:function(){return this.Ig},set:function(t){this.setGeometry(t,this.widthCallback)}},points:{enumerable:!0,get:function(){return this.Id},set:function(t){this.setPoints(t,this.widthCallback)}}})}}function zM(t,e){var i=new Ht,s=new Ja,r=new Er,n=new Gt,a=this.geometry;if(a.boundingSphere||a.computeBoundingSphere(),r.copy(a.boundingSphere),r.applyMatrix4(this.matrixWorld),!1!==t.ray.intersectSphere(r,n)){i.copy(this.matrixWorld).invert(),s.copy(t.ray).applyMatrix4(i);var h=new Gt,o=new Gt,l=new Gt,u=this instanceof Kg?2:1,r=a.index,i=a.attributes;if(null!==r)for(var c=r.array,f=i.position.array,d=0,v=c.length-1;d<v;d+=u){var p,m=c[d],g=c[d+1];h.fromArray(f,3*m),o.fromArray(f,3*g),m=this.material.fmmap,g=this.material.lineWidth/4,p=void 0,p={x:nt.document.body.clientWidth/2,y:nt.document.body.clientHeight/2},g={x:p.x+g,y:p.y},p=aa.coordsScreenToMap(m,p),m=aa.coordsScreenToMap(m,g),g=(p.x-m.x)*(p.x-m.x)+(p.y-m.y)*(p.y-m.y);g<s.distanceSqToSegment(h,o,n,l)||(n.applyMatrix4(this.matrixWorld),(p=t.ray.origin.distanceTo(n))<t.near)||p>t.far||(e.push({distance:p,point:l.clone().applyMatrix4(this.matrixWorld),index:d,face:null,faceIndex:null,object:this}),d=v)}}}function WM(t,e,i,s,r){var n;if(t=t.subarray||t.slice?t:t.buffer,i=i.subarray||i.slice?i:i.buffer,t=e?t.subarray?t.subarray(e,r&&e+r):t.slice(e,r&&e+r):t,i.set)i.set(t,s);else for(n=0;n<t.length;n++)i[n+s]=t[n]}VM.prototype.setMatrixWorld=function(t){this.matrixWorld=t},VM.prototype.setGeometry=function(t,e){this.Pg=t,this.setPoints(t.getAttribute("position").array,e)},VM.prototype.setPoints=function(e,i){if(e instanceof Float32Array||e instanceof Array){this.Id=e,this.totalLength=0,this.widthCallback=i,this.positions=[],this.counters=[];let t=!0;if(0!==e.length){if(e.length&&e[0]instanceof Gt)for(var s=0;s<e.length;s++){var r=e[s];if(isNaN(""+r.x)||isNaN(""+r.y)||isNaN(""+r.z)){t=!1;break}var n,a,h=s/e.length;this.positions.push(r.x,r.y,r.z),this.positions.push(r.x,r.y,r.z),this.counters.push(h),this.counters.push(h),0<s&&(r=e[s].x-e[s-1].x,n=e[s].y-e[s-1].y,a=e[s].z-e[s-1].z,this.totalLength=this.totalLength+Math.sqrt(r*r+n*n+a*a))}else for(s=0;s<e.length;s+=3){var o,l,u,h=s/e.length;if(isNaN(""+e[s])||isNaN(""+e[s+1])||isNaN(""+e[s+2])){t=!1;break}this.positions.push(e[s],e[s+1],e[s+2]),this.positions.push(e[s],e[s+1],e[s+2]),this.counters.push(h),this.counters.push(h),0<s&&(o=e[s]-e[u=s-3],l=e[s+1]-e[1+u],u=e[s+2]-e[2+u],this.totalLength=this.totalLength+Math.sqrt(o*o+l*l+u*u))}t&&this.process()}}else console.error("ERROR: The BufferArray of points is not instancied correctly.")},VM.prototype.raycast=zM,VM.prototype.compareV3=function(t,e){t*=6,e*=6;return this.positions[t]===this.positions[e]&&this.positions[1+t]===this.positions[1+e]&&this.positions[2+t]===this.positions[2+e]},VM.prototype.copyV3=function(t){t*=6;return[this.positions[t],this.positions[1+t],this.positions[2+t]]},VM.prototype.process=function(){var t,e=this.positions.length/6;this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[],t=this.compareV3(0,e-1)?this.copyV3(e-2):this.copyV3(0),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]);let i=0;for(var s,r,n,a=0;a<e;a++)this.side.push(1),this.side.push(-1),n=this.widthCallback?this.widthCallback(a/(e-1)):1,this.width.push(n),this.width.push(n),a<e-1&&(t=this.copyV3(a),this.previous.push(t[0],t[1],t[2]),this.previous.push(t[0],t[1],t[2]),this.indices_array.push(n=2*a,1+n,2+n),this.indices_array.push(2+n,1+n,3+n)),0<a&&(t=this.copyV3(a),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]),n=this.copyV3(a-1),s=t[0]-n[0],r=t[1]-n[1],n=t[2]-n[2],i+=Math.sqrt(s*s+r*r+n*n)),this.uvs.push(i/this.totalLength,0),this.uvs.push(i/this.totalLength,1);t=this.compareV3(e-1,0)?this.copyV3(1):this.copyV3(e-1),this.next.push(t[0],t[1],t[2]),this.next.push(t[0],t[1],t[2]),this.Dg&&this.Dg.position.count===this.positions.length?(this.Dg.position.copyArray(new Float32Array(this.positions)),this.Dg.position.needsUpdate=!0,this.Dg.previous.copyArray(new Float32Array(this.previous)),this.Dg.previous.needsUpdate=!0,this.Dg.next.copyArray(new Float32Array(this.next)),this.Dg.next.needsUpdate=!0,this.Dg.side.copyArray(new Float32Array(this.side)),this.Dg.side.needsUpdate=!0,this.Dg.width.copyArray(new Float32Array(this.width)),this.Dg.width.needsUpdate=!0,this.Dg.uv.copyArray(new Float32Array(this.uvs)),this.Dg.uv.needsUpdate=!0,this.Dg.index.copyArray(new Uint16Array(this.indices_array)),this.Dg.index.needsUpdate=!0):this.Dg={position:new N(new Float32Array(this.positions),3),previous:new N(new Float32Array(this.previous),3),next:new N(new Float32Array(this.next),3),side:new N(new Float32Array(this.side),1),width:new N(new Float32Array(this.width),1),uv:new N(new Float32Array(this.uvs),2),index:new N(new Uint16Array(this.indices_array),1),counters:new N(new Float32Array(this.counters),1)},this.setAttribute("position",this.Dg.position),this.setAttribute("previous",this.Dg.previous),this.setAttribute("next",this.Dg.next),this.setAttribute("side",this.Dg.side),this.setAttribute("width",this.Dg.width),this.setAttribute("uv",this.Dg.uv),this.setAttribute("counters",this.Dg.counters),this.setIndex(this.Dg.index),this.computeBoundingSphere(),this.computeBoundingBox()},VM.prototype.advance=function(t){var e=this.Dg.position.array,i=this.Dg.previous.array,s=this.Dg.next.array,r=e.length;WM(e,0,i,0,r),WM(e,6,e,0,r-6),e[r-6]=t.x,e[r-5]=t.y,e[r-4]=t.z,e[r-3]=t.x,e[r-2]=t.y,e[r-1]=t.z,WM(e,6,s,0,r-6),s[r-6]=t.x,s[r-5]=t.y,s[r-4]=t.z,s[r-3]=t.x,s[r-2]=t.y,s[r-1]=t.z,this.Dg.position.needsUpdate=!0,this.Dg.previous.needsUpdate=!0,this.Dg.next.needsUpdate=!0},b.meshline_vert=["",b.common,b.logdepthbuf_pars_vertex,b.fog_pars_vertex,"","attribute vec3 previous;","attribute vec3 next;","attribute float side;","attribute float width;","attribute float counters;","","uniform vec2 resolution;","uniform float lineWidth;","uniform vec3 color;","uniform float opacity;","uniform float sizeAttenuation;","uniform vec2 offset;","","varying vec2 vUV;","varying vec4 vColor;","varying float vCounters;","varying vec2 vUvPass;","","vec2 fix( vec4 i, float aspect ) {","","    vec2 res = i.xy / i.w;","    res.x *= aspect;","\t vCounters = counters;","    return res;","","}","","void main() {","","    float aspect = resolution.x / resolution.y;","","    vColor = vec4( color, opacity );","    vUV = uv + offset;","\t vUvPass=uv;","","    mat4 m = projectionMatrix * modelViewMatrix;","    vec4 finalPosition = m * vec4( position, 1.0 );","    vec4 prevPos = m * vec4( previous, 1.0 );","    vec4 nextPos = m * vec4( next, 1.0 );","","    vec2 currentP = fix( finalPosition, aspect );","    vec2 prevP = fix( prevPos, aspect );","    vec2 nextP = fix( nextPos, aspect );","","    float w = lineWidth * width;","","    vec2 dir;","    if( nextP == currentP ) dir = normalize( currentP - prevP );","    else if( prevP == currentP ) dir = normalize( nextP - currentP );","    else {","        vec2 dir1 = normalize( currentP - prevP );","        vec2 dir2 = normalize( nextP - currentP );","        dir = normalize( dir1 + dir2 );","","        vec2 perp = vec2( -dir1.y, dir1.x );","        vec2 miter = vec2( -dir.y, dir.x );","        //w = clamp( w / dot( miter, perp ), 0., 4. * lineWidth * width );","","    }","","    //vec2 normal = ( cross( vec3( dir, 0. ), vec3( 0., 0., 1. ) ) ).xy;","    vec4 normal = vec4( -dir.y, dir.x, 0., 1. );","    normal.xy *= .5 * w;","    normal *= projectionMatrix;","    if( sizeAttenuation == 0. ) {","        normal.xy *= finalPosition.w;","        normal.xy /= ( vec4( resolution, 0., 1. ) * projectionMatrix ).xy;","    }","","    finalPosition.xy += normal.xy * side;","","    gl_Position = finalPosition;","",b.logdepthbuf_vertex,"    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",b.fog_vertex,"}"].join("\n"),b.meshline_frag=["",b.fog_pars_fragment,b.logdepthbuf_pars_fragment,"","uniform sampler2D map;","uniform sampler2D alphaMap;","uniform float useMap;","uniform float useAlphaMap;","uniform float useDash;","uniform float dashArray;","uniform float dashOffset;","uniform float dashRatio;","uniform float visibility;","uniform float alphaTest;","uniform vec2 repeat;","uniform bool ispassed;","uniform vec3 passColor;","uniform float currentPercent;","uniform float beginPercent;","uniform float endPercent;","uniform bool isGradient;","uniform mat3 uvTransform;","uniform float gradientPercent[{num}];","uniform vec4 gradientColor[{num}];","uniform float gradientBegin;","uniform float gradientEnd;","uniform bool isArrow;","uniform bool usePassOpacity;","uniform float passOpacity;","uniform bool zFighting;","","varying vec2 vUV;","varying vec4 vColor;","varying float vCounters;","varying vec2 vUvPass;","","void main() {","",b.logdepthbuf_fragment,"","    vec4 c = vColor;","\t vec4 gColor=vec4(0.0,0.0,0.0,0.0);","    if(isGradient){","\t\tfloat value = gradientBegin + vUvPass.x * (gradientEnd - gradientBegin);","\t\tvec4 colorBegin=gradientColor[0];","\t\tvec4 colorEnd=gradientColor[0];","\t\tfloat bPercent=gradientPercent[0];","       float ePercent=gradientPercent[0];","\t\tfor(int i=0;i<{num};i++){","\t\t\tif(value>=gradientPercent[i]){","\t\t\t\tcolorBegin=gradientColor[i];","\t\t\t\tcolorEnd=gradientColor[i];","\t\t\t\tbPercent=gradientPercent[i];","\t\t\t\tePercent=gradientPercent[i];","\t\t\t\tif(i+1<={num}-1){","\t\t\t\t\tcolorEnd=gradientColor[i+1];","\t\t\t\t\tePercent=gradientPercent[i+1];","\t\t\t\t}","\t\t\t}","\t\t}","\t\tfloat perCent=(value-bPercent)/(ePercent-bPercent);","\t\tgColor=mix(colorBegin,colorEnd,perCent);","\t }","    if( useMap == 1. ) {","   vec2 uvRepet = vUV * repeat;","   vec2 uvRotation = ( uvTransform * vec3( uvRepet, 1.0 ) ).xy;","\t \tc = texture2D( map, uvRotation );","\t\tif(isArrow){","    \t\tc=c+gColor;","\t\t} else {","\t\t\tif(isGradient){","\t\t\t\tc.rgb=gColor.rgb;","\t\t\t}","\t\t}","\t } else {","       c = vColor;","\t\tif(isGradient){","\t\t\tc=gColor;","\t\t\tc.a=vColor.a;","\t\t}","\t }","\t bool isPassed2=false;","\t if(ispassed) {","\t\tif(currentPercent>=endPercent){","\t\t\tc=vec4(passColor,vColor.a);","\t\t\tisPassed2=true;","\t\t} else {","\t\t\tif((endPercent-currentPercent)<(1.0-vUvPass.x)*(endPercent-beginPercent)){","\t\t\t\tc=vec4(passColor,vColor.a);","\t\t\t\tisPassed2=true;","\t\t\t}","\t\t}","\t }","\t if(zFighting && !isPassed2){","\t\tdiscard;","\t }","    if( useAlphaMap == 1. ) c.a *= texture2D( alphaMap, vUV * repeat ).a;","    if( c.a < alphaTest ) discard;","    if( useDash == 1. ){","        c.a *= ceil(mod(vCounters + dashOffset, dashArray) - (dashArray * dashRatio));","    }","    gl_FragColor = c;","    gl_FragColor.a *= step(vCounters, visibility);","\t if(usePassOpacity&&isPassed2){","\t\tgl_FragColor.a=passOpacity;","\t\tif(passOpacity<0.1){","\t\t\tdiscard;","\t\t}","\t }","",b.fog_fragment,"}"].join("\n");class jM extends zh{constructor(t,e,i){super({uniforms:Object.assign({},P.fog,{lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},color:{value:new Wt(16777215)},opacity:{value:1},resolution:{value:new ct(1,1)},sizeAttenuation:{value:1},dashArray:{value:0},dashOffset:{value:0},dashRatio:{value:.5},useDash:{value:0},visibility:{value:1},alphaTest:{value:0},repeat:{value:new ct(1,1)},offset:{value:new ct(1,1)},ispassed:{value:!1},passColor:{value:new Wt(16777215)},currentPercent:{value:0},beginPercent:{value:0},endPercent:{value:0},isGradient:{value:!1},gradientPercent:{value:[]},gradientColor:{value:[]},gradientBegin:{value:0},gradientEnd:{value:0},isArrow:{value:!1},usePassOpacity:{value:!1},passOpacity:{value:1},zFighting:{value:!1}}),vertexShader:b.meshline_vert,fragmentShader:b.meshline_frag.replace(/{num}/g,""+e)}),this.depthTest=t.depthTest,this.isMeshLineMaterial=!0,this.type="MeshLineMaterial",this.fmmap=i,this.uniforms.uvTransform={value:new _},Object.defineProperties(this,{lineWidth:{enumerable:!0,get:function(){return this.uniforms.lineWidth.value},set:function(t){this.uniforms.lineWidth.value=t}},map:{enumerable:!0,get:function(){return this.uniforms.map.value},set:function(t){t&&(this.uniforms.map.value=t,this.uniforms.uvTransform.value=t.matrix)}},useMap:{enumerable:!0,get:function(){return this.uniforms.useMap.value},set:function(t){this.uniforms.useMap.value=t}},alphaMap:{enumerable:!0,get:function(){return this.uniforms.alphaMap.value},set:function(t){this.uniforms.alphaMap.value=t}},useAlphaMap:{enumerable:!0,get:function(){return this.uniforms.useAlphaMap.value},set:function(t){this.uniforms.useAlphaMap.value=t}},color:{enumerable:!0,get:function(){return this.uniforms.color.value},set:function(t){this.uniforms.color.value=t}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}},sizeAttenuation:{enumerable:!0,get:function(){return this.uniforms.sizeAttenuation.value},set:function(t){this.uniforms.sizeAttenuation.value=t}},dashArray:{enumerable:!0,get:function(){return this.uniforms.dashArray.value},set:function(t){this.uniforms.dashArray.value=t,this.useDash=0!==t?1:0}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(t){this.uniforms.dashOffset.value=t}},dashRatio:{enumerable:!0,get:function(){return this.uniforms.dashRatio.value},set:function(t){this.uniforms.dashRatio.value=t}},useDash:{enumerable:!0,get:function(){return this.uniforms.useDash.value},set:function(t){this.uniforms.useDash.value=t}},visibility:{enumerable:!0,get:function(){return this.uniforms.visibility.value},set:function(t){this.uniforms.visibility.value=t}},alphaTest:{enumerable:!0,get:function(){return this.uniforms.alphaTest.value},set:function(t){this.uniforms.alphaTest.value=t}},repeat:{enumerable:!0,get:function(){return this.uniforms.repeat.value},set:function(t){this.uniforms.repeat.value.copy(t)}},offset:{enumerable:!0,get:function(){return this.uniforms.offset.value},set:function(t){this.uniforms.offset.value.copy(t)}},ispassed:{enumerable:!0,get:function(){return this.uniforms.ispassed.value},set:function(t){this.uniforms.ispassed.value=t}},beginPercent:{enumerable:!0,get:function(){return this.uniforms.beginPercent.value},set:function(t){this.uniforms.beginPercent.value=t}},endPercent:{enumerable:!0,get:function(){return this.uniforms.endPercent.value},set:function(t){this.uniforms.endPercent.value=t}},currentPercent:{enumerable:!0,get:function(){return this.uniforms.currentPercent.value},set:function(t){this.uniforms.currentPercent.value=t}},passColor:{enumerable:!0,get:function(){return this.uniforms.passColor.value},set:function(t){this.uniforms.passColor.value=t}},gradientPercent:{enumerable:!0,get:function(){return this.uniforms.gradientPercent.value},set:function(t){this.uniforms.gradientPercent.value=t}},gradientColor:{enumerable:!0,get:function(){return this.uniforms.gradientColor.value},set:function(t){this.uniforms.gradientColor.value=t}},isGradient:{enumerable:!0,get:function(){return this.uniforms.isGradient.value},set:function(t){this.uniforms.isGradient.value=t}},gradientBegin:{enumerable:!0,get:function(){return this.uniforms.gradientBegin.value},set:function(t){this.uniforms.gradientBegin.value=t}},gradientEnd:{enumerable:!0,get:function(){return this.uniforms.gradientEnd.value},set:function(t){this.uniforms.gradientEnd.value=t}},isArrow:{enumerable:!0,get:function(){return this.uniforms.isArrow.value},set:function(t){this.uniforms.isArrow.value=t}},usePassOpacity:{enumerable:!0,get:function(){return this.uniforms.usePassOpacity.value},set:function(t){this.uniforms.usePassOpacity.value=t}},passOpacity:{enumerable:!0,get:function(){return this.uniforms.passOpacity.value},set:function(t){this.uniforms.passOpacity.value=t}},zFighting:{enumerable:!0,get:function(){return this.uniforms.zFighting.value},set:function(t){this.uniforms.zFighting.value=t}}}),this.setValues(t)}}jM.prototype.copy=function(t){return zh.prototype.copy.call(this,t),this.lineWidth=t.lineWidth,this.map=t.map,this.useMap=t.useMap,this.alphaMap=t.alphaMap,this.useAlphaMap=t.useAlphaMap,this.color.copy(t.color),this.opacity=t.opacity,this.resolution.copy(t.resolution),this.sizeAttenuation=t.sizeAttenuation,this.dashArray.copy(t.dashArray),this.dashOffset.copy(t.dashOffset),this.dashRatio.copy(t.dashRatio),this.useDash=t.useDash,this.visibility=t.visibility,this.alphaTest=t.alphaTest,this.repeat.copy(t.repeat),this};var XM={},YM=ZM;function ZM(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t}var qM=KM;function KM(t,e,i){return t[0]=e,t[1]=i,t}var JM=$M;function $M(t,e){var i=e[0],s=e[1],i=i*i+s*s;return 0<i&&(i=1/Math.sqrt(i),t[0]=e[0]*i,t[1]=e[1]*i),t}var QM=ty;function ty(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t}var ey=iy;function iy(t,e){return t[0]*e[0]+t[1]*e[1]}var sy=YM,ry=qM,ny=JM,ay=QM,hy=ey,oy=[0,0],ly=(XM.computeMiter=function(t,e,i,s,r){return sy(t,i,s),ny(t,t),ry(e,-t[1],t[0]),ry(oy,-i[1],i[0]),r/hy(e,oy)},XM.normal=function(t,e){return ry(t,-e[1],e[0]),t},XM.direction=function(t,e,i){return ay(t,e,i),ny(t,t),t},XM),uy=[0,0],cy=[0,0],fy=[0,0],dy=[0,0],vy=function(t,e){for(var i,s,r=null,n=[],a=(e&&(t=t.slice()).push(t[0]),t.length),h=1;h<a;h++){var o=t[h-1],l=t[h],u=h<t.length-1?t[h+1]:null;ly.direction(uy,l,o),r||ly.normal(r=[0,0],uy),1===h&&py(n,r,1),u?(ly.direction(cy,u,l),o=ly.computeMiter(fy,dy,uy,cy,1),py(n,dy,o)):(ly.normal(r,uy),py(n,r,1))}return 2<t.length&&e&&(e=t[a-2],i=t[0],s=t[1],ly.direction(uy,i,e),ly.direction(cy,s,i),ly.normal(r,uy),e=ly.computeMiter(fy,dy,uy,cy,1),n[0][0]=dy.slice(),n[a-1][0]=dy.slice(),n[0][1]=e,n[a-1][1]=e,n.pop()),n};function py(t,e,i){t.push([[e[0],e[1]],i])}var gy=oa(vy);class _y extends Nh{constructor(){super(),this.is2DLine=!0,this.type="FM2DLine"}setPoints(e){var i=[];let s=0;var r,n,a,h=[];for(let t=0;t<e.length;t++)i.push([e[t].x,e[t].z]),h.push(e[t].x,e[t].y,e[t].z),h.push(e[t].x,e[t].y,e[t].z),0<t&&(r=e[t].x-e[t-1].x,n=e[t].y-e[t-1].y,a=e[t].z-e[t-1].z,s+=Math.sqrt(r*r+n*n+a*a));var o,l,u,c=gy(i,!1),f=[],d=[],v=[],p=[];let m=0,g=0;for(let t=0;t<e.length-1;t++){var _=m;v[g++]=_+0,v[g++]=_+1,v[g++]=_+2,v[g++]=_+2,v[g++]=_+1,v[g++]=_+3,m+=2}for(let t=0;t<c.length;t++){var w=c[t],M=w[0],w=w[1];p.push(M[0],M[1]),p.push(M[0],M[1]),f.push(-w),f.push(w)}let y=0;for(let t=0;t<e.length;t++)0<t&&(o=e[t].x-e[t-1].x,l=e[t].y-e[t-1].y,u=e[t].z-e[t-1].z,y+=Math.sqrt(o*o+l*l+u*u)),d.push(y/s,0),d.push(y/s,1);this.setAttribute("position",new N(new Float32Array(h),3)),this.setAttribute("lineNormal",new N(new Float32Array(p),2)),this.setAttribute("uv",new N(new Float32Array(d),2)),this.setAttribute("lineMiter",new N(new Float32Array(f),1)),this.setIndex(new N(new Uint16Array(v),1))}}function wy(i,s){var t=new Ht,r=new Ja,e=new Er,n=new Gt,a=this.geometry;if(a.boundingSphere||a.computeBoundingSphere(),e.copy(a.boundingSphere),e.applyMatrix4(this.matrixWorld),!1!==i.ray.intersectSphere(e,n)){t.copy(this.matrixWorld).invert(),r.copy(i.ray).applyMatrix4(t);var h=new Gt,o=new Gt,l=new Gt,e=a.index,t=a.attributes;if(null!==e){var u=e.array,c=t.position.array;for(let t=0,e=u.length-1;t<e;t+=1){var f=u[t],d=u[t+1],f=(h.fromArray(c,3*f),o.fromArray(c,3*d),this.material.uniforms.lineWidth.value/2),d=(f*=f,r.distanceSqToSegment(h,o,n,l));f<d||(n.applyMatrix4(this.matrixWorld),(f=i.ray.origin.distanceTo(n))<i.near)||f>i.far||(s.push({distance:f,point:l.clone().applyMatrix4(this.matrixWorld),index:t,face:null,faceIndex:null,object:this}),t=e)}}}}b.flatline_vert=["",b.common,b.logdepthbuf_pars_vertex,b.fog_pars_vertex,"","uniform float lineWidth;","attribute float lineMiter;","attribute vec2 lineNormal;","uniform vec2 offset;","varying vec2 vUV;","varying vec2 vUvPass;","void main() {","   vec3 pointPos = position.xyz + vec3(lineNormal.x * lineWidth / 2.0 * lineMiter, 0.0, lineNormal.y * lineWidth / 2.0 * lineMiter);","   vUV = uv + offset;","\tvUvPass=uv;","   gl_Position = projectionMatrix * modelViewMatrix * vec4(pointPos, 1.0);","   vec4 mvPosition = modelViewMatrix * vec4( pointPos, 1.0 );",b.logdepthbuf_vertex,b.fog_vertex,"}"].join("\n"),b.flatline_frag=["",b.fog_pars_fragment,b.logdepthbuf_pars_fragment,"","uniform vec3 color;","uniform float opacity;","uniform sampler2D map;","uniform mat3 uvTransform;","uniform bool isMap;","uniform vec2 repeat;","","uniform bool isGradient;","uniform float gradientPercent[{num}];","uniform vec4 gradientColor[{num}];","uniform float gradientBegin;","uniform float gradientEnd;","uniform bool isArrow;","","uniform bool ispassed;","uniform vec3 passColor;","uniform float currentPercent;","uniform float beginPercent;","uniform float endPercent;","","uniform bool usePassOpacity;","uniform float passOpacity;","uniform bool zFighting;","","varying vec2 vUV;","varying vec2 vUvPass;","","void main() {","",b.logdepthbuf_fragment,"","   vec4 color2;","\tvec4 gColor=vec4(0.0,0.0,0.0,0.0);","   if(isGradient){","\t\tfloat value = gradientBegin + vUvPass.x * (gradientEnd - gradientBegin);","\t\tvec4 colorBegin=gradientColor[0];","\t\tvec4 colorEnd=gradientColor[0];","\t\tfloat bPercent=gradientPercent[0];","       float ePercent=gradientPercent[0];","\t\tfor(int i=0;i<{num};i++){","\t\t\tif(value>=gradientPercent[i]){","\t\t\t\tcolorBegin=gradientColor[i];","\t\t\t\tcolorEnd=gradientColor[i];","\t\t\t\tbPercent=gradientPercent[i];","\t\t\t\tePercent=gradientPercent[i];","\t\t\t\tif(i+1<={num}-1){","\t\t\t\t\tcolorEnd=gradientColor[i+1];","\t\t\t\t\tePercent=gradientPercent[i+1];","\t\t\t\t}","\t\t\t}","\t\t}","\t\tfloat perCent=(value-bPercent)/(ePercent-bPercent);","\t\tgColor=mix(colorBegin,colorEnd,perCent);","\t}","   if(isMap){","       vec2 uvRepet = vUV * repeat;","       vec2 uvRotation = ( uvTransform * vec3( uvRepet, 1.0 ) ).xy;","       color2 = texture2D( map, uvRotation);","\t\tif(isArrow){","    \t\tcolor2 = color2+gColor;","\t\t} else {","\t\t\tif(isGradient){","\t\t\t\tcolor2.rgb=gColor.rgb;","\t\t\t}","\t\t}","   } else {","       color2 = vec4(color,opacity);","\t\tif(isGradient){","           color2.rgb=gColor.rgb;","\t\t}","   }","\tbool isPassed2=false;","\tif(ispassed) {","\t\tif(currentPercent>=endPercent){","\t\t\tcolor2=vec4(passColor,color2.a);","\t\t\tisPassed2=true;","\t\t} else {","\t\t\tif((endPercent-currentPercent)<(1.0-vUvPass.x)*(endPercent-beginPercent)){","\t\t\t\tcolor2=vec4(passColor,color2.a);","\t\t\t\tisPassed2=true;","\t\t\t}","\t\t}","\t}","\tif(zFighting && !isPassed2){","\t    discard;","\t}","   gl_FragColor = color2;","\tif(usePassOpacity && isPassed2){","\t\tgl_FragColor.a=passOpacity;","\t\tif(passOpacity<0.1){","\t\t\tdiscard;","\t\t}","\t}","",b.fog_fragment,"}"].join("\n");class My extends zh{constructor(t,e){super({uniforms:Object.assign({},P.fog,{lineWidth:{value:t.lineWidth},color:{value:t.color},opacity:{value:t.opacity},map:{value:t.map},uvTransform:{value:t.uvTransform},isMap:{value:t.isMap},repeat:{value:new ct(1,1)},offset:{value:new ct(1,1)},isGradient:{value:t.isGradient},gradientPercent:{value:t.gradientPercent},gradientColor:{value:t.gradientColor},gradientBegin:{value:0},gradientEnd:{value:0},isArrow:{value:t.isArrow},ispassed:{value:!1},passColor:{value:t.passColor},currentPercent:{value:0},beginPercent:{value:0},endPercent:{value:0},usePassOpacity:{value:t.usePassOpacity},passOpacity:{value:t.passOpacity},zFighting:{value:t.zFighting}}),vertexShader:b.flatline_vert,fragmentShader:b.flatline_frag.replace(/{num}/g,""+e)}),this.isFlatLineMaterial=!0,this.type="FM2DLineMaterial"}}class yy extends Nh{constructor(){super(),this.isInstancedBufferGeometry=!0,this.type="InstancedBufferGeometry",this.instanceCount=1/0}copy(t){return super.copy(t),this.instanceCount=t.instanceCount,this}toJSON(){var t=super.toJSON();return t.instanceCount=this.instanceCount,t.isInstancedBufferGeometry=!0,t}}class Ey extends z0{constructor(t,e,i=1){super(t,e),this.isInstancedInterleavedBuffer=!0,this.meshPerAttribute=i}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}clone(t){t=super.clone(t);return t.meshPerAttribute=this.meshPerAttribute,t}toJSON(t){t=super.toJSON(t);return t.isInstancedInterleavedBuffer=!0,t.meshPerAttribute=this.meshPerAttribute,t}}class xy extends Nh{constructor(t=null){if(super(),this.type="WireframeGeometry",this.parameters={geometry:t},null!==t){var s=[],r=new Set,n=new Gt,a=new Gt;if(null!==t.index){var h=t.attributes.position,o=t.index;let i=t.groups;for(let t=0,e=(i=0===i.length?[{start:0,count:o.count,materialIndex:0}]:i).length;t<e;++t){var l=i[t],u=l.start;for(let e=u,t=u+l.count;e<t;e+=3)for(let t=0;t<3;t++){var c=o.getX(e+t),f=o.getX(e+(t+1)%3);n.fromBufferAttribute(h,c),a.fromBufferAttribute(h,f),!0===by(n,a,r)&&(s.push(n.x,n.y,n.z),s.push(a.x,a.y,a.z))}}}else{var i=t.attributes.position;for(let e=0,t=i.count/3;e<t;e++)for(let t=0;t<3;t++){var d=3*e+t,v=3*e+(t+1)%3;n.fromBufferAttribute(i,d),a.fromBufferAttribute(i,v),!0===by(n,a,r)&&(s.push(n.x,n.y,n.z),s.push(a.x,a.y,a.z))}}this.setAttribute("position",new ph(s,3))}}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}}function by(t,e,i){var s=`${t.x},${t.y},${t.z}-${e.x},${e.y},`+e.z,e=e.x+`,${e.y},${e.z}-${t.x},${t.y},`+t.z;return!0!==i.has(s)&&!0!==i.has(e)&&(i.add(s),i.add(e),!0)}class Sy extends yy{constructor(){super(),this.type="LineSegmentsGeometry";this.isLineSegmentsGeometry=!0,this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.setAttribute("position",new ph([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.setAttribute("uv",new ph([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2)),this.setAttribute("uv2",new ph([0,0,1,0,0,1/3,1,1/3,0,2/3,1,2/3,0,1,1,1],2))}applyMatrix(t){var e=this.attributes.instanceStart,i=this.attributes.instanceEnd;return void 0!==e&&(t.applyToBufferAttribute(e),t.applyToBufferAttribute(i),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(t){t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var e,t=new Ey(e,6,1);return this.setAttribute("instanceStart",new j0(t,3,0)),this.setAttribute("instanceEnd",new j0(t,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var e,t=new Ey(e,6,1);return this.addAttribute("instanceColorStart",new j0(t,3,0)),this.addAttribute("instanceColorEnd",new j0(t,3,3)),this}setUvys(t){t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var e,t=new Ey(e,2,1);return this.setAttribute("uvyStart",new j0(t,1,0)),this.setAttribute("uvyEnd",new j0(t,1,1)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){return this.fromWireframeGeometry(new xy(t.geometry)),this}fromLineSegements(t){t=t.geometry;return t.isGeometry?this.setPositions(t.vertices):t.isBufferGeometry&&this.setPositions(t.position.array),this}computeBoundingBox(){var t=new rr,e=(null===this.boundingBox&&(this.boundingBox=new rr),this.attributes.instanceStart),i=this.attributes.instanceEnd;void 0!==e&&void 0!==i&&(this.boundingBox.setFromBufferAttribute(e),t.setFromBufferAttribute(i),this.boundingBox.union(t))}computeBoundingSphere(){var t=new Gt,e=(null===this.boundingSphere&&(this.boundingSphere=new Er),null===this.boundingBox&&this.computeBoundingBox(),this.attributes.instanceStart),i=this.attributes.instanceEnd;if(void 0!==e&&void 0!==i){for(var s=this.boundingSphere.center,r=(this.boundingBox.getCenter(s),0),n=0,a=e.count;n<a;n++)t.fromBufferAttribute(e,n),r=Math.max(r,s.distanceToSquared(t)),t.fromBufferAttribute(i,n),r=Math.max(r,s.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("fm.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}clone(){}copy(t){return this}}class Ay extends Sy{constructor(){super(),this.type="LineGeometry",this.isLineGeometry=!0}setPositions(t){for(var e=t.length-3,i=new Float32Array(2*e),s=0;s<e;s+=3)i[2*s]=t[s],i[2*s+1]=t[s+1],i[2*s+2]=t[s+2],i[2*s+3]=t[s+3],i[2*s+4]=t[s+4],i[2*s+5]=t[s+5];return this.test="ddd",(new Sy).setPositions.call(this,i),this}setColors(t){for(var e=t.length-3,i=new Float32Array(2*e),s=0;s<e;s+=3)i[2*s]=t[s],i[2*s+1]=t[s+1],i[2*s+2]=t[s+2],i[2*s+3]=t[s+3],i[2*s+4]=t[s+4],i[2*s+5]=t[s+5];return(new Sy).setColors.call(this,i),this}fromLine(t){t=t.geometry;return t.isGeometry?this.setPositions(t.vertices):t.isBufferGeometry&&this.setPositions(t.position.array),this}copy(t){return this}}let Ty=new Gt,Ry=new Gt;class Ly{constructor(t=new Gt,e=new Gt){this.start=t,this.end=e}set(t,e){return this.start.copy(t),this.end.copy(e),this}copy(t){return this.start.copy(t.start),this.end.copy(t.end),this}getCenter(t){return t.addVectors(this.start,this.end).multiplyScalar(.5)}delta(t){return t.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(t,e){return this.delta(e).multiplyScalar(t).add(this.start)}closestPointToPointParameter(t,e){Ty.subVectors(t,this.start),Ry.subVectors(this.end,this.start);t=Ry.dot(Ry);let i=Ry.dot(Ty)/t;return i=e?Qi(i,0,1):i}closestPointToPoint(t,e,i){t=this.closestPointToPointParameter(t,e);return this.delta(i).multiplyScalar(t).add(this.start)}applyMatrix4(t){return this.start.applyMatrix4(t),this.end.applyMatrix4(t),this}equals(t){return t.start.equals(this.start)&&t.end.equals(this.end)}clone(){return(new this.constructor).copy(this)}}function Cy(t={x:0,y:0,z:0},e={x:0,y:0,z:0},i){t=new Vt(t.x,t.y,t.z,1),e=new Vt(e.x,e.y,e.z,1);return t.applyMatrix4(i.projectionMatrix),e.multiplyScalar(t.w),e.applyMatrix4(i.projectionMatrixInverse),{x:e.x,y:e.y,z:e.z}}class Ny extends L{constructor(t,e){super(t,e),this.type="LineSegments2",this.isLineSegments2=!0}computeLineDistances(){for(var t=new Gt,e=new Gt,i=this.geometry,s=i.attributes.instanceStart,r=i.attributes.instanceEnd,n=new Float32Array(2*s.data.count),a=0,h=0,o=s.data.count;a<o;a++,h+=2)t.fromBufferAttribute(s,a),e.fromBufferAttribute(r,a),n[h]=0===h?0:n[h-1],n[h+1]=n[h]+t.distanceTo(e);var l=new Ey(n,2,1);return i.setAttribute("instanceDistanceStart",new j0(l,1,0)),i.setAttribute("instanceDistanceEnd",new j0(l,1,1)),this}copy(t){return this}raycast(t,i){null===t.camera&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2.');var s=new Vt,r=new Vt,e=new Vt,n=new Gt,a=new Ht,h=new Ly,o=new Gt,l=new rr,u=new Er,c=void 0!==t.params.Line2&&t.params.Line2.threshold||0,f=t.ray,d=t.camera,v=d.projectionMatrix,p=this.matrixWorld,m=this.geometry,g=this.material,_=g.resolution,w=g.uniforms.lineWidth.value+c,M=m.attributes.instanceStart,y=m.attributes.instanceEnd,E=-d.near,g=2*Math.max(w/_.width,w/_.height),c=(null===m.boundingSphere&&m.computeBoundingSphere(),u.copy(m.boundingSphere).applyMatrix4(p),Math.max(d.near,u.distanceToPoint(f.origin))),c=Cy({x:0,y:0,z:-c},{x:g,y:0,z:0},d);if(d.isPerspectiveCamera?c.x/=2:c.x=w/d.zoom,u.radius+=c.x,!1!==t.ray.intersectsSphere(u)){null===m.boundingBox&&m.computeBoundingBox(),l.copy(m.boundingBox).applyMatrix4(p);c=Cy({x:0,y:0,z:-Math.max(d.near,l.distanceToPoint(f.origin))},{x:g,y:0,z:0},d);if(d.isPerspectiveCamera?c.x/=2:c.x=w/d.zoom,l.max.x+=c.x,l.max.y+=c.x,l.max.z+=c.x,l.min.x-=c.x,l.min.y-=c.x,l.min.z-=c.x,!1!==t.ray.intersectsBox(l)){f.at(1,e),e.w=1,e.applyMatrix4(d.matrixWorldInverse),e.applyMatrix4(v),e.multiplyScalar(1/e.w),e.x*=_.x/2,e.y*=_.y/2,e.z=0,n.copy(e),a.multiplyMatrices(d.matrixWorldInverse,p);for(let t=0,e=M.count;t<e;t++){s.fromBufferAttribute(M,t),r.fromBufferAttribute(y,t),s.w=1,r.w=1,s.applyMatrix4(a),r.applyMatrix4(a);var x=s.z>E&&r.z>E;if(!x){s.z>E?(x=s.z-r.z,x=(s.z-E)/x,s.lerp(r,x)):r.z>E&&(x=r.z-s.z,x=(r.z-E)/x,r.lerp(s,x)),s.applyMatrix4(v),r.applyMatrix4(v),s.multiplyScalar(1/s.w),r.multiplyScalar(1/r.w),s.x*=_.x/2,s.y*=_.y/2,r.x*=_.x/2,r.y*=_.y/2,h.start.copy(s),h.start.z=0,h.end.copy(r),h.end.z=0;var x=h.closestPointToPointParameter(n,!0),x=(h.at(x,o),ws.lerp(s.z,r.z,x)),x=-1<=x&&x<=1,b=o.distanceTo(r)<1||o.distanceTo(s)<1?.5*w*Math.sqrt(2):.5*w,b=n.distanceTo(o)<b;if(x&&b){h.start.fromBufferAttribute(M,t),h.end.fromBufferAttribute(y,t),h.start.applyMatrix4(p),h.end.applyMatrix4(p);x=new Gt,b=new Gt;f.distanceSqToSegment(h.start,h.end,b,x),i.push({point:b,pointOnLine:x,distance:f.origin.distanceTo(b),object:this,face:null,faceIndex:t,uv:null,uv2:null});break}}}}}}}class Iy extends Ny{constructor(t,e){super(t,e),this.type="Line2",this.isLine2=!0}}class Py{constructor(){}calculatePoint(t,e,i){return(new Gt).copy(i).add((new Gt).copy(t).sub(i).normalize().multiplyScalar(e))}computerArcLineByPoints(t,e,i,s,r){var n=[],t=this.calculatePoint(t,s,e),i=this.calculatePoint(i,s,e),a=new cw(t,e,i);n.push(t);for(let t=0;t<r-1;t++){var h=(t+1)/r,h=a.getPoint(h);n.push(h)}return n.push(i),n}}class Dy{constructor(){this.j=ws.generateUUID(),this.Id=null,this.Tr=0,this.h0=void 0,this.Og=!0,this.Ug=1,this.Fg=[],this.Bg=!1,this.kg=null,this.Gg=null,this.Hg=[],this.Vg=[],this.zg=[],this.Wg=[],this.jg=null,this.Xg=null,this.Yg=!1,this.mi=new sa}get points(){return this.Id}set points(t){this.Yg=!1,this.Id=t,this.mi.expandByCoords(t);for(let t=0;t<this.Id.length;t++){var e,i;0!==t&&(e=new Gt(this.Id[t].x,this.Id[t].y,this.Id[t].z),i=new Gt(this.Id[t-1].x,this.Id[t-1].y,this.Id[t-1].z),this.Vg.push(e.distanceTo(i)))}}get level(){return this.Tr}set level(t){this.Tr=t}get buildingID(){return this.h0}set buildingID(t){this.h0=t}set length(t){}get length(){return this.Zg(this.Hg.length)}get linePoints(){return this.kg}get uvys(){return this.Gg}resize(){this.Hg=[],this.Bg=!1}}Object.assign(Dy.prototype,{qg(t,e){this.Yg||("number"!=typeof e&&(e=this.Ug),this.kg=this.Kg(t,e),this.Gg=this.Jg(),this.Yg=!0)},Kg(e,t){this.Bg||(this.Og?this.$g(t):this.Fg=this.Qg(this.Id));var i=[];for(let t=0;t<this.Fg.length;t++){var s=this.Fg[t].x-e.x,r=this.Fg[t].z,n=-this.Fg[t].y+e.y;i.push(s,r,n),0!==t&&(s=new Gt(this.Fg[t].x,this.Fg[t].y,this.Fg[t].z),r=new Gt(this.Fg[t-1].x,this.Fg[t-1].y,this.Fg[t-1].z),this.Hg.push(s.distanceTo(r)))}return i},Qg(e){var i,s=[];for(let t=0;t<e.length;t++)0===t||t===e.length-1?s.push(e[t]):(null!==(i=r(e[t],s[s.length-1]))&&s.push(i),s.push(e[t]),null!==(i=r(e[t],e[t+1]))&&s.push(i));return s;function r(t,e){var i=e.x-t.x,e=e.y-t.y,s=Math.sqrt(i*i+e*e),r=Math.asin(Math.abs(e)/s);let n=1/s,a=(1<=n&&(n=.1),1),h=1;return 0!=i&&(a=i/Math.abs(i)),0!=e&&(h=e/Math.abs(e)),{x:t.x+a*s*n*Math.cos(r),y:t.y+h*s*n*Math.sin(r),z:t.z}}},t_(e,t,i){var s,r=[],n=new Py;for(let t=0;t<e.length;t++)0===t||t===e.length-1?r.push(e[t]):(s=this.e_(i,r[r.length-1],e[t],e[t+1]),r.push(...n.computerArcLineByPoints(r[r.length-1],e[t],e[t+1],s,2)));return r},$g(e){var i,s=[],r=new Py;for(let t=0;t<this.Id.length;t++)0===t||t===this.Id.length-1?s.push(this.Id[t]):(i=this.e_(e,s[s.length-1],this.Id[t],this.Id[t+1]),s.push(...r.computerArcLineByPoints(s[s.length-1],this.Id[t],this.Id[t+1],i,4)));this.Fg=s,this.Bg=!0},e_(t,e,i,s){return Math.min(.5*G.distanceOfTwoPoints(e,i),.5*G.distanceOfTwoPoints(i,s),t)},Jg(){var e,i=[],s=this.Zg(this.Hg.length);for(let t=0;t<this.Fg.length;t++)0===t?i.push(0):t===this.Fg.length-1?i.push(1):(e=this.Zg(t)/s,i.push(e),i.push(e));return i},Zg(e,t){let i=0,s=this.Hg;t&&(s=this.Vg);for(let t=0;t<s.length;t++)t<e&&(i+=s[t]);return i}});let Oy={FULL:0,DOTTED:2,DOT_DASH:4,CENTER:8,DASH:16,DOUBLE_DOT_DASH:32,TRI_DOT_DASH:64,FMARROW:128,ARROW:256};class Uy extends BM{constructor(e){if(super(e),e=e||{},this.Ai=p.LINE_MARKER,this.Xv=e.url,this.i_=void 0!==e.width?e.width:6,this.vm=void 0!==e.color?e.color:"#33cc61",this.Og=void 0===e.smooth||e.smooth,this.s_=void 0!==e.radius?e.radius:1,this.Ma=void 0===e.animate||e.animate,this.Kr=void 0!==e.opacity?e.opacity:1,this.r_=void 0===e.depth||e.depth,this.n_=e.pointSegCount,void 0===this.n_&&(this.n_=10),this.a_=void 0!==e.type?e.type:Oy.FMARROW,this.h_=void 0!==e.borderColor?e.borderColor:"#4a82d2",this.o_=e.isGeneralize,void 0===this.o_&&(this.o_=!1),this.l_=void 0!==e.segments?e.segments:[],this.Ea=[],this.u_=new Map,this.c_=60,this.f_=10,this.d_="#aeaeae",this.v_=void 0,this.p_=!1,this.m_=this.m_.bind(this),this.g_=this.g_.bind(this),this.__=this.__.bind(this),this.w_=this.w_.bind(this),this.Lg=this.Lg.bind(this),this.M_=this.M_.bind(this),this.y_=void 0!==e.zFighting?e.zFighting:void 0,this.E_=void 0===e.ignoreFloorSpace||e.ignoreFloorSpace,this.x_=!1,this.b_=1,this.S_=!1,this.A_=null,!1===this.y_&&(this.a_=Oy.FULL,this.vm="#aeaeae"),this.y_&&(this.T_=new Uy(Object.assign(e,{zFighting:!1})),this.x_=!0,this.b_=0),e.gradient){var i=Object.keys(e.gradient).map(parseFloat),s=(i.sort(function(t,e){return t-e}),[]);for(let t=0;t<i.length;t++){var r,n,a,h=e.gradient[i[t]];0<=h.toUpperCase().indexOf("RGB")?(n=h.substring(h.indexOf("(")+1,h.indexOf(")")).split(","),a=parseFloat(n[0])/255,r=parseFloat(n[1])/255,n=parseFloat(n[2])/255,s.push(new Vt(a,r,n,0))):(a=new Wt(h),s.push(new Vt(a.r,a.g,a.b,a.a)))}this.R_={percent:i,color:s}}}get bound(){if(!0===this.needUpdateBound){this.mi.reset();var e=this.l_;for(let t=0;t<e.length;t++){var i=e[t];this.mi.expandByCoords(i.Id)}this.needUpdateBound=!1}return this.mi.clone()}get level(){return null}get width(){return this.i_}set width(t){0!==t&&t!==this.i_&&(this.i_=t,this.u_.clear(),this.Pr(),this.y_&&(this.T_.width=t),this.g_())}getBelongedBuildingID(){let e=[];return this.segments.forEach(t=>{e.push(void 0===t.buildingID?null:t.buildingID)}),e}get color(){return this.vm}set color(t){this.vm!==t&&(this.vm=t,this.Pr())}get opacity(){return this.Kr}set opacity(t){this.Kr!==t&&(this.Kr=t,this.Pr(),this.y_)&&(this.T_.opacity=t)}get passedColor(){return this.d_}set passedColor(t){this.d_!==t&&(this.d_=t,this.Pr())}get segments(){return this.l_}set segments(t){this.l_=t;var e=this.ur(E);e&&(this.L_(e,!0),this.Bu(),this.w_(),this.y_&&(this.T_.segments=t),this.needUpdateBound=!1)}get visible(){return this.Qs}set visible(e){this.Qs=e;for(let t=0;t<this.Ea.length;t++)this.Ea[t].line.visible=e;var t=this.ur(E);t&&(t.enableUpdateRender(),this.y_)&&(this.T_.visible=e)}updatePosition(t){this.Lg(t)}update(){var t,e;this.Zs&&this.Zs.material&&(t=this.ur(E))&&(e=this.ur(v),this.S_?this.Zs.material=t.Wt.pl.nu({color:this.vm,lineWidth:this.i_,opacity:this.Kr*e.Kr,needDepth:!1,gradient:this.R_}):(this.Zs.material.dispose(),this.Zs.material=new jM({useMap:0,color:new Wt(this.vm),opacity:this.Kr*e.Kr,resolution:new ct(t.bt.renderer.domElement.clientWidth,t.bt.renderer.domElement.clientHeight),lineWidth:2*this.i_,sizeAttenuation:0,transparent:!0,depthTest:!1,passColor:new Wt(this.d_),isGradient:!1,gradientPercent:[0],gradientColor:[new Vt(0,0,0,0)]},1,t)),this.y_)&&this.T_.update()}moveProportion(i,s){let r=0;var n=[];for(let e=this.Ea.length-1;-1<e;e--)if(this.Ea[e].isCross&&!s||(r+=this.Ea[e].seg.length),"Mesh"===this.Ea[e].line.type)this.Ea[e].line.myseg={length:this.Ea[e].seg.length,isCross:this.Ea[e].isCross},n.push(this.Ea[e].line);else{var a=this.Ea[e].line.children;for(let t=0;t<a.length;t++)a[t].myseg.isCross=this.Ea[e].isCross,n.push(a[t])}for(let e=0;e<n.length;e++){let t=0;t=0===e?0:n[e-1].material.uniforms.endPercent.value,n[e].material.uniforms.beginPercent.value=t,!n[e].myseg.isCross||s?n[e].material.uniforms.endPercent.value=t+n[e].myseg.length/r:n[e].material.uniforms.endPercent.value=t,n[e].material.uniforms.currentPercent.value=i,n[e].material.uniforms.ispassed.value=!0}this.v_=i,this.p_=s;var t=this.ur(E);t&&(t.enableUpdateRender(),this.y_)&&this.T_.moveProportion(i,this.p_)}getLineNodes(){return this.Ea}addTo(t){this.C_(()=>{t.ya.add(this),this.N_(),t.on("visibleLevelsLoaded",this.w_),t.on("levelChanged",this.M_),t.on("updateCameraHeight",this.M_),t.on("zoom",this.M_),t.on("resize",this.M_),this.Ma&&!1!==this.y_&&t.ot.$s(this.m_),this.y_&&this.T_.addTo(t)})}remove(){var t=this.ur(E);t&&(t.off("visibleLevelsLoaded",this.w_),t.off("levelChanged",this.M_),t.off("updateCameraHeight",this.M_),t.off("zoom",this.M_),t.off("resize",this.M_),this.L_(t,!0),this.Ma&&t.ot.Ks(this.m_),t.ya.remove(this),t.enableUpdateRender(),this.y_)&&this.T_.remove(t)}dispose(){super.dispose();for(let t=0;t<this.l_.length;t++)this.l_[t].resize();this.y_&&this.T_.dispose()}getRenderNode(){return this.Ea}}Object.assign(Uy.prototype,{I_(t){t.on("resize",this.__)},P_(t){t.off("resize",this.__)},L_(t,i){for(let e=0;e<this.Ea.length;e++)if(i||!this.Ea[e].isCross){var s=this.Ea[e].buildingID&&""+this.Ea[e].buildingID,r=this.Ea[e].isCross?Math.min(this.Ea[e].gid,this.Ea[e].gidAn):this.Ea[e].gid,s=this.Vs(s,r,t);if(s)if(s.getOrCreateLayer(this.Ai).xa.remove(this.Ea[e].line),"Mesh"===this.Ea[e].line.type)this.D_(this.Ea[e].line);else{var n=[...this.Ea[e].line.children];for(let t=0;t<n.length;t++)this.Ea[e].line.remove(n[t]),this.D_(n[t])}}i&&(this.Ea=[])},D_(t){t.geometry.dispose();try{t.material.uniforms.map.value.dispose()}catch(t){}t.material.dispose()},O_(e){if(e.line)if(e.line.parent&&e.line.parent.remove(e.line),"Mesh"===e.line.type)this.D_(e.line);else{var i=[...e.line.children];for(let t=0;t<i.length;t++)e.line.remove(i[t]),this.D_(i[t])}},U_(t,e,i){let s=null;i?(this.S_=!0,(s=new Ay).setPositions(t),i=this.ur(v),i=e.Wt.pl.nu({color:this.vm,lineWidth:this.i_,opacity:this.opacity*i.Kr,needDepth:!1,gradient:this.R_}),this.Zs=new Iy(s,i),this.Zs.computeLineDistances(),s.dispose(),s=null):(this.S_=!1,(s=new VM).setPoints(t),i=new jM({useMap:0,color:new Wt(this.vm),opacity:this.Kr,resolution:new ct(e.bt.renderer.domElement.clientWidth,e.bt.renderer.domElement.clientHeight),lineWidth:2*this.i_,sizeAttenuation:0,transparent:!0,depthTest:!1,passColor:new Wt(this.d_),isGradient:!1,gradientPercent:[0],gradientColor:[new Vt(0,0,0,0)]},1,e),this.Zs=new L(s.geometry,i))},F_(t){let e=new VM;e.setPoints(t),this.Zs.geometry=e.geometry,e.dispose(),e=null},Bu(){var r=this.ur(E);if(r){var i=this.B_();let s=[];new ct(r.x,r.y);var n=this.l_;for(let t=0;t<n.length;t++){var a,h=n[t].points;let e=[];if(2===h.length&&h[0].x===h[1].x&&h[0].y===h[1].y)e=n[t].points;else{for(let t=0;t<h.length;t++)0!==e.length&&(a=e[e.length-1]).x===h[t].x&&a.y===h[t].y||e.push(h[t]);1===e.length&&e.push(e[0]),n[t].points=e}}this.l_=this.k_(this.l_),this.l_=(i=>{var s=[];for(let e=0;e<i.length;e++){var r=(s=>{var r=[],n=Math.ceil(s.length/1e3);for(let t=1;t<=n;t++){let e=1e3*(t-1),i=e+1e3;t===n&&(i=s.length),1<t&&(e-=1);var a=[];for(let t=e;t<i;t++)a.push(s[t]);r.push(a)}return r})(i[e].points),n=i[e].level;for(let t=0;t<r.length;t++){var a=new Dy;a.level=n,a.buildingID=i[e].buildingID,a.points=r[t],s.push(a)}}return s})(this.l_);for(let i=this.l_.length-1;-1<i;i--){var o,l=this.Vs(this.l_[i].buildingID,this.l_[i].Tr,r);if(!l)return;let t,e;if(0<i&&this.l_[i].h0===this.l_[i-1].h0&&this.l_[i].Tr!==this.l_[i-1].Tr){if(!(t=this.Vs(this.l_[i-1].buildingID,this.l_[i-1].Tr,r)))return;e=this.l_[i-1].points,this.l_[i].Xg=Object.assign({},e[e.length-1]),this.l_[i].Xg.z+=t.Jt-l.Jt}if(i<this.l_.length-1&&this.l_[i].h0===this.l_[i+1].h0&&this.l_[i].Tr!==this.l_[i+1].Tr){var u=this.Vs(this.l_[i+1].buildingID,this.l_[i+1].Tr,r);if(!u)return;this.l_[i].jg=Object.assign({},this.l_[i+1].points[0]),this.l_[i].jg.z+=u.Jt-l.Jt}s.push({seg:this.l_[i],buildingID:this.l_[i].h0,gid:this.l_[i].Tr,isCross:!1,floor:l}),0<i&&this.l_[i].h0===this.l_[i-1].h0&&this.l_[i].Tr!==this.l_[i-1].Tr&&((u=new Dy).Tr=this.l_[i].Tr,u.h0=this.l_[i].h0,u.isCross=!0,o=this.l_[i].points,this.G_(u,e,o,t,l),s.push({floor:t.level<l.level?t:l,seg:u,buildingID:u.h0,gid:this.l_[i-1].Tr,isCross:!0,gidAn:u.Tr,levelRange:[this.l_[i-1].Tr,this.l_[i].Tr]}))}s=s.reverse();for(let e=0;e<s.length;e++){var{seg:c,buildingID:f,gid:d,isCross:v,gidAn:p,levelRange:m,floor:g}=s[e];if(v||2!==c.Id.length||c.Id[0].x!==c.Id[1].x||c.Id[0].y!==c.Id[1].y){var _,w=e-s.length;let t=null;t=v?this.H_(c,i,w):(_=this.V_(r,this.i_,f,d),this.z_(c,i,w,_)),this.Ea.push({line:t,buildingID:f,gid:d,seg:c,isCross:v,gidAn:p,levelRange:m}),g.getOrCreateLayer(this.Ai).xa.add(t)}}this.dv=!0,this.Ea=this.Ea.reverse(),this.W_(),void 0!==this.v_&&this.moveProportion(this.v_,this.p_);{var M=i;var y=()=>{this.g_()};let e=null;(M.useMap?function t(){M.texture.source&&M.texture.source.data?(y(),null!==e&&clearTimeout(e)):e=setTimeout(t,0)}:y)()}return r.enableUpdateRender(),this.dv}},W_(){if(void 0!==this.R_){let i=0;var s=[];for(let t=this.Ea.length-1;-1<t;t--)if(this.Ea[t].isCross&&this.E_||(i+=this.Ea[t].seg.length),"Mesh"===this.Ea[t].line.type)this.Ea[t].line.myseg={length:this.Ea[t].seg.length,isCross:this.Ea[t].isCross},s.push(this.Ea[t].line);else{var e=this.Ea[t].line.children;for(let t=0;t<e.length;t++)s.push(e[t])}for(let e=0;e<s.length;e++){let t=0;t=0===e?0:s[e-1].material.uniforms.gradientEnd.value,s[e].material.uniforms.gradientBegin.value=t,s[e].myseg.isCross&&this.E_?s[e].material.uniforms.gradientEnd.value=t:s[e].material.uniforms.gradientEnd.value=t+s[e].myseg.length/i}}},k_(i){var s=[];for(let e=0;e<i.length;e++){var r=i[e].points,n=[[]];if(2===r.length&&r[0].x===r[1].x&&r[0].y===r[1].y)n[n.length-1].push(r[0]),n[n.length-1].push(r[1]);else for(let e=0;e<r.length;e++){var a=n[n.length-1];if(a.length<2)a.push(r[e]);else{var h=new ct(a[a.length-2].x,a[a.length-2].y),o=new ct(a[a.length-1].x,a[a.length-1].y),l=new ct(r[e].x,r[e].y),h=h.sub(o),l=l.sub(o),o=l.dot(h);let t=l.dot(h)/(l.length()*h.length());1<t&&(t=1);l=Math.acos(t);0<o&&l<Math.PI/12?(h=[a[a.length-1],r[e]],n.push(h)):a.push(r[e])}}for(let t=0;t<n.length;t++){var u=new Dy;u.level=i[e].level,u.buildingID=i[e].buildingID,u.points=n[t],s.push(u)}}return s},G_(t,e,i,s,r){var n=Object.assign({},e[e.length-1]),a=Object.assign({},i[0]);n.z+=s.Jt-r.Jt,t.points=[n,a],t.Xg=Object.assign({},e[e.length-2]),t.Xg.z+=s.Jt-r.Jt,t.jg=Object.assign({},i[1])},z_(d,v,p,t){let m=this,g=this.ur(E);if(g){var i=new ct(g.x,g.y);d.Og=this.Og,d.qg(i,this.s_);let f=this.Vs(d.h0,d.Tr,g);if(f){let e=d.Fg,c=(d.isCross&&(e=d.Id),t);if(void 0===c&&(c=this.V_(g,m.i_,d.h0,d.Tr)),this.o_){let t=g.getZoomRange()[1];21<t&&(t=21);i=c*((t-g.getZoom())/(t-1));if(20<=d.Id.length&&1<i){e=d.Id,e=HM(e,i);var s=this.k_([{points:e}]),r=new L0;r.position.set(0,f.Jt,0);for(let e=0;e<s.length;e++){let t=null;var n=a(t=this.Og?d.t_(s[e].points,1,this.s_):d.Qg(s[e].points));n.position.y=0,n.myseg={length:(e=>{let i=0;for(let t=0;t<e.length;t++){var s,r,n;0<t&&(s=e[t].x-e[t-1].x,r=e[t].y-e[t-1].y,n=e[t].z-e[t-1].z,i+=Math.sqrt(s*s+r*r+n*n))}return i})(s[e].points),h0:d.h0,Tr:d.Tr},r.add(n)}return r}}return a(e);function a(e){var i=[];for(let t=0;t<e.length;t++)i.push(new Gt(e[t].x-g.x,e[t].z,-e[t].y+g.y));let t=!0,s=new _,r=(v.useMap?s=v.texture.matrix:t=!1,!1),n=[0],a=[new Vt(0,0,0,0)],h=(void 0!==m.R_&&(r=!0,n=m.R_.percent,a=m.R_.color),!1),o=(m.a_!==Oy.FMARROW&&m.a_!==Oy.ARROW||(h=!0),!1);!1===m.y_&&(o=!0);var l=new My({color:new Wt(m.vm),lineWidth:c,opacity:m.Kr,map:v.texture,uvTransform:s,isMap:t,isGradient:r,gradientPercent:n,gradientColor:a,isArrow:h,passColor:new Wt(m.d_),usePassOpacity:m.x_,passOpacity:m.b_,zFighting:o},n.length),u=(l.transparent=!0,l.depthTest=m.r_,new _y),u=(u.setPoints(i),new L(u,l));return u.raycast=wy,m.y_?u.renderOrder=p:!1===m.y_&&(u.renderOrder=1),!m.y_&&!1!==m.y_||(l.stencilWrite=!0,l.stencilRef=d.Tr+1,l.stencilFunc=Di,l.stencilFail=Pi,l.stencilZFail=Pi,l.stencilZPass=Pi),u.position.set(0,f.Jt,0),u.mapNode=m,u.selfLevel=d.Tr,u.selfBuildingID=d.h0,u}}}},H_(h,o,l){var u=this.ur(E);if(u){var c=new ct(u.x,u.y),c=(h.Og=this.Og,h.qg(c,this.s_),this.Vs(h.h0,h.Tr,u));if(c){let e=h.Fg;h.isCross&&(e=h.Id);var f=[];for(let t=0;t<e.length;t++)f.push(new Gt(e[t].x-u.x,e[t].z,-e[t].y+u.y));let t=1,i=(o.useMap||(t=0),!1),s=[0],r=[new Vt(0,0,0,0)],n=(void 0!==this.R_&&(i=!0,s=this.R_.percent,r=this.R_.color),!1),a=(this.a_!==Oy.FMARROW&&this.a_!==Oy.ARROW||(n=!0),!1);!1===this.y_&&(a=!0);var o=new jM({useMap:t,map:o.texture,color:new Wt(this.vm),opacity:this.Kr,resolution:new ct(u.bt.renderer.domElement.clientWidth,u.bt.renderer.domElement.clientHeight),lineWidth:2*this.i_,sizeAttenuation:0,transparent:!0,depthTest:this.r_,passColor:new Wt(this.d_),isGradient:i,gradientPercent:s,gradientColor:r,isArrow:n,usePassOpacity:this.x_,passOpacity:this.b_,zFighting:a},s.length,u),d=new VM,d=(d.setPoints(f),new L(d.geometry,o));return d.raycast=zM,this.y_?d.renderOrder=l:!1===this.y_&&(d.renderOrder=1),!this.y_&&!1!==this.y_||(o.stencilWrite=!0,null===h.h0?o.stencilRef=1:o.stencilRef=2,o.stencilFunc=Di,o.stencilFail=Pi,o.stencilZFail=Pi,o.stencilZPass=Pi),d.position.set(0,c.Jt,0),d.mapNode=this,d.selfLevel=h.Tr,d.selfBuildingID=h.h0,d}}},m_(e){for(let t=0;t<this.Ea.length;t++)if("Mesh"===this.Ea[t].line.type)this.Ea[t].line.material.uniforms.offset.value.x-=.001*e/this.Ea[t].line.material.uniforms.repeat.value.x;else{var i=this.Ea[t].line.children;for(let t=0;t<i.length;t++)i[t].material.uniforms.offset.value.x-=.001*e/i[t].material.uniforms.repeat.value.x}this.ur(E).enableUpdateRender()},M_(t){var e=this.ur(E);if(e){if("zoom"===t.type)if(this.u_.clear(),this.o_)this.j_();else{for(let t=0;t<this.Ea.length;t++)this.Ea[t].isCross||this.X_(this.Ea[t],e);this.g_()}if("levelChanged"===t.type||"updateCameraHeight"===t.type){this.u_.clear();for(let t=0;t<this.Ea.length;t++)this.Ea[t].isCross||this.X_(this.Ea[t],e);this.g_()}"resize"===t.type&&this.__()}},X_(t,e){var i=t.buildingID,s=t.gid;if("Mesh"===t.line.type)t.line.material.uniforms.lineWidth.value=this.V_(e,this.i_,i,s);else{var r=t.line.children;for(let t=0;t<r.length;t++)r[t].material.uniforms.lineWidth.value=this.V_(e,this.i_,i,s)}},V_(t,e,i,s){null==i&&(i=t.getMapOptions().buildingID),null!==s&&void 0!==i||(s=t.getBuilding(i).level);var r={x:nt.document.body.clientWidth/2,y:nt.document.body.clientHeight/2},e={x:r.x+e,y:r.y},n=(t.bi.xs({buildingID:i,level:s})&&(r.buildingID=i,r.level=s,e.buildingID=i,e.level=s),this.u_.get(i+"_"+s));return void 0===n&&(r=aa.coordsScreenToMap(t,r),t=aa.coordsScreenToMap(t,e),n=Math.sqrt((r.x-t.x)*(r.x-t.x)+(r.y-t.y)*(r.y-t.y)),this.u_.set(i+"_"+s,n)),n},j_(e){e=e||this.ur(E);var i,s,r=this.B_();for(let t=0;t<this.Ea.length;t++)this.Ea[t].isCross||this.Ea[t].seg.Id.length<20||!this.Ea[t].line?this.Ea[t].isCross||this.X_(this.Ea[t],e):(i=this.Vs(this.Ea[t].seg.h0,this.Ea[t].seg.Tr,e),s=this.Ea[t].line.renderOrder,s=(this.O_(this.Ea[t]),this.z_(this.Ea[t].seg,r,s)),this.Ea[t].line=s,i.getOrCreateLayer(this.Ai).xa.add(s));this.W_(),void 0!==this.v_&&this.moveProportion(this.v_,this.p_),this.g_(),e.enableUpdateRender()},g_(){if(this.A_.useMap){let e=5;this.Xv&&(e=2);for(let t=0;t<this.Ea.length;t++)if(this.Ea[t].isCross)this.Y_(this.Ea[t].line.material,this.Ea[t].seg,e*this.i_,!0);else if("Mesh"===this.Ea[t].line.type)this.Y_(this.Ea[t].line.material,this.Ea[t].seg,this.i_,!1);else{var i=this.Ea[t].line.children;for(let t=0;t<i.length;t++)this.Y_(i[t].material,i[t].myseg,this.i_,!1)}}},Y_(i,s,r,e){var n=this.ur(E);if(n){var a=s.length,h=this.Vs(s.h0,s.Tr,n);if(h){let t=0;if(e){e=a*n.Wt.Z_(h.Jt);t=Math.floor(e*nt.window.devicePixelRatio/r),this.Xv&&i.uniforms.map.value&&i.uniforms.map.value.source.data&&(a=i.uniforms.map.value.source.data.height,h=i.uniforms.map.value.source.data.width,a*=this.i_/h,t=Math.floor(e*nt.window.devicePixelRatio/a))}else{let e=0;for(let t=0;t<this.Ea.length;t++)this.Ea[t].isCross||(e+=this.Ea[t].seg.length);i.uniforms.map.value&&i.uniforms.map.value.source.data&&(r=i.uniforms.map.value.source.data.height,h=i.uniforms.map.value.source.data.width,r*=i.uniforms.lineWidth.value/h,t=Math.floor(e/r),this.Xv||(nt.environment!==I.WX&&this.a_===Oy.FMARROW||this.a_===Oy.ARROW?t*=3:t/=4)),t=Math.floor(t*s.length/e)}0===t&&(t=1),i.uniforms.repeat.value=new ct(t,1),n.enableUpdateRender()}}},__(){var e=this.ur(E);if(e){for(let t=0;t<this.Ea.length;t++)"Mesh"===this.Ea[t].line.type&&(this.Ea[t].line.material.resolution=new ct(e.bt.renderer.domElement.clientWidth,e.bt.renderer.domElement.clientHeight));e.enableUpdateRender()}},N_(){var t,e,i=this.ur(E);for(t of this.Ea)t.isCross?(e=this.Qo(t.buildingID,i).visibleLevels).indexOf(t.gid)<0||e.indexOf(t.gidAn)<0?t.line.visible=!1:(t.line.visible=!0,t.line.visible=this.Qs):-1<this.Qo(t.buildingID,i).visibleLevels.indexOf(t.gid)?(t.line.visible=!0,t.line.visible=this.Qs):t.line.visible=!1;i.enableUpdateRender()},w_(){this.ur(E)&&this.N_()},q_(){this.c_=this.i_*this.f_;var t={type:"normal",width:128,height:128,color:this.vm,arrowHeightPercent:.6,arrowWidthPercent:1,arrowPercent:.1,lineType:null,dashArray:[2,1],textureCommand:"createNormalLineTexture",godHeightPercent:1,godEdgePercent:.2,godArrowPercent:.15,arrowWidth:20,godColor:this.vm,godEdgeColor:this.h_,godArrowColor:"#F4FEFB",godArrowXScale:4,godArrowWidthPercent:.9,useMap:!0,gradient:this.R_};switch(this.R_&&(t.color="#fff",t.godEdgeColor="rgba(0,0,0,1)",t.godColor="rgba(0,0,0,1)"),this.a_){case Oy.FULL:t.useMap=!1;break;case Oy.DOTTED:t.dashArray=[.5,.5,.5,.5,.5,.5,.5,.5];break;case Oy.DOT_DASH:t.dashArray=[2.5,1,.5,1];break;case Oy.CENTER:t.dashArray=[3,1,1.5,1];break;case Oy.DASH:t.dashArray=[2,1];break;case Oy.DOUBLE_DOT_DASH:t.dashArray=[2.5,.5,.5,.5,.5,.5];break;case Oy.TRI_DOT_DASH:t.dashArray=[2.5,.5,.5,.5,.5,.5,.5,.5];break;case Oy.FMARROW:case Oy.ARROW:nt.environment===I.BROWSER&&(t.width=5*this.i_,t.height=5*this.c_),t.arrowWidth=t.height/12,t.dashArray=[7,0],t.textureCommand="createArrowWidthBackTexture";break;default:t.useMap=!1}return t},B_(){var e=this.ur(E);if(e){if(null===this.A_){var i=this.q_();let t=null;this.Xv?this.A_={useMap:!0,texture:e.Wt.pl._u(this.Xv,t=>{t.needsUpdate=!0,t.rotation=Math.PI/2,t.flipY=!1,t.updateMatrix()})}:(i.useMap&&((t=e.Wt.pl[i.textureCommand](i)).minFilter=V,t.wrapS=Bt,t.wrapT=Bt,t.generateMipmaps=!1,t.anisotropy=4),this.A_={useMap:i.useMap,texture:t})}return this.A_}},C_(t){this.Xv?Tm.fl(this.Xv,()=>{t&&t()}):t&&t()},Pr(){let n=this.ur(E);if(n){let s=this,r=(this.A_=null,this.B_());var e=this.Ea;if(0<e.length)for(let t=0;t<e.length;t++)if(e[t].isCross)e[t].line.material.lineWidth=2*s.i_,e[t].line.material.color=new Wt(s.vm),e[t].line.material.passColor=new Wt(s.d_),e[t].line.material.opacity=s.Kr,r.useMap&&(e[t].line.material.map=r.texture);else if("Mesh"===e[t].line.type)a(e[t].line,e[t].buildingID,e[t].gid);else{var i=e[t].line.children;for(let t=0;t<i.length;t++)a(i[t])}function a(t,e,i){t.material.uniforms.lineWidth.value=s.V_(n,s.i_,e,i),t.material.uniforms.color.value=new Wt(s.vm),t.material.uniforms.passColor.value=new Wt(s.d_),t.material.uniforms.opacity.value=s.Kr,r.useMap&&(t.material.uniforms.isMap.value=!0,t.material.uniforms.map.value=r.texture)}n.enableUpdateRender()}},Vs(t,e,i){let s;return s=(t?this.Qo(t,i):i).getFloor(e)},Qo(t,e){return t=t||e.getMapOptions().buildingID,e.getBuilding(t)},Lg(){let i=this,s=this.ur(E);if(s){var r=this.Ea;if(0<r.length){var n=new ct(s.x,s.y);for(let e=0;e<r.length;e++){let t=r[e].buildingID;null==t&&(t=s.getMapOptions().mapID);var a=s.getBuilding(t),h=a.getFloor(r[e].gid);if(r[e].isCross){var o=r[e].seg.points,l=r[e+1].seg,l=l.points[l.points.length-1].z,u=r[e-1].seg,u=u.points[u.points.length-1].z;r[e].seg.points=[{x:o[0].x,y:o[0].y,z:l},{x:o[1].x,y:o[1].y,z:u+(a.getFloor(r[e].gidAn).Jt-h.Jt)}],r[e].seg.resize(),r[e].seg.Og=!1,r[e].seg.qg(n,i.s_);let t=r[e].line.material.map;l={texture:t=null!==t?t.clone():t,useMap:r[e].line.material.useMap},o=(l.useMap=0!==l.useMap,r[e].line.renderOrder),u=i.H_(r[e].seg,l,o),a=(u.material.beginPercent=r[e].line.material.beginPercent,u.material.endPercent=r[e].line.material.beginPercent,u.material.gradientBegin=r[e].line.material.gradientBegin,u.material.gradientEnd=r[e].line.material.gradientEnd,u.position.set(0,h.height,0),r[e].line.parent);null!==a&&(a.add(u),a.remove(r[e].line)),r[e].line.geometry.dispose(),null!==r[e].line.material.map&&r[e].line.material.map.dispose(),r[e].line.material.dispose(),r[e].line=u}else r[e].line&&r[e].line.position.set(0,h.height,0)}i.g_()}this.w_(),s.enableUpdateRender()}}});class Fy extends lM{constructor(t){super(),this.qs=t,void 0===this.qs.baseheight&&(this.qs.baseheight=0),this.Jt=Math.abs(this.qs.height-this.qs.baseheight),this.K_=this.qs.baseheight,this.qs.height<this.K_&&(this.K_=this.qs.height),this.Ai=p.MODEL,this.Zs=null,this.Rf=null,this.As=null,this.mi=null,this.J_="#FF0000",this.Qp=null,this.en={top:null,left:null,right:null,front:null,back:null},this.Q_=!1,this.X0=null,this.vm=null,this.Kr=null,this.t2=null,this.e2=null,this.i2=.01*this.s2(this.x+this.y),this.lv=null,this.e1=null,this.t1=[0,0],this.eg=null,this.Ym=0,this.Of=null,this.Zv=0,this.n2=null,this.Yv=0,this.Fv=!1,this.Bv=null,this.kv=null,this.Gv=null,this.Ir=null,this.Cm=void 0}get bindBuildingID(){return this.Cm}get FID(){return this.qs.fid}get typeID(){return this.qs.type}get name(){return this.qs.name}get eName(){return this.qs.ename}get pass(){return this.qs.pass}get coordinates(){return this.qs.Ti}get x(){return this.qs.yi?.x}get y(){return this.qs.yi?.y}get height(){return this.qs.height>=this.qs.baseheight?this.qs.height:this.qs.baseheight}get baseHeight(){return this.qs.baseheight<=this.qs.height?this.qs.baseheight:this.qs.height}get extrudeHeight(){return this.Jt}getData(){var t=Object.assign(super.getData(),{pass:this.qs.pass});return t.height=this.height,t.baseHeight=this.baseHeight,t.extrudeHeight=this.extrudeHeight,t}getArea(){return D3.area(this.qs.Ti[0])}setColor(t,e){this.Q_=!0,void 0!==t&&(this.vm=t),void 0!==e&&(this.Kr=e),this.Pr()}resetColor(){this.X0&&!this.a2()||this.fd(),this.setColor(this.X0.color,this.X0.alpha),this.Q_=!1}setBorderColor(t,e){t&&(this.t2=t),null!=e&&(this.e2=e);t=this.ur(E);this.h2(t)}resetBorderColor(){this.X0&&(this.a2()&&this.fd(),this.setBorderColor(this.X0.strokeColor,this.X0.alpha))}setTopImage(t){this.Zv=1,this.lv=t.image,this.eg=void 0!==t.coords?t.coords:this.qs.yi,this.e1=void 0!==t.size?t.size:[5,5],this.t1=void 0!==t.offset?t.offset:[0,0],this.Ym=void 0!==t.angle?t.angle:0,this.Zs&&this.o2()}clearTopImage(){this.Zv=0,this.l2()}flash(t){this.u2(t);let e=this,i=this.ur(E),s=0;function r(){s%2==0?e.Zs&&(e.Zs.material.color=new Wt(e.J_)):e.Zs&&(e.Zs.material.color=new Wt(e.vm)),s++,i.enableUpdateRender()}e.Qp&&clearTimeout(e.Qp),function t(){e.Zs&&(e.Zs.userData.sourceMaterial||(e.Zs.userData.sourceMaterial=e.Zs.material,e.Zs.material=e.Zs.material.clone()),e.Zs.userData.sourceMaterial.canDispose=!1,r());e.Qp=setTimeout(t,100)}()}stopFlash(){if(this.Qp&&(clearTimeout(this.Qp),this.Qp=null,this.Zs)){let t=this.Zs.material;this.Zs.material=this.Zs.userData.sourceMaterial,delete this.Zs.userData.sourceMaterial.canDispose,delete this.Zs.userData.sourceMaterial,t.dispose(),t=null,this.ur(E).enableUpdateRender()}}getOtherNode(){return{top:this.en.top,line:this.Rf}}}Object.assign(Fy.prototype,{iv(t){this.Cm=t},Bu(){if(!this.Zs&&1!==this.Yv){var t=this.ur(v),e=t.P;let r=e.P,n=e.P.Wt;this.fd(),this.vm&&this.Q_||(this.vm=this.X0.color),null!==this.Kr&&this.Q_||(this.Kr=this.X0.alpha),this.t2&&this.Q_||(this.t2=this.X0.strokeColor),this.i_&&this.Q_||(this.i_=this.X0.strokeWidth),null!==this.e2&&this.Q_||(this.e2=this.X0.alpha);e=t.getLayers(p.EXTENT_LAYER)[0].bound,t=r.nt.qv?n.Kv:n.Jv;this.Yv=1,t.bind(n)({type:this.type,data:this.qs,amount:this.Jt,referenceBound:e,isUseReferenceBound:!0,createLineType:1<this.i_?"onlyData":"geometry",lineHeight:this.Jt+this.i2}).then(t=>{this.Yv=2;var e=this.E0(n.pl),i=(e.userData.opacity=e.opacity,this.qs.getBound()),s=(null!==this.Ir?((s=e.clone()).color=new Wt(this.Ir),this.Zs=new L(t.geometry,s),this.Zs.userData.sourceMaterial=e):this.Zs=new L(t.geometry,e),new Gt(i.center.x-r.t,this.K_,r.o-i.center.y));this.Zs.position.copy(s),this.Zs.rotation.set(-Math.PI/2,0,0,"XYZ"),(this.Zs.mapNode=this).P.xa.add(this.Zs),this.c2=t.shape,this.f2(t.lineData),this.d2(),this.Of&&this.Of.Bu(this),r.enableUpdateRender()})}},m2(t){let e=[];t?e=t:this.c2.getPoints().forEach(t=>{e.push(t.x,t.y,this.Jt+this.i2)});var t=new Uy({color:this.t2,width:this.i_,smooth:!1,animate:!1,depth:!0}),i=(t.P=this).ur(E),s=(t.U_(e,i,!0),t.Zs.material.depthWrite=!0,t.Zs.material.depthTest=!0,t.Zs.material.polygonOffset=!0,t.Zs.material.polygonOffsetFactor=-3*this.i_,t.Zs.material.polygonOffsetUnits=1,this.Zs.add(t.Zs),this.Jt&&-1!==this.Jt?this.Jt:2);t.Zs.position.setZ(.005*s),t.Zs.renderOrder=-1,t.Zs.isNoPick=!0,this.Rf=t.Zs,this.g2=t,this.g2.Ea.push({line:t.Zs}),this.g2.I_(i)},cv(t){var e=this.ur(v),i={isline:!0,color:this.t2,opacity:this.e2*e.Kr,needDepth:!0},e=(void 0!==this.ir&&(i.opacity=this.ir),this.c0&&(i.isMask=this.c0,i.maskType=this.m0,i.maskPolygons=this.f0,i.maskHolePogygons=this.d0,i.maskHeight=this.g0,i.maskExtrudeHeight=this._0,i.boundCenter=this.w0,i.boundSize=this.M0,i.level=e.level,i.buildingId=e.parent.buildingId,i.maskID=this.$d,i.maskOpacity=this.y0,i.maskNodeHeight=this.av),t.Yl(i));return this.jv(e),e},initGLLine(t){var e=this.ur(rh).P.Wt;let i=this.cv(e.pl),s=this.Jt&&-1!==this.Jt?this.Jt:2;if(!t){var r=this.c2.getPoints(),n=(r&&0<r.length&&r.push(r[0]),[]),a=r.length;for(let t=0;t<a;t++)0===t||t===a-1||n.push(r[t].x,r[t].y,this.Jt+this.i2),n.push(r[t].x,r[t].y,this.Jt+this.i2);(t=new Nh).setAttribute("position",new ph(n,3))}var h=new Kg(t,i);if(h.position.setZ(.005*s),h.castShadow=!1,h.geometry.computeBoundingSphere(),this.Rf=h,this.Rf.matrixAutoUpdate=!1,this.Zs.add(h),0===this.i_&&(this.Rf.visible=!1),this.c2?.holes)for(let t=0;t<this.c2.holes.length;t++){u=l=o=void 0;var o=h,l=this.c2.holes[t].curves;for(let t=0;t<l.length;t++){var u=[],u=(u.push(new Gt(l[t].v1.x,l[t].v1.y,s)),u.push(new Gt(l[t].v2.x,l[t].v2.y,s)),(new Nh).setFromPoints(u)),u=new Kg(u,i);o.add(u)}}},f2(t){1<Math.floor(this.i_)?this.m2(t):this.initGLLine(t)},d2(){var t,e,i;this.lv&&this.e1&&(t=this.ur(E),e=new Ph(1,1,1,1),i=this.ov(t,this.lv),this.en.top=new L(e,i),t.getMapOptions().depthPeeling&&nt.environment===I.BROWSER?(this.en.top.renderOrder=0,this.en.top.material.depthTest=!0,this.en.top.material.depthWrite=!0):this.en.top.renderOrder=10,this._2(),this.Zs.add(this.en.top))},o2(){this.lv&&this.e1?this.en.top?(this.w2(),this._2()):this.d2():this.l2()},l2(){var t;this.en.top&&this.en.top.parent&&(this.en.top.parent.remove(this.en.top),this.en.top.geometry.dispose(),this.en.top.material.map&&this.en.top.material.map.dispose(),this.en.top.material.dispose(),this.en.top=null,t=this.ur(E))&&t.enableUpdateRender()},u2(t){this.J_=t},z0(){this.fd(),this.vm=this.X0.color,this.Kr=this.X0.alpha,this.t2=this.X0.strokeColor,this.e2=this.X0.alpha,this.i_=this.X0.strokeWidth,this.Rf&&(this.Rf.visible=0!==this.i_),this.Pr(),this.Zs&&this.o2()},M2(t){var e=this.ur(v);return t.Yl({isline:!0,color:this.t2,opacity:this.e2*e.Kr,needDepth:!0})},a2(){return!!this.Zs&&this.Zs.material.userData.dirtyTheme},E0(t){var e=this.ur(v),i=this.ur(rh).P.Wt,s=(t=t||i.pl,{themeUseDetail:this.X0.themeUseDetail,level:e.level,buildingId:e.parent.buildingId}),r={color:this.vm,alpha:this.Kr*e.Kr,type:this.Ai,modelSideGradient:jr(),isIgnoreLighting:Jr()};void 0!==this.ir&&(r.alpha=this.ir),this.c0&&(r.isMask=this.c0,r.maskType=this.m0,r.maskPolygons=this.f0,r.maskHolePogygons=this.d0,r.maskHeight=this.g0,r.maskExtrudeHeight=this._0,r.boundCenter=this.w0,r.boundSize=this.M0,r.level=e.level,r.buildingId=e.parent.buildingId,r.maskID=this.$d,r.maskOpacity=this.y0,r.maskNodeHeight=this.av),i.pl.callHook("getMaterialBefor",{material:this.Zs?.material,additionalInfo:s});let n=t.Jl(r,s);return this.jv(n),this.Fv&&((n=n.clone()).mapMixColor=this.Fv,n.heatCenter=this.Bv,n.heatSize=this.kv,n.map=this.Gv,n.map.needsUpdate=!0),i.pl.callHook("getMaterialAfter",{createInfo:r,material:n,additionalInfo:s}),n},ov(e,t){var i=this.ur(v),s={opacity:i.Kr};void 0!==this.ir&&(s.opacity=this.ir),this.c0&&(s.isMask=this.c0,s.maskType=this.m0,s.maskPolygons=this.f0,s.maskHolePogygons=this.d0,s.maskHeight=this.g0,s.maskExtrudeHeight=this._0,s.boundCenter=this.w0,s.boundSize=this.M0,s.level=i.level,s.buildingId=i.parent.buildingId,s.maskID=this.$d,s.maskOpacity=this.y0,s.maskNodeHeight=this.av);let r=e.Wt.pl.ql(s),n=(this.jv(r),r.depthTest=!0,r.depthWrite=!1,!(r.visible=!1));return"Safari"===Sm&&(n=!1),e.Wt.pl._u(t,function(t){r.map=t,r.map.wrapS=kt,r.map.wrapT=kt,r.needsUpdate=!0,r.visible=!0,r.polygonOffset=!0,r.polygonOffsetFactor=-1,r.polygonOffsetUnits=-4,e.enableUpdateRender()},{generateMipmaps:n}),r},w2(){var t,e=this.en.top;e&&(e.material.map&&e.material.map.dispose(),e.material.map=null,e.material.dispose(),t=this.ur(E),e.material=this.ov(t,this.lv))},Pr(){var t,e;this.Zs&&(t=this.ur(E))&&(this.Zs.userData.sourceMaterial?this.Zs.userData.sourceMaterial=this.E0(t.Wt.pl):(e=this.Zs.material.userData,this.Zs.material=this.E0(t.Wt.pl),this.Zs.material.userData=e),this.h2(t),this.w2(),t.enableUpdateRender())},h2(t){if(this.Rf&&Math.floor(this.i_)<2){var e=this.cv(t.Wt.pl);this.Rf.material=e;for(let t=0;t<this.Rf.children.length;t++)this.Rf.children[t].material=e}else this.Rf&&(this.Zs.remove(this.Rf),this.Rf.mapNode instanceof Uy?(this.Rf.mapNode.width=this.i_,this.Rf.mapNode.color=this.t2):this.m2());t.enableUpdateRender()},_2(){var t=this.en.top,e=(t.scale.set(this.e1[0],this.e1[1],1),this.qs.getBound());t.position.set(this.t1[0]+this.eg.x-e.center.x,this.t1[1]+this.eg.y-e.center.y,this.Jt+.1),t.rotation.z=-this.Ym*Math.PI/180},fd(){var t=this.ur(rh),e=t.P.Wt;this.X0=e.dd.$u({fid:this.qs.fid,typeID:this.qs.type+"",bid:t.Ht}),0===this.Zv&&(this.X0.image?this.lv=e.zf(this.X0,"logoPath",t.buildingID)+this.X0.image:this.lv=null,this.X0.coords&&(e=this.X0.coords.split(","),this.eg=new ct(parseFloat(e[0]),parseFloat(e[1]))),this.X0.angle&&(this.Ym=this.X0.angle),this.X0.sizes)&&(t=this.X0.sizes.split(","),this.e1=[parseFloat(t[0]),parseFloat(t[1])]),this.Zs&&delete this.Zs.material.userData.dirtyTheme},Q0(){var t;this.Zs&&((t=this.ur(E))&&t.Wt.pl.callHook("removeMaterial",{material:this.Zs?.material,additionalInfo:{themeUseDetail:this.X0.themeUseDetail}}),this.Rf&&(this.Zs.remove(this.Rf),this.Rf.material.dispose(),this.Rf.geometry.dispose(),this.Rf=void 0,t&&this.g2&&this.g2.P_(t),this.g2=null),this.l2(),this.Zs.parent&&this.Zs.parent.remove(this.Zs),this.Zs.geometry.dispose(),this.Zs.geometry=void 0,this.Zs.material=void 0,this.Zs.mapNode=void 0,this.Zs=void 0)},s2(t){return(t=(9301*t+49297)%233280)/233280}});class By extends W3{constructor(){super()}get level(){return this.P.Tr}get visible(){return this.Qs}set visible(t){super.visible=t,this.Qs=t,this.xa.visible=!(!this.P.visible||!this.Qs);t=this.ur(E);t&&t.Wt.Za()}getFeatures(){return this.Ft}dispose(){this.Cv&&this.Cv(),super.dispose()}init(){super.init();var t=this.ur(E);this.visible=t.Wt.E2(this.Ai)}getBound(){var t=this.bound;return{maxY:t.max.y,maxX:t.max.x,minX:t.min.x,minY:t.min.y}}remove(t){this.xa.remove(t.Zs),super.remove(t)}}Object.assign(By.prototype,{lt(t){(t.P=this).Ft.push(t)},b2(t,e){var i,s,r={[p.EXTERNAL_MODEL_LAYER]:PM,[p.MODEL_LAYER]:Fy,[p.EXTENT_LAYER]:cM,[p.FACILITY_LAYER]:DM,[p.LABEL_LAYER]:FM};for([i,s]of t.Ft){var n=new r[this.Ai](s,e.map);this.lt(n),this.type===p.MODEL_LAYER&&this.S2.set(n.FID,n),n.visible=e.map.Wt.ev(this.Ai,{typeID:n.typeID,FID:n.FID})}}});class ky extends By{constructor(){super()}init(){super.init(),this.Tv(),this.Rv(),this.type===p.EXTERNAL_MODEL_LAYER&&tM(this)}}Object.assign(ky.prototype,{Tv(){var t={[p.EXTERNAL_MODEL_LAYER]:"FMExternalModelLayer",[p.MODEL_LAYER]:"FMModelLayer",[p.EXTENT_LAYER]:"FMExtentLayer"},e=this.ur(E),t=t[this.Ai],i=e.Wt.Zu.get(e.getMapOptions().mapID).theme;e.getMapOptions().isuserLight||!i.Mu?this.Lv=new K3(e).createLight(this,t):(i=e.Wt.Zu.get(e.getMapOptions().mapID).theme.Mu,this.Lv=new K3(e).createLightByTheme(this,t,i.extent))},Rv(){this.xa.add(this.yv),this.xa.add(this.Mv),this.xa.add(this.Ev),this.xa.add(this.Ki),this.bv&&this.xa.add(this.bv)},Cv(){this.xa.remove(this.yv),this.xa.remove(this.Mv),this.xa.remove(this.Ev),this.Lv.Qt()}});class Gy extends ky{constructor(t,e){super(),this.mr=t.alias,this.A2=t.desc,this.Jt=t.height,this.Ai=p.EXTENT_LAYER,this.xa.name="extent",this.xa.userData.type="extent",this.T2={},this.b2(t,e)}}class Hy extends ky{constructor(t,e){super(),this.Ai=p.MODEL_LAYER,this.xa.name="model",this.xa.userData.type="model",this.mr="model",this.R2={},this.S2=new Map,this.b2(t,e)}get height(){return this.P.Jt}}class Vy extends By{constructor(){super()}get collision(){return this.Xa}set collision(t){this.Xa!==t&&(this.Xa=t,t=this.ur(E))&&t.Wt.Za()}}class zy extends Vy{constructor(t,e){super(),this.Ai=p.LABEL_LAYER,this.xa.userData.type="label",this.xa.name="label",(this.xa.mapNode=this).mr="label",this.L2={},this.b2(t,e),this.Xa=!0}get type(){return this.Ai}}class Wy extends Vy{constructor(t,e){super(),this.Ai=p.FACILITY_LAYER,this.xa.userData.type="facility",this.xa.name="facility",this.mr="facility",this.C2={},this.Xa=!0,(this.xa.mapNode=this).b2(t,e)}}class jy extends ky{constructor(t,e){super(),this.Ai=p.EXTERNAL_MODEL_LAYER,this.xa.name="externalModel",this.xa.userData.type="externalModel",this.mr="externalModel",this.R2={},this.b2(t,e)}get height(){return this.P.Jt}beforRemove(){this.traverse(t=>{t.beforRemove&&t.beforRemove()})}}class Xy extends j3{constructor(){super(),this.Ai=p.WALL_MARKER}}class Yy extends j3{constructor(){super(),this.Ai=p.TUBE_MARKER,this.Tv()}}Object.assign(Yy.prototype,{Tv(){this.Mv=new q3(7631988),this.Ki=new Js,this.yv=new Sg(8947848,1.2),this.yv.position.set(-1,1,1).normalize(),this.yv.castShadow=!1,this.yv.target=this.Ki,this.Ev=new Sg(3355443),this.Ev.position.set(-.5,1,-1).normalize(),this.Ev.target=this.Ki,this.xa.add(this.yv),this.xa.add(this.Ev),this.xa.add(this.Mv),this.xa.add(this.Ki)}});class Zy extends j3{constructor(){super(),this.Ai=p.LINE3D_MARKER}}class qy extends j3{constructor(){super(),this.Ai=p.SPHERE_MARKER}}let Ky={};Ky.LAYER_CLASS=new Map,Ky.LAYER_CLASS.set(p.EXTENT_LAYER,Gy),Ky.LAYER_CLASS.set(p.MODEL_LAYER,Hy),Ky.LAYER_CLASS.set(p.LABEL_LAYER,zy),Ky.LAYER_CLASS.set(p.FACILITY_LAYER,Wy),Ky.LAYER_CLASS.set(p.EXTERNAL_MODEL_LAYER,jy),Ky.LAYER_CLASS.set(p.IMAGE_MARKER,X3),Ky.LAYER_CLASS.set(p.TEXT_MARKER,Y3),Ky.LAYER_CLASS.set(p.POLYGON_MARKER,Z3),Ky.LAYER_CLASS.set(p.EXTRUDE_MARKER,J3),Ky.LAYER_CLASS.set(p.HEAT_MAP_MARKER,$3),Ky.LAYER_CLASS.set(p.DYNAMIC_MODEL_MARKER,iM),Ky.LAYER_CLASS.set(p.LINE_MARKER,sM),Ky.LAYER_CLASS.set(p.LOCATION_MARKER,rM),Ky.LAYER_CLASS.set(p.DOM_MARKER,nM),Ky.LAYER_CLASS.set(p.WALL_MARKER,Xy),Ky.LAYER_CLASS.set(p.TUBE_MARKER,Yy),Ky.LAYER_CLASS.set(p.LINE3D_MARKER,Zy),Ky.LAYER_CLASS.set(p.SPHERE_MARKER,qy);class Jy extends sh{constructor(t){super(),this.Ls=t.mapOptions,this.nt=t.states,this.qs=t.data,this.Tr=this.qs.gid,this.N2=this.qs.gname,this.I2=this.qs.alias,this.P2=this.qs.desc,this.Jt=0,this.D2=null,this.O2=[p.EXTENT_LAYER,p.EXTERNAL_MODEL_LAYER,p.MODEL_LAYER,p.LABEL_LAYER,p.FACILITY_LAYER],this.Kr=1,this.U2=!0,this.F2=new F3,this.F2.isEffect=!0,this.Sr=null,this.rr=!0}get bound(){return z3(this)}get height(){return this.Jt}get type(){return this.qs.Ai}get center(){var t=this.D2;return{x:(t.minX+t.maxX)/2,y:(t.minY+t.maxY)/2}}get x(){return this.center.x}get y(){return this.center.y}get visible(){return this.Qs}set visible(t){this.Qs=t,this.traverse(t=>{t.xa.visible=!(!t.visible||!this.Qs)});t=this.ur(E);t&&t.Wt.Za()}get level(){return this.Tr}get name(){return this.N2}get ID(){return this.Ht}get alias(){return this.I2}get floorID(){return this.qs.floorId}get effectScene(){return this.F2}getLayers(e,i){if(void 0===e)return this.Ft;var s=[];for(let t=0;t<this.Ft.length;t++)0==(this.Ft[t].type&e)==!!i&&s.push(this.Ft[t]);return s}getExtendMesh(){var t=this.getLayers(p.EXTENT_LAYER)[0];return t?t.Ft[0].Zs:null}getExtendByCoords(e){let i=null;var s=this.getLayers(p.EXTENT_LAYER)[0];for(let t=0;t<s.Ft.length;t++){var r=s.Ft[t],n=r.qs.Ti[0];if(G.Se(e,n,n.length)){i=r;break}}return i}getModelMeshs(t){var e=this.getLayers(p.MODEL_LAYER)[0],i=[],s=[];void 0!==t&&(s.push({x:t.min.x,y:t.min.y}),s.push({x:t.min.x,y:t.max.y}),s.push({x:t.max.x,y:t.max.y}),s.push({x:t.max.x,y:t.min.y}));for(let t=0;t<e.Ft.length;t++)(0===s.length||G.Se(e.Ft[t].bound.center,s,s.length))&&i.push(e.Ft[t]);return i}getBound(){return this.qs.getBound().toObject()}setExtentImage(e){var i=this.getLayers(p.EXTENT_LAYER)[0];for(let t=0;t<i.Ft.length;t++)i.Ft[t].i1(e)}clearExtentImage(){this.setExtentImage("")}getOrCreateLayer(t){var e=this.getLayers(t)[0];return void 0!==e||(e=new(Ky.LAYER_CLASS.get(t)),this.lt(e),this.ur(E).bt.Vt()),e}getMapCoordsRange(){return this.D2}opacity(){return this.Kr}remove(t){t.beforRemove&&t.beforRemove(),super.remove(t);t=this.ur(E);t&&t.bt&&t.bt.Vt()}}Object.assign(Jy.prototype,{B2(){var t=this.nt.Gt(this.P.Ht);t.nonFocusAlphaMode&&(this.P.level===this.Tr?1!==this.Kr&&(this.Kr=1,this.U2=!0):this.Kr!==t.nonFocusAlpha&&(this.Kr=t.nonFocusAlpha,this.U2=!0))},lt(t){(t.P=this).Ft.push(t),this.needUpdateBound=!0,t.init(),this.H2(t)},H2(t){this.F2.add(t.xa)},V2(){var t=this.P;if(this.P.constructor===C3)this.Jt=t.floorSpace*this.Tr;else if(1===t.visibleLevels.length&&this.nt.bs!=t.buildingID){var e=t.parent.jt;this.Jt=e.getFloor(e.level).height}else{let s=1/0,r=0;e=t.alignHeight;e.forEach((t,e,i)=>{Math.abs(this.Tr-e)<s&&(s=Math.abs(this.Tr-e),r=e)}),this.Jt=e.get(r)+t.floorSpace*(this.Tr-r)}},z2(t){t.Ai===p.LOCATION_MARKER&&t.Ft.forEach(t=>{t.Lg()})},br(t){var e=void 0===(t=t||{}).animate||t.animate,i=void 0!==t.duration?t.duration:.5;let s=this.ur(E);var r=this.Jt;this.V2();let n=()=>{s.ya.Ft.forEach(t=>{t.Ai===p.LINE_MARKER&&t.Lg({needUpdateCrossLine:1<this.parent.visibleLevels.length})}),s.enableUpdateNode()};e?(this.W2||(this.W2=new an),this.W2.Y([r]).Z([this.Jt]).K(i).J(e=>{this.traverse(t=>{t.Ai!==p.LINE_MARKER&&t.Ai!==p.LOCATION_MARKER&&(t.xa.position.y=e.destination[0]),this.z2(t)}),n()}).$(()=>{t.finish&&t.finish(),s.ot.ht(this.W2)}),s.ot.lt(this.W2.X())):(this.W2&&this.W2.stop(),this.traverse(t=>{t.Ai!==p.LINE_MARKER&&t.Ai!==p.LOCATION_MARKER&&(t.xa.position.y=this.Jt),this.z2(t)}),n())},j2(i){for(let t=0;t<this.Ft.length;t++)if("externalModel"===this.Ft[t].mr)this.Ft[t].xa.traverse(e=>{if("Mesh"===e.type&&e.material.length)for(let t=0;t<e.material.length;t++)e.material[t].userData.oldAlpha||(e.material[t].userData.oldAlpha=e.material[t].opacity),e.material[t].opacity=i});else for(var e=this.Ft[t].xa.children,s=0;s<e.length;s++)e[s].material&&(e[s].material.userData.oldAlpha||(e[s].material=e[s].material.clone(),e[s].material.userData.oldAlpha=e[s].material.opacity),e[s].material.opacity=i)},X2(){for(let t=0;t<this.Ft.length;t++)if("externalModel"===this.Ft[t].mr)this.Ft[t].xa.traverse(e=>{if("Mesh"===e.type)if(e.material.length)for(let t=0;t<e.material.length;t++)e.material[t].userData.oldAlpha&&(e.material[t].opacity=e.material[t].userData.oldAlpha);else e.material.userData.oldAlpha&&(e.material.opacity=e.material.userData.oldAlpha)});else{var e=this.Ft[t].xa.children;for(let t=0;t<e.length;t++)e[t].material&&e[t].material.userData.oldAlpha&&(e[t].material.opacity=e[t].material.userData.oldAlpha)}},Y2(){this.P.P.Or.Dr.get(this.P.dr).Ft.forEach(t=>{t.gid===this.Tr&&(t=t.Ft.get(p.EXTENT_LAYER).getBound(),this.D2={minX:t.ci.x,minY:t.ci.y,maxX:t.fi.x,maxY:t.fi.y})})},sd(){var t=this.qs,s=null,r=this.ur(E);for(let[e,i]of t.Ft){var n=this.Ft.some(t=>t.type===e);if(!n){let t=Object.keys(this.Ls.hideList);if(!(t=t.map(t=>+t)).includes(e)||0!==Object.keys(this.Ls.hideList[e]).length){s=new(Ky.LAYER_CLASS.get(e))(i,{map:r});if(this.lt(s),e===p.EXTENT_LAYER){var a=[];for(let t=0;t<s.Ft.length;t++)s.Ft[t].N0=HM(s.Ft[t].qs.Ti[0],.2),this.parent.Df&&this.parent.Df.childMapLevel===this.Tr&&a.push({points:s.Ft[t].N0});this.parent.Df&&0<a.length&&(this.parent.Df.polygons=a)}}}}},Z2(e,i){let s=null;for(let t=0;t<e.length;t++)if(""+e[t].Ai==""+i){s=e[t];break}return s},Zm(t){return this.Ft[2].S2.get(t)},q0(t){var e=this.ur(E);if(t&&t.level!==this.level&&e.nt.bs===t.parent.buildingID){var i=t.getLayers(p.EXTENT_LAYER)[0],s=[];if(i)for(let t=0;t<i.children.length;t++)s.push({points:i.children[t].N0});null===this.Sr?(this.Sr=new O3({polygons:s,showRegion:"outside"}),this.Sr.addTo(this),this.Sr.targetLevel=t.level):this.Sr.targetLevel!==t.level&&(this.Sr.polygons=s,this.Sr.targetLevel=t.level)}else null!==this.Sr&&(this.Sr.remove(),this.Sr=null)}});var v=Jy;function $y(t){Object.assign(t.prototype,{E2(t){t=this.st.getMapOptions().hideList[t];return void 0===t||0!==Object.keys(t).length},Ed(e){var t=this.nt.Gt(e.bid);let i=[];t.visibleLevels.forEach(t=>{-1<e.levels.indexOf(t)&&i.push(t)}),t.visibleLevels=i},q2(t,e){e=e||{};let i=this.nt.Gt(t.Ht),s=()=>{this.st.bt.Vt(),e.finish&&e.finish()};"animate"in e&&!e.animate?(t.traverse(t=>{t.br({animate:!1})}),s()):t.traverse(t=>{t.Tr===i.level?t.br({finish:()=>{s()}}):t.br({})})},Vs(t,e){t=this.st.getBuilding(t);return t?t.getFloor(e):null},K2(t){t=this.st.getBuilding(t);return null!==t?t.Ft:[]},Cr(e,i){e.levels.sort(),this.nt.Gt(e.building.Ht).visibleLevels=e.levels,this.Ed({bid:e.building.Ht,levels:e.building.gr}),this.Qf(e,()=>{this.Vt(),this.st.bt.xt();var t={type:"visibleLevelsLoaded"};e.building!==this.st.jt&&(t.buildingID=e.building.Ht),this.st.Yt.Xt(t),i&&i()})},Lr(e,i){this.st.Zt();let s=this.nt.Gt(e.Ht);s.targetLevel=i.level,-1<s.visibleLevelsBak.indexOf(i.level)?(this.st.bi.kt(e,i),void 0!==e.yr&&e.isGroundLevel&&e.yr===i.level&&2===s.visibleLevels.length&&2!==e.gr.length&&(s.visibleLevels.length=0,s.visibleLevels.push(i.level),e.setVisibleLevels(s.visibleLevels))):(s.visibleLevelsBak.length<=1?(s.visibleLevels=[i.level],s.visibleLevelsBak=[i.level],void 0!==e.yr&&e.yr!==i.level&&s.visibleLevels.push(e.yr)):(void 0!==e.yr&&e.isGroundLevel&&e.yr!==i.level&&2===s.visibleLevels.length&&2!==e.gr.length&&(s.visibleLevels.length=0,s.visibleLevels.push(e.yr)),s.visibleLevels.push(i.level),s.visibleLevelsBak.push(i.level)),e.setVisibleLevels(s.visibleLevels,()=>{var t;s.targetLevel===i.level?this.st.bi.kt(e,i):(t={type:"levelChanged",level:i.level},e!==this.st.jt&&(t.buildingID=e.Ht),this.st.Yt.Xt(t),i.finish&&i.finish())},!0))},ed(t){let e=!1;return t.qs.Ft.forEach(t=>{0<t.Ft.size&&(e=!0)}),e},td(t){let e=0;return t.traverse(t=>{this.J0(t)&&e++}),e},Rd(t){var i=this.nt.Gt(t.Ht),s=this.nt.nd(t.Ht);if(!i.visibleLevelsLoaded){let e=!0;var r=t.visibleLevels;for(let t=0;t<r.length;t++)s.get(r[t])||(e=!1);i.visibleLevelsLoaded=e}this.Ls.tile&&!this.Ls.preLoad?i.loaded=i.visibleLevelsLoaded:s.size===t.gr.length&&(i.loaded=!0),this.J2()},J2(){let i=!0;if(this.st.traverse(t=>{var e=this.nt.Gt(t.Ht);e.visibleLevelsLoaded||(t.constructor===A3?this.Qa(t)&&!e.visibleLevelsLoaded&&(i=!1):e.visibleLevelsLoaded||(i=!1))}),!this.nt.Ka&&i&&(this.nt.vd=!0),this.nt.Ka=i,!this.nt.qa){let i=!0,s=!0;this.st.traverse(t=>{var e=this.nt.Gt(t.Ht);e.sceneLoaded||(i=!1),(!this.Qa(t)||e.loaded)&&i||(s=!1)}),!this.nt.qa&&s&&(this.nt.pd=!0),this.nt.qa=s}},zt(){this.nt.Q2=!0},tw(){this.nt.Q2&&(this.ew=[],this.st.traverse(t=>{for(let e=0;e<t.Ft.length;e++){var i=t.Ft[e];i.B2(),i.U2&&i.traverse(t=>{t.traverse(t=>{t.type!==p.EXTENT&&t.type!==p.FACILITY&&t.type!==p.LABEL&&t.type!==p.MODEL&&t.type!==p.EXTERNAL_MODEL&&t.type!==p.TEXT_MARKER&&t.type!==p.DOM_MARKER&&t.type!==p.EXTRUDE_MARKER&&t.type!==p.IMAGE_MARKER&&t.type!==p.POLYGON_MARKER&&t.type!==p.DYNAMIC_MODEL_MARKER||t.Zs&&this.ew.push([e,t])})}),i.U2=!1}}),this.nt.Q2=!1)},iw(){if(0<this.ew.length){let e=0;for(let t=0;t<this.ew.length&&!(++e>this.Ls.maxMaterialCount);t++){var i=this.ew[t][1];i.update?i.update():i.Pr(),this.ew.splice(t,1),t--}this.st.enableUpdateRender()}},Ao(t,e,i){e=new v({mapOptions:this.Ls,states:this.nt,data:e,key:i});return t.lt(e),e.B2(),e.V2(),e},ad(t){t.sd(),t.Y2(),this.rd(t)},sw(t,i){return t.reduce((t,e)=>t&&e!==i,!0)},rw(e,i,s){var r=[];r.push(e);for(let t=0;t<i.length;t++)i[t]!==e&&r.push(i[t]);if(s)for(let t=0;t<s.length;t++)this.sw(r,s[t])&&r.push(s[t]);return r}})}let Qy={isDestory:!1,textureCanvas:null,boundingClientRect:null,dispose:()=>{}};class tE{constructor(t,e,i,s){this.st=t,this.Ls=e,this.nt=i,this.W=s,this.pl=new Vm(this),this.qs=null,this.Zf=new G2(t,this),this.dd=new Wm(this),this.Zu=new Map,this.Ua=[],this.ew=[],this.Xf=0,this.tv=!1,this.V=this.V.bind(this),this.H0=null,this.nw=this.nw.bind(this),this.aw=new Ar(new Gt(0,1,0),0),this.Vr=new Qa,this.Z0=!0,this.L0=null,t.on("visibleLevelsLoaded",this.nw),t.on("loaded",this.nw),t.on("viewChanged",this.nw),t.on("viewModeChanged",this.nw),t.on("buildingEntered",this.nw),t.on("buildingExited",this.nw),t.on("zoom",this.nw),t.on("move",this.nw),t.on("mapLoaded",this.nw),t.on("levelChanged",this.nw),t.on("sceneLoaded",this.nw),t.on("firstViewLoaded",this.nw),t.on("ViewBuildingChange",this.nw),t.on("beforeRender",this.V),this.jo=null,this.Sa=this.Sa.bind(this),this.Qh=new Qp({disposeCallback:this.Sa,enable:!0,name:"NodeManager",mapCreateTime:this.st.Il}),e.webWorker?.useWebWorker&&(this.Ha=new nt.TaskProcessor("workerCore.js",e.webWorker),this.Tg=new nt.TaskProcessor("workerCalculate.js",e.webWorker))}}Object.assign(tE.prototype,{nw(e){if("visibleLevelsLoaded"!==e.type&&"loaded"!==e.type&&"viewChanged"!==e.type||(this.nt.Y0=!0,this.Za()),"viewModeChanged"===e.type&&this.st.bi.yt.updateCheck(),"mapLoaded"===e.type&&this.st.hw(t=>{this.T0({bid:t.Ht})}),"move"===e.type&&this.st.Zt(),"buildingEntered"!==e.type&&"buildingExited"!==e.type||(this.T0({bid:e.buildingID}),"buildingExited"===e.type?e.isVisibuildingChange||null===this.L0||(this.L0.remove(),this.L0=null,this.st.getBuilding(e.buildingID).Df=null):this.R0({bid:e.buildingID})),"zoom"===e.type){if(this.st.Zt(),this.st.traverse(t=>{t!==this.st.jt&&(this.T0({bid:t.Ht}),t.Ld())}),nt.environment===I.WX){if(void 0===Qy.lastHandleZoomTime&&(Qy.lastHandleZoomTime=Date.now()),Date.now()-Qy.lastHandleZoomTime<50)return void(Qy.lastHandleZoomTime=Date.now());Qy.lastHandleZoomTime=Date.now()}this.st.traverse(t=>{t.visible&&t.traverse(t=>{t.visible&&t.traverse(t=>{t.visible&&t.traverse(t=>{t.type===p.EXTERNAL_MODEL&&t.Zs&&(!(t.qs&&(t.qs.maxlevel<=e.zoom||t.qs.minlevel>e.zoom))?t.fading&&t.Nm():t.Im())})})})})}if("levelChanged"===e.type||"visibleLevelsLoaded"===e.type){if(e.buildingID&&e.buildingID!==this.st.Ls.buildingID){var i=this.st.getBuilding(e.buildingID);if(i&&i.traverse(t=>{t.br()}),i&&i.Df){var s=this.C0(i);i.Df.polygons=s;let t=i.Nf[1];1===i.visibleLevels.length&&(t=i.level),i.Df.childMapLevel=t}}else this.st.traverse(t=>{"levelChanged"===e.type&&t.Ht!==this.st.Ls.buildingID&&t.Cd(e.level),t.traverse(t=>{t.br({animate:!1})})});this.st.bi.yt.updateCheck()}"sceneLoaded"!==e.type||e.buildingID||this.Wf(e.type),"visibleLevelsLoaded"===e.type&&void 0===e.buildingID&&this.Wf(e.type),"loaded"===e.type&&this.Wf(e.type),"firstViewLoaded"===e.type&&this.Wf(e.type),"ViewBuildingChange"===e.type&&(e.buildingID!==this.st.Ls.buildingID?this.st.bi.yt.updateCheck():this.st.getMapOptions().followFocus||(s=this.st.getBuilding(e.buildingID),this.st.bi.Kt(s,{level:s.level,animate:!1})))},Z_(t){var e=(new Gt).copy(this.st.bi.yt.target),i=new ct(0,0);e.y=t+i.y;let s;return 10/(s="PerspectiveCamera"===this.st.ct.type?(t=this.st.ct.near,i=this.st.ct.fov,e=this.st.bi.yt.object.position.distanceTo(e),10*t*Math.tan(i/2*u.DEG2RAD)*2/this.st.bt.renderer.domElement.clientHeight*e/t):(i=this.st.ct.top,e=this.st.ct.bottom,10*Math.abs(i-e)/this.st.bt.renderer.domElement.clientHeight/this.st.ct.zoom))},V(){this.nt.ac&&(this.tw(),this.iw(),this.Oa(),this.Fa(),this.st.bt.$a(),this.st.bt.ow())},Za(){this.st.bt.Za()},Vt(){this.st.bt.Vt()},$0(t,e){if(!t.getBound||!e)return!0;t=t.boundNoClone;if(!t)return!0;let i=!0;var{max:t,min:s}=t,{max:e,min:r}=e;return t.x<r.x||s.x>e.x||t.y<r.y||e.y<s.y?i=!1:i},K0(e,t){var i=[],s=[],r=this.Ls.container.clientWidth,n=this.Ls.container.clientHeight,a=(i.push(aa.coordsScreenToMap(this.st,{x:0,y:0,level:t,buildingID:e.Ht})),i.push(aa.coordsScreenToMap(this.st,{x:r,y:0,level:t,buildingID:e.Ht})),i.push(aa.coordsScreenToMap(this.st,{x:r,y:n,level:t,buildingID:e.Ht})),i.push(aa.coordsScreenToMap(this.st,{x:0,y:n,level:t,buildingID:e.Ht})),e.visibleLevels),h=new sa;for(let t=0;t<a.length;t++){var o=e.getFloor(a[t]).getBound();h.vi([o.max,o.min])}s.push({x:h.min.x,y:h.min.y}),s.push({x:h.min.x,y:h.max.y}),s.push({x:h.max.x,y:h.max.y}),s.push({x:h.max.x,y:h.min.y});r=[],n3.PolygonClip(i,s,r),n=new r3;return n.setFromPoints(r),n},lw(i,s){var r=new mw;let e=i[0];if(0<e.length){G.ui(e)||(e=e.reverse()),r.moveTo(e[0].x-s.center.x,e[0].y-s.center.y);for(let t=1;t<e.length;t++)r.lineTo(e[t].x-s.center.x,e[t].y-s.center.y)}if(1<i.length)for(let t=1;t<i.length;t++){let e=i[t];var n=new pw;if(0<e.length){G.ui(e)||(e=e.reverse()),n.moveTo(e[0].x-s.center.x,e[0].y-s.center.y);for(let t=1;t<e.length;t++)n.lineTo(e[t].x-s.center.x,e[t].y-s.center.y)}r.holes.push(n)}return r},uc(t,e,i,s){var r=t.Ti,n=t.getBound(),t=this.lw(r,n);let a=null;a=0===e?new $w(t):new t3(t,{depth:e,bevelEnabled:!1});let h,o,l,u;u=s?(h=i.min.x,o=i.min.y,l=i.max.x-h,i.max.y-o):(h=n.min.x,o=n.min.y,l=n.max.x-h,n.max.y-o);var{position:c,uv:f}=a.attributes;for(let e=0;e<c.count;e++){var d=c.getX(e),v=c.getY(e),p=c.getZ(e),d=(d+n.center.x-h)/l;let t=(v+n.center.y-o)/u;s&&(t=0===p?0:1),f.setX(e,d),f.setY(e,t)}return a.computeBoundingSphere(),{geometry:a,shape:t}},Jv(t){let{type:i,data:s,amount:r,referenceBound:n}=t;return new Promise((t,e)=>{t(this.uc(s,r,n,i==p.MODEL))})},uw(t){let s=new Nh;return t.forEach(t=>{var{itemSize:t,array:e,key:i}=t,e=new Float32Array(e);s.setAttribute(i,new N(e,t))}),s},Kv(t){let{data:o,amount:l,referenceBound:u,type:c,createLineType:f,lineHeight:d}=t;return new Promise((s,t)=>{let i=[];o.Ti.forEach((t,e)=>{i[e]=[],t.forEach(t=>{i[e].push(t.x,t.y)})});var e=[];for(let t=0;t<i.length;t++){var r=i[t],n=new ArrayBuffer(8*r.length);new Float64Array(n).set(r),e.push(n)}let a=o.getBound(),h=null;u&&(h={max:{x:u.max.x,y:u.max.y},min:{x:u.min.x,y:u.min.y}}),this.Ha.Ga({type:c,coordGroup:e,bound:{max:{x:a.max.x,y:a.max.y},min:{x:a.min.x,y:a.min.y}},referenceBound:h,amount:l,lineHeight:d,createLineType:f},e).then(t=>{var{attributesInfo:t,lineAttributeInfo:e}=t.result,t=this.uw(t);t.computeBoundingBox(),t.computeBoundingSphere();let i;"geometry"===f?i=this.uw(e):"onlyData"===f&&(i=new Float32Array(e)),s({shape:1<o.Ti.length?this.lw(o.Ti,a):null,lineData:i,geometry:t})})})},Hf(i){let s=this.nt.Gt(i.bid);s.themeNeedLoad=!0,s.themeLoaded=!1,this.ud({themeID:i.themeID},t=>{s.themeID=i.themeID;let e=this.Zu.get(i.bid);e||(this.Zu.set(i.bid,{theme:new zm}),e=this.Zu.get(i.bid)),e.theme.Bu(t),s.themeLoaded=!0,i.bid===this.Ls.buildingID&&(this.nt.fd(this.dd),this.st.setBackgroundColor(this.nt.backgroundColor,this.nt.backgroundAlpha)),this.V0()})},Vf(t){let e=this.Zu.get(t.bid);t.data?(e||(this.Zu.set(t.bid,{themeExtension:new a3}),e=this.Zu.get(t.bid)),e.themeExtension||(e.themeExtension=new a3),e.themeExtension.Bu(t.data)):e&&e.themeExtension&&(this.Ls.buildingID===t.bid?e.themeExtension.resize():(e.themeExtension.Qt(),e.themeExtension=null)),this.nt.fd(this.dd),this.st.setBackgroundColor(this.nt.backgroundColor,this.nt.backgroundAlpha),!1!==t.needUpdataNode&&this.G0(t)},Qt(t){clearTimeout(this.$f),this.st.off("visibleLevelsLoaded",this.nw),this.st.off("loaded",this.nw),this.st.off("viewChanged",this.nw),this.st.off("viewModeChanged",this.nw),this.st.off("buildingEntered",this.nw),this.st.off("zoom",this.nw),this.st.off("move",this.nw),this.st.off("buildingLoaded",this.nw),this.st.off("beforeRender",this.V),this.st.off("ViewBuildingChange",this.nw),this.jo=t,this.pl.Qt(()=>{this.pl=null,this.Qh.qh(!0)})},Sa(){for(var t in this.Ua=[],this.Zf.Qt(),this.Zf=null,this.Zu.clear(),this.Ha&&this.Ha.cw(),this.Tg&&this.Tg.cw(),this.st=null,this)this[""+t]&&this[""+t].Qt&&this[""+t].Qt();for(var e in this.jo&&this.jo({name:"NodeManager"}),this)this[""+e]=null,delete this[""+e]}}),R3(tE),U3(tE),$y(tE);class eE{constructor(){this.Ft=new Map,this.fw=[],this.te=(new Date).getTime(),this.dw=new Map,this.jo=null,this.Sa=this.Sa.bind(this),this.Aa=0,this.Ma()}}Object.assign(eE.prototype,{lt(e){if(Array.isArray(e)){this.Ft.set(e[0].j,e[0]),e[0].P=this;for(let t=1;t<e.length;t++)e[t].O=e[t-1].O+e[t-1].B,e[t].U=e[t-1].U+e[t-1].B,this.Ft.set(e[t].j,e[t]),e[t].P=this}else this.Ft.has(e.j)||(this.Ft.set(e.j,e),e.P=this,e.O=this.te)},ht(e){if(Array.isArray(e))for(let t=0;t<e.length;t++)this.Ft.delete(e[t].j);else this.Ft.delete(e.j)},Bm(t){this.fw.push(t)},Wm(t){t=this.fw.indexOf(t);-1<t&&this.fw.splice(t,1)},$s(t){this.dw.set(t.j=nn.generateUUID(),t)},Ks(t){this.dw.delete(t.j)},V(e,i,s){var r=[],n=[];for(let t=0;t<e.N.length;t++)void 0===e.D[t]&&(e.D[t]=0),1<=i?(r.push(e.I[t]),n.push(e.I[t]-e.N[t]-e.D[t])):(r.push((e.I[t]-e.N[t])*i+e.N[t]),n.push((e.I[t]-e.N[t])*s),e.D[t]+=(e.I[t]-e.N[t])*s);e.V({destination:r,delta:n}),n.length=r.length=0},Ma(){this.Aa=nt.window.requestAnimationFrame(this.Ma.bind(this));let s=(new Date).getTime(),r=s-this.te;this.dw.forEach(t=>t(r));for(let t=0;t<this.fw.length;t++)this.fw[t].update(r/1e3);this.Ft.forEach(t=>{var e,i;t.H||(t.G?t.F+=r:(e=(s-t.O)/t.B,i=r/t.B,this.V(t,e,i),e=s-t.O-t.U,t.B<=e&&(t.D=[],t.k?(t.O=s,t.W&&t.W()):(i=t.H,t.H=!0,!i&&t.W&&t.W()))))}),this.te=s},Qt(t){this.jo=t,this.Sa()},Sa(){this.Aa&&(nt.window.cancelAnimationFrame(this.Aa),this.Aa=0),this.Ft.forEach(function(t){t.Qt()}),this.Ft.clear(),this.fw=[],this.dw.clear(),this.jo&&this.jo({name:"Animator"})}});class iE{constructor(){this.pw=!0,this.T={}}}Object.assign(iE.prototype,{mw(t,e){this.gw(t,e)||(void 0===this.T[t]&&(this.T[t]=[]),this.T[t].push(e))},gw(t,e){return e?void 0!==this.T[t]&&-1!==this.T[t].indexOf(e):void 0!==this.T[t]&&0<this.T[t].length},_w(t,e){void 0!==this.T[t]&&-1!==(e=this.T[t].indexOf(e))&&this.T[t].splice(e,1)},Xt(i){if(this.pw&&void 0!==this.T[i.type]){var s=this.T[i.type].slice(0);for(let t=0,e=s.length;t<e;t++)s[t].call(this,i)}}});let sE={Entire:2,Individual:4},rE=(Object.freeze(sE),{RUNTIME:0,DIRTY:1});class nE{constructor(t){this.container=t.container,this.appName=t.appName,this.key=t.key,this.license=t.license,this.mapID=t.mapID,this.buildingID=t.mapID,this.mapURL=t.mapURL,this.mapURLAbsolute=void 0!==t.mapURLAbsolute&&t.mapURLAbsolute,this.themeTool=void 0!==t.themeTool?t.themeTool:null,this.merge=void 0!==t.merge?t.merge:null,this.userThemeURL=t.themeURL,this.themeURL=t.themeURL||Wp.themeUrl,this.themeID=t.themeID||"2001",this.externalModelURL=t.externalModelURL,this.X0=t.theme,this.themeExtension=void 0!==t.themeExtension?t.themeExtension:{},this.isPreview=void 0!==nt.KjWzhWlSj&&!!nt.KjWzhWlSj.ProtoDef,this.nonFocusAlpha=void 0!==t.nonFocusAlpha?t.nonFocusAlpha:.1,this.nonFocusAlphaMode=void 0!==t.nonFocusAlphaMode&&t.nonFocusAlphaMode,this.state=t.state||{},this.center=(void 0!==this.state.center?this.state:t).center,this.zoomRange=void 0!==this.state.zoomRange?this.state.zoomRange:void 0!==t.zoomRange?t.zoomRange:[16,23],this.mapZoom=void 0!==this.state.zoom?this.state.zoom:void 0!==t.mapZoom?t.mapZoom:20,this.rotation=void 0!==this.state.rotation?this.state.rotation:void 0!==t.rotation?t.rotation:0,this.maxTiltAngle=void 0!==t.maxTiltAngle?t.maxTiltAngle:90,this.minTiltAngle=void 0!==t.minTiltAngle?t.minTiltAngle:30,this.tiltAngle=void 0!==this.state.tiltAngle?this.state.tiltAngle:void 0!==t.tiltAngle?t.tiltAngle:30,this.viewMode=void 0!==this.state.viewMode?this.state.viewMode:void 0!==t.viewMode?t.viewMode:Cr.MODE_3D,this.floorSpace=void 0!==this.state.floorSpace?this.state.floorSpace:void 0!==t.floorSpace?t.floorSpace:50,this.level=void 0!==this.state.level?this.state.level:void 0!==t.level?t.level:1,this.visibleLevels=void 0!==this.state.visibleLevels?this.state.visibleLevels:void 0!==t.visibleLevels?t.visibleLevels:[1],this.buildingOptions=t.buildingOptions||{},this.navigationData=t.navigationData,this.buildings=t.buildings,this.backgroundColor=t.backgroundColor,this.backgroundAlpha=t.backgroundAlpha,this.Uu=t.highlightColor,this.Qr=void 0!==t.highlightPicker?t.highlightPicker:["click"],this.groundLevel=t.excavatedLevel,this.logarithmicDepthBuffer=t.logarithmicDepthBuffer||!1,this.tile=!1!==t.tile||t.tile,this.preLoad=!1!==t.preLoad||t.preLoad,this.followFocus=t.followFocus,void 0===this.followFocus&&(this.followFocus=!1),this.loadLayerWaitingTime=t.loadLayerWaitingTime||.002,this.renderOrder=t.renderOrder||[p.EXTENT,p.CAD_LAYER,p.EXTERNAL_MODEL,p.MODEL,p.DYNAMIC_MODEL_MARKER,p.EXTRUDE_MARKER,p.TUBE_MARKER,p.WALL_MARKER,p.SPHERE_MARKER,p.POLYGON_MARKER,p.HEAT_MAP_MARKER,p.LINE3D_MARKER,p.LINE_MARKER,p.FACILITY,p.LABEL,p.IMAGE_MARKER,p.TEXT_MARKER,p.LOCATION_MARKER],this.collisionOrder=t.collisionOrder?Pr.uniqWithArrayTwo(t.collisionOrder):[[p.TEXT_MARKER,p.IMAGE_MARKER]],this.fontFamily=t.fontFamily||'"Microsoft Yahei","",Tahoma,Arial',this.hdr=t.hdr,this.shadingMode=void 0!==t.shadingMode?t.shadingMode:ih.REAL,this.materialMode=this.shadingMode,this.maxMaterialCount=void 0!==t.maxMaterialCount?t.maxMaterialCount:1/0;var{interaction:e={},lock:i,enabledPanRange:s,panRangeValue:r,mouseMode:n}=t;if(this.interaction={lock:e.lock??i??!1,enabledPanRange:e.enabledPanRange??s??!1,panRangeValue:e.panRangeValue??r??null,mouseMode:e.mouseMode??n??pa.NORMAL,zoomCenterType:e.zoomCenterType??Ca.CENTER},this.labelField=void 0!==t.labelField?t.labelField:L3.NAME,this.panRangeValues={},null!==this.interaction.panRangeValue&&(this.panRangeValues[this.mapID]=this.interaction.panRangeValue),this.buildingOptions.buildings)for(let t=0;t<this.buildingOptions.buildings.length;t++){var a=this.buildingOptions.buildings[t].panRangeValue;a&&(this.panRangeValues[this.buildingOptions.buildings[t].buildingID]=a)}if(this.screenLockCoords=t.screenLockCoords,this.lightConfig={FMExtentLayer:[{name:"DirectionalLight",color:11579568,intensity:.95,position:{x:58,y:65,z:40},id:0},{name:"AmbientLight",color:11579568,intensity:.85,id:1},{name:"DirectionalLight",color:6447714,intensity:.65,position:{x:-100,y:0,z:45},id:2}],FMDynamicModelLayer:[{name:"DirectionalLight",color:11579568,intensity:.95,position:{x:58,y:65,z:45},id:0},{name:"AmbientLight",color:11579568,intensity:.85,id:1},{name:"DirectionalLight",color:6447714,position:{x:-100,y:0,z:45},intensity:.45,id:2}],FMModelLayer:[{name:"DirectionalLight",color:11645361,intensity:.95,position:{x:58,y:65,z:40},id:0},{name:"AmbientLight",color:11645361,intensity:.85,id:1},{name:"DirectionalLight",color:6513507,position:{x:-100,y:0,z:45},intensity:.65,id:2}],FMExternalModelLayer:[{name:"DirectionalLight",color:11579568,intensity:.95,position:{x:58,y:65,z:45},id:0},{name:"AmbientLight",color:11579568,intensity:.85,id:1},{name:"DirectionalLight",color:6447714,position:{x:-100,y:0,z:45},intensity:.45,id:2}]},this.isuserLight=!1,void 0!==t.light&&(this.lightConfig=t.light.getConfig(),this.isuserLight=!0),this.lockedLight=void 0===t.lockedLight||t.lockedLight,this.hideList=void 0!==t.hideList?t.hideList:{},this.ClassicMaterial=void 0===t.ClassicMaterial||t.ClassicMaterial,this.isOutdoor=!0,this.enableDamping=void 0!==t.enableDamping&&t.enableDamping,this.enterTriggerMode=void 0!==t.enterTriggerMode?t.enterTriggerMode:sE.Entire,this.autoPlay=void 0===t.autoPlay||t.autoPlay,this.decoderURL=void 0!==t.decoderURL?t.decoderURL:null,this.HDText=void 0!==t.HDText&&t.HDText,this.depthPeeling=void 0!==t.depthPeeling?t.depthPeeling:null,this.depthPeeling&&(this.depthPeeling.mode=t.depthPeeling?.mode||rE.RUNTIME,this.depthPeeling.layers=t.depthPeeling?.layers||4,this.depthPeeling.types=t.depthPeeling?.types||[p.MODEL_LAYER,p.EXTERNAL_MODEL_LAYER,p.DYNAMIC_MODEL_MARKER]),this.labelFade=void 0!==t.labelFade?t.labelFade:nt.environment===I.BROWSER,this.preserveDrawingBuffer=!1,void 0!==t.preserveDrawingBuffer&&(this.preserveDrawingBuffer=t.preserveDrawingBuffer),this.webWorker=void 0!==t.webWorker?t.webWorker:{useWebWorker:!1},this.webWorker.useWebWorker)try{var h=new Error,o=h.stack||h.sourceURL||h.stacktrace||"";let t=o.match(/(https?:\/\/[^\s]+\/)/);if(!t&&!(t=o.match(/(file?:\/\/[^\s]+\/)/)))return void console.error("worker path failed.");this.webWorker.baseURL=t[0]+"workers/"}catch(t){}nt.environment===I.WX&&(this.webWorker.useWebWorker=!1),this.shadingMode===ih.CLASSIC&&Zr(bi);var{effect:i={}}=t;this.effect={modelSideGradient:i.modelSideGradient??!0,ignoreLighting:i.ignoreLighting??!1},Xr(this.effect.modelSideGradient),$r(this.effect.ignoreLighting)}}class aE{constructor(t){this.Ls=t,this.zoomRange=this.Ls.zoomRange,this.zoom=this.Ls.mapZoom,this.Ws=this.Ls.rotation,this.ww=this.Ls.maxTiltAngle,this.Mw=this.Ls.minTiltAngle,this.tiltAngle=this.Ls.tiltAngle,this.Rs=this.Ls.viewMode,this.yw=new Map,this.Ew(),this.ac=!1,this.Ka=!1,this.qa=!1,this.pd=!1,this.vd=!1,this.F0=this.Ls.labelField,this.yi=new Gt,this.ls=this.ns,this.Xr=!1,this.xw=!0,this.bw=!1,this.Uu=void 0!==this.Ls.Uu?this.Ls.Uu:null,this.Sw=null,this.Aw=void 0!==this.Ls.backgroundColor?this.Ls.backgroundColor:null,this.Tw=null,this.Rw=void 0!==this.Ls.backgroundAlpha?this.Ls.backgroundAlpha:null,this.Lw=null,this.Cw=null,this.Yf=!1,this.th=!1,this.Y0=!1,this.Q2=!0,this.Nw=this.Ls.collisionOrder,this.bs=this.Ls.buildingID,this.qv=this.Ls.webWorker.useWebWorker}get zoom(){return this.ns}set zoom(t){this.ns=Math.min(Math.max(t,this.rt[0]),this.rt[1])}get zoomRange(){return this.rt}set zoomRange(t){t[0]=Math.min(Math.max(t[0],1),29),t[1]=Math.min(Math.max(t[1],1),29),this.rt=t}get tiltAngle(){return this.zs}set tiltAngle(t){t=Math.min(Math.max(t,this.Mw),this.ww),this.zs=t}get highlightColor(){return null!==this.Uu?this.Uu:this.Sw}set highlightColor(t){this.Uu=t}get backgroundColor(){return null!==this.Aw?this.Aw:this.Tw}get backgroundAlpha(){return null!==this.Rw?this.Rw:this.Lw}}Object.assign(aE.prototype,{Ew(){this.Iw(this.Ls.buildingID);var e=this.Ls.buildingOptions.buildings;if(e)for(let t=0;t<e.length;t++)e[t].buildingID&&this.Iw(e[t].buildingID)},fd(t){this.Sw=t.ic(this.Ls.buildingID);t=t.qu(this.Ls.buildingID);this.Tw=t.clearColor,this.Lw=t.clearAlpha,this.Cw=t.alphaTest,null!==this.Cw&&Kr(this.Cw)},Pw(t,e){switch(t){case"click":this.xw=e;break;case"move":this.bw=e;break;case"hover":this.Xr=e}},Dw(t){this.Ls.center&&(this.yi.x=this.Ls.center.x-t.x,this.yi.z=-this.Ls.center.y+t.y)},Gt(t){return this.yw.has(t)||this.Iw(t),this.yw.get(t)},Iw(e){let i={};if(this.Ls.buildingID===e)(i={themeID:this.Ls.themeID,visibleLevels:this.Ls.visibleLevels,level:this.Ls.level,groundLevel:this.Ls.groundLevel,targetLevel:this.Ls.level,floorSpace:this.Ls.floorSpace,nonFocusAlphaMode:this.Ls.nonFocusAlphaMode,nonFocusAlpha:this.Ls.nonFocusAlpha}).visibleLevelsBak=[...i.visibleLevels];else{var t=this.Ls.buildingOptions,s=t.buildings;if(i={themeID:t.themeID,themeExtension:t.themeExtension,visibleLevels:void 0!==t.visibleLevels?t.visibleLevels:[],level:t.level,targetLevel:t.level,floorSpace:(void 0!==t.floorSpace?t:this.Ls).floorSpace,overviewMode:void 0!==t.overviewMode?t.overviewMode:l3.NORMAL,isExcavate:void 0!==t.isExcavatedByBuilding&&t.isExcavatedByBuilding,nonFocusAlphaMode:(void 0!==t.nonFocusAlphaMode?t:this.Ls).nonFocusAlphaMode,nonFocusAlpha:(void 0!==t.nonFocusAlpha?t:this.Ls).nonFocusAlpha,minLevel:t.minLevel,maxLevel:t.maxLevel,themeLoaded:!1,themeNeedLoad:!0,groundLevel:t.excavatedLevel},s)for(let t=0;t<s.length;t++)s[t].buildingID===e&&(void 0!==s[t].themeID&&(i.themeID=s[t].themeID),void 0!==s[t].themeExtension&&(i.themeExtension=s[t].themeExtension),void 0!==s[t].visibleLevels&&(i.visibleLevels=s[t].visibleLevels,i.visibleLevelsBak=s[t].visibleLevels),void 0!==s[t].level&&(i.level=s[t].level),void 0!==s[t].targetLevel&&(i.targetLevel=s[t].targetLevel),void 0!==s[t].floorSpace&&(i.floorSpace=s[t].floorSpace),void 0!==s[t].overviewMode&&(i.overviewMode=s[t].overviewMode),void 0!==s[t].nonFocusAlphaMode&&(i.nonFocusAlphaMode=s[t].nonFocusAlphaMode),void 0!==s[t].nonFocusAlpha&&(i.nonFocusAlpha=s[t].nonFocusAlpha),void 0!==s[t].minLevel&&(i.minLevel=s[t].minLevel),void 0!==s[t].maxLevel&&(i.maxLevel=s[t].maxLevel),void 0!==s[t].isExcavatedByBuilding&&(i.isExcavate=s[t].isExcavatedByBuilding),void 0!==s[t].excavatedLevel)&&(i.groundLevel=s[t].excavatedLevel);i.visibleLevelsBak=[...i.visibleLevels]}i.level&&-1===i.visibleLevels.indexOf(i.level)&&(1<i.visibleLevels.length?(i.visibleLevels.push(i.level),i.visibleLevelsBak.push(i.level)):(i.visibleLevels=[i.level],i.visibleLevelsBak=[i.level])),this.Ls.buildingID===e&&void 0!==i.groundLevel&&1===i.visibleLevels.length&&i.level!==i.groundLevel&&i.visibleLevels.push(i.groundLevel),this.yw.set(e,i)},nd(t){t=this.Gt(t);return t.levelsLoaded||(t.levelsLoaded=new Map),t.levelsLoaded},hc(t){t=this.yw.get(t);return!1===t.themeNeedLoad||!1!==t.themeLoaded}});class hE{constructor(t){this.loadManager=t,this.requests=new Map}add(t,e){this.requests.set(t,e)}abortAll(){this.requests.forEach((t,e)=>{t.abort(),this.loadManager.itemEnd(e)}),this.requests.clear(),this.loadManager=null}}let oE=(t,e,i,s)=>{t.Or=new pm({mapCreateTime:t.Il}),t.Wt=new tE(t,e,i,s),t.Wt.j0()};class lE extends sh{constructor(t){super(),t.uatEnvironment&&jp(),this.js={error:[]},this.Il=(new Date).getTime(),this.Ls=new nE(t),this.nt=new aE(this.Ls),this.t=null,this.o=null,nt.environment===I.WX&&(nt.initCanvas(this.Ls,this),Qy.isDestory=!1),this.jt=null,this.rc=!1,this.Ow=new Gt,this.qt=null!=t.followFocus&&t.followFocus,this.Uw=null,this.Fw=!1,this.ua=[p.IMAGE_MARKER,p.TEXT_MARKER],this.Yt=new iE,this.ot=new eE,this.Or=null,this.Wt=null,this.Ps=null,this.Lt=null,nt.environment==I.BROWSER?this.ct=this.Bw(this.Ls.container.clientWidth,this.Ls.container.clientHeight):this.ct=this.Bw(this.Ls.container.width,this.Ls.container.height),this.bt=new av(this,this.Ls,this.nt),this.ya=new j3,(this.ya.P=this).bi=new za(this,this.Ls.container,this.nt),this.bi.enableDragRange=this.Ls.interaction.enabledPanRange,this.Ls.interaction.panRangeValue&&(this.Ls.enabledPanRange=!0,this.bi.enableDragRange=!0),this.Vr=new oh(this,this.Ls,this.nt),this.Sa=this.Sa.bind(this),this.kw=!1,this.St=this.St.bind(this),this.Gw=this.Gw.bind(this),this.Hw=[],this.Vw=!1,this.zw=null,this.Ww=null,this.jw=this.jw.bind(this),nt.environment==I.BROWSER&&(this.Xw=new nt.DomMarkerManager(this)),this.Yw(),this.Um=new hE(Zm),Zm.onLoad=()=>{this.enableUpdateRender()}}get requestDispose(){return this.kw}get focusBuilding(){return this.Zw}get x(){return this.t}get y(){return this.o}get bound(){return!0===this.needUpdateBound&&0<this.Ft.length&&(this.mi.reset(),this.Ft.forEach(t=>{this.mi.expand(t.bound)}),this.mi.expand(this.ya.bound),this.needUpdateBound=!1),this.mi.clone()}get camera(){return this.ct}set camera(t){this.ct=t}get followFocus(){return this.qt}set followFocus(t){this.qt!==t&&(this.qt=t,this.qt||this.bi.Kt(this.jt,{level:this.getLevel()}))}getScaleBarInfo(){let t;var e={x:(t=nt.environment===I.WX?{x:nt.document.body.clientWidth/2,y:nt.document.body.clientHeight/2}:{x:document.body.clientWidth/2,y:document.body.clientHeight/2}).x+100,y:t.y},i=aa.coordsScreenToMap(this,t),e=aa.coordsScreenToMap(this,e),i=Math.sqrt((i.x-e.x)*(i.x-e.x)+(i.y-e.y)*(i.y-e.y))/100;let s=[1e7,5e6,2e6,1e6,5e5,2e5,1e5,5e4,25e3,2e4,1e4,5e3,2e3,1e3,500,200,100,50,20,10,5,2,1,.5,.2,.1,.05,.02,.01][Math.floor(this.getZoom())-1],r="";return r=s<1e3&&1<=s?"":s<1?(s*=1e3,""):(s/=1e3,""),{screenDistance:s/i,actualDistance:s,unit:r}}setDevicePixalRatio(t){this.getRenderManager().renderer.setPixelRatio(t),this.Yt.Xt({type:"pixelRatioChanged"}),this.enableUpdateRender()}removeAnimator(t){this.ot.ht(t)}addAnimator(t){this.ot.lt(t)}copyCamera(){let t=null;return(t=this.ct===this.Ps?new ir(u.FOV,1,u.CAMERA_NEAR,u.CAMERA_FAR):new sr(1,1,1,1,u.CAMERA_NEAR,u.CAMERA_FAR)).copy(this.ct),t}enableUpdateRender(){this.nt.th=!0}enableUpdateNode(){this.nt.Y0=!0}getFloorInfos(){return this.getBuilding(this.Ls.buildingID).getFloorInfos()}setHighlightColor(t){this.nt.highlightColor=t}setControlTarget(t){this.bi.Xs(t)}resize(t,e){this.bt.ba(t,e)}getMarkerGroup(){return this.ya}getVisibleLevels(){return this.jt.visibleLevels}setTheme(t){this.Wt.Hf({themeID:t,bid:this.Ls.buildingID})}setThemeExtension(t,e){this.Wt.Vf({data:t,bid:this.Ls.buildingID,...e})}clearThemeExtension(){this.Wt.Vf({bid:this.Ls.buildingID})}getRenderOrder(){return this.bt.ua}setRenderOrder(t){this.bt.Ca(t)}getCollisionOrder(){return this.nt.Nw}setCollisionOrder(t){this.nt.Nw=Pr.uniqWithArrayTwo(t),this.Wt.Za()}adjustRenderOrder(t){this.bt.La(t)}setVisibleLevels(t,e){this.jt.setVisibleLevels(t,e)}getRenderManager(){return this.bt}setRenderManager(t){for(var e in this.bt.render=t.render,this.bt.getLayerType=t.getLayerType,t)this.bt[e]=t[e];this.bt.renderer=this.bt.getRenderer()}getCenter(){return this.bi.Ut()}setCenter(t){this.bi.Bt(t)}zoomIn(){this.bi.it(1.02)}zoomOut(){this.bi.it(.98)}getZoomRange(){return this.nt.rt}setZoomRange(t){this.bi.At(t)}getZoom(){return this.bi.ut()}setZoom(t){this.bi._t(t)}getRotation(){return this.bi.It()}setRotation(t){this.bi.Dt(t)}autoRotate(t){return(t=t||{}).loop=!0,void 0===t.duration&&(t.duration=5),this.bi.Dt(t)}getTilt(){return nn.round(90-this.bi.yt.getPolarAngle()*u.RAD2DEG)}setTilt(t){t.tilt=ws.clamp(t.tilt,this.Ls.minTiltAngle,this.Ls.maxTiltAngle),this.nt.zs=t.tilt,this.bi.Ct(t)}getFloor(t){return null===this.jt?null:this.jt.getFloor(t)}getLevel(){return this.jt?.level}getLevels(){return null!==this.jt?this.jt.gr:null}setLevel(t){this.Wt.Lr(this.jt,t)}getFloorSpace(){return null!==this.jt?this.jt.floorSpace:null}setFloorSpace(e){if("number"==typeof e)this.qw(e,!0);else{if(!("animate"in e)||e.animate){this.Nr||(this.Nr=new an);var i=Number.isFinite(e.duration)?e.duration:.5;let t=e.finish;return this.Nr.Y([this.jt.floorSpace]).Z([e.floorSpace]).K(i).J(t=>{this.qw(t.destination[0],!1)}).$(()=>{this.ot.ht(this.Nr),this.qw(e.floorSpace,!0),t&&t()}),this.ot.lt(this.Nr.X()),this.Nr}this.qw(e.floorSpace,!0)}}getViewMode(){return this.ct.isPerspectiveCamera?Cr.MODE_3D:Cr.MODE_2D}setViewMode(t){this.bi.Ys(t)}getInteractions(){return this.getInteracations()}getInteracations(){return this.bi}getBound(){return this.jt.bound.clone()}getState(){let t=null,e=(this.Zw&&(t={buildingID:this.Zw.buildingID,level:this.Zw.level,visibleLevels:this.Zw.getVisibleLevels()}),this.nt.bs);return e===this.getMapOptions().mapID&&(e=null),{center:this.getCenter(),zoom:this.getZoom(),rotation:this.getRotation(),tiltAngle:this.getTilt(),viewMode:this.getViewMode(),level:this.jt.level,floorSpace:this.getFloorSpace(),visibleLevels:this.jt.visibleLevels,viewBuildingID:e,focusBuildingState:t}}setState(r,n){n=n||{};var e,i=this.getState();let s=!1;for(e in i){if(void 0===r[e]&&(r[e]=i[e]),("floorSpace"===e||"level"===e||"rotation"===e||"tiltAngle"===e||"viewBuildingID"===e||"viewMode"===e||"zoom"===e)&&r[e]!==i[e]){s=!0;break}if("center"===e&&(r[e].x!==i[e].x||r[e].y!==i[e].y)){s=!0;break}if("visibleLevels"===e){if(r[e].length!==i[e].length){s=!0;break}for(let t=0;t<r[e].length;t++)if(r[e][t]!==i[e][t]){s=!0;break}if(s)break}if("focusBuildingState"===e)if(null!==r[e]&&null!==i[e]){var t=r[e],a=i[e];if(t.buildingID!==a.buildingID){s=!0;break}if(t.level!==a.level){s=!0;break}var h=t.visibleLevels,o=a.visibleLevels;if(h.length!==o.length){s=!0;break}for(let t=0;t<h.length;t++)if(h[t]!==o[t]){s=!0;break}if(s)break}else if(null===r[e]&&null!==i[e]||null!==r[e]&&null===i[e]){s=!0;break}}if(s){void 0===r.focusBuildingState&&(r.focusBuildingState=null),r.viewBuildingID||(r.viewBuildingID=this.getMapOptions().mapID);let s=!1!==n.animate,t=n.isParallel,e=(void 0===t&&(n.isParallel=!0,t=!0),n.duration);if(void 0===e&&(n.duration=3,e=3),t&&s&&0!==e)this.bi.Js(r,n,i);else{let i=e/5;this.bi.pauseDamping(),this.setFloorSpace(r.floorSpace),null!==r.focusBuildingState?(r.level!==this.getLevel()&&(i=e/6),(r.viewBuildingID===this.getMapOptions().mapID||this.nt.bs!==this.getMapOptions().mapID&&this.nt.bs!==r.focusBuildingState.buildingID)&&this.exitBuilding({buildingID:this.nt.bs,noCenter:!0,finish:()=>{this.setLevel({level:r.level,animate:!1})}})):this.nt.bs!==this.getMapOptions().mapID&&this.exitBuilding({buildingID:this.nt.bs,noCenter:!0,finish:()=>{this.setLevel({level:r.level,animate:!1})}}),this.qt=!1,this.setCenter({animate:s,x:r.center.x,y:r.center.y,duration:i,finish:()=>{this.setRotation({animate:s,rotation:r.rotation,duration:i,finish:()=>{this.setTilt({animate:s,tilt:r.tiltAngle,duration:i,finish:()=>{this.setZoom({animate:s,zoom:r.zoom,duration:i,finish:()=>{this.setViewMode({animate:s,mode:r.viewMode,finish:()=>{this.setVisibleLevels(r.visibleLevels,()=>{this.setLevel({animate:s,level:r.level,duration:i,finish:()=>{if(null===r.focusBuildingState)this.qt=this.getMapOptions().followFocus,this.bi.resumeDamping(),n.finish&&n.finish();else{this.qt=this.getMapOptions().followFocus;let t=r.focusBuildingState,e=this.getBuilding(t.buildingID);e.setVisibleLevels(t.visibleLevels,()=>{e.setLevel({level:t.level,animate:s,duration:i,finish:()=>{t.buildingID===r.viewBuildingID&&this.enterBuilding({buildingID:t.buildingID,noCenter:!0,finish:()=>{this.bi.resumeDamping(),n.finish&&n.finish()}})}})})}}})})}})}})}})}})}})}}else n.finish&&n.finish()}getNodes(i,s){let n=this;var r=[];this.jt;let e=[p.LABEL_LAYER,p.FACILITY_LAYER,p.MODEL_LAYER,p.EXTENT_LAYER,p.EXTERNAL_MODEL_LAYER];var t,a={};if(s)for(let e=0;e<s.length;e++){let t=s[e].buildingID;t=t||this.jt.buildingID;var h=((t,e)=>{let i=[],s=t.buildingID;s=s||n.jt.buildingID;var r=t.levels;for(let t=0;t<e.length;t++)e[t].buildingID!==s||r&&-1===r.indexOf(e[t].level)||i.push(e[t]);return i})(s[e],i);a[""+t]=h}else for(let e=0;e<i.length;e++){let t=i[e].buildingID;var o=a[""+(t=t||this.jt.buildingID)];o?o.push(i[e]):a[""+t]=[i[e]]}for(t in a){var l=a[t],u=(e=>{let i=null;for(let t=0;t<n.Ft.length;t++)if(n.Ft[t].buildingID===e){i=n.Ft[t];break}return i})(""+t);for(let t=0;t<l.length;t++){var c=l[t].level,f=l[t].eid,d=l[t].type;t:for(let t=0;t<u.Ft.length;t++)if(u.Ft[t].Tr===c){let i=u.Ft[t].getLayers();i=i.filter(t=>e.includes(t.type));for(let e=0;e<i.length;e++)for(let t=0;t<i[e].Ft.length;t++)if(i[e].Ft[t].qs.Ht===f&&i[e].Ft[t].Ai===d){r.push(i[e].Ft[t]);break t}}}}return r}getDataManager(){return this.Or}getMapOptions(){return this.Ls}getContainer(){return this.Ls.container}setFitView(t,e){let i=!1!==(e=e||{}).animate,s=this.getZoomRange(),r=this.copyCamera(),n=(r.near=1,r.far=1e10,r.updateProjectionMatrix(),this.bi.copyControls(r)),a=this.bi.yt,h=this.ct;this.bi.yt=n,this.ct=r,this.setZoomRange([1,29]),n.enableDamping=!1,this.bi.Kt(this.jt,{level:this.getLevel(),animate:!1}),this.setZoom({zoom:29,animate:!1,finish:()=>{this.setCenter({animate:!1,x:t.center.x,y:t.center.y,finish:()=>{this.Kw(t,5,0,t=>{this.bi.yt=a,this.ct=h,this.setZoomRange(s),n.dispose(),n=null,r=null,this.enableUpdateRender(),this.setZoom({animate:i,zoom:t.zoom,duration:.5}),this.setCenter({animate:i,x:t.center.x,y:t.center.y,duration:.5,finish:()=>{e.finish&&e.finish()}})})}})}})}setBackgroundColor(t,e){this.bt.renderer.setClearColor("string"===t?parseInt(t.slice(1),16):t,e),this.enableUpdateRender()}setLabelField(t){this.nt.F0=t,this.Wt.U0(),this.Wt.Za()}getLabelField(){return this.nt.F0}getBuilding(t){return this.Qo({bid:t})}getBuildings(){let e=[];return this.traverse(t=>{t!==this.jt&&e.push(t)}),e}changeOverviewMode(e){for(let t=0;t<e.buildingIDs.length;t++){var i=this.getBuilding(e.buildingIDs[t]);i.Sf!==e.overviewMode&&(i.Sf=e.overviewMode,this.followFocus&&e.overviewMode!=l3.OUTDOOR&&i.parent.focusBuilding&&i.parent.focusBuilding.buildingID==i.buildingID&&i.setLevel({level:i.level}),i.Ld(e),this.Wt.T0({bid:e.buildingIDs[t]}),this.Yt.Xt({type:"buildingOverviewModeChanged",buildingID:e.buildingIDs[t]}))}e.overviewMode==l3.OUTDOOR&&this.followFocus&&this.jt.setLevel({level:this.jt.level})}enterBuilding(t){let e=this,i=this.getBuilding(t.buildingID);function s(){e.getBuildings().forEach(t=>{e.Hw.push({buildingID:t.buildingID,visible:t.visible}),t.visible=!1}),i.visible=!0,e.nt.bs=t.buildingID,i.Nd("add"),e.Wt.Gf(i),e.Wt.Vt(),e.Wt.q2(i,{}),e.Yt.Xt({type:"ViewBuildingChange",buildingID:e.nt.bs}),e.Yt.Xt({type:"buildingEntered",buildingID:e.nt.bs}),t.finish&&t.finish({buildingID:t.buildingID})}this.setLevel({level:i.levelChart[0],animate:!1,finish:()=>{t.noCenter?s():this.bi.Bt({x:i.x,y:i.y,animate:!0,duration:.5,finish:()=>{s()}})}})}exitBuilding(t){let e=this,i=(this.Hw.forEach(t=>{this.getBuilding(t.buildingID).visible=t.visible}),this.Hw.length=0,this.getBuilding(this.nt.bs));function s(){e.nt.bs=e.Ls.buildingID,i.Nd("remove"),e.Wt.Vt(),e.Wt.q2(i,{}),e.Yt.Xt({type:"ViewBuildingChange",buildingID:e.nt.bs}),e.Yt.Xt({type:"buildingExited",noCenter:t.noCenter,buildingID:i.Ht,isVisibuildingChange:!0}),t.finish&&t.finish({buildingID:i.Ht})}t.noCenter?s():this.bi.Bt({x:i.x,y:i.y,animate:!0,duration:.5,finish:()=>{s()}})}setFocusNodes(e){var s=new Map,r=e.nodes,n=[];for(let i=0;i<r.length;i++)if(r[i].type===p.LINE_MARKER)n.push(r[i].er);else{let t=null,e=(t=r[i].type===p.DOM_MARKER?r[i].h0:r[i].parent.parent.parent.buildingID,s.get(t));e||(e=[],s.set(t,e)),e.push(r[i].er)}var i=[this.getBuilding(this.getMapOptions().mapID)],a=this.getBuildings();for(let t=0;t<a.length;t++)i.push(a[t]);for(let t=0;t<i.length;t++)i[t].ir=e.opacity,i[t].Mr=s.get(i[t].buildingID),i[t].Ur();var h=this.ya.Ft;for(let t=0;t<h.length;t++)n.indexOf(h[t].er)<0?(void 0===h[t].oldOpacity&&(h[t].oldOpacity=h[t].opacity),h[t].opacity=e.opacity):void 0!==h[t].oldOpacity&&(h[t].opacity=h[t].oldOpacity);this.enableUpdateRender()}clearFocusNodes(){var e=[this.getBuilding(this.getMapOptions().mapID)],i=this.getBuildings();for(let t=0;t<i.length;t++)e.push(i[t]);for(let t=0;t<e.length;t++)e[t].ir=void 0,e[t].Mr=void 0,e[t].Ur();var s=this.ya.Ft;for(let t=0;t<s.length;t++)void 0!==s[t].oldOpacity&&(s[t].opacity=s[t].oldOpacity);this.enableUpdateRender()}on(t,e){this.Yt&&(this.Yt.mw(t,e),this.nt.Pw(t,!0))}off(t,e){this.Yt&&(this.Yt._w(t,e),this.Yt.gw(t)||this.nt&&this.nt.Pw(t,!1))}pickFilterFunction(){return!0}dispose(t){var e;this.kw||(this.kw=!0,this.Yt.Xt({type:"dispose"}),this.Xw&&this.Xw.dispose(),this.Um&&this.Um.abortAll(),this.setBackgroundColor(16777215,1),this.bt.renderer.clear(),this.bt.Qt(),nt.environment==I.BROWSER&&this.Ls.container.removeChild(this.bt.renderer.domElement),nt.environment===I.WX&&(Qy.textureCanvas=null,Qy.isDestory=!0),e=()=>{this.Or.Qt(()=>{this.ot.Qt(()=>{this.Wt.Qt(()=>{this.Sa(),this.ya.dispose(),super.dispose(),Zm.onLoad=()=>{},Zm.record.clear(),t&&t()})})})},Zm.isLoaded()?e():Zm.onLoad=e)}collisionCheck(){this.Wt.Za()}checkExternalLoaded(){return this.Wt.mf()}}Object.assign(lE.prototype,{qw(t,e=!0){this.jt.floorSpace=t,this.jt.wr=e,this.Yt.Xt({type:"floorSpaceChanged"});var i=this.ya.Ft;for(let t=0;t<i.length;t++)i[t].Lg()},Sa(){let e=[this.Vr,this.bi];for(let t=0;t<e.length;t++)e[t].Qt();for(var t in this.bt.Sa(),this.bt=null,this.Or=null,this.Wt=null,this)-1<e.indexOf(this[""+t])&&delete this[""+t];e=null,this.jt=null},Bw(t,e){return this.Ps=new ir(u.FOV,t/e,u.CAMERA_NEAR,u.CAMERA_FAR),this.Lt=new sr(-t/2,t/2,e/2,-e/2,u.CAMERA_NEAR,u.CAMERA_FAR),this.nt.Rs===Cr.MODE_3D?this.Ps:this.Lt},lt(t){(t.P=this).Ft.push(t),this.needUpdateBound=!0},K0(t){var e=[],i=(e.push({x:t.min.x,y:t.min.y}),e.push({x:t.min.x,y:t.max.y}),e.push({x:t.max.x,y:t.max.y}),e.push({x:t.max.x,y:t.min.y}),new sa);for(let t=0;t<e.length;t++){var s=aa.coordsMapToScreen(this,{x:e[t].x,y:e[t].y,level:this.getLevel(),height:0});if(null===s)return null;i.vi([s])}return i},Jw(t){var e=this.bt.renderer.domElement.clientHeight,i=this.bt.renderer.domElement.clientWidth,s=this.getZoom(),s=this.bi.wt(s);let r=1;var t=this.K0(t);return t?(t=t.size,s*(r=i/e>t.x/t.y?t.y/e:t.x/i)):null},$w(t){t=this.K0(t);return t?aa.coordsScreenToMap(this,{x:(t.max.x+t.min.x)/2,y:(t.max.y+t.min.y)/2,level:this.getLevel()}):null},Kw(e,i,s,r){let n=this.getZoom();var t=this.Jw(e);t?n=this.bi.vt(t):n-=1,this.setZoom({animate:!1,zoom:n,finish:()=>{let t=this.$w(e);t?this.setCenter({animate:!1,x:t.x,y:t.y,finish:()=>{++s===i?r({zoom:n,center:t}):this.Kw(e,i,s,r)}}):0<n?this.Kw(e,i,s,r):r({zoom:n,center:e.center})}})},St(){var t=this.getZoom();Math.abs(t-this.nt.ls)>u.EPS&&(this.Yt.Xt({type:"zoom",zoom:t}),this.ct.isOrthographicCamera&&this.bt.xt(),this.nt.ls=t)},Gw(){if(this.nt.bw){let t=this.bi.yt.target;t.distanceToSquared(this.Ow)>u.EPS&&(this.Yt.Xt({type:"move",center:this.getCenter()}),this.Ow=t.clone(),t=null)}},Yw(){let a=!0;oE(this,this.Ls,this.nt,(t,e,i,s,r,n)=>{a&&(this.nt.Dw(this.jt),a=this.bi.Hs()),this.bt.Vt(),this.ct.updateMatrixWorld(),i&&n&&this.bi.lt([this.St,this.Gw]),r&&n&&(this.Vw=!0,this.Yt.Xt({type:"loaded"}),this.Zt(),this.nt.pd=!1)})},Qo(e){let i=null;return this.traverse(t=>{t.Ht!==e.bid&&t.dr!==e.mid||(i=t)}),i},I0(){var t=this.bt.renderer.domElement,t={x:t.clientWidth/2,y:t.clientHeight/2,z:this.bi.controls.target.y};return aa.coordsScreenToMap(this,t)},Qw(t){var e=this.getZoom();return!(e<t.Lf||e>=t.Cf)&&t.overviewMode==l3.NORMAL},P0(e){if(e===this.jt)return!1;if(!this.Vw)return!1;let i=!1;if(this.Ls.enterTriggerMode===sE.Individual)for(let t=0;t<e.Of.Mf.length;t++){var s=e.Of.Mf[t];if(s.type===p.MODEL&&s.level===this.jt.level&&D3.isContain(s.coordinates[0],this.I0())&&this.Qw(e)){this.Zw=e,i=!0;break}}else for(let t=0;t<e.levelChart.length;t+=2)if(e.levelChart[t]===this.jt.level){var r=e.levelChart[t+1],r=e.O0.get(r);if(D3.isContain(r[0],this.I0())&&this.Qw(e)){this.Zw=e,i=!0;break}}return i},hw(e){this.traverse(t=>{this.Zw||(this.P0(t),this.Zw&&e(t))})},Zt(){if(this.Fw&&this.Zw.Ht!=this.nt.Ls.mapID){let t=this.t3(),e=this.Zw.Ht;if(t||this.zw===e||(e=this.zw,t=!0),t){if(this.getState().viewBuildingID&&this.getState().viewBuildingID!==this.nt.Ls.mapID)return;var i={type:"buildingExited",buildingID:e},s=(this.Fw=!1,this.Zw=null,this.getBuilding(e));this.Wt.hc(e)&&s.Uf&&(s.Uf=!1,this.Yt.Xt(i)),this.followFocus&&this.setLevel({level:this.getLevel(),animate:!1})}}this.traverse(t=>{var e;this.Fw||(this.P0(t)?(e=this.D0(),this.zw=t.buildingID,!e||this.getState().viewBuildingID&&this.getState().viewBuildingID!==this.nt.Ls.mapID||(this.Fw=!0,this.Wt.hc(t.Ht)&&0==t.Uf?(t.Uf=!0,this.Yt.Xt({type:"buildingEntered",buildingID:t.Ht})):(this.Ww=t.Ht,this.on("update",this.jw)),this.followFocus&&t.setLevel({level:t.level,animate:!1}))):this.Zw=null)})},jw(){var t,e;this.Wt.hc(this.Ww)&&(this.Zw&&this.Zw.Ht===this.Ww&&(t=this.P0(this.Zw),e=this.D0(),t)&&e&&(this.Zw.Uf=!0,this.Yt.Xt({type:"buildingEntered",buildingID:this.Ww})),this.off("update",this.jw),this.Ww=null)},t3(){var t,e=this.e3();return this.Zw.overviewMode==l3.NORMAL?(t=(t=this.getZoom())<this.Zw.Lf||t>=this.Zw.Cf,!e||t):!e},D0(){var t;return this.Zw.overviewMode!=l3.NORMAL||!((t=this.getZoom())<this.Zw.Lf||t>=this.Zw.Cf)},e3(){if(null==this.Zw)return!1;if(this.P0(this.Zw))return!0;{var t=this.Zw.getFloor(this.Zw.level).getLayers(p.EXTENT_LAYER)[0];if(null==t)return!1;let e=!1;return t&&t.traverse(t=>{e=!D3.isContain(t.coordinates[0],this.I0())}),!e}}});var E=lE;class uE extends BM{constructor(t){super(t),this.As=new Map}moveTo(e){var t=void 0!==e.animate&&e.animate,i=e.duration||.5;let s=void 0!==e.height?e.height:this.Jt,r=this.ur(E);if(r){if(t){let t;return this.As.has("moveTo")?t=this.As.get("moveTo"):(t=new an,this.As.set("moveTo",t)),t.Y([this.t,this.o,this.Jt]).Z([e.x,e.y,s]).K(i).J(t=>{this.t=t.destination[0],this.o=t.destination[1],this.Jt=t.destination[2],this.Lg(),e.update&&e.update({x:this.t,y:this.o,level:this.Tr,height:this.Jt,buildingID:this.h0}),r.enableUpdateRender()}).$(()=>{this.t=e.x,this.o=e.y,this.Jt=s,this.Lg(),e.finish&&e.finish(),r.enableUpdateRender()}),r.ot.lt(t.X()),t}this.t=e.x,this.o=e.y,this.Jt=s,this.Lg(),e.finish&&e.finish(),r.enableUpdateRender()}}stop(){let e=this.ur(E);e&&this.As&&(this.As.forEach(t=>{e.ot.ht(t)}),this.As.clear())}getFMAnimation(){return new an}}Object.assign(uE.prototype,{Lg(){if(this.Zs){var t=this.ur(E);if(!t)return!1;var e=this.Ai===p.DOM_MARKER?this.hr.height+this.Jt:this.Jt;this.Zs.position.set(this.t-t.x,e,-this.o+t.y),this.needUpdateBound=!0,t.enableUpdateRender()}},i3(l){var t=void 0!==l.animate&&l.animate,u=l.duration||.5;let c=this.ur(E);var f=(t,e)=>e?t.getBuilding(e):t;let d=(t,e,i)=>{e!==i&&(this.h0=i.buildingID,this.remove(!1),this.addTo(t))};if(c){let i=f(c,this.h0),s=f(c,l.buildingID);f=this.level;let r=l.level??this.level,n=i.getFloor(f),a=s.getFloor(r),e=void 0!==l.height?l.height:this.s3,h=(void 0!==l.height&&(this.s3=l.height),a.height+e);f=n.height+this.r3;let o=new Gt;if(t){let t;return this.As.has("moveTo")?t=this.As.get("moveTo"):(t=new an,this.As.set("moveTo",t)),t.Y([this.t,this.o,f]).Z([l.x,l.y,h]).K(u).J(t=>{this.t=t.destination[0],this.o=t.destination[1];var e=this.Zs.getWorldPosition(o).y;r!=this.level?e>=a.height&&this.level<r?(d(c,i,s),this.level=r,this.r3=t.destination[2]-a.height):(e<=n.height&&this.level>r&&(d(c,i,s),this.level=r),this.r3=t.destination[2]-n.height):this.r3=t.destination[2]-a.height,this.Lg(),this.Zs.getWorldPosition(o).y===h&&(d(c,i,s),this.level=r,this.r3=h-a.height),l.update&&l.update({x:this.t,y:this.o,level:this.Tr,height:this.r3,buildingID:this.h0}),c.enableUpdateRender()}).$(()=>{this.t=l.x,this.o=l.y,this.r3=e,this.Lg(),l.finish&&l.finish(),c.enableUpdateRender()}),c.ot.lt(t.X()),t}d(c,i,s),this.level=l.level,this.r3=h-a.height,this.t=l.x,this.o=l.y,this.Lg(),l.finish&&l.finish(),c.enableUpdateRender()}}});class cE extends uE{constructor(t){super(t),this.collisitionVisible=!1,this.za=!0}get collision(){return this.Xa}set collision(t){this.Xa!==t&&(this.Xa=t,t=this.ur(E))&&t.Wt.Za()}addTo(t){super.addTo(t);t=this.ur(E);t&&(t.on("viewModeChanged",this.Da),t.on("zoom",this.Da),t.on("resize",this.Da),t.Wt.Za())}remove(){this.stop();var t=this.ur(E);t&&(t.off("viewModeChanged",this.Da),t.off("zoom",this.Da),t.off("resize",this.Da),super.remove(),t.Wt.Za(),t.enableUpdateRender())}Lg(){super.Lg(),this.Zs&&(this.Zs?.updateMatrixWorld(!0),this.Zs?.parent?.updateMatrixWorld(!0))}}class fE extends cE{constructor(t){super(t),this.Ai=p.IMAGE_MARKER,this.Xv=t.url,this.Ia=void 0!==t.size?t.size:32,this.r_=void 0!==t.depth&&t.depth,this.Kr=void 0!==t.opacity?t.opacity:1,this.Xa=void 0===t.collision||t.collision,this.yi=Pr.getCenterByAnchor(t.anchor),this.Da=this.Da.bind(this),this.n3=this.n3.bind(this)}get url(){return this.Xv}set url(t){this.Xv=t,this.Pr()}get opacity(){return this.Kr}set opacity(t){this.Kr=t,this.Pr()}get size(){return this.Ia}set size(t){this.Ia=t,this.Da()}jump(t){return G3(this,t)}stopJump(){return H3(this)}boost(t){return B3(this,t)}stopBoost(){return k3(this)}getRenderNode(){return this.Zs}}Object.assign(fE.prototype,{Bu(){var t;return!!this.Xv&&!!(t=this.ur(E))&&(t=this.E0(t),this.Zs=new x3(t),this.Zs.center.set(this.yi.x,this.yi.y),this.Zs.visible=this.collisitionVisible,this.Lg(),this.Da(),(this.Zs.mapNode=this).dv=!0)},Da(){var t=this.ur(E);t&&(V3(t.Wt,this),t.Wt.Za(),t.enableUpdateRender())},Pr(){var t=this.ur(E);t&&(this.Zs.material=this.E0(t),this.Da())},E0(t){var e=this.ur(v);return t.Wt.pl.du({url:this.Xv,needDepth:this.r_,opacity:this.Kr*e.Kr},()=>{this.Zs&&void 0!==this.Zs.material.userData.scaleRatio?this.Da():t.on("update",this.n3),t.enableUpdateRender()})},n3(){this.Zs&&void 0!==this.Zs.material.userData.scaleRatio&&(this.Da(),this.ur(E).off("update",this.n3))}});class dE extends cE{constructor(t){super(t),this.Ai=void 0!==t.type?t.type:p.TEXT_MARKER,this.tg=void 0!==t.text?t.text:"",this.a3=void 0!==t.fontsize?t.fontsize:20,void 0!==t.fontSize&&(this.a3=t.fontSize),this.h3=t.fontFamily,this.Eg=void 0!==t.fillColor?t.fillColor:"0,0,0",this.o3=void 0!==t.strokeColor?t.strokeColor:"255,225,255",this.l3=void 0!==t.strokeWidth?t.strokeWidth:1,this.u3=t.plateColor,this.c3=t.plateStrokeColor,this.r_=void 0!==t.depth&&t.depth,this.Xa=void 0===t.collision||t.collision,this.Kr=void 0!==t.opacity?t.opacity:1,this.xg=void 0!==t.textAlign?t.textAlign:Rm.Center,this.f3=t.anchor,this.yi=Pr.getCenterByAnchor(t.anchor),this.Ia=0,this.Da=this.Da.bind(this)}set size(t){this.Ia=t}get size(){return this.Ia}get text(){return this.tg}set text(t){this.tg=t}get fillColor(){return this.Eg}set fillColor(t){this.Eg=t}get strokeColor(){return this.o3}set strokeColor(t){this.o3=t}get strokeWidth(){return this.l3}set strokeWidth(t){this.l3=t}get fontsize(){return this.a3}set fontsize(t){this.a3=t}get fontSize(){return this.a3}set fontSize(t){this.a3=t}get plateColor(){return this.u3}set plateColor(t){this.u3=t}get plateStrokeColor(){return this.c3}set plateStrokeColor(t){this.c3=t}update(){this.Pr()}setInitWriteRenderNodeFunction(t){this.d3=t}findParent(t){return this.ur(t)}updateSize(){this.Da()}getRenderNode(){return this.Zs}getScreenSize(){var t=null;return t=this.Zs?{width:this.Zs.children[0].material.map.image.width/2,height:this.Zs.children[0].material.map.image.height/2}:t}addFrameCallbacks(t){var e=this.ur(E);if(!e)return!1;e.ot.$s(t)}removeFrameCallbacks(t){var e=this.ur(E);if(!e)return!1;e.ot.$s(t)}}Object.assign(dE.prototype,{Bu(){var t=this.ur(E);if(!t)return!1;this.rg=!1;t=t.Wt,t=this.E0(t.pl).material,this.Zs=new L0,t=new x3(t);return t.center.set(this.yi.x,this.yi.y),this.Zs.add(t),this.Da(),this.Lg(),this.Zs.mapNode=this,(t.mapNode=this).dv=!0,this.d3&&(this.Zs=this.d3(this.Zs)),this.Zs.visible=this.collisitionVisible,!0},m3(t,e){if(t&&t.material){var i=this.ur(E);if(!i)return!1;i=i.Wt.B0(e);t.scale.set(i,i,i),t.scale.multiplyScalar(t.material.userData.mspriteScale||1),t.scale.setX(t.scale.x/t.material.userData.scaleRatio)}},Da(){var t=this.ur(E);if(!t)return!1;var e=this.Zs.isGroup?this.Zs.children[0]:this.Zs;"Sprite"!==e.type||e.isNoScale||(this.m3(e,this.Ia),t.enableUpdateRender())},Cg(t){t&&t.material&&(t.material.map&&t.material.map.dispose(),t.material.dispose())},Pr(){var t,e=this.ur(E);e&&(t=this.Zs.isGroup?this.Zs.children[0]:this.Zs,e=(this.Cg(t),this.E0(e.Wt.pl)).material,t.material=e,this.Da())},E0(t){var e=this.ur(v),t=t.au(this.tg,{fontsize:this.rg?this.a3+2:this.a3,fillColor:nn.toRgba(this.Eg),strokeColor:nn.toRgba(this.o3),plateColor:nn.toRgba(this.u3),plateStrokeColor:nn.toRgba(this.c3),strokeWidth:this.l3},{family:this.h3,needSize:!0,opacity:this.Kr*e.Kr,textAlign:this.xg,drawText:!this.rg,callback:()=>{var t=this.ur(E);t&&t.enableUpdateRender()}});return this.Ia=t.size,{material:t}}});class vE extends Js{constructor(t=document.createElement("div")){super(),this.isCSS2DObject=!0,this.element=t,this.element.style.position="absolute",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.center=new ct(.5,.5),this.addEventListener("removed",function(){this.traverse(function(t){t.element instanceof Element&&null!==t.element.parentNode&&t.element.parentNode.removeChild(t.element)})})}copy(t,e){return super.copy(t,e),this.element=t.element.cloneNode(!0),this.center=t.center,this}}let pE=new Gt,mE=new Ht,gE=new Ht,_E=new Gt,wE=new Gt;class ME{constructor(t={}){let a=this,i,s,h,o,l={objects:new WeakMap},u=void 0!==t.element?t.element:document.createElement("div");function c(i){i.isCSS2DObject&&(i.element.style.display="none");for(let t=0,e=i.children.length;t<e;t++)c(i.children[t])}function f(t,e){return _E.setFromMatrixPosition(t.matrixWorld),wE.setFromMatrixPosition(e.matrixWorld),_E.distanceToSquared(wE)}u.style.overflow="hidden",this.domElement=u,this.getSize=function(){return{width:i,height:s}},this.render=function(t,e){!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),null===e.parent&&!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),mE.copy(e.matrixWorldInverse),gE.multiplyMatrices(e.projectionMatrix,mE),function i(s,r,n){if(!1===s.visible)return void c(s);if(s.isCSS2DObject){pE.setFromMatrixPosition(s.matrixWorld),pE.applyMatrix4(gE);let t=-1<=pE.z&&pE.z<=1&&!0===s.layers.test(n.layers),e=s.element,i=(e.style.display=!0==t?"":"none",!0==t&&(s.onBeforeRender(a,r,n),e.style.transform="translate("+-100*s.center.x+"%,"+-100*s.center.y+"%)translate("+(pE.x*h+h)+"px,"+(-pE.y*o+o)+"px)",e.parentNode!==u&&u.appendChild(e),s.onAfterRender(a,r,n)),{distanceToCameraSquared:f(n,s)});l.objects.set(s,i)}for(let t=0,e=s.children.length;t<e;t++)i(s.children[t],r,n)}(t,t,e);var i=(t=>{let e=[];return t.traverseVisible(function(t){t.isCSS2DObject&&e.push(t)}),e})(t).sort(function(t,e){return t.renderOrder!==e.renderOrder?e.renderOrder-t.renderOrder:l.objects.get(t).distanceToCameraSquared-l.objects.get(e).distanceToCameraSquared}),s=i.length;for(let t=0,e=i.length;t<e;t++)i[t].element.style.zIndex=s-t},this.setSize=function(t,e){i=t,s=e,h=i/2,o=s/2,u.style.width=t+"px",u.style.height=e+"px"}}}function yE(t,s){var r=[];for(let i=0;i<s.length;i++){let e=!0;for(let t=0;t<r.length;t++){var n=r[t].g3??r[t]._3(),a=s[i].g3??s[i]._3();if(!(e=!G.Me(a.leftTop,a.rightDown,n.leftTop,n.rightDown)))break}e?(s[i].Zs.element.childNodes[0].style.display="block",s[i].Zs&&!s[i].Zs.parent&&t.xa.add(s[i].Zs),s[i].w3=!1,r.push(s[i])):(s[i].Zs&&s[i].Zs.parent&&t.xa.remove(s[i].Zs),s[i].w3=!0)}t.P.enableUpdateRender()}function EE(i,s){var e=new Gt,r=[],n=[];for(let t=0;t<s.length;t++)s[t].Zs.updateMatrixWorld(!0),e.setFromMatrixPosition(s[t].Zs.matrixWorld),r.push(e.x,e.y,e.z),n.push(s[t].M3,s[t].y3);var t=new ArrayBuffer(8*r.length);let a=new Float64Array(t);a.set(r);var h=new ArrayBuffer(4*n.length),o=((a=new Float32Array(h)).set(n),i.P),l=o.camera,u=o.bt.renderer.domElement.clientWidth,c=o.bt.renderer.domElement.clientHeight;o.Wt.Ha.Ga({type:p.DOM_MARKER,rendererDomClientWidth:u,rendererDomClientHeight:c,markerPositions:t,markerSizes:h,matrixWorldInverse:l.matrixWorldInverse,projectionMatrix:l.projectionMatrix}).then(t=>{var e=t.result.ndcPositions;for(let t=0;t<s.length;t++)s[t].g3={leftTop:{x:e[4*t+0],y:e[4*t+1]},rightDown:{x:e[4*t+2],y:e[4*t+3]}};yE(i,s)})}class xE{constructor(t){this.P=t,this.un=null,this.En=this.En.bind(this),this.E3=this.E3.bind(this),this.xa=new F3,this.Ft=[]}add(t){t.P=this,(t.dv||t.Bu())&&this.hh(t),this.needUpdateBound=!0}remove(t){t=this.Ft.indexOf(t);-1<t&&this.Ft.splice(t,1),this.needUpdateBound=!0}clear(){for(var t of this.Ft)t.dispose();this.Ft.length=0}dispose(){if(null!==this.un){this.P.off("resize",this.En),this.P.off("beforeRender",this.E3);for(let t=0;t<this.Ft.length;t++)this.Ft[t].dispose();this.Ft.length=0,this.xa=void 0,this.un.domElement.parentNode&&this.un.domElement.parentNode.removeChild(this.un.domElement)}}}Object.assign(xE.prototype,{Bu(){this.un=new ME,this.un.setSize(this.P.getContainer().clientWidth,this.P.getContainer().clientHeight),this.un.domElement.style.top="0px",this.un.domElement.style.left="0px",this.un.domElement.style.position="absolute",this.un.domElement.style.pointerEvents="none",this.un.domElement.style.zIndex=2,this.P.getContainer().appendChild(this.un.domElement),this.P.on("resize",this.En),this.P.on("beforeRender",this.E3)},x3(e,i){let s=!1;if(!e.visible)return!1;for(let t=0;t<i.length;t++){var r=i[t].split("%A%B%C%D"),n=r[0];if(e.h0===n&&""+e.level==""+r[1]){s=!0;break}}return s},E3(){if(this.P.getRenderManager().nt.th){var e=[],i=[],s=Array.from(this.P.getRenderManager().getRenderList().keys());for(let t=0;t<s.length;t++){var r=s[t].split("%A%B%C%D");-1===e.indexOf(r[0])&&e.push(r[0]),i.push(r[0]+"%A%B%C%D"+r[1])}for(let t=0;t<this.Ft.length;t++)this.Ft[t].Lg(),this.x3(this.Ft[t],i)?this.Ft[t].Qs&&!this.Ft[t].Xa&&this.Ft[t].Zs&&!this.Ft[t].Zs.parent&&(this.Ft[t].Zs.element.childNodes[0].style.display="block",this.xa.add(this.Ft[t].Zs)):this.Ft[t].Zs&&this.Ft[t].Zs.parent&&this.xa.remove(this.Ft[t].Zs);this.Wa(e),this.un.render(this.xa,this.P.camera)}},En(){this.un.setSize(this.P.getContainer().clientWidth,this.P.getContainer().clientHeight),this.un.render(this.xa,this.P.camera)},Jr(e,t){var i=this.P.getBuilding(""+t).visibleLevels;let s=!1;for(let t=0;t<i.length;t++)if(i[t]===e){s=!0;break}return s},Wa(i){let s=this;for(let e=0;e<i.length;e++){var r=this.P.getBuilding(""+i[e]).visibleLevels;for(let t=0;t<r.length;t++){var n=[],a=[],h=(u=l=o=h=void 0,i[e]),o=r[t],l=n,u=a;for(let t=0;t<s.Ft.length;t++)s.Ft[t].visible&&s.Ft[t].Tr===o&&s.Ft[t].h0===h&&(s.Ft[t].Xa?l:u).push(s.Ft[t]);1<=n.length&&(s.P.Ls.webWorker.useWebWorker?EE:yE)(s,n),a.forEach(t=>{t.Zs.element.childNodes[0].style.display="block"})}}},hh(t){this.Ft.push(t);var e=Array.from(this.P.getRenderManager().getRenderList().keys());this.x3(t,e)&&t.Zs&&this.xa.add(t.Zs),this.un.render(this.xa,this.P.camera)}});class bE{constructor(){}static createShape(e,i){var s=new mw;if(Array.isArray(e[0])){var r=e[0];s.moveTo(r[0].x-i.x,r[0].y-i.y);for(let t=1;t<r.length;t++)s.lineTo(r[t].x-i.x,r[t].y-i.y);if(1<e.length)for(let t=1;t<e.length;t++){var n=e[t],a=new pw;if(0<n.length){a.moveTo(n[0].x-i.x,n[0].y-i.y);for(let t=1;t<n.length;t++)a.lineTo(n[t].x-i.x,n[t].y-i.y)}s.holes.push(a)}}else{s.moveTo(e[0].x-i.x,e[0].y-i.y);for(let t=1;t<e.length;t++)s.lineTo(e[t].x-i.x,e[t].y-i.y)}return s}static createShapeBufferGeometryByCenter(t,e,i){t=this.createShape(t,e),e=new $w(t);if(i){var s=[Number.MAX_VALUE,Number.MAX_VALUE],r=[-Number.MAX_VALUE,-Number.MAX_VALUE],n=e.attributes.position.array;for(let t=0;t<n.length/3;t++){var a=n[3*t],h=n[3*t+1];a<s[0]&&(s[0]=a),h<s[1]&&(s[1]=h),r[0]<a&&(r[0]=a),r[1]<h&&(r[1]=h)}var o=e.attributes.uv.array,l=[r[0]-s[0],r[1]-s[1]];for(let t=0;t<n.length/3;t++){var u=n[3*t],c=n[3*t+1];o[2*t]=(u-s[0])/l[0],o[2*t+1]=(c-s[1])/l[1]}e.setAttribute("uv",new ph(o,2))}return e}static createExtrudeBufferGeometry(t,e){e={steps:1,depth:e.depth,bevelEnabled:!1,bevelThickness:0,bevelSize:0,bevelOffset:0,bevelSegments:1};return new t3(t,e)}static closedPoints(t){return n3.closedPoints(t)}static createReactShape(t,e){var i=new mw,e=e/2,t=t/2;return i.moveTo(-t,-e),i.lineTo(-t,e),i.lineTo(t,e),i.lineTo(t,-e),i}static createCircleShape(t,e){var i=new mw;return i.absarc(0,0,t,0,2*Math.PI,!1),i}static createReactExtrudeBufferGeometry(t,e,i){t=bE.createReactShape(t,e);return this.createExtrudeBufferGeometry(t,i)}static createCircleExtrudeBufferGeometry(t,e,i){t=bE.createCircleShape(t,e);return this.createExtrudeBufferGeometry(t,i)}static createCenterBufferGeometry(i,e){var s=[];for(let e=0;e<i.length-1;e++)for(let t=2;t<10;t+=2)s.push({x:i[e].x+(i[e+1].x-i[e].x)*t*.1,y:i[e].y+(i[e+1].y-i[e].y)*t*.1,z:i[e].z+(i[e+1].z-i[e].z)*t*.1});s.push({x:s[0].x,y:s[0].y,z:s[0].z});var t=new Nh,r=[],n=[];for(let t=0;t<s.length-1;t++)r.push(s[t].x),r.push(s[t].y),r.push(s[t].z),r.push(s[t+1].x),r.push(s[t+1].y),r.push(s[t+1].z),r.push(e.x),r.push(e.y),r.push(e.z),n.push(0,0,1);var a=new Float32Array(r);return t.setAttribute("position",new ph(a,3)),t.setAttribute("gradientAlpha",new ph(n,1)),t}static scalePoints(e,i,s){var r=[];for(let t=0;t<e.length;t++){var n=e[t].x,a=e[t].y,h=e[t].z;r.push({x:n+(n-i.x)*(s-1),y:a+(a-i.y)*(s-1),z:h})}return r}static scaleValuePoints(e,i,s){var r=[];for(let t=0;t<e.length;t++){var n={x:e[t].x,y:e[t].y,z:e[t].z};n.x-i.x<0?n.x-=s:n.x+=s,n.y-i.y<0?n.y-=s:n.y+=s,r.push(n)}return r}}class SE extends BM{constructor(t){super(t),this.Ai=p.POLYGON_MARKER,this.Xv=void 0!==t.url?t.url:void 0,this.vm=void 0!==t.color?t.color:"#FF0000",this.Kr=void 0!==t.opacity?t.opacity:1,this.t2=t.borderColor||"#00ff00",this.i_="number"==typeof t.borderWidth?t.borderWidth:2,this.Jt=void 0!==t.height?t.height:0,this.Id=void 0!==t.points?t.points:[],this.Rf=null,this.__=this.__.bind(this)}get x(){return this.t}get y(){return this.o}get points(){return this.Id}set points(e){if(this.Id=e,this.Zs){e=this.ur(E);if(e){var i=new ct(e.x,e.y),i=bE.createShapeBufferGeometryByCenter(this.Id,i,!!this.Xv);let t=this.Zs.geometry;this.Zs.geometry=i,t.dispose(),t=null;i=this.b3(i);this.Rf.F_(i),e.enableUpdateRender(),this.tr=!0}}}get color(){return this.vm}set color(t){this.vm=t,this.S3()}get borderColor(){return this.t2}set borderColor(t){this.t2=t,this.Rf&&(this.Rf.color=t,this.Rf.update())}get borderWidth(){return this.i_}set borderWidth(t){this.i_=t,this.Rf&&(this.Rf.width=t,this.Rf.update())}get opacity(){return this.Kr}set opacity(t){this.Kr=t,this.S3()}getBound(){return D3.bound(this.Id)}getInsideCenter(){var t={};return D3.calculatorInsideCentroid(this.Id,t),t}getRenderNode(){return this.Zs}remove(){var t=this.ur(E);this.P&&this.P.remove(this),t&&(t.off("resize",this.__),t.enableUpdateRender())}}Object.assign(SE.prototype,{b3(e){var i=e.attributes.position.array.length,s=[];for(let t=0;t<i/3;t++)s.push(new Gt(e.attributes.position.array[3*t],e.attributes.position.array[3*t+1],e.attributes.position.array[3*t+2]));s.push(new Gt(e.attributes.position.array[0],e.attributes.position.array[1],e.attributes.position.array[2]));var r=[];for(let t=0;t<s.length-1;t++){var n=new Gt(s[t].x,s[t].y,s[t].z),a=new Gt(s[t+1].x,s[t+1].y,s[t+1].z);0===t&&r.push(n),r.push(h(n,a)),r.push(h(a,n)),r.push(a)}return r;function h(t,e){return new Gt(t.x+.001*(e.x-t.x),t.y+.001*(e.y-t.y),t.z+.001*(e.z-t.z))}},Bu(){if(!this.Id)return!1;var t=this.ur(E);if(!t)return!1;var e=this.ur(v);let i=t.Wt.pl.Yl({url:this.Xv,color:this.vm,opacity:this.Kr*e.Kr,visible:!this.Xv},()=>{i.map.wrapS=kt,i.map.wrapT=kt,i.needsUpdate=!0,i.visible=!0});var e=new ct(t.x,t.y),e=bE.createShapeBufferGeometryByCenter(this.Id,e,!!this.Xv),s=this.b3(e),e=(Q3(e,i,this),this.Zs.position.set(0,this.Jt,0),new Uy({color:this.t2,width:this.i_}));return e.P=this,e.U_(s,t),this.kg=s,(this.Rf=e).Zs.renderOrder=1,this.Zs.add(e.Zs),t.enableUpdateRender(),t.on("resize",this.__),!0},__(){var t=this.ur(E);t&&null!==this.Rf&&this.Rf.Zs&&(this.Rf.Zs.material.resolution=new ct(t.bt.renderer.domElement.clientWidth,t.bt.renderer.domElement.clientHeight),t.enableUpdateRender())},Lg(){this.Zs&&this.Zs.position.set(0,this.Jt,0),this.ur(E).enableUpdateRender()},S3(){var t=this.ur(E);if(!t)return!1;var e=t.Wt,i=this.ur(v);this.Zs.material=e.pl.Yl({url:this.Xv,color:this.vm,opacity:this.Kr*i.Kr,visible:!this.Xv},()=>{this.Zs.material.map.wrapS=kt,this.Zs.material.map.wrapT=kt,this.Zs.material.needsUpdate=!0,this.Zs.material.visible=!0}),t.enableUpdateRender()},Pr(){this.S3(),this.Rf.update()}});class AE extends Nh{constructor(){super();var t=new Float32Array([-.5,0,-.5,0,0,.5,0,-.5,1,0,.5,0,.5,1,1,-.5,0,.5,0,1]),t=new z0(t,5);this.setIndex([0,1,2,0,2,3]),this.setAttribute("position",new j0(t,3,0,!1)),this.setAttribute("uv",new j0(t,2,3,!1))}}class TE extends uE{constructor(t){super(t),this.Ai=p.LOCATION_MARKER,this.Xv=t.url,this.Ia=void 0!==t.size?t.size:20,this.Tr=void 0!==t.level?t.level:1,this.Kr=void 0!==t.opacity?t.opacity:1,this.h0=t.buildingID,this.A3=0,this.Da=this.Da.bind(this),this.Lg=this.Lg.bind(this),this.s3=t.height??1,this.r3=this.s3}get buildingID(){return this.h0}get level(){return this.Tr}set level(t){this.Tr!==t&&(this.Tr=t,t=this.ur(E),this.remove(!1),this.addTo(t))}get opacity(){return this.Kr}set opacity(t){this.Kr=t,this.dv&&this.Pr()}get url(){return this.Xv}set url(t){this.Xv=t,this.Pr()}get size(){return this.Ia}set size(t){this.Ia=t,this.Da()}get height(){return this.s3}set height(t){this.r3=t,this.s3=t,this.Lg()}moveTo(t){return this.i3(t)}rotateTo(e){let i=this.ur(E);if(!i)return!1;var s=e.duration||.5,r=this.Zs.rotation.y,n=e.heading%360*u.DEG2RAD;let t=0;n=r+(t=n-r!=0?Math.sin(n-r)/Math.abs(Math.sin(n-r))*Math.acos(Math.cos(n-r)):t);if(e.animate){let t;this.As.has("rotation")?((t=this.As.get("rotation")).finish(),t.Y([r]),t.Z([n])):(t=new an({src:[r],dest:[n]}),this.As.set("rotation",t)),t.K(s).J(t=>{this.Zs&&(this.Zs.rotation.y=t.destination[0],this.A3=t.destination[0],i.enableUpdateRender())}).$(()=>{i.ot.ht(t),i.enableUpdateRender(),e.finish&&e.finish()}),i.ot.lt(t.X())}else this.Zs&&(this.Zs.rotation.y=n,this.A3=n,i.enableUpdateRender())}addTo(t){var e=this.Vs(t);e&&(super.addTo(e),t.on("zoom",this.Da),t.on("resize",this.Da),t.on("viewChanged",this.Da))}remove(t=!0){t&&this.stop();t=this.ur(E);if(!t)return!1;t.off("zoom",this.Da),t.off("resize",this.Da),t.off("viewChanged",this.Da),super.remove()}getRenderNode(){return this.Zs}}Object.assign(TE.prototype,{Bu(){var t,e,i=this.ur(E);return!!i&&(e=new AE,t=this.E0(i),this.Zs=new L(e,t),this.Zs.renderOrder=1,(this.Zs.mapNode=this).Lg(),this.Zs.rotation.set(0,this.A3,0,"XYZ"),t.side=Yt,this.Zs.updateMatrixWorld(!0),e=i.Wt.k0(this.Zs,this.Ia),this.Zs.scale.set(e,e,e),this.Zs.visible=this.Qs,this.P.xa.add(this.Zs),this.dv=!0)},Da(){var e=this.ur(E);if(e){var i=this.Zs.position;let t=!1;(t=!(isNaN(i.x)||isNaN(i.y)||isNaN(i.z))&&"number"==typeof i.x&&"number"==typeof i.y&&"number"==typeof i.z?t:!0)||(i=e.Wt.k0(this.Zs,this.Ia),this.Zs.scale.set(i,i,i),e.enableUpdateRender())}},Lg(){var t,e=this.ur(E);e&&(t=this.Vs(e))&&(this.Zs.position.set(this.t-e.x,t.Jt+this.r3,-this.o+e.y),this.needUpdateBound=!0,e.enableUpdateRender())},E0(t){return t.Wt.pl.ql({url:this.Xv,flipY:!1,opacity:this.Kr},i=>{var s=i.map.image;if(s.width!==s.height){var r=nt.document.createElement("canvas"),n=r.getContext("2d"),a=s.width,h=s.height;let t=0,e=0;h<a?(r.width=a,r.height=a,e=(a-h)/2):(r.width=h,r.height=h,t=(h-a)/2),n.drawImage(s,t,e,a,h);n=new Y0(r);n.minFilter=V,n.generateMipmaps=!1,n.flipY=!1,i.map=n,i.needsUpdate=!0}this.Zs&&(s=t.Wt.k0(this.Zs,this.Ia),this.Zs.scale.set(s,s,s),t.enableUpdateRender())})},Pr(){var t=this.ur(E);if(!t)return!1;this.Zs.material.map&&this.Zs.material.map.dispose(),this.Zs.material.dispose(),this.Zs.material=this.E0(t),this.Zs.material.side=Yt,this.Zs.material.needsUpdate=!0,t.enableUpdateRender()},Vs(t){return(this.h0?t.getBuilding(this.h0):t).getFloor(this.Tr)}});let RE={EDGES_LINES_TYPE:"EDGES_LINES_TYPE"},LE=(Object.freeze(RE),{NONE:0,ALL:1,TOP:2}),CE=new Gt,NE=new Gt,IE=new Gt,PE=new so;class DE extends Nh{constructor(t=null,e=1){if(super(),this.type="EdgesGeometry",this.parameters={geometry:t,thresholdAngle:e},null!==t){var i,s,r,n=Math.pow(10,4),a=Math.cos(Ki*e),h=t.getIndex(),o=t.getAttribute("position"),l=(h||o).count,u=[0,0,0],c=["a","b","c"],f=new Array(3),d={},v=[];for(let t=0;t<l;t+=3){h?(u[0]=h.getX(t),u[1]=h.getX(t+1),u[2]=h.getX(t+2)):(u[0]=t,u[1]=t+1,u[2]=t+2);var{a:p,b:m,c:g}=PE;if(p.fromBufferAttribute(o,u[0]),m.fromBufferAttribute(o,u[1]),g.fromBufferAttribute(o,u[2]),PE.getNormal(IE),f[0]=`${Math.round(p.x*n)},${Math.round(p.y*n)},`+Math.round(p.z*n),f[1]=`${Math.round(m.x*n)},${Math.round(m.y*n)},`+Math.round(m.z*n),f[2]=`${Math.round(g.x*n)},${Math.round(g.y*n)},`+Math.round(g.z*n),f[0]!==f[1]&&f[1]!==f[2]&&f[2]!==f[0])for(let t=0;t<3;t++){var _=(t+1)%3,w=f[t],M=f[_],y=PE[c[t]],E=PE[c[_]],x=w+"_"+M,M=M+"_"+w;M in d&&d[M]?(IE.dot(d[M].normal)<=a&&(v.push(y.x,y.y,y.z),v.push(E.x,E.y,E.z)),d[M]=null):x in d||(d[x]={index0:u[t],index1:u[_],normal:IE.clone()})}}for(i in d)d[i]&&({index0:s,index1:r}=d[i],CE.fromBufferAttribute(o,s),NE.fromBufferAttribute(o,r),v.push(CE.x,CE.y,CE.z),v.push(NE.x,NE.y,NE.z));this.setAttribute("position",new ph(v,3))}}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}}class OE extends BM{constructor(t){super(t),this.Ai=RE.EDGES_LINES_TYPE,this.a_=void 0!==t.lineType?t.lineType:LE.TOP,this.T3=void 0!==t.lineAlpha?t.lineAlpha:1,this.t2=void 0!==t.lineColor?t.lineColor:"#FF0000"}get lineColor(){return this.t2}set lineColor(t){this.t2!==t&&(this.t2=t,this.Pr())}get lineAlpha(){return this.T3}set lineAlpha(t){this.T3!==t&&(this.T3=t,this.Pr())}}Object.assign(OE.prototype,{H_(t){var t=new DE(t),e=this.ur(E);if(!e)return!1;var e=e.Wt,i=this.ur(v),e=e.pl.mu(this.t2,this.T3*i.Kr);this.Zs=new Kg(t,e),this.dv=!0},Pr(){var t,e=this.ur(E);e&&(t=this.ur(v),this.Zs.material=e.Wt.pl.mu(this.t2,this.T3*t.Kr))}});class UE extends BM{constructor(t){if(super(t),this.Ai=p.EXTRUDE_MARKER,this.Kr=void 0!==t.opacity?t.opacity:1,this.vm=void 0!==t.color?t.color:"#FF0000",this.i0=void 0!==t.extrudeHeight?t.extrudeHeight:1,this.r_=this.i0,this.Id=void 0!==t.points?Object.assign(t.points):[],Array.isArray(this.Id[0]))for(let t=0;t<this.Id.length;t++)this.Id[t].constructor===Array&&(n3.polygonArea(this.Id[t])<0&&this.Id[t].reverse(),n3.closedPoints(this.Id[t]));else this.Id.constructor===Array&&(n3.polygonArea(this.Id)<0&&this.Id.reverse(),n3.closedPoints(this.Id));this.R3=new OE({lineType:t.edgeMode,lineColor:void 0!==t.edgeColor?t.edgeColor:this.vm,lineAlpha:void 0!==t.edgeOpacity?t.edgeOpacity:this.Kr}),this.R3.P=this}get x(){return this.t}get y(){return this.o}get color(){return this.vm}set color(t){this.vm!==t&&(this.vm=t,this.L3())}get opacity(){return this.Kr}set opacity(t){this.Kr!==t&&(this.Kr=t,this.L3())}get edgeColor(){return this.R3.t2}set edgeColor(t){this.R3.lineColor=t;t=this.ur(E);t&&t.enableUpdateRender()}get edgeOpacity(){return this.R3.T3}set edgeOpacity(t){this.R3.lineAlpha=t;t=this.ur(E);t&&t.enableUpdateRender()}get extrudeHeight(){return this.i0}set extrudeHeight(t){this.i0!==t&&(this.i0=t,this.Zs.scale.setZ(this.i0/this.r_),t=this.ur(E))&&t.enableUpdateRender()}get points(){return this.Id}set points(t){this.Id=t,this.Id.constructor===Array&&(n3.polygonArea(this.Id)<0&&this.Id.reverse(),n3.closedPoints(this.Id)),this.Zs&&(t=this.ur(E))&&(this.Zs.parent.remove(this.Zs),this.Zs.traverse(function(t){t instanceof L&&(t.geometry.dispose(),t.material=void 0,t.geometry=void 0)}),this.Zs.mapNode=void 0,this.Zs=void 0,this.Bu(),this.parent.scene.add(this.Zs),t.enableUpdateRender())}dispose(){this.R3&&this.R3.dispose(),super.dispose()}getRenderNode(){return this.Zs}setType(t){this.Ai=t}}Object.assign(UE.prototype,{Bu(){var t=this.ur(E);if(!t)return!1;var e=t.Wt,i=this.ur(v),s=new ct(t.x,t.y),r=bE.createShape(this.Id,s);let n={depth:this.r_};var r=bE.createExtrudeBufferGeometry(r,n),{position:a,uv:h}=r.attributes;for(let t=0;t<a.count;t++){var o=a.getZ(t);h.setY(t,o/n.depth)}return Q3(r,e.pl.Jl({color:this.vm,alpha:this.Kr*i.Kr,modelSideGradient:jr(),type:this.Ai}),this),this.Zs.position.set(0,this.Jt,0),this.R3.a_===LE.TOP?this.C3(s):this.R3.a_===LE.ALL&&this.f2(r),this.dv=!0,t.enableUpdateRender(),this.dv},C3(t){t=bE.createShape(this.Id,t),t=new $w(t);this.f2(t),this.R3.Zs.position.setZ(this.r_),t.dispose()},f2(t){this.R3.H_(t),this.Zs.add(this.R3.Zs)},L3(){var t,e,i=this.ur(E);i&&(t=this.ur(v),e=i.Wt,this.Zs.material=e.pl.Jl({color:this.vm,alpha:this.Kr*t.Kr,modelSideGradient:jr(),type:this.Ai}),i.enableUpdateRender())},Pr(){this.L3(),this.R3.Pr()},Lg(){this.Zs.position.set(0,this.Jt,0),this.ur(E).enableUpdateRender()}});class FE{constructor(t,e){this.options=e,this.extendDataMap=new Map,this.floor=null,this.map=t}setExtendDataMap(t){this.floor=t;let e=null;if(0===this.extendDataMap.size){var i=t.getLayers(p.EXTENT_LAYER)[0];for(let t=0;t<i.children.length;t++)this.extendDataMap.set(""+i.children[t].ID,{extend:i.children[t],datas:[]}),0===t&&(e=""+i.children[t].ID)}return e}dataAnalyser(e,i){if(i)for(let t=0;t<i.length;t++){var s=e.getExtendByCoords(i[t]);s&&this.extendDataMap.get(""+s.ID).datas.push(i[t])}else for(var[t,r]of this.extendDataMap)r.datas=[]}createHeatMap(t){for(var[e,i]of this.extendDataMap)if(""+e!=""+t){var s,r={};for(s in this.options)r[s]=this.options[s];r.extend=i.extend;e=new BE(this.map,r);e.addDataSource(i.datas),e.addTo(this.floor),i.heatMap=e}}}class BE extends BM{constructor(t,e){super(e=e||{}),this.eh=e,this.N3=null,this.I3=e.extend,this.Ai=p.HEAT_MAP_MARKER,this.st=t,this.Aw=e.backgroundColor,this.Kr=e.opacity,this.s_=void 0!==e.radius?e.radius:30,this.P3=void 0!==e.valueRange?void 0!==e.valueRange.max?void 0!==e.valueRange.min?e.valueRange:{max:e.valueRange.max,min:0}:void 0!==e.valueRange.min?{max:100,min:e.valueRange.min}:{max:100,min:0}:{max:100,min:0},this.P3.min>=this.P3.max&&(this.P3={max:100,min:0}),this.D3=void 0!==e.quality?e.quality:1024,this.Pv=void 0===e.isPlane||e.isPlane,this.O3=this.Pv,this.R_=void 0!==e.gradient?e.gradient:{.45:"rgb(0,0,255)",.55:"rgb(0,255,255)",.65:"rgb(0,255,0)",.95:"yellow",1:"rgb(255,0,0)"},this.U3=e.maxOpacity,void 0===this.U3&&(this.U3=1),void 0!==this.Kr&&(this.U3=this.Kr),this.F3=e.minOpacity,void 0===this.F3&&(this.F3=0),this.Sn=e.blur,void 0===this.Sn&&(this.Sn=.85),this.B3=e.scaleRadius,void 0===this.B3&&(this.B3=!0),this.Jt=e.height,void 0===this.Jt&&(this.Jt=1),this.Pv||(this.B3=!0),this.Id=[],this.H3=null,this.qs=null,this.V3=null,this.z3=0,this.hr=null,this.Ov=null,this.W3=void 0,this.j3=null,this.Uv=null,this.X3=null,this.Y3=null,this.Z3=null,this.q3=null,this.M_=this.M_.bind(this),this.K3=11,this.J3=22,this.Q3=null,this.tM=`
            #include <common>
            #include <logdepthbuf_pars_vertex>
            varying vec3 vPosition;
            void main(){
                    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
                    vPosition=vec3(modelMatrix * vec4( position, 1.0 ));
                    gl_Position = projectionMatrix * mvPosition;
                    #include <logdepthbuf_vertex>
            }
        `,this.eM=`
            varying vec3 vPosition;
            uniform sampler2D heatTexture;
            uniform vec2 boundCenter;
	        uniform vec2 boundSize;
            #include <logdepthbuf_pars_fragment>
            void main() {
                #include <logdepthbuf_fragment>
                vec2 uvheat=vec2((vPosition.x -  (boundCenter.x - boundSize.x/2.0)) / boundSize.x , (vPosition.z - (boundCenter.y-boundSize.y/2.0)) / boundSize.y);
                vec4 color=texture2D(heatTexture,uvheat);
                gl_FragColor = color;
            }
        `}get bound(){var t,e;return!0===this.needUpdateBound&&null!==this.hr&&(this.mi.reset(),t=this.hr.getLayers(p.MODEL_LAYER)[0],!1===this.Pv?(e=this.hr.getLayers(p.EXTENT_LAYER)[0],t&&this.mi.expand(t.bound),e&&this.mi.expand(e.bound)):t&&this.mi.expand(t.bound),this.needUpdateBound=!1),this.mi.clone()}get x(){return this.t}get y(){return this.o}get height(){return this.Jt}set height(t){if(this.O3&&(this.Jt=t,this.Lg(),null!==this.N3))for(var[e,i]of this.N3.extendDataMap)""+e!=""+this.X3.ID&&(i.heatMap.height=t)}get opacity(){return this.Kr}set opacity(t){if(this.Kr=t,this.U3=this.Kr,this.j3&&(this.j3.configure({radius:this.s_,valueRange:this.P3,maxOpacity:this.U3,minOpacity:this.F3,gradient:this.R_,blur:this.Sn}),null!==this.N3))for(var[e,i]of this.N3.extendDataMap)""+e!=""+this.X3.ID&&(i.heatMap.opacity=t)}set valueRange(t){if(void 0!==t.max&&(this.P3.max=t.max),void 0!==t.min&&(this.P3.min=t.min),this.P3.min>=this.P3.max&&(this.P3={max:100,min:0}),null!==this.N3)for(var[e,i]of this.N3.extendDataMap)""+e!=""+this.X3.ID&&(i.heatMap.valueRange=t)}get valueRange(){return this.P3}get level(){return this.hr.level}get visible(){return super.visible}set visible(t){if(this.Qs!==t)if(super.visible=t,this.Pv){if(this.B3?this.Zs&&(this.Zs.visible=t):(this.Id.length=0,this.iM(),this.update()),this.st.enableUpdateRender(),null!==this.N3)for(var[e,i]of this.N3.extendDataMap)""+e!=""+this.X3.ID&&(i.heatMap.visible=t)}else t?this.P.Dv(this.Ov,this):this.P.Dv(null,this),this.st.enableUpdateRender()}simulate(t){this.z3=t}clearDataSource(){this.qs=null,this.Id=[],null!==this.N3&&this.N3.dataAnalyser(this.hr,null)}addPoint(t,e,i){var s;t&&e&&i&&(null===this.N3?(s=this.hr.getLayers(p.EXTENT_LAYER)[0].bound,(s=this.sM(t,e,s))&&(s.x=Math.round(s.x),s.y=Math.round(s.y),s.value=i,s.radius=this.s_,this.Id.push(s))):this.N3.dataAnalyser(this.hr,[{x:t,y:e,value:i}]))}addDataSource(t){this.qs=t,this.Id=[],null!==this.N3&&(this.N3.dataAnalyser(this.hr,null),this.N3.dataAnalyser(this.hr,t))}update(){if(null!==this.N3){var t,e,i=this.N3.extendDataMap.get(""+this.X3.ID);this.qs=i.datas,this.Id=[];for([t,e]of this.N3.extendDataMap)""+t!=""+this.X3.ID&&(e.heatMap.addDataSource(e.datas),e.heatMap.update())}0===this.Id.length&&null!=this.qs&&(i=this.X3,this.B3?this.rM(i.bound):this.iM()),nt.environment===I.WX&&(this.V3.width=this.H3.width,this.V3.height=this.H3.height),this.j3.setData({max:this.P3.max,min:this.P3.min,data:this.Id}),this.nM(),this.Pv?this.B3?(i=this.Zs.material.uniforms.heatTexture.value,this.Zs.material.uniforms.heatTexture.value=this.Ov,i.dispose()):this.aM():this.P.Dv(this.Ov,this),this.st.enableUpdateRender()}addTo(i){this.hr=i;let s=null;if(this.Pv){let t=null,e=null;s=void 0===this.I3?(this.N3=new FE(this.st,this.eh),e=this.N3.setExtendDataMap(i),(t=this.N3.extendDataMap.get(e)).heatMap=this,t.extend):this.I3,null!==this.N3&&(this.N3.dataAnalyser(i,this.qs),this.qs=t.datas,this.N3.createHeatMap(e))}else if(s=this.hr.getLayers(p.EXTENT_LAYER)[0],null!==this.qs){var e=[],r=(e.push({x:s.bound.min.x,y:s.bound.min.y}),e.push({x:s.bound.min.x,y:s.bound.max.y}),e.push({x:s.bound.max.x,y:s.bound.max.y}),e.push({x:s.bound.max.x,y:s.bound.min.y}),[]);for(let t=0;t<this.qs.length;t++)G.Se(this.qs[t],e,e.length)&&r.push(this.qs[t]);this.qs=r}var t=s.bound,t=(this.Uv=s.bound,this.X3=s,nt.environment===I.WX?this.V3=Qy.textureCanvas[0]:this.V3=document.createElement("canvas"),0!=this.z3&&this.hM(this.z3),null!=this.qs&&(this.B3?(this.H3=this.oM(t),this.V3.width=this.H3.width,this.V3.height=this.H3.height,this.rM(t)):(t=this.lM(),this.uM(t),this.q3=this.oM(this.Y3),nt.environment===I.WX?this.Z3=Qy.textureCanvas[0]:this.Z3=document.createElement("canvas"),this.Z3.width=this.q3.width,this.Z3.height=this.q3.height,this.rM(this.Y3,t))),{radius:this.s_,valueRange:this.P3,maxOpacity:this.U3,minOpacity:this.F3,gradient:this.R_,blur:this.Sn});this.B3?t.canvas=this.V3:t.canvas=this.Z3,this.j3=nt.heatmap.create(t),null!==this.qs&&this.j3.setData({max:this.P3.max,min:this.P3.min,data:this.Id}),super.addTo(i),this.needUpdateBound=!0}remove(){if(this.B3||(this.st.off("zoom",this.M_),this.st.off("levelChanged",this.M_),this.st.off("visibleLevelsLoaded",this.M_),this.st.off("move",this.M_),this.st.off("viewChanged",this.M_),this.st.off("resize",this.M_)),super.remove(),null!==this.N3){for(var[t,e]of this.N3.extendDataMap)""+t!=""+this.X3.ID&&e.heatMap.remove();this.N3.extendDataMap.clear()}}dispose(){if(super.dispose(),this.hr=null,this.Ov&&this.Ov.dispose(),(this.Ov=null)!==this.N3){for(var[t,e]of this.N3.extendDataMap)e.heatMap.hr=null,e.heatMap.Ov=null;this.N3.extendDataMap.clear()}}}Object.assign(BE.prototype,{nM(){var t,e;nt.environment===I.WX?(this.B3||this.cM(),t=this.V3.toDataURL("image/png"),this.Ov?this.image&&(this.image.crossOrigin="Anonymous",this.image.onload=()=>{this.Ov.image=this.image,this.Zs.material.map=this.Ov,this.Zs.material.map.needsUpdate=!0,this.Zs.material.needsUpdate=!0,this.st.enableUpdateRender()},this.image.src=t):(e=new c,(this.Ov=e).minFilter=Jt,nt.textureHelper.createImage({url:t,onload:t=>{this.Ov.image=t,this.Ov.needsUpdate=!0,this.image=t,this.Zs.material.map=this.Ov,this.Zs.material.map.needsUpdate=!0,this.Zs.material.needsUpdate=!0,this.st.enableUpdateRender()}}))):this.B3?(this.Ov=new Y0(this.fM(this.V3)),this.Ov.flipY=!1,this.Ov.minFilter=V,this.Ov.generateMipmaps=!1):(this.cM(),this.Ov=new c(this.fM(this.V3)))},E0(){let t=null;return this.B3?t=new zh({uniforms:{heatTexture:{value:this.Ov},boundCenter:{value:new ct(this.Uv.center.x-this.st.x,this.st.y-this.Uv.center.y)},boundSize:{value:new ct(this.Uv.size.x,this.Uv.size.y)}},transparent:!0,depthWrite:!0,depthTest:!1,vertexShader:this.tM,fragmentShader:this.eM}):((t=new ro(16777215)).opacity=1,t.transparent=!0,t.map=this.Ov,t.map&&(t.map.needsUpdate=!0),t.depthTest=!1,t.needsUpdate=!0),t},Bu(){if(!this.dv){var t,e,i=this.X3.Zs;if(!this.Pv||i)if(this.Ov=null,this.nM(),this.Pv)this.B3?(t=i.userData,i.userData={},e=i.clone(),i.userData=t,e.name="heatMap",e.scale.z=.001,e.position.y+=this.Jt,i=this.E0(),e.material=i,this.Zs=e,this.Zs.mapNode=this):this.aM(),this.dv=!0;else{this.dv=!0;var s=this.hr.getModelMeshs();for(let t=0;t<s.length;t++)if(s[t]){this.dv=!0;break}}this.ur(E).enableUpdateRender(),this.B3||(this.st.on("zoom",this.M_),this.st.on("levelChanged",this.M_),this.st.on("visibleLevelsLoaded",this.M_),this.st.on("move",this.M_),this.st.on("viewChanged",this.M_),this.st.on("resize",this.M_))}return this.dv},cM(){var t,e,i;this.Pv?this.V3=this.Z3:(this.H3=this.oM(this.Uv),e=this.H3.width,i=this.H3.height,this.V3.width=e,this.V3.height=i,(t=this.V3.getContext("2d")).clearRect(0,0,e,i),e=(this.Y3.min.x-this.Uv.min.x)/(this.Uv.max.x-this.Uv.min.x)*e,i=(this.Uv.max.y-this.Y3.max.y)/(this.Uv.max.y-this.Uv.min.y)*i,t.drawImage(this.Z3,e,i,+this.Z3.width,+this.Z3.height))},Lg(){this.Zs.position.y=this.Jt,this.ur(E).enableUpdateRender()},sM(t,e,i){t={x:(t-i.min.x)/(i.max.x-i.min.x),y:(i.max.y-e)/(i.max.y-i.min.y)};return this.B3?(t.x=t.x*this.H3.width,t.y=t.y*this.H3.height):(t.x=t.x*this.q3.width,t.y=t.y*this.q3.height),t},dM(){var t,e;return nt.environment===I.WX?[t=nt.window.screenWidth/2.54,t]:(t=[],void 0!==window.screen.deviceXDPI?(t[0]=window.screen.deviceXDPI,t[1]=window.screen.deviceYDPI):((e=document.createElement("DIV")).style.cssText="width:1in;height:1in;position:absolute;left:0px;top:0px;z-index:99;visibility:hidden",document.body.appendChild(e),t[0]=parseInt(e.offsetWidth),t[1]=parseInt(e.offsetHeight),e.parentNode.removeChild(e)),t)},oM(e){let i=e.max.x-e.min.x,s=e.max.y-e.min.y,r=(i<1&&(i=1),s<1&&(s=1),null);if(this.B3){r={width:Math.round(i),height:Math.round(s)};e=this.dM();r.width=parseInt(r.width*e[0]/25.4),r.height=parseInt(r.height*e[1]/25.4);let t=1;(r.width>=this.D3||r.height>=this.D3)&&(r.width>=r.height?(t=r.height/r.width,r.width=this.D3,r.height=parseInt(this.D3*t)):(t=r.width/r.height,r.height=this.D3,r.width=parseInt(this.D3*t)))}else{var e=this.vM(),t=Math.round(i/e),e=Math.round(s/e);r={width:t,height:e}}return r},fM(t){let e=ws.floorPowerOfTwo(t.width),i=ws.floorPowerOfTwo(t.height);this.B3||(e>i?4096<e&&(s=e/4096,e=4096,i/=s):4096<i&&(s=i/4096,i=4096,e/=s)),void 0===this.W3&&(this.W3=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")),this.W3.width=e,this.W3.height=i;var s=this.W3.getContext("2d");return void 0!==this.Aw&&(s.fillStyle=this.Aw,s.fillRect(0,0,e,i)),s.drawImage(t,0,0,e,i),this.W3},rM(e,t){let i=null;i=t||this.qs;for(let t=0;t<i.length;t++){var s,r=this.sM(i[t].x,i[t].y,e);if(!r)return!0;r.x=Math.round(r.x),r.y=Math.round(r.y),r.value=i[t].value,this.B3?(s=this.H3.width/this.Uv.size.x,r.radius=this.s_*s):r.radius=this.s_,this.Id.push(r)}},hM(t){this.qs=[];let e=[];if(this.X3.type===p.EXTENT_LAYER)for(let t=0;t<this.X3.children.length;t++)e.push(...this.X3.children[t].qs.Ti[0]);else e=this.X3.qs.Ti[0];for(;this.qs.length<t;){var i=Math.floor(this.Uv.min.x+Math.random()*this.Uv.size.x+1),s=Math.floor(this.Uv.min.y+Math.random()*this.Uv.size.y+1),r=this.P3.min+Math.floor(Math.random()*(this.P3.max-this.P3.min)+1);G.Se({x:i,y:s},e,e.length)&&this.qs.push({x:i,y:s,value:r})}},M_(){this.dv&&null!==this.qs&&this.Qs&&this.pM()&&(this.Id.length=0,this.iM(),this.update())},pM(){let e=!1;var i=Array.from(this.st.getRenderManager().getRenderList().keys()),s=this.hr.parent;for(let t=0;t<i.length;t++){var r=i[t].split("%A%B%C%D");if(""+r[0]==""+s.buildingID&&""+r[1]==""+this.hr.level){e=!0;break}}return e},iM(){var t=this.lM();this.uM(t),this.q3=this.oM(this.Y3),this.rM(this.Y3,t),this.j3.un.setDimensions(this.q3.width,this.q3.height)},uM(e){this.Y3=new sa;let i=null,s=null,r=null,n=null;var t=this.vM()*this.s_;for(let t=0;t<e.length;t++)(null===i||i>e[t].x)&&(i=e[t].x),(null===s||s>e[t].y)&&(s=e[t].y),(null===r||r<e[t].x)&&(r=e[t].x),(null===n||n<e[t].y)&&(n=e[t].y);t=[{x:i-t,y:s-t},{x:i-t,y:n+t},{x:r+t,y:n+t},{x:r+t,y:s-t}];this.Y3.expandByCoords(t)},lM(){var i=[],s=this.qs,t=this.vM()*this.s_;for(let e=0;e<s.length;e++){var r=D3.circleBuilder(t,s[e],32);for(let t=0;t<r.length;t++)if(this.mM(r[t])){i.push(s[e]);break}}return i},mM(t){var t=new Gt(t.x-this.st.x,this.hr.height,this.st.y-t.y),e=this.st.camera,t=t.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix);return!(1<Math.abs(t.x)||1<Math.abs(t.y)||1<Math.abs(t.z))},vM(){var t={x:nt.document.body.clientWidth/2,y:nt.document.body.clientHeight/2,z:this.hr.height+this.Jt,buildingID:this.hr.parent.buildingID},e={x:t.x+1,y:t.y,z:this.hr.height+this.Jt,buildingID:this.hr.parent.buildingID},t=aa.coordsScreenToMap(this.st,t),e=aa.coordsScreenToMap(this.st,e),t=Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y));return this.st.getZoom()<this.K3?76.43745851702988:t},aM(t){this.Zs&&this.Zs.parent&&(this.Zs.parent.remove(this.Zs),this.Zs.material.map?.dispose(),this.Zs.geometry.dispose(),this.Zs.geometry=void 0,this.Zs.material.dispose(),this.Zs.material=void 0,this.Zs=void 0);let e=!1;t||(t=this.Y3,e=!0);var i=new Ph(t.size.x,t.size.y,1,1),s=this.E0(),i=new L(i,s);i.name="heatMap",i.position.y=this.Jt,i.position.x=t.center.x-this.st.x,i.position.z=-t.center.y+this.st.y,i.rotation.set(-Math.PI/2,0,0,"XYZ"),null!==this.Q3&&(s.clippingPlanes=this.Q3,s.clipping=!0),i.material=s,this.Zs=i,this.Zs.visible=this.visible,this.Zs.mapNode=this,e&&this.P.scene.add(this.Zs)},gM(e){let i=[];var s=[];for(let t=0;t<e.length;t++)i.push({x:e[t].x,y:e[t].y});G.isClockwise(i[0],i[1],i[2])||(i=i.reverse());for(let t=0;t<i.length-1;t++){var r=i[t],n=i[t+1],a=(r.x+n.x)/2-this.st.x,h=-(r.y+n.y)/2+this.st.y,r=eM(G.getAngle({p1:r,p2:n}),{x:a,y:0,z:h},this),n=new Ar,a=new Gt,h=new Gt;a.set(0,0,1).applyQuaternion(r.quaternion),h.copy(r.position),n.setFromNormalAndCoplanarPoint(a,h),s.push(n),r.parent.remove(r)}return s}});class kE extends uE{constructor(t){super(t),this.Ai=p.DYNAMIC_MODEL_MARKER,this.Ht=void 0!==t.id?t.id:ws.generateUUID(),this._M=ws.generateUUID(),this.nm=void 0!==t.fadeIn&&t.fadeIn,this.Hv=void 0!==t.fadeOut&&t.fadeOut,this.Kr=void 0!==t.opacity?t.opacity:null,this.wM=void 0!==t.scale?t.scale:1,this.MM=t.shadingMode,void 0===this.MM&&(this.MM=ih.CLASSIC),this.Qs=!0,void 0!==t.visible&&(this.Qs=t.visible),this.yM=t.tilt,this.Xv=t.url,this.Ym=t.heading,this.W=t.callback,this.EM=new Map,this.EM.set(this.ROOT,t.color),this.s1=null,this.ap=[],this.Mm=null,this.ym=null,this.h0=null,this.Tr=null,this.gm=this.gm.bind(this),this.Lm=!1,this.Rm=[],this.xM=null}get FID(){return this._M}get color(){return this.getModelColor()}set color(t){this.modifyModelColor(t)}get scale(){return this.wM}set scale(t){this.wM=t,this.Pa()}get tilt(){return this.yM}get heading(){return this.Ym}get opacity(){return this.Kr}set opacity(t){this.Kr=t,this.Pr()}addTo(t){super.addTo(t),this.Tr=t.level,this.h0=t.parent.buildingID,t.parent instanceof C3&&(this.h0=null)}moveTo(t){let e=t.buildingID;if(void 0===e&&(e=this.h0),this.h0!=e){this.h0=e,this.Tr=t.level;var i=this.ur(E);if(!i)return!1;if(!this.Zs)return!1;var s=this.Hv,i=(this.Hv=!1,this.remove(),this.Vs(i));this.addTo(i),this.Hv=s}else t.level&&this.bM(t.level);return super.moveTo(t)}modifyModelColor(t,e){e=e||this.ROOT,this.EM.set(e,t),this.Pr()}getNodeNames(){let s=[];return this.Zs?(function e(t){"Mesh"!==t.type&&"SkinnedMesh"!==t.type||s.push(t.name);let i=t.children;for(let t=0;t<i.length;t++)e(i[t])}(this.Zs),s):[]}getModelColor(t){return t=t||this.ROOT,this.EM.get(t)}rotateTo(i){let s=this.ur(E);if(!s)return!1;var r=i.heading%360*u.DEG2RAD;if(this.SM=i.heading,this.Zs){var n=this.Zs.rotation.y;let t=0,e=n+(t=r-n!=0?Math.sin(r-n)/Math.abs(Math.sin(r-n))*Math.acos(Math.cos(r-n)):t);if(i.animate){r=i.duration||.5;let t;this.As.has("rotation")?t=this.As.get("rotation"):(t=new an,this.As.set("rotation",t));var a=this.Ym;t.Y([n,a]).Z([e,i.heading]).K(r).J(t=>{this.Zs.rotation.y=t.destination[0],this.Ym=t.destination[1],s.enableUpdateRender()}).$(()=>{this.Zs.rotation.y=e,this.Ym=i.heading,s.enableUpdateRender(),i.finish&&i.finish()}),s.ot.lt(t.X())}else this.Zs.rotation.y=e,this.Ym=i.heading,s.enableUpdateRender(),i.finish&&i.finish();return this.As.get("rotation")}}startAction(t,e){var i=this.ap[t],e=(i&&(e&&(i.clampWhenFinished=!0,i.loop=ni),this.Mm&&this.Mm===t?(i.time=this.ym,i.paused=!1,i.play(),this.Mm=null,this.ym=null):(this.Mm!==t&&(this.Mm=null,this.ym=null),i.reset().setEffectiveTimeScale(1).setEffectiveWeight(1).play())),this.ur(E));e&&e.on("beforeRender",this.gm)}getAction(){return this.ap}getClip(t){return this.ap[t].n1}getMixer(){return this.s1}stopAction(t){var e=this.ur(E),e=(e&&e.off("beforeRender",this.gm),this.ap[t]);e&&(e.paused=!0,this.Mm=t,this.ym=e.time)}getActionNames(){return Object.keys(this.ap)}remove(){this.stop(),this.Rm.forEach(t=>{t.stop()}),this.Zs&&this.Zs.bloom&&this.Zs.bloom.remove(this);var t=this.ur(E);t&&this.s1&&t.ot.Wm(this.s1),super.remove()}dispose(){super.dispose(),this.remove(),this.Zs&&(this.Zs.mapNode=void 0,this.Zs=void 0),this.dv=!1,this.AM()}getRenderNode(){return this.Zs}getActions(){return this.Zs?Promise.resolve(this.Rm):new Promise(t=>{let e=()=>{this.Zs?t(this.Rm):setTimeout(e,50)};e()})}}Object.assign(kE.prototype,{ROOT:"root",bM(t){var e;this.Tr!==t&&(this.Tr=t,t=this.ur(E))&&(e=this.Hv,this.Hv=!1,this.remove(),t=this.Vs(t),this.addTo(t),this.Hv=e)},Vs(t){return(this.h0?t.getBuilding(this.h0):t).getFloor(this.Tr)},Bu(){if(!this.dv){let s=this.ur(E);if(!s)return!1;this.dv=!0;var n=this.Xv.split(".");let r=n[n.length-1].toLocaleLowerCase();this.fileExtension=r;n={gltf:{},glb:{},fbx:nt.window.fengmap?.FBXLoader};if(n[r]){let t,e,i=(t=("glb"===r||"gltf"===r?(e=s.Wt.Zf).Vo:(e=new n[r]).load).bind(e),{glb:t=>t.scene,fbx:t=>t});return i.gltf=i.glb,t(this.Xv,t=>{if(this.dv){if(this.Zs=i[r](t),this.Zs.visible=this.Qs,this.Ym&&(this.Zs.rotation.y=this.Ym%360*u.DEG2RAD),this.yM&&(this.Zs.rotation.x=this.yM%360*u.DEG2RAD),this.Pa(),(this.Zs.mapNode=this).P.xa.add(this.Zs),0<t.animations.length){this.s1=new gM(this.Zs),this.Rm.length=0;for(var e of t.animations){this.ap[e.name]=this.s1.clipAction(e);e=new _M(this,e.name,this.s1.clipAction(e),s);this.Rm.push(e)}s.ot.Bm(this.s1)}this.Pr(),this.Lg(),this.nm&&this.Vv({src:[0],dest:[1],duration:1}),s.enableUpdateRender(),this.W&&this.W(this)}},null,function(t){console.error(t)}),!0}console.error(" "+r)}},Vv(e){let s=this.ur(E);if(s){let t=new an({src:e.src||[0],dest:e.dest||[1]});this.As.set("faceIn",t),t.K(e.duration||1).J(t=>{let i=t.destination[0];this.Zs.traverse(t=>{var e;"Mesh"!==t.type&&"SkinnedMesh"!==t.type||("glb"===this.fileExtension||"gltf"===this.fileExtension?(t.material.transparent=!0,e=t.material.userData.sourceOpacity,t.material.opacity=e*i,s.enableUpdateRender()):Array.isArray(t.material)?(t.material.forEach(t=>{var e=t.userData.sourceOpacity;t.transparent=!0,t.opacity=e*i}),s.enableUpdateRender()):(e=t.material.userData.sourceOpacity,t.material.transparent=!0,t.material.opacity=e*i))})}).$(()=>{e.callback&&e.callback(),s.ot.ht(t),s.enableUpdateNode()}).X(),s.ot.lt(t)}},Pa(){if(this.Zs){var t=this.ur(E);if(!t)return!1;var e=this.Zs?.userData?.sourceScale||new N3(1,1,1);this.Zs.scale.copy(e).multiplyScalar(this.wM),t.enableUpdateRender()}},TM(t){void 0===t.userData.sourceOpacity&&(t.userData.sourceOpacity=t.opacity),void 0===t.userData.sourceTransparent&&(t.userData.sourceTransparent=t.transparent)},RM(t,e){e=null!==this.Kr?this.Kr*e.Kr:void 0!==t.userData.sourceOpacity?t.userData.sourceOpacity*e.Kr:t.opacity*e.Kr;return{opacity:e,transparent:t.userData.sourceTransparent||e<1}},Pr(){let i=this;if(this.Zs){let h=this.ur(E),o=this.ur(v);var t=this.EM.get(this.ROOT);function l(t){if(i.MM===ih.CLASSIC)for(var e in t)t[e]&&t[e].isTexture&&(t[e].colorSpace=bi)}this.LM(this.Zs,t,(e,t)=>{var i={color:t},s=this.CM(e.material,o,i);if("glb"===this.fileExtension||"gltf"===this.fileExtension)if(Array.isArray(e.material.length))for(let t=0;t<e.material.length;t++)e.material[t].depthWrite=!0,e.material[t]=h.Wt.pl.su(e.material[t],s),l(e.material[t]);else e.material.depthWrite=!0,e.material=h.Wt.pl.su(e.material,s),l(e.material);else if(Array.isArray(e.material))for(let t=0;t<e.material.length;t++){this.TM(e.material[t]),e.material[t].depthWrite=!0;var{opacity:r,transparent:n}=this.RM(e.material[t],o);e.material[t].color=new Wt(i.color||16777215),e.material[t].opacity=r,e.material[t].transparent=n,l(e.material[t])}else{this.TM(e.material),e.material.depthWrite=!0;var{opacity:t,transparent:a}=this.RM(e.material,o);e.material.color=new Wt(i.color||16777215),e.material.opacity=t,e.material.transparent=a,l(e.material)}}),h.enableUpdateRender()}},LM(e,i,s){var t=this.EM.get(e.name);if(t&&(i=t),"Mesh"===e.type||"SkinnedMesh"===e.type)s(e,i);else for(let t=0;t<e.children.length;t++)this.LM(e.children[t],i,s)},CM(t,e,i){var s;if("glb"===this.fileExtension||"gltf"===this.fileExtension)return s={},void 0===t.userData.sourceOpacity&&(t.userData.sourceOpacity=t.opacity),void 0===t.userData.sourceTransparent&&(t.userData.sourceTransparent=t.transparent),i.color&&(s.color=i.color),s.opacity=null!==this.Kr?this.Kr*e.Kr:void 0!==t.userData.sourceOpacity?t.userData.sourceOpacity*e.Kr:t.opacity*e.Kr,s.transparent=t.userData.sourceTransparent||s.opacity<1,s},gm(){var t=this.ur(E);t&&t.enableUpdateRender()},NM(e){if(e._interpolant&&(e._interpolant.length=0),e.o1){for(let t=0;t<e.o1.length;t++)e.o1[t].parameterPositions=null,e.o1[t].resultBuffer=null,e.o1[t].sampleValues=null,e.o1[t]=null;e.o1=null}if(e.l1){for(let t=0;t<e.l1.length;t++)e.l1[t].binding=null,e.l1[t].buffer=null,e.l1[t]=null;e.l1=null}if(e.n1&&e.n1.tracks){for(let t=0;t<e.n1.tracks.length;t++)e.n1.tracks[t].times=null,e.n1.tracks[t].values=null,e.n1.tracks[t]=null;e.n1.tracks=null,e.n1=null}},AM(){for(var t in this.ap)this.NM(this.ap[t]),this.ap[t]=null;if(this.ap=[],this.s1){for(let t=0;t<this.s1.Lc.length;t++)this.s1.Lc[t].buffer=null;this.s1.Lc=null,this.s1.J1=null,this.s1.Mh=null,this.s1.stats=null,this.s1.tp=null,this.s1.ap=null,this.s1=null}},xp(){if(!this.Lm){var e=this.getActionNames();for(let t=0;t<e.length;t++)this.ap[e[t]].stop();this.Lm=!0}},Ep(e){let i=this,s=e.playInfo.startParam,r=e.playInfo.count,n=e.playInfo.timeout,a=e.getClip().tracks[0].times,h=0;!function t(){h<=Math.abs(r)?(e.loop=ni,e.clampWhenFinished=!0,e.time=a[s+h*r/Math.abs(r)],e.play(),e.paused=!0,i.gm(),h++,e.playInfo.param=h,e.playInfo.timelone=setTimeout(t,1e3*n)):(e.paused=!0,i.gm(),null!==e.playInfo.timelone&&(clearTimeout(e.playInfo.timelone),e.playInfo.timelone=null,e.playInfo.once?e.playInfo=null:(h=0,t())))}()},IM(h){if(h.playInfo){null!==h.playInfo.timelone&&clearTimeout(h.playInfo.timelone);let e=this,i=h.playInfo.startParam,s=h.playInfo.count,r=h.playInfo.timeout,n=h.getClip().tracks[0].times,a=h.playInfo.param;!function t(){a<=Math.abs(s)?(h.loop=ni,h.clampWhenFinished=!0,h.time=n[i+a*s/Math.abs(s)],h.play(),h.paused=!0,e.gm(),a++,h.playInfo.param=a,h.playInfo.timelone=setTimeout(t,1e3*r)):(h.paused=!0,e.gm(),null!==h.playInfo.timelone?(clearTimeout(h.playInfo.timelone),h.playInfo.timelone=null,h.playInfo.once||(a=0,t())):h.playInfo=null)}()}}});class GE extends uE{constructor(t){super(t),this.Ht=null,this.Ai=p.DOM_MARKER,this.PM=void 0!==t.fontsize?t.fontsize:16,this.DM=t.content,this.M3=t.domWidth,this.y3=t.domHeight,this.OM=t.domWidth,this.UM=t.domHeight,this.f3=void 0!==t.anchor?t.anchor:Ir.CENTER,this.Kr=void 0!==t.opacity?t.opacity:1,this.Xa=void 0!==t.collision&&t.collision,this.w3=!1,this.Zs=null,this.dv=!1,this.Tr=null,this.h0=null,this.hr=null,this.FM=null,this.BM=this.BM.bind(this),this.mv=null,this.Bu()}get isInputElement(){if(!this.Zs)return!1;var e=["input","textarea"];let i=!1;for(let t=0;t<e.length;t++)if(0<=this.Zs.element.childNodes[0].innerHTML.toLocaleLowerCase().indexOf(e[t])){i=!0;break}return i}get content(){return this.DM}set content(t){this.DM=t,"string"==typeof this.DM?this.Zs.element.childNodes[0].innerHTML=""+this.DM:this.Zs.element.childNodes[0].appendChild(this.DM),void 0!==this.OM&&void 0!==this.UM||this.En(),this.hr.P.P.enableUpdateRender()}get visible(){return this.Qs}set visible(t){this.Qs=t;t=this.hr.P.P;this.Zs&&(this.Qs?t.Xw.xa.add(this.Zs):this.Zs.parent&&t.Xw.xa.remove(this.Zs)),t.enableUpdateRender()}get opacity(){return this.Kr}set opacity(t){this.Kr=t,this.Zs.element.childNodes[0].style.opacity=this.Kr,this.hr.P.P.enableUpdateRender()}get level(){return this.Tr}remove(){this.Zs&&(this.stop(),this.isInputElement&&(this.hr.P.P.getInteracations().controls.enabled=!0),this.mv.remove(this),this.P&&this.P.remove(this),this.Zs.parent&&this.Zs.parent.remove(this.Zs),this.P=void 0,this.hr.P.P.enableUpdateRender(),this.dispose(!0))}addTo(t){let e=t.P.P;if(null===e.Xw.un&&e.Xw.Bu(),this.dv||this.Bu(),this.Tr=t.level,this.hr=t,this.h0=t.parent.buildingID,this.Zs.position.set(this.t-e.x,t.height+this.Jt,-this.o+e.y),this.Zs.element.childNodes[0].style.opacity=t.Kr,e.Xw.add(this),this.mv=t.getOrCreateLayer(this.Ai),this.mv.add(this),this.isInputElement){let t=null;this.kM=()=>{t=e.getInteracations().controls.enabled,e.getInteracations().controls.enabled=!1,e.getInteracations().controls.resetState()},this.GM=()=>{null!==t&&(e.getInteracations().controls.enabled=t,e.getInteracations().controls.resetState(),t=null)},this.Zs.element.childNodes[0].addEventListener("mouseenter",this.kM),this.Zs.element.childNodes[0].addEventListener("mouseleave",this.GM)}e.enableUpdateRender()}dispose(t){t||this.remove(),this.Zs&&(this.isInputElement&&(this.Zs.element.childNodes[0].removeEventListener("mouseenter",this.kM),this.Zs.element.childNodes[0].removeEventListener("mouseleave",this.GM)),this.Zs.mapNode=void 0,this.Zs=void 0),this.dv=!1}getRenderNode(){return this.Zs}}Object.assign(GE.prototype,{Bu(){var t=document.createElement("div"),e=document.createElement("div");e.style.position="absolute";let i=!(e.style.pointerEvents="all");void 0===this.M3||void 0===this.y3?i=!0:(e.style.width=this.M3+"px",e.style.height=this.y3+"px"),e.style.fontSize=this.PM+"px",e.style.opacity=this.Kr,i||(s=this.HM(),e.style.top=s.top,e.style.left=s.left),"string"==typeof this.DM?e.innerHTML=this.DM:e.appendChild(this.DM),t.appendChild(e);var s=new vE(t);return this.Zs=s,this.Zs.element.childNodes[0].style.display="none",(this.Zs.mapNode=this).dv=!0,this.Ht=this.Zs.uuid,i&&this.En(),!0},En(){let i=this,s=null,r=document.createElement("div"),n=this.Zs.element.childNodes[0];r.style.position="absolute",void 0===this.OM?r.style.width="fit-content":r.style.width=this.OM+"px",void 0===this.UM?r.style.height="fit-content":r.style.height=this.UM+"px",r.style.fontSize=this.PM+"px",r.innerHTML=n.innerHTML,document.body.appendChild(r),function t(){if(r.parentNode){null!==s&&clearTimeout(s);let t=r.getBoundingClientRect(),e=(i.M3=t.width,i.y3=t.height,i.HM());n.style.width=i.M3+"px",n.style.height=i.y3+"px",n.style.top=e.top,n.style.left=e.left,r.parentNode.removeChild(r)}else s=setTimeout(t(),1)}()},HM(){let t,e;switch(this.f3){case Ir.CENTER:t=-this.M3/2,e=-this.y3/2;break;case Ir.RIGHT_BOTTOM:t=-this.M3,e=-this.y3;break;case Ir.LEFT_BOTTOM:t=0,e=-this.y3;break;case Ir.RIGHT_TOP:t=-this.M3,e=0;break;case Ir.LEFT_TOP:t=0,e=0;break;case Ir.RIGHT:t=-this.M3,e=-this.y3/2;break;case Ir.LEFT:t=0,e=-this.y3/2;break;case Ir.BOTTOM:t=-this.M3/2,e=-this.y3;break;case Ir.TOP:t=-this.M3/2,e=0}return this.FM={left:t,top:e},{left:t+"px",top:e+"px"}},_3(){var t=this.P.P;if(!this.FM)return null;var e=t.camera;this.Zs.updateMatrixWorld(!0);var e=(new Gt).setFromMatrixPosition(this.Zs.matrixWorld).applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix),i=t.bt.renderer.domElement.clientWidth,t=t.bt.renderer.domElement.clientHeight,s=e.x,e=e.y;return{leftTop:new ct(s-this.M3/i,e+this.y3/t),rightDown:new ct(s+this.M3/i,e-this.y3/t)}},BM(t){var e,i=this.P.P,s={};for(e in t)s[e]=t[e];s.offsetX=t.clientX,s.offsetY=t.clientY,i.Vr.W(s)},Pr(){this.Zs.element.childNodes[0].style.opacity=this.hr.Kr}});class HE{constructor(t){this.VM=t.origon,this.Ki=t.target,this.zM=null,this.WM=null,this.jM=null,this.XM=null,this.YM=null,this.ZM=null,this.qM=null,this.KM=null,this.Bu()}transform(t){let e=t.x-this.zM.x,i=t.y-this.zM.y;var t=this.WM.x*e+this.WM.y*i,s=this.jM.x*e+this.jM.y*i;let r=t/this.XM.x,n=s/this.XM.y,a=r*this.KM.x,h=n*this.KM.y;return{x:this.YM.x+this.ZM.x*a+this.qM.x*h,y:this.YM.y+this.ZM.y*a+this.qM.y*h}}}Object.assign(HE.prototype,{Bu(){!Array.isArray(this.VM)||!Array.isArray(this.Ki)||this.VM.length<3||this.Ki.length<3||(this.zM=this.VM[0],this.WM={x:this.VM[1].x-this.VM[0].x,y:this.VM[1].y-this.VM[0].y},this.jM={x:this.VM[2].x-this.VM[0].x,y:this.VM[2].y-this.VM[0].y},this.XM={x:G.ze(this.WM),y:G.ze(this.jM)},this.YM=this.Ki[0],this.ZM={x:this.Ki[1].x-this.Ki[0].x,y:this.Ki[1].y-this.Ki[0].y},this.qM={x:this.Ki[2].x-this.Ki[0].x,y:this.Ki[2].y-this.Ki[0].y},this.KM={x:G.ze(this.ZM),y:G.ze(this.qM)},this.WM.x/=this.XM.x,this.WM.y/=this.XM.x,this.jM.x/=this.XM.y,this.jM.y/=this.XM.y,this.ZM.x/=this.KM.x,this.ZM.y/=this.KM.x,this.qM.x/=this.KM.y,this.qM.y/=this.KM.y)}});class VE{constructor(t){this.Ia=t.size,this.Ws=t.rotation,this.yi=t.center}get min(){return{x:this.yi.x-this.Ia.x/2,y:this.yi.y-this.Ia.y/2}}get max(){return{x:this.yi.x+this.Ia.x/2,y:this.yi.y+this.Ia.y/2}}get center(){return{x:this.yi.x,y:this.yi.y}}get rotation(){return this.Ws}get size(){return{x:this.Ia.x,y:this.Ia.y}}clone(){return new VE({size:this.Ia,center:this.yi,rotation:this.Ws})}valid(){return!(this.min.x>this.max.x||this.min.y>this.max.y)}expand(t){t&&t.valid()&&(t.min.x<this.min.x&&(this.min.x=t.min.x),t.min.y<this.min.y&&(this.min.y=t.min.y),t.max.x>this.max.x&&(this.max.x=t.max.x),t.max.y>this.max.y)&&(this.max.y=t.max.y)}}let zE={Default:1,Legacy:2,Classic:4,Custom:8};class WE{constructor(t,e){this.JM=t,this.$M=e,this.QM={[zE.Default]:{FMExtentLayer:[{name:"DirectionalLight",color:11579568,intensity:.95,position:{x:58,y:65,z:40},id:0},{name:"AmbientLight",color:11579568,intensity:.85,id:1},{name:"DirectionalLight",color:6447714,intensity:.65,position:{x:-100,y:0,z:45},id:2}],FMDynamicModelLayer:[{name:"DirectionalLight",color:11579568,intensity:.95,position:{x:58,y:65,z:45},id:0},{name:"AmbientLight",color:11579568,intensity:.85,id:1},{name:"DirectionalLight",color:6447714,position:{x:-100,y:0,z:45},intensity:.45,id:2}],FMModelLayer:[{name:"DirectionalLight",color:11645361,intensity:.95,position:{x:58,y:65,z:40},id:0},{name:"AmbientLight",color:11645361,intensity:.85,id:1},{name:"DirectionalLight",color:6513507,position:{x:-100,y:0,z:45},intensity:.65,id:2}],FMExternalModelLayer:[{name:"DirectionalLight",color:11579568,intensity:.95,position:{x:58,y:65,z:45},id:0},{name:"AmbientLight",color:11579568,intensity:.85,id:1},{name:"DirectionalLight",color:6447714,position:{x:-100,y:0,z:45},intensity:.45,id:2}]},[zE.Legacy]:{FMExtentLayer:[{name:"DirectionalLight",color:8947848,intensity:1.2,position:{x:-1,y:1,z:1},id:0},{name:"AmbientLight",color:7631988,intensity:1,id:1},{name:"DirectionalLight",color:3355443,intensity:1,position:{x:-.5,y:1,z:-1},id:2}],FMExternalModelLayer:[{name:"DirectionalLight",color:8947848,intensity:1.2,position:{x:-1,y:1,z:1},id:0},{name:"AmbientLight",color:16777215,intensity:.46,id:1},{name:"DirectionalLight",color:3355443,position:{x:-.5,y:1,z:-1},intensity:1,id:2}],FMModelLayer:[{name:"DirectionalLight",color:8947848,intensity:1.2,position:{x:-1,y:1,z:1},id:0},{name:"AmbientLight",color:7631988,intensity:1,id:1},{name:"DirectionalLight",color:3355443,position:{x:-.5,y:1,z:-1},intensity:1,id:2}],FMDynamicModelLayer:[{name:"DirectionalLight",color:8947848,intensity:1.2,position:{x:-1,y:1,z:1},id:0},{name:"AmbientLight",color:7631988,intensity:1,id:1},{name:"DirectionalLight",color:3355443,position:{x:-.5,y:1,z:-1},intensity:1,id:2}]},[zE.Classic]:{FMExtentLayer:[{name:"DirectionalLight",color:8947848,intensity:1.2,position:{x:-1,y:1,z:1},id:0},{name:"AmbientLight",color:7631988,intensity:1,id:1},{name:"DirectionalLight",color:3355443,intensity:1,position:{x:-.5,y:1,z:-1},id:2}],FMExternalModelLayer:[{name:"DirectionalLight",color:8947848,intensity:1.2,position:{x:-1,y:1,z:1},id:0},{name:"AmbientLight",color:16777215,intensity:.46,id:1},{name:"DirectionalLight",color:3355443,position:{x:-.5,y:1,z:-1},intensity:1,id:2}],FMModelLayer:[{name:"DirectionalLight",color:8947848,intensity:1.2,position:{x:-1,y:1,z:1},id:0},{name:"AmbientLight",color:7631988,intensity:1,id:1},{name:"DirectionalLight",color:3355443,position:{x:-.5,y:1,z:-1},intensity:1,id:2}],FMDynamicModelLayer:[{name:"DirectionalLight",color:8947848,intensity:.9,position:{x:-1,y:1,z:1},id:0},{name:"AmbientLight",color:16777215,intensity:.33,id:1},{name:"DirectionalLight",color:3355443,position:{x:-.5,y:1,z:-1},intensity:1,id:2}]}}}getConfig(){return this.JM==zE.Custom?this.$M:this.QM[this.JM]}}class jE{constructor(){this.st=null,this.rn={},this.O=(new Date).getTime(),this.V=this.V.bind(this)}replace(t,e,i){this.getTextureNames(t).indexOf(e)<0?console.warn(e+"gif,"):(this.ty(t.FID,e),0<=i.indexOf(".mp4")||0<=i.indexOf(".webm")||0<=i.indexOf(".ogg")?this.Vp(i,t,e):0<=i.indexOf(".gif")?this.Pp(i,t,e):(0<=i.indexOf(".jpg")||0<=i.indexOf(".png"))&&this.ey(i,t,e),t.multiMediaTool.replace(e),null===this.st&&(this.st=t.parent.parent.parent.parent,this.st.on("update",this.V)))}reset(t,e){this.ty(t.FID,e),t.multiMediaTool.reset(e)}dispose(){for(var t in this.rn){var e=t.split("_");this.reset(this.rn[t].externalModel,e[1])}this.st.off("update",this.V)}getTextureNames(t){return t.multiMediaTool.textureNames}}Object.assign(jE.prototype,{ty(t,e){var i=this.rn[t+"_"+e];if(i&&"video"===i.type)document.getElementById(i.texture.video_id).parentNode.removeChild(document.getElementById(i.texture.video_id)),i.texture.dispose();else if(i&&"gif"===i.type)for(let t=0;t<i.canvasArray.length;t++)i.canvasArray[t].getContext("2d").clearRect(0,0,i.canvasArray[t].width,i.canvasArray[t].height);delete this.rn[t+"_"+e]},ey(t,e,i){let s=new Image;s.crossOrigin="Anonymous",s.onload=()=>{var t=document.createElement("canvas");t.width=512,t.height=512,t.getContext("2d").drawImage(s,0,0,512,512),this.rn[e.FID+"_"+i]={type:"gif",canvascount:0,externalModel:e,canvasArray:[t],isnewupdate:!0}},s.src=t},Vp(t,s,r){let n=this,e=(this.Gp=t,null);var i=document.createElement("div");i.style.display="none";let a="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)});var h=a+"_div";i.setAttribute("id",h),i.innerHTML='<video id="'+a+'" loop crossOrigin="anonymous" muted><source src="'+t+'"></video>',document.body.appendChild(i),function t(){let i=document.getElementById(a);i?(null!==e&&clearTimeout(e),i.addEventListener("loadeddata",t=>{var e=new xM(i);e.video_id=a+"_div",e.name=r,s.isGltf&&(e.flipY=!1),n.rn[s.FID+"_"+r]={type:"video",externalModel:s,texture:e,isnewupdate:!0},i.play()})):e=setTimeout(t,0)}()},Pp(t,e,i){var s=document.createElement("div");s.style.display="none",document.body.appendChild(s);let r=new Image;r.crossOrigin="Anonymous",r.onload=()=>{this.rn[e.FID+"_"+i]={type:"gif",canvascount:0,externalModel:e,canvasArray:[],isnewupdate:!0},s.appendChild(r);var t=new yM({gif:r});t.load(()=>{this.Dp(t,e.FID,i,s)})},r.src=t},Dp(s,r,n,t){let a=this,h=null,e=s.get_length(),o=1;this.rn[r+"_"+n].canvascount=0,function i(){if(o>e)document.body.removeChild(t),null!==h&&clearTimeout(h);else{s.move_to(o);let t=document.createElement("canvas"),e=(t.width=512,t.height=512,t.getContext("2d"));e.drawImage(s.get_canvas(),0,0,512,512),a.rn[r+"_"+n].canvasArray.push(t),o++,h=setTimeout(i,0)}}()},iy(a){let r=this;var t=a.getRenderNode();function e(e){var i=a.multiMediaTool.oldMaterial[e.name];if(Array.isArray(i))for(let t=0;t<i.length;t++){var s,r=h(e.material[t],i[t]);r&&(r.iscanvasinfo?(s=r.info,e.material[t].map.image=s.canvasArray[s.canvascount],e.material[t].map.needsUpdate=!0):(e.material[t].dispose(),e.material[t]=r))}else{var t,n=h(e.material,i);n&&(n.iscanvasinfo?(t=n.info,e.material.map.image=t.canvasArray[t.canvascount],e.material.map.needsUpdate=!0):(e.material.dispose(),e.material=n))}}function h(t,e){let i="";e.uniforms&&e.uniforms.map&&e.uniforms.map.value?i=e.uniforms.map.value.name:e.map&&(i=""+e.map.name).indexOf(".gif")<0&&i.indexOf(".mp4")<0&&i.indexOf(".webm")<0&&i.indexOf(".ogg")<0&&(i=""+e.name);var s,e=r.rn[a.FID+"_"+i];return e?"video"===e.type?!t.isupdate||e.isnewupdate?(e.isnewupdate=!1,(s=new ro({map:e.texture.clone()})).isBasic=!0,s.isupdate=!0,s.updatename=i,s):null:"gif"===e.type?e.canvasArray[e.canvascount]?!t.isupdate||e.isnewupdate?(e.isnewupdate=!1,s=new Y0(e.canvasArray[e.canvascount]),a.isGltf&&(s.flipY=!1),s.repeat.set(1,1),s.name=i,s.magFilter=V,s.minFilter=ie,(t=new ro({map:s})).updatename=i,t.isBasic=!0,t.isupdate=!0,t):{iscanvasinfo:!0,info:e}:null:void 0:null}t&&(a.isGltf?t.traverse(t=>{"Mesh"===t.type&&e(t)}):e(t))},V(){var t,e,i=(new Date).getTime(),s=i-this.O;50<=s&&(this.O=i);let r=[];for(t in this.rn)(e=>{let i=!0;for(let t=0;t<r.length;t++)if(r[t].FID===e){i=!1;break}return i})(t.split("_")[0])&&this.rn[t]&&r.push(this.rn[t].externalModel),"gif"===this.rn[t].type&&50<=s&&((e=this.rn[t]).canvascount<e.canvasArray.length-1?e.canvascount++:e.canvascount=0);for(let t=0;t<r.length;t++)this.iy(r[t])}});class XE{constructor(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s}contains(t){return t.x>=this.x&&t.y>=this.y&&t.x<this.x+this.width&&t.y<this.y+this.height}intersects(t){return this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.y+this.height>t.y}}class YE{constructor(t,e=1,i=8,s=0){this.bound=t,this.maxPoints=e,this.maxDepth=i,this.depth=s,this.points=[],this.nodes=[]}insert(t,e){if(this.bound.contains(t)){if(e){if(0===this.nodes.length||this.depth>=this.maxDepth)return this.points.push(t),!0}else if(this.points.length<this.maxPoints||this.depth>=this.maxDepth)return this.points.push(t),!0;0===this.nodes.length&&this.split();for(var i of this.nodes)if(i.insert(t,e))return!0}return!1}delete(i){let s=this;var t=(()=>{let e=-1;for(let t=0;t<s.points.length;t++)if(s.points[t].x===i.x&&s.points[t].y===i.y){e=t;break}return e})();if(-1!==t)this.points.splice(t,1);else for(let t=0;t<this.nodes.length;t++)this.nodes[t].delete(i)}split(){var t,e=this.bound.x,i=this.bound.y,s=this.bound.width/2,r=this.bound.height/2;this.nodes.push(new YE(new XE(e,i,s,r),this.maxPoints,this.maxDepth,this.depth+1)),this.nodes.push(new YE(new XE(e+s,i,s,r),this.maxPoints,this.maxDepth,this.depth+1)),this.nodes.push(new YE(new XE(e,i+r,s,r),this.maxPoints,this.maxDepth,this.depth+1)),this.nodes.push(new YE(new XE(e+s,i+r,s,r),this.maxPoints,this.maxDepth,this.depth+1));for(t of this.points)for(var n of this.nodes)n.insert(t);this.points=[]}query(t){let e=[];if(this.bound.intersects(t)){for(var i of this.points)t.contains(i)&&e.push(i);for(var s of this.nodes)e=e.concat(s.query(t))}return e}}class ZE{constructor(){}scatterPoints(e,t){var i=t.min.x,s=t.min.y,r=t.max.x-t.min.x,t=t.max.y-t.min.y,i=new XE(i,s,r,t),n=new YE(i);for(let t=0;t<e.length;t++)n.insert(e[t]);return n}clusterPoints(e,i,s,t){var r=[];t&&e.sort(function(t,e){return e.weight-t.weight});for(let t=0;t<e.length;t++){var n=e[t];if(!n.clustered){let t=i.query(new XE(n.x-s/2,n.y-s/2,s,s));if(0!=(t=t.filter(function(t){return!0!==t.clustered})).length){for(var a of t)a.clustered=!0;r.push(t)}}}return r}getClusterCenter(i,s=!1){var r=[];for(let e=0;e<i.length;e++){var n,a,h=i[e].length;let t={};h<=0||(n=i[e][0].level,a=i[e][0].buildingID,(t=s?this.get_centroid(i[e],s):this.get_centroid(i[e])).level=n,t.buildingID=a,t.num=h,r.push(t))}return r}get_centroid(r,t=!1){var n={};if(0!=r.length){let e=0,i=0,s=0;if(t){for(let t=0;t<r.length;t++){var a=r[t];e+=a.x*a.weight,i+=a.y*a.weight,s+=a.weight}if(0==s)return n;e/=s,i/=s}else{for(let t=0;t<r.length;t++){var h=r[t];e+=h.x,i+=h.y}e/=r.length,i/=r.length}n={x:e,y:i}}return n}}class qE{constructor(t){this.sy=t.render,this.st=t.map,this.ny=t.gridSize,void 0===this.ny&&(this.ny=100),this.Id=t.points,this.J3=t.maxZoom,void 0===this.J3&&(this.J3=20),this.hy=t.renderClusterMarker,this.oy=t.renderMarker,this.DM=t.content,this.ly=t.clusterMarkerUserDefine,void 0===this.ly&&(this.ly=!1),this.uy=new Map,this.vy=null,this.py=new ZE,this.my=null,this.h0=t.buildingID,void 0===this.h0&&(this.h0=this.st.getMapOptions().buildingID),this.Tr=t.level,this.mi=null,this.M_=this.M_.bind(this),this.V=this.V.bind(this),this.gy=this.gy.bind(this),this._y=[],this.wy=[],this.O=0,this.My="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAACDFJREFUeF7Fmw2MXFUVx3/nzczOdrtt3LZaSYFEDdBqMFKgIUESqhVaxS4xYIJBRVZaMKxktYvT7XZ3ust+0G3aKrVAaJvYBqM0JkitfIjWmDUW6xeU+AFVI2CBCrSpbdmZ2feOuW936n5137vvvdk9yWQ+3vmf8z//e+/7uPeOMFW2Rc9DWYLwMeCjwAeBuUDtMIVTwNvAP4DDwJ+A52iS1ytJUSoZnIc1wylWIHwJ+Dgw3zLfm0A/ym5qeZLVUrLEB7pXToBNeiMO3wKuCmQRzuEgHvezRh4P5x7OK3kBNutH8NiKsCwcBUsv5VmUJprlRUvkhO7JCtCnDQgbgTlJkJskxnGUZpplZ9w8yQnQpx0I6+MSssIrnTRLmxVmjHMyAvTpduCuOERiYB+kWb4WFR9fgE3ag0cuKoFEcA69rJG1UWLFE6BHb8ch9jiMQnwcRvkyOdltGyu6AN26EIfngSrbpBXyH8DjMlrkrzbxowvQqz8HPmGTbAp8D5ATK07RBOjVepREb0gSE0e4kZz8OGw8ewEe0xRH+CNwadgkAX7l29tMQvEOU2QxeRkME89egPu0Hond+r8G9iH04/GaT9ThfNR/XvgscHUY8uf0EeppkSfCxIgiwE+BFWGCT+DzEg7NgeS6dSUefcDFkfIIT7BO6sNg7QTo0vkoLwGzwwQf43OYNDeQk1dCYXv1Qgb5ScShdpJBLiIvx4Jy2QnQqZ8DfhQUdILj/yTFlbSIed4Pb906F5dDwAfCg4Y9hZW0yr4gnJ0AHdoJtAYFHXdcWMF6ecoaZwCduhzlSWuseU5oD35OsBNgg5pLX6ixdZaw8Axtcr11ASMBHfo0ynWWMfbRLiuDMLYCmMufmdKysa/SHvOxdYM2ADtskgLP0y6BXO0EyKu5ZC2wIPIuKS5nvfzFAjPetVMX4fJ7YIZFnKPkJZCrnQDtehx4jwWJNxD/bGwmPKNbXmtRXgbebxHkBBukLsjfToA2fWt4Jjcobvn4URw+RF4GwgIm9GvULHX83bL3vUOHmFnnSc1WgH8BFwYFHXH8BIN8mO6YU9steh5p/mzZ+16lQwK52gnQqr8FrrQQwNziLqdDnrbCjHVu1eVgfSn8HfdJIFdbAX6I8nnLYrbRJY2WmNHu6/QB4G7LGHvpkkCudgKs1VYEczNkY2+hLKTH8i6wnCGv8yhiriLzbJICbXRLIFc7AVr0UyjPWBIx7nvoEbM6ZG853YNwqzVQuI5u+VkQzk6AnNYh/uUo8Ow6LrHSQq/0BBEadTynaxG6rTBDzv8hy8Xk5UQQ1k4AE22tPoryhaDAEx5XNjODdYGXxbxW8y5dCN+IlAe+R6/cFgZrL0BOl6EEdq1Jkv8B+DZpDtAlr47yu1fPR/x5xnuAxWEKOIfPNdwv/WHw9gKYqPfqr4BrwiSYxMc8Gr/gd9che+/wsrn98Bqd5Ck2SugJm6gCfBJ4NqYAlYE7XEGvmOeGUBZNABN6je4FbgqVZeqctrHJ7p4jugBmvHr+Tg6bh6NKSvEyBa7gATlpkyS6AEO94DOoP2833ebisIQ+MSdYK4sngEn1Td3or9VPpymNbJFtUSjEF8BkvUf34/DpKARiY5QdbJU7osZJRoAmnYOHWexYGJVIRFw/dSwNuwo0UY5kBBjqBZcI/rTVzIjF2MJe1xKL2S5v2AJH+icngIn6dV0uYFaOko07vsKCOixlq/wmTvEGmzjRVKPerlR204QIt7jfkR/ELb4iApigzt26WaEpCYJjYwhs9LaJ2X+YiCXeA8qspFEfRy0XUYJKUvbpd4MXO4LCVO4cMDLyKq1xMpgxavYFJ2F/82ZwOZvkdBLBzjZUksHGxbpLL0kJBxO4XS44cFVpu5gN1IlaxYZAmWX6Tr1WHQ7EYu1xk/uQRFmVDkxbcQH8k+KdmhOwmw77fx99yH1QKrYJc0oEMLVkVuv3FW4JbJLRDs8NPixJ7TafMPWUCUCjzs4UeVHhgpAiuE6KS4vbYy6sBiSbOgGA9CpdqvCLMAKo0uw9IpvC+MbxmVIB/KFwhz6mcPNkpBWOuAtYFOchJ6woUy9Ag16mwqQTFyrc6j4ij4YtIo7flAtgyKYbdD+cc/7ghcGdZheKaJzCwmKnS4CrxfwZagJzlPrCrnCbHMMWOZnftAhgCGUbtN8bsyNUlEPFXbIkicLCxpg+Ab6iN6gwah+fwPWFXRJl8TVsveP8KitAXh3eJoNLhjOk8UhRQ6rMoqrAL4FFw98PFYssYxbV/vczmJlelxoGSVFiLiXy4kWu9BzABAVQ4YvUkKamOstMz/MLyaiSQnAw7x7if3bQlMcxz+U2XNrMtIymaUwJ+93ynysVz0cJLoon5h1KjsPAQIHTDHKGPZyJe7KML8DNmmIW86tS1KnHzHKBfrGmAEPf2MjP5muKk54yS4ocRDjqZLjWc6jVQbJnG8tIZ+IYK382ccxvRhSH00WX4/yXN9krRiBriy1AdrVe5LoswKMgUPILDWMeUkpzrKpAHod/Fx12ZBze55cXxjz/OpnBIZtSXivslCNhYGN9YgvAKp2XcbmAFFWmu8tQ+7h+y08mxtBwMOM8jUvRfw8ygzE9QUmp4PjDwqVYKvEKu6NtwYkvgCFthkEtc7IZZqtSrUIWjypD0gghRoiRYpSHxVAxBf/8MCTEUO8xv5fNtPRw4b64DkVRCiIMFEqc5BTvRO3+JkUyAoxqORWaqOY0VZSoQsiYV9Z0V9NyptjM8AkR8EUyRMpd3whVwvVbV3ALZliZX8wrQ5GZFNnCQNyTX5ny/wAFqGhfpVfGKAAAAABJRU5ErkJggg==",this.Bu(),this.Yt=new iE}addPoint(t){this.Id.push(t),this.my.insert(t,!0),this.ly&&this.hy&&this.yy(),this.Ey(!0)}removePoint(i){let s=this;var t=(()=>{let e=-1;for(let t=0;t<s.Id.length;t++)if(s.Id[t].x===i.x&&s.Id[t].y===i.y){e=t;break}return e})();-1!==t&&(this.Id.splice(t,1),this.my.delete(i),this.ly&&this.hy&&this.yy(),this.Ey(!0))}dispose(){for(let t=0;t<this._y.length;t++)this._y[t].marker?.remove(),delete this._y[t];this.yy(),this._y.length=0,this.wy.length=0,this.xy(),this.Id.length=0,this.my=void 0,this.st.off("zoom",this.M_),this.st.off("move",this.M_),this.st.off("viewChanged",this.M_),this.st.off("resize",this.M_),this.ly&&this.st.off("click",this.gy)}on(t,e){this.Yt.mw(t,e)}}Object.assign(qE.prototype,{Bu(){var t=this.st.getBuilding(this.h0).getFloor(this.Tr);t?(this.mi=t.bound,this.by(),this.Ey(!0),this.st.on("zoom",this.M_),this.st.on("move",this.M_),this.st.on("viewChanged",this.M_),this.st.on("resize",this.M_),this.ly&&this.st.on("click",this.gy)):this.st.on("update",this.V)},yy(){if(0<this.uy.size){for(var[t,e]of this.uy)for(let t=0;t<e.length;t++)e[t].marker&&e[t].marker.parent&&e[t].marker.remove();this.uy.clear()}},by(){this.my=this.py.scatterPoints(this.Id,this.mi)},Ey(t){let e=this;if(this.st.getZoom()<this.J3){if(t){for(let t=0;t<this.Id.length;t++)this.Id[t].clustered=null;var i=this.Sy();this.vy=this.Ay(this.Ty(this.Id,this.my,i))}null!==this.vy&&(!s()||this.sy?(i=this.lM(this.vy),this.Ry(i)):this.Ly(this.st.getZoom(),t))}else!s()||this.sy?(i=this.lM(this.Id),this.Ry(i)):this.Ly("other",t);if(this.sy){let e=[],i=this.h0;i===this.st.getMapOptions().buildingID&&(i=null),this._y.forEach(t=>{e.push({x:t.marker.x,y:t.marker.y,level:this.Tr,buildingID:i,isCluster:"multiple"===t.type,points:t.points||[]})}),Pr.compareArrays(this.wy,e)||(this.wy=e,this.sy(e))}function s(){return e.ly&&e.hy}},Ly(t){for(var[e,i]of this.uy)if(""+t!=""+e)for(let t=0;t<i.length;t++)null!==i[t].marker&&(i[t].marker.visible=!1);let s=this.uy.get(""+t);if(!s||0===s.length){s=[];let i=this.vy;""+t=="other"&&(i=this.Id);for(let e=0;e<i.length;e++){let t=i[e].num;void 0===t&&(t=1),s.push({markers:i[e].markers,num:t,marker:null,x:i[e].x,y:i[e].y})}this.uy.set(""+t,s)}this.Cy(s)},lM(e){var i=[];for(let t=0;t<e.length;t++)this.mM(e[t])&&i.push(e[t]);return i},Cy(i){for(let e=0;e<i.length;e++)if(this.mM(i[e]))if(null===i[e].marker)if(1<i[e].num){var s={marker:null,count:i[e].num,x:i[e].x,y:i[e].y};this.hy(s),null!==s.marker?(i[e].marker=s.marker,i[e].marker.clusterPoints=i[e].markers,i[e].marker.parent||(s=this.Vs(i[e].marker.type),i[e].marker.addTo(s)),i[e].marker.getRenderNode()&&!i[e].marker.getRenderNode().visible&&(i[e].marker.getRenderNode().visible=!0)):((s=this.Ny(i[e],this.Iy(i[e].num))).getRenderNode().point=i[e],i[e].marker=s,r=this.Vs(s.type),s.addTo(r))}else{let t=null;t=this.oy&&(s={x:i[e].x,y:i[e].y},this.oy(s),t=s.marker)||new fE({url:this.My,collision:!1,x:i[e].x,y:i[e].y}),i[e].marker=t;var r=this.Vs(t.type);t.addTo(r)}else i[e].marker.visible=!0;else null!==i[e].marker&&(i[e].marker.visible=!1)},Ry(s){let r=this;if(0===this._y.length)for(let t=0;t<s.length;t++)this.Py(s[t]);else{var e=[],i=[];for(let t=0;t<s.length;t++){var n,a=l(s[t]);null!==a&&((n=this._y[a]).marker.moveTo({x:s[t].x,y:s[t].y}),n.marker.getRenderNode().point=s[t],n.points=s[t].markers,e.push(n),this._y.splice(a,1),i.push(t),"multiple"===n.type)&&this.hy&&(a={marker:n.marker,count:s[t].num},this.hy(a))}s=t(i);for(let t=i.length=0;t<s.length&&0!==this._y.length;t++){var h,o=l(s[t],!0);null!==o&&((o=this._y.splice(o,1)[0]).marker.moveTo({x:s[t].x,y:s[t].y}),"multiple"===o.type&&(o.marker.getRenderNode().point=s[t],o.points=s[t].markers,o.num=s[t].num,this.hy?(o.marker.content="<div></div>",h={marker:o.marker,count:s[t].num},this.hy(h)):o.marker.content=this.Iy(s[t].num)),i.push(t),e.push(o))}s=t(i);for(let t=i.length=0;t<s.length;t++)this.Py(s[t],e);for(let t=0;t<this._y.length;t++)this._y[t].marker.remove();this._y.length=0,this._y=e}function l(e,i){let s=null;for(let t=0;t<r._y.length;t++)if(void 0===e.num||1===e.num){if("single"===r._y[t].type){if(!r.oy){s=t;break}if(r._y[t].marker.x===e.x&&r._y[t].marker.y===e.y){s=t;break}}}else if(i){if("multiple"===r._y[t].type){s=t;break}}else if(r._y[t].num===e.num){s=t;break}return s}function t(e){var i=[];for(let t=0;t<s.length;t++)((e,i)=>{let s=!0;for(let t=0;t<e.length;t++)if(e[t]===i){s=!1;break}return s})(e,t)&&i.push(s[t]);return i}},Iy(t){let e=null;return e=void 0===this.DM?'<div style="background: rgba(73,102,245,0.8);height: 50px;width: 50px;border: 2px solid #3F5BC0;border-radius: 25px;box-shadow: rgb(255, 204, 204) 0px 0px 5px;line-height: 50px;color: rgb(255, 255, 255);font-size: 14px;text-align: center;">'+t+"</div>":this.DM.replace("${num}",""+t)},Py(e,i){if(1<e.num)this.hy?(r={marker:s=this.Ny(e,"<div></div>"),count:e.num},this.hy(r),(i||this._y).push({points:e.markers,type:"multiple",num:e.num,marker:s})):(r=this.Ny(e,this.Iy(e.num)),(i||this._y).push({points:e.markers,type:"multiple",num:e.num,marker:r}));else{let t=null;t=this.oy&&(s={x:e.x,y:e.y},this.oy(s),t=s.marker)||new fE({url:this.My,collision:!1,x:e.x,y:e.y});var s,r=this.Vs(t.type);t.addTo(r),(i||this._y).push({type:"single",num:e.num,marker:t})}},Ny(t,e){let i=new nt.FMDomMarker({map:this.st,x:t.x,y:t.y,collision:!1,anchor:Ir.BOTTOM,content:e});e=this.Vs(i.type);return i.addTo(e),i.getRenderNode().point=t,nt.environment==I.BROWSER&&(i.getRenderNode().element.addEventListener("mousedown",t=>{this.O=(new Date).getTime()}),i.getRenderNode().element.addEventListener("mouseup",t=>{if(!(200<(new Date).getTime()-this.O)){let t=this.h0;t===this.st.getMapOptions().buildingID&&(t=null);var e=i.getRenderNode().point;this.Yt.Xt({type:"click",buildingID:t,coords:{x:e.x,y:e.y},level:this.Tr,target:i,markers:s(e.markers)})}}),i.getRenderNode().element.addEventListener("touchstart",t=>{this.O=(new Date).getTime()}),i.getRenderNode().element.addEventListener("touchend",t=>{if(!(200<(new Date).getTime()-this.O)){let t=this.h0;t===this.st.getMapOptions().buildingID&&(t=null);var e=i.getRenderNode().point;this.Yt.Xt({type:"click",buildingID:t,coords:{x:e.x,y:e.y},level:this.Tr,target:i,markers:s(e.markers)})}})),i;function s(e){var i=[];for(let t=0;t<e.length;t++){var s,r={};for(s in e[t])r[s]=e[t][s];i.push(r)}return i}},Sy(){var t={x:nt.document.body.clientWidth/2,y:nt.document.body.clientHeight/2},e={x:t.x+this.ny,y:t.y},t=aa.coordsScreenToMap(this.st,t),e=aa.coordsScreenToMap(this.st,e);return Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))},Ty(e,i,s){var r=[];for(let t=0;t<e.length;t++){var n=e[t];if(!n.clustered){let t=i.query(new XE(n.x-s/2,n.y-s/2,s,s));if(0!=(t=t.filter(function(t){return!0!==t.clustered})).length){for(var a of t)a.clustered=!0;r.push(t)}}}return r},Ay(r){var t=[];for(let s=0;s<r.length;s++){let e=0,i=0;var n=r[s].length;if(!(n<=0)){var a=r[s][0].level,h=r[s][0].buildingID;for(let t=0;t<n;t++)e+=r[s][t].x,i+=r[s][t].y;t.push({x:e/n,y:i/n,level:a,buildingID:h,num:n,markers:r[s]})}}return t},gy(t){var e=t.targets;let i=null;for(let t=0;t<e.length;t++)if(e[t].clusterPoints){i=e[t];break}if(null!==i){let t=this.h0;t===this.st.getMapOptions().buildingID&&(t=null),this.Yt.Xt({type:"click",buildingID:t,coords:{x:i.x,y:i.y},level:this.Tr,target:i,markers:(e=>{var i=[];for(let t=0;t<e.length;t++){var s,r={};for(s in e[t])r[s]=e[t][s];i.push(r)}return i})(i.clusterPoints)})}},M_(e){if(this.pM()){let t=!1;"zoom"===e.type&&(t=!0),this.Ey(t)}},pM(){let e=!1;var i=Array.from(this.st.getRenderManager().getRenderList().keys());for(let t=0;t<i.length;t++){var s=i[t].split("%A%B%C%D");if(""+s[0]==""+this.h0&&""+s[1]==""+this.Tr){e=!0;break}}return e},mM(t){var e=this.Vs(),e=new Gt(t.x-this.st.x,e.height,this.st.y-t.y),t=this.st.camera,e=e.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix);return!(1<Math.abs(e.x)||1<Math.abs(e.y))},xy(){!function e(i){i.points.length=0;for(let t=0;t<i.nodes.length;t++)e(i.nodes[t]),delete i.nodes[t];i.nodes.length=0}(this.my)},Vs(t){return""+t==""+p.LOCATION_MARKER?this.st:this.st.getBuilding(this.h0).getFloor(this.Tr)},V(){this.st.getBuilding(this.h0).getFloor(this.Tr)&&(this.Bu(),this.st.off("update",this.V))}});let KE={uLayer:{value:0},uPrevDepthTexture:{value:null},uScreenSize:{value:new ct(1,1)},uDepthPeel:{value:1},uDepthOffset:{value:1e-5}},JE=`
varying vec2 vUv;
void main(){
  vUv = uv;
  gl_Position = vec4(position.xy, 0., 1.);
}
`;function $E(){return new zh({uniforms:{uTextureA:{value:null},uTextureB:{value:null},uBlit:{value:0}},vertexShader:JE,fragmentShader:`
          varying vec2 vUv;
          uniform sampler2D uTextureA;
          uniform sampler2D uTextureB;

          void main(){
            vec4 src = texture2D(uTextureA, vUv);
            vec4 dst = texture2D(uTextureB, vUv);

            float a1 = 1.-src.a;
            gl_FragColor.a = src.a + a1 * dst.a;
            gl_FragColor.rgb = src.rgb + a1 * dst.rgb;
            gl_FragColor.rgb /= gl_FragColor.a;
          }
        `,transparent:!0,depthTest:!1,depthWrite:!1})}function QE(t){t.fragmentShader=t.fragmentShader.replace("#include <packing>",""),t.fragmentShader=`
					#include <packing>

					${t.fragmentShader}
				`,tx(t),t.fragmentShader=t.fragmentShader.replace(/}(\s*)$/g,`
    if(uDepthPeel != 0) {
      #ifdef STANDARD
        gl_FragColor.a = diffuseColor.a;
      #else
        gl_FragColor.a = opacity;
      #endif
      gl_FragColor.rgb *= gl_FragColor.a;
    }
  }
  `)}function tx(t){t.uniforms.uScreenSize=KE.uScreenSize,t.uniforms.uPrevDepthTexture=KE.uPrevDepthTexture,t.uniforms.uLayer=KE.uLayer,t.uniforms.uDepthOffset=KE.uDepthOffset,t.uniforms.uDepthPeel=KE.uDepthPeel,t.vertexShader=t.vertexShader.replace("void main() {",`
    varying vec2 vFMHighPrecisionZW;
    void main() {`),t.vertexShader=t.vertexShader.replace(/}$/gm,`
    vFMHighPrecisionZW = gl_Position.zw;
  }
  `),t.fragmentShader=`
					uniform vec2 uScreenSize;
					uniform sampler2D uPrevDepthTexture;
					uniform int uLayer;
					uniform int uDepthPeel;
					uniform float uDepthOffset;
          varying vec2 vFMHighPrecisionZW;
					${t.fragmentShader}
				`,t.fragmentShader=t.fragmentShader.replace(/}(\s*)$/g,`
  if(uDepthPeel == 0) return;

  if(uLayer != 0 ){
    vec2 screenPos = gl_FragCoord.xy * uScreenSize;
    float prevDepth = unpackRGBAToDepth(texture2D(uPrevDepthTexture, screenPos));
    float fragCoordZ = 0.5 * vFMHighPrecisionZW[0] / vFMHighPrecisionZW[1] + 0.5;
    if(prevDepth + uDepthOffset - fragCoordZ >= 0. ){
      discard;
    }
  }
}`)}class ex{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}let ix=new sr(-1,1,1,-1,0,1);class sx extends Nh{constructor(){super(),this.setAttribute("position",new ph([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new ph([0,2,0,0,2,0],2))}}let rx=new sx;class nx{constructor(t){this.Dy=new L(rx,t)}dispose(){this.Dy.geometry.dispose()}render(t){t.render(this.Dy,ix)}get material(){return this.Dy.material}set material(t){this.Dy.material=t}}class ax extends ex{constructor(t={}){super();var{scene:t,camera:e,renderer:i,samples:s,layers:r,mode:n,w:a,h,type:o}=t;this.un=i,this.xa=t,this.ct=e,this.Oy=s??4,this.Uy=n,this.Ai=o,this.Fy=null,this.By=[],this.ky=r??2,this.Gy=new ct(a,h),this.Hy=$E(),this.Vy=new g0,this.Vy.depthPacking=Mi,this.Vy.onBeforeCompile=tx,this.zy=new nx(this.Hy),this.clearDepth=!1,this.needsSwap=!1,this.Wy=new Map,this.jh=!0,this.initTargets()}set enable(t){(this.jh=t)?(KE.uDepthPeel.value=1,this.Wy.forEach(t=>{t=t.mesh;void 0!==t.material.userData.transparent&&(t.material.transparent=t.material.userData.transparent)})):(KE.uDepthPeel.value=0,this.restoreState()),this.Wy.clear()}get enable(){return this.jh}restoreState(){this.Wy.forEach(t=>{t=t.mesh;t.material&&(t.material.transparent=t.material.userData.transparent,delete t.userData.transparent,t.material.needsUpdate=!0)}),this.Wy.clear()}initTargets(){var e=this.Gy;for(let t=0;t<5;t++){2<=t&&this.Oy;var i=Ic,s=new i(e.x,e.y,{minFilter:Jt,magFilter:Jt,type:le,format:ge,colorSpace:Hr,depthBuffer:!0});i===Ic&&(s.samples=this.Oy),this.By.push(s)}}setSize(){var e=new ct;this.un.getDrawingBufferSize(e);for(let t=0;t<5;t++)this.By[t].setSize(e.x,e.y);this.Gy.x=e.x,this.Gy.y=e.y,KE.uScreenSize.value.set(1/e.x,1/e.y)}dispose(){for(let t=0;t<5;t++)this.By[t].dispose()}clearTarget(t,e,i){t.setRenderTarget(e),t.setClearColor(i[0],i[1]),t.clear()}clearAllTarget(t,e){var i=this.By,s=t.getClearColor(new Wt),r=t.getClearAlpha();this.clearTarget(t,i[0],[16777215,1]),this.clearTarget(t,i[1],[16777215,1]),this.clearTarget(t,i[2],[0,0]),this.clearTarget(t,i[3],[0,0]),this.clearTarget(t,e,[s,r])}jy(t){let i={model:p.MODEL_LAYER,extent:p.EXTENT_LAYER,externalModel:p.EXTERNAL_MODEL_LAYER,dynamicModel:p.DYNAMIC_MODEL_MARKER};t.children.forEach(t=>{let e=this.Ai.includes(i[t.name]);t.traverse(t=>{"Mesh"==t.type&&(void 0===t.material.userData.transparent&&(t.material.userData.transparent=t.material.transparent),e)&&t.visible&&0===t.renderOrder&&(t.material.transparent=!1,this.Wy.has(t.uuid)||this.Wy.set(t.uuid,{mesh:t,onBeforeCompile:t.material.onBeforeCompile}),t.material.onBeforeCompile=QE,t.material.needsUpdate=!0)})})}render(e,t,i){this.clearAllTarget(e,i);var s=e.getClearColor(new Wt).getHex(),r=e.getClearAlpha(),{xa:n,ct:a,ky:h,By:o,Vy:l,Hy:u}=this,c=(e.setRenderTarget(i),e.setClearColor(s,r),e.clear(),e.render(n,a),KE.uLayer.value=0,n.overrideMaterial=l,e.setRenderTarget(o[0]),e.setClearColor(16777215,1),e.clear(),e.render(n,a),n.overrideMaterial=null,e.setRenderTarget(o[2]),e.setClearColor(0,0),e.clear(),e.render(n,a),{0:2,1:4,2:3}),f={0:3,1:2,2:4},d={0:4,1:3,2:2};for(let t=0;t<h;t++){var v=t%2,p=(t+1)%2,m=c[t%3],g=f[t%3],_=d[t%3];KE.uPrevDepthTexture.value=o[v].texture,KE.uLayer.value=t+1,n.overrideMaterial=l,e.setRenderTarget(o[p]),e.setClearColor(16777215,1),e.clear(),e.render(n,a),n.overrideMaterial=null,e.setRenderTarget(o[g]),e.setClearColor(0,0),e.clear(),e.render(n,a),u.uniforms.uTextureA.value=o[m].texture,u.uniforms.uTextureB.value=o[g].texture,e.setRenderTarget(o[_]),e.setClearColor(0,0),e.clear(),this.zy.render(e)}KE.uPrevDepthTexture.value=null,e.setRenderTarget(this.Fy),this.zy.render(e),e.setClearColor(s,r),this.Fy&&this.Fy.depthTexture&&(i=this.Fy.texture,e.setRenderTarget(this.Fy),e.render(n,a),this.Fy.texture=i)}setPass(t,e){t&&(this.xa=t),e&&(this.ct=e)}}class hx{constructor(t={}){this.Xy=new F3,this.eh=t;var{renderManager:e,map:i}=this.eh,s={minFilter:V,magFilter:V,format:ge,stencilBuffer:!1,colorSpace:Hr},r=e.renderer.domElement.parentElement.clientWidth*e.renderer.getPixelRatio(),n=e.renderer.domElement.parentElement.clientHeight*e.renderer.getPixelRatio();this.Yy=new Ic(r,n,s),this.ct=i.camera,this.un=e.renderer,this.state=this.un.state,this.Zy=new ax({w:r,h:n,scene:this.Xy,camera:i.camera,renderer:e.renderer,layers:t.layers,mode:t.mode,type:t.type}),this.Zy.setSize(),this.handleResize=this.handleResize.bind(this),this.handleViewChange=this.handleViewChange.bind(this),this.handleViewModeChanged=this.handleViewModeChanged.bind(this),this.jh=!0,this.qy=-1,i.on("resize",this.handleResize),i.on("viewChanged",this.handleViewChange),i.on("viewModeChanged",this.handleViewModeChanged)}set enable(t){this.jh=t,this.Zy.enable=t,this.Xy.children.length=0}get enable(){return this.jh}set autoClear(t){this.un.autoClear=t}get autoClear(){return this.un.autoClear}get domElement(){return this.un.domElement}get toneMapping(){return this.un.toneMapping}set toneMapping(t){this.un.toneMapping=t}clear(t,e,i){this.un.clear(t,e,i)}getSize(t){return this.un.getSize(t)}getPixelRatio(){return this.un.getPixelRatio()}setRenderTarget(t){this.Zy.Fy=t,this.un.setRenderTarget(t)}getRenderTarget(){return this.un.getRenderTarget()}setSize(t,e){this.un.setSize(t,e)}getClearColor(t){return this.un.getClearColor(t)}setClearColor(t,e){return this.un.setClearColor(t,e)}getClearAlpha(){return this.un.getClearAlpha()}setClearAlpha(t){this.un.setClearAlpha(t)}getContext(){return this.un.getContext()}handleViewModeChanged(){this.Zy.setPass(void 0,this.eh.map.camera)}handleViewChange(){this.eh.mode!=rE.RUNTIME&&(this.enable=!1,clearTimeout(this.qy),this.qy=setTimeout(()=>{this.enable=!0,this.eh.map.enableUpdateRender()},500))}handleResize(){this.Zy.setSize()}render(t,e){let i=this.eh.renderManager;if("basic"!==i.type&&i.rn.forEach(t=>{t.effectScene&&(t.effectScene.add(t),t.effectScene=null)}),t)return this.Zy.enable&&"Mesh"!==t.type&&!t.overrideMaterial?(this.Zy.setPass(t,e),void this.Zy.render(this.un,null,this.Yy)):void this.un.render(t,e);let s=!1,r=[];this.jh?(this.Xy.children.length=0,i.rn.forEach(t=>{"model"===t.name||"extent"==t.name||"externalModel"==t.name||"dynamicModel"==t.name?(("externalModel"!==t.name||"externalModel"===t.name&&s)&&this.Ky(t,!1),"externalModel"!==t.name||s||(s=!0,t.traverse(t=>{"PointLight"===t.type&&r.push(t),"Mesh"===t.type&&(t.userData.resetLight=!0)})),"model"!==t.name&&"extent"!==t.name||t.traverse(t=>{"Mesh"===t.type&&(t.userData.resetLight=!0,t.onBeforeRender=()=>{r.forEach(t=>{t.userData.intensity=t.intensity,t.intensity=0})},t.onAfterRender=()=>{r.forEach(t=>{t.intensity=t.userData.intensity,delete t.userData.intensity})})})):this.Ky(t,!1),void 0===t.effectScene&&(t.effectScene=t.parent),this.Xy.add(t)}),this.Zy.setPass(this.Xy,this.ct),this.Zy.render(this.un,null,this.Yy),i.renderer.setRenderTarget(null),i.rn.forEach(t=>{"model"!==t.name&&"externalModel"!==t.name&&"extent"!==t.name&&"dynamicModel"!==t.name&&i.renderer.render(t,i.st.ct)})):i.rn.forEach(t=>{"externalModel"!==t.name&&this.Ky(t,!0),i.renderer.render(t,i.st.ct)})}}Object.assign(hx.prototype,{Ky(t,e){0<t.children.length&&("DirectionalLight"===t.children[0].type||"AmbientLight"===t.children[0].type)&&(t.children[0].visible=e,t.children[1].visible=e,t.children[2].visible=e)}});let ox={WHITE:new Wt(16777215),BLACK:new Wt(0),TRANSPARENT:new Wt(0,0,0,0)},lx=(t,e)=>e?(e.copy(t),e):t.clone(),ux=(t,e)=>t.equals(e),cx={clone:lx,equals:ux,ZERO:new ct(0,0)},fx={clone:lx,equals:ux,ZERO:new Gt(0,0)};function g(t,e){return null!=t?t:e}g.EMPTY_OBJECT=Object.freeze({});let dx={CENTER:0,BOTTOM:1,BASELINE:2,TOP:-1};var vx=Object.freeze(dx);let px={CENTER:0,LEFT:1,RIGHT:-1};var mx=Object.freeze(px);function gx(t){var e=t.Jy;C(e)&&(e.$y(t),t.wg=!0)}class _x{constructor(t,e){this.Jy=e,this.Qy=new ct(0,0),this.tE=fx.clone(g(t.eyeOffset,fx.ZERO)),this.eE=g(t.verticalOrigin,vx.CENTER),this.iE=g(t.horizontalOrigin,mx.CENTER),this.wM=g(t.scale,1)}get horizontalOrigin(){return this.iE}set horizontalOrigin(t){this.iE=t}get verticalOrigin(){return this.eE}set verticalOrigin(t){this.eE=t}get image(){return this.sE}set image(t){this.setImage(t,t)}setImage(t,e){this.rE=-1,this.nE=void 0,this.sE=t,this.aE=e,C(this.Jy.hE)&&this.C_()}}function m(t){this.name="DeveloperError",this.message=t;let e;try{throw new Error}catch(t){e=t.stack}this.stack=e}Object.assign(_x.prototype,{C_(){let i=this.Jy.hE,s=this.sE,r=this.aE,t;C(r)&&(t=i.addImage(s,r)),C(this.oE=t)&&t.then(t=>{var e;this.sE===s&&this.aE===r&&(e=i.textureCoordinates[t],this.lE=i.texture.width*e.width,this.uE=i.texture.height*e.height,this.rE=t,this.cE=!0,this.aE=void 0,this.oE=void 0,gx(this))}).catch(t=>{console.error("Error loading image for billboard: "+t),this.oE=void 0})},fE(t){var e=this.Qy;cx.equals(e,t)||cx.clone(t,e)}}),C(Object.create)&&(m.prototype=Object.create(Error.prototype),m.prototype.constructor=m),m.prototype.toString=function(){let t=this.name+": "+this.message;return C(this.stack)&&(t+=`
`+this.stack.toString()),t},m.throwInstantiationError=function(){throw new m("This function defines an interface and should not be called directly.")};let k={};function Mx(t){return t+" is required, actual value was undefined"}function yx(t,e,i){return`Expected ${i} to be typeof ${e}, actual typeof was `+t}k.typeOf={},k.defined=function(t,e){if(!C(e))throw new m(Mx(t))},k.typeOf.func=function(t,e){if("function"!=typeof e)throw new m(yx(typeof e,"function",t))},k.typeOf.string=function(t,e){if("string"!=typeof e)throw new m(yx(typeof e,"string",t))},k.typeOf.number=function(t,e){if("number"!=typeof e)throw new m(yx(typeof e,"number",t))},k.typeOf.number.lessThan=function(t,e,i){if(k.typeOf.number(t,e),i<=e)throw new m(`Expected ${t} to be less than ${i}, actual value was `+e)},k.typeOf.number.lessThanOrEquals=function(t,e,i){if(k.typeOf.number(t,e),i<e)throw new m(`Expected ${t} to be less than or equal to ${i}, actual value was `+e)},k.typeOf.number.greaterThan=function(t,e,i){if(k.typeOf.number(t,e),e<=i)throw new m(`Expected ${t} to be greater than ${i}, actual value was `+e)},k.typeOf.number.greaterThanOrEquals=function(t,e,i){if(k.typeOf.number(t,e),e<i)throw new m(`Expected ${t} to be greater than or equal to ${i}, actual value was `+e)},k.typeOf.object=function(t,e){if("object"!=typeof e)throw new m(yx(typeof e,"object",t))},k.typeOf.bool=function(t,e){if("boolean"!=typeof e)throw new m(yx(typeof e,"boolean",t))},k.typeOf.bigint=function(t,e){if("bigint"!=typeof e)throw new m(yx(typeof e,"bigint",t))},k.typeOf.number.equals=function(t,e,i,s){if(k.typeOf.number(t,i),k.typeOf.number(e,s),i!==s)throw new m(t+` must be equal to ${e}, the actual values are ${i} and `+s)};let Ex=Math.PI/180;class H{static equalsEpsilon(t,e,i,s){if(!C(t))throw new m("left is required.");if(!C(e))throw new m("right is required.");i=g(i,0),s=g(s,i);var r=Math.abs(t-e);return r<=s||r<=i*Math.max(Math.abs(t),Math.abs(e))}static toRadians(t){if(C(t))return t*Ex;throw new m("degrees is required.")}}function w(t,e,i){this.x=g(t,0),this.y=g(e,0),this.z=g(i,0)}w.fromSpherical=function(t,e){k.typeOf.object("spherical",t),C(e)||(e=new w);var i=t.clock,s=t.cone,t=g(t.magnitude,1),r=t*Math.sin(s);return e.x=r*Math.cos(i),e.y=r*Math.sin(i),e.z=t*Math.cos(s),e},w.fromElements=function(t,e,i,s){return C(s)?(s.x=t,s.y=e,s.z=i,s):new w(t,e,i)},w.clone=function(t,e){if(C(t))return C(e)?(e.x=t.x,e.y=t.y,e.z=t.z,e):new w(t.x,t.y,t.z)},w.fromCartesian4=w.clone,w.packedLength=3,w.pack=function(t,e,i){return k.typeOf.object("value",t),k.defined("array",e),i=g(i,0),e[i++]=t.x,e[i++]=t.y,e[i]=t.z,e},w.unpack=function(t,e,i){return k.defined("array",t),e=g(e,0),(i=C(i)?i:new w).x=t[e++],i.y=t[e++],i.z=t[e],i},w.packArray=function(e,i){k.defined("array",e);var s=e.length,t=3*s;if(C(i)){if(!Array.isArray(i)&&i.length!==t)throw new m("If result is a typed array, it must have exactly array.length * 3 elements");i.length!==t&&(i.length=t)}else i=new Array(t);for(let t=0;t<s;++t)w.pack(e[t],i,3*t);return i},w.unpackArray=function(e,i){if(k.defined("array",e),k.typeOf.number.greaterThanOrEquals("array.length",e.length,3),e.length%3!=0)throw new m("array length must be a multiple of 3.");var s=e.length;C(i)?i.length=s/3:i=new Array(s/3);for(let t=0;t<s;t+=3){var r=t/3;i[r]=w.unpack(e,t,i[r])}return i},w.fromArray=w.unpack,w.maximumComponent=function(t){return k.typeOf.object("cartesian",t),Math.max(t.x,t.y,t.z)},w.minimumComponent=function(t){return k.typeOf.object("cartesian",t),Math.min(t.x,t.y,t.z)},w.minimumByComponent=function(t,e,i){return k.typeOf.object("first",t),k.typeOf.object("second",e),k.typeOf.object("result",i),i.x=Math.min(t.x,e.x),i.y=Math.min(t.y,e.y),i.z=Math.min(t.z,e.z),i},w.maximumByComponent=function(t,e,i){return k.typeOf.object("first",t),k.typeOf.object("second",e),k.typeOf.object("result",i),i.x=Math.max(t.x,e.x),i.y=Math.max(t.y,e.y),i.z=Math.max(t.z,e.z),i},w.clamp=function(t,e,i,s){k.typeOf.object("value",t),k.typeOf.object("min",e),k.typeOf.object("max",i),k.typeOf.object("result",s);var r=H.clamp(t.x,e.x,i.x),n=H.clamp(t.y,e.y,i.y),t=H.clamp(t.z,e.z,i.z);return s.x=r,s.y=n,s.z=t,s},w.magnitudeSquared=function(t){return k.typeOf.object("cartesian",t),t.x*t.x+t.y*t.y+t.z*t.z},w.magnitude=function(t){return Math.sqrt(w.magnitudeSquared(t))};let xx=new w,bx=(w.distance=function(t,e){return k.typeOf.object("left",t),k.typeOf.object("right",e),w.subtract(t,e,xx),w.magnitude(xx)},w.distanceSquared=function(t,e){return k.typeOf.object("left",t),k.typeOf.object("right",e),w.subtract(t,e,xx),w.magnitudeSquared(xx)},w.normalize=function(t,e){k.typeOf.object("cartesian",t),k.typeOf.object("result",e);var i=w.magnitude(t);if(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i,isNaN(e.x)||isNaN(e.y)||isNaN(e.z))throw new m("normalized result is not a number");return e},w.dot=function(t,e){return k.typeOf.object("left",t),k.typeOf.object("right",e),t.x*e.x+t.y*e.y+t.z*e.z},w.multiplyComponents=function(t,e,i){return k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i),i.x=t.x*e.x,i.y=t.y*e.y,i.z=t.z*e.z,i},w.divideComponents=function(t,e,i){return k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i),i.x=t.x/e.x,i.y=t.y/e.y,i.z=t.z/e.z,i},w.add=function(t,e,i){return k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i),i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i},w.subtract=function(t,e,i){return k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i),i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z,i},w.multiplyByScalar=function(t,e,i){return k.typeOf.object("cartesian",t),k.typeOf.number("scalar",e),k.typeOf.object("result",i),i.x=t.x*e,i.y=t.y*e,i.z=t.z*e,i},w.divideByScalar=function(t,e,i){return k.typeOf.object("cartesian",t),k.typeOf.number("scalar",e),k.typeOf.object("result",i),i.x=t.x/e,i.y=t.y/e,i.z=t.z/e,i},w.negate=function(t,e){return k.typeOf.object("cartesian",t),k.typeOf.object("result",e),e.x=-t.x,e.y=-t.y,e.z=-t.z,e},w.abs=function(t,e){return k.typeOf.object("cartesian",t),k.typeOf.object("result",e),e.x=Math.abs(t.x),e.y=Math.abs(t.y),e.z=Math.abs(t.z),e},new w),Sx=(w.lerp=function(t,e,i,s){return k.typeOf.object("start",t),k.typeOf.object("end",e),k.typeOf.number("t",i),k.typeOf.object("result",s),w.multiplyByScalar(e,i,bx),s=w.multiplyByScalar(t,1-i,s),w.add(bx,s,s)},new w),Ax=new w,Tx=(w.angleBetween=function(t,e){k.typeOf.object("left",t),k.typeOf.object("right",e),w.normalize(t,Sx),w.normalize(e,Ax);t=w.dot(Sx,Ax),e=w.magnitude(w.cross(Sx,Ax,Sx));return Math.atan2(e,t)},new w),Rx=(w.mostOrthogonalAxis=function(t,e){k.typeOf.object("cartesian",t),k.typeOf.object("result",e);t=w.normalize(t,Tx);return w.abs(t,t),e=t.x<=t.y?t.x<=t.z?w.clone(w.UNIT_X,e):w.clone(w.UNIT_Z,e):t.y<=t.z?w.clone(w.UNIT_Y,e):w.clone(w.UNIT_Z,e)},w.projectVector=function(t,e,i){k.defined("a",t),k.defined("b",e),k.defined("result",i);t=w.dot(t,e)/w.dot(e,e);return w.multiplyByScalar(e,t,i)},w.equals=function(t,e){return t===e||C(t)&&C(e)&&t.x===e.x&&t.y===e.y&&t.z===e.z},w.equalsArray=function(t,e,i){return t.x===e[i]&&t.y===e[i+1]&&t.z===e[i+2]},w.equalsEpsilon=function(t,e,i,s){return t===e||C(t)&&C(e)&&H.equalsEpsilon(t.x,e.x,i,s)&&H.equalsEpsilon(t.y,e.y,i,s)&&H.equalsEpsilon(t.z,e.z,i,s)},w.cross=function(t,e,i){k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i);var s=t.x,r=t.y,t=t.z,n=e.x,a=e.y,e=e.z,h=t*n-s*e,s=s*a-r*n;return i.x=r*e-t*a,i.y=h,i.z=s,i},w.midpoint=function(t,e,i){return k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i),i.x=.5*(t.x+e.x),i.y=.5*(t.y+e.y),i.z=.5*(t.z+e.z),i},w.fromDegrees=function(t,e,i,s,r){return k.typeOf.number("longitude",t),k.typeOf.number("latitude",e),t=H.toRadians(t),e=H.toRadians(e),w.fromRadians(t,e,i,s,r)},new w),Lx=new w,Cx=new w(40680631590769,40680631590769,40408299984661.445);function z(t,e,i,s){this.x=g(t,0),this.y=g(e,0),this.z=g(i,0),this.w=g(s,0)}w.fromRadians=function(t,e,i,s,r){k.typeOf.number("longitude",t),k.typeOf.number("latitude",e),i=g(i,0);var s=C(s)?s.radiiSquared:Cx,n=Math.cos(e),n=(Rx.x=n*Math.cos(t),Rx.y=n*Math.sin(t),Rx.z=Math.sin(e),Rx=w.normalize(Rx,Rx),w.multiplyComponents(s,Rx,Lx),Math.sqrt(w.dot(Rx,Lx)));return Lx=w.divideByScalar(Lx,n,Lx),Rx=w.multiplyByScalar(Rx,i,Rx),C(r)||(r=new w),w.add(Lx,Rx,r)},w.fromDegreesArray=function(e,i,s){if(k.defined("coordinates",e),e.length<2||e.length%2!=0)throw new m("the number of coordinates must be a multiple of 2 and at least 2");var r=e.length;C(s)?s.length=r/2:s=new Array(r/2);for(let t=0;t<r;t+=2){var n=e[t],a=e[t+1],h=t/2;s[h]=w.fromDegrees(n,a,0,i,s[h])}return s},w.fromRadiansArray=function(e,i,s){if(k.defined("coordinates",e),e.length<2||e.length%2!=0)throw new m("the number of coordinates must be a multiple of 2 and at least 2");var r=e.length;C(s)?s.length=r/2:s=new Array(r/2);for(let t=0;t<r;t+=2){var n=e[t],a=e[t+1],h=t/2;s[h]=w.fromRadians(n,a,0,i,s[h])}return s},w.fromDegreesArrayHeights=function(e,i,s){if(k.defined("coordinates",e),e.length<3||e.length%3!=0)throw new m("the number of coordinates must be a multiple of 3 and at least 3");var r=e.length;C(s)?s.length=r/3:s=new Array(r/3);for(let t=0;t<r;t+=3){var n=e[t],a=e[t+1],h=e[t+2],o=t/3;s[o]=w.fromDegrees(n,a,h,i,s[o])}return s},w.fromRadiansArrayHeights=function(e,i,s){if(k.defined("coordinates",e),e.length<3||e.length%3!=0)throw new m("the number of coordinates must be a multiple of 3 and at least 3");var r=e.length;C(s)?s.length=r/3:s=new Array(r/3);for(let t=0;t<r;t+=3){var n=e[t],a=e[t+1],h=e[t+2],o=t/3;s[o]=w.fromRadians(n,a,h,i,s[o])}return s},w.ZERO=Object.freeze(new w(0,0,0)),w.ONE=Object.freeze(new w(1,1,1)),w.UNIT_X=Object.freeze(new w(1,0,0)),w.UNIT_Y=Object.freeze(new w(0,1,0)),w.UNIT_Z=Object.freeze(new w(0,0,1)),w.prototype.clone=function(t){return w.clone(this,t)},w.prototype.equals=function(t){return w.equals(this,t)},w.prototype.equalsEpsilon=function(t,e,i){return w.equalsEpsilon(this,t,e,i)},w.prototype.toString=function(){return`(${this.x}, ${this.y}, ${this.z})`},z.fromElements=function(t,e,i,s,r){return C(r)?(r.x=t,r.y=e,r.z=i,r.w=s,r):new z(t,e,i,s)},z.fromColor=function(t,e){return k.typeOf.object("color",t),C(e)?(e.x=t.red,e.y=t.green,e.z=t.blue,e.w=t.alpha,e):new z(t.red,t.green,t.blue,t.alpha)},z.clone=function(t,e){if(C(t))return C(e)?(e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e):new z(t.x,t.y,t.z,t.w)},z.packedLength=4,z.pack=function(t,e,i){return k.typeOf.object("value",t),k.defined("array",e),i=g(i,0),e[i++]=t.x,e[i++]=t.y,e[i++]=t.z,e[i]=t.w,e},z.unpack=function(t,e,i){return k.defined("array",t),e=g(e,0),(i=C(i)?i:new z).x=t[e++],i.y=t[e++],i.z=t[e++],i.w=t[e],i},z.packArray=function(e,i){k.defined("array",e);var s=e.length,t=4*s;if(C(i)){if(!Array.isArray(i)&&i.length!==t)throw new m("If result is a typed array, it must have exactly array.length * 4 elements");i.length!==t&&(i.length=t)}else i=new Array(t);for(let t=0;t<s;++t)z.pack(e[t],i,4*t);return i},z.unpackArray=function(e,i){if(k.defined("array",e),k.typeOf.number.greaterThanOrEquals("array.length",e.length,4),e.length%4!=0)throw new m("array length must be a multiple of 4.");var s=e.length;C(i)?i.length=s/4:i=new Array(s/4);for(let t=0;t<s;t+=4){var r=t/4;i[r]=z.unpack(e,t,i[r])}return i},z.fromArray=z.unpack,z.maximumComponent=function(t){return k.typeOf.object("cartesian",t),Math.max(t.x,t.y,t.z,t.w)},z.minimumComponent=function(t){return k.typeOf.object("cartesian",t),Math.min(t.x,t.y,t.z,t.w)},z.minimumByComponent=function(t,e,i){return k.typeOf.object("first",t),k.typeOf.object("second",e),k.typeOf.object("result",i),i.x=Math.min(t.x,e.x),i.y=Math.min(t.y,e.y),i.z=Math.min(t.z,e.z),i.w=Math.min(t.w,e.w),i},z.maximumByComponent=function(t,e,i){return k.typeOf.object("first",t),k.typeOf.object("second",e),k.typeOf.object("result",i),i.x=Math.max(t.x,e.x),i.y=Math.max(t.y,e.y),i.z=Math.max(t.z,e.z),i.w=Math.max(t.w,e.w),i},z.clamp=function(t,e,i,s){k.typeOf.object("value",t),k.typeOf.object("min",e),k.typeOf.object("max",i),k.typeOf.object("result",s);var r=H.clamp(t.x,e.x,i.x),n=H.clamp(t.y,e.y,i.y),a=H.clamp(t.z,e.z,i.z),t=H.clamp(t.w,e.w,i.w);return s.x=r,s.y=n,s.z=a,s.w=t,s},z.magnitudeSquared=function(t){return k.typeOf.object("cartesian",t),t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w},z.magnitude=function(t){return Math.sqrt(z.magnitudeSquared(t))};let Nx=new z,Ix=(z.distance=function(t,e){return k.typeOf.object("left",t),k.typeOf.object("right",e),z.subtract(t,e,Nx),z.magnitude(Nx)},z.distanceSquared=function(t,e){return k.typeOf.object("left",t),k.typeOf.object("right",e),z.subtract(t,e,Nx),z.magnitudeSquared(Nx)},z.normalize=function(t,e){k.typeOf.object("cartesian",t),k.typeOf.object("result",e);var i=z.magnitude(t);if(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i,e.w=t.w/i,isNaN(e.x)||isNaN(e.y)||isNaN(e.z)||isNaN(e.w))throw new m("normalized result is not a number");return e},z.dot=function(t,e){return k.typeOf.object("left",t),k.typeOf.object("right",e),t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},z.multiplyComponents=function(t,e,i){return k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i),i.x=t.x*e.x,i.y=t.y*e.y,i.z=t.z*e.z,i.w=t.w*e.w,i},z.divideComponents=function(t,e,i){return k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i),i.x=t.x/e.x,i.y=t.y/e.y,i.z=t.z/e.z,i.w=t.w/e.w,i},z.add=function(t,e,i){return k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i),i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i.w=t.w+e.w,i},z.subtract=function(t,e,i){return k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i),i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z,i.w=t.w-e.w,i},z.multiplyByScalar=function(t,e,i){return k.typeOf.object("cartesian",t),k.typeOf.number("scalar",e),k.typeOf.object("result",i),i.x=t.x*e,i.y=t.y*e,i.z=t.z*e,i.w=t.w*e,i},z.divideByScalar=function(t,e,i){return k.typeOf.object("cartesian",t),k.typeOf.number("scalar",e),k.typeOf.object("result",i),i.x=t.x/e,i.y=t.y/e,i.z=t.z/e,i.w=t.w/e,i},z.negate=function(t,e){return k.typeOf.object("cartesian",t),k.typeOf.object("result",e),e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e},z.abs=function(t,e){return k.typeOf.object("cartesian",t),k.typeOf.object("result",e),e.x=Math.abs(t.x),e.y=Math.abs(t.y),e.z=Math.abs(t.z),e.w=Math.abs(t.w),e},new z),Px=(z.lerp=function(t,e,i,s){return k.typeOf.object("start",t),k.typeOf.object("end",e),k.typeOf.number("t",i),k.typeOf.object("result",s),z.multiplyByScalar(e,i,Ix),s=z.multiplyByScalar(t,1-i,s),z.add(Ix,s,s)},new z),Dx=(z.mostOrthogonalAxis=function(t,e){k.typeOf.object("cartesian",t),k.typeOf.object("result",e);t=z.normalize(t,Px);return z.abs(t,t),e=t.x<=t.y?t.x<=t.z?t.x<=t.w?z.clone(z.UNIT_X,e):z.clone(z.UNIT_W,e):t.z<=t.w?z.clone(z.UNIT_Z,e):z.clone(z.UNIT_W,e):t.y<=t.z?t.y<=t.w?z.clone(z.UNIT_Y,e):z.clone(z.UNIT_W,e):t.z<=t.w?z.clone(z.UNIT_Z,e):z.clone(z.UNIT_W,e)},z.equals=function(t,e){return t===e||C(t)&&C(e)&&t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},z.equalsArray=function(t,e,i){return t.x===e[i]&&t.y===e[i+1]&&t.z===e[i+2]&&t.w===e[i+3]},z.equalsEpsilon=function(t,e,i,s){return t===e||C(t)&&C(e)&&H.equalsEpsilon(t.x,e.x,i,s)&&H.equalsEpsilon(t.y,e.y,i,s)&&H.equalsEpsilon(t.z,e.z,i,s)&&H.equalsEpsilon(t.w,e.w,i,s)},z.ZERO=Object.freeze(new z(0,0,0,0)),z.ONE=Object.freeze(new z(1,1,1,1)),z.UNIT_X=Object.freeze(new z(1,0,0,0)),z.UNIT_Y=Object.freeze(new z(0,1,0,0)),z.UNIT_Z=Object.freeze(new z(0,0,1,0)),z.UNIT_W=Object.freeze(new z(0,0,0,1)),z.prototype.clone=function(t){return z.clone(this,t)},z.prototype.equals=function(t){return z.equals(this,t)},z.prototype.equalsEpsilon=function(t,e,i){return z.equalsEpsilon(this,t,e,i)},z.prototype.toString=function(){return`(${this.x}, ${this.y}, ${this.z}, ${this.w})`},new Float32Array(1)),Ox=new Uint8Array(Dx.buffer),Ux=new Uint32Array([287454020]),Fx=new Uint8Array(Ux.buffer),Bx=68===Fx[0];function W(t,e,i,s,r,n,a,h,o){this[0]=g(t,0),this[1]=g(s,0),this[2]=g(a,0),this[3]=g(e,0),this[4]=g(r,0),this[5]=g(h,0),this[6]=g(i,0),this[7]=g(n,0),this[8]=g(o,0)}z.packFloat=function(t,e){return k.typeOf.number("value",t),C(e)||(e=new z),Dx[0]=t,Bx?(e.x=Ox[0],e.y=Ox[1],e.z=Ox[2],e.w=Ox[3]):(e.x=Ox[3],e.y=Ox[2],e.z=Ox[1],e.w=Ox[0]),e},z.unpackFloat=function(t){return k.typeOf.object("packedFloat",t),Bx?(Ox[0]=t.x,Ox[1]=t.y,Ox[2]=t.z,Ox[3]=t.w):(Ox[0]=t.w,Ox[1]=t.z,Ox[2]=t.y,Ox[3]=t.x),Dx[0]},W.packedLength=9,W.pack=function(t,e,i){return k.typeOf.object("value",t),k.defined("array",e),i=g(i,0),e[i++]=t[0],e[i++]=t[1],e[i++]=t[2],e[i++]=t[3],e[i++]=t[4],e[i++]=t[5],e[i++]=t[6],e[i++]=t[7],e[i++]=t[8],e},W.unpack=function(t,e,i){return k.defined("array",t),e=g(e,0),(i=C(i)?i:new W)[0]=t[e++],i[1]=t[e++],i[2]=t[e++],i[3]=t[e++],i[4]=t[e++],i[5]=t[e++],i[6]=t[e++],i[7]=t[e++],i[8]=t[e++],i},W.packArray=function(e,i){k.defined("array",e);var s=e.length,t=9*s;if(C(i)){if(!Array.isArray(i)&&i.length!==t)throw new m("If result is a typed array, it must have exactly array.length * 9 elements");i.length!==t&&(i.length=t)}else i=new Array(t);for(let t=0;t<s;++t)W.pack(e[t],i,9*t);return i},W.unpackArray=function(e,i){if(k.defined("array",e),k.typeOf.number.greaterThanOrEquals("array.length",e.length,9),e.length%9!=0)throw new m("array length must be a multiple of 9.");var s=e.length;C(i)?i.length=s/9:i=new Array(s/9);for(let t=0;t<s;t+=9){var r=t/9;i[r]=W.unpack(e,t,i[r])}return i},W.clone=function(t,e){if(C(t))return C(e)?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e):new W(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8])},W.fromArray=W.unpack,W.fromColumnMajorArray=function(t,e){return k.defined("values",t),W.clone(t,e)},W.fromRowMajorArray=function(t,e){return k.defined("values",t),C(e)?(e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],e):new W(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},W.fromQuaternion=function(t,e){k.typeOf.object("quaternion",t);var i=t.x*t.x,s=t.x*t.y,r=t.x*t.z,n=t.x*t.w,a=t.y*t.y,h=t.y*t.z,o=t.y*t.w,l=t.z*t.z,u=t.z*t.w,t=t.w*t.w,c=i-a-l+t,f=2*(s-u),d=2*(r+o),s=2*(s+u),u=a-i-l+t,v=2*(h-n),r=2*(r-o),o=2*(h+n),h=-i-a+l+t;return C(e)?(e[0]=c,e[1]=s,e[2]=r,e[3]=f,e[4]=u,e[5]=o,e[6]=d,e[7]=v,e[8]=h,e):new W(c,f,d,s,u,v,r,o,h)},W.fromHeadingPitchRoll=function(t,e){k.typeOf.object("headingPitchRoll",t);var i=Math.cos(-t.pitch),s=Math.cos(-t.heading),r=Math.cos(t.roll),n=Math.sin(-t.pitch),a=Math.sin(-t.heading),t=Math.sin(t.roll),h=i*s,o=-r*a+t*n*s,l=t*a+r*n*s,u=i*a,c=r*s+t*n*a,s=-t*s+r*n*a,a=-n,n=t*i,t=r*i;return C(e)?(e[0]=h,e[1]=u,e[2]=a,e[3]=o,e[4]=c,e[5]=n,e[6]=l,e[7]=s,e[8]=t,e):new W(h,o,l,u,c,s,a,n,t)},W.fromScale=function(t,e){return k.typeOf.object("scale",t),C(e)?(e[0]=t.x,e[1]=0,e[2]=0,e[3]=0,e[4]=t.y,e[5]=0,e[6]=0,e[7]=0,e[8]=t.z,e):new W(t.x,0,0,0,t.y,0,0,0,t.z)},W.fromUniformScale=function(t,e){return k.typeOf.number("scale",t),C(e)?(e[0]=t,e[1]=0,e[2]=0,e[3]=0,e[4]=t,e[5]=0,e[6]=0,e[7]=0,e[8]=t,e):new W(t,0,0,0,t,0,0,0,t)},W.fromCrossProduct=function(t,e){return k.typeOf.object("vector",t),C(e)?(e[0]=0,e[1]=t.z,e[2]=-t.y,e[3]=-t.z,e[4]=0,e[5]=t.x,e[6]=t.y,e[7]=-t.x,e[8]=0,e):new W(0,-t.z,t.y,t.z,0,-t.x,-t.y,t.x,0)},W.fromRotationX=function(t,e){k.typeOf.number("angle",t);var i=Math.cos(t),t=Math.sin(t);return C(e)?(e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=i,e[5]=t,e[6]=0,e[7]=-t,e[8]=i,e):new W(1,0,0,0,i,-t,0,t,i)},W.fromRotationY=function(t,e){k.typeOf.number("angle",t);var i=Math.cos(t),t=Math.sin(t);return C(e)?(e[0]=i,e[1]=0,e[2]=-t,e[3]=0,e[4]=1,e[5]=0,e[6]=t,e[7]=0,e[8]=i,e):new W(i,0,t,0,1,0,-t,0,i)},W.fromRotationZ=function(t,e){k.typeOf.number("angle",t);var i=Math.cos(t),t=Math.sin(t);return C(e)?(e[0]=i,e[1]=t,e[2]=0,e[3]=-t,e[4]=i,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e):new W(i,-t,0,t,i,0,0,0,1)},W.toArray=function(t,e){return k.typeOf.object("matrix",t),C(e)?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e):[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]},W.getElementIndex=function(t,e){return k.typeOf.number.greaterThanOrEquals("row",e,0),k.typeOf.number.lessThanOrEquals("row",e,2),k.typeOf.number.greaterThanOrEquals("column",t,0),k.typeOf.number.lessThanOrEquals("column",t,2),3*t+e},W.getColumn=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.number.greaterThanOrEquals("index",e,0),k.typeOf.number.lessThanOrEquals("index",e,2),k.typeOf.object("result",i);var e=3*e,s=t[e],r=t[1+e],t=t[2+e];return i.x=s,i.y=r,i.z=t,i},W.setColumn=function(t,e,i,s){k.typeOf.object("matrix",t),k.typeOf.number.greaterThanOrEquals("index",e,0),k.typeOf.number.lessThanOrEquals("index",e,2),k.typeOf.object("cartesian",i),k.typeOf.object("result",s);e*=3;return(s=W.clone(t,s))[e]=i.x,s[1+e]=i.y,s[2+e]=i.z,s},W.getRow=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.number.greaterThanOrEquals("index",e,0),k.typeOf.number.lessThanOrEquals("index",e,2),k.typeOf.object("result",i);var s=t[e],r=t[e+3],t=t[e+6];return i.x=s,i.y=r,i.z=t,i},W.setRow=function(t,e,i,s){return k.typeOf.object("matrix",t),k.typeOf.number.greaterThanOrEquals("index",e,0),k.typeOf.number.lessThanOrEquals("index",e,2),k.typeOf.object("cartesian",i),k.typeOf.object("result",s),(s=W.clone(t,s))[e]=i.x,s[e+3]=i.y,s[e+6]=i.z,s};let kx=new w,Gx=(W.setScale=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.object("scale",e),k.typeOf.object("result",i);var s=W.getScale(t,kx),r=e.x/s.x,n=e.y/s.y,e=e.z/s.z;return i[0]=t[0]*r,i[1]=t[1]*r,i[2]=t[2]*r,i[3]=t[3]*n,i[4]=t[4]*n,i[5]=t[5]*n,i[6]=t[6]*e,i[7]=t[7]*e,i[8]=t[8]*e,i},new w),Hx=(W.setUniformScale=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.number("scale",e),k.typeOf.object("result",i);var s=W.getScale(t,Gx),r=e/s.x,n=e/s.y,e=e/s.z;return i[0]=t[0]*r,i[1]=t[1]*r,i[2]=t[2]*r,i[3]=t[3]*n,i[4]=t[4]*n,i[5]=t[5]*n,i[6]=t[6]*e,i[7]=t[7]*e,i[8]=t[8]*e,i},new w),Vx=(W.getScale=function(t,e){return k.typeOf.object("matrix",t),k.typeOf.object("result",e),e.x=w.magnitude(w.fromElements(t[0],t[1],t[2],Hx)),e.y=w.magnitude(w.fromElements(t[3],t[4],t[5],Hx)),e.z=w.magnitude(w.fromElements(t[6],t[7],t[8],Hx)),e},new w),zx=(W.getMaximumScale=function(t){return W.getScale(t,Vx),w.maximumComponent(Vx)},new w),Wx=(W.setRotation=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.object("result",i);t=W.getScale(t,zx);return i[0]=e[0]*t.x,i[1]=e[1]*t.x,i[2]=e[2]*t.x,i[3]=e[3]*t.y,i[4]=e[4]*t.y,i[5]=e[5]*t.y,i[6]=e[6]*t.z,i[7]=e[7]*t.z,i[8]=e[8]*t.z,i},new w);function jx(e){let i=0;for(let t=0;t<9;++t){var s=e[t];i+=s*s}return Math.sqrt(i)}W.getRotation=function(t,e){k.typeOf.object("matrix",t),k.typeOf.object("result",e);var i=W.getScale(t,Wx);return e[0]=t[0]/i.x,e[1]=t[1]/i.x,e[2]=t[2]/i.x,e[3]=t[3]/i.y,e[4]=t[4]/i.y,e[5]=t[5]/i.y,e[6]=t[6]/i.z,e[7]=t[7]/i.z,e[8]=t[8]/i.z,e},W.multiply=function(t,e,i){k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i);var s=t[0]*e[0]+t[3]*e[1]+t[6]*e[2],r=t[1]*e[0]+t[4]*e[1]+t[7]*e[2],n=t[2]*e[0]+t[5]*e[1]+t[8]*e[2],a=t[0]*e[3]+t[3]*e[4]+t[6]*e[5],h=t[1]*e[3]+t[4]*e[4]+t[7]*e[5],o=t[2]*e[3]+t[5]*e[4]+t[8]*e[5],l=t[0]*e[6]+t[3]*e[7]+t[6]*e[8],u=t[1]*e[6]+t[4]*e[7]+t[7]*e[8],t=t[2]*e[6]+t[5]*e[7]+t[8]*e[8];return i[0]=s,i[1]=r,i[2]=n,i[3]=a,i[4]=h,i[5]=o,i[6]=l,i[7]=u,i[8]=t,i},W.add=function(t,e,i){return k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i[4]=t[4]+e[4],i[5]=t[5]+e[5],i[6]=t[6]+e[6],i[7]=t[7]+e[7],i[8]=t[8]+e[8],i},W.subtract=function(t,e,i){return k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i[3]=t[3]-e[3],i[4]=t[4]-e[4],i[5]=t[5]-e[5],i[6]=t[6]-e[6],i[7]=t[7]-e[7],i[8]=t[8]-e[8],i},W.multiplyByVector=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.object("cartesian",e),k.typeOf.object("result",i);var s=e.x,r=e.y,e=e.z,n=t[0]*s+t[3]*r+t[6]*e,a=t[1]*s+t[4]*r+t[7]*e,s=t[2]*s+t[5]*r+t[8]*e;return i.x=n,i.y=a,i.z=s,i},W.multiplyByScalar=function(t,e,i){return k.typeOf.object("matrix",t),k.typeOf.number("scalar",e),k.typeOf.object("result",i),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i[4]=t[4]*e,i[5]=t[5]*e,i[6]=t[6]*e,i[7]=t[7]*e,i[8]=t[8]*e,i},W.multiplyByScale=function(t,e,i){return k.typeOf.object("matrix",t),k.typeOf.object("scale",e),k.typeOf.object("result",i),i[0]=t[0]*e.x,i[1]=t[1]*e.x,i[2]=t[2]*e.x,i[3]=t[3]*e.y,i[4]=t[4]*e.y,i[5]=t[5]*e.y,i[6]=t[6]*e.z,i[7]=t[7]*e.z,i[8]=t[8]*e.z,i},W.multiplyByUniformScale=function(t,e,i){return k.typeOf.object("matrix",t),k.typeOf.number("scale",e),k.typeOf.object("result",i),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i[4]=t[4]*e,i[5]=t[5]*e,i[6]=t[6]*e,i[7]=t[7]*e,i[8]=t[8]*e,i},W.negate=function(t,e){return k.typeOf.object("matrix",t),k.typeOf.object("result",e),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e},W.transpose=function(t,e){k.typeOf.object("matrix",t),k.typeOf.object("result",e);var i=t[0],s=t[3],r=t[6],n=t[1],a=t[4],h=t[7],o=t[2],l=t[5],t=t[8];return e[0]=i,e[1]=s,e[2]=r,e[3]=n,e[4]=a,e[5]=h,e[6]=o,e[7]=l,e[8]=t,e};let Xx=[1,0,0],Yx=[2,2,1];function Zx(e){let i=0;for(let t=0;t<3;++t){var s=e[W.getElementIndex(Yx[t],Xx[t])];i+=2*s*s}return Math.sqrt(i)}function qx(e,t){var i=H.EPSILON15;let s=0,r=1;for(let t=0;t<3;++t){var n=Math.abs(e[W.getElementIndex(Yx[t],Xx[t])]);n>s&&(r=t,s=n)}let a=1,h=0;var o=Xx[r],l=Yx[r];if(Math.abs(e[W.getElementIndex(l,o)])>i){i=(e[W.getElementIndex(l,l)]-e[W.getElementIndex(o,o)])/2/e[W.getElementIndex(l,o)];let t;t=i<0?-1/(-i+Math.sqrt(1+i*i)):1/(i+Math.sqrt(1+i*i)),a=1/Math.sqrt(1+t*t),h=t*a}(t=W.clone(W.IDENTITY,t))[W.getElementIndex(o,o)]=t[W.getElementIndex(l,l)]=a,t[W.getElementIndex(l,o)]=h,t[W.getElementIndex(o,l)]=-h}let Kx=new W,Jx=new W,$x=(W.computeEigenDecomposition=function(t,e){k.typeOf.object("matrix",t);var i=H.EPSILON20;let s=0,r=0;for(var n=(e=C(e)?e:{}).unitary=W.clone(W.IDENTITY,e.unitary),a=e.diagonal=W.clone(t,e.diagonal),h=i*jx(a);r<10&&Zx(a)>h;)qx(a,Kx),W.transpose(Kx,Jx),W.multiply(a,Kx,a),W.multiply(Jx,a,a),W.multiply(n,Kx,n),2<++s&&(++r,s=0);return e},W.abs=function(t,e){return k.typeOf.object("matrix",t),k.typeOf.object("result",e),e[0]=Math.abs(t[0]),e[1]=Math.abs(t[1]),e[2]=Math.abs(t[2]),e[3]=Math.abs(t[3]),e[4]=Math.abs(t[4]),e[5]=Math.abs(t[5]),e[6]=Math.abs(t[6]),e[7]=Math.abs(t[7]),e[8]=Math.abs(t[8]),e},W.determinant=function(t){k.typeOf.object("matrix",t);var e=t[0],i=t[3],s=t[6],r=t[4],n=t[7],a=t[5],h=t[8];return e*(r*h-a*n)+t[1]*(a*s-i*h)+t[2]*(i*n-r*s)},W.inverse=function(t,e){k.typeOf.object("matrix",t),k.typeOf.object("result",e);var i=t[0],s=t[1],r=t[2],n=t[3],a=t[4],h=t[5],o=t[6],l=t[7],u=t[8],t=W.determinant(t);if(Math.abs(t)<=H.EPSILON15)throw new m("matrix is not invertible");return e[0]=a*u-l*h,e[1]=l*r-s*u,e[2]=s*h-a*r,e[3]=o*h-n*u,e[4]=i*u-o*r,e[5]=n*r-i*h,e[6]=n*l-o*a,e[7]=o*s-i*l,e[8]=i*a-n*s,W.multiplyByScalar(e,1/t,e)},new W);function Qx(t){this.name="RuntimeError",this.message=t;let e;try{throw new Error}catch(t){e=t.stack}this.stack=e}function j(t,e,i,s,r,n,a,h,o,l,u,c,f,d,v,p){this[0]=g(t,0),this[1]=g(r,0),this[2]=g(o,0),this[3]=g(f,0),this[4]=g(e,0),this[5]=g(n,0),this[6]=g(l,0),this[7]=g(d,0),this[8]=g(i,0),this[9]=g(a,0),this[10]=g(u,0),this[11]=g(v,0),this[12]=g(s,0),this[13]=g(h,0),this[14]=g(c,0),this[15]=g(p,0)}W.inverseTranspose=function(t,e){return k.typeOf.object("matrix",t),k.typeOf.object("result",e),W.inverse(W.transpose(t,$x),e)},W.equals=function(t,e){return t===e||C(t)&&C(e)&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]},W.equalsEpsilon=function(t,e,i){return i=g(i,0),t===e||C(t)&&C(e)&&Math.abs(t[0]-e[0])<=i&&Math.abs(t[1]-e[1])<=i&&Math.abs(t[2]-e[2])<=i&&Math.abs(t[3]-e[3])<=i&&Math.abs(t[4]-e[4])<=i&&Math.abs(t[5]-e[5])<=i&&Math.abs(t[6]-e[6])<=i&&Math.abs(t[7]-e[7])<=i&&Math.abs(t[8]-e[8])<=i},W.IDENTITY=Object.freeze(new W(1,0,0,0,1,0,0,0,1)),W.ZERO=Object.freeze(new W(0,0,0,0,0,0,0,0,0)),W.COLUMN0ROW0=0,W.COLUMN0ROW1=1,W.COLUMN0ROW2=2,W.COLUMN1ROW0=3,W.COLUMN1ROW1=4,W.COLUMN1ROW2=5,W.COLUMN2ROW0=6,W.COLUMN2ROW1=7,W.COLUMN2ROW2=8,Object.defineProperties(W.prototype,{length:{get:function(){return W.packedLength}}}),W.prototype.clone=function(t){return W.clone(this,t)},W.prototype.equals=function(t){return W.equals(this,t)},W.equalsArray=function(t,e,i){return t[0]===e[i]&&t[1]===e[i+1]&&t[2]===e[i+2]&&t[3]===e[i+3]&&t[4]===e[i+4]&&t[5]===e[i+5]&&t[6]===e[i+6]&&t[7]===e[i+7]&&t[8]===e[i+8]},W.prototype.equalsEpsilon=function(t,e){return W.equalsEpsilon(this,t,e)},W.prototype.toString=function(){return`(${this[0]}, ${this[3]}, ${this[6]})
(${this[1]}, ${this[4]}, ${this[7]})
(${this[2]}, ${this[5]}, ${this[8]})`},C(Object.create)&&(Qx.prototype=Object.create(Error.prototype),Qx.prototype.constructor=Qx),Qx.prototype.toString=function(){let t=this.name+": "+this.message;return C(this.stack)&&(t+=`
`+this.stack.toString()),t},j.packedLength=16,j.pack=function(t,e,i){return k.typeOf.object("value",t),k.defined("array",e),i=g(i,0),e[i++]=t[0],e[i++]=t[1],e[i++]=t[2],e[i++]=t[3],e[i++]=t[4],e[i++]=t[5],e[i++]=t[6],e[i++]=t[7],e[i++]=t[8],e[i++]=t[9],e[i++]=t[10],e[i++]=t[11],e[i++]=t[12],e[i++]=t[13],e[i++]=t[14],e[i]=t[15],e},j.unpack=function(t,e,i){return k.defined("array",t),e=g(e,0),(i=C(i)?i:new j)[0]=t[e++],i[1]=t[e++],i[2]=t[e++],i[3]=t[e++],i[4]=t[e++],i[5]=t[e++],i[6]=t[e++],i[7]=t[e++],i[8]=t[e++],i[9]=t[e++],i[10]=t[e++],i[11]=t[e++],i[12]=t[e++],i[13]=t[e++],i[14]=t[e++],i[15]=t[e],i},j.packArray=function(e,i){k.defined("array",e);var s=e.length,t=16*s;if(C(i)){if(!Array.isArray(i)&&i.length!==t)throw new m("If result is a typed array, it must have exactly array.length * 16 elements");i.length!==t&&(i.length=t)}else i=new Array(t);for(let t=0;t<s;++t)j.pack(e[t],i,16*t);return i},j.unpackArray=function(e,i){if(k.defined("array",e),k.typeOf.number.greaterThanOrEquals("array.length",e.length,16),e.length%16!=0)throw new m("array length must be a multiple of 16.");var s=e.length;C(i)?i.length=s/16:i=new Array(s/16);for(let t=0;t<s;t+=16){var r=t/16;i[r]=j.unpack(e,t,i[r])}return i},j.clone=function(t,e){if(C(t))return C(e)?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e):new j(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15])},j.fromArray=j.unpack,j.fromColumnMajorArray=function(t,e){return k.defined("values",t),j.clone(t,e)},j.fromRowMajorArray=function(t,e){return k.defined("values",t),C(e)?(e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e):new j(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},j.fromRotationTranslation=function(t,e,i){return k.typeOf.object("rotation",t),e=g(e,w.ZERO),C(i)?(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=0,i[4]=t[3],i[5]=t[4],i[6]=t[5],i[7]=0,i[8]=t[6],i[9]=t[7],i[10]=t[8],i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,i):new j(t[0],t[3],t[6],e.x,t[1],t[4],t[7],e.y,t[2],t[5],t[8],e.z,0,0,0,1)},j.fromTranslationQuaternionRotationScale=function(t,e,i,s){k.typeOf.object("translation",t),k.typeOf.object("rotation",e),k.typeOf.object("scale",i),C(s)||(s=new j);var r=i.x,n=i.y,i=i.z,a=e.x*e.x,h=e.x*e.y,o=e.x*e.z,l=e.x*e.w,u=e.y*e.y,c=e.y*e.z,f=e.y*e.w,d=e.z*e.z,v=e.z*e.w,e=e.w*e.w,p=2*(h-v),m=2*(o+f),h=2*(h+v),v=u-a-d+e,g=2*(c-l),o=2*(o-f),f=2*(c+l),c=-a-u+d+e;return s[0]=(a-u-d+e)*r,s[1]=h*r,s[2]=o*r,s[3]=0,s[4]=p*n,s[5]=v*n,s[6]=f*n,s[7]=0,s[8]=m*i,s[9]=g*i,s[10]=c*i,s[11]=0,s[12]=t.x,s[13]=t.y,s[14]=t.z,s[15]=1,s},j.fromTranslationRotationScale=function(t,e){return k.typeOf.object("translationRotationScale",t),j.fromTranslationQuaternionRotationScale(t.translation,t.rotation,t.scale,e)},j.fromTranslation=function(t,e){return k.typeOf.object("translation",t),j.fromRotationTranslation(W.IDENTITY,t,e)},j.fromScale=function(t,e){return k.typeOf.object("scale",t),C(e)?(e[0]=t.x,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t.y,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t.z,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e):new j(t.x,0,0,0,0,t.y,0,0,0,0,t.z,0,0,0,0,1)},j.fromUniformScale=function(t,e){return k.typeOf.number("scale",t),C(e)?(e[0]=t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e):new j(t,0,0,0,0,t,0,0,0,0,t,0,0,0,0,1)},j.fromRotation=function(t,e){return k.typeOf.object("rotation",t),(e=C(e)?e:new j)[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[3],e[5]=t[4],e[6]=t[5],e[7]=0,e[8]=t[6],e[9]=t[7],e[10]=t[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e};let tb=new w,eb=new w,ib=new w,sb=(j.fromCamera=function(t,e){k.typeOf.object("camera",t);var i=t.position,s=t.direction,t=t.up,s=(k.typeOf.object("camera.position",i),k.typeOf.object("camera.direction",s),k.typeOf.object("camera.up",t),w.normalize(s,tb),w.normalize(w.cross(tb,t,eb),eb),w.normalize(w.cross(eb,tb,ib),ib),eb.x),t=eb.y,r=eb.z,n=tb.x,a=tb.y,h=tb.z,o=ib.x,l=ib.y,u=ib.z,c=i.x,f=i.y,i=i.z,d=s*-c+t*-f+r*-i,v=o*-c+l*-f+u*-i,c=n*c+a*f+h*i;return C(e)?(e[0]=s,e[1]=o,e[2]=-n,e[3]=0,e[4]=t,e[5]=l,e[6]=-a,e[7]=0,e[8]=r,e[9]=u,e[10]=-h,e[11]=0,e[12]=d,e[13]=v,e[14]=c,e[15]=1,e):new j(s,t,r,d,o,l,u,v,-n,-a,-h,c,0,0,0,1)},j.computePerspectiveFieldOfView=function(t,e,i,s,r){k.typeOf.number.greaterThan("fovY",t,0),k.typeOf.number.lessThan("fovY",t,Math.PI),k.typeOf.number.greaterThan("near",i,0),k.typeOf.number.greaterThan("far",s,0),k.typeOf.object("result",r);var t=1/Math.tan(.5*t),n=(s+i)/(i-s),i=2*s*i/(i-s);return r[0]=t/e,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=n,r[11]=-1,r[12]=0,r[13]=0,r[14]=i,r[15]=0,r},j.computeOrthographicOffCenter=function(t,e,i,s,r,n,a){k.typeOf.number("left",t),k.typeOf.number("right",e),k.typeOf.number("bottom",i),k.typeOf.number("top",s),k.typeOf.number("near",r),k.typeOf.number("far",n),k.typeOf.object("result",a);var h=1/(e-t),o=1/(s-i),l=1/(n-r),e=-(e+t)*h,t=-(s+i)*o,s=-(n+r)*l;return o*=2,l*=-2,a[0]=h*=2,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=o,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=l,a[11]=0,a[12]=e,a[13]=t,a[14]=s,a[15]=1,a},j.computePerspectiveOffCenter=function(t,e,i,s,r,n,a){k.typeOf.number("left",t),k.typeOf.number("right",e),k.typeOf.number("bottom",i),k.typeOf.number("top",s),k.typeOf.number("near",r),k.typeOf.number("far",n),k.typeOf.object("result",a);var h=2*r/(s-i),o=(e+t)/(e-t),s=(s+i)/(s-i),i=-(n+r)/(n-r),n=-2*n*r/(n-r);return a[0]=2*r/(e-t),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=h,a[6]=0,a[7]=0,a[8]=o,a[9]=s,a[10]=i,a[11]=-1,a[12]=0,a[13]=0,a[14]=n,a[15]=0,a},j.computeInfinitePerspectiveOffCenter=function(t,e,i,s,r,n){k.typeOf.number("left",t),k.typeOf.number("right",e),k.typeOf.number("bottom",i),k.typeOf.number("top",s),k.typeOf.number("near",r),k.typeOf.object("result",n);var a=2*r/(s-i),h=(e+t)/(e-t),s=(s+i)/(s-i),i=-2*r;return n[0]=2*r/(e-t),n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=a,n[6]=0,n[7]=0,n[8]=h,n[9]=s,n[10]=-1,n[11]=-1,n[12]=0,n[13]=0,n[14]=i,n[15]=0,n},j.computeViewportTransformation=function(t,e,i,s){C(s)||(s=new j),t=g(t,g.EMPTY_OBJECT);var r=g(t.x,0),n=g(t.y,0),a=g(t.width,0),t=g(t.height,0),a=(e=g(e,0),.5*a),t=.5*t,i=.5*((i=g(i,1))-e),h=t,o=i,r=r+a,n=n+t,t=e+i;return s[0]=a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=h,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=o,s[11]=0,s[12]=r,s[13]=n,s[14]=t,s[15]=1,s},j.computeView=function(t,e,i,s,r){return k.typeOf.object("position",t),k.typeOf.object("direction",e),k.typeOf.object("up",i),k.typeOf.object("right",s),k.typeOf.object("result",r),r[0]=s.x,r[1]=i.x,r[2]=-e.x,r[3]=0,r[4]=s.y,r[5]=i.y,r[6]=-e.y,r[7]=0,r[8]=s.z,r[9]=i.z,r[10]=-e.z,r[11]=0,r[12]=-w.dot(s,t),r[13]=-w.dot(i,t),r[14]=w.dot(e,t),r[15]=1,r},j.toArray=function(t,e){return k.typeOf.object("matrix",t),C(e)?(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e):[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]},j.getElementIndex=function(t,e){return k.typeOf.number.greaterThanOrEquals("row",e,0),k.typeOf.number.lessThanOrEquals("row",e,3),k.typeOf.number.greaterThanOrEquals("column",t,0),k.typeOf.number.lessThanOrEquals("column",t,3),4*t+e},j.getColumn=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.number.greaterThanOrEquals("index",e,0),k.typeOf.number.lessThanOrEquals("index",e,3),k.typeOf.object("result",i);var e=4*e,s=t[e],r=t[1+e],n=t[2+e],t=t[3+e];return i.x=s,i.y=r,i.z=n,i.w=t,i},j.setColumn=function(t,e,i,s){k.typeOf.object("matrix",t),k.typeOf.number.greaterThanOrEquals("index",e,0),k.typeOf.number.lessThanOrEquals("index",e,3),k.typeOf.object("cartesian",i),k.typeOf.object("result",s);e*=4;return(s=j.clone(t,s))[e]=i.x,s[1+e]=i.y,s[2+e]=i.z,s[3+e]=i.w,s},j.getRow=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.number.greaterThanOrEquals("index",e,0),k.typeOf.number.lessThanOrEquals("index",e,3),k.typeOf.object("result",i);var s=t[e],r=t[e+4],n=t[e+8],t=t[e+12];return i.x=s,i.y=r,i.z=n,i.w=t,i},j.setRow=function(t,e,i,s){return k.typeOf.object("matrix",t),k.typeOf.number.greaterThanOrEquals("index",e,0),k.typeOf.number.lessThanOrEquals("index",e,3),k.typeOf.object("cartesian",i),k.typeOf.object("result",s),(s=j.clone(t,s))[e]=i.x,s[e+4]=i.y,s[e+8]=i.z,s[e+12]=i.w,s},j.setTranslation=function(t,e,i){return k.typeOf.object("matrix",t),k.typeOf.object("translation",e),k.typeOf.object("result",i),i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=t[15],i},new w),rb=(j.setScale=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.object("scale",e),k.typeOf.object("result",i);var s=j.getScale(t,sb),r=e.x/s.x,n=e.y/s.y,e=e.z/s.z;return i[0]=t[0]*r,i[1]=t[1]*r,i[2]=t[2]*r,i[3]=t[3],i[4]=t[4]*n,i[5]=t[5]*n,i[6]=t[6]*n,i[7]=t[7],i[8]=t[8]*e,i[9]=t[9]*e,i[10]=t[10]*e,i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i},new w),nb=(j.setUniformScale=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.number("scale",e),k.typeOf.object("result",i);var s=j.getScale(t,rb),r=e/s.x,n=e/s.y,e=e/s.z;return i[0]=t[0]*r,i[1]=t[1]*r,i[2]=t[2]*r,i[3]=t[3],i[4]=t[4]*n,i[5]=t[5]*n,i[6]=t[6]*n,i[7]=t[7],i[8]=t[8]*e,i[9]=t[9]*e,i[10]=t[10]*e,i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i},new w),ab=(j.getScale=function(t,e){return k.typeOf.object("matrix",t),k.typeOf.object("result",e),e.x=w.magnitude(w.fromElements(t[0],t[1],t[2],nb)),e.y=w.magnitude(w.fromElements(t[4],t[5],t[6],nb)),e.z=w.magnitude(w.fromElements(t[8],t[9],t[10],nb)),e},new w),hb=(j.getMaximumScale=function(t){return j.getScale(t,ab),w.maximumComponent(ab)},new w),ob=(j.setRotation=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.object("result",i);var s=j.getScale(t,hb);return i[0]=e[0]*s.x,i[1]=e[1]*s.x,i[2]=e[2]*s.x,i[3]=t[3],i[4]=e[3]*s.y,i[5]=e[4]*s.y,i[6]=e[5]*s.y,i[7]=t[7],i[8]=e[6]*s.z,i[9]=e[7]*s.z,i[10]=e[8]*s.z,i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i},new w),lb=(j.getRotation=function(t,e){k.typeOf.object("matrix",t),k.typeOf.object("result",e);var i=j.getScale(t,ob);return e[0]=t[0]/i.x,e[1]=t[1]/i.x,e[2]=t[2]/i.x,e[3]=t[4]/i.y,e[4]=t[5]/i.y,e[5]=t[6]/i.y,e[6]=t[8]/i.z,e[7]=t[9]/i.z,e[8]=t[10]/i.z,e},j.multiply=function(t,e,i){k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i);var s=t[0],r=t[1],n=t[2],a=t[3],h=t[4],o=t[5],l=t[6],u=t[7],c=t[8],f=t[9],d=t[10],v=t[11],p=t[12],m=t[13],g=t[14],t=t[15],_=e[0],w=e[1],M=e[2],y=e[3],E=e[4],x=e[5],b=e[6],S=e[7],A=e[8],T=e[9],R=e[10],L=e[11],C=e[12],N=e[13],I=e[14],e=e[15],P=r*_+o*w+f*M+m*y,D=n*_+l*w+d*M+g*y,O=a*_+u*w+v*M+t*y,U=s*E+h*x+c*b+p*S,F=r*E+o*x+f*b+m*S,B=n*E+l*x+d*b+g*S,E=a*E+u*x+v*b+t*S,x=s*A+h*T+c*R+p*L,b=r*A+o*T+f*R+m*L,S=n*A+l*T+d*R+g*L,A=a*A+u*T+v*R+t*L,T=s*C+h*N+c*I+p*e,R=r*C+o*N+f*I+m*e,L=n*C+l*N+d*I+g*e,r=a*C+u*N+v*I+t*e;return i[0]=s*_+h*w+c*M+p*y,i[1]=P,i[2]=D,i[3]=O,i[4]=U,i[5]=F,i[6]=B,i[7]=E,i[8]=x,i[9]=b,i[10]=S,i[11]=A,i[12]=T,i[13]=R,i[14]=L,i[15]=r,i},j.add=function(t,e,i){return k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i[4]=t[4]+e[4],i[5]=t[5]+e[5],i[6]=t[6]+e[6],i[7]=t[7]+e[7],i[8]=t[8]+e[8],i[9]=t[9]+e[9],i[10]=t[10]+e[10],i[11]=t[11]+e[11],i[12]=t[12]+e[12],i[13]=t[13]+e[13],i[14]=t[14]+e[14],i[15]=t[15]+e[15],i},j.subtract=function(t,e,i){return k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i[3]=t[3]-e[3],i[4]=t[4]-e[4],i[5]=t[5]-e[5],i[6]=t[6]-e[6],i[7]=t[7]-e[7],i[8]=t[8]-e[8],i[9]=t[9]-e[9],i[10]=t[10]-e[10],i[11]=t[11]-e[11],i[12]=t[12]-e[12],i[13]=t[13]-e[13],i[14]=t[14]-e[14],i[15]=t[15]-e[15],i},j.multiplyTransformation=function(t,e,i){k.typeOf.object("left",t),k.typeOf.object("right",e),k.typeOf.object("result",i);var s=t[0],r=t[1],n=t[2],a=t[4],h=t[5],o=t[6],l=t[8],u=t[9],c=t[10],f=e[0],d=e[1],v=e[2],p=e[4],m=e[5],g=e[6],_=e[8],w=e[9],M=e[10],y=e[12],E=e[13],e=e[14],x=r*f+h*d+u*v,b=n*f+o*d+c*v,S=s*p+a*m+l*g,A=r*p+h*m+u*g,p=n*p+o*m+c*g,m=s*_+a*w+l*M,g=r*_+h*w+u*M,_=n*_+o*w+c*M,w=s*y+a*E+l*e+t[12],M=r*y+h*E+u*e+t[13],r=n*y+o*E+c*e+t[14];return i[0]=s*f+a*d+l*v,i[1]=x,i[2]=b,i[3]=0,i[4]=S,i[5]=A,i[6]=p,i[7]=0,i[8]=m,i[9]=g,i[10]=_,i[11]=0,i[12]=w,i[13]=M,i[14]=r,i[15]=1,i},j.multiplyByMatrix3=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.object("rotation",e),k.typeOf.object("result",i);var s=t[0],r=t[1],n=t[2],a=t[4],h=t[5],o=t[6],l=t[8],u=t[9],c=t[10],f=e[0],d=e[1],v=e[2],p=e[3],m=e[4],g=e[5],_=e[6],w=e[7],e=e[8],M=r*f+h*d+u*v,y=n*f+o*d+c*v,E=s*p+a*m+l*g,x=r*p+h*m+u*g,p=n*p+o*m+c*g,m=s*_+a*w+l*e,g=r*_+h*w+u*e,r=n*_+o*w+c*e;return i[0]=s*f+a*d+l*v,i[1]=M,i[2]=y,i[3]=0,i[4]=E,i[5]=x,i[6]=p,i[7]=0,i[8]=m,i[9]=g,i[10]=r,i[11]=0,i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i},j.multiplyByTranslation=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.object("translation",e),k.typeOf.object("result",i);var s=e.x,r=e.y,e=e.z,n=s*t[0]+r*t[4]+e*t[8]+t[12],a=s*t[1]+r*t[5]+e*t[9]+t[13],s=s*t[2]+r*t[6]+e*t[10]+t[14];return i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=n,i[13]=a,i[14]=s,i[15]=t[15],i},j.multiplyByScale=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.object("scale",e),k.typeOf.object("result",i);var s=e.x,r=e.y,e=e.z;return 1===s&&1===r&&1===e?j.clone(t,i):(i[0]=s*t[0],i[1]=s*t[1],i[2]=s*t[2],i[3]=t[3],i[4]=r*t[4],i[5]=r*t[5],i[6]=r*t[6],i[7]=t[7],i[8]=e*t[8],i[9]=e*t[9],i[10]=e*t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i)},j.multiplyByUniformScale=function(t,e,i){return k.typeOf.object("matrix",t),k.typeOf.number("scale",e),k.typeOf.object("result",i),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3],i[4]=t[4]*e,i[5]=t[5]*e,i[6]=t[6]*e,i[7]=t[7],i[8]=t[8]*e,i[9]=t[9]*e,i[10]=t[10]*e,i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i},j.multiplyByVector=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.object("cartesian",e),k.typeOf.object("result",i);var s=e.x,r=e.y,n=e.z,e=e.w,a=t[0]*s+t[4]*r+t[8]*n+t[12]*e,h=t[1]*s+t[5]*r+t[9]*n+t[13]*e,o=t[2]*s+t[6]*r+t[10]*n+t[14]*e,s=t[3]*s+t[7]*r+t[11]*n+t[15]*e;return i.x=a,i.y=h,i.z=o,i.w=s,i},j.multiplyByPointAsVector=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.object("cartesian",e),k.typeOf.object("result",i);var s=e.x,r=e.y,e=e.z,n=t[0]*s+t[4]*r+t[8]*e,a=t[1]*s+t[5]*r+t[9]*e,s=t[2]*s+t[6]*r+t[10]*e;return i.x=n,i.y=a,i.z=s,i},j.multiplyByPoint=function(t,e,i){k.typeOf.object("matrix",t),k.typeOf.object("cartesian",e),k.typeOf.object("result",i);var s=e.x,r=e.y,e=e.z,n=t[0]*s+t[4]*r+t[8]*e+t[12],a=t[1]*s+t[5]*r+t[9]*e+t[13],s=t[2]*s+t[6]*r+t[10]*e+t[14];return i.x=n,i.y=a,i.z=s,i},j.multiplyByScalar=function(t,e,i){return k.typeOf.object("matrix",t),k.typeOf.number("scalar",e),k.typeOf.object("result",i),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i[4]=t[4]*e,i[5]=t[5]*e,i[6]=t[6]*e,i[7]=t[7]*e,i[8]=t[8]*e,i[9]=t[9]*e,i[10]=t[10]*e,i[11]=t[11]*e,i[12]=t[12]*e,i[13]=t[13]*e,i[14]=t[14]*e,i[15]=t[15]*e,i},j.negate=function(t,e){return k.typeOf.object("matrix",t),k.typeOf.object("result",e),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e[11]=-t[11],e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=-t[15],e},j.transpose=function(t,e){k.typeOf.object("matrix",t),k.typeOf.object("result",e);var i=t[1],s=t[2],r=t[3],n=t[6],a=t[7],h=t[11];return e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=i,e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=s,e[9]=n,e[10]=t[10],e[11]=t[14],e[12]=r,e[13]=a,e[14]=h,e[15]=t[15],e},j.abs=function(t,e){return k.typeOf.object("matrix",t),k.typeOf.object("result",e),e[0]=Math.abs(t[0]),e[1]=Math.abs(t[1]),e[2]=Math.abs(t[2]),e[3]=Math.abs(t[3]),e[4]=Math.abs(t[4]),e[5]=Math.abs(t[5]),e[6]=Math.abs(t[6]),e[7]=Math.abs(t[7]),e[8]=Math.abs(t[8]),e[9]=Math.abs(t[9]),e[10]=Math.abs(t[10]),e[11]=Math.abs(t[11]),e[12]=Math.abs(t[12]),e[13]=Math.abs(t[13]),e[14]=Math.abs(t[14]),e[15]=Math.abs(t[15]),e},j.equals=function(t,e){return t===e||C(t)&&C(e)&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[3]===e[3]&&t[7]===e[7]&&t[11]===e[11]&&t[15]===e[15]},j.equalsEpsilon=function(t,e,i){return i=g(i,0),t===e||C(t)&&C(e)&&Math.abs(t[0]-e[0])<=i&&Math.abs(t[1]-e[1])<=i&&Math.abs(t[2]-e[2])<=i&&Math.abs(t[3]-e[3])<=i&&Math.abs(t[4]-e[4])<=i&&Math.abs(t[5]-e[5])<=i&&Math.abs(t[6]-e[6])<=i&&Math.abs(t[7]-e[7])<=i&&Math.abs(t[8]-e[8])<=i&&Math.abs(t[9]-e[9])<=i&&Math.abs(t[10]-e[10])<=i&&Math.abs(t[11]-e[11])<=i&&Math.abs(t[12]-e[12])<=i&&Math.abs(t[13]-e[13])<=i&&Math.abs(t[14]-e[14])<=i&&Math.abs(t[15]-e[15])<=i},j.getTranslation=function(t,e){return k.typeOf.object("matrix",t),k.typeOf.object("result",e),e.x=t[12],e.y=t[13],e.z=t[14],e},j.getMatrix3=function(t,e){return k.typeOf.object("matrix",t),k.typeOf.object("result",e),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},new W),ub=new W,cb=new z,fb=new z(0,0,0,1),db=(j.inverse=function(t,e){k.typeOf.object("matrix",t),k.typeOf.object("result",e);var i=t[0],s=t[4],r=t[8],n=t[12],a=t[1],h=t[5],o=t[9],l=t[13],u=t[2],c=t[6],f=t[10],d=t[14],v=t[3],p=t[7],m=t[11],g=t[15],_=f*g,w=d*m,M=c*g,y=d*p,E=c*m,x=f*p,b=u*g,S=d*v,A=u*m,T=f*v,R=u*p,L=c*v,C=_*h+y*o+E*l-(w*h+M*o+x*l),N=w*a+b*o+T*l-(_*a+S*o+A*l),I=M*a+S*h+R*l-(y*a+b*h+L*l),P=x*a+A*h+L*o-(E*a+T*h+R*o),D=w*s+M*r+x*n-(_*s+y*r+E*n),O=_*i+S*r+A*n-(w*i+b*r+T*n),U=y*i+b*s+L*n-(M*i+S*s+R*n),F=E*i+T*s+R*r-(x*i+A*s+L*r),B=(_=r*l)*p+(y=n*h)*m+(E=s*o)*g-((w=n*o)*p+(M=s*l)*m+(x=r*h)*g),l=w*v+(b=i*l)*m+(T=r*a)*g-(_*v+(S=n*a)*m+(A=i*o)*g),o=M*v+S*p+(R=i*h)*g-(y*v+b*p+(L=s*a)*g),h=x*v+A*p+L*m-(E*v+T*p+R*m),a=M*f+x*d+w*c-(E*d+_*c+y*f),g=A*d+_*u+S*f-(b*f+T*d+w*u),v=b*c+L*d+y*u-(R*d+M*u+S*c),p=R*f+E*u+T*c-(A*c+L*f+x*u),m=i*C+s*N+r*I+n*P;if(Math.abs(m)<H.EPSILON21){if(W.equalsEpsilon(j.getMatrix3(t,lb),ub,H.EPSILON7)&&z.equals(j.getRow(t,3,cb),fb))return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=0,e[11]=0,e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=1,e;throw new Qx("matrix is not invertible because its determinate is zero.")}return e[0]=C*(m=1/m),e[1]=N*m,e[2]=I*m,e[3]=P*m,e[4]=D*m,e[5]=O*m,e[6]=U*m,e[7]=F*m,e[8]=B*m,e[9]=l*m,e[10]=o*m,e[11]=h*m,e[12]=a*m,e[13]=g*m,e[14]=v*m,e[15]=p*m,e},j.inverseTransformation=function(t,e){k.typeOf.object("matrix",t),k.typeOf.object("result",e);var i=t[0],s=t[1],r=t[2],n=t[4],a=t[5],h=t[6],o=t[8],l=t[9],u=t[10],c=t[12],f=t[13],t=t[14],d=-i*c-s*f-r*t,v=-n*c-a*f-h*t,c=-o*c-l*f-u*t;return e[0]=i,e[1]=n,e[2]=o,e[3]=0,e[4]=s,e[5]=a,e[6]=l,e[7]=0,e[8]=r,e[9]=h,e[10]=u,e[11]=0,e[12]=d,e[13]=v,e[14]=c,e[15]=1,e},new j);function vb(t){t=g(t,g.EMPTY_OBJECT),this.left=t.left,this.dE=void 0,this.right=t.right,this.vE=void 0,this.top=t.top,this.pE=void 0,this.bottom=t.bottom,this.mE=void 0,this.near=g(t.near,1),this.gE=this.near,this.far=g(t.far,5e8),this._E=this.far,this.wE=new j,this.ME=new j}function pb(t){if(!(C(t.right)&&C(t.left)&&C(t.top)&&C(t.bottom)&&C(t.near)&&C(t.far)))throw new m("right, left, top, bottom, near, or far parameters are not set.");var e=t.top,i=t.bottom,s=t.right,r=t.left,n=t.near,a=t.far;if(e!==t.pE||i!==t.mE||r!==t.dE||s!==t.vE||n!==t.gE||a!==t._E){if(t.near<=0||t.near>t.far)throw new m("near must be greater than zero and less than far.");t.dE=r,t.vE=s,t.pE=e,t.mE=i,t.gE=n,t._E=a,t.wE=j.computePerspectiveOffCenter(r,s,i,e,n,a,t.wE),t.ME=j.computeInfinitePerspectiveOffCenter(r,s,i,e,n,t.ME)}}function mb(t){t=g(t,g.EMPTY_OBJECT),this.yE=new vb,this.fov=t.fov,this.EE=void 0,this.xE=void 0,this.bE=void 0,this.aspectRatio=t.aspectRatio,this.SE=void 0,this.near=g(t.near,1),this.gE=this.near,this.far=g(t.far,5e8),this._E=this.far,this.xOffset=g(t.xOffset,0),this.AE=this.xOffset,this.yOffset=g(t.yOffset,0),this.TE=this.yOffset}function gb(t){if(!(C(t.fov)&&C(t.aspectRatio)&&C(t.near)&&C(t.far)))throw new m("fov, aspectRatio, near, or far parameters are not set.");var e=t.yE;if(t.fov!==t.EE||t.aspectRatio!==t.SE||t.near!==t.gE||t.far!==t._E||t.xOffset!==t.AE||t.yOffset!==t.TE){if(t.fov<0||t.fov>=Math.PI)throw new m("fov must be in the range [0, PI).");if(t.aspectRatio<0)throw new m("aspectRatio must be positive.");if(t.near<0||t.near>t.far)throw new m("near must be greater than zero and less than far.");t.SE=t.aspectRatio,t.EE=t.fov,t.xE=t.fov,t.gE=t.near,t._E=t.far,t.bE=2*Math.tan(.5*t.xE),t.AE=t.xOffset,t.TE=t.yOffset,e.top=t.near*Math.tan(.5*t.xE),e.bottom=-e.top,e.right=t.aspectRatio*e.top,e.left=-e.right,e.near=t.near,e.far=t.far,e.right+=t.xOffset,e.left+=t.xOffset,e.top+=t.yOffset,e.bottom+=t.yOffset}}function _b(t){t=g(t,g.EMPTY_OBJECT),this.left=t.left,this.dE=void 0,this.right=t.right,this.vE=void 0,this.top=t.top,this.pE=void 0,this.bottom=t.bottom,this.mE=void 0,this.near=g(t.near,1),this.gE=this.near,this.far=g(t.far,5e8),this._E=this.far,this.RE=new j}function wb(t){if(!(C(t.right)&&C(t.left)&&C(t.top)&&C(t.bottom)&&C(t.near)&&C(t.far)))throw new m("right, left, top, bottom, near, or far parameters are not set.");if(t.top!==t.pE||t.bottom!==t.mE||t.left!==t.dE||t.right!==t.vE||t.near!==t.gE||t.far!==t._E){if(t.left>t.right)throw new m("right must be greater than left.");if(t.top<t.bottom)throw new m("top must be greater than bottom.");if(t.near<=0||t.near>t.far)throw new m("near must be greater than zero and less than far.");t.dE=t.left,t.vE=t.right,t.pE=t.top,t.mE=t.bottom,t.gE=t.near,t._E=t.far,t.RE=j.computeOrthographicOffCenter(t.left,t.right,t.bottom,t.top,t.near,t.far,t.RE)}}j.inverseTranspose=function(t,e){return k.typeOf.object("matrix",t),k.typeOf.object("result",e),j.inverse(j.transpose(t,db),e)},j.IDENTITY=Object.freeze(new j(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)),j.ZERO=Object.freeze(new j(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)),j.COLUMN0ROW0=0,j.COLUMN0ROW1=1,j.COLUMN0ROW2=2,j.COLUMN0ROW3=3,j.COLUMN1ROW0=4,j.COLUMN1ROW1=5,j.COLUMN1ROW2=6,j.COLUMN1ROW3=7,j.COLUMN2ROW0=8,j.COLUMN2ROW1=9,j.COLUMN2ROW2=10,j.COLUMN2ROW3=11,j.COLUMN3ROW0=12,j.COLUMN3ROW1=13,j.COLUMN3ROW2=14,j.COLUMN3ROW3=15,Object.defineProperties(j.prototype,{length:{get:function(){return j.packedLength}}}),j.prototype.clone=function(t){return j.clone(this,t)},j.prototype.equals=function(t){return j.equals(this,t)},j.equalsArray=function(t,e,i){return t[0]===e[i]&&t[1]===e[i+1]&&t[2]===e[i+2]&&t[3]===e[i+3]&&t[4]===e[i+4]&&t[5]===e[i+5]&&t[6]===e[i+6]&&t[7]===e[i+7]&&t[8]===e[i+8]&&t[9]===e[i+9]&&t[10]===e[i+10]&&t[11]===e[i+11]&&t[12]===e[i+12]&&t[13]===e[i+13]&&t[14]===e[i+14]&&t[15]===e[i+15]},j.prototype.equalsEpsilon=function(t,e){return j.equalsEpsilon(this,t,e)},j.prototype.toString=function(){return`(${this[0]}, ${this[4]}, ${this[8]}, ${this[12]})
(${this[1]}, ${this[5]}, ${this[9]}, ${this[13]})
(${this[2]}, ${this[6]}, ${this[10]}, ${this[14]})
(${this[3]}, ${this[7]}, ${this[11]}, ${this[15]})`},Object.defineProperties(vb.prototype,{projectionMatrix:{get:function(){return pb(this),this.wE}},infiniteProjectionMatrix:{get:function(){return pb(this),this.ME}}}),vb.prototype.getPixelDimensions=function(t,e,i,s,r){if(pb(this),!C(t)||!C(e))throw new m("Both drawingBufferWidth and drawingBufferHeight are required.");if(t<=0)throw new m("drawingBufferWidth must be greater than zero.");if(e<=0)throw new m("drawingBufferHeight must be greater than zero.");if(!C(i))throw new m("distance is required.");if(!C(s))throw new m("pixelRatio is required");if(s<=0)throw new m("pixelRatio must be greater than zero.");var n,a;if(C(r))return n=1/this.near,e=2*s*i*(a=this.top*n)/e,a=this.right*n,r.x=2*s*i*a/t,r.y=e,r;throw new m("A result object is required.")},vb.prototype.clone=function(t){return(t=C(t)?t:new vb).right=this.right,t.left=this.left,t.top=this.top,t.bottom=this.bottom,t.near=this.near,t.far=this.far,t.dE=void 0,t.vE=void 0,t.pE=void 0,t.mE=void 0,t.gE=void 0,t._E=void 0,t},vb.prototype.equals=function(t){return C(t)&&t instanceof vb&&this.right===t.right&&this.left===t.left&&this.top===t.top&&this.bottom===t.bottom&&this.near===t.near&&this.far===t.far},vb.prototype.equalsEpsilon=function(t,e,i){return t===this||C(t)&&t instanceof vb&&H.equalsEpsilon(this.right,t.right,e,i)&&H.equalsEpsilon(this.left,t.left,e,i)&&H.equalsEpsilon(this.top,t.top,e,i)&&H.equalsEpsilon(this.bottom,t.bottom,e,i)&&H.equalsEpsilon(this.near,t.near,e,i)&&H.equalsEpsilon(this.far,t.far,e,i)},mb.packedLength=6,mb.prototype.update=function(){gb(this)},mb.pack=function(t,e,i){return k.typeOf.object("value",t),k.defined("array",e),i=g(i,0),e[i++]=t.fov,e[i++]=t.aspectRatio,e[i++]=t.near,e[i++]=t.far,e[i++]=t.xOffset,e[i]=t.yOffset,e},mb.unpack=function(t,e,i){return k.defined("array",t),e=g(e,0),(i=C(i)?i:new mb).fov=t[e++],i.aspectRatio=t[e++],i.near=t[e++],i.far=t[e++],i.xOffset=t[e++],i.yOffset=t[e],i},Object.defineProperties(mb.prototype,{projectionMatrix:{get:function(){return gb(this),this.yE.projectionMatrix}},infiniteProjectionMatrix:{get:function(){return gb(this),this.yE.infiniteProjectionMatrix}},fovy:{get:function(){return gb(this),this.xE}},sseDenominator:{get:function(){return gb(this),this.bE}},offCenterFrustum:{get:function(){return gb(this),this.yE}}}),mb.prototype.computeCullingVolume=function(t,e,i){return gb(this),this.yE.computeCullingVolume(t,e,i)},mb.prototype.getPixelDimensions=function(t,e,i,s,r){return gb(this),this.yE.getPixelDimensions(t,e,i,s,r)},mb.prototype.clone=function(t){return(t=C(t)?t:new mb).aspectRatio=this.aspectRatio,t.fov=this.fov,t.near=this.near,t.far=this.far,t.SE=void 0,t.EE=void 0,t.gE=void 0,t._E=void 0,this.yE.clone(t.yE),t},mb.prototype.equals=function(t){return!!(C(t)&&t instanceof mb)&&(gb(this),gb(t),this.fov===t.fov)&&this.aspectRatio===t.aspectRatio&&this.yE.equals(t.yE)},mb.prototype.equalsEpsilon=function(t,e,i){return!!(C(t)&&t instanceof mb)&&(gb(this),gb(t),H.equalsEpsilon(this.fov,t.fov,e,i))&&H.equalsEpsilon(this.aspectRatio,t.aspectRatio,e,i)&&this.yE.equalsEpsilon(t.yE,e,i)},Object.defineProperties(_b.prototype,{projectionMatrix:{get:function(){return wb(this),this.RE}}});let Mb=new w,yb=new w,Eb=new w,xb=new w;function bb(t){t=g(t,g.EMPTY_OBJECT),this.yE=new _b,this.width=t.width,this.Tp=void 0,this.aspectRatio=t.aspectRatio,this.SE=void 0,this.near=g(t.near,1),this.gE=this.near,this.far=g(t.far,5e8),this._E=this.far,this.zoom=t.zoom||1,this.ns=this.zoom}function Sb(t){if(!(C(t.width)&&C(t.aspectRatio)&&C(t.near)&&C(t.far)&&C(t.zoom)))throw new m("width, aspectRatio, near, or far parameters are not set.");var e=t.yE;if(t.width!==t.Tp||t.aspectRatio!==t.SE||t.near!==t.gE||t.far!==t._E||t.zoom!==t.ns){if(t.aspectRatio<0)throw new m("aspectRatio must be positive.");if(t.near<0||t.near>t.far)throw new m("near must be greater than zero and less than far.");t.SE=t.aspectRatio,t.Tp=t.width,t.gE=t.near,t._E=t.far;var i=t.width/(2*t.zoom),s=1/t.aspectRatio*t.width/(2*t.zoom),r=0-i,n=0+s,s=0-s;e.right=0+i,e.left=r,e.top=n,e.bottom=s,e.near=t.near,e.far=t.far}}_b.prototype.computeCullingVolume=function(t,e,i){if(!C(t))throw new m("position is required.");if(!C(e))throw new m("direction is required.");if(!C(i))throw new m("up is required.");var s=this._cullingVolume.planes,r=this.top,n=this.bottom,a=this.right,h=this.left,o=this.near,l=this.far,u=w.cross(e,i,Mb),c=(w.normalize(u,u),yb),o=(w.multiplyByScalar(e,o,c),w.add(t,c,c),Eb);w.multiplyByScalar(u,h,o),w.add(c,o,o);let f=s[0];return(f=C(f)?f:s[0]=new z).x=u.x,f.y=u.y,f.z=u.z,f.w=-w.dot(u,o),w.multiplyByScalar(u,a,o),w.add(c,o,o),(f=C(f=s[1])?f:s[1]=new z).x=-u.x,f.y=-u.y,f.z=-u.z,f.w=-w.dot(w.negate(u,xb),o),w.multiplyByScalar(i,n,o),w.add(c,o,o),(f=C(f=s[2])?f:s[2]=new z).x=i.x,f.y=i.y,f.z=i.z,f.w=-w.dot(i,o),w.multiplyByScalar(i,r,o),w.add(c,o,o),(f=C(f=s[3])?f:s[3]=new z).x=-i.x,f.y=-i.y,f.z=-i.z,f.w=-w.dot(w.negate(i,xb),o),(f=C(f=s[4])?f:s[4]=new z).x=e.x,f.y=e.y,f.z=e.z,f.w=-w.dot(e,c),w.multiplyByScalar(e,l,o),w.add(t,o,o),(f=C(f=s[5])?f:s[5]=new z).x=-e.x,f.y=-e.y,f.z=-e.z,f.w=-w.dot(w.negate(e,xb),o),this._cullingVolume},_b.prototype.getPixelDimensions=function(t,e,i,s,r){if(wb(this),!C(t)||!C(e))throw new m("Both drawingBufferWidth and drawingBufferHeight are required.");if(t<=0)throw new m("drawingBufferWidth must be greater than zero.");if(e<=0)throw new m("drawingBufferHeight must be greater than zero.");if(!C(i))throw new m("distance is required.");if(!C(s))throw new m("pixelRatio is required.");if(s<=0)throw new m("pixelRatio must be greater than zero.");if(C(r))return i=this.right-this.left,e=s*(this.top-this.bottom)/e,r.x=s*i/t,r.y=e,r;throw new m("A result object is required.")},_b.prototype.clone=function(t){return(t=C(t)?t:new _b).left=this.left,t.right=this.right,t.top=this.top,t.bottom=this.bottom,t.near=this.near,t.far=this.far,t.dE=void 0,t.vE=void 0,t.pE=void 0,t.mE=void 0,t.gE=void 0,t._E=void 0,t},_b.prototype.equals=function(t){return C(t)&&t instanceof _b&&this.right===t.right&&this.left===t.left&&this.top===t.top&&this.bottom===t.bottom&&this.near===t.near&&this.far===t.far},_b.prototype.equalsEpsilon=function(t,e,i){return t===this||C(t)&&t instanceof _b&&H.equalsEpsilon(this.right,t.right,e,i)&&H.equalsEpsilon(this.left,t.left,e,i)&&H.equalsEpsilon(this.top,t.top,e,i)&&H.equalsEpsilon(this.bottom,t.bottom,e,i)&&H.equalsEpsilon(this.near,t.near,e,i)&&H.equalsEpsilon(this.far,t.far,e,i)},bb.packedLength=4,bb.pack=function(t,e,i){return k.typeOf.object("value",t),k.defined("array",e),i=g(i,0),e[i++]=t.width,e[i++]=t.aspectRatio,e[i++]=t.near,e[i]=t.far,e},bb.unpack=function(t,e,i){return k.defined("array",t),e=g(e,0),(i=C(i)?i:new bb).width=t[e++],i.aspectRatio=t[e++],i.near=t[e++],i.far=t[e],i},Object.defineProperties(bb.prototype,{projectionMatrix:{get:function(){return Sb(this),this.yE.projectionMatrix}},offCenterFrustum:{get:function(){return Sb(this),this.yE}}}),bb.prototype.computeCullingVolume=function(t,e,i){return Sb(this),this.yE.computeCullingVolume(t,e,i)},bb.prototype.getPixelDimensions=function(t,e,i,s,r){return Sb(this),this.yE.getPixelDimensions(t,e,i,s,r)},bb.prototype.clone=function(t){return(t=C(t)?t:new bb).aspectRatio=this.aspectRatio,t.width=this.width,t.near=this.near,t.far=this.far,t.SE=void 0,t.Tp=void 0,t.gE=void 0,t._E=void 0,this.yE.clone(t.yE),t},bb.prototype.equals=function(t){return!!(C(t)&&t instanceof bb)&&(Sb(this),Sb(t),this.width===t.width)&&this.aspectRatio===t.aspectRatio&&this.yE.equals(t.yE)},bb.prototype.update=function(){Sb(this)},bb.prototype.equalsEpsilon=function(t,e,i){return!!(C(t)&&t instanceof bb)&&(Sb(this),Sb(t),H.equalsEpsilon(this.width,t.width,e,i))&&H.equalsEpsilon(this.aspectRatio,t.aspectRatio,e,i)&&this.yE.equalsEpsilon(t.yE,e,i)};var Ab=`
uniform float czm_orthographicIn3D;
uniform float u_device_pixel_ratio;
uniform vec4 czm_viewport;
uniform vec4 czm_frustumPlanes;
uniform vec2 czm_currentFrustum;
uniform mat4 czm_projection;
uniform mat4 modelViewMatrix;
uniform vec2 pixelOffset;

attribute vec2 direction;
uniform vec2 origin;
attribute vec2 imageSize;
attribute vec2 translate;
attribute float scale;

attribute vec3 eyeOffset;
attribute vec2 bottomLeft;
attribute vec2 imageRectangle;

varying vec2 v_textureCoordinates;

/**
 * 
 * @param {vec4} positionEC 
 * @param {float} pixelRatio 
 */
float czm_metersPerPixel(vec4 positionEC, float pixelRatio) {
  float width = czm_viewport.z;
    float height = czm_viewport.w;
    float pixelWidth;
    float pixelHeight;

    float top = czm_frustumPlanes.x;
    float bottom = czm_frustumPlanes.y;
    float left = czm_frustumPlanes.z;
    float right = czm_frustumPlanes.w;

    if (czm_orthographicIn3D == 1.0)
    {
        float frustumWidth = right - left;
        float frustumHeight = top - bottom;
        pixelWidth = frustumWidth / width;
        pixelHeight = frustumHeight / height;
    }
    else
    {
        float distanceToPixel = -positionEC.z;
        float inverseNear = 1.0 / czm_currentFrustum.x;
        float tanTheta = top * inverseNear;
        pixelHeight = 2.0 * distanceToPixel * tanTheta / height;
        tanTheta = right * inverseNear;
        pixelWidth = 2.0 * distanceToPixel * tanTheta / width;
    }

    return max(pixelWidth, pixelHeight) * pixelRatio;
}

float czm_metersPerPixel(vec4 positionEC) {
    return czm_metersPerPixel(positionEC, u_device_pixel_ratio);
}

float czm_branchFreeTernary(bool comparison, float a, float b) {
    float useA = float(comparison);
    return a * useA + b * (1.0 - useA);
}

vec4 addScreenSpaceOffset(
  vec4 positionEC,
  vec2 imageSize,
  float scale,
  vec2 direction,
  vec2 origin,
  vec2 translate,
  vec2 pixelOffset,
   vec3 alignedAxis,
   bool validAlignedAxis,
   float rotation,
   bool sizeInMeters,
   out mat2 rotationMatrix,
   out float mpp
  ) {
    vec2 halfSize = imageSize * scale * 0.5;
    halfSize *= ((direction * 2.0) - 1.0);
    vec2 originTranslate = origin * abs(halfSize);

    mpp = czm_metersPerPixel(positionEC);
    positionEC.xy += (originTranslate + halfSize) * czm_branchFreeTernary(sizeInMeters, 1.0, mpp);
    positionEC.xy += (translate + pixelOffset) * mpp;
    return positionEC;
}

void main() {
    vec4 positionEC = modelViewMatrix * vec4(0.,0.,0., 1.0);

    float mpp;
    mat2 rotationMatrix;
    bool validAlignedAxis = false;
    float rotation = 0.0;
    bool sizeInMeters = false;

    vec3 alignedAxis = vec3(0.0);
    positionEC = addScreenSpaceOffset(
        positionEC,
        imageSize,
        scale,
        direction,
        origin,
        translate,
        pixelOffset,
        alignedAxis,
        validAlignedAxis,
        rotation,
        sizeInMeters,
        rotationMatrix,
        mpp
    );
    gl_Position = czm_projection * positionEC;


    vec2 textureCoordinatesBottomLeft = bottomLeft;
    vec2 textureCoordinatesRange = imageRectangle;
    vec2 textureCoordinates = textureCoordinatesBottomLeft + direction * textureCoordinatesRange;
    v_textureCoordinates = textureCoordinates;
}
`,Tb=`
precision highp float;
precision highp int;

#define SDF_EDGE 0.75
#define SDF_PX 8.0

uniform sampler2D u_atlas;
uniform vec3 fillColor;
uniform float fontSize;
uniform float u_device_pixel_ratio;
uniform float opacity;

uniform float isHalo;
uniform float halo_blur;
uniform vec3 outlineColor;
uniform float outlineWidth;

varying vec2 v_textureCoordinates;

void main() {
  float buff = (256.0 - 64.0) / 256.0;
  float fontScale = fontSize / 24.0;
  float EDGE_GAMMA = 0.105 / u_device_pixel_ratio;
  float gamma = EDGE_GAMMA / (fontScale);

  vec3 color = fillColor;

  if (isHalo > 0. ) {
    color = outlineColor;
    gamma = (halo_blur * 1.19 / SDF_PX + EDGE_GAMMA) / fontScale ;
    buff = (6.0 - outlineWidth / fontScale) / SDF_PX;
  }

  float dist = texture2D(u_atlas, v_textureCoordinates).a;
  float alpha = smoothstep(buff - gamma, buff + gamma, dist);

  gl_FragColor = vec4(color, alpha * opacity);

  if(isHalo > 0. && gl_FragColor.a < 0.95) {
    discard;
  }
}
`;class Rb{constructor(t){this.label=t,this.viewportV2=new ct}get frustum(){return this.label.ng.map.camera.isOrthographicCamera?this.frustumO:this.frustumP}getGeometry(e=[]){var t=new yy,i=(t.instanceCount=e.length,[]),s=[],r=[],n=[],a=[],h=[];for(let t=0;t<e.length;t++){var{bottomLeft:o,eyeOffset:l,imageHeight:u,imageWidth:c,imageRectangleSize:f,scale:d,translate:v}=e[t];i.push(o.x,o.y),s.push(l.x,l.y,l.z),r.push(c,u),n.push(f.width,f.height),h.push(v.x,v.y),a.push(d)}return t.setAttribute("bottomLeft",new Tg(new Float32Array(i),2)),t.setAttribute("eyeOffset",new Tg(new Float32Array(s),3)),t.setAttribute("imageSize",new Tg(new Float32Array(r),2)),t.setAttribute("imageRectangle",new Tg(new Float32Array(n),2)),t.setAttribute("scale",new Tg(new Float32Array(a),1)),t.setAttribute("translate",new Tg(new Float32Array(h),2)),t.setIndex([0,1,2,0,2,3]),t.setAttribute("direction",new N(new Float32Array([0,0,1,0,1,1,0,1]),2)),t}LE(t,e){var i=this.label.ng,s=i.map.camera,i=i.map.bt.renderer,r=new Y0(t.canvas),i=(r.minFilter=V,r.magFilter=V,s.updateMatrix(),s.updateProjectionMatrix(),i.getDrawingBufferSize(this.viewportV2),this.frustumP=new mb({fov:H.toRadians(s.fov||60),aspectRatio:this.viewportV2.x/this.viewportV2.y,near:s.near,far:s.far}),this.frustumO=new bb({width:i.domElement.clientWidth,aspectRatio:i.domElement.clientWidth/i.domElement.clientHeight,near:s.near,far:s.far,zoom:s.zoom}),s.isOrthographicCamera?this.frustumO:this.frustumP),i=(i.update(),i.yE),{fillColor:t,fontSize:n}=t;return{isHalo:{value:e},outlineColor:{value:this.label.outlineColor},outlineWidth:{value:this.label.outlineWidth},halo_blur:{value:1},czm_orthographicIn3D:{value:s.isOrthographicCamera?1:0},czm_currentFrustum:{value:[s.near,s.far]},czm_viewport:{value:[0,0,this.viewportV2.x,this.viewportV2.y]},czm_frustumPlanes:{value:[i.top,i.bottom,i.left,i.right]},czm_projection:{value:s.projectionMatrix},czm_viewMatrix:{value:s.matrixWorldInverse},u_atlas:{value:r},u_device_pixel_ratio:{value:this.label.pixelRatio},fontSize:{value:+n},fillColor:{value:t},pixelOffset:{value:this.label.pixelOffset},origin:{value:[mx.LEFT,this.label.verticalOrigin]},opacity:{value:this.label.opacity}}}init(t,e){if(this.label.rootNode){var s=this.getGeometry(t),t=this.LE(t[0],e),t=new Em({uniforms:t,fragmentShader:Tb,vertexShader:Ab,transparent:!0,wireframe:!1,depthTest:!1});let i=new L(s,t);i.frustumCulled=!1,i.onBeforeRender=()=>{var t=this.label.ng,e=t.map.camera,t=t.map.bt.renderer,t=(t.getDrawingBufferSize(this.viewportV2),this.frustumP.fov=H.toRadians(e.fov||60),this.frustumP.aspectRatio=this.viewportV2.x/this.viewportV2.y,this.frustumP.near=e.near,this.frustumP.far=e.far,this.frustumO.aspectRatio=t.domElement.clientWidth/t.domElement.clientHeight,this.frustumO.near=e.near,this.frustumO.far=e.far,this.frustumO.width=t.domElement.clientWidth,this.frustumO.zoom=e.zoom,e.isOrthographicCamera?this.frustumO:this.frustumP),t=(t.update(),t.yE);i.material.uniforms.czm_currentFrustum.value=[e.near,e.far],i.material.uniforms.czm_viewport.value=[0,0,this.viewportV2.x,this.viewportV2.y],i.material.uniforms.czm_projection.value=e.projectionMatrix,i.material.uniforms.czm_frustumPlanes.value=[t.top,t.bottom,t.left,t.right],i.material.uniforms.czm_orthographicIn3D.value=e.isOrthographicCamera?1:0,i.material.uniforms.pixelOffset.value=this.label.pixelOffset,i.material.uniforms.origin.value=[mx.LEFT,this.label.verticalOrigin],i.material.uniforms.fillColor.value=this.label.Eg,i.material.uniforms.u_device_pixel_ratio.value=this.label.pixelRatio,i.material.uniforms.opacity.value=this.label.opacity},i.renderOrder=e?-1:1;s=e?"labelMeshInstance":"labelOutlineMeshInstance";this.label.rootNode.add(i),(this.label[s]=this).mesh=i}}}class Lb{constructor(){this.CE=[],this.NE=[],this.label=null}add(t={}){t=new _x(t,this);return t.IE=this.CE.length,this.CE.push(t),t}createMeshInstance(e){if(0!=e.length){this.label.wg=!1;var i=[];for(let t=0;t<e.length;t++){var s=e[t],{scale:r,pixelOffset:n,pickPrimitive:a,Qy:h,eE:o,iE:l,tE:u}=s,c=s.rE;if(-1===c)break;var{width:c,height:f,x:d,y:v}=this.hE.textureCoordinates[c],p=this.hE.Ov.width,m=this.hE.Ov.height,p=Math.round(g(s.width,p*c)),m=Math.round(g(s.height,m*f));i.push({fontSize:a.PM,sE:s.sE,bottomLeft:{x:d,y:v},imageRectangleSize:{width:c,height:f},fillColor:s.color,show:1,scale:r,pixelOffset:n,imageWidth:p,imageHeight:m,eyeOffset:u,translate:{x:h.x,y:h.y},verticalOrigin:o,horizontalOrigin:l,canvas:this.hE.texture.canvas})}0===i.length?this.label.wg=!0:(new Rb(this.label).init(i,!1),new Rb(this.label).init(i,!0))}}update(){var e=this.NE.length,t=this.hE.textureCoordinates;if(0!==t.length){for(let t=0;t<e;++t)this.NE[t].wg=!1;this.createMeshInstance(this.NE),this.NE.length=0}}}Object.assign(Lb.prototype,{$y(t){this.NE.push(t)}});let Cb={FILL:0,OUTLINE:1,FILL_AND_OUTLINE:2};var Nb=Object.freeze(Cb);let Ib={FONT_SIZE:48,PADDING:10,RADIUS:12,CUTOFF:.25};var Pb=Object.freeze(Ib);function Db(n,a,h,o,l){var u=n.measureText(a);if(!/\S/.test(a))return{width:u.width,height:0,ascent:0,descent:0,minx:0};{var c=document.defaultView.getComputedStyle(n.canvas).getPropertyValue("font-size").replace("px","")||Pb.FONT_SIZE,f=document.createElement("canvas"),d=u.width+100|0,v=3*c,c=v/2,p=(f.width=d,f.height=v,f.getContext("2d")),m=(p.font=h,p.fillStyle="white",p.fillRect(0,0,f.width+1,f.height+1),o&&(p.strokeStyle="black",p.lineWidth=n.lineWidth,p.strokeText(a,50,c)),l&&(p.fillStyle="black",p.fillText(a,50,c)),p.getImageData(0,0,d,v).data),g=m.length,_=4*d;let t,e,i,s;for(t=0;t<g;++t)if(255!==m[t]){i=t/_|0;break}for(t=g-1;0<=t;--t)if(255!==m[t]){s=t/_|0;break}let r=-1;for(t=0;t<d&&-1===r;++t)for(e=0;e<v;++e){var w=4*t+e*_;if(255!==m[w]||255!==m[1+w]||255!==m[2+w]||255!==m[3+w]){r=t;break}}return{width:u.width,height:s-i,ascent:c-i,descent:s-c,minx:r-50}}}function Ob(t){t=t.match(/\b\d+(?=px\b)/);if(null!==t)return parseInt(t[0])}function Ub(t){return/[\u4e00-\u9fa5]/.test(t)}let Fb;function Bb(t,e){if(!C(t))throw new m("text is required.");var i,s,r,n,a,h,o,l,u,c,f,d,v,p;if(""!==t)return e=g(e,g.EMPTY_OBJECT),i=g(e.font,"10px sans-serif"),s=g(e.stroke,!1),r=g(e.fill,!0),n=g(e.strokeWidth,1),a=g(e.backgroundColor,ox.TRANSPARENT),v=2*(h=g(e.padding,0)),(o=document.createElement("canvas")).width=1,o.height=1,o.style.font=i,l=o.getContext("2d",{willReadFrequently:!0}),C(Fb)||(C(l.imageSmoothingEnabled)?Fb="imageSmoothingEnabled":C(l.mozImageSmoothingEnabled)?Fb="mozImageSmoothingEnabled":C(l.webkitImageSmoothingEnabled)?Fb="webkitImageSmoothingEnabled":C(l.msImageSmoothingEnabled)&&(Fb="msImageSmoothingEnabled")),l.font=i,l.lineJoin="round",l.lineWidth=n,l[Fb]=!1,p=(Ob(i)||0)/(Ub(t)?11:15),l.textBaseline="alphabetic",o.style.visibility="hidden",document.body.appendChild(o),d=Db(l,t,i,s,r),o.dimensions=d,document.body.removeChild(o),o.style.visibility="",u=-d.minx,c=Math.ceil(d.width)+u+v,d=(f=d.height+v)-(f-d.ascent+h)+v-p,o.width=c,o.height=f,l.font=i,l.lineJoin="round",l.lineWidth=n,l[Fb]=!1,a!==ox.TRANSPARENT&&(l.fillStyle=a.getStyle(),l.fillRect(0,0,o.width,o.height)),s&&(v=g(e.strokeColor,ox.BLACK),l.strokeStyle=v.getStyle(),l.strokeText(t,u+h,d)),r&&(p=g(e.fillColor,ox.WHITE),l.fillStyle=p.getStyle(),l.fillText(t,u+h,d)),o}class kb{constructor(t,e,i){this.labelCollection=t,this.index=e,this.dimensions=i}}var Gb=1e20;function Hb(t,e){var i,s,r,n,a,h=null==(e=e||{}).cutoff?.25:e.cutoff,o=null==e.radius?8:e.radius,l=e.channel||0;if(ArrayBuffer.isView(t)||Array.isArray(t)){if(!e.width||!e.height)throw Error("For raw data width and height should be provided by options");i=e.width,s=e.height,r=t,a=e.stride||Math.floor(t.length/i/s)}else window.HTMLCanvasElement&&t instanceof window.HTMLCanvasElement?(f=(d=t).getContext("2d"),i=d.width,s=d.height,r=(v=f.getImageData(0,0,i,s)).data,a=4):window.CanvasRenderingContext2D&&t instanceof window.CanvasRenderingContext2D?(i=(d=t.canvas).width,r=(v=(f=t).getImageData(0,0,i,s=d.height)).data,a=4):window.ImageData&&t instanceof window.ImageData&&(i=(v=t).width,s=t.height,r=v.data,a=4);if(e=Math.max(i,s),window.Uint8ClampedArray&&r instanceof window.Uint8ClampedArray||window.Uint8Array&&r instanceof window.Uint8Array)for(n=r,r=Array(i*s),p=0,m=Math.floor(n.length/a);p<m;p++)r[p]=n[p*a+l]/255;else if(1!==a)throw Error("Raw data can have only 1 value per pixel");for(var u=Array(i*s),c=Array(i*s),f=Array(e),d=Array(e),t=Array(e+1),v=Array(e),p=0,m=i*s;p<m;p++){var g=r[p];u[p]=1===g?0:0===g?Gb:Math.pow(Math.max(0,.5-g),2),c[p]=1===g?Gb:0===g?0:Math.pow(Math.max(0,g-.5),2)}Vb(u,i,s,f,d,v,t),Vb(c,i,s,f,d,v,t);var _=new(window.Float32Array?Float32Array:Array)(i*s);for(p=0,m=i*s;p<m;p++)_[p]=Math.min(Math.max(1-((u[p]-c[p])/o+h),0),1);return _}function Vb(t,e,i,s,r,n,a){for(var h=0;h<e;h++){for(var o=0;o<i;o++)s[o]=t[o*e+h];for(zb(s,r,n,a,i),o=0;o<i;o++)t[o*e+h]=r[o]}for(o=0;o<i;o++){for(h=0;h<e;h++)s[h]=t[o*e+h];for(zb(s,r,n,a,e),h=0;h<e;h++)t[o*e+h]=Math.sqrt(r[h])}}function zb(t,e,i,s,r){s[i[0]=0]=-Gb,s[1]=+Gb;for(var n=1,a=0;n<r;n++){for(var h=(t[n]+n*n-(t[i[a]]+i[a]*i[a]))/(2*n-2*i[a]);h<=s[a];)a--,h=(t[n]+n*n-(t[i[a]]+i[a]*i[a]))/(2*n-2*i[a]);i[++a]=n,s[a]=h,s[a+1]=+Gb}for(a=n=0;n<r;n++){for(;s[a+1]<n;)a++;e[n]=(n-i[a])*(n-i[a])+t[i[a]]}}class Wb{constructor(){this.textureInfo=null,this.dimensions=null}}class jb{constructor(t,e,i,s){this.x=g(t,0),this.y=g(e,0),this.width=g(i,0),this.height=g(s,0)}}let Xb={},Yb=0,Zb=256;function qb(t,e){return document.defaultView.getComputedStyle(t,null).getPropertyValue(e)}function Kb(t,e){e.textureInfo=void 0,e.dimensions=void 0;var i=e.billboard;i&&(i.show=!1,i.image=void 0,i.PE&&(i.PE(),i.PE=void 0),e.billboard=void 0)}let Jb={};function $b(t,e,i,s,r,n,a){return Jb.font=e,Jb.fillColor=i,Jb.strokeColor=s,Jb.strokeWidth=r,Jb.padding=Pb.PADDING,a===vx.CENTER?Jb.textBaseline="middle":a===vx.TOP?Jb.textBaseline="top":Jb.textBaseline="bottom",Jb.fill=n===Nb.FILL||n===Nb.FILL_AND_OUTLINE,Jb.stroke=n===Nb.OUTLINE||n===Nb.FILL_AND_OUTLINE,Jb.backgroundColor=ox.BLACK,Bb(t,Jb)}function Qb(e){let i=Xb[e.DE];if(!i){var s=document.createElement("div");s.style.position="absolute",s.style.opacity=0,s.style.font=e.DE,document.body.appendChild(s);let t=parseFloat(qb(s,"line-height"));isNaN(t)&&(t=void 0),i={family:qb(s,"font-family"),size:qb(s,"font-size").replace("px",""),style:qb(s,"font-style"),weight:qb(s,"font-weight"),lineHeight:t},document.body.removeChild(s),Yb<Zb&&(Xb[e.DE]=i,Yb++)}e.h3=i.family,e.PM=i.size,e.OE=i.style,e.UE=i.weight,e.FE=i.lineHeight}function tS(t,e,i,s){t=$b(t,`${e.OE} ${e.UE} ${Pb.FONT_SIZE}px `+e.h3,ox.WHITE,ox.WHITE,0,Nb.FILL,s),e=new kb(i,-1,t.dimensions);if(0<t.width&&0<t.height){var r=Hb(t,{cutoff:Pb.CUTOFF,radius:Pb.RADIUS}),s=t.getContext("2d"),n=t.width,a=t.height,h=s.getImageData(0,0,n,a);for(let e=0;e<n;e++)for(let t=0;t<a;t++){var o=t*n+e,l=255*r[o],o=4*o;h.data[0+o]=l,h.data[1+o]=l,h.data[2+o]=l,h.data[3+o]=l}s.putImageData(h,0,0)}return{glyphTextureInfo:e,canvas:t}}function eS(i,s){var t=s.tg,r=t,e=t.length,n=s.BE,a=n.length;let h,o,l;if(s.kE=s.PM/Pb.FONT_SIZE,e<a)for(o=e;o<a;++o)Kb(i,n[o]);n.length=e;t=s._showBackground&&0<t.split("\n").join("").length;let u=s.GE;var c=i._backgroundBillboardCollection,f=(t?(C(u)||(u=c.add({collection:i,image:hS,imageSubRegion:oS}),s.GE=u),u.color=s.Aw,u.show=s.Ef,u.position=s._position,u.eyeOffset=s.tE,u.pixelOffset=s.HE,u.horizontalOrigin=mx.LEFT,u.verticalOrigin=s.eE,u.heightReference=s._heightReference,u.scale=s.totalScale,u.pickPrimitive=s,u.id=s.Ht,u.translucencyByDistance=s._translucencyByDistance,u.pixelOffsetScaleByDistance=s._pixelOffsetScaleByDistance,u.scaleByDistance=s._scaleByDistance,u.distanceDisplayCondition=s._distanceDisplayCondition,u.disableDepthTestDistance=s._disableDepthTestDistance):C(u)&&(c.remove(u),s.GE=u=void 0),i.Mg);for(l=0;l<e;++l){var d=r[l],v=s.eE,p=JSON.stringify([d,s.h3,s.OE,s.UE,+v]);let t=f[p],e;if(C(t)||(e=tS(d,s,i,v),t=e.glyphTextureInfo,f[p]=t," "!==d&&(t.index=i.hE.addImageSync(p,e.canvas))),C(h=n[l])?-1===t.index?Kb(i,h):C(h.textureInfo)&&(h.textureInfo=void 0):(h=new Wb,n[l]=h),h.textureInfo=t,h.dimensions=t.dimensions,-1!==t.index){let t=h.billboard;v=i.VE;C(t)||(0<v.length?t=v.pop():((t=i.Jy.add({collection:i})).zE=new ct,t.WE=new ct),h.billboard=t),t.show=s.Ef,t.position=s._position,t.eyeOffset=s.tE,t.pixelOffset=s.HE,t.horizontalOrigin=mx.LEFT,t.verticalOrigin=s.eE,t.heightReference=s._heightReference,t.scale=s.totalScale,t.pickPrimitive=s,t.id=s.Ht,t.image=p,t.translucencyByDistance=s._translucencyByDistance,t.pixelOffsetScaleByDistance=s._pixelOffsetScaleByDistance,t.scaleByDistance=s._scaleByDistance,t.distanceDisplayCondition=s._distanceDisplayCondition,t.disableDepthTestDistance=s._disableDepthTestDistance,t.jE=s.jE,t.outlineColor=s.outlineColor,s.style===Nb.FILL_AND_OUTLINE?(t.color=s.Eg,t.outlineWidth=s.outlineWidth):s.style===Nb.FILL?(t.color=s.Eg,t.outlineWidth=0):s.style===Nb.OUTLINE&&(t.color=ox.TRANSPARENT,t.outlineWidth=s.outlineWidth)}}s.XE=!0}function iS(t,e,i){return e===mx.CENTER?-t/2:e===mx.RIGHT?-(t+i.x):i.x}function sS(t,e,i,s,r){let n=0;return n=i===mx.CENTER?-t/2:i===mx.RIGHT?-(t+r.x):r.x,s===Rm.Left?n+=0:s===Rm.Right?n+=t-e+r.x:n+=t/2-e/2,n}let rS=new ct,nS=new ct,aS=1.2,hS="ID_WHITE_PIXEL",oS=new jb(1,1,1,1);function lS(t){var e=t.BE,i=t.tg;let s,r,n=0,a=0;var h=[];let o=Number.NEGATIVE_INFINITY,l=0,u=1,c;var f=e.length,d=t.GE,v=cx.clone(C(d)?t._backgroundPadding:cx.ZERO,nS);for(v.x/=t.kE,v.y/=t.kE,c=0;c<f;++c)"\n"===i.charAt(c)?(h.push(n),++u,n=0):(s=e[c],r=s.dimensions,l=Math.max(l,r.height-r.descent),o=Math.max(o,r.descent),n+=r.width-r.minx,c<f-1&&(n+=e[c+1].dimensions.minx),a=Math.max(a,n));h.push(n);var p=l+o,m=t.totalScale,g=t.iE,_=t.eE,w=t.xg;let M=0;var y=h[M];let E=iS(y,g,v);var x,w=sS(a,y,g,w,v),b=(y<a&&1<h.length&&(E=w),(C(t.FE)?t.FE:aS*t.PM)/t.kE),S=b*(u-1);let A=a,T=p+S,R=(C(d)&&(A+=2*v.x,T+=2*v.y,d.YE=g),rS.x=E*m,!(rS.y=0)),L=0;for(c=0;c<f;++c)"\n"===i.charAt(c)?(++M,L+=b,y=h[M],E=iS(y,g,v),rS.x=E*m,R=!0):(s=e[c],r=s.dimensions,_===vx.TOP?(rS.y=r.height-l-v.y,rS.y+=Pb.PADDING):_===vx.CENTER?rS.y=(S+r.height-l)/2:(_===vx.BASELINE?rS.y=S:rS.y=S+o+v.y,rS.y-=Pb.PADDING),rS.y=(rS.y-r.descent-L)*m,R&&(rS.x-=Pb.PADDING*m,R=!1),C(s.billboard)&&(s.billboard.fE(rS),s.billboard.zE.x=A,s.billboard.zE.y=T,s.billboard.YE=g),c<f-1&&(x=e[c+1],rS.x+=(r.width-r.minx+x.dimensions.minx)*m));C(d)&&0<i.split("\n").join("").length&&(E=g===mx.CENTER?-a/2-v.x:g===mx.RIGHT?-(a+2*v.x):0,rS.x=E*m,_===vx.TOP?rS.y=p-l-o:_===vx.CENTER?rS.y=(p-l)/2-o:_===vx.BASELINE?rS.y=-v.y-o:rS.y=0,rS.y=rS.y*m,d.width=A,d.height=T,d.fE(rS),d.WE=cx.clone(rS,d.WE))}class uS{constructor(t={},e){this.opacity=1,this.ng=e,this.yg=!1,this.tg="",this.DE=`16px '"Microsoft Yahei","",Tahoma,Arial'`,this.Eg=[0,0,0],this.xg="",this.BE=[],this.style=Nb.FILL,this.iE=mx.CENTER,this.eE=vx.CENTER,this.wM=g(t.scale,1),this.HE=t.pixelOffset||[0,0],this.tE=fx.clone(g(t.eyeOffset,fx.ZERO)),this.outlineColor=[0,0,0],this.outlineWidth=0,Qb(this)}get horizontalOrigin(){return this.iE}get verticalOrigin(){return this.eE}get text(){return this.tg}set text(t){if(this.tg!==t){if(this.tg="",-1<t.indexOf("%rn%")){var e=t.split("%rn%");for(let t=0;t<e.length;t++)this.tg+=e[t],this.tg+="\n";this.tg=this.tg.slice(0,this.tg.length-1)}else this.tg=t;this.yg=!0}}get font(){return this.DE}set font(t){this.DE!==t&&(this.DE=t,this.yg=!0,Qb(this))}get pixelOffset(){return this.HE}set pixelOffset(e){this.HE=e,this.ng.Jy.CE.forEach(t=>{t.pixelOffset=e})}get totalScale(){return this.wM*this.kE}get horizontalOrigin(){return this.iE}getScreenSpaceBoundingBox(s={x:0,y:0},t){var r=this;let n=0,a=0,h=0,o=0;var l=r.totalScale,e=r.GE;if(C(e))n=s.x+e.Qy.x,a=s.y-e.Qy.y,h=e.width*l,o=e.height*l,r.verticalOrigin===vx.BOTTOM||r.verticalOrigin===vx.BASELINE?a-=o:r.verticalOrigin===vx.CENTER&&(a-=.5*o);else{n=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY;let e=0,i=0;var u=r.BE,c=u.length;for(let t=0;t<c;++t){var f=u[t],d=f.billboard;if(C(d)){var v=s.x+d.Qy.x;let t=s.y-d.Qy.y;d=f.dimensions.width*l,f=f.dimensions.height*l;r.verticalOrigin===vx.BOTTOM||r.verticalOrigin===vx.BASELINE?t-=f:r.verticalOrigin===vx.CENTER&&(t-=.5*f),r.eE===vx.TOP?t+=Pb.PADDING*l:r.eE!==vx.BOTTOM&&r.eE!==vx.BASELINE||(t-=Pb.PADDING*l),n=Math.min(n,v),a=Math.min(a,t),e=Math.max(e,v+d),i=Math.max(i,t+f)}}h=e-n,o=i-a}return(t=C(t)?t:new jb).x=n,t.y=a,t.width=h,t.height=o,t}}function cS(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}let fS={DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,FUNC_ADD:32774,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,BLEND_COLOR:32773,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,STREAM_DRAW:35040,STATIC_DRAW:35044,DYNAMIC_DRAW:35048,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,CULL_FACE:2884,BLEND:3042,DITHER:3024,STENCIL_TEST:2960,DEPTH_TEST:2929,SCISSOR_TEST:3089,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CW:2304,CCW:2305,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,COMPRESSED_TEXTURE_FORMATS:34467,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_UNIFORMS:35718,ACTIVE_ATTRIBUTES:35721,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,NOTEQUAL:517,GEQUAL:518,ALWAYS:519,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,VENDOR:7936,RENDERER:7937,VERSION:7938,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,TEXTURE1:33985,TEXTURE2:33986,TEXTURE3:33987,TEXTURE4:33988,TEXTURE5:33989,TEXTURE6:33990,TEXTURE7:33991,TEXTURE8:33992,TEXTURE9:33993,TEXTURE10:33994,TEXTURE11:33995,TEXTURE12:33996,TEXTURE13:33997,TEXTURE14:33998,TEXTURE15:33999,TEXTURE16:34e3,TEXTURE17:34001,TEXTURE18:34002,TEXTURE19:34003,TEXTURE20:34004,TEXTURE21:34005,TEXTURE22:34006,TEXTURE23:34007,TEXTURE24:34008,TEXTURE25:34009,TEXTURE26:34010,TEXTURE27:34011,TEXTURE28:34012,TEXTURE29:34013,TEXTURE30:34014,TEXTURE31:34015,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,IMPLEMENTATION_COLOR_READ_TYPE:35738,IMPLEMENTATION_COLOR_READ_FORMAT:35739,COMPILE_STATUS:35713,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,CONTEXT_LOST_WEBGL:37442,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,BROWSER_DEFAULT_WEBGL:37444,COMPRESSED_RGB_S3TC_DXT1_EXT:33776,COMPRESSED_RGBA_S3TC_DXT1_EXT:33777,COMPRESSED_RGBA_S3TC_DXT3_EXT:33778,COMPRESSED_RGBA_S3TC_DXT5_EXT:33779,COMPRESSED_RGB_PVRTC_4BPPV1_IMG:35840,COMPRESSED_RGB_PVRTC_2BPPV1_IMG:35841,COMPRESSED_RGBA_PVRTC_4BPPV1_IMG:35842,COMPRESSED_RGBA_PVRTC_2BPPV1_IMG:35843,COMPRESSED_RGBA_ASTC_4x4_WEBGL:37808,COMPRESSED_RGB_ETC1_WEBGL:36196,COMPRESSED_RGBA_BPTC_UNORM:36492,HALF_FLOAT_OES:36193,DOUBLE:5130,READ_BUFFER:3074,UNPACK_ROW_LENGTH:3314,UNPACK_SKIP_ROWS:3315,UNPACK_SKIP_PIXELS:3316,PACK_ROW_LENGTH:3330,PACK_SKIP_ROWS:3331,PACK_SKIP_PIXELS:3332,COLOR:6144,DEPTH:6145,STENCIL:6146,RED:6403,RGB8:32849,RGBA8:32856,RGB10_A2:32857,TEXTURE_BINDING_3D:32874,UNPACK_SKIP_IMAGES:32877,UNPACK_IMAGE_HEIGHT:32878,TEXTURE_3D:32879,TEXTURE_WRAP_R:32882,MAX_3D_TEXTURE_SIZE:32883,UNSIGNED_INT_2_10_10_10_REV:33640,MAX_ELEMENTS_VERTICES:33e3,MAX_ELEMENTS_INDICES:33001,TEXTURE_MIN_LOD:33082,TEXTURE_MAX_LOD:33083,TEXTURE_BASE_LEVEL:33084,TEXTURE_MAX_LEVEL:33085,MIN:32775,MAX:32776,DEPTH_COMPONENT24:33190,MAX_TEXTURE_LOD_BIAS:34045,TEXTURE_COMPARE_MODE:34892,TEXTURE_COMPARE_FUNC:34893,CURRENT_QUERY:34917,QUERY_RESULT:34918,QUERY_RESULT_AVAILABLE:34919,STREAM_READ:35041,STREAM_COPY:35042,STATIC_READ:35045,STATIC_COPY:35046,DYNAMIC_READ:35049,DYNAMIC_COPY:35050,MAX_DRAW_BUFFERS:34852,DRAW_BUFFER0:34853,DRAW_BUFFER1:34854,DRAW_BUFFER2:34855,DRAW_BUFFER3:34856,DRAW_BUFFER4:34857,DRAW_BUFFER5:34858,DRAW_BUFFER6:34859,DRAW_BUFFER7:34860,DRAW_BUFFER8:34861,DRAW_BUFFER9:34862,DRAW_BUFFER10:34863,DRAW_BUFFER11:34864,DRAW_BUFFER12:34865,DRAW_BUFFER13:34866,DRAW_BUFFER14:34867,DRAW_BUFFER15:34868,MAX_FRAGMENT_UNIFORM_COMPONENTS:35657,MAX_VERTEX_UNIFORM_COMPONENTS:35658,SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,FRAGMENT_SHADER_DERIVATIVE_HINT:35723,PIXEL_PACK_BUFFER:35051,PIXEL_UNPACK_BUFFER:35052,PIXEL_PACK_BUFFER_BINDING:35053,PIXEL_UNPACK_BUFFER_BINDING:35055,FLOAT_MAT2x3:35685,FLOAT_MAT2x4:35686,FLOAT_MAT3x2:35687,FLOAT_MAT3x4:35688,FLOAT_MAT4x2:35689,FLOAT_MAT4x3:35690,SRGB:35904,SRGB8:35905,SRGB8_ALPHA8:35907,COMPARE_REF_TO_TEXTURE:34894,RGBA32F:34836,RGB32F:34837,RGBA16F:34842,RGB16F:34843,VERTEX_ATTRIB_ARRAY_INTEGER:35069,MAX_ARRAY_TEXTURE_LAYERS:35071,MIN_PROGRAM_TEXEL_OFFSET:35076,MAX_PROGRAM_TEXEL_OFFSET:35077,MAX_VARYING_COMPONENTS:35659,TEXTURE_2D_ARRAY:35866,TEXTURE_BINDING_2D_ARRAY:35869,R11F_G11F_B10F:35898,UNSIGNED_INT_10F_11F_11F_REV:35899,RGB9_E5:35901,UNSIGNED_INT_5_9_9_9_REV:35902,TRANSFORM_FEEDBACK_BUFFER_MODE:35967,MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS:35968,TRANSFORM_FEEDBACK_VARYINGS:35971,TRANSFORM_FEEDBACK_BUFFER_START:35972,TRANSFORM_FEEDBACK_BUFFER_SIZE:35973,TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN:35976,RASTERIZER_DISCARD:35977,MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS:35978,MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS:35979,INTERLEAVED_ATTRIBS:35980,SEPARATE_ATTRIBS:35981,TRANSFORM_FEEDBACK_BUFFER:35982,TRANSFORM_FEEDBACK_BUFFER_BINDING:35983,RGBA32UI:36208,RGB32UI:36209,RGBA16UI:36214,RGB16UI:36215,RGBA8UI:36220,RGB8UI:36221,RGBA32I:36226,RGB32I:36227,RGBA16I:36232,RGB16I:36233,RGBA8I:36238,RGB8I:36239,RED_INTEGER:36244,RGB_INTEGER:36248,RGBA_INTEGER:36249,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311,DEPTH_COMPONENT32F:36012,DEPTH32F_STENCIL8:36013,FLOAT_32_UNSIGNED_INT_24_8_REV:36269,FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING:33296,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE:33297,FRAMEBUFFER_ATTACHMENT_RED_SIZE:33298,FRAMEBUFFER_ATTACHMENT_GREEN_SIZE:33299,FRAMEBUFFER_ATTACHMENT_BLUE_SIZE:33300,FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE:33301,FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE:33302,FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE:33303,FRAMEBUFFER_DEFAULT:33304,UNSIGNED_INT_24_8:34042,DEPTH24_STENCIL8:35056,UNSIGNED_NORMALIZED:35863,DRAW_FRAMEBUFFER_BINDING:36006,READ_FRAMEBUFFER:36008,DRAW_FRAMEBUFFER:36009,READ_FRAMEBUFFER_BINDING:36010,RENDERBUFFER_SAMPLES:36011,FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER:36052,MAX_COLOR_ATTACHMENTS:36063,COLOR_ATTACHMENT1:36065,COLOR_ATTACHMENT2:36066,COLOR_ATTACHMENT3:36067,COLOR_ATTACHMENT4:36068,COLOR_ATTACHMENT5:36069,COLOR_ATTACHMENT6:36070,COLOR_ATTACHMENT7:36071,COLOR_ATTACHMENT8:36072,COLOR_ATTACHMENT9:36073,COLOR_ATTACHMENT10:36074,COLOR_ATTACHMENT11:36075,COLOR_ATTACHMENT12:36076,COLOR_ATTACHMENT13:36077,COLOR_ATTACHMENT14:36078,COLOR_ATTACHMENT15:36079,FRAMEBUFFER_INCOMPLETE_MULTISAMPLE:36182,MAX_SAMPLES:36183,HALF_FLOAT:5131,RG:33319,RG_INTEGER:33320,R8:33321,RG8:33323,R16F:33325,R32F:33326,RG16F:33327,RG32F:33328,R8I:33329,R8UI:33330,R16I:33331,R16UI:33332,R32I:33333,R32UI:33334,RG8I:33335,RG8UI:33336,RG16I:33337,RG16UI:33338,RG32I:33339,RG32UI:33340,VERTEX_ARRAY_BINDING:34229,R8_SNORM:36756,RG8_SNORM:36757,RGB8_SNORM:36758,RGBA8_SNORM:36759,SIGNED_NORMALIZED:36764,COPY_READ_BUFFER:36662,COPY_WRITE_BUFFER:36663,COPY_READ_BUFFER_BINDING:36662,COPY_WRITE_BUFFER_BINDING:36663,UNIFORM_BUFFER:35345,UNIFORM_BUFFER_BINDING:35368,UNIFORM_BUFFER_START:35369,UNIFORM_BUFFER_SIZE:35370,MAX_VERTEX_UNIFORM_BLOCKS:35371,MAX_FRAGMENT_UNIFORM_BLOCKS:35373,MAX_COMBINED_UNIFORM_BLOCKS:35374,MAX_UNIFORM_BUFFER_BINDINGS:35375,MAX_UNIFORM_BLOCK_SIZE:35376,MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS:35377,MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS:35379,UNIFORM_BUFFER_OFFSET_ALIGNMENT:35380,ACTIVE_UNIFORM_BLOCKS:35382,UNIFORM_TYPE:35383,UNIFORM_SIZE:35384,UNIFORM_BLOCK_INDEX:35386,UNIFORM_OFFSET:35387,UNIFORM_ARRAY_STRIDE:35388,UNIFORM_MATRIX_STRIDE:35389,UNIFORM_IS_ROW_MAJOR:35390,UNIFORM_BLOCK_BINDING:35391,UNIFORM_BLOCK_DATA_SIZE:35392,UNIFORM_BLOCK_ACTIVE_UNIFORMS:35394,UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES:35395,UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER:35396,UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER:35398,INVALID_INDEX:4294967295,MAX_VERTEX_OUTPUT_COMPONENTS:37154,MAX_FRAGMENT_INPUT_COMPONENTS:37157,MAX_SERVER_WAIT_TIMEOUT:37137,OBJECT_TYPE:37138,SYNC_CONDITION:37139,SYNC_STATUS:37140,SYNC_FLAGS:37141,SYNC_FENCE:37142,SYNC_GPU_COMMANDS_COMPLETE:37143,UNSIGNALED:37144,SIGNALED:37145,ALREADY_SIGNALED:37146,TIMEOUT_EXPIRED:37147,CONDITION_SATISFIED:37148,WAIT_FAILED:37149,SYNC_FLUSH_COMMANDS_BIT:1,VERTEX_ATTRIB_ARRAY_DIVISOR:35070,ANY_SAMPLES_PASSED:35887,ANY_SAMPLES_PASSED_CONSERVATIVE:36202,SAMPLER_BINDING:35097,RGB10_A2UI:36975,INT_2_10_10_10_REV:36255,TRANSFORM_FEEDBACK:36386,TRANSFORM_FEEDBACK_PAUSED:36387,TRANSFORM_FEEDBACK_ACTIVE:36388,TRANSFORM_FEEDBACK_BINDING:36389,COMPRESSED_R11_EAC:37488,COMPRESSED_SIGNED_R11_EAC:37489,COMPRESSED_RG11_EAC:37490,COMPRESSED_SIGNED_RG11_EAC:37491,COMPRESSED_RGB8_ETC2:37492,COMPRESSED_SRGB8_ETC2:37493,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:37494,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:37495,COMPRESSED_RGBA8_ETC2_EAC:37496,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:37497,TEXTURE_IMMUTABLE_FORMAT:37167,MAX_ELEMENT_INDEX:36203,TEXTURE_IMMUTABLE_LEVELS:33503,MAX_TEXTURE_MAX_ANISOTROPY_EXT:34047};var dS=Object.freeze(fS);let vS={DEPTH_COMPONENT:dS.DEPTH_COMPONENT,DEPTH_STENCIL:dS.DEPTH_STENCIL,ALPHA:dS.ALPHA,RED:dS.RED,RG:dS.RG,RGB:dS.RGB,RGBA:dS.RGBA,LUMINANCE:dS.LUMINANCE,LUMINANCE_ALPHA:dS.LUMINANCE_ALPHA,RGB_DXT1:dS.COMPRESSED_RGB_S3TC_DXT1_EXT,RGBA_DXT1:dS.COMPRESSED_RGBA_S3TC_DXT1_EXT,RGBA_DXT3:dS.COMPRESSED_RGBA_S3TC_DXT3_EXT,RGBA_DXT5:dS.COMPRESSED_RGBA_S3TC_DXT5_EXT,RGB_PVRTC_4BPPV1:dS.COMPRESSED_RGB_PVRTC_4BPPV1_IMG,RGB_PVRTC_2BPPV1:dS.COMPRESSED_RGB_PVRTC_2BPPV1_IMG,RGBA_PVRTC_4BPPV1:dS.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG,RGBA_PVRTC_2BPPV1:dS.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG,RGBA_ASTC:dS.COMPRESSED_RGBA_ASTC_4x4_WEBGL,RGB_ETC1:dS.COMPRESSED_RGB_ETC1_WEBGL,RGB8_ETC2:dS.COMPRESSED_RGB8_ETC2,RGBA8_ETC2_EAC:dS.COMPRESSED_RGBA8_ETC2_EAC,RGBA_BC7:dS.COMPRESSED_RGBA_BPTC_UNORM};var pS=Object.freeze(vS);class mS{constructor(t={}){this.Ht=cS(),this.width=t.width,this.height=t.height,this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.ctx=this.canvas.getContext("2d")}copyFrom(t={}){var e=g(t.xOffset,0),i=g(t.yOffset,0),t=t.source,s=this.canvas.height,r=t.width,n=t.height,t=t.getContext("2d").getImageData(0,0,r,n);this.ctx.putImageData(t,e,s-n-i)}}class gS{constructor(t,e,i,s,r){this.bottomLeft=g(t,cx.ZERO),this.topRight=g(e,cx.ZERO),this.childNode1=i,this.childNode2=s,this.imageIndex=r}}function _S(i,s){var t=i.numberOfImages,r=i.ZE;if(0<t){var t=i.Ov.width,e=i.Ov.height,n=2*(t+s.width+r),a=2*(e+s.height+r),h=t/n,o=e/a,t=new gS(new ct(t+r,r),new ct(n,e)),t=new gS(new ct,new ct(n,e),i.Mh,t),e=new gS(new ct(r,e+r),new ct(n,a)),t=new gS(new ct,new ct(n,a),t,e);for(let t=0;t<i.qE.length;t++){var l=i.qE[t];C(l)&&(l.x*=h,l.y*=o,l.width*=h,l.height*=o)}e=new mS({context:i._context,width:n,height:a,pixelFormat:i.KE});e.copyFrom({source:i.Ov.canvas}),i.Ov=e,i.Mh=t}else{let t=2*(s.width+2*r),e=2*(s.height+2*r);t<i.JE.x&&(t=i.JE.x),e<i.JE.y&&(e=i.JE.y),i.Ov=i.Ov&&i.Ov.destroy(),i.Ov=new mS({context:i._context,width:t,height:e,pixelFormat:i.KE}),i.Mh=new gS(new ct(r,r),new ct(t,e))}}function wS(t,e,i){var s,r;if(C(e))return C(e.childNode1)||C(e.childNode2)?wS(t,e.childNode1,i)||wS(t,e.childNode2,i):C(e.imageIndex)||(r=e.topRight.x-e.bottomLeft.x,s=e.topRight.y-e.bottomLeft.y,r=r-i.width,s=s-i.height,r<0)||s<0?void 0:0==r&&0==s?e:(s<r?(e.childNode1=new gS(new ct(e.bottomLeft.x,e.bottomLeft.y),new ct(e.bottomLeft.x+i.width,e.topRight.y)),(s=e.bottomLeft.x+i.width+t.ZE)<e.topRight.x&&(e.childNode2=new gS(new ct(s,e.bottomLeft.y),new ct(e.topRight.x,e.topRight.y)))):(e.childNode1=new gS(new ct(e.bottomLeft.x,e.bottomLeft.y),new ct(e.topRight.x,e.bottomLeft.y+i.height)),(r=e.bottomLeft.y+i.height+t.ZE)<e.topRight.y&&(e.childNode2=new gS(new ct(e.bottomLeft.x,r),new ct(e.topRight.x,e.topRight.y)))),wS(t,e.childNode1,i))}function MS(t,e,i){var s,r,n,a,h,o,l=wS(t,t.Mh,e);C(l)?(l.imageIndex=i,o=t.Ov.width,s=t.Ov.height,h=l.topRight.x-l.bottomLeft.x,r=l.topRight.y-l.bottomLeft.y,n=l.bottomLeft.x/o,a=l.bottomLeft.y/s,h=h/o,o=r/s,t.qE[i]=new jb(n,a,h,o),t.Ov.copyFrom({source:e,xOffset:l.bottomLeft.x,yOffset:l.bottomLeft.y})):(_S(t,e),MS(t,e,i)),t.$E=cS()}function yS(t,e){return!C(t)||t.isDestroyed()?-1:(MS(t,e,e=t.numberOfImages),e)}let ES=new ct(16,16);class xS{constructor(t={}){var e=g(t.borderWidthInPixels,1),i=g(t.initialSize,ES);this.KE=g(t.pixelFormat,pS.RGBA),this.ZE=e,this.qE=[],this.$E=cS(),this.QE={},this.tx={},this.JE=i,this.Mh=void 0}get numberOfImages(){return this.qE.length}get textureCoordinates(){return this.qE}get texture(){return this.Ov}addImageSync(t,e){if(!C(t))throw new m("id is required.");var i;if(C(e))return C(i=this.tx[t])||(i=yS(this,e),this.QE[t]=Promise.resolve(i),this.tx[t]=i),i;throw new m("image is required.")}isDestroyed(){return!1}addImage(t){var e=this.QE[t];return C(e)||(this.QE[t]=e),e}}class bS{constructor(){this.map=null,this.Mg={},this.VE=[],this.L2=[],this.hE=new xS,this.Jy=new Lb,this.Jy.hE=this.hE}add(t){t=new uS(t,this);return this.L2.push(t),this.Jy.label=t}update(){var e=this.L2.length;for(let t=0;t<e;t++){var i=this.L2[t];i.yg&&(eS(this,i),i.yg=!1),i.XE&&(lS(i),i.XE=!1)}this.Jy.update()}}var SS={exports:{}},AS=(SS.exports,(t=>{var e,i;e=ha,i=function(){var l,r={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},n=(l=r.defaultRadius,t.prototype={ix:function(t,e){var i=t[this.sx],s=t[this.nx],r=this.hx,n=this.qs,a=this.fi,h=this.ci,o=t[this.ox]||1,t=t.radius||this.lx||l,r=(n[i]||(n[i]=[],r[i]=[]),n[i][s]?n[i][s]+=o:(n[i][s]=o,r[i][s]=t),n[i][s]);return a<r?(e?this.setDataMax(r):this.fi=r,!1):r<h?(e?this.setDataMin(r):this.ci=r,!1):{x:i,y:s,value:o,radius:t,min:h,max:a}},ux:function(){var t,e=[],i=this.qs,s=this.hx;for(t in i)for(var r in i[t])e.push({x:t,y:r,radius:s[t][r],value:i[t][r]});return{min:this.ci,max:this.fi,data:e}},vx:function(){this.mx.emit("extremachange",{min:this.ci,max:this.fi})},addData:function(){if(0<arguments[0].length)for(var t=arguments[0],e=t.length;e--;)this.addData.call(this,t[e]);else{var i=this.ix(arguments[0],!0);i&&(0===this.qs.length&&(this.ci=this.fi=i.value),this.mx.emit("renderpartial",{min:this.ci,max:this.fi,data:[i]}))}return this},setData:function(t){var e=t.data,i=e.length;this.qs=[],this.hx=[];for(var s=0;s<i;s++)this.ix(e[s],!1);return this.fi=t.max,this.ci=t.min||0,this.vx(),this.mx.emit("renderall",this.gx()),this},removeData:function(){},setDataMax:function(t){return this.fi=t,this.vx(),this.mx.emit("renderall",this.gx()),this},setDataMin:function(t){return this.ci=t,this.vx(),this.mx.emit("renderall",this.gx()),this},setCoordinator:function(t){this.mx=t},gx:function(){return{max:this.fi,min:this.ci,data:this.qs,radi:this.hx}},getData:function(){return this.ux()}},t);function t(t){this.mx={},this.qs=[],this.hx=[],this.ci=10,this.fi=1,this.sx=t.xField||t.defaultXField,this.nx=t.yField||t.defaultYField,this.ox=t.valueField||t.defaultValueField,t.radius&&(this.lx=t.radius)}function s(t){var e,i=t.gradient||t.defaultGradient,s=(t=document.createElement("canvas")).getContext("2d"),r=(t.width=256,t.height=1,s.createLinearGradient(0,0,256,1));for(e in i)r.addColorStop(e,i[e]);return s.fillStyle=r,s.fillRect(0,0,256,1),s.getImageData(0,0,256,1).data}function e(t){var e=this.shadowCanvas=document.createElement("canvas"),i=this.canvas=t.canvas;this._x=[1e4,1e4,0,0],e.width=i.width,e.height=i.height,this.Tp=i.width,this.Jt=i.height,this.shadowCtx=e.getContext("2d"),this.ctx=i.getContext("2d"),this.wx=s(t),this.Mx={},this.yx(t)}i=!(e.prototype={renderPartial:function(t){0<t.data.length&&(this.Ex(t),this.xx())},renderAll:function(t){this.Ja(),0<t.data.length&&(this.Ex((t=>{for(var e=[],i=t.min,s=t.max,r=t.radi,t=t.data,n=Object.keys(t),a=n.length;a--;)for(var h=n[a],o=Object.keys(t[h]),l=o.length;l--;){var u=o[l],c=t[h][u],f=r[h][u];e.push({x:h,y:u,value:c,radius:f})}return{min:i,max:s,data:e}})(t)),this.xx())},bx:function(t){this.wx=s(t)},updateConfig:function(t){t.gradient&&this.bx(t),this.yx(t)},setDimensions:function(t,e){this.Tp=t,this.Jt=e,this.canvas.width=this.shadowCanvas.width=t,this.canvas.height=this.shadowCanvas.height=e},Ja:function(){this.shadowCtx.clearRect(0,0,this.Tp,this.Jt),this.ctx.clearRect(0,0,this.Tp,this.Jt)},yx:function(t){this.Sn=0==t.blur?0:t.blur||t.defaultBlur,t.backgroundColor&&(this.canvas.style.backgroundColor=t.backgroundColor),this.Tp=this.canvas.width=this.shadowCanvas.width=t.width||this.Tp,this.Jt=this.canvas.height=this.shadowCanvas.height=t.height||this.Jt,this.Kr=255*(t.opacity||0),this.U3=255*(t.maxOpacity||t.defaultMaxOpacity),this.F3=255*(t.minOpacity||t.defaultMinOpacity),this.Sx=!!t.useGradientOpacity},Ex:function(t){for(var e,i,s,r,n,a=this.ci=t.min,h=this.fi=t.max,o=(t=t.data||[]).length,l=1-this.Sn;o--;){var u,c=t[o],f=c.x,d=c.y,v=c.radius,c=Math.min(c.value,h),f=f-v,d=d-v,p=this.shadowCtx,m=(this.Mx[v]?u=this.Mx[v]:this.Mx[v]=(e=v,i=l,n=m=r=s=void 0,s=document.createElement("canvas"),r=s.getContext("2d"),n=m=e,s.width=s.height=2*e,1==i?(r.beginPath(),r.arc(m,n,e,0,2*Math.PI,!1),r.fillStyle="rgba(0,0,0,1)",r.fill()):((i=r.createRadialGradient(m,n,e*i,m,n,e)).addColorStop(0,"rgba(0,0,0,1)"),i.addColorStop(1,"rgba(0,0,0,0)"),r.fillStyle=i,r.fillRect(0,0,2*e,2*e)),u=s),(c-a)/(h-a));p.globalAlpha=m<.01?.01:m,p.drawImage(u,f,d),f<this._x[0]&&(this._x[0]=f),d<this._x[1]&&(this._x[1]=d),f+2*v>this._x[2]&&(this._x[2]=f+2*v),d+2*v>this._x[3]&&(this._x[3]=d+2*v)}},xx:function(){for(var t=this._x[0],e=this._x[1],i=this._x[2]-t,s=this._x[3]-e,r=this.Tp,n=this.Jt,a=this.Kr,h=this.U3,o=this.F3,l=this.Sx,r=this.shadowCtx.getImageData(t=t<0?0:t,e=e<0?0:e,i=r<t+i?r-t:i,s=n<e+s?n-e:s),u=r.data,c=u.length,f=this.wx,d=3;d<c;d+=4){var v=u[d],p=4*v;p&&(v=0<a?a:v<h?v<o?o:v:h,u[d-3]=f[p],u[d-2]=f[1+p],u[d-1]=f[2+p],u[d]=l?f[3+p]:v)}this.ctx.putImageData(r,t,e),this._x=[1e3,1e3,0,0]},getValueAt:function(t){var t=this.shadowCtx.getImageData(t.x,t.y,1,1).data[3],e=this.fi,i=this.ci;return Math.abs(e-i)*(t/255)>>0},getDataURL:function(){return this.canvas.toDataURL()}});var i,a,h=i="canvas2d"===r.defaultRenderer?e:i,o=function(){for(var t={},e=arguments.length,i=0;i<e;i++){var s,r=arguments[i];for(s in r)t[s]=r[s]}return t},u=(c.prototype={on:function(t,e,i){var s=this.cStore;s[t]||(s[t]=[]),s[t].push(function(t){return e.call(i,t)})},emit:function(t,e){var i=this.cStore;if(i[t])for(var s=i[t].length,r=0;r<s;r++)(0,i[t][r])(e)}},a=c,f.prototype={addData:function(){return this.Ax.addData.apply(this.Ax,arguments),this},removeData:function(){return this.Ax.removeData&&this.Ax.removeData.apply(this.Ax,arguments),this},setData:function(){return this.Ax.setData.apply(this.Ax,arguments),this},setDataMax:function(){return this.Ax.setDataMax.apply(this.Ax,arguments),this},setDataMin:function(){return this.Ax.setDataMin.apply(this.Ax,arguments),this},configure:function(t){return this.Tx=o(this.Tx,t),this.un.updateConfig(this.Tx),this.mx.emit("renderall",this.Ax.gx()),this},repaint:function(){return this.mx.emit("renderall",this.Ax.gx()),this},getData:function(){return this.Ax.getData()},getDataURL:function(){return this.un.getDataURL()},getValueAt:function(t){return this.Ax.getValueAt?this.Ax.getValueAt(t):this.un.getValueAt?this.un.getValueAt(t):null}},f);function c(){this.cStore={}}function f(){var e,t,i=this.Tx=o(r,arguments[0]||{});if(this.mx=new a,i.plugin){var s=i.plugin;if(!r.plugins[s])throw new Error("Plugin '"+s+"' not found. Maybe it was not registered.");var s=r.plugins[s];this.un=new s.renderer(i),this.Ax=new s.store(i)}else this.un=new h(i),this.Ax=new n(i);s=(e=this).un,i=e.mx,t=e.Ax,i.on("renderpartial",s.renderPartial,s),i.on("renderall",s.renderAll,s),i.on("extremachange",function(t){e.Tx.onExtremaChange&&e.Tx.onExtremaChange({min:t.min,max:t.max,gradient:e.Tx.gradient||e.Tx.defaultGradient})}),t.setCoordinator(i)}return{create:function(t){return new u(t)},register:function(t,e){r.plugins[t]=e}}},t.exports?t.exports=i():e.h337=i()})(SS),SS.exports),TS=oa(AS),RS;class LS{static getPointFromBound(t){var e=t.min.x,i=t.min.y,s=t.max.x,t=t.max.y;return[{x:e,y:i},{x:e,y:t},{x:s,y:i},{x:s,y:t}]}static getBoundFromPoint(e){let i=e[0].x,s=e[0].y,r=e[0].x,n=e[0].y;for(let t=0;t<e.length;t++){var a=e[t];i>a.x&&(i=a.x),s>a.y&&(s=a.y),r<a.x&&(r=a.x),n<a.y&&(n=a.y)}return{max:{x:r,y:n},min:{x:i,y:s},size:{x:r-i,y:n-s}}}static getRotationBound(t,i){var e=new Gt(0,1,0),s=(new Ht).makeRotationAxis(e,i.getRotation()*Math.PI/180),r=LS.getPointFromBound(t),n=[];for(let e=0;e<r.length;e++){let t=new Gt(r[e].x-i.x,0,i.y-r[e].y);t=t.applyMatrix4(s),n.push(t)}var a=[];for(let t=0;t<r.length;t++){var h=n[t];a.push({x:h.x+i.x,y:i.y-h.z})}return LS.getBoundFromPoint(a)}}class M{static showFloorNode(i,t){for(let e=0;e<t.Ft.length;e++){var s=t.Ft[e];if(-1<i.getVisibleLevels().indexOf(t.level))for(let t=0;t<s.Ft.length;t++){var r=s.Ft[t];r.Zs||1!=r.visible||i.Wt.Ua.push([e,r])}}}static showAllNode(e){for(e.getLevels().forEach(t=>{M.showFloorNode(e,e.getFloor(t))});0<e.Wt.Ua.length;)e.Wt.Fa()}static recoveAllNode(t){t.enableUpdateNode(),t.Wt.Oa()}static setVisibleLevelsFrustumCulled(t,e){var i=t.bt,s=t.getVisibleLevels();for(let t=0;t<s.length;t++){var r=s[t]+"_"+p.LABEL,n=s[t]+"_"+p.FACILITY,a=s[t]+"_"+p.TEXT_MARKER,h=s[t]+"_"+p.IMAGE_MARKER,r=i.rn.get(r),n=i.rn.get(n),a=i.rn.get(a),h=i.rn.get(h),o=[];r&&r.children&&o.push(...r.children),n&&n.children&&o.push(...n.children),a&&a.children&&o.push(...a.children),h&&h.children&&o.push(...h.children),o.forEach(t=>{t.frustumCulled=e})}}static setValue(t,e,i){i[t]=e}static getValue(t,e){return e[t]}static addLastFrame(e,i){let s=window.devicePixelRatio||1;var t=e.bt.renderer;let r=t.domElement.parentElement,n=t.domElement.clientWidth,a=t.domElement.clientHeight;var h=document.createElement("canvas");h.width=n*s,h.height=a*s,h.style.width=n+"px",h.style.height=a+"px",h.style.position="absolute",h.style.zIndex=1,h.className="exportImageLastFrame";let o=h.getContext("2d"),l=new Image;l.onload=t=>{o.drawImage(t.path[0],0,0,n*s,a*s),r.append(h),e.Yt.Xt({type:"printBefor"}),i()},l.onerror=t=>{console.warn("fail...",t)},e.bt.render(),l.src=t.domElement.toDataURL()}static removeLastFrame(t){var e=t.bt.renderer,i=document.querySelector(".exportImageLastFrame"),e=e.domElement.parentElement;e&&i&&e.removeChild(i),t.Yt.Xt({type:"printAfter"})}static start(t){var e={callback:null,viewParam:{width:0,height:0},state:{col:0,row:0,loadCount:0},camera:null,backCamera:null,width:0,height:0,padding:0,canvas:null,renderTarget:null,cameraType:null,defaultLogoAspact:null};let{padding:i,map:s,imageWidth:r,imageHieght:n,callback:a,bound:h,cameraType:o}=t;h&&(M.setValue("originBound",{max:{x:h.max.x,y:h.max.y},min:{x:h.min.x,y:h.min.y}},e),h.size||(h.size.x=h.max.x-h.min.x,h.size.y=h.max.y-h.min.y),t=r/h.size.x,u=n/h.size.y,l=LS.getRotationBound(h,s),h=l,Math.abs(u-t)<.1)&&(r=h.size.x*t,n=h.size.y*u),M.setValue("mapZoom",s.getZoom(),e),M.setValue("cameraType",o||"2d",e),"2d"==e.cameraType?M.setValue("backCamera",s.ct,e):M.setValue("backCamera",{aspect:s.ct.aspect},e);var l=r/n,t=(15e3<r&&(r=15e3,n=+r/l),15e3<n&&(n=15e3,r=n*l),i=i||0,i*=2,r=Math.ceil(r),n=Math.ceil(n),M.setValue("width",r,e),M.setValue("height",n,e),s.bt.renderer.domElement.clientWidth),u=s.bt.renderer.domElement.clientHeight,l=(M.setValue("defaultLogoAspact",t/u,e),M.setValue("domSize",{width:t,height:u},e),M.setValue("padding",i,e),M.setValue("callback",a,e),{width:r,height:n}),t=(4096<l.width&&(l.width=4096),4096<l.height&&(l.height=4096),M.setValue("viewParam",l,e),Math.ceil(r/e.viewParam.width)),u=Math.ceil(n/e.viewParam.height),t=(M.setValue("state",{col:t,row:u,loadCount:0},e),document.createElement("canvas"));t.width=r,t.height=n,t.style.width=r+"px",t.style.height=n+"px",M.setValue("canvas",t,e),"2d"==e.cameraType?(u=M.getCameraParame2d(s,r,n,h,i,void 0,e),M.setValue("camera",u,e),s.ct=u):"3d"==e.cameraType&&M.setCameraParame3d(s,r,n,null,i,e),s.bt.renderer.setPixelRatio(1),s.bt.renderer.setSize(l.width,l.height),s.Yt.Xt({type:"viewModeChanged"}),M.shot(s,t,e)}static print(t){M.addLastFrame(t.map,()=>{M.start(t)})}static recoverParam(t,e){"2d"===e.cameraType?(t.ct=M.getValue("backCamera",e),t.Lt=t.ct):"3d"===e.cameraType&&(i=M.getValue("backCamera",e),t.ct.aspect=i.aspect,t.ct.clearViewOffset());var i=M.getValue("domSize",e),s=window.devicePixelRatio||1;t.bt.renderer.setPixelRatio(s),t.bt.renderer.setSize(i.width,i.height),t.Yt.Xt({type:"viewModeChanged"}),M.recoveAllNode(t,e),M.setLogo(t,M.getValue("defaultLogoAspact",e)),t.bi.yt.object=t.ct,M.setVisibleLevelsFrustumCulled(t,!0),t.bt.xt(),t.bt.ma=!0,t.bt.renderer.clear(),t.bt.render(),t.enableUpdateNode(),M.removeLastFrame(t)}static getCameraParame2d(t,e,i,s,r,n,a){var h,o,l,u,c=Math.min(e,i),n=n||(c-r)/c,r=t.getState(),{min:c,max:s}=s,f=Math.abs(s.x-c.x),s=Math.abs(s.y-c.y),c=e/i,e=(c<s/f?(l=-f/2,u=f/2,h=-f/c/2,o=f/c/2):(h=-s/2,o=s/2,l=-s*c/2,u=s*c/2),new sr(l,u,o,h,1,1e4)),i=(e.zoom=n,e.up=new Gt(0,1,0),e.rotation.x=-Math.PI/2,e.rotation.y=0,e.rotation.z=-r.rotation*Math.PI/180,t.getBound()).center,f=M.getValue("originBound",a),s=(f.max.x+f.min.x)/2-i.x,c=(f.max.y+f.min.y)/2-i.y;return e.position.x=s,e.position.y=t.ct.position.y,e.position.z=-c,e.updateProjectionMatrix(),e.updateMatrix(),e.updateMatrixWorld(),e.updateWorldMatrix(),e.matrixWorldNeedsUpdate=!0,e}static setCameraParame3d(t,e,i,s,r,n){t.ct.aspect=e/i,M.setValue("camera",t.ct,n)}static readPixcel(i,s,r,n){let{row:a,col:h}=M.getValue("state",n);var t=i.bt.renderer,o=M.getValue("canvas",n);let{width:l,height:u}=M.getValue("viewParam",n),c=o.getContext("2d");var e=document.createElement("canvas");e.width=l,e.height=u;let f=e.getContext("2d"),d=M.getValue("callback",n),v=new Image;v.onload=t=>{var e=M.getValue("state",n);e.loadCount++,M.setValue("state",e,n),f.drawImage(t.path[0],0,0,l,u),c.putImageData(f.getImageData(0,0,l,u),s,r),e.loadCount===a*h&&(o.toBlob(t=>{d&&d(t)}),M.recoverParam(i,n),n.callback=null,n.viewParam=null,n.state=null,n.camera=null,n.backCamera=null,n.canvas=null,n=null)},i.bt.render(),v.src=t.domElement.toDataURL()}static setLogo(t,e){if(t.bt.needLogo){e=Math.min(e,1);const i=.4;e=-1*(.5*i/e-1);t.bt.da.material.uniforms.offset.value.x=e}}static caleAvoid(t,e){var i,s;"2d"!=t.cameraType&&t.cameraType,"2d"==t.cameraType?(M.showAllNode(e,t),s=M.getValue("width",t),i=M.getValue("height",t),e.bt.renderer.setSize(s,i),e.bt.xt(),e.bt.ow(),s=M.getValue("viewParam",t),e.bt.renderer.setSize(s.width,s.height)):(e.bt.xt(),e.bt.ow())}static shot(e,i,s){M.setLogo(e,s.width/s.height);var r=M.getValue("camera",s),{row:n,col:a}=(e.bt.ma=!0,M.setVisibleLevelsFrustumCulled(e,!1),M.getValue("state",s)),h=M.getValue("viewParam",s);M.caleAvoid(s,e);for(let t=0;t<n*a;t++){var o=Math.floor(t/a),l=Math.max(t-o*a,0),u=i.width,c=i.height,f=new Image,o=(f.indexI=o,f.indexJ=l,h.width*f.indexJ),l=h.height*f.indexI;r.setViewOffset(u,c,o,l,h.width,h.height),r.updateProjectionMatrix(),M.readPixcel(e,o,l,s)}}}class CS{static getRenderNode(t){let e=null;if(t)return t.getRenderNode?(e=t.getRenderNode())&&"Group"===e.type&&(e=e.children[0]):t.Zs&&(e=t.Zs),e}static downLoad(t){let e;var i=new FileReader;i.readAsDataURL(t),i.onload=function(t){(e=t.target.result).length<6||((t=document.createElement("a")).download=(new Date).getTime()+".jpg",t.href=e,document.body.appendChild(t),t.click(),t.remove())}}static setLogo(t,e){if(t.bt.needLogo){e=Math.min(e,1);const i=.4;e=-1*(.5*i/e-1);t.bt.da.material.uniforms.offset.value.x=e}}static setVisibleLevelsFrustumCulled(t,e,i){this.forEachElement(t,e,t=>{var e=CS.getRenderNode(t);e&&(e.frustumCulled=i),t.type===p.LABEL&&t.getRenderNode()?.children.forEach(t=>{t.frustumCulled=i})})}static addLastFrame(t,e){let i=nt.window.devicePixelRatio||1;var s=t.bt.renderer;let r=s.domElement.parentElement,n=s.domElement.clientWidth,a=s.domElement.clientHeight;var h=document.createElement("canvas");h.width=n*i,h.height=a*i,h.style.width=n+"px",h.style.height=a+"px",h.style.position="absolute",h.style.zIndex=0,h.className="exportImageLastFrame";let o=h.getContext("2d");var l=new Image,u=(l.crossOrigin="Anonymous",l.onload=()=>{o.drawImage(l,0,0,n*i,a*i),r.append(h),t.Yt.Xt({type:"printBefor"}),e()},l.onerror=t=>{console.warn("fail...",t)},t.bt.render(),"FF"===Sm?"image/jpeg":"image/png");l.src=s.domElement.toDataURL(u,1)}static insideBound(t,e){let i=!1;return i=t.min.x>=e.min.x&&t.min.y>=e.min.y&&t.max.x<=e.max.x&&t.max.y<=e.max.y?!0:i}static forEachElement(t,e,i){var s=t.getFloor(e);for(let t=0;t<s.Ft.length;t++){var r=s.Ft[t];for(let t=0;t<r.Ft.length;t++)i(r.Ft[t])}}static getInBoundSpriteElement(t,e,i,s){this.forEachElement(t,e,t=>{var e=CS.getRenderNode(t);e&&"Sprite"===e.type&&this.insideBound(t.bound,i)&&(t.type!==p.LABEL||0<t.text.length)&&s.push(t)})}static getElementBound(t){let e=new sa;return t.forEach(t=>{e.expand(t.bound)}),e}}class NS{static getSpriteWorldSize(t,e,i,s){let r,n;if(t.parent.isHasText){var a=t.getScreenSize();if(!a||isNaN(a.width)||isNaN(a.height))return null;n=a.width,r=a.height}else{a=CS.getRenderNode(t)?.material?.map?.image;if(!a)return null;r=a.height/2,n=a.width/2}return{x:n*Math.abs(e.left-e.right)/e.zoom/s,y:r*Math.abs(e.top-e.bottom)/e.zoom/i}}static getSpriteBound(t,e,i,s){var r={},n={},a=(t=Math.ceil(t),e=Math.ceil(e),new sa);return r.x=i.x-s.x*t,n.x=i.x+(1-s.x)*t,n.y=i.y-s.y*e,r.y=i.y+(1-s.y)*e,a.expandByCoords([r,n]),a}static calcElements(e,i,s,r,n){for(let t=0;t<e.length;t++){var a=e[t],h=CS.getRenderNode(a);if(h&&"Sprite"===h.type){var o=NS.getSpriteWorldSize(a,s,r,n);if(o){let t;t=a.getAnchor?a.getAnchor():h.center;h=NS.getSpriteBound(o.x,o.y,a.bound.center,t);isNaN(h.size.x)||isNaN(h.size.y)||h.size.x===1/0||h.size.y===1/0||i.expand(h)}}}}static getWidthSpriteBound(t,e,i,s,r){this.calcElements(t,r,e,i,s)}}class IS{static createCamera(){var t=new sr(-1,1,1,-1,1,1e4);return t.up=new Gt(0,1,0),t}static calcExportWidthHeight(t){var e=t[0].distanceTo(t[1]);return{exportWidth:t[1].distanceTo(t[2]),exportHeight:e}}static updateCamera(t,e,i,s,r){r.left=-e/2,r.right=e/2,r.top=i/2,r.bottom=-i/2;let n=1;var a=s.center,h=s.size,s=s.rotation??0;n=e/i>h.x/h.y?i/h.y:e/h.x,r.rotation.x=-Math.PI/2,r.rotation.y=0,r.rotation.z=-s*Math.PI/180;const o=t.Ft[0].x,l=t.Ft[0].y;i=a.x-o,e=l-a.y;r.position.x=i,r.position.y=Math.max((t.getLevels().length+1)*t.getFloorSpace(),1e3),r.position.z=e,r.zoom=n,r.updateProjectionMatrix(),r.updateMatrixWorld()}static readOptions(t,e,i){i.buildings=void 0!==i.buildings?i.buildings:[],i.autoDownload=void 0===i.autoDownload||i.autoDownload,i.isExpandbound=void 0===i.isExpandbound||i.isExpandbound,i.padding=void 0!==i.padding?i.padding:5,i.color=void 0!==i.color?i.color:"rgba(255, 255, 255, 1.0)",i.imageWidth=void 0!==i.width?i.width:1e3,i.imageHeight=void 0!==i.height?i.height:1e3,delete i.width,delete i.height;15e3<i.imageWidth&&(i.imageWidth=15e3),15e3<i.imageHeight&&(i.imageHeight=15e3),i.imageWidth<200&&(i.imageWidth=200),i.imageHeight<200&&(i.imageHeight=200),i.imageWidth=Math.ceil(i.imageWidth),i.imageHeight=Math.ceil(i.imageHeight),i.level=void 0!==i.level?i.level:1,i.oldLevel=t.getLevel(),i.bound=e,i.map=t}static initOptions(t){(t=Object.assign(t,{renderSizeMap:{width:null,height:null},renderSizeExport:{width:0,height:0},camera:null,backCamera:null,imageRenderSize:{width:null,height:null}})).renderSizeMap={width:t.map.bt.renderer.domElement.clientWidth,height:t.map.bt.renderer.domElement.clientHeight},t.imageRenderSize={width:t.imageWidth-2*t.padding,height:t.imageHeight-2*t.padding},t.renderSizeExport={width:t.imageRenderSize.width,height:t.imageRenderSize.height};2048<t.renderSizeExport.width&&(t.renderSizeExport.width=2048),2048<t.renderSizeExport.height&&(t.renderSizeExport.height=2048),t.backCamera=t.map.camera,t.camera=this.createCamera()}static findSpriteElement(t,e,i){var s=[];return CS.getInBoundSpriteElement(t,e,i,s),s}static expandBoundBySprite(e,i){var s=i.bound.clone();for(let t=0;t<100&&(this.updateCamera(i.map,i.imageRenderSize.width,i.imageRenderSize.height,s,i.camera),NS.getWidthSpriteBound(e,i.camera,i.imageRenderSize.height,i.imageRenderSize.width,s),!(15e3<s.size.x||15e4<s.size.y));t++);var t=i.bound.clone();return t.expand(s),t}static addLastFrame(t,e){CS.addLastFrame(t,e)}static setStyle(t,e,i,s,r){CS.forEachElement(t,e,e=>{i.forEach(t=>{if(t.type===e.type)switch(t.type){case p.LABEL:"befor"===r?0<e.text.length&&s.push(e.mg(t.fontSize)):e.fontSize=null;break;case p.TEXT_MARKER:"befor"===r?(e.Zs.userData.originFontSize=e.fontSize,e.fontSize=t.fontSize):(e.fontSize=e.Zs.userData.originFontSize,delete e.Zs.userData.originFontSize),e.update();break;case p.FACILITY:e.size="befor"===r?t.size:null;break;case p.IMAGE_MARKER:"befor"===r?(e.Zs.userData.originSize=e.size,e.size=t.size):(e.size=e.Zs.userData.originSize,delete e.Zs.userData.originSize)}})})}static befor(h){return new Promise((t,e)=>{let{style:i=[],map:s,level:r,buildings:n}=h,a=(s.Wt.Z0=!1,[]);this.setStyle(s,r,i,a,"befor"),n.forEach(t=>{var e=s.getBuilding(t.buildingID);this.setStyle(e,t.level,i,a,"befor")}),Promise.all(a).then(t)})}static after(t){let{style:i=[],map:s,level:e,buildings:r}=t,n=(s.Wt.Z0=!0,[]);this.setStyle(s,e,i,n),r.forEach(t=>{var e=s.getBuilding(t.buildingID);this.setStyle(e,t.level,i,n)})}static updateSize(t,e){CS.forEachElement(t,e,t=>{t.updateSize?t.updateSize():t.Da&&t.Da()})}static caleAvoid(e){e.map.setDevicePixalRatio(1),e.map.bt.renderer.setSize(e.imageRenderSize.width,e.imageRenderSize.height),e.map.bt.xt(),e.map.bt.ma=!0,e.map.bt.ow(e.zoom),this.updateSize(e.map,e.level),e.buildings.forEach(t=>{t=e.map.getBuilding(t.buildingID);this.updateSize(t,t.level)}),e.map.bt.renderer.setSize(e.renderSizeExport.width,e.renderSizeExport.height),e.map.Yt.Xt({type:"resize"})}static start(e,i){var{map:t,imageRenderSize:s,renderSizeExport:r,camera:n}=e,a=(CS.setLogo(t,s.width/s.height),CS.setVisibleLevelsFrustumCulled(t,e.level,!1),e.buildings.forEach(t=>{t=e.map.getBuilding(t.buildingID);CS.setVisibleLevelsFrustumCulled(t,t.level,!1)}),this.caleAvoid(e),document.createElement("canvas")),h=(a.width=e.imageWidth,a.height=e.imageHeight,a.style.width=e.imageWidth+"px",a.style.height=e.imageHeight+"px",a.getContext("2d")),o={col:0,row:0,loadCount:0};if(o.col=Math.ceil(e.imageRenderSize.width/e.renderSizeExport.width),o.row=Math.ceil(e.imageRenderSize.height/e.renderSizeExport.height),isNaN(o.col)||isNaN(o.row))i(null);else for(let t=0;t<o.row*o.col;t++){var l=Math.floor(t/o.col),u=Math.max(t-l*o.col,0),u=r.width*u,l=r.height*l;n.setViewOffset(s.width,s.height,u,l,r.width,r.height),n.updateProjectionMatrix(),this.renderImage(u,l,o,a,h,i,e)}}static renderDomMarker(o){if(o.dependent&&o.dependent.html2canvas){o.camera.view=null,this.updateCamera(o.map,o.width,o.height,o.bound,o.camera);var e=o.width/2,i=o.height/2,s=new Gt,t=new Ht,r=new Ht;t.copy(o.camera.matrixWorldInverse),r.multiplyMatrices(o.camera.projectionMatrix,t);let h=[];var n=[],a=o.map.Xw;for(let t=0;t<a.Ft.length;t++){var l=a.Ft[t];l.level===o.level&&(s.setFromMatrixPosition(l.Zs.matrixWorld),s.applyMatrix4(r),h.push({x:s.x*e+e,y:-s.y*i+i}),l=o.dependent.html2canvas(l.Zs.element.childNodes[0],{backgroundColor:null}),n.push(l))}0==n.length?o.callback(o.canvasAll):Promise.all(n).then(r=>{let n=0;for(let s=0;s<r.length;s++){let t=r[s],e=h[s],i=new Image;i.onload=()=>{n+=1,o.ctxAll.drawImage(i,e.x-t.width/2,e.y-t.height/2),n===r.length&&o.callback(o.canvasAll)},i.onerror=t=>{(n+=1)===r.length&&o.callback(o.canvasAll)};var a="FF"===Sm?"image/jpeg":"image/png";i.src=t.toDataURL(a,1)}}).catch(t=>{console.error(t),o.callback(o.canvasAll)})}else o.callback(o.canvasAll)}static renderImage(t,e,i,s,r,n,a){let{map:h,padding:o,renderSizeExport:l}=a;var u=document.createElement("canvas");u.width=l.width,u.height=l.height;let c=u.getContext("2d");var f=new Image,u=(f.crossOrigin="Anonymous",f.onload=()=>{i.loadCount++,c.drawImage(f,0,0,l.width,l.height),r.putImageData(c.getImageData(0,0,l.width,l.height),t+o,e+o),i.loadCount===i.row*i.col&&this.renderDomMarker({ctxAll:r,level:a.level,canvasAll:s,map:a.map,width:a.imageWidth,height:a.imageHeight,camera:a.camera,dependent:a.dependent,bound:a.bound,callback:t=>{r.fillStyle=a.color,r.fillRect(0,0,a.imageWidth,a.padding),r.fillRect(0,0,a.padding,a.imageHeight),r.fillRect(0,a.imageHeight-a.padding,a.imageWidth,a.imageHeight),r.fillRect(a.imageWidth-a.padding,0,a.imageWidth,a.imageHeight),t.toBlob(t=>{a.autoDownload&&CS.downLoad(t),n(t)})}})},h.bt.render(),"FF"===Sm?"image/jpeg":"image/png");f.src=h.bt.renderer.domElement.toDataURL(u,1)}static recoverParamCore(t){var e=t.map,i=(e.ct=t.backCamera,t.renderSizeMap),s=window.devicePixelRatio||1;e.bt.renderer.setSize(i.width,i.height),e.setDevicePixalRatio(s),CS.setLogo(e,i.width/i.height),e.bi.yt.object=e.ct,t.map.Yt.Xt({type:"resize"})}static findWattingLabelNodeByLevel(t,e,i){CS.forEachElement(t,e,t=>{t.type==p.LABEL&&t.visible&&i.push(t)})}static findAllWattingLabelNode(e,i){IS.findWattingLabelNodeByLevel(e.map,e.level,i);for(let t=0;t<e.buildings.length;t++){var s=e.map.getBuilding(e.buildings[t].buildingID);IS.findWattingLabelNodeByLevel(s,s.level,i)}}static recoverParam(e){var t=e.map;this.updateSize(e.map,e.level),e.buildings.forEach(t=>{t=e.map.getBuilding(t.buildingID);this.updateSize(t,t.level)}),CS.setVisibleLevelsFrustumCulled(t,e.level,!0),e.buildings.forEach(t=>{t=e.map.getBuilding(t.buildingID);CS.setVisibleLevelsFrustumCulled(t,t.level,!0)}),t.bt.xt(),t.bt.ma=!0,t.enableUpdateNode()}static removeLastFrame(t){let e=t.bt.renderer.domElement.parentElement;e&&e.childNodes.forEach(t=>{"exportImageLastFrame"===t.className&&e.removeChild(t)}),t.Yt.Xt({type:"printAfter"})}}class PS{constructor(t){this.buildings=t.buildings,this.map=t.map,this.onlyInBuilding=t.onlyInBuilding,this.buildingOldParam=[],this.innerBuildingIDs=[],this.outterBuildingIDs=[],this.initBuildingIDs(),this.saveBuildingParam(),this.setBuildingsParamForExport()}restoreBuildingParam(){let n=this.map,a=[];return this.onlyInBuilding&&this.setBuildingVisible(null,!0),this.setBuildingOverviewMode(this.innerBuildingIDs,l3.INDOOR),this.buildingOldParam.forEach(t=>{var{buildingID:t,level:e,visibleLevels:i,overviewMode:s,facadeNodeVisible:r}=t,s=(this.setBuildingVisible(t,!0),void 0!==s&&this.setBuildingOverviewMode([t],s),a.push(this.setBuildingLevel(t,i,e)),n.getBuilding(t));s&&(s.Of.visible=r,s.Ld())}),this.map.qt=this.qt,Promise.all(a)}initBuildingIDs(){var{buildings:t,map:e}=this;let i=[],s=t.map(t=>t.buildingID);e.getBuildings().forEach(t=>{!1===s.includes(t.Ht)&&i.push(t.Ht)}),this.innerBuildingIDs=s,this.outterBuildingIDs=i}saveBuildingParam(){this.qt=this.map.qt,this.map.qt=!1;var{map:e,innerBuildingIDs:t,outterBuildingIDs:i}=this,s=(this.buildingOldParam.push({buildingID:null,level:e.getLevel(),visibleLevels:e.getVisibleLevels()}),[...t,...i]);for(let t=0;t<s.length;t++){var r=e.getBuilding(s[t]);this.buildingOldParam.push({buildingID:r.Ht,level:r.level,visibleLevels:r.visibleLevels,overviewMode:r.overviewMode,facadeNodeVisible:r.Of.visible})}}checkBuildingLoaded(){var{buildings:e,map:i}=this;let s=0;for(let t=0;t<e.length;t++)i.nt.Gt(e[t].buildingID).loaded&&(s+=1);return s===e.length}setBuildingOverviewMode(t,e){let i=this.map;i.changeOverviewMode({buildingIDs:t,overviewMode:e,duration:0}),t.forEach(t=>{i.getBuilding(t).Of.visible=e!==l3.INDOOR})}setBuildingsParamForExport(){this.setBuildingOverviewMode(this.innerBuildingIDs,l3.INDOOR),this.setBuildingOverviewMode(this.outterBuildingIDs,l3.OUTDOOR),this.onlyInBuilding&&this.setBuildingVisible(null,!1),this.innerBuildingIDs.forEach(t=>{this.setBuildingVisible(t,!0)}),this.outterBuildingIDs.forEach(t=>{this.setBuildingVisible(t,!1)}),this.map.bt.$a()}loadBuildings(){return new Promise((s,r)=>{if(this.checkBuildingLoaded())s();else{let{buildings:t,map:e}=this,i=()=>{this.checkBuildingLoaded()&&(e.off("buildingLoaded",i),s())};e.on("buildingLoaded",i),t.forEach(t=>{t=e.getBuilding(t.buildingID);e.Wt.md(t)}),setTimeout(()=>{r("...")},1e4)}})}setBuildingVisible(t,e){let i;var s=this.map;(i=null===t?s.jt:s.getBuilding(t))&&(i.Ft.forEach(t=>{t.visible=e}),i.visible=e,i.traverse(t=>{t.br({animate:!1})}))}setBuildingLevel(s,r,n){let a=this.map;return new Promise((e,i)=>{if(s){let t=a.getBuilding(s);t?t.setVisibleLevels(r,()=>{t.traverse(t=>{t.br({animate:!1})}),t.setLevel({level:n,animate:!1,finish:()=>{t.traverse(t=>{t.br({animate:!1})}),e()}})}):i(`buildingId: ${s} `)}else a.setVisibleLevels(r,()=>{a.setLevel({level:n,animate:!1,finish:e})})})}async loadLevel(){var e=this.buildings,i=[];for(let t=0;t<e.length;t++)i.push(this.setBuildingLevel(e[t].buildingID,[e[t].level],e[t].level));return Promise.all(i)}}let DS=!1,OS=0;class US{static Rx(t,e,i,s,r,n){var a=Math.min(r/i,n/s),i=i*a,s=s*a;t.drawImage(e,(r-i)/2,(n-s)/2,i,s)}static screenshot(a,t,e,i,h,o,l,u){const c=e.x-t.x,f=e.y-t.y,s=(e.x+t.x)/2,r=(e.y+t.y)/2,n=a.bt.renderer.domElement.style.width,d=a.bt.renderer.domElement.style.height,v=n.split("p")[0],p=d.split("p")[0];let m=null,g=(m=(e.x-t.x)/(e.y-t.y)>v/p?v/(e.x-t.x):p/(e.y-t.y),s-v/2),_=r-p/2,w=document.getElementsByTagName("canvas")[0],M=document.createElement("canvas"),y=document.createElement("canvas"),E=document.createElement("canvas"),x=nt.window.devicePixelRatio,b=new Image,S=(a.getViewMode(),Cr.PERSPECTIVE,a.ct.setViewOffset(v*m,p*m,v*(m-1)/2+g*m,p*(m-1)/2+_*m,v,p),a.bt.render(),M.width=c*m*x,M.height=f*m*x,M.style.width=c*m*x+"px",M.style.height=f*m*x+"px",i?(y.width=1240*Math.pow(1.414,h-1),y.height=1754*Math.pow(1.414,h-1),y.style.width=1240*Math.pow(1.414,h-1)+"px",y.style.height=1754*Math.pow(1.414,h-1)+"px"):(y.height=1240*Math.pow(1.414,h-1),y.width=1754*Math.pow(1.414,h-1),y.style.height=1240*Math.pow(1.414,h-1)+"px",y.style.width=1754*Math.pow(1.414,h-1)+"px"),E.height=u||f*Math.pow(1.414,h-1),E.width=l||c*Math.pow(1.414,h-1),E.style.height=E.height+"px",E.style.width=E.width+"px",b.src=w.toDataURL("image/png"),(a.getViewMode()===Cr.PERSPECTIVE?a.Ps:a.Lt).clearViewOffset(),M.getContext("2d")),A=y.getContext("2d"),T=E.getContext("2d");b.onload=()=>{a.getViewMode(),Cr.PERSPECTIVE,S.drawImage(b,-(v*x-c*m*x)/2,-(p*x-f*m*x)/2);let n=new Image;n.src=M.toDataURL("image/png"),n.onload=()=>{a.camera.clearViewOffset(),a.enableUpdateRender();var t=Math.min(1240*Math.pow(1.414,h-1)/(c*m),1754*Math.pow(1.414,h-1)/(f*m)),e=(y.width-c*m*t)/2,i=(y.height-f*m*t)/2;A.drawImage(n,e,i,c*m*t,f*m*t),l&&u?US.Rx(T,n,c,f,E.width,E.height):T.drawImage(n,0,0,c*Math.pow(1.414,h-1),f*Math.pow(1.414,h-1));let s=y.toDataURL("image/png"),r=E.toDataURL("image/png");-1<navigator.userAgent.indexOf("Edge")||-1<navigator.userAgent.indexOf(".NET4.0C")?o(s,null,r,null):y.toBlob(e=>E.toBlob(t=>o(s,e,r,t)))}}}static print(t,e){DS=!0;let i=t.getZoom(),s=(t.setZoom({animate:!0,zoom:29}),t.bi.yt.target.x),r=t.bi.yt.target.z,n=(t.bi.yt.panAdd({x:-s,z:-r,y:0}),t.getTilt()),a=t.getRotation(),h=document.createElement("canvas");h.width=6*t.bt.renderer.domElement.width,h.height=6*t.bt.renderer.domElement.height,t.setTilt({tilt:90,finish:()=>{t.setRotation({rotation:0})}}),t.getViewMode()===Cr.MODE_3D?t.setViewMode({mode:Cr.MODE_2D,callback:()=>US.shot_(t,h,h.getContext("2d"),0,t.Lt.zoom,s,r,i,Cr.MODE_3D,n,a,e)}):US.shot_(t,h,h.getContext("2d"),0,t.Lt.zoom,s,r,i,Cr.MODE_2D,n,a,e)}static export(t){var e;void 0!==t.imageWidth&&void 0!==t.imageHieght&&(e=t.map.getViewMode(),void 0===t.mode?t.cameraType=e===Cr.MODE_2D?"2d":"3d":t.cameraType=t.mode===Cr.MODE_2D?"2d":"3d",e!=Cr.MODE_2D||t.mode!==Cr.MODE_3D)&&M.print(t)}static shot_(n,a,h,o,l,u,c,f,d,v,p,m){if(DS&&o<36){let t=null,e=null,i=(o<6?(t=0,e=+o):o<12?(t=1,e=o-6):o<18?(t=2,e=o-12):o<24?(t=3,e=o-18):o<30?(t=4,e=o-24):o<36&&(t=5,e=o-30),n.bt.renderer.domElement.width),s=n.bt.renderer.domElement.height,r=new Image;return r.indexI=t,r.indexJ=e,n.Lt.setViewOffset(i,s,2.5*-i+i*t,2.5*-s+s*e,i,s),n.Lt.updateProjectionMatrix(),r.onload=t=>{OS++;let e=t.target;e=e||t.path[0],h.drawImage(e,i*e.indexI,s*e.indexJ),36===OS&&(a.toBlob(t=>{n.Lt.zoom=6*l,n.Lt.updateProjectionMatrix(),n.setViewMode({mode:d,callback:()=>{n.setRotation({rotation:p,finish:()=>{n.setTilt({tilt:v})}})}}),n.setZoom({zoom:f}),n.Lt.clearViewOffset(),n.bt.Vt(),n.bi.yt.panAdd({x:u,z:c,y:0}),n.bt.xt(),n.bi.yt.update(),n.bt.render(),DS=!1,m(t)}),OS=0)},n.bt.xt(),n.bi.yt.update(),n.bt.render(),r.src=n.bt.renderer.domElement.toDataURL(),o++,US.shot_(n,a,h,o,l,u,c,f,d,v,p,m)}}static async exportToImage(n,a,h,o,l){h=h||{},n.Yt.pw=!1,IS.readOptions(n,a,h),IS.initOptions(h),h.renderSizeExport.width<=0||h.renderSizeExport.height<=0?l&&l("0"):1==h.onlyInBuilding&&0==h.map.getBuildings().length?l&&l(""):IS.addLastFrame(h.map,async()=>{h.map.bt.renderer.domElement.style.opacity="0";let s=new PS(h),r=h.map.nt.qv,i=(h.map.nt.qv=!1,async()=>{var e=[];for(h.map.enableUpdateNode(),h.map.Wt.Oa(!0,h.zoom);0<h.map.Wt.Ua.length;)h.map.Wt.Fa();IS.findAllWattingLabelNode(h,e),h.map.bt.$a();var i=[];for(let t=0;t<e.length;t++)0<e[t].text.length&&i.push(e[t].gg());Promise.all(i).then(async()=>{var t;await IS.befor(h),!0===h.isExpandbound&&(t=IS.findSpriteElement(h.map,h.level,h.bound),a=IS.expandBoundBySprite(t,h)),IS.updateCamera(h.map,h.imageRenderSize.width,h.imageRenderSize.height,a,h.camera),h.map.camera=h.camera,IS.start(h,async t=>{for(IS.recoverParamCore(h),await s.restoreBuildingParam(),IS.after(h),h.map.Wt.Oa();0<h.map.Wt.Ua.length;)h.map.Wt.Fa();IS.recoverParam(h),h.map.bt.render(),h.map.toolBar&&(h.map.toolBar.enable=!0),h.map.bt.xt(),h.map.bt.ma=!0,h.map.bt.ow(),h.map.bt.$a(),h.map.bt.renderer.domElement.style.opacity="1",h.map.nt.qv=r,IS.removeLastFrame(n),h.map.Yt.pw=!0,null!==t?o&&o(t):l&&l()})})}),t=()=>{let e=[!1,!1];if(Zm.isLoaded())e[0]=!0,e.every(t=>t)&&i();else{let t=Zm.onLoad;Zm.onLoad=()=>{t(),e[0]=!0,Zm.onLoad=t,e.every(t=>t)&&i()}}Tm.ul===Tm.ll?(e[1]=!0,e.every(t=>t)&&i()):Tm.cl.set(h.map.Il,()=>{Tm.cl.delete(h.map.Il),e[1]=!0,e.every(t=>t)&&i()})};0<h.buildings.length?(await s.loadBuildings(),await s.loadLevel(),t()):h.map.setVisibleLevels([h.level],()=>{h.map.setLevel({level:h.level,animate:!1,finish:t})})})}}function FS(t){t=new Worker(t,{type:"module"});return t.onerror=function(t){console.error(t)},t}let BS=(i,s,r,n)=>{let a=({data:t})=>{var e;t.id===s&&(t.error?(e=t.error,(e=new Error(t.error.message)).stack=t.error.stack,n(e)):r(t),i.removeEventListener("message",a))};return a};async function kS(i,t,e){e=e||[];let s=i.Lx++;var r=new Promise((t,e)=>{i.Cx.addEventListener("message",BS(i.Cx,s,t,e))});return i.Cx.postMessage({id:s,parameters:t,canTransferArrayBuffer:!0},e),r}async function GS(e,t,i){++e.Nx;try{var s=await kS(e,t,i);return--e.Nx,s}catch(t){throw--e.Nx,t}}class HS{constructor(t,e){this.Ix=e.baseURL+t,this.Lx=0,this.Nx=0,this.Px=e.maximumActiveTasks??512,this.Dx=[]}}Object.assign(HS.prototype,{Ox(t,e){if(this.Cx||(this.Cx=FS(this.Ix)),!(this.Nx>=this.Px))return GS(this,t,e)},Ux(){for(;this.Nx<this.Px&&0<this.Dx.length;){var{taskParam:t,resolve:e,reject:i}=this.Dx.shift(),{parameters:t,transferableObjects:s}=t;this.Ox(t,s).then(e,i).finally(()=>{this.Ux()})}},Ga(i,s){return new Promise((t,e)=>{this.Dx.push({taskParam:{parameters:i,transferableObjects:s},resolve:t,reject:e}),this.Ux()})},cw(){this.Cx&&(this.Cx.terminate(),this.Cx=void 0,this.Dx.length=0,this.Nx=0)}}),Object.assign(av.prototype,{ow(t){this.ma&&(this.st.traverse(async e=>{if(this.st.Wt.Qa(e)){var i=e.visibleLevels,r=[],n=t??this.st.getZoom(),s=this.nt.Nw;for(let t=0;t<i.length;t++){var a=e.getFloor(i[t]);if(a){var h=a.getLayers(p.LABEL_LAYER);let t;0<h.length&&(t=h[0].scene);h=a.getLayers(p.FACILITY_LAYER);let e;0<h.length&&(e=h[0].scene);h=[];t&&h.push(...t.children),e&&h.push(...e.children),this.st.nt.qv&&await this.ka(h),r.length=0,t&&this.Wa(r,t.children,!0,n,t.mapNode.Xa),e&&this.Wa(r,e.children,!1,n,e.mapNode.Xa);for(let t=0;t<s.length;t++){var o=s[t];for(let s=r.length=0;s<o.length;s++){var l=o[s],l=a.getLayers(l);let t,e,i=!1;0<l.length&&(t=l[0],e=t.scene,i=!0===t.isHasText),e&&void 0!==t.collision&&(this.st.nt.qv&&await this.ka(e.children,!1),e.children.forEach(t=>{t.mapNode&&t.mapNode.avoidBefor&&t.mapNode.avoidBefor()}),this.Wa(r,e.children,i,n,t.collision),this.st.enableUpdateRender())}}}}}}),this.ma=!1,this.st.enableUpdateRender())}}),nt.DepthPeelingRenderer=hx,nt.LabelCollection=bS,nt.heatmap=TS,nt.TaskProcessor=HS,nt.DomMarkerManager=xE,nt.FMDomMarker=GE;let VS={FMMouseMode:pa,VERSION:a.VERSION,BUILD:a.BUILD,FMMap:E,FMType:p,FMViewMode:Cr,FMShadingMode:ih,FMInfoMode:Nr,FMTextAlign:Rm,FMLineType:Oy,FMLabelField:L3,FMMarkerAnchor:Ir,FMEdgeMode:LE,FMDepthPeelingMode:rE,FMOverviewMode:l3,FMEnterTriggerMode:sE,FMUtil:aa,FMCalculator:D3,FMCoordsTransformer:HE,FMImageMarker:fE,FMMarker:BM,FMTextMarker:dE,FMPolygonMarker:SE,FMLocationMarker:TE,FMHeatMap:BE,FMDynamicModel:kE,FMLineMarker:Uy,FMDomMarker:GE,FMExtrudeMarker:UE,FMSegment:Dy,FMMarkerLayer:j3,FMBound:sa,FMOrientedBound:VE,FMRectangle:I3,FMMarkerFun:Ky,FMMapMask:O3,FMLight:WE,FMLightMode:zE,FMDynamicTextureTool:jE,FMMarkerCluster:qE,FMZoomCenterType:Ca},zS=ov.global(),WS=void 0!==zS?zS.fengmap:{};for(RS in null==WS&&(WS={}),VS)WS[RS]=VS[RS];void 0!==zS&&(zS.fengmap=WS),WS.FMUtil.screenshot=US.screenshot,WS.FMUtil.exportToImage=US.exportToImage;var jS=WS;let{VERSION:XS,BUILD:YS}=a;t.BUILD=YS,t.FMBound=sa,t.FMCalculator=D3,t.FMCoordsTransformer=HE,t.FMDepthPeelingMode=rE,t.FMDomMarker=GE,t.FMDynamicModel=kE,t.FMDynamicTextureTool=jE,t.FMEdgeMode=LE,t.FMEnterTriggerMode=sE,t.FMExtrudeMarker=UE,t.FMHeatMap=BE,t.FMImageMarker=fE,t.FMInfoMode=Nr,t.FMLabelField=L3,t.FMLight=WE,t.FMLightMode=zE,t.FMLineMarker=Uy,t.FMLineType=Oy,t.FMLocationMarker=TE,t.FMMap=E,t.FMMapMask=O3,t.FMMarker=BM,t.FMMarkerAnchor=Ir,t.FMMarkerCluster=qE,t.FMMarkerFun=Ky,t.FMMarkerLayer=j3,t.FMMouseMode=pa,t.FMOrientedBound=VE,t.FMOverviewMode=l3,t.FMPolygonMarker=SE,t.FMRectangle=I3,t.FMSegment=Dy,t.FMShadingMode=ih,t.FMTextAlign=Rm,t.FMTextMarker=dE,t.FMType=p,t.FMUtil=aa,t.FMViewMode=Cr,t.FMZoomCenterType=Ca,t.VERSION=XS,t.default=jS,Object.defineProperty(t,"Si",{value:!0})}({});
